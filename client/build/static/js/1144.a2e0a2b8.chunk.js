"use strict";(self.webpackChunkSEEDs_v2_0_Client=self.webpackChunkSEEDs_v2_0_Client||[]).push([[1144],{59419:(o,_,v)=>{v.d(_,{A:()=>e});class e{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(o,_,v){this._layerById[_]=v,this._layerByName[o]=v}async featureSetByName(o){return void 0===this._layerByName[o]?null:this._layerByName[o]}async featureSetById(o){return void 0===this._layerById[o]?null:this._layerById[o]}castToText(){return"object, FeatureSetCollection"}}},81144:(o,_,v)=>{v.r(_),v.d(_,{constructAssociationMetaDataFeatureSetFromUrl:()=>A,constructFeatureSet:()=>g,constructFeatureSetFromPortalItem:()=>q,constructFeatureSetFromRelationship:()=>k,constructFeatureSetFromUrl:()=>F,convertToFeatureSet:()=>j,createFeatureSetCollectionFromMap:()=>D,createFeatureSetCollectionFromService:()=>E,initialiseMetaDataCache:()=>I});var R=v(53705),U=v(59419),M=v(80004),W=v(62062),Z=v(13812),V=v(20277),J=v(57137),z=v(67531),Q=v(46458),Y=v(24855),K=v(71692),X=v(10291),$=v(59359),H=v(6755),ee=v(92541);class StatsField_a{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const o=new StatsField_a;return o.field=this.field,o.tofieldname=this.tofieldname,o.typeofstat=this.typeofstat,o.workingexpr=this.workingexpr,o}static parseStatField(o,_,v,R){const U=new StatsField_a;U.field=o;const M=ee.WhereClause.create(_,v,R),W=function s(o){if("function"===o.parseTree.type){if(0===o.parseTree.args.value.length)return{name:o.parseTree.name,expr:null};if(o.parseTree.args.value.length>1)throw new z.L8(z.Z7.MissingStatisticParameters);const _=ee.WhereClause.create((0,$.Mi)(o.parseTree.args.value[0],X.zl.Standardised,o.parameters),o.fieldsIndex,o.timeZone);return{name:o.parseTree.name,expr:_}}return null}(M);if(null===W)throw new z.L8(z.Z7.UnsupportedSqlFunction,{function:""});const Z=W.name.toUpperCase().trim();if("MIN"===Z){if(U.typeofstat="MIN",U.workingexpr=W.expr,null===M)throw new z.L8(z.Z7.InvalidFunctionParameters,{function:"min"})}else if("MAX"===Z){if(U.typeofstat="MAX",U.workingexpr=W.expr,null===M)throw new z.L8(z.Z7.InvalidFunctionParameters,{function:"max"})}else if("COUNT"===Z)U.typeofstat="COUNT",U.workingexpr=W.expr;else if("STDEV"===Z){if(U.typeofstat="STDDEV",U.workingexpr=W.expr,null===M)throw new z.L8(z.Z7.InvalidFunctionParameters,{function:"stdev"})}else if("SUM"===Z){if(U.typeofstat="SUM",U.workingexpr=W.expr,null===M)throw new z.L8(z.Z7.InvalidFunctionParameters,{function:"sum"})}else if("MEAN"===Z){if(U.typeofstat="AVG",U.workingexpr=W.expr,null===M)throw new z.L8(z.Z7.InvalidFunctionParameters,{function:Z})}else if("AVG"===Z){if(U.typeofstat="AVG",U.workingexpr=W.expr,null===M)throw new z.L8(z.Z7.InvalidFunctionParameters,{function:"avg"})}else{if("VAR"!==Z)throw new z.L8(z.Z7.UnsupportedSqlFunction,{function:Z});if(U.typeofstat="VAR",U.workingexpr=W.expr,null===M)throw new z.L8(z.Z7.InvalidFunctionParameters,{function:"var"})}return U}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var te=v(52482),ie=v(99343),re=v(39378),se=v(23342),ne=v(98664),ae=v(67871),le=v(8084);function G(o){if(!o)return"COUNT";switch(o.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class O extends Q.A{constructor(o){super(o),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=o.parentfeatureset,this._config=o}isTable(){return!0}async _getSet(o){if(null===this._wset){const _=await this._getFilteredSet("",null,null,null,o);return this._wset=_,this._wset}return this._wset}_isInFeatureSet(){return X.J6.InFeatureSet}_nextUniqueName(o){for(;1===o["T"+this._uniqueIds.toString()];)this._uniqueIds++;const _="T"+this._uniqueIds.toString();return o[_]=1,_}_convertToEsriFieldType(o){return o}_initialiseFeatureSet(){const o={};let _=!1,v=1;const R=this._parent?this._parent.getFieldsIndex():new le.A([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===_;){let o=!1;for(let _=0;_<this._config.groupbyfields.length;_++)if(this._config.groupbyfields[_].name.toLowerCase()===this.objectIdField.toLowerCase()){o=!0;break}if(!1===o)for(let _=0;_<this._config.statsfields.length;_++)if(this._config.statsfields[_].name.toLowerCase()===this.objectIdField.toLowerCase()){o=!0;break}!1===o?_=!0:(this.objectIdField="ROW__ID"+v.toString(),v++)}for(const M of this._config.statsfields){const o=new StatsField_a;o.field=M.name,o.tofieldname=M.name,o.workingexpr=M.expression instanceof ee.WhereClause?M.expression:ee.WhereClause.create(M.expression,R,this.dateFieldsTimeZoneDefaultUTC),o.typeofstat=G(M.statistic),this._decodedStatsfield.push(o)}this._decodedGroupbyfield=[];for(const M of this._config.groupbyfields){const o={name:M.name,singlefield:null,tofieldname:M.name,expression:M.expression instanceof ee.WhereClause?M.expression:ee.WhereClause.create(M.expression,R,this.dateFieldsTimeZoneDefaultUTC),sqlType:null};this._decodedGroupbyfield.push(o)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const _ of this._parent.fields)o[_.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField=""}else this.geometryType=X.ik.point,this.typeIdField="",this.types=null,this.subtypes=null,this.subtypeField="",this.spatialReference=new ne.A({wkid:4326});this.fields=[];const U=new StatsField_a;U.field=this._nextUniqueName(o),U.tofieldname=this.objectIdField,U.workingexpr=ee.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC),U.typeofstat="MIN",this._decodedStatsfield.push(U);for(const M of this._decodedGroupbyfield){const _=new ae.A;if(M.name=this._nextUniqueName(o),_.name=M.tofieldname,_.alias=_.name,(0,$.DA)(M.expression)){const o=this._parent.getField((0,$.YY)(M.expression,X.zl.Standardised));if(!o)throw new z.dr(z.D_.AggregationFieldNotFound);M.name=o.name,M.singlefield=o.name,this.phsyicalgroupbyfields.push(o.name),_.type=o.type,M.sqlType=o.type}else{_.type=this._convertToEsriFieldType((0,$.IY)(M.expression,this._parent.fields));const o=new ae.A;o.name=M.name,o.alias=o.name,this.phsyicalgroupbyfields.push(M.name),this._adaptedFields.push(new V.Gr(o,M.expression)),this._candosimplegroupby=!1,M.sqlType=_.type}this.fields.push(_)}if(this._adaptedFields.length>0)for(const M of this._parent.fields)this._adaptedFields.push(new V.IO(M));for(let M=0;M<this._decodedStatsfield.length;M++){const _=new ae.A;let v=null;const R=this._decodedStatsfield[M];R.field=this._nextUniqueName(o),R.tofieldname===this.objectIdField&&(this._internalObjectIdField=R.field),_.name=R.tofieldname,_.alias=_.name;const U=null!==R.workingexpr&&(0,$.DA)(R.workingexpr)?(0,$.YY)(R.workingexpr,X.zl.Standardised):"";switch(this._decodedStatsfield[M].typeofstat){case"SUM":if(""!==U){if(v=this._parent.getField(U),!v)throw new z.dr(z.D_.AggregationFieldNotFound);_.type=v.type}else _.type="double";break;case"MIN":case"MAX":if(""!==U){if(v=this._parent.getField(U),!v)throw new z.dr(z.D_.AggregationFieldNotFound);_.type=v.type}else _.type="double";break;case"COUNT":_.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==U&&(v=this._parent.getField(U),!v))throw new z.dr(z.D_.AggregationFieldNotFound);_.type="double"}this.fields.push(_)}}async _canDoAggregates(){return!1}async _getFeatures(o,_,v,R){-1!==_&&this._featureCache[_];const U=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(o,U)?(await this._expandPagedSet(o,U,0,0,R),this._getFeatures(o,_,v,R)):"success"}async _getFilteredSet(o,_,v,R,U){if(""!==o)return new Y.A([],[],!0,null);let M=null;const Z={ordered:!1,nowhereclause:!1};if(await this._ensureLoaded(),null!==v)for(let W=0;W<this._decodedStatsfield.length;W++)if(!0===(0,$.Ju)(v,this._decodedStatsfield[W].tofieldname)){Z.nowhereclause=!0,v=null;break}if(null!==R){Z.ordered=!0;for(let o=0;o<this._decodedStatsfield.length;o++)if(!0===R.scanForField(this._decodedStatsfield[o].tofieldname)){R=null,Z.ordered=!1;break}if(null!==R)for(const o of this._decodedGroupbyfield)if(null===o.singlefield&&!0===R.scanForField(o.tofieldname)){R=null,Z.ordered=!1;break}}if(!1!==this._candosimplegroupby&&await this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null)){let o=null;v&&(o=this._reformulateWhereClauseWithoutGroupByFields(v));let _=null;R&&(_=this._reformulateOrderClauseWithoutGroupByFields(R));const W=await this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,o,_,this._internalObjectIdField);return this._checkCancelled(U),M=!0===Z.nowhereclause?new Y.A(W._candidates.slice(0).concat(W._known.slice(0)),[],!0===Z.ordered&&W._ordered,this._clonePageDefinition(W.pagesDefinition)):new Y.A(W._candidates.slice(0),W._known.slice(0),!0===Z.ordered&&W._ordered,this._clonePageDefinition(W.pagesDefinition)),M}let z=this._parent;if(this._adaptedFields.length>0&&(z=new V.a({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===Z.nowhereclause)M=new Y.A(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new J.A({parentfeatureset:z,orderbyclause:new K.A(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}});else{let o=z;if(null!==v){let _=null;v&&(_=this._reformulateWhereClauseWithoutGroupByFields(v)),o=new W.A({parentfeatureset:o,whereclause:_})}M=new Y.A(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new J.A({parentfeatureset:o,orderbyclause:new K.A(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}})}return M}_reformulateWhereClauseWithoutStatsFields(o){for(const _ of this._decodedStatsfield)o=(0,$.bD)(o,_.tofieldname,(0,$.YY)(_.workingexpr,X.zl.Standardised),this._parent.getFieldsIndex());return o}_reformulateWhereClauseWithoutGroupByFields(o){for(const _ of this._decodedGroupbyfield)_.tofieldname!==_.name&&(o=(0,$.bD)(o,_.tofieldname,(0,$.YY)(_.expression,X.zl.Standardised),this._parent.getFieldsIndex()));return o}_reformulateOrderClauseWithoutGroupByFields(o){const _=[];for(const v of this._decodedGroupbyfield)v.tofieldname!==v.name&&_.push({field:v.tofieldname,newfield:v.name});return _.length>0?o.replaceFields(_):o}_clonePageDefinition(o){return null===o?null:!0===o.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:o.resultRecordCount,resultOffset:o.resultOffset,internal:o.internal}:this._parent._clonePageDefinition(o)}async _refineSetBlock(o,_,v){if(!0===this._checkIfNeedToExpandCandidatePage(o,this._maxQuery))return await this._expandPagedSet(o,this._maxQuery,0,0,v),this._refineSetBlock(o,_,v);this._checkCancelled(v);o._candidates.length;return this._refineKnowns(o,_),o._candidates.length,o._candidates.length,o}_expandPagedSet(o,_,v,R,U){return this._expandPagedSetFeatureSet(o,_,v,R,U)}async _getPhysicalPage(o,_,v){if(!0===o.pagesDefinition.aggregatefeaturesetpagedefinition)return this._sequentialGetPhysicalItem(o,o.pagesDefinition.resultRecordCount,v,[]);const R=await this._getAgregagtePhysicalPage(o,_,v);for(const U of R){const o={geometry:U.geometry,attributes:{}},_={};for(const v in U.attributes)_[v.toLowerCase()]=U.attributes[v];for(const v of this._decodedGroupbyfield)o.attributes[v.tofieldname]=_[v.name.toLowerCase()];for(const v of this._decodedStatsfield)o.attributes[v.tofieldname]=_[v.field.toLowerCase()];this._featureCache[o.attributes[this.objectIdField]]=new Z.A(o)}return R.length}_sequentialGetPhysicalItem(o,_,v,R){return new Promise(((U,M)=>{null===o.pagesDefinition.internal.iterator&&(o.pagesDefinition.internal.iterator=o.pagesDefinition.internal.subfeatureset.iterator(v)),!0===o.pagesDefinition.internal.fullyResolved||0===_?U(R.length):this._nextAggregateItem(o,_,v,R,(M=>{null===M?U(R.length):(_-=1,U(this._sequentialGetPhysicalItem(o,_,v,R)))}),M)}))}_nextAggregateItem(o,_,v,R,U,W){try{(0,M.a2)(o.pagesDefinition.internal.iterator.next()).then((M=>{if(null===M)if(null!==o.pagesDefinition.internal.workingItem){const _=this._calculateAndAppendAggregateItem(o.pagesDefinition.internal.workingItem);R.push(_),o.pagesDefinition.internal.workingItem=null,o.pagesDefinition.internal.set.push(_.attributes[this.objectIdField]),o.pagesDefinition.internal.fullyResolved=!0,U(null)}else o.pagesDefinition.internal.fullyResolved=!0,U(null);else{const Z=this._generateAggregateHash(M);if(null===o.pagesDefinition.internal.workingItem)o.pagesDefinition.internal.workingItem={features:[M],id:Z};else{if(Z!==o.pagesDefinition.internal.workingItem.id){const v=this._calculateAndAppendAggregateItem(o.pagesDefinition.internal.workingItem);return R.push(v),o.pagesDefinition.internal.workingItem=null,o.pagesDefinition.internal.set.push(v.attributes[this.objectIdField]),_-=1,o.pagesDefinition.internal.workingItem={features:[M],id:Z},void U(v)}o.pagesDefinition.internal.workingItem.features.push(M)}this._nextAggregateItem(o,_,v,R,U,W)}}),W)}catch(Z){W(Z)}}_calculateFieldStat(o,_,v){const R=[];for(let U=0;U<o.features.length;U++)if(null!==_.workingexpr){const v=_.workingexpr.calculateValue(o.features[U]);null!==v&&(v instanceof ie.n||v instanceof se.k?R.push(v.toNumber()):v instanceof re.g?R.push(v.toMilliseconds()):R.push(v))}else R.push(null);switch(_.typeofstat){case"MIN":v.attributes[_.tofieldname]=(0,H.tQ)("min",R,-1);break;case"MAX":v.attributes[_.tofieldname]=(0,H.tQ)("max",R,-1);break;case"SUM":v.attributes[_.tofieldname]=(0,H.tQ)("sum",R,-1);break;case"COUNT":v.attributes[_.tofieldname]=R.length;break;case"VAR":v.attributes[_.tofieldname]=(0,H.tQ)("var",R,-1);break;case"STDDEV":v.attributes[_.tofieldname]=(0,H.tQ)("stddev",R,-1);break;case"AVG":v.attributes[_.tofieldname]=(0,H.tQ)("avg",R,-1)}return!0}_calculateAndAppendAggregateItem(o){const _={attributes:{},geometry:null};for(const R of this._decodedGroupbyfield){const v=R.singlefield?o.features[0].attributes[R.singlefield]:ee.WhereClause.convertValueToStorageFormat(R.expression.calculateValue(o.features[0]),R.sqlType);_.attributes[R.tofieldname]=v}for(const R of this._decodedStatsfield)this._calculateFieldStat(o,R,_);const v=[];for(let R=0;R<this._decodedStatsfield.length;R++)v.push(this._calculateFieldStat(o,this._decodedStatsfield[R],_));return this._featureCache[_.attributes[this.objectIdField]]=new Z.A({attributes:_.attributes,geometry:_.geometry}),_}_generateAggregateHash(o){let _="";for(const v of this._decodedGroupbyfield){const R=v.singlefield?o.attributes[v.singlefield]:v.expression.calculateValue(o);_+=null==R?":":":"+R.toString()}return(0,te.d)(_,te.T.String)}async _stat(){return{calculated:!1}}async getFeatureByObjectId(){return null}static registerAction(){Q.A._featuresetFunctions.groupby=function(o,_){return new O({parentfeatureset:this,groupbyfields:o,statsfields:_})}}}var oe=v(51834),ue=v(23663),de=v(50075),ce=v(78728),he=v(58989),fe=v(31670),pe=v(78395),_e=v(9370),ye=v(34009),ge=v(4180),me=v(50886),we=v(81618),ve=v(35999),Fe=v(25230),Se=v(35761),be=v(2569),Ie=v(94309),Ce=v(49096);async function f(o,_,R,U){return async function m(o,_,R,U){var M;const W=null===R||void 0===R?void 0:R.infoFor3D;if(!d(o,W)||null==W||!_.assetMaps||null===(M=_.features)||void 0===M||!M.length)return Ie.A.fromJSON(_);const{meshFeatureSetFromJSON:Z}=await(0,we.qr)(Promise.all([v.e(9278),v.e(8910),v.e(148),v.e(5017),v.e(2664),v.e(3933)]).then(v.bind(v,56372)),U);return Z(o,W,_)}(_,await async function c(o,_,v,R){var U;const M={...R},W=function p(o,_){var v,R;let U=Ce.A.from(o);U.sourceSpatialReference=null!==(v=null!==(R=U.sourceSpatialReference)&&void 0!==R?R:null===_||void 0===_?void 0:_.sourceSpatialReference)&&void 0!==v?v:null,((null===_||void 0===_?void 0:_.gdbVersion)||(null===_||void 0===_?void 0:_.dynamicDataSource))&&(U=U===o?U.clone():U,U.gdbVersion=o.gdbVersion||_.gdbVersion,U.dynamicDataSource=o.dynamicDataSource?Fe.L.from(o.dynamicDataSource):_.dynamicDataSource);const M=null===_||void 0===_?void 0:_.infoFor3D;if(null!=M&&d(o,M)){var W,Z;U=U===o?U.clone():U,U.formatOf3DObjects=null;const{supportedFormats:_,queryFormats:v}=M,R=null!==(W=(0,ve.R_)("model/gltf-binary",_))&&void 0!==W?W:(0,ve.E1)("glb",_),V=null!==(Z=(0,ve.R_)("model/gltf+json",_))&&void 0!==Z?Z:(0,ve.E1)("gtlf",_);for(const o of v){if(o===R){U.formatOf3DObjects=o;break}o!==V||U.formatOf3DObjects||(U.formatOf3DObjects=o)}if(!U.formatOf3DObjects)throw new ge.A("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==U.outFields||!U.outFields.includes("*")){U=U===o?U.clone():U,null==U.outFields&&(U.outFields=[]);const{originX:_,originY:v,originZ:R,translationX:W,translationY:Z,translationZ:V,scaleX:J,scaleY:z,scaleZ:Q,rotationX:Y,rotationY:K,rotationZ:X,rotationDeg:$}=M.transformFieldRoles;U.outFields.push(_,v,R,W,Z,V,J,z,Q,Y,K,X,$)}}return U}(_,v),Z=null!=(null===(U=_.outStatistics)||void 0===U?void 0:U[0]),V=(0,me.A)("featurelayer-pbf-statistics"),J=!Z||V;let z;if("pbf"===(null===v||void 0===v?void 0:v.format)&&J)try{z=await(0,be.S)(o,W,M)}catch(d){if("query:parsing-pbf"!==d.name)throw d;v.format="json"}return"json"!==(null===v||void 0===v?void 0:v.format)&&J||(z=await(0,Se.e)(o,W,M)),function l(o,_){if(null!=o&&null!=_)for(const v of _){const _=o.get(v.name);_&&Object.assign(v,_.toJSON())}}(null===v||void 0===v?void 0:v.fieldsIndex,z.fields),z}(o,_,R,U),R,U)}function d(o,_){return null!=_&&!0===o.returnGeometry&&"xyFootprint"!==o.multipatchOption&&!o.outStatistics}v(61272),v(76761),v(4270),v(72466),v(99524);var De=v(87849),Ae=(v(30174),v(89412),v(48343),v(60141),v(55476),v(39572),v(40954),v(49049),v(78535),v(73336)),Te=(v(21374),v(48237),v(84661),v(86745)),Re=(v(44190),v(82004));class P extends Q.A{constructor(o){super(o),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,o.spatialReference&&(this.spatialReference=o.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=o.layer,this._wset=null,void 0!==o.outFields&&(this._overrideFields=o.outFields),void 0!==o.includeGeometry&&(this._removeGeometry=!1===o.includeGeometry)}_maxQueryRate(){return X.gO}end(){return this._layer}optimisePagingFeatureQueries(o){this._pageJustIds=o}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(o){const _=this.urlQueryPath+","+(0,X.JB)(o.toJSON());return(0,te.d)(_,te.T.String)}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){var o,_,v,R;if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this.hasZ=!0===(null===(o=this._layer)||void 0===o||null===(o=o.capabilities)||void 0===o||null===(o=o.data)||void 0===o?void 0:o.supportsZ),this.hasM=!0===(null===(_=this._layer)||void 0===_||null===(_=_.capabilities)||void 0===_||null===(_=_.data)||void 0===_?void 0:_.supportsM),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const o=[],_=[];for(const v of this.fields)if("oid"===v.type)o.push(v),_.push(v.name);else for(const R of this._overrideFields)if(R.toLowerCase()===v.name.toLowerCase()){o.push(v),_.push(v.name);break}this.fields=o,this._overrideFields=_}if(this._layer.source&&this._layer.source.sourceJSON){const o=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=X.zl.StandardisedNoInterval,null!=o&&o>=10.61&&(this._databaseType=X.zl.Standardised)):null!=o&&(o>=10.5&&(this._databaseType=X.zl.StandardisedNoInterval,this._requestStandardised=!0),o>=10.61&&(this._databaseType=X.zl.Standardised))}this.objectIdField=this._layer.objectIdField;for(const U of this.fields)"global-id"===U.type&&(this.globalIdField=U.name);this._layer instanceof ye.default?(this.subtypeField=null!==(v=this._layer.subtypeField)&&void 0!==v?v:"",this.subtypes=this._layer.subtypes,this.types=null,this.typeIdField=null):(this.typeIdField=null!==(R=this._layer.typeIdField)&&void 0!==R?R:"",this.types=this._layer.types,this.subtypeField=this._layer.subtypeField,this.subtypes=this._layer.subtypes)}_isInFeatureSet(){return X.J6.InFeatureSet}async _refineSetBlock(o){return o}_candidateIdTransform(o){return o}async _getSet(o){if(null===this._wset){await this._ensureLoaded();const _=await this._getFilteredSet("",null,null,null,o);return this._wset=_,_}return this._wset}async _runDatabaseProbe(o){await this._ensureLoaded();const _=new Ce.A;this.datesInUnknownTimezone&&(_.timeReferenceUnknownClient=!0),_.where=o.replace("OBJECTID",this._layer.objectIdField);try{return await this._layer.queryObjectIds(_),!0}catch(v){return!1}}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(o){var _;const v=null===(_=this._layer)||void 0===_||null===(_=_.capabilities)||void 0===_?void 0:_.query;return!o.outStatistics&&!0===(null===v||void 0===v?void 0:v.supportsFormatPBF)&&!0===(null===v||void 0===v?void 0:v.supportsQuantizationEditMode)}async queryPBF(o){return o.quantizationParameters={mode:"edit"},(await f(this._layer.parsedUrl,o,{format:"pbf"},{})).unquantize()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||"SDE.DEFAULT":""}nativeCapabilities(){var o;return{title:null!==(o=this._layer.title)&&void 0!==o?o:"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(o,_){o.returnZ=this.hasZ,o.returnM=this.hasM;const v="execute"===_?Se.s:"executeForCount"===_?De.I:Ae.V,R="execute"===_&&this.pbfSupportedForQuery(o);let U=null;if(this.recentlyUsedQueries){const _=this.convertQueryToLruCacheKey(o);U=this.recentlyUsedQueries.getFromCache(_),null===U&&(U=!0!==R?v(this._layer.parsedUrl.path,o):this.queryPBF(o),this.recentlyUsedQueries.addToCache(_,U),U=U.catch((o=>{var v;throw null!==(v=this.recentlyUsedQueries)&&void 0!==v&&v.removeFromCache(_),o})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:o,method:_}),null===U&&(U=!0!==R?v(this._layer.parsedUrl.path,o):this.queryPBF(o)),U}async _getFilteredSet(o,_,v,R,U){const M=await this.databaseType();if(this.isTable()&&_&&null!==o&&""!==o)return new Y.A([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(o,_,v,R,U);let W="",Z=!1;null!==R&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(W=R.constructClause(),Z=!0);const V=new Ce.A;this.datesInUnknownTimezone&&(V.timeReferenceUnknownClient=!0),V.where=null===v?null===_?"1=1":"":(0,$.YY)(v,M),this._requestStandardised&&(V.sqlFormat="standard"),V.spatialRelationship=this._makeRelationshipEnum(o),V.outSpatialReference=this.spatialReference,V.orderByFields=""!==W?W.split(","):null,V.geometry=null===_?null:_,V.relationParameter=this._makeRelationshipParam(o);let J=await this.executeQuery(V,"executeForIds");return null===J&&(J=[]),this._checkCancelled(U),new Y.A([],J,Z,null)}_expandPagedSet(o,_,v,R,U){return this._expandPagedSetFeatureSet(o,_,v,R,U)}async _getFilteredSetUsingPaging(o,_,v,R,U){var M;let W="",Z=!1;null!==R&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(W=R.constructClause(),Z=!0);const V=await this.databaseType();let J=null===v?null===_?"1=1":"":(0,$.YY)(v,V);this._layer.definitionExpression&&this._useDefinitionExpression&&(J=""!==J?"(("+this._layer.definitionExpression+") AND ("+J+"))":this._layer.definitionExpression);let z=this._maxQueryRate();const Q=null===(M=this._layer.capabilities)||void 0===M?void 0:M.query.maxRecordCount;null!=Q&&Q<z&&(z=Q);let K=null;if(!0===this._pageJustIds)K=new Y.A([],["GETPAGES"],Z,{spatialRel:this._makeRelationshipEnum(o),relationParam:this._makeRelationshipParam(o),outFields:this._layer.objectIdField,resultRecordCount:z,resultOffset:0,geometry:null===_?null:_,where:J,orderByFields:W,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var X;let v=!0;!0===this._removeGeometry&&(v=!1);const R=null!==(X=this._overrideFields)&&void 0!==X?X:this._fieldsIncludingObjectId(["*"]);K=new Y.A([],["GETPAGES"],Z,{spatialRel:this._makeRelationshipEnum(o),relationParam:this._makeRelationshipParam(o),outFields:R.join(","),resultRecordCount:z,resultOffset:0,geometry:null===_?null:_,where:J,orderByFields:W,returnGeometry:v,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return await this._expandPagedSet(K,z,0,1,U),K}_clonePageDefinition(o){return null===o?null:!0!==o.groupbypage?{groupbypage:!1,spatialRel:o.spatialRel,relationParam:o.relationParam,outFields:o.outFields,resultRecordCount:o.resultRecordCount,resultOffset:o.resultOffset,geometry:o.geometry,where:o.where,orderByFields:o.orderByFields,returnGeometry:o.returnGeometry,returnIdsOnly:o.returnIdsOnly,internal:o.internal}:{groupbypage:!0,spatialRel:o.spatialRel,relationParam:o.relationParam,outFields:o.outFields,resultRecordCount:o.resultRecordCount,useOIDpagination:o.useOIDpagination,generatedOid:o.generatedOid,groupByFieldsForStatistics:o.groupByFieldsForStatistics,resultOffset:o.resultOffset,outStatistics:o.outStatistics,geometry:o.geometry,where:o.where,orderByFields:o.orderByFields,returnGeometry:o.returnGeometry,returnIdsOnly:o.returnIdsOnly,internal:o.internal}}async _getPhysicalPage(o,_,v){const R=o.pagesDefinition.internal.lastRetrieved,U=R,M=o.pagesDefinition.internal.lastPage,W=new Ce.A;this._requestStandardised&&(W.sqlFormat="standard"),this.datesInUnknownTimezone&&(W.timeReferenceUnknownClient=!0),W.spatialRelationship=o.pagesDefinition.spatialRel,W.relationParameter=o.pagesDefinition.relationParam,W.outFields=o.pagesDefinition.outFields.split(","),W.num=o.pagesDefinition.resultRecordCount,W.start=o.pagesDefinition.internal.lastPage,W.geometry=o.pagesDefinition.geometry,W.where=o.pagesDefinition.where,W.orderByFields=""!==o.pagesDefinition.orderByFields?o.pagesDefinition.orderByFields.split(","):null,W.returnGeometry=o.pagesDefinition.returnGeometry,W.outSpatialReference=this.spatialReference;const Z=await this.executeQuery(W,"execute");if(this._checkCancelled(v),o.pagesDefinition.internal.lastPage!==M)return"done";const V=this._layer.objectIdField;for(let J=0;J<Z.features.length;J++)o.pagesDefinition.internal.set[U+J]=Z.features[J].attributes[V];if(!1===this._pageJustIds)for(let J=0;J<Z.features.length;J++)this._featureCache[Z.features[J].attributes[V]]=Z.features[J];return(void 0===Z.exceededTransferLimit&&Z.features.length!==o.pagesDefinition.resultRecordCount||!1===Z.exceededTransferLimit)&&(o.pagesDefinition.internal.fullyResolved=!0),o.pagesDefinition.internal.lastRetrieved=R+Z.features.length,o.pagesDefinition.internal.lastPage+=o.pagesDefinition.resultRecordCount,"done"}_fieldsIncludingObjectId(o){if(null===o)return[this.objectIdField];const _=o.slice(0);if(_.includes("*"))return _;let v=!1;for(const R of _)if(R.toUpperCase()===this.objectIdField.toUpperCase()){v=!0;break}return!1===v&&_.push(this.objectIdField),_}async _getFeatures(o,_,v,R){var U;const M=[];if(-1!==_&&void 0===this._featureCache[_]&&M.push(_),!0===this._checkIfNeedToExpandKnownPage(o,this._maxProcessingRate()))return await this._expandPagedSet(o,this._maxProcessingRate(),0,0,R),this._getFeatures(o,_,v,R);let W=0;for(let z=o._lastFetchedIndex;z<o._known.length;z++){if(o._lastFetchedIndex+=1,W++,void 0===this._featureCache[o._known[z]]){let v=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){const _=this._layer._mode;if(void 0!==_._featureMap[o._known[z]]){const R=_._featureMap[o._known[z]];null!==R&&(v=!0,this._featureCache[o._known[z]]=R)}}if(!1===v&&(o._known[z]!==_&&M.push(o._known[z]),M.length>=this._maxProcessingRate()-1))break}if(W>=v&&0===M.length)break}if(0===M.length)return"success";const Z=new Ce.A;this._requestStandardised&&(Z.sqlFormat="standard"),this.datesInUnknownTimezone&&(Z.timeReferenceUnknownClient=!0),Z.objectIds=M,Z.outFields=null!==(U=this._overrideFields)&&void 0!==U?U:this._fieldsIncludingObjectId(["*"]),Z.returnGeometry=!0,!0===this._removeGeometry&&(Z.returnGeometry=!1),Z.outSpatialReference=this.spatialReference;const V=await this.executeQuery(Z,"execute");if(this._checkCancelled(R),void 0!==V.error)throw new z.dr(z.D_.RequestFailed,{reason:V.error});const J=this._layer.objectIdField;for(let z=0;z<V.features.length;z++)this._featureCache[V.features[z].attributes[J]]=V.features[z];return"success"}async _getDistinctPages(o,_,v,R,U,M,W,Z,V){var J,Q;await this._ensureLoaded();const Y=await this.databaseType();let K=v.parseTree.column;const X=null!==(J=this._layer.fields)&&void 0!==J?J:[];for(let z=0;z<X.length;z++)if(X[z].name.toLowerCase()===K.toLowerCase()){K=X[z].name;break}const H=new Ce.A;this._requestStandardised&&(H.sqlFormat="standard"),this.datesInUnknownTimezone&&(H.timeReferenceUnknownClient=!0);let ee=null===M?null===U?"1=1":"":(0,$.YY)(M,Y);this._layer.definitionExpression&&this._useDefinitionExpression&&(ee=""!==ee?"(("+this._layer.definitionExpression+") AND ("+ee+"))":this._layer.definitionExpression),H.where=ee,H.spatialRelationship=this._makeRelationshipEnum(R),H.relationParameter=this._makeRelationshipParam(R),H.geometry=null===U?null:U,H.returnDistinctValues=!0,H.returnGeometry=!1,H.outFields=[K];const te=await this.executeQuery(H,"execute");if(this._checkCancelled(V),!te.hasOwnProperty("features"))throw new z.dr(z.D_.InvalidStatResponse);let ie=!1;for(let z=0;z<X.length;z++)if(X[z].name===K){"date"===X[z].type&&(ie=!0);break}for(let z=0;z<te.features.length;z++){if(ie){const o=te.features[z].attributes[K];null!==o?Z.push(new Date(o)):Z.push(o)}else Z.push(te.features[z].attributes[K]);if(Z.length>=W)break}return 0===te.features.length?Z:te.features.length===(null===(Q=this._layer.capabilities)||void 0===Q?void 0:Q.query.maxRecordCount)&&Z.length<W?{calculated:!0,result:await this._getDistinctPages(o+te.features.length,_,v,R,U,M,W,Z,V)}:Z}async _distinctStat(o,_,v,R,U,M,W){return{calculated:!0,result:await this._getDistinctPages(0,o,_,v,R,U,M,[],W)}}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType}async _countstat(o,_,v,R){const U=await this.databaseType(),M=new Ce.A;if(this._requestStandardised&&(M.sqlFormat="standard"),this.isTable()&&v&&null!==_&&""!==_)return{calculated:!0,result:0};let W=null===R?null===v?"1=1":"":(0,$.YY)(R,U);return this._layer.definitionExpression&&this._useDefinitionExpression&&(W=""!==W?"(("+this._layer.definitionExpression+") AND ("+W+"))":this._layer.definitionExpression),M.where=W,this.datesInUnknownTimezone&&(M.timeReferenceUnknownClient=!0),M.where=W,M.spatialRelationship=this._makeRelationshipEnum(_),M.relationParameter=this._makeRelationshipParam(_),M.geometry=null===v?null:v,M.returnGeometry=!1,{calculated:!0,result:await this.executeQuery(M,"executeForCount")}}async _stats(o,_,v,R,U,M,W){var Z;await this._ensureLoaded();const V=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,J=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,Q=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;if("count"===o)return Q?this._countstat(o,v,R,U):{calculated:!1};if(!1===J||!1===(0,$.DA)(_)&&!1===V||!1===_.isStandardized)return""!==v||null!==U?{calculated:!1}:this._manualStat(o,_,M,W);if("distinct"===o)return!1===Q?""!==v||null!==U?{calculated:!1}:this._manualStat(o,_,M,W):this._distinctStat(o,_,v,R,U,M,W);const Y=await this.databaseType();if(this.isTable()&&R&&null!==v&&""!==v)return{calculated:!0,result:null};const K=new Ce.A;this._requestStandardised&&(K.sqlFormat="standard");let X=null===U?null===R?"1=1":"":(0,$.YY)(U,Y);this._layer.definitionExpression&&this._useDefinitionExpression&&(X=""!==X?"(("+this._layer.definitionExpression+") AND ("+X+"))":this._layer.definitionExpression),K.where=X,K.spatialRelationship=this._makeRelationshipEnum(v),K.relationParameter=this._makeRelationshipParam(v),K.geometry=null===R?null:R,this.datesInUnknownTimezone&&(K.timeReferenceUnknownClient=!0);const ee=new Re.A;ee.statisticType=(0,H.Dp)(o),ee.onStatisticField=(0,$.YY)(_,Y),ee.outStatisticFieldName="ARCADE_STAT_RESULT",K.returnGeometry=!1;let te="ARCADE_STAT_RESULT";K.outStatistics=[ee];const ie=await this.executeQuery(K,"execute");if(!ie.hasOwnProperty("features")||0===ie.features.length)throw new z.dr(z.D_.InvalidStatResponse);let re=!1;const se=null!==(Z=ie.fields)&&void 0!==Z?Z:[];for(let z=0;z<se.length;z++)if("ARCADE_STAT_RESULT"===se[z].name.toUpperCase()){te=se[z].name,"date"===se[z].type&&(re=!0);break}if(re){let o=ie.features[0].attributes[te];return null!==o&&(o=new Date(ie.features[0].attributes[te])),{calculated:!0,result:o}}return{calculated:!0,result:ie.features[0].attributes[te]}}_stat(o,_,v,R,U,M,W){return this._stats(o,_,v,R,U,M,W)}async _canDoAggregates(o,_){var v;await this._ensureLoaded();let R=!1;const U=null===(v=this._layer.capabilities)||void 0===v?void 0:v.query,M=!0===(null===U||void 0===U?void 0:U.supportsSqlExpression);if(null!=U&&!0===U.supportsStatistics&&!0===U.supportsOrderBy&&(R=!0),R)for(let Z=0;Z<_.length-1;Z++){var W;(!1===(null===(W=_[Z].workingexpr)||void 0===W?void 0:W.isStandardized)||!1===(0,$.DA)(_[Z].workingexpr)&&!1===M)&&(R=!1)}return!1!==R}_makeRelationshipEnum(o){if(o.includes("esriSpatialRelRelation"))return"relation";switch(o){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return o}_makeRelationshipParam(o){return o.includes("esriSpatialRelRelation")?o.split(":")[1]:""}async _getAggregatePagesDataSourceDefinition(o,_,v,R,U,M,W){var Z;await this._ensureLoaded();const V=await this.databaseType();let J="",z=!1,Q=!1;null!==M&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(J=M.constructClause(),Q=!0),this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(Q=!1,z=!0,J=this._layer.objectIdField);const K=[];for(let Y=0;Y<_.length;Y++){const o=new Re.A;o.onStatisticField=null!==_[Y].workingexpr?(0,$.YY)(_[Y].workingexpr,V):"",o.outStatisticFieldName=_[Y].field,o.statisticType=_[Y].toStatisticsName(),K.push(o)}""===J&&(J=o.join(","));let X=this._maxQueryRate();const H=null===(Z=this._layer.capabilities)||void 0===Z?void 0:Z.query.maxRecordCount;null!=H&&H<X&&(X=H);let ee=null===U?null===R?"1=1":"":(0,$.YY)(U,V);return this._layer.definitionExpression&&this._useDefinitionExpression&&(ee=""!==ee?"(("+this._layer.definitionExpression+") AND ("+ee+"))":this._layer.definitionExpression),new Y.A([],["GETPAGES"],Q,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(v),relationParam:this._makeRelationshipParam(v),outFields:["*"],useOIDpagination:z,generatedOid:W,resultRecordCount:X,resultOffset:0,groupByFieldsForStatistics:o,outStatistics:K,geometry:null===R?null:R,where:ee,orderByFields:J,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}async _getAgregagtePhysicalPage(o,_,v){let R=o.pagesDefinition.where;!0===o.pagesDefinition.useOIDpagination&&(R=""!==R?"("+R+") AND ("+o.pagesDefinition.generatedOid+">"+o.pagesDefinition.internal.lastMaxId.toString()+")":o.pagesDefinition.generatedOid+">"+o.pagesDefinition.internal.lastMaxId.toString());const U=o.pagesDefinition.internal.lastRetrieved,M=U,W=o.pagesDefinition.internal.lastPage,V=new Ce.A;if(this._requestStandardised&&(V.sqlFormat="standard"),V.where=R,V.spatialRelationship=o.pagesDefinition.spatialRel,V.relationParameter=o.pagesDefinition.relationParam,V.outFields=o.pagesDefinition.outFields,V.outStatistics=o.pagesDefinition.outStatistics,V.geometry=o.pagesDefinition.geometry,V.groupByFieldsForStatistics=o.pagesDefinition.groupByFieldsForStatistics,V.num=o.pagesDefinition.resultRecordCount,V.start=o.pagesDefinition.internal.lastPage,V.returnGeometry=o.pagesDefinition.returnGeometry,this.datesInUnknownTimezone&&(V.timeReferenceUnknownClient=!0),V.orderByFields=""!==o.pagesDefinition.orderByFields?o.pagesDefinition.orderByFields.split(","):null,this.isTable()&&V.geometry&&V.spatialRelationship)return[];const J=await this.executeQuery(V,"execute");if(this._checkCancelled(v),!J.hasOwnProperty("features"))throw new z.dr(z.D_.InvalidStatResponse);const Q=[];if(o.pagesDefinition.internal.lastPage!==W)return[];J.features.length>0&&void 0===J.features[0].attributes[o.pagesDefinition.generatedOid]&&(o.pagesDefinition.generatedOid=o.pagesDefinition.generatedOid.toLowerCase());for(let Z=0;Z<J.features.length;Z++)o.pagesDefinition.internal.set[M+Z]=J.features[Z].attributes[o.pagesDefinition.generatedOid];for(let z=0;z<J.features.length;z++)Q.push(new Z.A({attributes:J.features[z].attributes,geometry:null}));return!0===o.pagesDefinition.useOIDpagination?0===J.features.length?o.pagesDefinition.internal.fullyResolved=!0:o.pagesDefinition.internal.lastMaxId=J.features[J.features.length-1].attributes[o.pagesDefinition.generatedOid]:(void 0===J.exceededTransferLimit&&J.features.length!==o.pagesDefinition.resultRecordCount||!1===J.exceededTransferLimit)&&(o.pagesDefinition.internal.fullyResolved=!0),o.pagesDefinition.internal.lastRetrieved=U+J.features.length,o.pagesDefinition.internal.lastPage+=o.pagesDefinition.resultRecordCount,Q}static create(o,_,v,R,U){const M=new _e.default({url:o,outFields:null===_?["*"]:_});return new P({layer:M,spatialReference:v,lrucache:R,interceptor:U})}relationshipMetaData(){var o;return this._layer&&this._layer.source&&null!==(o=this._layer.source.sourceJSON)&&void 0!==o&&o.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,X.Qi)(this._layer.parsedUrl.path)}async queryAttachments(o,_,v,R,U){const M=this._layer.capabilities;if(null!==M&&void 0!==M&&M.data.supportsAttachment&&null!==M&&void 0!==M&&M.operations.supportsQueryAttachments){const M={objectIds:[o],returnMetadata:U};(_&&_>0||v&&v>0)&&(M.size=[_&&_>0?_:0,v&&v>0?v:_+1]),R&&R.length>0&&(M.attachmentTypes=R),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:M,method:"attachments"});const W=await this._layer.queryAttachments(M),Z=[];return W&&W[o]&&W[o].forEach((_=>{var v;const R=this._layer.parsedUrl.path+"/"+o.toString()+"/attachments/"+_.id.toString();let M=null;U&&_.exifInfo&&(M=he.A.convertJsonToArcade(_.exifInfo,"system",!0)),Z.push(new ce.A(_.id,_.name,_.contentType,_.size,R,M,null!==(v=_.keywords)&&void 0!==v?v:null))})),Z}return[]}async queryRelatedFeatures(o){var _;const v={f:"json",relationshipId:o.relationshipId.toString(),definitionExpression:o.where,outFields:null===(_=o.outFields)||void 0===_?void 0:_.join(","),returnGeometry:o.returnGeometry.toString()};void 0!==o.resultOffset&&null!==o.resultOffset&&(v.resultOffset=o.resultOffset.toString()),void 0!==o.resultRecordCount&&null!==o.resultRecordCount&&(v.resultRecordCount=o.resultRecordCount.toString()),o.orderByFields&&(v.orderByFields=o.orderByFields.join(",")),o.objectIds&&o.objectIds.length>0&&(v.objectIds=o.objectIds.join(",")),o.outSpatialReference&&(v.outSR=(0,pe.YX)(o.outSpatialReference)),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:v,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});const U=await(0,R.A)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:v});if(U.data){const o={},_=U.data;if(null!==_&&void 0!==_&&_.relatedRecordGroups){const v=_.spatialReference;for(const R of _.relatedRecordGroups){const U=R.objectId,M=[];for(const o of R.relatedRecords){o.geometry&&(o.geometry.spatialReference=v);const _=new Z.A({geometry:o.geometry?(0,fe.rS)(o.geometry):null,attributes:o.attributes});M.push(_)}o[U]={features:M,exceededTransferLimit:!0===_.exceededTransferLimit}}}return o}throw new z.dr(z.D_.InvalidRequest)}async getFeatureByObjectId(o,_){const v=new Ce.A;v.outFields=_,v.returnGeometry=!1,v.outSpatialReference=this.spatialReference,v.where=this.objectIdField+"="+o.toString(),this.datesInUnknownTimezone&&(v.timeReferenceUnknownClient=!0),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:v,method:"execute"});const R=await(0,Se.s)(this._layer.parsedUrl.path,v);return 1===R.features.length?R.features[0]:null}async getIdentityUser(){await this.load();const o=null===de.id||void 0===de.id?void 0:de.id.findCredential(this._layer.url);return o?o.userId:null}async getOwningSystemUrl(){await this.load();const o=null===de.id||void 0===de.id?void 0:de.id.findServerInfo(this._layer.url);if(o)return o.owningSystemUrl;let _=this._layer.url;const v=_.toLowerCase().indexOf("/rest/services");if(_=v>-1?_.substring(0,v):_,_){_+="/rest/info";try{var U;const o=await(0,R.A)(_,{query:{f:"json"}});let v="";return null!==(U=o.data)&&void 0!==U&&U.owningSystemUrl&&(v=o.data.owningSystemUrl),v}catch(M){return""}}return""}getDataSourceFeatureSet(){var o,_,v,R;const U=new P({layer:this._layer,spatialReference:null!==(o=this.spatialReference)&&void 0!==o?o:void 0,outFields:null!==(_=this._overrideFields)&&void 0!==_?_:void 0,includeGeometry:!this._removeGeometry,lrucache:null!==(v=this.recentlyUsedQueries)&&void 0!==v?v:void 0,interceptor:null!==(R=this.featureSetQueryInterceptor)&&void 0!==R?R:void 0});return U._useDefinitionExpression=!1,U}get preferredTimeZone(){var o;return null!==(o=this._layer.preferredTimeZone)&&void 0!==o?o:null}get dateFieldsTimeZone(){var o;return null!==(o=this._layer.dateFieldsTimeZone)&&void 0!==o?o:null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone}get editFieldsInfo(){var o;return null!==(o=this._layer.editFieldsInfo)&&void 0!==o?o:null}get timeInfo(){var o;return null!==(o=this._layer.timeInfo)&&void 0!==o?o:null}async getFeatureSetInfo(){var o,_,v;if(this.fsetInfo)return this.fsetInfo;let U=null,{parsedUrl:{path:M},serviceItemId:W=null}=this._layer;if(M){var Z,V,J,z;const o=await(0,R.A)(M,{responseType:"json",query:{f:"json"}});U=null!==(Z=null===o||void 0===o||null===(V=o.data)||void 0===V?void 0:V.name)&&void 0!==Z?Z:null,W=null!==(J=null===o||void 0===o||null===(z=o.data)||void 0===z?void 0:z.serviceItemId)&&void 0!==J?J:null}const Q=this._layer.title&&null!==(null!==(o=this._layer.parent)&&void 0!==o?o:null);return this.featureSetInfo={layerId:this._layer.layerId,layerName:""===U?null:U,itemId:""===W?null:W,serviceLayerUrl:""===M?null:M,webMapLayerId:Q&&null!==(_=this._layer.id)&&void 0!==_?_:null,webMapLayerTitle:Q&&null!==(v=this._layer.title)&&void 0!==v?v:null,className:null,objectClassId:null},this.fsetInfo}}var xe=v(77125);class FeatureLayerRelated_d extends Q.A{constructor(o){super(o),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,o.spatialReference&&(this.spatialReference=o.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=o.layer,this._wset=null,this._findObjectId=o.objectId,this.featureObjectId=o.objectId,this.relationship=o.relationship,this._relatedLayer=o.relatedLayer,void 0!==o.outFields&&(this._overrideFields=o.outFields),void 0!==o.includeGeometry&&(this._removeGeometry=!1===o.includeGeometry)}_maxQueryRate(){return X.gO}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){var o;return await Promise.all([this._layer.load(),null===(o=this._relatedLayer)||void 0===o?void 0:o.load()]),this._initialiseFeatureSet(),this}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const o=[],_=[];for(const v of this.fields)if("oid"===v.type)o.push(v),_.push(v.name);else for(const R of this._overrideFields)if(R.toLowerCase()===v.name.toLowerCase()){o.push(v),_.push(v.name);break}this.fields=o,this._overrideFields=_}const o=this._layer.nativeCapabilities();o&&(this._databaseType=o.databaseType,this._requestStandardised=o.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types,this.subtypeField=this._relatedLayer.subtypeField,this.subtypes=this._relatedLayer.subtypes}async databaseType(){return await this._relatedLayer.databaseType(),this._databaseType=this._relatedLayer._databaseType,this._databaseType}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return X.J6.InFeatureSet}_candidateIdTransform(o){return o}async _getSet(o){if(null===this._wset){await this._ensureLoaded();const _=await this._getFilteredSet("",null,null,null,o);return this._wset=_,_}return this._wset}_changeFeature(o){const _={};for(const v of this.fields)_[v.name]=o.attributes[v.name];return new Z.A({geometry:!0===this._removeGeometry?null:o.geometry,attributes:_})}async _getFilteredSet(o,_,v,R,U){var M,W;if(await this.databaseType(),this.isTable()&&_&&null!==o&&""!==o)return new Y.A([],[],!0,null);const Z=this._layer.nativeCapabilities();if(!1===Z.canQueryRelated)return new Y.A([],[],!0,null);if(null!==(M=Z.capabilities)&&void 0!==M&&M.queryRelated&&Z.capabilities.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(o,_,v,R,U);let V="",J=!1;null!==R&&(null===(W=Z.capabilities)||void 0===W?void 0:W.queryRelated)&&!0===Z.capabilities.queryRelated.supportsOrderBy&&(V=R.constructClause(),J=!0);const z=new Te.default;z.objectIds=[this._findObjectId];const Q=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((o=>o.name)):["*"]);z.outFields=Q,z.relationshipId=this.relationship.id,z.where="1=1";let K=!0;!0===this._removeGeometry&&(K=!1),z.returnGeometry=K,this._requestStandardised&&(z.sqlFormat="standard"),z.outSpatialReference=this.spatialReference,z.orderByFields=""!==V?V.split(","):null;const X=await Z.source.queryRelatedFeatures(z);this._checkCancelled(U);const $=X[this._findObjectId]?X[this._findObjectId].features:[],H=[];for(let Y=0;Y<$.length;Y++)this._featureCache[$[Y].attributes[this._relatedLayer.objectIdField]]=$[Y],H.push($[Y].attributes[this._relatedLayer.objectIdField]);const ee=_&&null!==o&&""!==o,te=null!=v;return new Y.A(ee||te?H:[],ee||te?[]:H,J,null)}_fieldsIncludingObjectId(o){if(null===o)return[this.objectIdField];const _=o.slice(0);if(_.includes("*"))return _;let v=!1;for(const R of _)if(R.toUpperCase()===this.objectIdField.toUpperCase()){v=!0;break}return!1===v&&_.push(this.objectIdField),_}async _getFilteredSetUsingPaging(o,_,v,R,U){var M,W;let Z="",V=!1;const J=this._layer.nativeCapabilities();null!==R&&null!==J&&void 0!==J&&null!==(M=J.capabilities)&&void 0!==M&&M.queryRelated&&!0===J.capabilities.queryRelated.supportsOrderBy&&(Z=R.constructClause(),V=!0),await this.databaseType();let z=this._maxQueryRate();const Q=null===(W=J.capabilities)||void 0===W?void 0:W.query.maxRecordCount;null!=Q&&Q<z&&(z=Q);const K=_&&null!==o&&""!==o,X=null!=v;let $=null,H=!0;!0===this._removeGeometry&&(H=!1);const ee=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map((o=>o.name)):["*"]);return $=new Y.A(K||X?["GETPAGES"]:[],K||X?[]:["GETPAGES"],V,{outFields:ee.join(","),resultRecordCount:z,resultOffset:0,objectIds:[this._findObjectId],where:"1=1",orderByFields:Z,returnGeometry:H,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),await this._expandPagedSet($,z,0,0,U),$}_expandPagedSet(o,_,v,R,U){return this._expandPagedSetFeatureSet(o,_,v,R,U)}_clonePageDefinition(o){return null===o?null:!0!==o.groupbypage?{groupbypage:!1,outFields:o.outFields,resultRecordCount:o.resultRecordCount,resultOffset:o.resultOffset,where:o.where,objectIds:o.objectIds,orderByFields:o.orderByFields,returnGeometry:o.returnGeometry,returnIdsOnly:o.returnIdsOnly,internal:o.internal}:{groupbypage:!0,outFields:o.outFields,resultRecordCount:o.resultRecordCount,useOIDpagination:o.useOIDpagination,generatedOid:o.generatedOid,groupByFieldsForStatistics:o.groupByFieldsForStatistics,resultOffset:o.resultOffset,outStatistics:o.outStatistics,geometry:o.geometry,where:o.where,objectIds:o.objectIds,orderByFields:o.orderByFields,returnGeometry:o.returnGeometry,returnIdsOnly:o.returnIdsOnly,internal:o.internal}}async _getPhysicalPage(o,_,v){const R=o.pagesDefinition.internal.lastRetrieved,U=R,M=o.pagesDefinition.internal.lastPage,W=this._layer.nativeCapabilities(),Z=new Te.default;!0===this._requestStandardised&&(Z.sqlFormat="standard"),Z.relationshipId=this.relationship.id,Z.objectIds=o.pagesDefinition.objectIds,Z.resultOffset=o.pagesDefinition.internal.lastPage,Z.resultRecordCount=o.pagesDefinition.resultRecordCount,Z.outFields=o.pagesDefinition.outFields.split(","),Z.where=o.pagesDefinition.where,Z.orderByFields=""!==o.pagesDefinition.orderByFields?o.pagesDefinition.orderByFields.split(","):null,Z.returnGeometry=o.pagesDefinition.returnGeometry,Z.outSpatialReference=this.spatialReference;const V=await W.source.queryRelatedFeatures(Z);if(this._checkCancelled(v),o.pagesDefinition.internal.lastPage!==M)return 0;const J=V[this._findObjectId]?V[this._findObjectId].features:[];for(let Q=0;Q<J.length;Q++)o.pagesDefinition.internal.set[U+Q]=J[Q].attributes[this._relatedLayer.objectIdField];for(let Q=0;Q<J.length;Q++)this._featureCache[J[Q].attributes[this._relatedLayer.objectIdField]]=J[Q];const z=!V[this._findObjectId]||!1===V[this._findObjectId].exceededTransferLimit;return J.length!==o.pagesDefinition.resultRecordCount&&z&&(o.pagesDefinition.internal.fullyResolved=!0),o.pagesDefinition.internal.lastRetrieved=R+J.length,o.pagesDefinition.internal.lastPage+=o.pagesDefinition.resultRecordCount,J.length}async _getFeatures(o,_,v,R){const U=[];-1!==_&&void 0===this._featureCache[_]&&U.push(_);const M=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(o,M))return await this._expandPagedSet(o,M,0,0,R),this._getFeatures(o,_,v,R);let W=0;for(let Z=o._lastFetchedIndex;Z<o._known.length&&(W++,W<=v&&(o._lastFetchedIndex+=1),!("GETPAGES"!==o._known[Z]&&void 0===this._featureCache[o._known[Z]]&&(o._known[Z]!==_&&U.push(o._known[Z]),U.length>v)))&&!(W>=v&&0===U.length);Z++);if(0===U.length)return"success";throw new z.dr(z.D_.MissingFeatures)}async _refineSetBlock(o,_,v){return o}async _stat(o,_,v,R,U,M,W){return{calculated:!1}}get gdbVersion(){return this._relatedLayer.gdbVersion}async _canDoAggregates(o,_,v,R,U){return!1}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(o,_,v,R,U){return this._relatedLayer.queryAttachments(o,_,v,R,U)}getFeatureByObjectId(o,_){return this._relatedLayer.getFeatureByObjectId(o,_)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeZone(){var o,_;return null!==(o=null===(_=this._relatedLayer)||void 0===_?void 0:_.preferredTimeZone)&&void 0!==o?o:null}get dateFieldsTimeZone(){var o,_;return null!==(o=null===(_=this._relatedLayer)||void 0===_?void 0:_.dateFieldsTimeZone)&&void 0!==o?o:null}get datesInUnknownTimezone(){var o;return null===(o=this._relatedLayer)||void 0===o?void 0:o.datesInUnknownTimezone}get editFieldsInfo(){var o,_;return null!==(o=null===(_=this._relatedLayer)||void 0===_?void 0:_.editFieldsInfo)&&void 0!==o?o:null}get timeInfo(){var o,_;return null!==(o=null===(_=this._relatedLayer)||void 0===_?void 0:_.timeInfo)&&void 0!==o?o:null}async getFeatureSetInfo(){var o;return null!==(o=this.fsetInfo)&&void 0!==o?o:this._layer.featureSetInfo}}var ke=v(68734),Ne=v(35799);function I(){null===ke.A.applicationCache&&(ke.A.applicationCache=new ke.A)}async function S(o,_){if(ke.A.applicationCache){const R=ke.A.applicationCache.getLayerInfo(o);if(R){const v=await R;return new _e.default({url:o,outFields:_,sourceJSON:v})}const U=new _e.default({url:o,outFields:_}),M=(async()=>(await U.load(),U.sourceJSON))();if(ke.A.applicationCache){ke.A.applicationCache.setLayerInfo(o,M);try{return await M,U}catch(v){throw ke.A.applicationCache.clearLayerInfo(o),v}}return await M,U}return new _e.default({url:o,outFields:_})}async function F(o,_,v,R,U){let M=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return g(await S(o,["*"]),_,v,R,U,M)}function g(o){let _=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,R=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],U=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,W=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;if(o instanceof _e.default||(0,M.a0)(o)){const M={layer:o,spatialReference:_,outFields:v,includeGeometry:R,lrucache:U,interceptor:W};return 1==!(o.url||!o.source)?new xe.A(M):new P(M)}const Z=g(o.parent,_,v,R,U,W);return Z.filter(ee.WhereClause.create(o.parent.subtypeField+"="+o.subtypeCode.toString(),o.parent.fieldsIndex,Z.dateFieldsTimeZoneDefaultUTC))}async function T(o){if(null!==ke.A.applicationCache){const _=ke.A.applicationCache.getLayerInfo(o);if(null!==_)return _}const _=(async()=>{const _=await(0,R.A)(o,{responseType:"json",query:{f:"json"}});if(_.data){const o=_.data;return o.layers||(o.layers=[]),o.tables||(o.tables=[]),o}return{layers:[],tables:[]}})();if(null!==ke.A.applicationCache){ke.A.applicationCache.setLayerInfo(o,_);try{return await _}catch(v){throw ke.A.applicationCache.clearLayerInfo(o),v}}return _}async function A(o,_){var v;const U={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},M=await T(o);if(U.metadata=M,void 0!==(null===(v=M.controllerDatasetLayers)||void 0===v?void 0:v.utilityNetworkLayerId)&&null!==M.controllerDatasetLayers.utilityNetworkLayerId){if(M.layers)for(const o of M.layers)U.layerNameLkp[o.id]=o.name;if(M.tables)for(const o of M.tables)U.layerNameLkp[o.id]=o.name;const v=M.controllerDatasetLayers.utilityNetworkLayerId;U.networkId=v;const K=await async function C(o,_){const v="QUERYDATAELEMTS:"+_.toString()+":"+o;if(null!==ke.A.applicationCache){const o=ke.A.applicationCache.getLayerInfo(v);if(null!==o)return o}const U=(async()=>{const v=await(0,R.A)(o+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([_.toString()]),f:"json"}});if(v.data){var U;const o=v.data;if(null!==(U=o.layerDataElements)&&void 0!==U&&U[0])return o.layerDataElements[0]}throw new z.dr(z.D_.DataElementsNotFound)})();if(null!==ke.A.applicationCache){ke.A.applicationCache.setLayerInfo(v,U);try{return await U}catch(K){throw ke.A.applicationCache.clearLayerInfo(v),K}}return U}(o,v);if(K){var W,Z;U.queryelem=K,null!==(W=U.queryelem)&&void 0!==W&&W.dataElement&&void 0!==U.queryelem.dataElement.schemaGeneration&&(U.unVersion=U.queryelem.dataElement.schemaGeneration),U.lkp={},U.queryelem.dataElement.domainNetworks||(U.queryelem.dataElement.domainNetworks=[]);for(const o of U.queryelem.dataElement.domainNetworks){for(const _ of null!==(V=o.edgeSources)&&void 0!==V?V:[]){var V,J;const o={layerId:_.layerId,sourceId:_.sourceId,className:null!==(J=U.layerNameLkp[_.layerId])&&void 0!==J?J:null};o.className&&(U.lkp[o.className]=o)}for(const _ of null!==(Q=o.junctionSources)&&void 0!==Q?Q:[]){var Q,Y;const o={layerId:_.layerId,sourceId:_.sourceId,className:null!==(Y=U.layerNameLkp[_.layerId])&&void 0!==Y?Y:null};o.className&&(U.lkp[o.className]=o)}}if(U.queryelem.dataElement.terminalConfigurations)for(const o of U.queryelem.dataElement.terminalConfigurations)for(const _ of o.terminals)U.terminals.push({terminalId:_.terminalId,terminalName:_.terminalName});const M=await async function N(o){if(null!==ke.A.applicationCache){const _=ke.A.applicationCache.getLayerInfo(o);if(null!==_)return _}const _=(async()=>{const _=await(0,R.A)(o,{responseType:"json",query:{f:"json"}});return _.data?_.data:null})();if(null!==ke.A.applicationCache){ke.A.applicationCache.setLayerInfo(o,_);try{return await _}catch(M){throw ke.A.applicationCache.clearLayerInfo(o),M}}return _}(o+"/"+v);if(void 0!==(null===(Z=M.systemLayers)||void 0===Z?void 0:Z.associationsTableId)&&null!==M.systemLayers.associationsTableId){const v=[];U.unVersion>=4&&(v.push("STATUS"),v.push("PERCENTALONG"));let R=await F(o+"/"+M.systemLayers.associationsTableId.toString(),_,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...v],!1,null,null);return await R.load(),U.unVersion>=4&&(R=R.filter(ee.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)",R.getFieldsIndex(),R.dateFieldsTimeZoneDefaultUTC)),await R.load()),{lkp:U.lkp,associations:R,unVersion:U.unVersion,terminals:U.terminals}}return{associations:null,unVersion:U.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:U.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:U.unVersion,lkp:null,terminals:[]}}async function k(o,_,v){let R=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,U=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,M=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],W=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,Z=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,V=o.serviceUrl();if(!V)return null;V="/"===V.charAt(V.length-1)?V+_.relatedTableId.toString():V+"/"+_.relatedTableId.toString();const J=await F(V,R,U,M,W,Z);return new FeatureLayerRelated_d({layer:o,relatedLayer:J,relationship:_,objectId:v,spatialReference:R,outFields:U,includeGeometry:M,lrucache:W,interceptor:Z})}W.A.registerAction(),O.registerAction(),J.A.registerAction(),oe.A.registerAction(),ue.A.registerAction();class featureSetUtils_O extends U.A{constructor(o){let _=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,R=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;super(),this._map=o,this._overridespref=_,this._lrucache=v,this._interceptor=R,this._instantLayers=[]}_makeAndAddFeatureSet(o){let _=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const R=g(o,this._overridespref,null===v?["*"]:v,_,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:R,opitem:o,includeGeometry:_,outFields:JSON.stringify(v)}),R}async featureSetByName(o){let _=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return await this._map.load(),this.featureSetByName(o,_,v);null===v&&(v=["*"]),v=(v=v.slice(0)).sort();const R=JSON.stringify(v);for(let M=0;M<this._instantLayers.length;M++){const v=this._instantLayers[M];if(v.opitem.title===o&&v.includeGeometry===_&&v.outFields===R)return this._instantLayers[M].featureset}const U=this._map.allLayers.find((_=>{if(_ instanceof _e.default){if(_.title===o)return!0}else if((0,M.a0)(_)&&_.title===o)return!0;return!1}));if(U)return this._makeAndAddFeatureSet(U,_,v);if(this._map.tables){const R=this._map.tables.find((_=>!!(_.title&&_.title===o||_.title&&_.title===o)));if(R){if(R instanceof _e.default)return this._makeAndAddFeatureSet(R,_,v);if(R._materializedTable);else{const o=R.outFields?R:{...R,outFields:["*"]};R._materializedTable=new _e.default(o)}return await R._materializedTable.load(),this._makeAndAddFeatureSet(R._materializedTable,_,v)}}return null}async featureSetById(o){let _=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return await this._map.load(),this.featureSetById(o,_,v);null===v&&(v=["*"]),v=(v=v.slice(0)).sort();const R=JSON.stringify(v);for(let M=0;M<this._instantLayers.length;M++){const v=this._instantLayers[M];if(v.opitem.id===o&&v.includeGeometry===_&&v.outFields===R)return this._instantLayers[M].featureset}const U=this._map.allLayers.find((_=>{if(_ instanceof _e.default){if(_.id===o)return!0}else if((0,M.a0)(_)&&_.id===o)return!0;return!1}));if(U)return this._makeAndAddFeatureSet(U,_,v);if(this._map.tables){const R=this._map.tables.find((_=>_.id===o));if(R){if(R instanceof _e.default)return this._makeAndAddFeatureSet(R,_,v);if(R._materializedTable);else{const o={...R,outFields:["*"]};R._materializedTable=new _e.default(o)}return await R._materializedTable.load(),this._makeAndAddFeatureSet(R._materializedTable,_,v)}}return null}}class b extends U.A{constructor(o){let _=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,R=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;super(),this._url=o,this._overridespref=_,this._lrucache=v,this._interceptor=R,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(o){let _=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const R=g(o,this._overridespref,null===v?["*"]:v,_,this._lrucache);return this._instantLayers.push({featureset:R,opitem:o,includeGeometry:_,outFields:JSON.stringify(v)}),R}async _loadMetaData(){const o=await T(this._url);return this.metadata=o,o}load(){return this._loadMetaData()}clone(){return new b(this._url,this._overridespref,this._lrucache,this._interceptor)}async featureSetByName(o){let _=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null===v&&(v=["*"]),v=(v=v.slice(0)).sort();const R=JSON.stringify(v);for(let V=0;V<this._instantLayers.length;V++){const v=this._instantLayers[V];if(v.opitem.title===o&&v.includeGeometry===_&&v.outFields===R)return this._instantLayers[V].featureset}const U=await this._loadMetaData();let M=null;for(const V of null!==(W=U.layers)&&void 0!==W?W:[]){var W;V.name===o&&(M=V)}if(!M)for(const V of null!==(Z=U.tables)&&void 0!==Z?Z:[]){var Z;V.name===o&&(M=V)}if(M){const o=await S(this._url+"/"+M.id,["*"]);return this._makeAndAddFeatureSet(o,_,v)}return null}async featureSetById(o){let _=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];null===v&&(v=["*"]),v=(v=v.slice(0)).sort();const R=JSON.stringify(v);o=null!=o?o.toString():"";for(let V=0;V<this._instantLayers.length;V++){const v=this._instantLayers[V];if(v.opitem.id===o&&v.includeGeometry===_&&v.outFields===R)return this._instantLayers[V].featureset}const U=await this._loadMetaData();let M=null;for(const V of null!==(W=U.layers)&&void 0!==W?W:[]){var W;null!==V.id&&void 0!==V.id&&V.id.toString()===o&&(M=V)}if(!M)for(const V of null!==(Z=U.tables)&&void 0!==Z?Z:[]){var Z;null!==V.id&&void 0!==V.id&&V.id.toString()===o&&(M=V)}if(M){const o=await S(this._url+"/"+M.id,["*"]);return this._makeAndAddFeatureSet(o,_,v)}return null}}function D(o,_){return new featureSetUtils_O(o,_,arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,arguments.length>3&&void 0!==arguments[3]?arguments[3]:null)}function E(o,_){return new b(o,_,arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,arguments.length>3&&void 0!==arguments[3]?arguments[3]:null)}function j(o,_,v,R,U){if(null===o)return null;if(o instanceof _e.default){switch(_){case"datasource":return g(o,U,o.outFields,!0,v,R).getDataSourceFeatureSet();case"parent":case"root":return g(o,U,o.outFields,!0,v,R)}return null}if((0,M.a0)(o)){switch(_){case"datasource":return g(o,U,o.outFields,!0,v,R).getDataSourceFeatureSet();case"parent":case"root":return g(o,U,o.outFields,!0,v,R)}return null}if((0,M.a1)(o)){switch(_){case"datasource":return g(o.parent,U,o.parent.outFields,!0,v,R).getDataSourceFeatureSet();case"parent":case"root":return g(o,U,o.parent.outFields,!0,v,R)}return null}if(o instanceof Q.A)switch(_){case"datasource":return o.getDataSourceFeatureSet();case"parent":return o;case"root":return o.getRootFeatureSet()}return null}async function q(o,_,v,R,U,M,W){let Z=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(ke.A.applicationCache){const V=ke.A.applicationCache.getLayerInfo(o+":"+M.url);if(V){const o=await V;return g(new _e.default({url:(0,X.Qi)(o.url)+"/"+_,outFields:["*"]}),v,R,U,W,Z)}}const V=new Ne.default({id:o,portal:M}).load();ke.A.applicationCache&&ke.A.applicationCache.setLayerInfo(o+":"+M.url,V);try{var J;const o=await V;return g(new _e.default({url:(0,X.Qi)(null!==(J=o.url)&&void 0!==J?J:"")+"/"+_,outFields:["*"]}),v,R,U,W,Z)}catch(z){throw ke.A.applicationCache&&ke.A.applicationCache.clearLayerInfo(o+":"+M.url),z}}},20277:(o,_,v)=>{v.d(_,{Gr:()=>B,IO:()=>I,a:()=>L,bV:()=>b,p8:()=>k});var R=v(13812),U=v(98140),M=v(67531),W=v(46458),Z=v(24855),V=v(10291),J=v(59359),z=v(35598),Q=v(92541),Y=v(98664);class D{constructor(o){this.field=o,this.sqlRewritable=!1}postInitialization(o,_){}}class I extends D{constructor(o){super(o),this.sqlRewritable=!0}extractValue(o){return o.attributes[this.field.name]}rewriteSql(o){return{rewritten:this.sqlRewritable,where:o}}}class k extends D{constructor(o,_,v){super((0,V.ke)(o)),this.originalField=o,this.sqlRewritable=!0,this.field.name=_,this.field.alias=v}rewriteSql(o,_){return{rewritten:this.sqlRewritable,where:(0,J.bD)(o,this.field.name,this.originalField.name,_.getFieldsIndex())}}extractValue(o){return o.attributes[this.originalField.name]}}class b extends D{constructor(o,_,v){super(o),this.codefield=_,this.lkp=v,this.reverseLkp={};for(const R in v)this.reverseLkp[v[R]]=R;this.sqlRewritable=!0}rewriteSql(o,_){const v=this.evaluateNodeToWhereClause(o.parseTree,V.zl.Standardised,this.field.name,this.codefield instanceof Q.WhereClause?(0,J.YY)(this.codefield,V.zl.Standardised):this.codefield,o.parameters);return v.includes(b.BADNESS)?{rewritten:!1,where:o}:{rewritten:this.sqlRewritable,where:Q.WhereClause.create(v,_._parent.getFieldsIndex(),_.dateFieldsTimeZoneDefaultUTC)}}evaluateNodeToWhereClause(o,_){let v,R,U,W,Z=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,z=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,Q=arguments.length>4?arguments[4]:void 0;switch(o.type){case"interval":return(0,J.oj)(this.evaluateNodeToWhereClause(o.value,_,Z,z,Q),o.qualifier,o.op);case"case-expression":{let v=" CASE ";"simple"===o.format&&(v+=this.evaluateNodeToWhereClause(o.operand,_,Z,b.BADNESS,Q));for(let R=0;R<o.clauses.length;R++)v+=" WHEN "+this.evaluateNodeToWhereClause(o.clauses[R].operand,_,Z,b.BADNESS,Q)+" THEN "+this.evaluateNodeToWhereClause(o.clauses[R].value,_,Z,b.BADNESS,Q);return null!==o.else&&(v+=" ELSE "+this.evaluateNodeToWhereClause(o.else,_,Z,b.BADNESS,Q)),v+=" END ",v}case"parameter":{const v=Q[o.value.toLowerCase()];if("string"==typeof v)return"'"+v.toString().replaceAll("'","''")+"'";if((0,V.$P)(v))return(0,J.bm)(v,_);if((0,V.Lk)(v))return(0,J.bm)(v,_);if((0,V.eg)(v))return(0,J.F1)(v,_);if((0,V.rX)(v))return(0,J.R8)(v,_);if((0,V.f0)(v))return(0,J.Nf)(v,_);if(v instanceof Array){const o=[];for(let R=0;R<v.length;R++)"string"==typeof v[R]?o.push("'"+v[R].toString().replaceAll("'","''")+"'"):(0,V.$P)(v[R])||(0,V.Lk)(v[R])?o.push((0,J.bm)(v[R],_)):(0,V.eg)(v[R])?o.push((0,J.F1)(v[R],_)):(0,V.rX)(v[R])?o.push((0,J.R8)(v[R],_)):(0,V.f0)(v[R])?o.push((0,J.Nf)(v[R],_)):o.push(v[R].toString());return o}return v.toString()}case"expression-list":R=[];for(const v of o.value)R.push(this.evaluateNodeToWhereClause(v,_,Z,z,Q));return R;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(o.expr,_,Z,b.BADNESS,Q)+" ) ";case"binary-expression":switch(o.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" AND "+this.evaluateNodeToWhereClause(o.right,_,Z,z,Q)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" OR "+this.evaluateNodeToWhereClause(o.right,_,Z,z,Q)+") ";case"IS":if("null"!==o.right.type)throw new M.L8(M.Z7.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" IS NULL )";case"ISNOT":if("null"!==o.right.type)throw new M.L8(M.Z7.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" IS NOT NULL )";case"IN":if(v=[],"expression-list"===o.right.type){if("column-reference"===o.left.type&&o.left.column.toUpperCase()===this.field.name.toUpperCase()){const v=[];let R=!0;for(const _ of o.right.value){if("string"!==_.type){R=!1;break}if(void 0===this.lkp[_.value]){R=!1;break}v.push(this.lkp[_.value].toString())}if(R)return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" IN ("+v.join(",")+")) "}return v=this.evaluateNodeToWhereClause(o.right,_,Z,z,Q)," ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" IN ("+v.join(",")+")) "}return W=this.evaluateNodeToWhereClause(o.right,_,Z,z,Q),W instanceof Array?" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" IN ("+W.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" IN ("+W+")) ";case"NOT IN":if(v=[],"expression-list"===o.right.type){if("column-reference"===o.left.type&&o.left.column.toUpperCase()===this.field.name.toUpperCase()){const v=[];let R=!0;for(const _ of o.right.value){if("string"!==_.type){R=!1;break}if(void 0===this.lkp[_.value]){R=!1;break}v.push(this.lkp[_.value].toString())}if(R)return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" NOT IN ("+v.join(",")+")) "}return v=this.evaluateNodeToWhereClause(o.right,_,Z,z,Q)," ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" NOT IN ("+v.join(",")+")) "}return W=this.evaluateNodeToWhereClause(o.right,_,Z,z,Q),W instanceof Array?" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" NOT IN ("+W.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(o.left,_,Z,z,Q)+" NOT IN ("+W+")) ";case"BETWEEN":return U=this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)," ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" BETWEEN "+U[0]+" AND "+U[1]+" ) ";case"NOTBETWEEN":return U=this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)," ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" NOT BETWEEN "+U[0]+" AND "+U[1]+" ) ";case"LIKE":return""!==o.escape?" ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" LIKE "+this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)+" ESCAPE '"+o.escape+"') ":" ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" LIKE "+this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)+") ";case"NOT LIKE":return""!==o.escape?" ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" NOT LIKE "+this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)+" ESCAPE '"+o.escape+"') ":" ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" NOT LIKE "+this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)+") ";case"<>":case"=":if("column-reference"===o.left.type&&"string"===o.right.type){if(o.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[o.right.value.toString()])return" ("+z+" "+o.operator+" "+this.lkp[o.right.value.toString()].toString()+") "}else if("column-reference"===o.right.type&&"string"===o.left.type&&o.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[o.right.value.toString()].toString()+" "+o.operator+" "+z+") ";return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" "+o.operator+" "+this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(o.left,_,Z,b.BADNESS,Q)+" "+o.operator+" "+this.evaluateNodeToWhereClause(o.right,_,Z,b.BADNESS,Q)+") "}case"null":return"null";case"boolean":return!0===o.value?"1":"0";case"string":return"'"+o.value.toString().replaceAll("'","''")+"'";case"timestamp":return"timestamp '".concat(o.value,"'");case"date":return"date '".concat(o.value,"'");case"time":return"time '".concat(o.value,"'");case"number":return o.value.toString();case"current-time":return(0,J.C6)("date"===o.mode,_);case"column-reference":return Z&&Z.toLowerCase()===o.column.toLowerCase()?"("+z+")":o.column;case"data-type":return o.value;case"function":{const v=this.evaluateNodeToWhereClause(o.args,_,Z,b.BADNESS,Q);return(0,J.F6)(o.name,v,_)}}throw new M.L8(M.Z7.UnsupportedSyntax,{node:o.type})}extractValue(o){return this.codefield instanceof Q.WhereClause?this.reverseLkp[Q.WhereClause.convertValueToStorageFormat(this.codefield.calculateValueCompiled(o))]:this.reverseLkp[o.attributes[this.codefield]]}}b.BADNESS="_!!!_BAD_LKP_!!!!";class B extends D{constructor(o,_){super(o),this._sql=_}rewriteSql(o,_){return{rewritten:!0,where:(0,J.bD)(o,this.field.name,(0,J.YY)(this._sql,V.zl.Standardised),_.getFieldsIndex())}}extractValue(o){return Q.WhereClause.convertValueToStorageFormat(this._sql.calculateValueCompiled(o),this.field.type)}}class L extends W.A{static findField(o,_){for(const v of o)if(v.name.toLowerCase()===_.toString().toLowerCase())return v;return null}constructor(o){super(o),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=[],this._extraFilter=null,this._extraFilter=o.extraFilter,this._parent=o.parentfeatureset,this._maxProcessing=30,this.adaptedFields=o.adaptedFields}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new Y.A({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=V.ik.point,this.typeIdField="",this.types=null,this.subtypeField=null,this.subtypes=null),this.fields=[];for(const o of this.adaptedFields)o.postInitialization(this,this._parent),this.fields.push(o.field)}async _getSet(o){if(null===this._wset){var _;await this._ensureLoaded();let v=null;return v=this._extraFilter?await this._getFilteredSet("",null,null,null,o):await(null===(_=this._parent)||void 0===_?void 0:_._getSet(o)),this._checkCancelled(o),(0,z.Lw)(v),this._wset=new Z.A(v._candidates.slice(0),v._known.slice(0),v._ordered,this._clonePageDefinition(v.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(o){return this._parent._isInFeatureSet(o)}async _getFeatures(o,_,v,M){var W;const V=[];-1!==_&&void 0===this._featureCache[_]&&V.push(_);const J=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(o,J))return await this._expandPagedSet(o,J,0,0,M),this._getFeatures(o,_,v,M);let z=0;for(let R=o._lastFetchedIndex;R<o._known.length&&(z++,z<=v&&(o._lastFetchedIndex+=1),!(void 0===this._featureCache[o._known[R]]&&(o._known[R]!==_&&V.push(o._known[R]),V.length>=J)));R++);if(0===V.length)return"success";o=new Z.A([],V,o._ordered,null);const Q=Math.min(V.length,v);await(null===(W=this._parent)||void 0===W?void 0:W._getFeatures(o,-1,Q,M)),this._checkCancelled(M);const Y=[];for(let R=0;R<Q;R++){var K;const o=null===(K=this._parent)||void 0===K?void 0:K._featureFromCache(V[R]);void 0!==o&&Y.push({geometry:o.geometry,attributes:o.attributes,id:V[R]})}for(const Z of Y){const o=[];for(const _ of this.adaptedFields)o[_.field.name]=_.extractValue(Z);this._featureCache[Z.id]=new R.A({attributes:o,geometry:(0,U.Yq)(Z.geometry)})}return"success"}async _fetchAndRefineFeatures(){throw new M.dr(M.D_.NeverReach)}async _getFilteredSet(o,_,v,R,U){let M=!1;const W=this._reformulateWithoutAdaptions(v);M=W.cannot,v=W.where;let V=!1;if(null!==R){V=!0;const o=[];for(const _ of this.adaptedFields)if(!(_ instanceof I)&&!0===R.scanForField(_.field.name)){if(!(_ instanceof k)){R=null,V=!1;break}o.push({field:_.field.name,newfield:_.originalField.name})}R&&o.length>0&&(R=R.replaceFields(o))}null!==v?null!==this._extraFilter&&(v=(0,J.kg)(this._extraFilter,v)):v=this._extraFilter,await this._ensureLoaded();const z=await this._parent._getFilteredSet(o,_,v,R,U);let Q;return this._checkCancelled(U),Q=!0===M?new Z.A(z._candidates.slice(0).concat(z._known.slice(0)),[],!0===V&&z._ordered,this._clonePageDefinition(z.pagesDefinition)):new Z.A(z._candidates.slice(0),z._known.slice(0),!0===V&&z._ordered,this._clonePageDefinition(z.pagesDefinition)),Q}_reformulateWithoutAdaptions(o){const _={cannot:!1,where:o};if(null!==o)for(const v of this.adaptedFields)if(!0===(0,J.Ju)(o,v.field.name)){const R=v.rewriteSql(o,this);if(!0!==R.rewritten){_.cannot=!0,_.where=null;break}_.where=R.where}return _}async _stat(o,_,v,R,U,M,W){let Z=!1,V=this._reformulateWithoutAdaptions(_);if(Z=V.cannot,_=V.where,V=this._reformulateWithoutAdaptions(U),Z=Z||V.cannot,null!==(U=V.where)?null!==this._extraFilter&&(U=(0,J.kg)(this._extraFilter,U)):U=this._extraFilter,!0===Z)return null===U&&""===v&&null===R?this._manualStat(o,_,M,W):{calculated:!1};const z=await this._parent._stat(o,_,v,R,U,M,W);return!1===z.calculated?null===U&&""===v&&null===R?this._manualStat(o,_,M,W):{calculated:!1}:z}async _canDoAggregates(o,_,v,R,U){if(null===this._parent)return!1;for(let Z=0;Z<o.length;Z++)for(const _ of this.adaptedFields)if(o[Z].toLowerCase()===_.field.name.toLowerCase()&&!(_ instanceof I))return!1;const M=[];for(let Z=0;Z<_.length;Z++){const o=_[Z];if(null!==o.workingexpr){const _=this._reformulateWithoutAdaptions(o.workingexpr);if(_.cannot)return!1;const v=o.clone();v.workingexpr=_.where,M.push(v)}else M.push(o)}const W=this._reformulateWithoutAdaptions(U);return!W.cannot&&(null!==(U=W.where)?null!==this._extraFilter&&(U=(0,J.kg)(this._extraFilter,U)):U=this._extraFilter,this._parent._canDoAggregates(o,M,v,R,U))}async _getAggregatePagesDataSourceDefinition(o,_,v,R,U,W,Z){if(null===this._parent)throw new M.dr(M.D_.NeverReach);const V=[];for(let J=0;J<_.length;J++){const o=_[J];if(null!==o.workingexpr){const _=this._reformulateWithoutAdaptions(o.workingexpr);if(_.cannot)throw new M.dr(M.D_.NeverReach);const v=o.clone();v.workingexpr=_.where,V.push(v)}else V.push(o)}const z=this._reformulateWithoutAdaptions(U);if(z.cannot)throw new M.dr(M.D_.NeverReach);return null!==(U=z.where)?null!==this._extraFilter&&(U=(0,J.kg)(this._extraFilter,U)):U=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(o,V,v,R,U,W,Z)}}},62062:(o,_,v)=>{v.d(_,{A:()=>c});var R=v(67531),U=v(46458),M=v(24855),W=v(10291),Z=v(59359),V=v(81618),J=v(92541),z=v(98664);class c extends U.A{constructor(o){super(o),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=o.parentfeatureset,o.whereclause instanceof J.WhereClause?(this._whereclause=o.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=o.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes):(this.fields=[],this.typeIdField="",this.subtypeField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new z.A({wkid:4326}),this.geometryType=W.ik.point)}async _getSet(o){if(null===this._wset){await this._ensureLoaded();const _=await this._parent._getFilteredSet("",null,this._whereclause,null,o);return this._checkCancelled(o),null!==this._whereClauseFunction?this._wset=new M.A(_._candidates.slice(0).concat(_._known.slice(0)),[],_._ordered,this._clonePageDefinition(_.pagesDefinition)):this._wset=new M.A(_._candidates.slice(0),_._known.slice(0),_._ordered,this._clonePageDefinition(_.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(o){var _;let v=null===(_=this._parent)||void 0===_?void 0:_._isInFeatureSet(o);return v===W.J6.NotInFeatureSet?v:(v=this._idstates[o],void 0===v?W.J6.Unknown:v)}_getFeature(o,_,v){return this._parent._getFeature(o,_,v)}_getFeatures(o,_,v,R){return this._parent._getFeatures(o,_,v,R)}_featureFromCache(o){return this._parent._featureFromCache(o)}executeWhereClause(o){var _,v;return null!==(_=null===(v=this._whereclause)||void 0===v?void 0:v.testFeature(o))&&void 0!==_&&_}async executeWhereClauseDeferred(o){if(null!==this._whereClauseFunction){const _=this._whereClauseFunction(o);return(0,V.$X)(_),_}return this.executeWhereClause(o)}async _fetchAndRefineFeatures(o,_,v){var R;const U=new M.A([],o,!1,null),Z=Math.min(_,o.length);if(await(null===(R=this._parent)||void 0===R?void 0:R._getFeatures(U,-1,Z,v)),this._checkCancelled(v),null==this._whereClauseFunction){for(let _=0;_<Z;_++){var V;const v=null===(V=this._parent)||void 0===V?void 0:V._featureFromCache(o[_]);!0===this.executeWhereClause(v)?this._idstates[o[_]]=W.J6.InFeatureSet:this._idstates[o[_]]=W.J6.NotInFeatureSet}return"success"}const J=[];for(let M=0;M<Z;M++){var z;const _=null===(z=this._parent)||void 0===z?void 0:z._featureFromCache(o[M]);J.push(await this.executeWhereClauseDeferred(_))}for(let M=0;M<_;M++)!0===J[M]?this._idstates[o[M]]=W.J6.InFeatureSet:this._idstates[o[M]]=W.J6.NotInFeatureSet;return"success"}async _getFilteredSet(o,_,v,R,U){null!==this._whereClauseFunction||(null!==v?null!==this._whereclause&&(v=(0,Z.kg)(this._whereclause,v)):v=this._whereclause),await this._ensureLoaded();const W=await this._parent._getFilteredSet(o,_,v,R,U);let V;return this._checkCancelled(U),V=null!==this._whereClauseFunction?new M.A(W._candidates.slice(0).concat(W._known.slice(0)),[],W._ordered,this._clonePageDefinition(W.pagesDefinition)):new M.A(W._candidates.slice(0),W._known.slice(0),W._ordered,this._clonePageDefinition(W.pagesDefinition)),V}async _stat(o,_,v,R,U,M,W){if(null!==this._whereClauseFunction)return null===U&&""===v&&null===R?this._manualStat(o,_,M,W):{calculated:!1};let V=this._whereclause;null!==U&&null!==this._whereclause&&(V=(0,Z.kg)(this._whereclause,U));const J=await this._parent._stat(o,_,v,R,V,M,W);return!1===J.calculated?null===U&&""===v&&null===R?this._manualStat(o,_,M,W):{calculated:!1}:J}async _canDoAggregates(o,_,v,R,U){return null===this._whereClauseFunction&&(null!==U?null!==this._whereclause&&(U=(0,Z.kg)(this._whereclause,U)):U=this._whereclause,null!==this._parent&&this._parent._canDoAggregates(o,_,v,R,U))}async _getAggregatePagesDataSourceDefinition(o,_,v,U,M,W,V){if(null===this._parent)throw new R.dr(R.D_.NeverReach);return null!==M?null!==this._whereclause&&(M=(0,Z.kg)(this._whereclause,M)):M=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(o,_,v,U,M,W,V)}static registerAction(){U.A._featuresetFunctions.filter=function(o){if("function"==typeof o)return new c({parentfeatureset:this,whereclause:o});let _=null;return o instanceof J.WhereClause&&(_=o),new c({parentfeatureset:this,whereclause:_})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}},57137:(o,_,v)=>{v.d(_,{A:()=>a});var R=v(80004),U=v(67531),M=v(46458),W=v(24855),Z=v(71692);class a extends M.A{constructor(o){super(o),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=o.orderbyclause,this._parent=o.parentfeatureset}async _getSet(o){if(null===this._wset){await this._ensureLoaded();const _=await this._getFilteredSet("",null,null,this._orderbyclause,o);return this._checkCancelled(o),this._wset=_,this._wset}return this._wset}async manualOrderSet(o,_){var v;const R=await this.getIdColumnDictionary(o,[],-1,_);null===(v=this._orderbyclause)||void 0===v||v.order(R);const U=new W.A([],[],!0,null);for(let M=0;M<R.length;M++)U._known.push(R[M].id);return U}async getIdColumnDictionary(o,_,v,U){if(v<o._known.length-1){const M=this._maxQueryRate();if("GETPAGES"===o._known[v+1])return await(0,R.a2)(this._parent._expandPagedSet(o,M,0,0,U)),this.getIdColumnDictionary(o,_,v,U);let W=v+1;const Z=[];for(;W<o._known.length&&"GETPAGES"!==o._known[W];)Z.push(o._known[W]),W++;v+=Z.length;const V=await(0,R.a2)(this._parent._getFeatureBatch(Z,U));this._checkCancelled(U);for(const o of V)_.push({id:o.attributes[this.objectIdField],feature:o});return this.getIdColumnDictionary(o,_,v,U)}return o._candidates.length>0?(await(0,R.a2)(this._refineSetBlock(o,this._maxProcessingRate(),U)),this._checkCancelled(U),this.getIdColumnDictionary(o,_,v,U)):_}_isInFeatureSet(o){return this._parent._isInFeatureSet(o)}_getFeatures(o,_,v,R){return this._parent._getFeatures(o,_,v,R)}_featureFromCache(o){if(void 0===this._featureCache[o]){const _=this._parent._featureFromCache(o);if(void 0===_)return;return null===_?null:(this._featureCache[o]=_,_)}return this._featureCache[o]}async _fetchAndRefineFeatures(){throw new U.dr(U.D_.NeverReach)}async _getFilteredSet(o,_,v,R,U){await this._ensureLoaded();const M=await this._parent._getFilteredSet(o,_,v,null===R?this._orderbyclause:R,U);this._checkCancelled(U);const Z=new W.A(M._candidates.slice(0),M._known.slice(0),M._ordered,this._clonePageDefinition(M.pagesDefinition));let V=!0;if(M._candidates.length>0&&(V=!1),!1===Z._ordered){let o=await this.manualOrderSet(Z,U);return!1===V&&(null===_&&null===v||(o=new W.A(o._candidates.slice(0).concat(o._known.slice(0)),[],o._ordered,this._clonePageDefinition(o.pagesDefinition)))),o}return Z}static registerAction(){M.A._featuresetFunctions.orderBy=function(o){return""===o?this:new a({parentfeatureset:this,orderbyclause:new Z.A(o)})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}},23663:(o,_,v)=>{v.d(_,{A:()=>a});var R=v(67531),U=v(46458),M=v(24855),W=v(10291);class a extends U.A{constructor(o){super(o),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=o.topnum,this._parent=o.parentfeatureset}async _getSet(o){if(null===this._wset){await this._ensureLoaded();const _=await this._parent._getSet(o);return this._wset=new M.A(_._candidates.slice(0),_._known.slice(0),!1,this._clonePageDefinition(_.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}_setKnownLength(o){return o._known.length>0&&"GETPAGES"===o._known[o._known.length-1]?o._known.length-1:o._known.length}_isInFeatureSet(o){const _=this._parent._isInFeatureSet(o);if(_===W.J6.NotInFeatureSet)return _;const v=this._idstates[o];return v===W.J6.InFeatureSet||v===W.J6.NotInFeatureSet?v:_===W.J6.InFeatureSet&&void 0===v?this._countedin<this._topnum?(this._idstates[o]=W.J6.InFeatureSet,this._countedin++,W.J6.InFeatureSet):(this._idstates[o]=W.J6.NotInFeatureSet,W.J6.NotInFeatureSet):W.J6.Unknown}async _expandPagedSet(o,_,v,U,M){if(null===this._parent)throw new R.dr(R.D_.NotImplemented);if(_>this._topnum&&(_=this._topnum),this._countedin>=this._topnum&&o.pagesDefinition.internal.set.length<=o.pagesDefinition.resultOffset){let _=o._known.length;return _>0&&"GETPAGES"===o._known[_-1]&&(o._known.length=_-1),_=o._candidates.length,_>0&&"GETPAGES"===o._candidates[_-1]&&(o._candidates.length=_-1),"success"}const W=await this._parent._expandPagedSet(o,_,v,U,M);return this._setKnownLength(o)>this._topnum&&(o._known.length=this._topnum),this._setKnownLength(o)>=this._topnum&&(o._candidates.length=0),W}async _getFeatures(o,_,v,R){const U=[],W=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(o,W))return await this._expandPagedSet(o,W,0,0,R),this._getFeatures(o,_,v,R);-1!==_&&void 0===this._featureCache[_]&&U.push(_);let Z=0;for(let M=o._lastFetchedIndex;M<o._known.length&&(Z++,Z<=v&&(o._lastFetchedIndex+=1),!(void 0===this._featureCache[o._known[M]]&&(o._known[M]!==_&&U.push(o._known[M]),U.length>W)));M++);if(0===U.length)return"success";const V=new M.A([],U,!1,null),J=Math.min(U.length,v);await this._parent._getFeatures(V,-1,J,R);for(let M=0;M<J;M++){const o=this._parent._featureFromCache(U[M]);void 0!==o&&(this._featureCache[U[M]]=o)}return"success"}async _getFilteredSet(o,_,v,R,U){await this._ensureLoaded();const W=await this._getSet(U);return new M.A(W._candidates.slice(0).concat(W._known.slice(0)),[],!1,this._clonePageDefinition(W.pagesDefinition))}_refineKnowns(o,_){let v=0,R=null;const U=[];for(let M=0;M<o._candidates.length;M++){const Z=this._isInFeatureSet(o._candidates[M]);if(Z===W.J6.InFeatureSet){if(o._known.push(o._candidates[M]),v+=1,null===R?R={start:M,end:M}:R.end===M-1?R.end=M:(U.push(R),R={start:M,end:M}),o._known.length>=this._topnum)break}else if(Z===W.J6.NotInFeatureSet)null===R?R={start:M,end:M}:R.end===M-1?R.end=M:(U.push(R),R={start:M,end:M}),v+=1;else if(Z===W.J6.Unknown)break;if(v>=_)break}null!==R&&U.push(R);for(let M=U.length-1;M>=0;M--)o._candidates.splice(U[M].start,U[M].end-U[M].start+1);this._setKnownLength(o)>this._topnum&&(o._known=o._known.slice(0,this._topnum)),this._setKnownLength(o)>=this._topnum&&(o._candidates=[])}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}static registerAction(){U.A._featuresetFunctions.top=function(o){return new a({parentfeatureset:this,topnum:o})}}getFieldsIndex(){return this._parent.getFieldsIndex()}}},77125:(o,_,v)=>{v.d(_,{A:()=>f});var R=v(13812),U=v(67531),M=v(46458),W=v(24855),Z=v(10291),V=v(59359),J=v(66445),z=v(9370),Q=v(34009),Y=v(9989),K=v(67871),X=v(49096);class f extends M.A{constructor(o){super(o),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,o.spatialReference&&(this.spatialReference=o.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=o.layer,this._wset=null,!0===o.isTable&&(this._forceIsTable=!0),void 0!==o.outFields&&(this._overrideFields=o.outFields),void 0!==o.includeGeometry&&(this._removeGeometry=!1===o.includeGeometry)}_maxQueryRate(){return Z.gO}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}get gdbVersion(){return""}_initialiseFeatureSet(){var o,_,v,R;if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const o=[],_=[];for(const v of this.fields)if("oid"===v.type)o.push(v),_.push(v.name);else for(const R of this._overrideFields)if(R.toLowerCase()===v.name.toLowerCase()){o.push(v),_.push(v.name);break}this.fields=o,this._overrideFields=_}this.objectIdField=this._layer.objectIdField;for(const U of this.fields)"global-id"===U.type&&(this.globalIdField=U.name);this._databaseType=Z.zl.Standardised,this.hasZ=!0===(null===(o=this._layer)||void 0===o||null===(o=o.capabilities)||void 0===o||null===(o=o.data)||void 0===o?void 0:o.supportsZ),this.hasM=!0===(null===(_=this._layer)||void 0===_||null===(_=_.capabilities)||void 0===_||null===(_=_.data)||void 0===_?void 0:_.supportsM),this._layer instanceof Q.default?(this.subtypeField=null!==(v=this._layer.subtypeField)&&void 0!==v?v:"",this.subtypes=this._layer.subtypes,this.types=null,this.typeIdField=null):(this.typeIdField=null!==(R=this._layer.typeIdField)&&void 0!==R?R:"",this.types=this._layer.types,this.subtypeField=this._layer.subtypeField,this.subtypes=this._layer.subtypes)}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return Z.J6.InFeatureSet}_candidateIdTransform(o){return o}async _getSet(o){if(null===this._wset){await this._ensureLoaded();const _=await this._getFilteredSet("",null,null,null,o);return this._wset=_,_}return this._wset}_changeFeature(o){const _={};for(const v of this.fields)_[v.name]=o.attributes[v.name];return new R.A({geometry:!0===this._removeGeometry?null:o.geometry,attributes:_})}async _getFilteredSet(o,_,v,R,U){let M="",J=!1;if(null!==R&&(M=R.constructClause(),J=!0),this.isTable()&&_&&null!==o&&""!==o)return new W.A([],[],!0,null);const z=new X.A;z.returnZ=this.hasZ,z.returnM=this.hasM,z.where=null===v?null===_?"1=1":"":(0,V.YY)(v,Z.zl.Standardised),z.spatialRelationship=this._makeRelationshipEnum(o),z.outSpatialReference=this.spatialReference,z.orderByFields=""!==M?M.split(","):null,z.geometry=null===_?null:_,z.returnGeometry=!0,z.relationParameter=this._makeRelationshipParam(o);const Q=await this._layer.queryFeatures(z);if(null===Q)return new W.A([],[],J,null);this._checkCancelled(U);const Y=[];return Q.features.forEach((o=>{const _=o.attributes[this._layer.objectIdField];Y.push(_),this._featureCache[_]=this._changeFeature(o)})),new W.A([],Y,J,null)}_makeRelationshipEnum(o){if(o.includes("esriSpatialRelRelation"))return"relation";switch(o){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return o}_makeRelationshipParam(o){return o.includes("esriSpatialRelRelation")?o.split(":")[1]:""}async _queryAllFeatures(){if(this._wset)return this._wset;const o=new X.A;if(o.where="1=1",await this._ensureLoaded(),this._layer.source&&this._layer.source.items){const o=[];return this._layer.source.items.forEach((_=>{const v=_.attributes[this._layer.objectIdField];o.push(v),this._featureCache[v]=this._changeFeature(_)})),this._wset=new W.A([],o,!1,null),this._wset}o.returnZ=this.hasZ,o.returnM=this.hasM;const _=await this._layer.queryFeatures(o),v=[];return _.features.forEach((o=>{const _=o.attributes[this._layer.objectIdField];v.push(_),this._featureCache[_]=this._changeFeature(o)})),this._wset=new W.A([],v,!1,null),this._wset}async _getFeatures(o,_,v){const R=[];-1!==_&&void 0===this._featureCache[_]&&R.push(_);for(let U=o._lastFetchedIndex;U<o._known.length&&(o._lastFetchedIndex+=1,!(void 0===this._featureCache[o._known[U]]&&(o._known[U]!==_&&R.push(o._known[U]),R.length>v)));U++);if(0===R.length)return"success";throw new U.dr(U.D_.MissingFeatures)}async _refineSetBlock(o){return o}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}relationshipMetaData(){return[]}static _cloneAttr(o){const _={};for(const v in o)_[v]=o[v];return _}nativeCapabilities(){var o;return{title:null!==(o=this._layer.title)&&void 0!==o?o:"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(o,_){var v,R,U,M,W,Z,V;let Q=o.layerDefinition.objectIdField;const X=null!==(v=o.layerDefinition.typeIdField)&&void 0!==v?v:"",$=[];if(o.layerDefinition.types)for(const J of o.layerDefinition.types)$.push(Y.A.fromJSON(J));let H=o.layerDefinition.geometryType;void 0===H&&(H=o.featureSet.geometryType||"");let ee=o.featureSet.features;const te=_.toJSON();if(!Q){let _=!1;for(const v of o.layerDefinition.fields)if("oid"===v.type||"esriFieldTypeOID"===v.type){Q=v.name,_=!0;break}if(!1===_){let _="FID",v=!0,R=0;for(;v;){let U=!0;for(const v of o.layerDefinition.fields)if(v.name===_){U=!1;break}!0===U?v=!1:(R++,_="FID"+R.toString())}o.layerDefinition.fields.push({type:"esriFieldTypeOID",name:_,alias:_});const U=[];for(let M=0;M<ee.length;M++)U.push({geometry:o.featureSet.features[M].geometry,attributes:o.featureSet.features[M].attributes?this._cloneAttr(o.featureSet.features[M].attributes):{}}),U[M].attributes[_]=M;ee=U,Q=_}}const ie=[];for(const J of o.layerDefinition.fields)J instanceof K.A?ie.push(J):ie.push(K.A.fromJSON(J));let re=H;switch(re||(re=""),re){case"esriGeometryPoint":re="point";break;case"esriGeometryPolyline":re="polyline";break;case"esriGeometryPolygon":re="polygon";break;case"esriGeometryEnvelope":re="extent";break;case"esriGeometryMultipoint":re="multipoint";break;case"":case"esriGeometryNull":re="esriGeometryNull"}if("esriGeometryNull"!==re)for(const z of ee)z.geometry&&z.geometry instanceof J.A==0&&(z.geometry.type=re,void 0===z.geometry.spatialReference&&(z.geometry.spatialReference=te));else for(const J of ee)J.geometry&&(J.geometry=null);const se={outFields:["*"],source:ee,fields:ie,hasZ:!0===(null===o||void 0===o||null===(R=o.layerDefinition)||void 0===R?void 0:R.hasZ)||!0===(null===o||void 0===o||null===(U=o.featureSet)||void 0===U?void 0:U.hasZ),hasM:!0===(null===o||void 0===o||null===(M=o.layerDefinition)||void 0===M?void 0:M.hasM)||!0===(null===o||void 0===o||null===(W=o.featureSet)||void 0===W?void 0:W.hasM),types:$,typeIdField:X,objectIdField:Q,spatialReference:_},ne="esriGeometryNull"===re||null===re;ne||(se.geometryType=re);const ae=new z.default(se);return(null===o||void 0===o||null===(Z=o.layerDefinition)||void 0===Z?void 0:Z.subtypeField)&&(null===o||void 0===o||null===(V=o.layerDefinition)||void 0===V?void 0:V.subtypes)&&ae.read({subtypes:o.layerDefinition.subtypes,subtypeField:o.layerDefinition.subtypeField}),new f({layer:ae,spatialReference:_,isTable:ne})}async queryAttachments(){return[]}async getFeatureByObjectId(o){const _=new X.A;_.where=this.objectIdField+"="+o.toString(),_.returnZ=this.hasZ,_.returnM=this.hasM;const v=await this._layer.queryFeatures(_);return 1===v.features.length?v.features[0]:null}async getOwningSystemUrl(){return""}async getIdentityUser(){return""}get preferredTimeZone(){var o;return null!==(o=this._layer.preferredTimeZone)&&void 0!==o?o:null}get dateFieldsTimeZone(){var o;return null!==(o=this._layer.dateFieldsTimeZone)&&void 0!==o?o:null}get datesInUnknownTimezone(){var o;return null===(o=this._layer)||void 0===o?void 0:o.datesInUnknownTimezone}get editFieldsInfo(){var o;return null===(o=this._layer)||void 0===o?void 0:o.editFieldsInfo}get timeInfo(){var o;return null===(o=this._layer)||void 0===o?void 0:o.timeInfo}async getFeatureSetInfo(){var o,_,v;const R=this._layer.title&&this._layer.parent;return null!==(o=this.fsetInfo)&&void 0!==o?o:{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:R&&null!==(_=this._layer.id)&&void 0!==_?_:null,webMapLayerTitle:R&&null!==(v=this._layer.title)&&void 0!==v?v:null,className:null,objectClassId:null}}}},71692:(o,_,v)=>{function t(o,_){return o===_?0:null===o?-1:null===_?1:o<_?-1:1}v.d(_,{A:()=>e});class e{constructor(o){const _=o.split(",");this._fields=[],this._directions=[];for(let v=0;v<_.length;v++){const o=_[v].match(/\S+/g);this._fields.push(o[0]),2===o.length?"asc"===o[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let o="";for(let _=0;_<this._fields.length;_++)0!==_&&(o+=","),o+=this._fields[_],1===this._directions[_]?o+=" ASC":o+=" DESC";return o}order(o){o.sort(((o,_)=>{for(let v=0;v<this._fields.length;v++){const R=this.featureValue(o.feature,this._fields[v],v),U=this.featureValue(_.feature,this._fields[v],v);let M=0;if(M=1===this._directions[v]?t(R,U):-1*t(R,U),0!==M)return M}return 0}))}scanForField(o){for(let _=0;_<this._fields.length;_++)if(this._fields[_].toLowerCase().trim()===o.toLowerCase().trim())return!0;return!1}replaceFields(o){let _="";for(let v=0;v<this._fields.length;v++){0!==v&&(_+=",");let R=this._fields[v];for(const _ of o)if(R.toLowerCase()===_.field.toLowerCase()){R=_.newfield;break}_+=R,1===this._directions[v]?_+=" ASC":_+=" DESC"}return new e(_)}featureValue(o,_,v){const R=o.attributes[_];if(void 0!==R)return R;for(const U in o.attributes)if(_.toLowerCase()===U.toLowerCase())return this._fields[v]=U,o.attributes[U];return null}}},9989:(o,_,v)=>{v.d(_,{A:()=>K});var R=v(80671),U=v(88706),M=v(83375),W=v(57453),Z=(v(50886),v(89412),v(76761),v(59299)),V=v(68682),J=v(51715),z=v(78091),Q=v(10171);let Y=class extends((0,U.O)(M.oY)){constructor(o){super(o),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(o){const _={};for(const v of Object.keys(o))_[v]=(0,z.rS)(o[v]);return _}writeDomains(o,_){const v={};for(const U of Object.keys(o)){var R;o[U]&&(v[U]=null===(R=o[U])||void 0===R?void 0:R.toJSON())}_.domains=v}};(0,R._)([(0,W.MZ)({json:{write:!0}})],Y.prototype,"id",void 0),(0,R._)([(0,W.MZ)({json:{write:!0}})],Y.prototype,"name",void 0),(0,R._)([(0,W.MZ)({json:{write:!0}})],Y.prototype,"domains",void 0),(0,R._)([(0,Z.w)("domains")],Y.prototype,"readDomains",null),(0,R._)([(0,J.K)("domains")],Y.prototype,"writeDomains",null),(0,R._)([(0,W.MZ)({type:[Q.A],json:{write:!0}})],Y.prototype,"templates",void 0),Y=(0,R._)([(0,V.$)("esri.layers.support.FeatureType")],Y);const K=Y},35999:(o,_,v)=>{v.d(_,{E1:()=>i,Fm:()=>s,JZ:()=>F,R_:()=>u,fu:()=>t,oF:()=>r,rq:()=>c});const R=[["binary","application/octet-stream","bin",""]];function t(o,_){var v;return null!=d(_.name,null!==(v=null===o||void 0===o?void 0:o.supportedFormats)&&void 0!==v?v:[])}function r(o,_){var v;if(!o)return!1;const R=c(_,null!==(v=o.supportedFormats)&&void 0!==v?v:[]);return null!=R&&o.editFormats.includes(R)}function u(o,_){return m(function p(o,_){const v=o.toLowerCase();return a(_).find((o=>l(o)===v))}(o,_))}function i(o,_){return m(d(o,_))}function s(o,_){return l(function f(o,_){return a(_).find((_=>m(_)===o))}(o,_))}function c(o,_){var v;return null!==(v=i(o.name,_))&&void 0!==v?v:u(o.type,_)}function a(o){return[...R,...o]}function d(o,_){const v=o.toLowerCase();return a(_).find((o=>w(o).some((o=>v.endsWith(o)))))}function m(o){return null===o||void 0===o?void 0:o[0]}function l(o){return null===o||void 0===o?void 0:o[1].toLowerCase()}function w(o){var _;return null!==(_=null===o||void 0===o?void 0:o[2].split(",").map((o=>o.toLowerCase())))&&void 0!==_?_:[]}function F(o){var _;return null===(_=o.tables)||void 0===_?void 0:_.find((o=>"assetMaps"===o.role))}},19766:(o,_,v)=>{function t(o){const _={};for(const v in o){if("declaredClass"===v)continue;const R=o[v];if(null!=R&&"function"!=typeof R)if(Array.isArray(R)){_[v]=[];for(let o=0;o<R.length;o++)_[v][o]=t(R[o])}else"object"==typeof R?R.toJSON&&(_[v]=JSON.stringify(R)):_[v]=R}return _}v.d(_,{z:()=>t})},87849:(o,_,v)=>{v.d(_,{I:()=>n});var R=v(95530),U=v(83947),M=v(49096);async function n(o,_,v){const W=(0,R.Dl)(o);return(0,U.gW)(W,M.A.from(_),{...v}).then((o=>o.data.count))}},73336:(o,_,v)=>{v.d(_,{V:()=>s});var R=v(95530),U=v(83947),M=v(49096);async function s(o,_,v){const W=(0,R.Dl)(o);return(0,U.Pk)(W,M.A.from(_),{...v}).then((o=>o.data.objectIds))}},35761:(o,_,v)=>{v.d(_,{e:()=>a,s:()=>s});var R=v(95530),U=v(83947),M=v(94309),W=v(49096);async function s(o,_,v){const R=await a(o,_,v);return M.A.fromJSON(R)}async function a(o,_,v){const M=(0,R.Dl)(o),Z={...v},V=W.A.from(_),{data:J}=await(0,U.eW)(M,V,V.sourceSpatialReference,Z);return J}},2569:(o,_,v)=>{v.d(_,{S:()=>executeQueryPBF_n});var R=v(95530),U=v(35598),M=v(8641),W=v(32050);function pbfJSONFeatureSet_o(o,_){return _}function i(o,_,v,R){switch(v){case 0:return u(o,_+R,0);case 1:return"lowerLeft"===o.originPosition?u(o,_+R,1):function l(o,_,v){let{translate:R,scale:U}=o;return R[v]-_*U[v]}(o,_+R,1)}}function n(o,_,v,R){return 2===v?u(o,_,2):i(o,_,v,R)}function pbfJSONFeatureSet_a(o,_,v,R){return 2===v?0===_?0:u(o,_,3):i(o,_,v,R)}function h(o,_,v,R){return 3===v?0===_?0:u(o,_,3):n(o,_,v,R)}function u(o,_,v){let{translate:R,scale:U}=o;return R[v]+_*U[v]}class d{constructor(o){this._options=o,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this._previousCoordinate=[0,0],this._transform=null,this._applyTransform=pbfJSONFeatureSet_o,this._lengths=[],this._currentLengthIndex=0,this._toAddInCurrentPath=0,this._vertexDimension=0,this._mValueOffset=null,this._coordinateBuffer=null,this._coordinateBufferPtr=0,this._attributesConstructor=class{}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(o){if(this._options.applyTransform&&(o.transform=null),this._attributesConstructor=class{},this._coordinateBuffer=null,this._lengths.length=0,!o.hasZ)return;const _=(0,M.N)(o.geometryType,this._options.sourceSpatialReference,o.spatialReference);if(null!=_)for(const v of o.features)_(v.geometry)}createSpatialReference(){return{}}addField(o,_){const v=o.fields;(0,U.Lw)(v),v.push(_);const R=v.map((o=>o.name));this._attributesConstructor=function(){for(const o of R)this[o]=null}}addFeature(o,_){o.features.push(_)}prepareFeatures(o){switch(this._transform=o.transform,this._options.applyTransform&&o.transform&&(this._applyTransform=this._deriveApplyTransform(o)),this._mValueOffset=null,this._vertexDimension=2,o.hasZ&&this._vertexDimension++,o.hasM&&(this._mValueOffset=this._vertexDimension,this._vertexDimension++),o.geometryType){case"esriGeometryPoint":this.addCoordinate=(o,_,v)=>this.addCoordinatePoint(o,_,v),this.createGeometry=o=>this.createPointGeometry(o);break;case"esriGeometryPolygon":this.addCoordinate=(o,_,v)=>this._addCoordinatePolygon(o,_,v),this.createGeometry=o=>this._createPolygonGeometry(o);break;case"esriGeometryPolyline":this.addCoordinate=(o,_,v)=>this._addCoordinatePolyline(o,_,v),this.createGeometry=o=>this._createPolylineGeometry(o);break;case"esriGeometryMultipoint":this.addCoordinate=(o,_,v)=>this._addCoordinateMultipoint(o,_,v),this.createGeometry=o=>this._createMultipointGeometry(o)}}createFeature(){return this._lengths.length=0,this._currentLengthIndex=0,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0,this._coordinateBuffer=null,this._coordinateBufferPtr=0,{attributes:new this._attributesConstructor}}allocateCoordinates(){}addLength(o,_,v){0===this._lengths.length&&(this._toAddInCurrentPath=_),this._lengths.push(_)}addQueryGeometry(o,_){const{queryGeometry:v,queryGeometryType:R}=_,U=(0,W.Ch)(v.clone(),v,!1,!1,this._transform),M=(0,W.zv)(U,R,!1,!1);o.queryGeometryType=R,o.queryGeometry={...M}}createPointGeometry(o){const _={x:0,y:0,spatialReference:o.spatialReference};return o.hasZ&&(_.z=0),o.hasM&&(_.m=0),_}addCoordinatePoint(o,_,v){const R=this._transform;switch(_=this._applyTransform(R,_,v,0),v){case 0:o.x=_;break;case 1:o.y=_;break;case 2:"z"in o?o.z=_:o.m=_;break;case 3:o.m=_}}_transformPathLikeValue(o,_){let v=0;_<=1&&(v=this._previousCoordinate[_],this._previousCoordinate[_]+=o);const R=this._transform;return null===this._mValueOffset||0!==o||_%this._mValueOffset?this._applyTransform(R,o,_,v):0}_addCoordinatePolyline(o,_,v){this._dehydratedAddPointsCoordinate(o.paths,_,v)}_addCoordinatePolygon(o,_,v){this._dehydratedAddPointsCoordinate(o.rings,_,v)}_addCoordinateMultipoint(o,_,v){0===v&&o.points.push([]);const R=this._transformPathLikeValue(_,v);o.points[o.points.length-1].push(R)}_createPolygonGeometry(o){return{rings:[[]],spatialReference:o.spatialReference,hasZ:!!o.hasZ,hasM:!!o.hasM}}_createPolylineGeometry(o){return{paths:[[]],spatialReference:o.spatialReference,hasZ:!!o.hasZ,hasM:!!o.hasM}}_createMultipointGeometry(o){return{points:[],spatialReference:o.spatialReference,hasZ:!!o.hasZ,hasM:!!o.hasM}}_dehydratedAddPointsCoordinate(o,_,v){0===v&&0==this._toAddInCurrentPath--&&(o.push([]),this._toAddInCurrentPath=this._lengths[++this._currentLengthIndex]-1,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0);const R=this._transformPathLikeValue(_,v),U=o[o.length-1];0===v&&(this._coordinateBufferPtr=0,this._coordinateBuffer=new Array(this._vertexDimension),U.push(this._coordinateBuffer)),this._coordinateBuffer[this._coordinateBufferPtr++]=R}_deriveApplyTransform(o){const{hasZ:_,hasM:v}=o;return _&&v?h:_?n:v?pbfJSONFeatureSet_a:i}}var Z=v(83947),V=(v(94309),v(49096));async function executeQueryPBF_n(o,_,v){const U=(0,R.Dl)(o),M={...v},W=V.A.from(_),J=!W.quantizationParameters,{data:z}=await(0,Z.IJ)(U,W,new d({sourceSpatialReference:W.sourceSpatialReference,applyTransform:J}),M);return z}},83947:(o,_,v)=>{v.d(_,{GB:()=>E,IJ:()=>f,Jf:()=>x,Pk:()=>p,eW:()=>c,gW:()=>S,kS:()=>d});var R=v(53705),U=v(4270),M=v(31670),W=v(30172),Z=v(78395),V=v(19766),J=v(84714),z=v(34127);const Q="Layer does not support extent calculation.";function y(o,_){var v;const R=o.geometry,U=o.toJSON();delete U.compactGeometryEnabled,delete U.defaultSpatialReferenceEnabled;const W=U;let V,J,z;if(null!=R&&(J=R.spatialReference,z=(0,Z.YX)(J),W.geometryType=(0,M.$B)(R),W.geometry=function m(o,_){if(_&&"extent"===o.type)return"".concat(o.xmin,",").concat(o.ymin,",").concat(o.xmax,",").concat(o.ymax);if(_&&"point"===o.type)return"".concat(o.x,",").concat(o.y);const v=o.toJSON();return delete v.spatialReference,JSON.stringify(v)}(R,o.compactGeometryEnabled),W.inSR=z),U.groupByFieldsForStatistics&&(W.groupByFieldsForStatistics=U.groupByFieldsForStatistics.join(",")),U.objectIds&&(W.objectIds=U.objectIds.join(",")),U.orderByFields&&(W.orderByFields=U.orderByFields.join(",")),!U.outFields||!U.returnDistinctValues&&(null!==_&&void 0!==_&&_.returnCountOnly||null!==_&&void 0!==_&&_.returnExtentOnly||null!==_&&void 0!==_&&_.returnIdsOnly)?delete W.outFields:U.outFields.includes("*")?W.outFields="*":W.outFields=U.outFields.join(","),U.outSR?(W.outSR=(0,Z.YX)(U.outSR),V=o.outSpatialReference):R&&(U.returnGeometry||U.returnCentroid)&&(W.outSR=W.inSR,V=J),U.returnGeometry&&delete U.returnGeometry,U.outStatistics&&(W.outStatistics=JSON.stringify(U.outStatistics)),U.fullText&&(W.fullText=JSON.stringify(U.fullText)),U.pixelSize&&(W.pixelSize=JSON.stringify(U.pixelSize)),U.quantizationParameters&&(o.defaultSpatialReferenceEnabled&&null!=J&&null!=(null===(v=o.quantizationParameters)||void 0===v?void 0:v.extent)&&J.equals(o.quantizationParameters.extent.spatialReference)&&delete U.quantizationParameters.extent.spatialReference,W.quantizationParameters=JSON.stringify(U.quantizationParameters)),U.parameterValues&&(W.parameterValues=JSON.stringify(U.parameterValues)),U.rangeValues&&(W.rangeValues=JSON.stringify(U.rangeValues)),U.dynamicDataSource&&(W.layer=JSON.stringify({source:U.dynamicDataSource}),delete U.dynamicDataSource),U.timeExtent){const o=U.timeExtent,{start:_,end:v}=o;null==_&&null==v||(W.time=_===v?_:"".concat(null!==_&&void 0!==_?_:"null",",").concat(null!==v&&void 0!==v?v:"null")),delete U.timeExtent}return o.defaultSpatialReferenceEnabled&&null!=J&&null!=V&&J.equals(V)&&(W.defaultSR=W.inSR,delete W.inSR,delete W.outSR),W}async function c(o,_,v,R){const U=null!=_.timeExtent&&_.timeExtent.isEmpty?{data:{features:[]}}:await E(o,_,"json",R);return(0,z.q)(_,v,U.data),U}async function f(o,_,v,R){if(null!=_.timeExtent&&_.timeExtent.isEmpty)return{data:v.createFeatureResult()};const U=await d(o,_,R),M=U;return M.data=(0,J.m)(U.data,v),M}function d(o,_,v){return E(o,_,"pbf",v)}function p(o,_,v){return null!=_.timeExtent&&_.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):E(o,_,"json",v,{returnIdsOnly:!0})}function S(o,_,v){return null!=_.timeExtent&&_.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):E(o,_,"json",v,{returnIdsOnly:!0,returnCountOnly:!0})}async function x(o,_,v){if(null!=_.timeExtent&&_.timeExtent.isEmpty)return{data:{count:0,extent:null}};const R=await E(o,_,"json",v,{returnExtentOnly:!0,returnCountOnly:!0}),U=R.data;if(U.hasOwnProperty("extent"))return R;if(U.features)throw new Error(Q);if(U.hasOwnProperty("count"))throw new Error(Q);return R}async function E(o,_,v){let M=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},Z=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const J="string"==typeof o?(0,U.An)(o):o,z=_.geometry?[_.geometry]:[],Q=await(0,W.el)(z,null,{signal:M.signal}),Y=null===Q||void 0===Q?void 0:Q[0];null!=Y&&((_=_.clone()).geometry=Y);const K=(0,V.z)({...J.query,f:v,...Z,...y(_,Z)});return(0,R.A)((0,U.fj)(J.path,function g(o,_){return null!=o.formatOf3DObjects&&!(_.returnCountOnly||_.returnExtentOnly||_.returnIdsOnly)}(_,Z)?"query3d":"query"),{...M,responseType:"pbf"===v?"array-buffer":"json",query:{...K,...M.query}})}},34127:(o,_,v)=>{v.d(_,{q:()=>t});var R=v(8641);function t(o,_,v){if(null===v||void 0===v||!v.features||!v.hasZ)return;const U=(0,R.N)(v.geometryType,_,o.outSpatialReference);if(null!=U)for(const R of v.features)U(R.geometry)}},72466:(o,_,v)=>{v.d(_,{A:()=>Q});var R,U=v(80671),M=v(83375),W=v(57453),Z=v(6493),V=(v(76761),v(50886),v(68682));function n(o){const{exifInfo:_,exifName:v,tagName:R}=o;if(!_||!v||!R)return null;const U=_.find((o=>o.name===v));return U?function t(o){const{tagName:_,tags:v}=o;if(!v||!_)return null;const R=v.find((o=>o.name===_));return(null===R||void 0===R?void 0:R.value)||null}({tagName:R,tags:U.tags}):null}const J={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let z=R=class extends M.oY{constructor(o){super(o),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:o}=this,_=n({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:o});return J[_]||null}clone(){return new R({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};(0,U._)([(0,W.MZ)({type:String})],z.prototype,"contentType",void 0),(0,U._)([(0,W.MZ)()],z.prototype,"exifInfo",void 0),(0,U._)([(0,W.MZ)({readOnly:!0})],z.prototype,"orientationInfo",null),(0,U._)([(0,W.MZ)({type:Z.jz})],z.prototype,"id",void 0),(0,U._)([(0,W.MZ)({type:String})],z.prototype,"globalId",void 0),(0,U._)([(0,W.MZ)({type:String})],z.prototype,"keywords",void 0),(0,U._)([(0,W.MZ)({type:String})],z.prototype,"name",void 0),(0,U._)([(0,W.MZ)({json:{read:!1}})],z.prototype,"parentGlobalId",void 0),(0,U._)([(0,W.MZ)({json:{read:!1}})],z.prototype,"parentObjectId",void 0),(0,U._)([(0,W.MZ)({type:Z.jz})],z.prototype,"size",void 0),(0,U._)([(0,W.MZ)({json:{read:!1}})],z.prototype,"url",void 0),z=R=(0,U._)([(0,V.$)("esri.layers.support.AttachmentInfo")],z);const Q=z}}]);
//# sourceMappingURL=1144.a2e0a2b8.chunk.js.map