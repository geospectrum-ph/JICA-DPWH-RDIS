"use strict";(self.webpackChunkSEEDs_v2_0_Client=self.webpackChunkSEEDs_v2_0_Client||[]).push([[7326],{53395:(s,h,_)=>{function n(){return new Float32Array(3)}function t(s){const h=new Float32Array(3);return h[0]=s[0],h[1]=s[1],h[2]=s[2],h}function r(s,h,_){const m=new Float32Array(3);return m[0]=s,m[1]=h,m[2]=_,m}function o(){return n()}function u(){return r(1,1,1)}function c(){return r(1,0,0)}function i(){return r(0,1,0)}function a(){return r(0,0,1)}_.d(h,{fA:()=>r,o8:()=>t,vt:()=>n});const m=o(),b=u(),x=c(),w=i(),S=a();Object.freeze(Object.defineProperty({__proto__:null,ONES:b,UNIT_X:x,UNIT_Y:w,UNIT_Z:S,ZEROS:m,clone:t,create:n,createView:function e(s,h){return new Float32Array(s,h,3)},fromValues:r,ones:u,unitX:c,unitY:i,unitZ:a,zeros:o},Symbol.toStringTag,{value:"Module"}))},12198:(s,h,_)=>{_.d(h,{b3:()=>a,jZ:()=>p});var m=_(83375),b=_(88965),x=_(12439),w=_(78966),S=_(31670),R=_(55476),M=_(78395);function p(s){return f(s,!0)}function a(s){return f(s,!1)}function f(s,h){if(null==s)return null;const _=s.spatialReference,b=(0,M.Vp)(_),w=(0,m.Wj)(s)?s.toJSON():s;if(!b)return w;const A=(0,M.K8)(_)?102100:4326,k=R.j7[A].maxX,z=R.j7[A].minX;if((0,S.fT)(w))return y(w,k,z);if((0,S.U9)(w))return w.points=w.points.map((s=>y(s,k,z))),w;if((0,S.ZC)(w))return d(w,b);if((0,S.Bi)(w)||(0,S.Rg)(w)){const s=(0,x.Rg)(G,w),_={xmin:s[0],ymin:s[1],xmax:s[2],ymax:s[3]},m=(0,R.kd)(_.xmin,z)*(2*k),b=0===m?w:(0,R.kS)(w,m);return _.xmin+=m,_.xmax+=m,_.xmax>k?P(b,k,h):_.xmin<z?P(b,z,h):b}return w}function d(s,h){if(!h)return s;const _=function I(s,h){const _=[],{ymin:m,ymax:b,xmin:x,xmax:w}=s,S=s.xmax-s.xmin,[R,M]=h.valid,{x:G,frameId:A}=g(s.xmin,h),{x:k,frameId:z}=g(s.xmax,h),U=G===k&&S>0;if(S>2*M){const s={xmin:x<w?G:k,ymin:m,xmax:M,ymax:b},h={xmin:R,ymin:m,xmax:x<w?k:G,ymax:b},S={xmin:0,ymin:m,xmax:M,ymax:b},U={xmin:R,ymin:m,xmax:0,ymax:b},Z=[],E=[];v(s,S)&&Z.push(A),v(s,U)&&E.push(A),v(h,S)&&Z.push(z),v(h,U)&&E.push(z);for(let _=A+1;_<z;_++)Z.push(_),E.push(_);_.push(new C(s,[A]),new C(h,[z]),new C(S,Z),new C(U,E))}else G>k||U?_.push(new C({xmin:G,ymin:m,xmax:M,ymax:b},[A]),new C({xmin:R,ymin:m,xmax:k,ymax:b},[z])):_.push(new C({xmin:G,ymin:m,xmax:k,ymax:b},[A]));return _}(s,h).map((s=>s.extent));return _.length<2?_[0]||s:_.length>2?(s.xmin=h.valid[0],s.xmax=h.valid[1],s):{rings:_.map((s=>[[s.xmin,s.ymin],[s.xmin,s.ymax],[s.xmax,s.ymax],[s.xmax,s.ymin],[s.xmin,s.ymin]]))}}function y(s,h,_){if(Array.isArray(s)){const m=s[0];if(m>h){const _=(0,R.kd)(m,h);s[0]=m+_*(-2*h)}else if(m<_){const h=(0,R.kd)(m,_);s[0]=m+h*(-2*_)}}else{const m=s.x;if(m>h){const _=(0,R.kd)(m,h);s.x+=_*(-2*h)}else if(m<_){const h=(0,R.kd)(m,_);s.x+=h*(-2*_)}}return s}function g(s,h){const[_,m]=h.valid,b=2*m;let x,w=0;return s>m?(x=Math.ceil(Math.abs(s-m)/b),s-=x*b,w=x):s<_&&(x=Math.ceil(Math.abs(s-_)/b),s+=x*b,w=-x),{x:s,frameId:w}}function v(s,h){const{xmin:_,ymin:m,xmax:b,ymax:x}=h;return O(s,_,m)&&O(s,_,x)&&O(s,b,x)&&O(s,b,m)}function O(s,h,_){return h>=s.xmin&&h<=s.xmax&&_>=s.ymin&&_<=s.ymax}function P(s,h){let _=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const m=!(0,S.Rg)(s);if(m&&(0,w.m3)(s),_)return(new T).cut(s,h);const b=m?s.rings:s.paths,x=m?4:2,R=b.length,M=-2*h;for(let w=0;w<R;w++){const s=b[w];if(s&&s.length>=x){const h=[];for(const _ of s)h.push([_[0]+M,_[1]]);b.push(h)}}return m?s.rings=b:s.paths=b,s}class C{constructor(s,h){this.extent=s,this.frameIds=h}}const G=(0,b.vt)();class T{constructor(){this._linesIn=[],this._linesOut=[]}cut(s,h){let _;if(this._xCut=h,s.rings)this._closed=!0,_=s.rings,this._minPts=4;else{if(!s.paths)return null;this._closed=!1,_=s.paths,this._minPts=2}for(const b of _){if(!b||b.length<this._minPts)continue;let s=!0;for(const h of b)s?(this.moveTo(h),s=!1):this.lineTo(h);this._closed&&this.close()}this._pushLineIn(),this._pushLineOut(),_=[];for(const b of this._linesIn)b&&b.length>=this._minPts&&_.push(b);const m=-2*this._xCut;for(const b of this._linesOut)if(b&&b.length>=this._minPts){for(const s of b)s[0]+=m;_.push(b)}return this._closed?s.rings=_:s.paths=_,s}moveTo(s){this._pushLineIn(),this._pushLineOut(),this._prevSide=this._side(s[0]),this._moveTo(s[0],s[1],this._prevSide),this._prevPt=s,this._firstPt=s}lineTo(s){const h=this._side(s[0]);if(h*this._prevSide==-1){const _=this._intersect(this._prevPt,s);this._lineTo(this._xCut,_,0),this._prevSide=0,this._lineTo(s[0],s[1],h)}else this._lineTo(s[0],s[1],h);this._prevSide=h,this._prevPt=s}close(){const s=this._firstPt,h=this._prevPt;s[0]===h[0]&&s[1]===h[1]||this.lineTo(s),this._checkClosingPt(this._lineIn),this._checkClosingPt(this._lineOut)}_moveTo(s,h,_){this._closed?(this._lineIn.push([_<=0?s:this._xCut,h]),this._lineOut.push([_>=0?s:this._xCut,h])):(_<=0&&this._lineIn.push([s,h]),_>=0&&this._lineOut.push([s,h]))}_lineTo(s,h,_){this._closed?(this._addPolyVertex(this._lineIn,_<=0?s:this._xCut,h),this._addPolyVertex(this._lineOut,_>=0?s:this._xCut,h)):_<0?(0===this._prevSide&&this._pushLineOut(),this._lineIn.push([s,h])):_>0?(0===this._prevSide&&this._pushLineIn(),this._lineOut.push([s,h])):this._prevSide<0?(this._lineIn.push([s,h]),this._lineOut.push([s,h])):this._prevSide>0&&(this._lineOut.push([s,h]),this._lineIn.push([s,h]))}_addPolyVertex(s,h,_){const m=s.length;m>1&&s[m-1][0]===h&&s[m-2][0]===h?s[m-1][1]=_:s.push([h,_])}_checkClosingPt(s){const h=s.length;h>3&&s[0][0]===this._xCut&&s[h-2][0]===this._xCut&&s[1][0]===this._xCut&&(s[0][1]=s[h-2][1],s.pop())}_side(s){return s<this._xCut?-1:s>this._xCut?1:0}_intersect(s,h){const _=(this._xCut-s[0])/(h[0]-s[0]);return s[1]+_*(h[1]-s[1])}_pushLineIn(){this._lineIn&&this._lineIn.length>=this._minPts&&this._linesIn.push(this._lineIn),this._lineIn=[]}_pushLineOut(){this._lineOut&&this._lineOut.length>=this._minPts&&this._linesOut.push(this._lineOut),this._lineOut=[]}}},41096:(s,h,_)=>{_.d(h,{A:()=>fe});var m=_(80671),b=_(18763),x=_(16842),w=_(50886),S=_(16904),R=_(35598),M=_(81618),G=_(63390),A=_(57453),k=(_(89412),_(68682)),z=_(88965),U=_(31670),Z=_(8084),E=_(8809),V=_(85060),j=_(99442),L=_(80271),q=_(99900),D=_(50386),N=_(74771),Q=_(79866),H=_(53809);var B=_(75224),W=_(84792),X=_(97930),Y=_(13869),J=_(29170),$=_(91080),K=_(61077),ee=_(32050),te=_(41156),se=_(95330);class c extends se.Y{static from(s,h,_){return new c(s,h,_)}constructor(s,h,_){super(_),this._items=s,this._tile=h,this._index=-1,this._cachedGeometry=null;const m=h.lod;m.wrap&&(this._wrappingInfo={worldSizeX:m.worldSize[0]})}get _current(){return this._items[this._index]}getItem(){return this._current}getZOrder(){return this._current.zOrder}getMeshWriters(){var s,h;return null!==(s=null===(h=this._current.symbolResource)||void 0===h?void 0:h.symbolInfo.meshWriters)&&void 0!==s?s:[]}hasField(s){return null!=this._current.attributes[s]}field(s){return this.readAttribute(s)}get geometryType(){const s=(0,U.$B)(this._current.geometry);return"esriGeometryPoint"===s?"esriGeometryMultipoint":s}getCursor(){return this.copy()}copy(){const s=new c(this._items,this._tile,this.metadata);return this.copyInto(s),s}copyInto(s){super.copyInto(s),s._cachedGeometry=this._cachedGeometry,s._index=this._index}get fields(){throw new Error("Fields reading not supported to graphics.")}get hasFeatures(){return!!this._items.length}get hasNext(){return this._index+1<this._items.length}get exceededTransferLimit(){throw new Error("InternalError: exceededTransferLimit not implemented for graphics.")}get hasZ(){return!1}get hasM(){return!1}getInTransform(){return this._tile.transform}getSize(){return this._items.length}getAttributeHash(){let s="";for(const h in this._current.attributes)s+=this._current.attributes[h];return s}getObjectId(){return this._items[this._index].objectId}getDisplayId(){return this._current.displayId}setDisplayId(s){throw new Error("InternalError: Setting displayId not supported for graphics.")}setIndex(s){this._index=s}getIndex(){return this._index}next(){for(this._cachedGeometry=null;++this._index<this._items.length&&!this._getExists(););return this._index<this._items.length}readGeometryArea(){throw new Error("InternalError: readGeometryArea not supported for graphics.")}_readGeometry(){if(!this._cachedGeometry){const s=(0,ee.Ux)(this._current.projectedGeometry,this.hasZ,this.hasM);if(this._cachedGeometry=(0,ee.Nl)(new te.A,s,this.hasZ,this.hasM,this.geometryType,this._tile.transform),!this._cachedGeometry)return null;this._wrapGeometry(this._cachedGeometry)}return this._cachedGeometry}_wrapGeometry(s){if(!this._wrappingInfo)return;const{worldSizeX:h}=this._wrappingInfo;if(s.isPoint)return 1===h?(s.coords.push(L.CQ,0),s.coords.push(2*-L.CQ,0),void s.lengths.push(3)):2===h?(s.coords.push(2*L.CQ,0),s.coords.push(4*-L.CQ,0),void s.lengths.push(3)):void this._wrapVertex(s.coords,0,2,h);if("esriGeometryMultipoint"!==this.geometryType);else{if(1===h){const h=s.coords.slice();h[0]-=512;const _=s.coords.slice();_[0]+=512,s.coords.push(...h,..._);const m=s.lengths[0];return void s.lengths.push(m,m)}this._wrapVertex(s.coords,0,2,h)}}_wrapVertex(s,h,_,m){const b=h*_,x=s[b];x<-L.CQ*(m-2)?s[b]=x+L.CQ*m:x>L.CQ*(m-1)&&(s[b]=x-L.CQ*m)}_readX(){const s=this._readGeometry();return null!=s?s.coords[0]:0}_readY(){const s=this._readGeometry();return null!=s?s.coords[1]:0}_readServerCentroid(){switch(this.geometryType){case"esriGeometryPolygon":{const s=(0,K.l8)(this._current.projectedGeometry),h=new te.A([],s);return(0,ee.Nl)(new te.A,h,this.hasZ,this.hasM,this.geometryType,this._tile.transform)}case"esriGeometryPolyline":{const s=this._current.projectedGeometry,h=(0,K.S8)(s.paths,this.hasZ),_=new te.A([],h);return(0,ee.Nl)(new te.A,_,this.hasZ,this.hasM,this.geometryType,this._tile.transform)}}return null}_readAttribute(s,h){const _=this._current.attributes[s];if(void 0!==_)return _;const m=s.toLowerCase();for(const b in this._current.attributes)if(b.toLowerCase()===m)return this._current.attributes[b]}_readAttributes(){return this._current.attributes}}var ie=_(62555),re=_(71055),ne=_(12439),oe=_(30172),ae=_(78395),he=_(80887),ce=_(78966),ue=_(12198),le=_(22786),de=_(48343);_(90624);function u(s){if(!s)return null;const{xmin:h,ymin:_,xmax:m,ymax:b,spatialReference:x}=s;return new de.A({rings:[[[h,_],[h,b],[m,b],[m,_],[h,_]]],spatialReference:x})}class GraphicStoreItem_p{static fromGraphic(s,h,_,m){return new GraphicStoreItem_p(s.geometry,h,s.attributes,s.visible,s.uid,_,m)}constructor(s,h,_,m,b,x,w){this.geometry=s,this.symbol=h,this.attributes=_,this.visible=m,this.objectId=b,this.zOrder=x,this.displayId=w,this.bounds=(0,z.vt)(),this.prevBounds=(0,z.vt)(),this.size=[0,0,0,0]}get linearCIM(){var s;return null===(s=this.symbolResource)||void 0===s?void 0:s.symbolInfo.linearCIM}update(s,h,_){return(this.geometry!==s.geometry||this.attributes!==s.attributes||this.symbol!==h||this.zOrder!==_||this.visible!==s.visible)&&(this.prevBounds=this.bounds,this.bounds=(0,z.vt)(),this.zOrder=_,this.geometry=s.geometry,this.attributes=s.attributes,this.symbol=h,this.visible=s.visible,this.symbolResource=null,this.projectedGeometry=null,!0)}async projectAndNormalize(s){let h=this.geometry;if(!h||!h.spatialReference||"mesh"===h.type)return;"extent"===h.type&&(h=u(h)),await(0,le.Nk)(h.spatialReference,s);const _=(0,ue.b3)(h);if(!_)return;const m=(0,le.Cv)(_,h.spatialReference,s);m&&(0,ce.uC)(m),this.projectedGeometry=(0,U.ZC)(m)?u(m):m}}class GraphicUpdateMessage_t{constructor(s,h,_){this.added=s,this.updated=h,this.removed=_}hasAnyUpdate(){return!!(this.added.length||this.updated.length||this.removed.length)}}const pe=1e-5;function d(s,h){return h.zOrder-s.zOrder}class p{constructor(s,h,_,m,b){this._items=new Map,this._boundsDirty=!1,this._outSpatialReference=s,this._cimResourceManager=h,this._hittestDrawHelper=new he.CK(h),this._tileInfoView=_,this._store=b;const x=_.getClosestInfoForScale(m);this._resolution=this._tileInfoView.getTileResolution(x.level)}items(){return this._items.values()}getItem(s){return this._items.get(s)}async update(s,h,_){const m=[],b=[],x=[],w=new Set,S=[];let R=0;for(const M of s.items){R++;const s=M.uid,x=this._items.get(s),G=h(M);if(w.add(s),x){x.update(M,G,R)&&(b.push(x),S.push(this._updateItem(x,_)));continue}const A=this._store.createDisplayIdForObjectId(s),k=GraphicStoreItem_p.fromGraphic(M,G,R,A);S.push(this._updateItem(k,_)),this._items.set(k.objectId,k),m.push(k)}for(const[M,G]of this._items.entries())w.has(M)||(this._store.releaseDisplayIdForObjectId(M),this._items.delete(M),x.push(G));return await Promise.all(S),this._index=null,new GraphicUpdateMessage_t(m,b,x)}updateLevel(s){this._resolution!==s&&(this._index=null,this._boundsDirty=!0,this._resolution=s)}hitTest(s,h,_,m,b){const x=(0,w.A)("esri-mobile"),S=(0,w.A)(x?"hittest-2d-mobile-tolerance":"hittest-2d-desktop-tolerance"),R=S+(x?0:(0,w.A)("hittest-2d-small-symbol-tolerance"));s=(0,oe.mT)(s,this._tileInfoView.spatialReference);const M=m*window.devicePixelRatio*R,G=(0,z.vt)();G[0]=s-M,G[1]=h-M,G[2]=s+M,G[3]=h+M;const A=m*window.devicePixelRatio*S,k=(0,z.vt)();k[0]=s-A,k[1]=h-A,k[2]=s+A,k[3]=h+A;const U=.5*m*(R+50),Z=this._searchIndex(s-U,h-U,s+U,h+U);if(!Z||0===Z.length)return[];const E=[],V=(0,z.vt)(),j=(0,z.vt)();for(const w of Z){if(!w.visible)continue;const{projectedGeometry:s,symbolResource:h}=w;this._getSymbolBounds(V,h,s,j,b),j[3]=j[2]=j[1]=j[0]=0,(0,z.HY)(V,G)&&E.push(w)}if(0===E.length)return[];const L=this._hittestDrawHelper,q=[];for(const w of E){const{projectedGeometry:s,symbolResource:h}=w;if(!h)continue;const{textInfo:_,symbolInfo:x}=h,S=x.cimSymbol;L.hitTest(k,S.symbol,s,_,b,m)&&q.push(w)}return q.sort(d),q.map((s=>s.objectId))}queryItems(s){return 0===this._items.size?[]:this._searchForItems(s)}clear(){this._items.clear(),this._index=null}async _updateItem(s,h){await s.projectAndNormalize(this._outSpatialReference),await h(s);const{size:_}=s;_[0]=_[1]=_[2]=_[3]=0,this._getSymbolBounds(s.bounds,s.symbolResource,s.projectedGeometry,s.size,0)}_searchIndex(s,h,_,m){return this._boundsDirty&&(this._items.forEach((s=>this._getSymbolBounds(s.bounds,s.symbolResource,s.projectedGeometry,s.size,0))),this._boundsDirty=!1),this._index||(this._index=(0,re.r)(9,(s=>({minX:s.bounds[0],minY:s.bounds[1],maxX:s.bounds[2],maxY:s.bounds[3]}))),this._index.load(Array.from(this._items.values()))),this._index.search({minX:s,minY:h,maxX:_,maxY:m})}_searchForItems(s){const h=this._tileInfoView.spatialReference,_=s.bounds,m=(0,ae.Vp)(h);if(m&&h.isWrappable){const[h,b]=m.valid,x=Math.abs(_[2]-b)<pe,w=Math.abs(_[0]-h)<pe;if((!x||!w)&&(x||w)){const m=s.resolution;let w;w=(0,z.vt)(x?[h,_[1],h+50*m,_[3]]:[b-50*m,_[1],b,_[3]]);const S=this._searchIndex(_[0],_[1],_[2],_[3]),R=this._searchIndex(w[0],w[1],w[2],w[3]);return[...new Set([...S,...R])]}}return this._searchIndex(_[0],_[1],_[2],_[3])}_getSymbolBounds(s,h,_,m,b){if(!h||!h.symbolInfo.linearCIM||!_)return null;if(s||(s=(0,z.vt)()),(0,ne.Rg)(s,_),!m||0===m[0]&&0===m[1]&&0===m[2]&&0===m[3]){const{textInfo:s,symbolInfo:_}=h,x=_.cimSymbol;m||(m=[0,0,0,0]);const w=E.Sc.getSymbolInflateSize(m,x.symbol,this._cimResourceManager,b,s);m[0]=(0,ie.Lz)(w[0]),m[1]=(0,ie.Lz)(w[1]),m[2]=(0,ie.Lz)(w[2]),m[3]=(0,ie.Lz)(w[3])}const x=this._resolution,w=E.Sc.safeSize(m);return s[0]-=w*x,s[1]-=w*x,s[2]+=w*x,s[3]+=w*x,s}}var _e=_(5993),me=_(72593);class F{static getOrCreate(s,h,_){let m=h.get(s.id);return m||(m=new F(s,_),h.set(s.id,m)),m}static fromItems(s,h,_){const m=new F(s,_);return m.addedOrModified.push(...h),m}constructor(s,h){this.tile=s,this.metadata=h,this.addedOrModified=[],this.removed=[]}get reader(){return this._reader||(this._reader=c.from(this.addedOrModified,this.tile,this.metadata)),this._reader}}let ye=class extends((0,S.sA)(b.A)){constructor(s){super(s),this._attached=!1,this._tiles=new Map,this._controller=new AbortController,this._hashToSymbolInfo=new Map,this._lastCleanup=performance.now(),this._cleanupRequired=!0,this.lastUpdateId=-1,this.renderer=null,this._updateTracking=new me.F({debugName:"GraphicsView2D"}),this.updateRequested=!1,this.defaultPointSymbolEnabled=!0,this._commandQueue=new _e.A({process:s=>{switch(s.type){case"processed-edit":throw new Error("InternalError: Unsupported command");case"update":return this._update()}}}),this.graphicUpdateHandler=this.graphicUpdateHandler.bind(this)}destroy(){this.container.destroy(),this.view=null,this.renderer=null,this._set("graphics",null),this._controller.abort(),this._graphicStore.clear(),this._attributeStore=null,this._hashToSymbolInfo.clear(),this._updateTracking.destroy(),this._commandQueue.destroy()}_initAttributeStore(){this._storage=new J.l({spatialReference:this.view.spatialReference,fields:new Z.A}),this._attributeStore=new Y.K({isLocal:!0,update:async s=>{(0,w.A)("esri-2d-update-debug")&&console.debug("[Id: ".concat(this.layerId,"] GraphicsView2D.AttributeStoreView.updateStart"),{message:s});const h=this.container.attributeView.requestUpdate(s);this.container.requestRender(),await h,(0,w.A)("esri-2d-update-debug")&&console.debug("[Id: ".concat(this.layerId,"] GraphicsView2D.AttributeStoreView.updateEnd"),{message:s})}});const s=(0,X.T9)(null,[]);this._attributeStore.update(s,this._storage,null),this.container.checkHighlight=()=>this._attributeStore.hasHighlight}initialize(){this._initAttributeStore(),this._metadata=$.h.create(this.view.spatialReference),this._resourceProxy=new N.J({fetch:s=>Promise.all(s.map((s=>this.view.stage.textureManager.rasterizeItem(s)))),fetchDictionary:s=>{throw new Error("InternalError: Graphics do not support Dictionary requests")}}),this.addHandles([(0,G.wB)((()=>this._effectiveRenderer),(()=>this._pushUpdate())),this.view.graphicsTileStore.on("update",this._onTileUpdate.bind(this)),this.container.on("attach",(()=>{this.addHandles([this.graphics.on("change",(()=>this._pushUpdate()))]),this._graphicStore=new p(this.view.spatialReference,this._cimResourceManager,this.view.featuresTilingScheme,this.view.state.scale,this._attributeStore),this._attached=!0,this.requestUpdate(),this._pushUpdate()}))]),this._updateTracking.addUpdateTracking("CommandQueue",this._commandQueue.updateTracking);const s=this.view.graphicsTileStore.tiles;this._onTileUpdate({added:s,removed:[]})}get _effectiveRenderer(){return"function"==typeof this.renderer?this.renderer():this.renderer}get _cimResourceManager(){return this.view.stage.textureManager.resourceManager}get updating(){const s=!this._attached||this._updateTracking.updating;return(0,w.A)("esri-2d-log-updating")&&console.log("Updating GraphicsView2D: ".concat(s,"\n  -> attaching ").concat(!this._attached,"\n  -> updateTracking ").concat(this._updateTracking.updating)),s}hitTest(s){if(!this.view||this.view.suspended)return[];const{resolution:h,rotation:_}=this.view.state,m=this._graphicStore.hitTest(s.x,s.y,2,h,_),b=new Set(m),w=this.graphics.items.reduce(((s,h)=>(b.has(h.uid)&&s.set(h.uid,h),s)),new Map);return m.map((s=>w.get(s))).filter(x.Ru)}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.requestUpdateCallback()),this.notifyChange("updating")}processUpdate(s){this.updateRequested&&(this.updateRequested=!1,this.update(s))}viewChange(){this.requestUpdate()}setHighlight(s){const h=[];for(const{objectId:m,highlightFlags:b}of s){var _;const s=null===(_=this._graphicStore.getItem(m))||void 0===_?void 0:_.displayId;h.push({objectId:m,highlightFlags:b,displayId:s})}this._attributeStore.setHighlight(h,s),this._pushUpdate()}graphicUpdateHandler(s){this._pushUpdate()}update(s){this.updateRequested=!1,this._attached&&this._graphicStore.updateLevel(s.state.resolution)}_pushUpdate(){(0,M.QZ)(this._commandQueue.push({type:"update"}))}async _update(){try{(0,w.A)("esri-2d-update-debug")&&console.debug("[Id: ".concat(this.layerId,"] GraphicsView._update start"));const s=await this._graphicStore.update(this.graphics,(s=>this._getSymbolForGraphic(s)),(s=>this._ensureSymbolResource(s)));if(!s.hasAnyUpdate())return void await this._attributeStore.sendUpdates();s.removed.length&&(this._cleanupRequired=!0),(0,w.A)("esri-2d-update-debug")&&console.debug("[Id: ".concat(this.layerId,"] GraphicsView updateMessage"),s);const h=this._createTileMessages(s);await this._fetchResources(h),this._write(h);for(const _ of s.added)this._setFilterState(_);for(const _ of s.updated)this._setFilterState(_);(0,w.A)("esri-2d-update-debug")&&console.debug("[Id: ".concat(this.layerId,"] GraphicsView sendUpdate"),s),await this._attributeStore.sendUpdates(),(0,w.A)("esri-2d-update-debug")&&console.debug("[Id: ".concat(this.layerId,"] GraphicsView sendUpdate.await"),s)}catch(s){}this._cleanupSharedResources()}_createTileMessages(s){const h=new Map;for(const _ of s.added){const s=this.view.graphicsTileStore.getIntersectingTiles(_.bounds);for(const m of s)F.getOrCreate(m,h,this._metadata).addedOrModified.push(_)}for(const _ of s.updated){const s=this.view.graphicsTileStore.getIntersectingTiles(_.prevBounds),m=this.view.graphicsTileStore.getIntersectingTiles(_.bounds);for(const b of s)F.getOrCreate(b,h,this._metadata).removed.push(_.displayId);for(const b of m)F.getOrCreate(b,h,this._metadata).addedOrModified.push(_)}for(const _ of s.removed){const s=this.view.graphicsTileStore.getIntersectingTiles(_.bounds);for(const m of s)F.getOrCreate(m,h,this._metadata).removed.push(_.displayId)}return Array.from(h.values())}async _fetchResources(s){for(const{tile:h,reader:_}of s){(0,w.A)("esri-2d-update-debug")&&console.debug("Id[".concat(this.layerId,"] Tile[").concat(h.id,"] GraphicsView fetchResources"),s);const m=_.getCursor();for(;m.next();)for(const s of m.getMeshWriters())s.enqueueRequest(this._resourceProxy,m,h.createArcadeEvaluationOptions(this.view.timeZone))}await this._resourceProxy.fetchEnqueuedResources()}_write(s){for(const h of s){(0,w.A)("esri-2d-update-debug")&&console.debug("Id[".concat(this.layerId,"] Tile[").concat(h.tile.id,"] GraphicsView write"),h);const s=this._writeMeshes(h);let _=this._tiles.get(h.tile.key);_||(_=this._createFeatureTile(h.tile.key)),(0,w.A)("esri-2d-update-debug")&&console.debug("Id[".concat(this.layerId,"] Tile[").concat(h.tile.id,"] GraphicsView onTileData"),h),this.container.onTileData(_,{type:"update",modify:s,remove:h.removed,end:!1,attributeEpoch:this._attributeStore.epoch}),this.container.requestRender()}}_writeMeshes(s){const h=new D.U(s.tile.id),_=s.reader.getCursor();for(;_.next();){h.entityStart(_.getDisplayId(),_.getZOrder());for(const m of _.getMeshWriters())m.write(h,this._resourceProxy,_,s.tile.createArcadeEvaluationOptions(this.view.timeZone),s.tile.level);h.entityEnd()}return{...h.serialize().message,tileId:s.tile.id}}_setFilterState(s){const h=s.displayId,_=this._attributeStore.getHighlightFlags(s.objectId);this._attributeStore.setData(h,0,0,_|(s.visible?L.LY:0))}_getSymbolForGraphic(s){return null!=s.symbol?s.symbol:null!=this._effectiveRenderer?this._effectiveRenderer.getSymbol(s):this._getNullSymbol(s)}async _ensureSymbolResource(s){if(!s.symbol)return;const h=await this._getSymbolInfo(s.symbol);if(!h)return;const _=h.linearCIM.filter((s=>"text"===s.type));if(_.length>0){const m=await this._getTextResources(s,_);s.symbolResource={symbolInfo:h,textInfo:m}}else s.symbolResource={symbolInfo:h}}_getSymbolInfo(s){const h=s.hash();return this._hashToSymbolInfo.has(h)||this._hashToSymbolInfo.set(h,this._createSymbolInfo(h,s).catch((s=>null))),this._hashToSymbolInfo.get(h)}async _createSymbolInfo(s,h){const _=await this._convertToCIMSymbol(h),m=await this._createLinearCIM(_);if("text"===h.type)for(const b of m)"text"===b.type&&(b.lineWidth=h.lineWidth);return{hash:s,cimSymbol:_,linearCIM:m,meshWriters:await this._createMeshWriters(_,m)}}async _convertToCIMSymbol(s){const h=(0,E.Vb)(s);return"web-style"===h.type?(await h.fetchCIMSymbol()).data:h}async _createLinearCIM(s){return await Promise.all(E.wp.fetchResources(s.symbol,this._cimResourceManager,[])),this.view.stage.cimAnalyzer.analyzeSymbolReference(s,!1)}async _createMeshWriters(s,h){(0,M.Te)(this._controller.signal);const _=this.container.instanceStore,m=await async function l(s,h,_){const m=[],b={scaleInfo:(0,H.TY)(s),scaleExpression:null};for(const x of h)switch(x.type){case"marker":m.push(...(0,H.Zi)(_.instances.marker,x,Q.Dk,b));break;case"fill":null==x.spriteRasterizationParam?m.push(...(0,H.Gn)(_.instances.fill,x,b)):m.push(...(0,H.oF)(_.instances.complexFill,x,!1,b));break;case"line":x.spriteRasterizationParam?m.push(...(0,H.EM)(_.instances.texturedLine,x,!1,b)):m.push(...(0,H.NZ)(_.instances.line,x,!1,b));break;case"text":m.push(...(0,H.IQ)(_.instances.text,x,Q.Dk,b))}return m}(s,h,_);return Promise.all(m.map((s=>(0,B.hZ)(this._storage,this._resourceProxy,s.meshWriterName,(0,W.P)(s.id),s.options,{tileInfo:this.view.featuresTilingScheme.tileInfo},s.optionalAttributes))))}_onTileUpdate(s){if(s.added&&s.added.length>0)for(const h of s.added)this._updateTracking.addPromise(this._addTile(h));if(s.removed&&s.removed.length>0)for(const h of s.removed)this._removeTile(h.key)}_createFeatureTile(s){const h=this.view.featuresTilingScheme.getTileBounds((0,z.vt)(),s),_=this.view.featuresTilingScheme.getTileResolution(s.level),m=new q.R(s,_,h[0],h[3]);return this._tiles.set(s,m),this.container.addChild(m),m}async _addTile(s){if(!this._attached)return;const h=this._graphicStore.queryItems(s);if(!h.length)return;const _=this._createFeatureTile(s.key),m=F.fromItems(s,h,this._metadata);await this._fetchResources([m]);const b=this._writeMeshes(m);_.onMessage({type:"append",append:b,clear:!1,end:!0,attributeEpoch:this._attributeStore.epoch})}_removeTile(s){if(!this._tiles.has(s))return;const h=this._tiles.get(s);this.container.removeChild(h),h.destroy(),this._tiles.delete(s)}_getNullSymbol(s){const h=s.geometry;return(0,U.Rg)(h)?j.x3:(0,U.Bi)(h)||(0,U.ZC)(h)?j.JJ:this.defaultPointSymbolEnabled?j.jM:null}async _getTextResources(s,h){const _=new Array,m=new Array;for(let S=0;S<h.length;S++){const b=h[S],{resource:x,overrides:w}=b.textRasterizationParam;if((null===w||void 0===w?void 0:w.length)>0){const h=V.$.resolveSymbolOverrides({type:"CIMSymbolReference",primitiveOverrides:w,symbol:{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,size:x.symbol.height,anchorPointUnits:"Relative",frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:x.symbol,textString:x.textString}],scaleSymbolsProportionally:!0,respectFrame:!0}]}},s,this.view.spatialReference,null,(0,U.$B)(s.projectedGeometry),null,null);h.then((s=>{const h=s.symbolLayers[0],{textString:_}=h.markerGraphics[0];m.push({type:"cim-rasterization-info",resource:{type:"text",textString:_||"",font:x.font}}),b.text=x.textString=_||""})),_.push(h)}else m.push({type:"cim-rasterization-info",resource:x})}_.length>0&&await Promise.all(_);const b=m.map((s=>this.view.stage.textureManager.rasterizeItem(s))),x=await Promise.all(b);(0,R.Lw)(x);const w=new Map;for(let S=0;S<h.length;S++){const s=h[S];w.set(s.textRasterizationParam.resource.symbol,{text:s.text,glyphMosaicItems:x[S]})}return w}_cleanupSharedResources(){if(!this._cleanupRequired)return;const s=performance.now();if(s-this._lastCleanup<5e3)return;this._cleanupRequired=!1,this._lastCleanup=s;const h=new Set;for(const b of this._graphicStore.items()){var _;const s=null===(_=b.symbolResource)||void 0===_?void 0:_.symbolInfo.hash;h.add(s)}const m=new Set(this._hashToSymbolInfo.keys());for(const b of m.values())h.has(b)||this._hashToSymbolInfo.delete(b)}};(0,m._)([(0,A.MZ)()],ye.prototype,"_effectiveRenderer",null),(0,m._)([(0,A.MZ)({constructOnly:!0})],ye.prototype,"layerId",void 0),(0,m._)([(0,A.MZ)({constructOnly:!0})],ye.prototype,"requestUpdateCallback",void 0),(0,m._)([(0,A.MZ)()],ye.prototype,"container",void 0),(0,m._)([(0,A.MZ)({constructOnly:!0})],ye.prototype,"graphics",void 0),(0,m._)([(0,A.MZ)()],ye.prototype,"renderer",void 0),(0,m._)([(0,A.MZ)()],ye.prototype,"_updateTracking",void 0),(0,m._)([(0,A.MZ)()],ye.prototype,"updating",null),(0,m._)([(0,A.MZ)()],ye.prototype,"view",void 0),(0,m._)([(0,A.MZ)()],ye.prototype,"updateRequested",void 0),(0,m._)([(0,A.MZ)()],ye.prototype,"defaultPointSymbolEnabled",void 0),ye=(0,m._)([(0,k.$)("esri.views.2d.layers.support.GraphicsView2D")],ye);const fe=ye}}]);
//# sourceMappingURL=7326.dbd3977d.chunk.js.map