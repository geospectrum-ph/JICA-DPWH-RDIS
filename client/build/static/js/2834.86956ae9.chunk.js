"use strict";(self.webpackChunkSEEDs_v2_0_Client=self.webpackChunkSEEDs_v2_0_Client||[]).push([[2834],{42834:(e,n,s)=>{s.r(n),s.d(n,{createConnection:()=>r});var i=s(80671),a=(s(30174),s(53705)),l=s(4180),u=s(89412),h=s(81618),_=s(4270),w=(s(50886),s(76761),s(68682)),v=s(57453),b=s(8641),k=s(73067);let F=class extends k.A.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new l.A("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};(0,i._)([(0,v.MZ)({readOnly:!0})],F.prototype,"connectionError",null),F=(0,i._)([(0,w.$)("esri.layers.support.StreamConnection")],F);const A=F;var O,R;(R=O||(O={}))[R.CONNECTING=0]="CONNECTING",R[R.OPEN=1]="OPEN",R[R.CLOSING=2]="CLOSING",R[R.CLOSED=3]="CLOSED";let C=class extends A{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:n,spatialReference:s,sourceSpatialReference:i}=e;this._config=e,this._featureZScaler=(0,b.N)(n,i,s),this._open()}normalizeCtorArgs(){return{}}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){super.destroy(),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case O.CONNECTING:case O.OPEN:return"connected";case O.CLOSING:case O.CLOSED:return"disconnected"}}sendMessageToSocket(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}async _tryCreateWebSocket(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._config.source.path,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{var i;if(this.destroyed)return;const n=(0,_.a6)(e,null!==(i=this._config.customParameters)&&void 0!==i?i:{});this._websocket=await this._createWebSocket(n),this.notifyChange("connectionStatus")}catch(F){const a=n/1e3;return this._config.maxReconnectionAttempts&&s>=this._config.maxReconnectionAttempts?(u.A.getLogger(this).error(new l.A("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(u.A.getLogger(this).error(new l.A("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(a,"s"),F)),await(0,h.Pl)(n),this._tryCreateWebSocket(e,Math.min(1.5*n,1e3*this._config.maxReconnectionInterval),s+1))}}_setWebSocketJSONParseHandler(e){e.onmessage=e=>{try{const n=JSON.parse(e.data);this._onMessage(n)}catch(n){return void u.A.getLogger(this).error(new l.A("websocket-connection","Failed to parse message, invalid JSON",{error:n}))}}}_createWebSocket(e){return new Promise(((n,s)=>{const i=new WebSocket(e);i.onopen=()=>{if(i.onopen=null,this.destroyed)return i.onclose=null,void i.close();i.onclose=e=>this._onClose(e),i.onerror=e=>this._onError(e),this._setWebSocketJSONParseHandler(i),n(i)},i.onclose=e=>{i.onopen=i.onclose=null,s(e)}}))}async _handshake(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;const n=this._websocket;if(null==n)return;const s=(0,h.Tw)(),i=n.onmessage,{filter:a,outFields:_,spatialReference:w}=this._config;return s.timeout(e),n.onmessage=e=>{var h;let v=null;try{v=JSON.parse(e.data)}catch(O){}v&&"object"==typeof v||(u.A.getLogger(this).error(new l.A("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),s.reject(),this.destroy()),(null===(h=v.spatialReference)||void 0===h?void 0:h.wkid)!==(null===w||void 0===w?void 0:w.wkid)&&(u.A.getLogger(this).error(new l.A("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(w.wkid),e.data)),s.reject(),this.destroy()),"json"!==v.format&&(u.A.getLogger(this).error(new l.A("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),s.reject(),this.destroy()),a&&v.filter!==a&&u.A.getLogger(this).error(new l.A("websocket-connection","Tried to set filter, but server doesn't support it")),_&&v.outFields!==_&&u.A.getLogger(this).error(new l.A("websocket-connection","Tried to set outFields, but server doesn't support it")),n.onmessage=i;for(const s of this._outstandingMessages)n.send(JSON.stringify(s));this._outstandingMessages=[],s.resolve()},n.send(JSON.stringify({filter:a,outFields:_,format:"json",spatialReference:{wkid:w.wkid}})),s.promise}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const n of e.features)null!=this._featureZScaler&&this._featureZScaler(n.geometry),this.onFeature(n)}}_onError(e){const n="Encountered an error over WebSocket connection";this._set("errorString",n),u.A.getLogger(this).error("websocket-connection",n)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&u.A.getLogger(this).error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}};(0,i._)([(0,v.MZ)()],C.prototype,"connectionStatus",null),(0,i._)([(0,v.MZ)()],C.prototype,"errorString",void 0),C=(0,i._)([(0,w.$)("esri.layers.graphics.sources.connections.WebSocketConnection")],C);var N=s(83947),q=s(49096),P=s(31670),j=s(98664);const L={maxQueryDepth:5,maxRecordCountFactor:3};let J=class extends C{constructor(e){super({...L,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||u.A.getLogger(this).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const n=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(n);const{filter:s,outFields:i}=this._config;this.destroyed||this._setFilter(s,i)}_onMessage(e){if("attributes"in e){let s;try{s=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(s.geometry)}catch(n){return void u.A.getLogger(this).error(new l.A("geoevent-connection","Failed to parse message",n))}this.onFeature(s)}else this.onMessage(e)}async _fetchServiceDefinition(e){const n={f:"json",...this._config.customParameters},s=(0,a.A)(e.path,{query:n,responseType:"json"}),i=(await s).data;return this._serviceDefinition=i,i}_fetchWebSocketUrl(e,n){const s=e[0],{urls:i,token:a}=s,l=this._inferWebSocketBaseUrl(i);return(0,_.a6)("".concat(l,"/subscribe"),{outSR:""+n.wkid,token:a})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const n of e)if(n.includes("wss"))return n;return u.A.getLogger(this).error(new l.A("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,n){const s=this._websocket;if(null==s||null==e&&null==n)return;const i=JSON.stringify({filter:this._serializeFilter(e,n)});let a=!1;const _=(0,h.Tw)();return s.onmessage=e=>{const n=JSON.parse(e.data);n.filter&&(n.error&&(u.A.getLogger(this).error(new l.A("geoevent-connection","Failed to set service filter",n.error)),this._set("errorString","Could not set service filter - ".concat(n.error)),_.reject(n.error)),this._setWebSocketJSONParseHandler(s),a=!0,_.resolve())},s.send(i),setTimeout((()=>{a||(this.destroyed||this._websocket!==s||u.A.getLogger(this).error(new l.A("geoevent-connection","Server timed out when setting filter")),_.reject())}),1e4),_.promise}_serializeFilter(e,n){const s={};if(null==e&&null==n)return s;if(null!==e&&void 0!==e&&e.geometry)try{const n=(0,P.rS)(e.geometry);if("extent"!==n.type)throw new l.A("Expected extent but found type ".concat(n.type));s.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(i){u.A.getLogger(this).error(new l.A("geoevent-connection","Encountered an error when setting connection geometryDefinition",i))}return null!==e&&void 0!==e&&e.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(s.where=e.where),null!=n&&(s.outFields=n.join(",")),s}_enrich(e){if(!this._relatedFeatures)return e;const n=this._serviceDefinition.relatedFeatures.joinField,s=e.attributes[n],i=this._relatedFeatures.get(s);if(!i)return u.A.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:a,geometry:h}=i;for(const l in a)e.attributes[l]=a[l];return h&&(e.geometry=h),e.geometry||e.centroid||u.A.getLogger(this).error(new l.A("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:n}=this._serviceDefinition,s=this._queryRelatedFeatures(e),i=this._queryArchive(n);await s;const a=await i;if(!a)return;for(const l of a.features)this.onFeature(this._enrich(l))}catch(R){u.A.getLogger(this).error(new l.A("geoevent-connection","Encountered an error when querying buddy services",{error:R}))}}async _queryRelatedFeatures(e){if(!e)return;const n=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(n)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){var n,i,a;const l=new((await Promise.all([s.e(5658),s.e(6572),s.e(9370),s.e(1322)]).then(s.bind(s,9370))).default)({url:e}),{capabilities:u}=await l.load(),h=u.query.supportsMaxRecordCountFactor,_=u.query.supportsPagination,w=u.query.supportsCentroid,v=this._config.maxRecordCountFactor,b=l.capabilities.query.maxRecordCount,k=h?b*v:b,F=new q.A;if(F.outFields=null!==(n=this._config.outFields)&&void 0!==n?n:["*"],F.where=null!==(i=null===(a=this._config.filter)||void 0===a?void 0:a.where)&&void 0!==i?i:"1=1",F.returnGeometry=!0,F.returnExceededLimitFeatures=!0,F.outSpatialReference=j.A.fromJSON(this._config.spatialReference),w&&(F.returnCentroid=!0),h&&(F.maxRecordCountFactor=v),_)return F.num=k,l.destroy(),this._queryPages(e,F);const A=await(0,N.eW)(e,F,this._config.sourceSpatialReference);return l.destroy(),A.data}async _queryPages(e,n){var s;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;n.start=null!=n.num?a*n.num:null;const{data:l}=await(0,N.eW)(e,n,this._config.sourceSpatialReference);return l.exceededTransferLimit&&a<(null!==(s=this._config.maxQueryDepth)&&void 0!==s?s:0)?(l.features.forEach((e=>i.push(e))),this._queryPages(e,n,i,a+1)):(i.forEach((e=>l.features.push(e))),l)}_addRelatedFeatures(e){const n=new Map,s=e.features,i=this._serviceDefinition.relatedFeatures.joinField;for(const a of s){const e=a.attributes[i];n.set(e,a)}this._relatedFeatures=n}};J=(0,i._)([(0,w.$)("esri.layers.graphics.sources.connections.GeoEventConnection")],J);const T=J;let M=class extends A{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:n,spatialReference:s,sourceSpatialReference:i}=e;this._featureZScaler=(0,b.N)(n,i,s)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const n of e.features)null!=this._featureZScaler&&this._featureZScaler(n.geometry),this.onFeature(n)}this.onMessage(e)}};function o(e,n){if(null==e&&null==n)return null;const s={};return null!=n&&(s.geometry=n),null!=e&&(s.where=e),s}function r(e,n,s,i,a,l,u,h,_){const w={source:e,sourceSpatialReference:n,spatialReference:s,geometryType:i,filter:o(a,l),maxReconnectionAttempts:u,maxReconnectionInterval:h,customParameters:_};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new C(w):new T(w):new M(w)}(0,i._)([(0,v.MZ)()],M.prototype,"connectionStatus",void 0),(0,i._)([(0,v.MZ)()],M.prototype,"errorString",void 0),M=(0,i._)([(0,w.$)("esri.layers.support.ClientSideConnection")],M)},19766:(e,n,s)=>{function t(e){const n={};for(const s in e){if("declaredClass"===s)continue;const i=e[s];if(null!=i&&"function"!=typeof i)if(Array.isArray(i)){n[s]=[];for(let e=0;e<i.length;e++)n[s][e]=t(i[e])}else"object"==typeof i?i.toJSON&&(n[s]=JSON.stringify(i)):n[s]=i}return n}s.d(n,{z:()=>t})},83947:(e,n,s)=>{s.d(n,{GB:()=>E,IJ:()=>f,Jf:()=>x,Pk:()=>p,eW:()=>c,gW:()=>S,kS:()=>d});var i=s(53705),a=s(4270),l=s(31670),u=s(30172),h=s(78395),_=s(19766),w=s(84714),v=s(34127);const b="Layer does not support extent calculation.";function y(e,n){var s;const i=e.geometry,a=e.toJSON();delete a.compactGeometryEnabled,delete a.defaultSpatialReferenceEnabled;const u=a;let _,w,v;if(null!=i&&(w=i.spatialReference,v=(0,h.YX)(w),u.geometryType=(0,l.$B)(i),u.geometry=function m(e,n){if(n&&"extent"===e.type)return"".concat(e.xmin,",").concat(e.ymin,",").concat(e.xmax,",").concat(e.ymax);if(n&&"point"===e.type)return"".concat(e.x,",").concat(e.y);const s=e.toJSON();return delete s.spatialReference,JSON.stringify(s)}(i,e.compactGeometryEnabled),u.inSR=v),a.groupByFieldsForStatistics&&(u.groupByFieldsForStatistics=a.groupByFieldsForStatistics.join(",")),a.objectIds&&(u.objectIds=a.objectIds.join(",")),a.orderByFields&&(u.orderByFields=a.orderByFields.join(",")),!a.outFields||!a.returnDistinctValues&&(null!==n&&void 0!==n&&n.returnCountOnly||null!==n&&void 0!==n&&n.returnExtentOnly||null!==n&&void 0!==n&&n.returnIdsOnly)?delete u.outFields:a.outFields.includes("*")?u.outFields="*":u.outFields=a.outFields.join(","),a.outSR?(u.outSR=(0,h.YX)(a.outSR),_=e.outSpatialReference):i&&(a.returnGeometry||a.returnCentroid)&&(u.outSR=u.inSR,_=w),a.returnGeometry&&delete a.returnGeometry,a.outStatistics&&(u.outStatistics=JSON.stringify(a.outStatistics)),a.fullText&&(u.fullText=JSON.stringify(a.fullText)),a.pixelSize&&(u.pixelSize=JSON.stringify(a.pixelSize)),a.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=w&&null!=(null===(s=e.quantizationParameters)||void 0===s?void 0:s.extent)&&w.equals(e.quantizationParameters.extent.spatialReference)&&delete a.quantizationParameters.extent.spatialReference,u.quantizationParameters=JSON.stringify(a.quantizationParameters)),a.parameterValues&&(u.parameterValues=JSON.stringify(a.parameterValues)),a.rangeValues&&(u.rangeValues=JSON.stringify(a.rangeValues)),a.dynamicDataSource&&(u.layer=JSON.stringify({source:a.dynamicDataSource}),delete a.dynamicDataSource),a.timeExtent){const e=a.timeExtent,{start:n,end:s}=e;null==n&&null==s||(u.time=n===s?n:"".concat(null!==n&&void 0!==n?n:"null",",").concat(null!==s&&void 0!==s?s:"null")),delete a.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=w&&null!=_&&w.equals(_)&&(u.defaultSR=u.inSR,delete u.inSR,delete u.outSR),u}async function c(e,n,s,i){const a=null!=n.timeExtent&&n.timeExtent.isEmpty?{data:{features:[]}}:await E(e,n,"json",i);return(0,v.q)(n,s,a.data),a}async function f(e,n,s,i){if(null!=n.timeExtent&&n.timeExtent.isEmpty)return{data:s.createFeatureResult()};const a=await d(e,n,i),l=a;return l.data=(0,w.m)(a.data,s),l}function d(e,n,s){return E(e,n,"pbf",s)}function p(e,n,s){return null!=n.timeExtent&&n.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):E(e,n,"json",s,{returnIdsOnly:!0})}function S(e,n,s){return null!=n.timeExtent&&n.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):E(e,n,"json",s,{returnIdsOnly:!0,returnCountOnly:!0})}async function x(e,n,s){if(null!=n.timeExtent&&n.timeExtent.isEmpty)return{data:{count:0,extent:null}};const i=await E(e,n,"json",s,{returnExtentOnly:!0,returnCountOnly:!0}),a=i.data;if(a.hasOwnProperty("extent"))return i;if(a.features)throw new Error(b);if(a.hasOwnProperty("count"))throw new Error(b);return i}async function E(e,n,s){let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const w="string"==typeof e?(0,a.An)(e):e,v=n.geometry?[n.geometry]:[],b=await(0,u.el)(v,null,{signal:l.signal}),k=null===b||void 0===b?void 0:b[0];null!=k&&((n=n.clone()).geometry=k);const F=(0,_.z)({...w.query,f:s,...h,...y(n,h)});return(0,i.A)((0,a.fj)(w.path,function g(e,n){return null!=e.formatOf3DObjects&&!(n.returnCountOnly||n.returnExtentOnly||n.returnIdsOnly)}(n,h)?"query3d":"query"),{...l,responseType:"pbf"===s?"array-buffer":"json",query:{...F,...l.query}})}},34127:(e,n,s)=>{s.d(n,{q:()=>t});var i=s(8641);function t(e,n,s){if(null===s||void 0===s||!s.features||!s.hasZ)return;const a=(0,i.N)(s.geometryType,n,e.outSpatialReference);if(null!=a)for(const i of s.features)a(i.geometry)}}}]);
//# sourceMappingURL=2834.86956ae9.chunk.js.map