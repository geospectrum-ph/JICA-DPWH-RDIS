"use strict";(self.webpackChunkSEEDs_v2_0_Client=self.webpackChunkSEEDs_v2_0_Client||[]).push([[7801],{637:(d,b,M)=>{M.d(b,{NH:()=>a,ip:()=>r,sU:()=>c,vG:()=>g});M(50886);var S=M(4180),O=M(4270);function a(d){const b=o(d);return null!=b?b.toDataURL():""}async function r(d){const b=o(d);if(null==b)throw new S.A("imageToArrayBuffer","Unsupported image type");const M=await async function i(d){if(!(d instanceof HTMLImageElement))return"image/png";const b=d.src;if((0,O.DB)(b)){const d=(0,O.r$)(b);return"image/jpeg"===(null===d||void 0===d?void 0:d.mediaType)?d.mediaType:"image/png"}return/\.png$/i.test(b)?"image/png":/\.(jpg|jpeg)$/i.test(b)?"image/jpeg":"image/png"}(d),P=await new Promise((d=>b.toBlob(d,M)));if(!P)throw new S.A("imageToArrayBuffer","Failed to encode image");return{data:await P.arrayBuffer(),type:M}}function o(d){if(d instanceof HTMLCanvasElement)return d;if(d instanceof HTMLVideoElement)return null;const b=document.createElement("canvas");b.width=d.width,b.height=d.height;const M=b.getContext("2d");return d instanceof HTMLImageElement?M.drawImage(d,0,0,d.width,d.height):d instanceof ImageData&&M.putImageData(d,0,0),b}function c(d){const b=[],M=new Uint8Array(d);for(let S=0;S<M.length;S++)b.push(String.fromCharCode(M[S]));return"data:application/octet-stream;base64,"+btoa(b.join(""))}function g(d){if(d.byteLength<8)return!1;const b=new Uint8Array(d);return 137===b[0]&&80===b[1]&&78===b[2]&&71===b[3]&&13===b[4]&&10===b[5]&&26===b[6]&&10===b[7]}},76547:(d,b,M)=>{M.d(b,{D:()=>t});var S=M(53705);async function t(d,b){const{data:M}=await(0,S.A)(d,{responseType:"image",...b});return M}},85914:(d,b,M)=>{M.d(b,{A:()=>i});var S=M(77480),O=M(49178);class i{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(d){var b;return null!==(b=this._resourceMap.get(d))&&void 0!==b?b:null}async fetchResource(d,b){const M=this._resourceMap.get(d);if(M)return{width:M.width,height:M.height};let S=this._inFlightResourceMap.get(d);return S?S.then((d=>({width:d.width,height:d.height}))):(S=(0,O.M5)(d,b),this._inFlightResourceMap.set(d,S),S.then((b=>(this._inFlightResourceMap.delete(d),this._resourceMap.set(d,b),{width:b.width,height:b.height})),(()=>({width:0,height:0}))))}deleteResource(d){this._inFlightResourceMap.delete(d),this._resourceMap.delete(d)}loadFont(d){return(0,S.Al)(d)}}},14789:(d,b,M)=>{M.d(b,{Fj:()=>m,Z7:()=>f,ce:()=>a,eR:()=>e});var S=M(31714),O=M(31670),P=M(29470),T=M(80271);function e(d){switch(d.type){case"CIMPointSymbol":{const b=d.symbolLayers;if(!b||1!==b.length)return null;const M=b[0];return"CIMVectorMarker"!==M.type?null:e(M)}case"CIMVectorMarker":{var b;const M=d.markerGraphics;if(!M||1!==M.length)return null;const S=M[0];if(!S)return null;const O=S.geometry;if(!O)return null;const P=S.symbol;return!P||"CIMPolygonSymbol"!==P.type&&"CIMLineSymbol"!==P.type||null!==(b=P.symbolLayers)&&void 0!==b&&b.some((d=>!!d.effects))?null:{type:"sdf",geom:O,asFill:"CIMPolygonSymbol"===P.type}}}}function s(d){let b=1/0,M=-1/0,S=1/0,O=-1/0;for(const P of d)for(const d of P)d[0]<b&&(b=d[0]),d[0]>M&&(M=d[0]),d[1]<S&&(S=d[1]),d[1]>O&&(O=d[1]);return[b,S,M,O]}function f(d){return d?d.rings?s(d.rings):d.paths?s(d.paths):(0,O.ZC)(d)?[d.xmin,d.ymin,d.xmax,d.ymax]:null:null}function m(d,b,M,S,O){const[P,C,E,A]=d;if(E<P||A<C)return[0,0,0,1];const z=E-P,B=A-C,I=T.hM,U=Math.floor(.5*(64-I)),V=(128-2*(U+I))/Math.max(z,B),W=Math.round(z*V)+2*U,H=Math.round(B*V)+2*U;let q=1;b&&(q=H/V/(b.ymax-b.ymin));let Y=0,K=0,J=1;S&&(O?b&&M&&b.ymax-b.ymin>0&&(J=(b.xmax-b.xmin)/(b.ymax-b.ymin),Y=S.x/(M*J),K=S.y/M):(Y=S.x,K=S.y)),b&&(Y=.5*(b.xmax+b.xmin)+Y*(b.xmax-b.xmin),K=.5*(b.ymax+b.ymin)+K*(b.ymax-b.ymin)),Y-=P,K-=C,Y*=V,K*=V,Y+=U,K+=U;let Q=Y/W-.5,Z=K/H-.5;return O&&M&&(Q*=M*J,Z*=M),[q,Q,Z,J]}function a(d){const b=function l(d){return d?d.rings?d.rings:d.paths?d.paths:void 0!==d.xmin&&void 0!==d.ymin&&void 0!==d.xmax&&void 0!==d.ymax?[[[d.xmin,d.ymin],[d.xmin,d.ymax],[d.xmax,d.ymax],[d.xmax,d.ymin],[d.xmin,d.ymin]]]:null:null}(d.geom),M=function i(d){let b=1/0,M=-1/0,S=1/0,O=-1/0;for(const P of d)for(const d of P)d[0]<b&&(b=d[0]),d[0]>M&&(M=d[0]),d[1]<S&&(S=d[1]),d[1]>O&&(O=d[1]);return new P.A(b,S,M-b,O-S)}(b),S=T.hM,O=Math.floor(.5*(64-S)),C=(128-2*(O+S))/Math.max(M.width,M.height),E=Math.round(M.width*C)+2*O,A=Math.round(M.height*C)+2*O,z=[];for(const P of b)if(P&&P.length>1){const b=[];for(const S of P){let[P,T]=S;P-=M.x,T-=M.y,P*=C,T*=C,P+=O-.5,T+=O-.5,d.asFill?b.push([P,T]):b.push([Math.round(P),Math.round(T)])}if(d.asFill){const d=b.length-1;b[0][0]===b[d][0]&&b[0][1]===b[d][1]||b.push(b[0])}z.push(b)}const B=function c(d,b,M,S){const O=b*M,P=new Array(O),T=S*S+1;for(let C=0;C<O;++C)P[C]=T;for(const C of d){const d=C.length;for(let O=1;O<d;++O){const d=C[O-1],T=C[O];let E,A,z,B;d[0]<T[0]?(E=d[0],A=T[0]):(E=T[0],A=d[0]),d[1]<T[1]?(z=d[1],B=T[1]):(z=T[1],B=d[1]);let I=Math.floor(E)-S,U=Math.floor(A)+S,V=Math.floor(z)-S,W=Math.floor(B)+S;I<0&&(I=0),U>b&&(U=b),V<0&&(V=0),W>M&&(W=M);const H=T[0]-d[0],q=T[1]-d[1],Y=H*H+q*q;for(let S=I;S<U;S++)for(let O=V;O<W;O++){let C,E,A=(S-d[0])*H+(O-d[1])*q;A<0?(C=d[0],E=d[1]):A>Y?(C=T[0],E=T[1]):(A/=Y,C=d[0]+A*H,E=d[1]+A*q);const z=(S-C)*(S-C)+(O-E)*(O-E),B=(M-O-1)*b+S;z<P[B]&&(P[B]=z)}}}for(let C=0;C<O;++C)P[C]=Math.sqrt(P[C]);return P}(z,E,A,O);return d.asFill&&function u(d,b,M,S,O){for(const P of d){const d=P.length;for(let T=1;T<d;++T){const d=P[T-1],C=P[T];let E,A,z,B;d[0]<C[0]?(E=d[0],A=C[0]):(E=C[0],A=d[0]),d[1]<C[1]?(z=d[1],B=C[1]):(z=C[1],B=d[1]);let I=Math.floor(E),U=Math.floor(A)+1,V=Math.floor(z),W=Math.floor(B)+1;I<S&&(I=S),U>b-S&&(U=b-S),V<S&&(V=S),W>M-S&&(W=M-S);for(let P=V;P<W;++P){if(d[1]>P==C[1]>P)continue;const T=(M-P-1)*b;for(let b=I;b<U;++b)b<(C[0]-d[0])*(P-d[1])/(C[1]-d[1])+d[0]&&(O[T+b]=-O[T+b]);for(let d=S;d<I;++d)O[T+d]=-O[T+d]}}}}(z,E,A,O,B),[y(B,O),E,A]}function y(d,b){const M=2*b,O=d.length,P=new Uint8Array(4*O);for(let T=0;T<O;++T){const b=.5-d[T]/M;(0,S.U)(b,P,4*T)}return P}},87663:(d,b,M)=>{M.d(b,{c:()=>e,k:()=>i});var S=M(31714),O=M(48237),P=M(28155);const r=d=>"vertical"===d||"horizontal"===d||"cross"===d||"esriSFSCross"===d||"esriSFSVertical"===d||"esriSFSHorizontal"===d;function e(d,b,M){const S=b.style,P=(0,O.yR)(Math.ceil(M)),T=r(S)?8*P:16*P,C=2*P;d.width=T,d.height=T;const E=d.getContext("2d");E.strokeStyle="#FFFFFF",E.lineWidth=P,E.beginPath(),"vertical"!==S&&"cross"!==S&&"esriSFSCross"!==S&&"esriSFSVertical"!==S||(E.moveTo(T/2,-C),E.lineTo(T/2,T+C)),"horizontal"!==S&&"cross"!==S&&"esriSFSCross"!==S&&"esriSFSHorizontal"!==S||(E.moveTo(-C,T/2),E.lineTo(T+C,T/2)),"backward-diagonal"!==S&&"diagonal-cross"!==S&&"esriSFSDiagonalCross"!==S&&"esriSFSBackwardDiagonal"!==S||(E.moveTo(-C,-C),E.lineTo(T+C,T+C),E.moveTo(T-C,-C),E.lineTo(T+C,C),E.moveTo(-C,T-C),E.lineTo(C,T+C)),"forward-diagonal"!==S&&"diagonal-cross"!==S&&"esriSFSForwardDiagonal"!==S&&"esriSFSDiagonalCross"!==S||(E.moveTo(T+C,-C),E.lineTo(-C,T+C),E.moveTo(C,-C),E.lineTo(-C,C),E.moveTo(T+C,T-C),E.lineTo(T-C,T+C)),E.stroke();const A=E.getImageData(0,0,d.width,d.height),z=new Uint8Array(A.data);let B;for(let O=0;O<z.length;O+=4)B=z[O+3]/255,z[O]=z[O]*B,z[O+1]=z[O+1]*B,z[O+2]=z[O+2]*B;return[z,d.width,d.height,P]}function i(d,b){const M="Butt"===b,O="Square"===b,T=!M&&!O;d.length%2==1&&(d=[...d,...d]);const C=P.$,E=2*C;let A=0;for(const S of d)A+=S;const z=Math.round(A*C),B=new Float32Array(z*E),I=.5*C;let U=0,V=0,W=.5,H=!0;for(const S of d){for(U=V,V+=S*C;W<=V;){let d=.5;for(;d<E;){const b=(d-.5)*z+W-.5,S=T?(d-C)*(d-C):Math.abs(d-C);B[b]=H?M?Math.max(Math.max(U+I-W,S),Math.max(W-V+I,S)):S:T?Math.min((W-U)*(W-U)+S,(W-V)*(W-V)+S):O?Math.min(Math.max(W-U,S),Math.max(V-W,S)):Math.min(Math.max(W-U+I,S),Math.max(V+I-W,S)),d++}W++}H=!H}const q=B.length,Y=new Uint8Array(4*q);for(let P=0;P<q;++P){const d=(T?Math.sqrt(B[P]):B[P])/C;(0,S.U)(d,Y,4*P)}return[Y,z,E]}},73476:(d,b,M)=>{M.d(b,{ZH:()=>f});var S=M(58285),O=M(73905),P=(M(637),M(64032)),T=M(98824);function u(d,b){const{width:M,height:S,getFrame:P}=d,T=d.frameDurations.slice(),C=T.pop();return T.push((0,O.l5)(C+b)),{frameCount:d.frameCount,duration:d.duration+b,frameDurations:T,getFrame:P,width:M,height:S}}class h{constructor(d,b,M,S){this._animation=d,this._repeatType=M,this._onFrameData=S,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let O=0;for(;b>O;)O+=this.timeToFrame,this.nextFrame();const P=this._animation.getFrame(this._currentFrame);this._onFrameData(P)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case P.fu.None:this._currentFrame-=this._direction;break;case P.fu.Loop:this._currentFrame=0;break;case P.fu.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case P.fu.None:this._currentFrame-=this._direction;break;case P.fu.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case P.fu.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const d=this._animation.getFrame(this._currentFrame);this._onFrameData(d)}}function c(d,b,M,S){let C,{repeatType:E}=b;if(null==E&&(E=P.fu.Loop),!0===b.reverseAnimation&&(d=function o(d){const{width:b,height:M}=d,S=d.frameDurations.reverse();return{frameCount:d.frameCount,duration:d.duration,frameDurations:S,getFrame:b=>{const M=d.frameDurations.length-1-b;return d.getFrame(M)},width:b,height:M}}(d)),null!=b.duration&&(d=function s(d,b){const{width:M,height:S,getFrame:P}=d,T=b/d.duration,C=d.frameDurations.map((d=>(0,O.l5)(d*T)));return{frameCount:d.frameCount,duration:d.duration,frameDurations:C,getFrame:P,width:M,height:S}}(d,(0,O.l5)(1e3*b.duration))),null!=b.repeatDelay){const M=1e3*b.repeatDelay;E===P.fu.Loop?d=u(d,(0,O.l5)(M)):E===P.fu.Oscillate&&(d=function m(d,b){const{width:M,height:S,getFrame:P}=d,T=d.frameDurations.slice(),C=T.shift();return T.unshift((0,O.l5)(C+b)),{frameCount:d.frameCount,duration:d.duration+b,frameDurations:T,getFrame:P,width:M,height:S}}(u(d,(0,O.l5)(M/2)),(0,O.l5)(M/2)))}if(null!=b.startTimeOffset)C=(0,O.l5)(1e3*b.startTimeOffset);else if(null!=b.randomizeStartTime){const S=82749913,P=null!=b.randomizeStartSeed?b.randomizeStartSeed:S,E=(0,T.J)(M,P);C=(0,O.l5)(E*function n(d){return(0,O.l5)(d.frameDurations.reduce(((d,b)=>d+b),0))}(d))}else C=(0,O.l5)(0);return new h(d,C,E,S)}function f(d,b,M,O){const P=null==b.playAnimation||b.playAnimation,T=c(d,b,M,O);let C,E=T.timeToFrame;return function u(){C=P?setTimeout((()=>{T.nextFrame(),E=T.timeToFrame,u()}),E):void 0}(),(0,S.hA)((()=>P&&clearTimeout(C)))}},7801:(d,b,M)=>{M.r(b),M.d(b,{GraphicContainer:()=>Tt.A,GraphicsView2D:()=>Pt.A,LabelManager:()=>Ot.C,MagnifierView2D:()=>MagnifierView2D_A,MapViewNavigation:()=>Ct.A,Stage:()=>Stage_v});var S=M(4180),O=M(50886),P=M(35598),T=M(59650),C=M(82428),E=M(46427),A=M(50352),z=M(77480),B=M(66004),I=M(89412),U=M(62555),V=M(4389),W=M(8809),H=M(29354),q=M(64032),Y=M(85060),K=M(14789),J=M(3067),Q=M(17865),Z=M(80271);function N(d){const b=d.markerPlacement;return b&&b.angleToLine?q.C1.MAP:q.C1.SCREEN}class w{constructor(d){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],d&&(this._resourceManager=d)}analyzeSymbolReference(d,b,M){if(this._cimLayers=null!==M&&void 0!==M?M:[],!d)return this._cimLayers;if(this._reset(),d.primitiveOverrides){this._primitiveOverrides=d.primitiveOverrides;for(const d of this._primitiveOverrides){const b=d.valueExpressionInfo;if(b)this._setPoMap(d.primitiveName,d.propertyName,b);else if(null!=d.value){let b=d.value;d.propertyName.includes("Color")&&((0,A.IB)(b)&&(b=(0,J.G9)(b)),b=(0,J.e6)(b)),this._setPoMap(d.primitiveName,d.propertyName,b)}}}return this._analyzeSymbol(d.symbol,b),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(d,b){switch(null===d||void 0===d?void 0:d.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(d,b)}}_analyzeMultiLayerSymbol(d,b){var M;const S=null===d||void 0===d?void 0:d.symbolLayers;if(!S)return;const O=d.effects;let P=q.C1.SCREEN;const T=null!==(M=(0,J.YC)(d))&&void 0!==M?M:0;"CIMPointSymbol"===d.type&&"Map"===d.angleAlignment&&(P=q.C1.MAP);const C="CIMPolygonSymbol"===d.type;let E=S.length;for(;E--;){const M=S[E];if(!M||!1===M.enable)continue;let A;(null===O||void 0===O?void 0:O.length)&&(A=[...O]);const z=M.effects;(null===z||void 0===z?void 0:z.length)&&(O?A.push(...z):A=[...z]);let B=null;if(A){B=[];for(const d of A){const b=Y.$.findEffectOverrides(d,this._primitiveOverrides);b&&B.push(b)}}const U=[];switch(Y.$.findApplicableOverrides(M,this._primitiveOverrides,U),M.type){case"CIMSolidFill":this._analyzeSolidFill(M,B);break;case"CIMPictureFill":this._analyzePictureFill(M,B);break;case"CIMHatchFill":this._analyzeHatchFill(M,B);break;case"CIMGradientFill":this._analyzeGradientFill(M,B);break;case"CIMSolidStroke":this._analyzeSolidStroke(M,B,C,T);break;case"CIMPictureStroke":this._analyzePictureStroke(M,B,C,T);break;case"CIMGradientStroke":this._analyzeGradientStroke(M,B,C,T);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==d.type&&"CIMPolygonSymbol"!==d.type||(P=N(M));const S=[],O=M.primitiveName;O&&S.push(O);const E=C&&(0,J.zr)(M.markerPlacement);this._analyzeMarker(M,B,null,S,P,T,b,[],!1,E);break}default:I.A.getLogger("esri.symbols.cim.cimAnalyzer").error("Cannot analyze CIM layer",M.type)}}}_analyzeSolidFill(d,b){const{primitiveName:M,type:S}=d,O=(0,J.e6)(d.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!d.colorLocked,color:this._getValueOrOverrideExpression(S,M,"Color",O),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:b,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(d,b){const{primitiveName:M,type:S}=d,O=(0,J.Ny)(d),P=(0,J._W)(d.height,H.D.CIMPictureFill.height);let T=(0,J._W)(d.scaleX,1);if("width"in d&&"number"==typeof d.width){const b=d.width;let M=1;const S=this._resourceManager.getResource(d.url);null!=S&&(M=S.width/S.height),T/=M*(P/b)}const C={type:"sprite-rasterization-param",resource:d,overrides:this._getPrimitiveMaterialOverrides(M,S)};this._cimLayers.push({type:"fill",spriteRasterizationParam:C,colorLocked:!!d.colorLocked,effects:b,color:this._getValueOrOverrideExpression(S,M,"TintColor",O),height:this._getValueOrOverrideExpression(S,M,"Height",P),scaleX:this._getValueOrOverrideExpression(S,M,"ScaleX",T),angle:this._getValueOrOverrideExpression(S,M,"Rotation",(0,J._W)(d.rotation)),offsetX:this._getValueOrOverrideExpression(S,M,"OffsetX",(0,J._W)(d.offsetX)),offsetY:this._getValueOrOverrideExpression(S,M,"OffsetY",(0,J._W)(d.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(d,b){var M;const{primitiveName:S,type:O}=d,P=this._analyzeMaterialOverrides(S,["Rotation","OffsetX","OffsetY"]),T=this._normalizePrimitiveOverrideProps(P);let C=[255,255,255,1],E=!1;if(null!==(M=d.lineSymbol)&&void 0!==M&&M.symbolLayers)for(const V of d.lineSymbol.symbolLayers){var A,z,B,I;if("CIMSolidStroke"!==V.type)continue;const d=null!==(A=V.primitiveName)&&void 0!==A?A:S;E||!d||V.colorLocked||null==(null===(z=this._poMap[d])||void 0===z?void 0:z.Color)&&null==(null===(B=this._poMap[d])||void 0===B?void 0:B.StrokeColor)||(C=(0,J.e6)(V.color),C=null!==(I=this._maybeGetValueOrOverrideExpression(d,"StrokeColor"))&&void 0!==I?I:this._getValueOrOverrideExpression(O,d,"Color",C),E=!0);const b=this._maybeGetValueOrOverrideExpression(d,"StrokeWidth");if(b){let M=null,S=null;"number"==typeof b?M=b:S=b.valueExpressionInfo;let P=T.find((d=>"strokeWidth"===d.propertyName));P?P.propertyName="width":(P={type:"CIMPrimitiveOverride",primitiveName:d,propertyName:"width",valueExpressionInfo:S,value:M,defaultValue:(0,J.iA)(O,"width")},T.push(P))}}const U={type:"sprite-rasterization-param",resource:d,overrides:T};this._cimLayers.push({type:"fill",spriteRasterizationParam:U,colorLocked:!!d.colorLocked,effects:b,color:C,height:this._getValueOrOverrideExpression(O,S,"Separation",(0,J._W)(d.separation,H.D.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(O,S,"Rotation",(0,J._W)(d.rotation)),offsetX:this._getValueOrOverrideExpression(O,S,"OffsetX",(0,J._W)(d.offsetX)),offsetY:this._getValueOrOverrideExpression(O,S,"OffsetY",(0,J._W)(d.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!E})}_analyzeGradientFill(d,b){this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!d.colorLocked,effects:b,color:[128,128,128,1],height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeSolidStroke(d,b,M,S){const{primitiveName:O,type:P}=d,T=(0,J.e6)(d.color),C=(0,J._W)(d.width,H.D.CIMSolidStroke.width),E=(0,J.GV)(d.capStyle,H.D.CIMSolidStroke.capstyle),A=(0,J.GV)(d.joinStyle,H.D.CIMSolidStroke.joinstyle),z=d.miterLimit;let B,I,U=[];if(this._analyzePrimitiveOverrides(O,b,null,null)&&(U=this._getPrimitiveMaterialOverrides(O,P)),b&&b instanceof Array&&b.length>0){const d=b[b.length-1].effect;d&&"CIMGeometricEffectDashes"===d.type&&"NoConstraint"===d.lineDashEnding&&null===d.offsetAlongLine&&(B=d.dashTemplate,I=d.scaleDash,(b=[...b]).pop())}const V=void 0!==B?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:B,capStyle:E},overrides:U}:null;this._cimLayers.push({type:"line",spriteRasterizationParam:V,isOutline:M,colorLocked:!!d.colorLocked,effects:b,color:this._getValueOrOverrideExpression(P,O,"Color",T),width:this._getValueOrOverrideExpression(P,O,"Width",C),cap:this._getValueOrOverrideExpression(P,O,"CapStyle",E),join:this._getValueOrOverrideExpression(P,O,"JoinStyle",A),miterLimit:z&&this._getValueOrOverrideExpression(P,O,"MiterLimit",z),referenceWidth:S,zOrder:R(d.name),dashTemplate:B,scaleDash:I,sampleAlphaOnly:!0})}_analyzePictureStroke(d,b,M,S){const{primitiveName:O,type:P}=d,T=(0,J.Ny)(d),C=(0,J._W)(d.width,H.D.CIMPictureStroke.width),E=(0,J.GV)(d.capStyle,H.D.CIMPictureStroke.capstyle),A=(0,J.GV)(d.joinStyle,H.D.CIMPictureStroke.joinstyle),z=d.miterLimit,B={type:"sprite-rasterization-param",resource:d,overrides:this._getPrimitiveMaterialOverrides(O,P)};this._cimLayers.push({type:"line",spriteRasterizationParam:B,isOutline:M,colorLocked:!!d.colorLocked,effects:b,color:this._getValueOrOverrideExpression(P,O,"TintColor",T),width:this._getValueOrOverrideExpression(P,O,"Width",C),cap:this._getValueOrOverrideExpression(P,O,"CapStyle",E),join:this._getValueOrOverrideExpression(P,O,"JoinStyle",A),miterLimit:z&&this._getValueOrOverrideExpression(P,O,"MiterLimit",z),referenceWidth:S,zOrder:R(d.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(d,b,M,S){const{primitiveName:O,type:P}=d,T=(0,J._W)(d.width,H.D.CIMSolidStroke.width),C=(0,J.GV)(d.capStyle,H.D.CIMGradientStroke.capstyle),E=(0,J.GV)(d.joinStyle,H.D.CIMGradientStroke.joinstyle),A=d.miterLimit;this._cimLayers.push({type:"line",spriteRasterizationParam:null,isOutline:M,colorLocked:!!d.colorLocked,effects:b,color:[128,128,128,1],width:this._getValueOrOverrideExpression(P,O,"Width",T),cap:this._getValueOrOverrideExpression(P,O,"CapStyle",C),join:this._getValueOrOverrideExpression(P,O,"JoinStyle",E),miterLimit:A&&this._getValueOrOverrideExpression(P,O,"MiterLimit",A),referenceWidth:S,zOrder:R(d.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(d,b,M,S,O,P,T,C){let E=arguments.length>8&&void 0!==arguments[8]&&arguments[8],A=arguments.length>9&&void 0!==arguments[9]&&arguments[9];if(E||(E=!!d.colorLocked),this._analyzeMarkerInsidePolygon(d,b,E))return;const z=(0,J._W)(d.size,H.D.CIMVectorMarker.size),B=(0,J._W)(d.rotation),I=(0,J._W)(d.offsetX),U=(0,J._W)(d.offsetY),{primitiveName:V,type:W}=d,q=this._getValueOrOverrideExpression(W,V,"Size",z),Y=this._getValueOrOverrideExpression(W,V,"Rotation",B),K=this._getValueOrOverrideExpression(W,V,"OffsetX",I),Q=this._getValueOrOverrideExpression(W,V,"OffsetY",U);switch(d.type){case"CIMPictureMarker":this._analyzePictureMarker(d,b,M,S,O,P,q,Y,K,Q,C,E,A);break;case"CIMVectorMarker":this._analyzeVectorMarker(d,b,M,S,O,P,q,Y,K,Q,C,T,E,A)}}_analyzeMarkerInsidePolygon(d,b,M){const{markerPlacement:S,type:O}=d;if(!S||"CIMMarkerPlacementInsidePolygon"!==S.type)return!1;if("CIMVectorMarker"===O||"CIMPictureMarker"===O){const M=d.primitiveName;if(M&&this._analyzePrimitiveOverrides([M],b,null,null))return!1;const P=S.primitiveName;if(P&&this._analyzePrimitiveOverrides([P],b,null,null))return!1;if("CIMVectorMarker"===O){const{markerGraphics:b}=d;if(b)for(const d of b){const{symbol:b}=d;if("CIMPolygonSymbol"===(null===b||void 0===b?void 0:b.type)&&b.symbolLayers){const{symbolLayers:d}=b;for(const b of d)if("CIMSolidStroke"===b.type)return!1}}}else{const{animatedSymbolProperties:b}=d;if(b)return!1}}const P=Math.abs(S.stepX),T=Math.abs(S.stepY);if(0===P||0===T)return!0;let C,E;if("Random"===S.gridType){const d=(0,U.PN)(Z.yv),b=Math.max(Math.floor(d/P),1);C=T*Math.max(Math.floor(d/T),1),E=b*P/C}else S.shiftOddRows?(C=2*T,E=P/T*.5):(C=T,E=P/T);const A=(0,J.Ny)(d),z="CIMCharacterMarker"===d.type?null:{type:"sprite-rasterization-param",resource:d,overrides:[]};return this._cimLayers.push({type:"fill",spriteRasterizationParam:z,colorLocked:M,effects:b,color:A,height:C,scaleX:E,angle:S.gridAngle,offsetX:(0,J._W)(S.offsetX),offsetY:(0,J._W)(S.offsetY),applyRandomOffset:"Random"===S.gridType,sampleAlphaOnly:"CIMPictureMarker"!==d.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(d,b,M,S,O,P,T,C,E,A,z,I,U){var W,H,q,Y,K,Q,Z,ee,te;const{primitiveName:ie,type:re}=d;let se=(0,J._W)(d.scaleX,1);const ae=(0,J.Ny)(d);M||(M=this._createMarkerPlacementOverrideExpression(d.markerPlacement));const ne=this._createAnimatedSymbolPropertiesOverrideExpression(d.animatedSymbolProperties),oe=null!==(W=d.anchorPoint)&&void 0!==W?W:{x:0,y:0};if("width"in d&&"number"==typeof d.width){const b=d.width;let M=1;const S=this._resourceManager.getResource(d.url);null!=S&&(M=S.width/S.height),se/=M*((0,J._W)(d.size)/b)}const le=[...S];let he;d.primitiveName&&le.push(d.primitiveName),d.animatedSymbolProperties||ne?he={type:"animated",url:d.url,urlHash:"H"+(0,V.Wm)(d.url),playAnimation:null===(H=d.animatedSymbolProperties)||void 0===H?void 0:H.playAnimation,reverseAnimation:null===(q=d.animatedSymbolProperties)||void 0===q?void 0:q.reverseAnimation,randomizeStartTime:null===(Y=d.animatedSymbolProperties)||void 0===Y?void 0:Y.randomizeStartTime,randomizeStartSeed:null===(K=d.animatedSymbolProperties)||void 0===K?void 0:K.randomizeStartSeed,startTimeOffset:null===(Q=d.animatedSymbolProperties)||void 0===Q?void 0:Q.startTimeOffset,duration:null===(Z=d.animatedSymbolProperties)||void 0===Z?void 0:Z.duration,repeatType:null===(ee=d.animatedSymbolProperties)||void 0===ee?void 0:ee.repeatType,repeatDelay:null===(te=d.animatedSymbolProperties)||void 0===te?void 0:te.repeatDelay}:(he=(0,B.o8)(d),he.markerPlacement=null);const ce={type:"sprite-rasterization-param",resource:he,overrides:this._getMaterialOverrides(le,re)};ne&&ce.overrides.push(...ne.overrides),this._cimLayers.push({type:"marker",spriteRasterizationParam:ce,colorLocked:I,effects:b,scaleSymbolsProportionally:!1,alignment:O,size:T,scaleX:this._getValueOrOverrideExpression(re,ie,"ScaleX",se),rotation:C,offsetX:E,offsetY:A,transform:{type:"cim-marker-transform-param",params:z},color:this._getValueOrOverrideExpression(re,ie,"TintColor",ae),anchorPoint:{x:oe.x,y:oe.y},isAbsoluteAnchorPoint:"Relative"!==d.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!d.rotateClockwise,referenceSize:P,sizeRatio:1,isOutline:U,markerPlacement:M,animatedSymbolProperties:ne})}_analyzeVectorMarker(d,b,M,S,O,P,T,C,E,A,z,B,I,U){var V,W,H;const q=d.markerGraphics;if(!q)return;const Y=d.frame;let K=0;if(K=Y?Y.ymax-Y.ymin:P,K){const b={offsetX:E,offsetY:A,rotation:C,size:T,frameHeight:K,rotateClockWise:!!d.rotateClockwise};z=[...z,b]}M||(M=this._createMarkerPlacementOverrideExpression(d.markerPlacement));for(const J of q)if(J){const T=J.symbol;if(!T)continue;const C=J.primitiveName;let E;if(C&&S.push(C),("CIMPointSymbol"===T.type||"CIMTextSymbol"===T.type)&&Y){let b=0,M=0;const S=J.geometry;"x"in S&&"y"in S&&(b+=S.x-.5*(Y.xmin+Y.xmax),M+=S.y-.5*(Y.ymin+Y.ymax));const O=d.anchorPoint;O&&("Absolute"===d.anchorPointUnits?(b-=O.x,M-=O.y):Y&&(b-=(Y.xmax-Y.xmin)*O.x,M-=(Y.ymax-Y.ymin)*O.y));const P={offsetX:b,offsetY:M,rotation:0,size:0,frameHeight:0,rotateClockWise:!1};E=[...z,P]}switch(T.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":B||X(T)?this._analyzeMultiLayerGraphicNonSDF(d,b,M,null,J,S,O,P,null!==(V=E)&&void 0!==V?V:z,K,I,U):this._analyzeMultiLayerGraphic(d,b,M,null,J,S,O,P,null!==(W=E)&&void 0!==W?W:z,K,I,U);break;case"CIMTextSymbol":this._analyzeTextGraphic(b,M,J,S,O,P,null!==(H=E)&&void 0!==H?H:z,I)}C&&S.pop()}}_analyzeMultiLayerGraphic(d,b,M,S,O,P,T,C,E,A,z,B){const I=O.symbol,U=I.symbolLayers;if(!U)return;let V=U.length;if(G(U))return void this._analyzeCompositeMarkerGraphic(d,b,M,S,O,U,T,C,E,A,z,B);const W=this._resourceManager.geometryEngine,H=Q.V.applyEffects(I.effects,O.geometry,W);if(H)for(;V--;){const I=U[V];if(!I||!1===I.enable)continue;const te=I.primitiveName;switch(te&&P.push(te),I.type){case"CIMSolidFill":case"CIMSolidStroke":{var q,Y,Z,ee;const P=Q.V.applyEffects(I.effects,H,W),U=(0,K.Z7)(P);if(!U)continue;const V="Relative"!==d.anchorPointUnits,[ie,re,se,ae]=(0,K.Fj)(U,d.frame,d.size,d.anchorPoint,V),ne="CIMSolidFill"===I.type,oe={type:"sdf",geom:P,asFill:ne},{path:le}=I,he=ne?(0,J.e6)((0,J.pM)(I)):null==le?(0,J.e6)((0,J._1)(I)):[0,0,0,0],ce=ne?[0,0,0,0]:(0,J.e6)((0,J._1)(I)),ue=null!==(q=(0,J.xo)(I))&&void 0!==q?q:0;if(!ne&&!ue)break;const de=O.primitiveName;let _e=null;ne&&!I.colorLocked&&(_e=this._maybeGetValueOrOverrideExpression(de,"FillColor"));let pe=null;ne||I.colorLocked||(pe=this._maybeGetValueOrOverrideExpression(de,"StrokeColor"));const me=null!==(Y=_e)&&void 0!==Y?Y:this._getValueOrOverrideExpression(I.type,te,"Color",he),fe=null!==(Z=pe)&&void 0!==Z?Z:this._getValueOrOverrideExpression(I.type,te,"Color",ce),ge=null!==(ee=this._maybeGetValueOrOverrideExpression(de,"StrokeWidth"))&&void 0!==ee?ee:this._getValueOrOverrideExpression(I.type,te,"Width",ue),ve=le?{type:"sprite-rasterization-param",resource:{type:"path",path:le,asFill:ne},overrides:[]}:{type:"sprite-rasterization-param",resource:oe,overrides:[]};this._cimLayers.push({type:"marker",spriteRasterizationParam:ve,colorLocked:!!I.colorLocked||!!z,effects:b,scaleSymbolsProportionally:!!d.scaleSymbolsProportionally,alignment:T,anchorPoint:{x:re,y:se},isAbsoluteAnchorPoint:V,size:A,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:E},frameHeight:A,widthRatio:ae,rotateClockwise:!1,referenceSize:C,sizeRatio:ie,color:me,outlineColor:fe,outlineWidth:ge,isOutline:B,markerPlacement:M,animatedSymbolProperties:S});break}case"CIMPictureMarker":case"CIMVectorMarker":I.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(d,b,M,S,O,P,T,C,E,A,!!I.colorLocked||!!z,B):this._analyzeMarker(I,b,M,P,T,C,!1,E,z,B);break;default:this._analyzeMultiLayerGraphicNonSDF(d,b,M,S,O,P,T,C,E,A,!!I.colorLocked||!!z,B)}te&&P.pop()}}_analyzeTextGraphic(d,b,M,S,O,P,T,C){var E,A,B,I,U;Y.$.findApplicableOverrides(M,this._primitiveOverrides,[]);const V=M.geometry;if(!("x"in V)||!("y"in V))return;const W=M.symbol,q=(0,J.DW)(W),K=(0,J._d)(W.fontStyleName),Q=(0,z.af)(W.fontFamilyName);W.font={family:Q,decoration:q,...K};const Z=(0,J._W)(W.height,H.D.CIMTextSymbol.height),ee=(0,J._W)(W.angle),te=(0,J._W)(W.offsetX),ie=(0,J._W)(W.offsetY),re=(0,J.e6)((0,J.pM)(W));let se=(0,J.e6)((0,J._1)(W)),ae=null!==(E=(0,J.xo)(W))&&void 0!==E?E:0;ae||(se=(0,J.e6)((0,J.pM)(W.haloSymbol)),ae=(0,J._W)(W.haloSize));let ne=!1;if(null!==(A=W.symbol)&&void 0!==A&&A.symbolLayers)for(const z of W.symbol.symbolLayers)null!=(0,J.e6)((0,J.pM)(z))&&(ne=!!z.colorLocked);const oe=M.primitiveName;let le=null;ne||(le=this._maybeGetValueOrOverrideExpression(oe,"FillColor"));const he=this._maybeGetValueOrOverrideExpression(oe,"TextSize"),ce=this._maybeGetValueOrOverrideExpression(oe,"TextAngle"),ue=this._maybeGetValueOrOverrideExpression(oe,"TextOffsetX"),de=this._maybeGetValueOrOverrideExpression(oe,"TextOffsetY");let _e=null,pe=null,me=0;if(W.callout&&"CIMBackgroundCallout"===W.callout.type){const d=W.callout;if(d.backgroundSymbol){const b=d.backgroundSymbol.symbolLayers;if(b)for(const d of b)"CIMSolidFill"===d.type?_e=(0,J.e6)(d.color):"CIMSolidStroke"===d.type&&(pe=(0,J.e6)(d.color),me=(0,J._W)(d.width,H.D.CIMSolidStroke.width))}}const fe=this._getValueOrOverrideExpression(W.type,M.primitiveName,"TextString",null!==(B=M.textString)&&void 0!==B?B:"");if(null==fe)return;const{fontStyleName:ge}=W,ve=Q+(ge?"-"+ge.toLowerCase():"-regular"),ye=this._getMaterialOverrides(S,W.type);ye.push(...this._getPrimitiveMaterialOverrides(M.primitiveName,W.type));const be={type:"text-rasterization-param",resource:{type:"text",textString:null!==(I=M.textString)&&void 0!==I?I:"",font:W.font,symbol:W,primitiveName:M.primitiveName},overrides:ye};this._cimLayers.push({type:"text",lineWidth:null,textRasterizationParam:be,colorLocked:!!C||!!ne,effects:d,alignment:O,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:ve,decoration:q,weight:K.weight,style:K.style,size:null!==he&&void 0!==he?he:Z,angle:null!==ce&&void 0!==ce?ce:ee,offsetX:null!==ue&&void 0!==ue?ue:te,offsetY:null!==de&&void 0!==de?de:ie,transform:{type:"cim-marker-transform-param",params:T},horizontalAlignment:(0,J.Bu)(W.horizontalAlignment),verticalAlignment:(0,J.Nl)(W.verticalAlignment),text:fe,color:null!==(U=le)&&void 0!==U?U:this._getValueOrOverrideExpression(W.type,M.primitiveName,"Color",re),outlineColor:se,outlineSize:ae,backgroundColor:_e,borderLineColor:pe,borderLineWidth:me,referenceSize:P,sizeRatio:1,markerPlacement:b})}_analyzeMultiLayerGraphicNonSDF(d,b,M,S,O,P,T,C,E,A,z,B){const I=this._buildSimpleMarker(d,O),V=d.primitiveName,H=this._analyzeMaterialOverrides(V,["Rotation","OffsetX","OffsetY"]),q=this._normalizePrimitiveOverrideProps(H),[Y,K,J]=W.wp.getTextureAnchor(I,this._resourceManager),Q=this._getMaterialOverrides(P,d.type);Q.push(...q);const Z={type:"sprite-rasterization-param",resource:{...I,avoidSDFRasterization:!0},overrides:Q};this._cimLayers.push({type:"marker",spriteRasterizationParam:Z,colorLocked:z,effects:b,scaleSymbolsProportionally:!!d.scaleSymbolsProportionally,alignment:T,anchorPoint:{x:Y,y:K},isAbsoluteAnchorPoint:!1,size:A,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:E},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:A,widthRatio:1,rotateClockwise:!!d.rotateClockwise,referenceSize:C,sizeRatio:J/(0,U.Lz)(d.size),isOutline:B,markerPlacement:M,animatedSymbolProperties:S})}_createMarkerPlacementOverrideExpression(d){if(!d)return null;const b=[];return Y.$.findApplicableOverrides(d,this._primitiveOverrides,b),{type:"cim-marker-placement-info",placement:d,overrides:F(b)}}_createAnimatedSymbolPropertiesOverrideExpression(d){if(!d)return null;const b=[];return Y.$.findApplicableOverrides(d,this._primitiveOverrides,b),{type:"cim-animation-info",animation:d,overrides:F(b)}}_buildSimpleMarker(d,b){return{type:d.type,enable:!0,name:d.name,colorLocked:d.colorLocked,primitiveName:d.primitiveName,anchorPoint:d.anchorPoint,anchorPointUnits:d.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:d.rotateClockwise,rotation:0,size:d.size,billboardMode3D:d.billboardMode3D,depth3D:d.depth3D,frame:d.frame,markerGraphics:[b],scaleSymbolsProportionally:d.scaleSymbolsProportionally,respectFrame:d.respectFrame,clippingPath:d.clippingPath}}_analyzeCompositeMarkerGraphic(d,b,M,S,O,P,T,C,E,A,z,B){var I,U,V;const W=O.geometry,q=P[0],Y=P[1],Q=(0,K.Z7)(W);if(!Q)return;const Z="Relative"!==d.anchorPointUnits,[ee,te,ie,re]=(0,K.Fj)(Q,d.frame,d.size,d.anchorPoint,Z),{path:se}=Y,ae=Y.primitiveName,ne=q.primitiveName,oe=O.primitiveName;let le=null;Y.colorLocked||z||(le=this._maybeGetValueOrOverrideExpression(oe,"FillColor"));const he=null!==(I=le)&&void 0!==I?I:this._getValueOrOverrideExpression(Y.type,ae,"Color",(0,J.e6)(Y.color));let ce=null;q.colorLocked||z||(ce=this._maybeGetValueOrOverrideExpression(oe,"StrokeColor"));const ue=null!==(U=ce)&&void 0!==U?U:this._getValueOrOverrideExpression(q.type,ne,"Color",(0,J.e6)(q.color)),de=null!==(V=this._maybeGetValueOrOverrideExpression(oe,"StrokeWidth"))&&void 0!==V?V:this._getValueOrOverrideExpression(q.type,ne,"Width",(0,J._W)(q.width,H.D.CIMSolidStroke.width)),_e={type:"sprite-rasterization-param",resource:se?{type:"path",path:se,asFill:!0}:{type:"sdf",geom:W,asFill:!0},overrides:[]};this._cimLayers.push({type:"marker",spriteRasterizationParam:_e,colorLocked:z,effects:b,scaleSymbolsProportionally:!!d.scaleSymbolsProportionally,alignment:T,anchorPoint:{x:te,y:ie},isAbsoluteAnchorPoint:Z,size:A,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:E},frameHeight:A,widthRatio:re,rotateClockwise:!1,referenceSize:C,sizeRatio:ee,color:he,outlineColor:ue,outlineWidth:de,isOutline:B,markerPlacement:M,animatedSymbolProperties:S})}_setPoMap(d,b,M){let S;this._poMap[d]?S=this._poMap[d]:(S={},this._poMap[d]=S),S[b]=M}_maybeGetValueOrOverrideExpression(d,b,M){return this._getValueOrOverrideExpression("",d,b,M,!1)}_getValueOrOverrideExpression(d,b,M,S){if((!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!(0,J.ZO)(S)&&(S=(0,J.iA)(d,M.toLowerCase())),null==b)return S;const O=this._poMap[b];if(null==O)return S;const P=O[M];return"string"==typeof P||"number"==typeof P||Array.isArray(P)?P:P?{valueExpressionInfo:P,defaultValue:S}:S}_analyzePrimitiveOverrides(d,b,M,S){if(null==d)return!1;"string"==typeof d&&(d=[d]);for(const O of this._primitiveOverrides)if(d.includes(O.primitiveName)&&O.valueExpressionInfo)return!0;if(null!=b)for(const O of b)if((null===O||void 0===O?void 0:O.overrides.length)>0)return!0;if(null!=M)for(const O of M)if((null===O||void 0===O?void 0:O.overrides.length)>0)return!0;if(null!=S)for(const O of S)if((null===O||void 0===O?void 0:O.overrides.length)>0)return!0;return!1}_getMaterialOverrides(d,b){if(!d)return[];const M=[];for(const S of d)M.push(...this._getPrimitiveMaterialOverrides(S,b));return M}_getPrimitiveMaterialOverrides(d,b){if(!d)return[];const M=this._normalizePrimitiveOverrideProps(this._primitiveOverrides.filter((b=>b.primitiveName===d)));return M.forEach((d=>d.defaultValue=(0,J.iA)(b,d.propertyName.toLowerCase()))),M}_analyzeMaterialOverrides(d,b){return this._primitiveOverrides.filter((M=>M.primitiveName!==d||!b.includes(M.propertyName)))}_normalizePrimitiveOverrideProps(d){return d.map((d=>({...d,propertyName:(0,J.YF)(d.propertyName)})))}}function R(d){if(d&&0===d.indexOf("Level_")){const b=parseInt(d.substr(6),10);if(!isNaN(b))return b}return 0}const G=d=>d&&2===d.length&&d[0].enable&&d[1].enable&&"CIMSolidStroke"===d[0].type&&"CIMSolidFill"===d[1].type&&null==d[0].path&&null==d[1].path&&!d[0].effects&&!d[1].effects;function X(d){const b=d.symbolLayers;if(!b||2!==b.length)return!1;const M=b.find((d=>{var b;return null===(b=d.effects)||void 0===b?void 0:b.find((d=>"CIMGeometricEffectDashes"===d.type&&null!=d.dashTemplate))})),S=b.find((d=>{var b;return null===(b=d.effects)||void 0===b?void 0:b.find((d=>"CIMGeometricEffectAddControlPoints"===d.type))}));return!!M||!!S}function F(d){return(0,B.o8)(d).map((d=>({...d,propertyName:(0,J.YF)(d.propertyName)})))}var ee=M(5528),te=M(73067),ie=M(1045),re=M(58285),se=M(48237),ae=M(22815),ne=M(86089),oe=M(99647);class l{constructor(d){this.events=new te.A,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");const b={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0};d.appendChild(this._canvas);let M=(0,oe.q)(this._canvas,b);M||(M=(0,oe.q)(this._canvas,{...b,failIfMajorPerformanceCaveat:!1}),this._hasMajorPerformanceCaveat=!0),this._gl=M,this._handles=(0,re.vE)([(0,ie.on)(this._canvas,"webglcontextlost",(d=>this.events.emit("webgl-context-lost",d)))])}destroy(){var d;null!==(d=this._canvas.parentNode)&&void 0!==d&&d.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}get gl(){return this._gl}render(d,b){if(this._hasMajorPerformanceCaveat||(0,O.A)("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=(0,O.A)("esri-performance-mode-frames-between-render")&&(b(),this._lastRenderViewState=d.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){const[b,M,S,O,P,T]=this._computeViewTransform(this._lastRenderViewState,d.state);this._canvas.style.transform="matrix(".concat(b,", ").concat(M,", ").concat(S,", ").concat(O,", ").concat(P,", ").concat(T,")")}}else b()}resize(d){const b=this._canvas,M=b.style,{state:{size:S},pixelRatio:O}=d,P=S[0],T=S[1],C=Math.round(P*O),E=Math.round(T*O);b.width===C&&b.height===E||(b.width=C,b.height=E),M.width=P+"px",M.height=T+"px"}_computeViewTransform(d,b){const[M,S]=d.center,[O,P]=b.center,[T,C]=d.toScreen([0,0],O,P),[E,A]=d.toScreen([0,0],M,S),z=E-T,B=A-C,I=d.scale/b.scale,U=b.rotation-d.rotation,V=(0,ne.vt)();return(0,ae.D_)(V),(0,ae.hs)(V,V,[I,I]),(0,ae.e$)(V,V,(0,se.kU)(U)),(0,ae.Tl)(V,V,[z,B]),V}}var le=M(21847),he=M(82262),ce=M(89766);const ue={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform lowp sampler2D u_texture;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\nvoid main() {\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = u_opacity * color;\n#else\ngl_FragColor = u_color;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\nuniform mediump vec4 u_tlbr;\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\n#endif\nvoid main() {\ngl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\nv_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\nv_tlbr             = u_tlbr / u_mosaicSize.xyxy;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nvoid main()\n{\nmediump float dist = length(v_offset);\nmediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\nlowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\ngl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_stroke_color = stroke_color * stroke_opacity;\nv_stroke_width = stroke_width;\nv_radius = radius;\nv_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\nmediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\nv_offset = offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\nmediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\nmediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);\nlowp vec4 color = texture2D(u_texture, samplePos);\ngl_FragColor = v_color[3] * color;\n#else\ngl_FragColor = v_color;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\n#include <util/util.glsl>\nuniform mediump vec2 u_mosaicSize;\nuniform mediump float u_patternFactor;\nvarying mediump vec2 v_tileTextureCoord;\nvarying mediump vec4 v_tlbr;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\n#ifdef PATTERN\nfloat patternWidth = nextPOT(tlbr.z - tlbr.x);\nfloat patternHeight = nextPOT(tlbr.w - tlbr.y);\nfloat scaleX = 1.0 / (patternWidth * u_patternFactor);\nfloat scaleY = 1.0 / (patternHeight * u_patternFactor);\nmat3 patterMat = mat3(scaleX, 0.0,    0.0,\n0.0,    -scaleY, 0.0,\n0.0,    0.0,    1.0);\nv_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;\nv_tlbr             = tlbr / u_mosaicSize.xyxy;\n#endif\nvec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\nfloat compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\nvec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\nreturn vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\nlowp vec4 fillPixelColor = v_color;\nfloat d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\nconst float softEdgeRatio = 0.248062016;\nfloat size = max(v_size.x, v_size.y);\nfloat dist = d * softEdgeRatio * size;\nfillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\nif (v_halo_width > 0.25) {\nlowp vec4 outlinePixelColor = u_outlineColor;\nconst float outlineLimitRatio = (16.0 / 86.0);\nfloat clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\noutlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\ngl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n}\nelse {\ngl_FragColor = v_opacity * fillPixelColor;\n}\n#else\nlowp vec4 texColor = texture2D(u_texture, v_tex);\ngl_FragColor = v_opacity * texColor;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nv_color = color;\nv_opacity = opacity;\n#ifdef SDF\nv_halo_width = halo_width;\n#endif\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_opacity *= interpolatedOpacity;\nmediump float a_angle         = a_levelInfo[1];\nmediump float a_minLevel      = a_levelInfo[2];\nmediump float a_maxLevel      = a_levelInfo[3];\nmediump vec2 a_tex            = a_texAngleRange.xy;\nmediump float delta_z = 0.0;\nmediump float rotated = mod(a_angle + u_mapRotation, 256.0);\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_opacity, 0.0);\nvec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\nv_size = abs(offset);\n#ifdef SDF\noffset = (120.0 / 86.0) * offset;\n#endif\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\nv_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"precision lowp float;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#if defined (PATTERN) || defined(SDF)\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\nuniform sampler2D u_texture;\nuniform mediump float u_antialiasing;\n#endif\n#ifdef SDF\n#include <util/encoding.glsl>\n#endif\nvoid main()\n{\nmediump float fragDist = length(v_normal) * v_lineHalfWidth;\nlowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\nmediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nlowp vec4 color = texture2D(u_texture, texCoord);\ngl_FragColor = alpha * v_color[3] * color;\n#elif defined(SDF)\nmediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));\nmediump float relativeTexY =  0.5 + 0.25 * v_normal.y;\nmediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));\nmediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;\nfloat dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);\ngl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;\n#else\ngl_FragColor = alpha * v_color;\n#endif\n}","line.vert":"precision mediump float;\nattribute vec2 a_pos;\nattribute vec4 a_extrude_offset;\nattribute vec4 a_dir_normal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump float u_zoomFactor;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\nconst mediump float tileCoordRatio = 8.0;\n#if defined (SDF)\nconst mediump float sdfPatternHalfWidth = 15.5;\n#endif\n#if defined (PATTERN) || defined(SDF)\nuniform mediump vec2 u_mosaicSize;\nvarying mediump vec4 v_tlbr;\nvarying mediump vec2 v_patternSize;\nvarying mediump float v_widthRatio;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_blur = blur + u_antialiasing;\nv_normal = a_dir_normal.zw * scale;\n#if defined (PATTERN) || defined(SDF)\nv_tlbr          = tlbr / u_mosaicSize.xyxy;\nv_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);\n#if defined (PATTERN)\nv_widthRatio = width / v_patternSize.y;\n#else\nv_widthRatio = width / sdfPatternHalfWidth / 2.0;\n#endif\n#endif\nv_lineHalfWidth = (width + u_antialiasing) * 0.5;\nmediump vec2 dir = a_dir_normal.xy * scale;\nmediump vec2 offset_ = a_extrude_offset.zw * scale * offset;\nmediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n#if defined (PATTERN) || defined(SDF)\nv_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);\n#endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\nvoid main()\n{\nlowp float dist = abs(v_normal.y);\nlowp float alpha = smoothstep(1.0, 0.0, dist);\ngl_FragColor = alpha * v_color;\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\nv_color = color * opacity;\nv_normal = a_xnormal;\nmediump vec2 dist = u_outline_width * scale * a_offset;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\nvoid main()\n{\nlowp float dist = texture2D(u_texture, v_tex).a;\nmediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\ngl_FragColor = alpha * v_color;\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\nif (u_halo > 0.5)\n{\nv_color = halo_color * opacity;\nhalo_width *= sdfPixel;\nhalo_blur *= sdfPixel;\n}\nelse\n{\nv_color = color * opacity;\nhalo_width = 0.0;\nhalo_blur = 0.0;\n}\nfloat modded = mod(a_opacityInfo, 128.0);\nfloat targetOpacity = (a_opacityInfo - modded) / 128.0;\nfloat startOpacity = modded / 127.0;\nfloat interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\nv_color *= interpolatedOpacity;\nmediump float a_angle       = a_levelInfo[1];\nmediump float a_minLevel    = a_levelInfo[2];\nmediump float a_maxLevel    = a_levelInfo[3];\nmediump vec2 a_tex          = a_texAngleRange.xy;\nmediump float a_visMinAngle    = a_texAngleRange.z;\nmediump float a_visMaxAngle    = a_texAngleRange.w;\nmediump float delta_z = 0.0;\nmediump float angle = mod(a_angle + u_mapRotation, 256.0);\nif (a_visMinAngle < a_visMaxAngle)\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n}\nelse\n{\ndelta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n}\ndelta_z += 1.0 - step(a_minLevel, u_level);\ndelta_z += step(a_maxLevel, u_level);\ndelta_z += step(v_color[3], 0.0);\nv_tex = a_tex.xy / u_mosaicSize;\nv_edgeDistance = edgePos - halo_width / size;\nv_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\nmediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\ngl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n255.0 / (256.0),\n255.0 / (256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0),\n255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n);\nfloat rgba2float(vec4 rgba) {\nreturn dot(rgba, rgba2float_factors);\n}","util.glsl":"float nextPOT(in float x) {\nreturn pow(2.0, ceil(log2(abs(x))));\n}"}};const de=new(M(2107).Z)((function o(d){let b=ue;return d.split("/").forEach((d=>{b&&(b=b[d])})),b}));function n(d){return de.resolveIncludes(d)}var _e=M(48750);const Programs_t=d=>(0,_e.I)({PATTERN:d.pattern}),pe={shaders:d=>({vertexShader:Programs_t(d)+n("background/background.vert"),fragmentShader:Programs_t(d)+n("background/background.frag")})},me={shaders:d=>({vertexShader:n("circle/circle.vert"),fragmentShader:n("circle/circle.frag")})},Programs_n=d=>(0,_e.I)({PATTERN:d.pattern}),fe={shaders:d=>({vertexShader:Programs_n(d)+n("fill/fill.vert"),fragmentShader:Programs_n(d)+n("fill/fill.frag")})},ge={shaders:d=>({vertexShader:n("outline/outline.vert"),fragmentShader:n("outline/outline.frag")})},s=d=>(0,_e.I)({SDF:d.sdf}),ve={shaders:d=>({vertexShader:s(d)+n("icon/icon.vert"),fragmentShader:s(d)+n("icon/icon.frag")})},h=d=>(0,_e.I)({PATTERN:d.pattern,SDF:d.sdf}),ye={shaders:d=>({vertexShader:h(d)+n("line/line.vert"),fragmentShader:h(d)+n("line/line.frag")})},be={shaders:d=>({vertexShader:n("text/text.vert"),fragmentShader:n("text/text.frag")})};class p{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach((d=>d.dispose())),this._programByKey.clear()}getMaterialProgram(d,b,M){const S=b.key<<3|this._getMaterialOptionsValue(b.type,M);if(this._programByKey.has(S))return this._programByKey.get(S);const O=this._getProgramTemplate(b.type),{shaders:P}=O,{vertexShader:T,fragmentShader:C}=P(M),E=b.getShaderHeader(),A=b.getShaderMain(),z=T.replace("#pragma header",E).replace("#pragma main",A),B=d.programCache.acquire(z,C,b.getAttributeLocations());return this._programByKey.set(S,B),B}_getMaterialOptionsValue(d,b){switch(d){case ce.kh.BACKGROUND:case ce.kh.FILL:return(b.pattern?1:0)<<1;case ce.kh.OUTLINE:return 0;case ce.kh.LINE:{const d=b;return(d.sdf?1:0)<<2|(d.pattern?1:0)<<1}case ce.kh.ICON:return(b.sdf?1:0)<<1;case ce.kh.CIRCLE:case ce.kh.TEXT:default:return 0}}_getProgramTemplate(d){switch(d){case ce.kh.BACKGROUND:return pe;case ce.kh.CIRCLE:return me;case ce.kh.FILL:return fe;case ce.kh.ICON:return ve;case ce.kh.LINE:return ye;case ce.kh.OUTLINE:return ge;case ce.kh.TEXT:return be;default:return null}}}var we=M(40449),xe=M(22677),Me=M(25078),Se=M(60985),Oe=M(16285),Pe=M(77127);class _{constructor(){this._initialized=!1}dispose(){this._program=(0,P.WD)(this._program),this._vertexArrayObject=(0,P.WD)(this._vertexArrayObject)}render(d,b,M,S){d&&(this._initialized||this._initialize(d),d.setBlendFunctionSeparate(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA,Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),d.bindVAO(this._vertexArrayObject),d.useProgram(this._program),b.setSamplingMode(M),d.bindTexture(b,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",S),d.drawArrays(Se.WR.TRIANGLE_STRIP,0,4),d.bindTexture(null,0),d.bindVAO())}_initialize(d){if(this._initialized)return!0;const b=(0,Oe.r)(d,xe.J);if(!b)return!1;const M=new Int8Array(16);M[0]=-1,M[1]=-1,M[2]=0,M[3]=0,M[4]=1,M[5]=-1,M[6]=1,M[7]=0,M[8]=-1,M[9]=1,M[10]=0,M[11]=1,M[12]=1,M[13]=1,M[14]=1,M[15]=1;const S=xe.J.attributes,O=new Pe.Z(d,S,we.oI,{geometry:Me.g.createVertex(d,Se._U.STATIC_DRAW,M)});return this._program=b,this._vertexArrayObject=O,this._initialized=!0,!0}}var Te=M(19070);class MaterialManager_e{constructor(d){this._rctx=d,this._programByKey=new Map}dispose(){this._programByKey.forEach((d=>d.dispose())),this._programByKey.clear()}getProgram(d){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const M=d.vsPath+"."+d.fsPath+JSON.stringify(b);if(this._programByKey.has(M))return this._programByKey.get(M);const S={...b.map((d=>"string"==typeof d?{name:d,value:!0}:d)).reduce(((d,b)=>({...d,[b.name]:b.value})),{})},{vsPath:O,fsPath:P,attributes:T}=d,C=(0,Te.p)(O,P,T,S),E=this._rctx.programCache.acquire(C.shaders.vertexShader,C.shaders.fragmentShader,C.attributes);if(!E)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(M,E),E}}var Ce=M(61272),Fe=M(53705),Re=M(90301),Ee=M(81618),Ae=M(85914),ze=M(87663),ke=M(29470);class Rasterizer_c{constructor(d){this._resourceManager=d,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(d,b){switch(d.type){case"dash":{const b=d.dashTemplate,M=d.capStyle,[S,O,P]=(0,ze.k)(b,M);return{size:[O,P],image:new Uint32Array(S.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[M,S,O,P]=(0,ze.c)(this._canvas,d,b);return{size:[S,O],image:new Uint32Array(M.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:P}}case"sdf":return this._rasterizeSDFInfo(d);case"CIMHatchFill":case"CIMVectorMarker":case"CIMPictureMarker":return this._rasterizeCIMJSONResource(d,b)}}_rasterizeCIMJSONResource(d,b){switch(d.type){case"CIMHatchFill":{const M=W.wp.fromCIMHatchFill(d,b);return this._rasterizeCIMVectorMarker(M)}case"CIMPictureMarker":{const b=W.wp.fromCIMInsidePolygon(d);return this._rasterizeCIMVectorMarker(b)}case"CIMVectorMarker":{var M;if("CIMMarkerPlacementInsidePolygon"===(null===(M=d.markerPlacement)||void 0===M?void 0:M.type)){const b=W.wp.fromCIMInsidePolygon(d);return this._rasterizeCIMVectorMarker(b)}const b=(0,K.eR)(d);return b&&!d.avoidSDFRasterization?this._rasterizeSDFInfo(b):this._rasterizeCIMVectorMarker(d,!1)}}}_rasterizeSDFInfo(d){if(!d)return null;const[b,M,S]=(0,K.ce)(d);return b?{size:[M,S],image:new Uint32Array(b.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}_rasterizeCIMVectorMarker(d){const b=!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?ke.A.fromExtent(d.frame):null,[M,S,O,P,T]=W.wp.rasterize(this._canvas,d,b,this._resourceManager);return M?{size:[S,O],image:new Uint32Array(M.buffer),sdf:!1,simplePattern:!1,anchorX:P,anchorY:T}:null}rasterizeImageResource(d,b,M,S){this._canvas.width=d,this._canvas.height=b;const O=this._canvas.getContext("2d",{willReadFrequently:!0});M instanceof ImageData?O.putImageData(M,0,0):(M.setAttribute("width","".concat(d,"px")),M.setAttribute("height","".concat(b,"px")),O.drawImage(M,0,0,d,b));const P=O.getImageData(0,0,d,b),T=new Uint8Array(P.data);if(S)for(const I of S)if(I&&I.oldColor&&4===I.oldColor.length&&I.newColor&&4===I.newColor.length){const[d,b,M,S]=I.oldColor,[O,P,C,E]=I.newColor;if(d===O&&b===P&&M===C&&S===E)continue;for(let A=0;A<T.length;A+=4)d===T[A]&&b===T[A+1]&&M===T[A+2]&&S===T[A+3]&&(T[A]=O,T[A+1]=P,T[A+2]=C,T[A+3]=E)}let C;for(let I=0;I<T.length;I+=4)C=T[I+3]/255,T[I]=T[I]*C,T[I+1]=T[I+1]*C,T[I+2]=T[I+2]*C;let E=T,A=d,z=b;const B=512;if(A>=B||z>=B){const M=A/z;M>1?(A=B,z=Math.round(B/M)):(z=B,A=Math.round(B*M)),E=new Uint8Array(4*A*z);const S=new Uint8ClampedArray(E.buffer);(0,J.Go)(T,d,b,S,A,z,!1)}return{size:[A,z],image:new Uint32Array(E.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}var Be=M(20943);class RectangleBinPack_t{constructor(d,b){this._width=0,this._height=0,this._free=[],this._width=d,this._height=b,this._free.push(new Be.A(0,0,d,b))}get width(){return this._width}get height(){return this._height}allocate(d,b){if(d>this._width||b>this._height)return new Be.A;let M=null,S=-1;for(let O=0;O<this._free.length;++O){const P=this._free[O];d<=P.width&&b<=P.height&&(null===M||P.y<=M.y&&P.x<=M.x)&&(M=P,S=O)}return null===M?new Be.A:(this._free.splice(S,1),M.width<M.height?(M.width>d&&this._free.push(new Be.A(M.x+d,M.y,M.width-d,b)),M.height>b&&this._free.push(new Be.A(M.x,M.y+b,M.width,M.height-b))):(M.width>d&&this._free.push(new Be.A(M.x+d,M.y,M.width-d,M.height)),M.height>b&&this._free.push(new Be.A(M.x,M.y+b,d,M.height-b))),new Be.A(M.x,M.y,d,b))}release(d){for(let b=0;b<this._free.length;++b){const M=this._free[b];if(M.y===d.y&&M.height===d.height&&M.x+M.width===d.x)M.width+=d.width;else if(M.x===d.x&&M.width===d.width&&M.y+M.height===d.y)M.height+=d.height;else if(d.y===M.y&&d.height===M.height&&d.x+d.width===M.x)M.x=d.x,M.width+=d.width;else{if(d.x!==M.x||d.width!==M.width||d.y+d.height!==M.y)continue;M.y=d.y,M.height+=d.height}this._free.splice(b,1),this.release(d)}this._free.push(d)}}var Ie=M(83663),De=M(83881);const GlyphMosaic_o=d=>Math.floor(d/256);class GlyphMosaic_p{constructor(d,b,M){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=d,this.height=b,this._glyphSource=M,this._binPack=new RectangleBinPack_t(d-4,b-4),this._glyphData.push(new Uint8Array(d*b)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const d of this._textures)d&&d.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const d=[117,149,181,207,207,181,149,117],b=[],M=[];for(let P=0;P<d.length;P++){const S=d[P];for(let d=0;d<11;d++){const O=P>=3&&P<5&&d>=3&&d<8?255:0;b.push(S),M.push(O)}}const S={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(b)},O={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(M)};this._recordGlyph(S),this._recordGlyph(O)}getTexture(d,b){if(!this._textures[b]){const M=new De.R;M.pixelFormat=Se.Ab.ALPHA,M.wrapMode=Se.pF.CLAMP_TO_EDGE,M.width=this.width,M.height=this.height,this._textures[b]=new Ie.g(d,M,new Uint8Array(this.width*this.height))}return this._dirties[b]&&(this._textures[b].setData(this._glyphData[b]),this._dirties[b]=!1),this._textures[b]}async getGlyphItems(d,b,M){const S=this._getGlyphCache(d);return await this._fetchRanges(d,b,M),b.map((b=>this._getMosaicItem(S,d,b)))}bind(d,b,M,S){const O=this.getTexture(d,M);O.setSamplingMode(b),d.bindTexture(O,S)}preloadASCIIGlyphCache(d){const b=this._preloadCache[d];if(null!=b)return b;const M=this._glyphSource.preloadASCIIRange(d).then((()=>{const b=this._getGlyphCache(d);for(let M=0;M<256;M++)this._getMosaicItem(b,d,M)}));return this._preloadCache[d]=M,M}_getGlyphCache(d){return this._glyphCache[d]||(this._glyphCache[d]={}),this._glyphCache[d]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(d,b,M){const S=function GlyphMosaic_c(d){const b=new Set;for(const M of d)b.add(GlyphMosaic_o(M));return b}(b),O=[];S.forEach((b=>{O.push(this._fetchRange(d,b,M))})),await Promise.all(O)}async _fetchRange(d,b,M){if(b>256)return;const S=d+b;return function GlyphMosaic_l(d,b,M){return d.has(b)||d.set(b,M().then((()=>{d.delete(b)})).catch((M=>{d.delete(b),(0,Ee.jH)(M)}))),d.get(b)}(this._rangePromises,S,(()=>this._glyphSource.getRange(d,b,M)))}_getMosaicItem(d,b,M){if(!d[M]){const S=this._glyphSource.getGlyph(b,M);if(null===S||void 0===S||!S.metrics)return(d=>({rect:new Be.A(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:d,sdf:!0}))(M);const O=this._recordGlyph(S),P=this._currentPage,T=S.metrics;d[M]={rect:O,page:P,metrics:T,code:M,sdf:!0},this._invalidate()}return d[M]}_recordGlyph(d){const b=d.metrics;let M;if(0===b.width)M=new Be.A(0,0,0,0);else{const S=3,P=b.width+2*S,T=b.height+2*S;M=this._binPack.allocate(P,T),M.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new RectangleBinPack_t(this.width-4,this.height-4),M=this._binPack.allocate(P,T));const C=this._glyphData[this._currentPage],E=d.bitmap;let A,z;if(E)for(let d=0;d<T;d++){A=P*d,z=this.width*(M.y+d)+M.x;for(let d=0;d<P;d++)C[z+d]=E[A+d]}(0,O.A)("esri-glyph-debug")&&this._showDebugPage(C)}return M}_showDebugPage(d){const b=document.createElement("canvas"),M=b.getContext("2d"),S=new ImageData(this.width,this.height),O=S.data;b.width=this.width,b.height=this.height,b.style.border="1px solid black";for(let P=0;P<d.length;++P)O[4*P]=d[P],O[4*P+1]=0,O[4*P+2]=0,O[4*P+3]=255;M.putImageData(S,0,0),document.body.appendChild(b)}}var Le=M(40954);class GlyphSource_a{constructor(d){for(this._metrics=[],this._bitmaps=[];d.next();)switch(d.tag()){case 1:{const b=d.getMessage();for(;b.next();)switch(b.tag()){case 3:{const d=b.getMessage();let M,S,O,P,T,C,E;for(;d.next();)switch(d.tag()){case 1:M=d.getUInt32();break;case 2:S=d.getBytes();break;case 3:O=d.getUInt32();break;case 4:P=d.getUInt32();break;case 5:T=d.getSInt32();break;case 6:C=d.getSInt32();break;case 7:E=d.getUInt32();break;default:d.skip()}d.release(),M&&(this._metrics[M]={width:O,height:P,left:T,top:C,advance:E},this._bitmaps[M]=S);break}default:b.skip()}b.release();break}default:d.skip()}}getMetrics(d){return this._metrics[d]}getBitmap(d){return this._bitmaps[d]}}class GlyphSource_s{constructor(){this._ranges=[]}getRange(d){return this._ranges[d]}addRange(d,b){this._ranges[d]=b}}class r{constructor(d){this._glyphInfo={},this._baseURL=d}getRange(d,b,M){const S=this._getFontStack(d);if(S.getRange(b))return Promise.resolve();const O=256*b,P=O+255,T=this._baseURL.replace("{fontstack}",d).replace("{range}",O+"-"+P);return(0,Fe.A)(T,{responseType:"array-buffer",...M}).then((d=>{S.addRange(b,new GlyphSource_a(new Le.A(new Uint8Array(d.data),new DataView(d.data))))}))}async preloadASCIIRange(d){const b=this._getFontStack(d),M=this._baseURL.replace("{fontstack}",d).replace("{range}","0-255"),S=await(0,Fe.A)(M,{responseType:"array-buffer"}),O=new GlyphSource_a(new Le.A(new Uint8Array(S.data),new DataView(S.data)));for(let P=0;P<=255;P++)b.getRange(P)||b.addRange(P,O)}getGlyph(d,b){const M=this._getFontStack(d);if(!M)return;const S=Math.floor(b/256),O=M.getRange(S);return O?{metrics:O.getMetrics(b),bitmap:O.getBitmap(b)}:void 0}_getFontStack(d){let b=this._glyphInfo[d];return b||(b=this._glyphInfo[d]=new GlyphSource_s),b}}var Ne=M(31714);const Ue=1e20;class SDFConverter_r{constructor(d){this._svg=null,this.size=d;const b=document.createElement("canvas");b.width=b.height=d,this._context=b.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(d*d),this._gridInner=new Float64Array(d*d),this._f=new Float64Array(d),this._d=new Float64Array(d),this._z=new Float64Array(d+1),this._v=new Int16Array(d)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(d,b,M){let S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:31;this._initSVG();const O=this.createSVGString(d,b);return new Promise(((d,b)=>{const P=new Image;P.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(O),P.onload=()=>{P.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(P,0,0,this.size,this.size);const b=this._context.getImageData(0,0,this.size,this.size),M=new Uint8Array(this.size*this.size*4);for(let d=0;d<this.size*this.size;d++){const M=b.data[4*d+3]/255;this._gridOuter[d]=1===M?0:0===M?Ue:Math.max(0,.5-M)**2,this._gridInner[d]=1===M?Ue:0===M?0:Math.max(0,M-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let d=0;d<this.size*this.size;d++){const b=this._gridOuter[d]-this._gridInner[d];(0,Ne.U)(.5-b/(2*S),M,4*d)}d(M)};const T=null===M||void 0===M?void 0:M.signal;T&&(0,Ee.u7)(T,(()=>b((0,Ee.NK)())))}))}_initSVG(){if(!this._svg){const d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("style","position: absolute;"),d.setAttribute("width","0"),d.setAttribute("height","0"),d.setAttribute("aria-hidden","true"),d.setAttribute("role","presentation"),document.body.appendChild(d),this._svg=d}return this._svg}createSVGString(d,b){const M=this._initSVG(),S=document.createElementNS("http://www.w3.org/2000/svg","path");S.setAttribute("d",d),M.appendChild(S);const O=S.getBBox(),P=O.width/O.height,T=this.size/2;let C,E,A;if(P>1){C=T/O.width;const d=T*(1/P);E=this.size/4,A=T-d/2}else C=T/O.height,E=T-T*P/2,A=this.size/4;const z=-O.x*C+E,B=-O.y*C+A;S.setAttribute("style","transform: matrix(".concat(C,", 0, 0, ").concat(C,", ").concat(z,", ").concat(B,")")),S.setAttribute("stroke-width",""+.5/C);const I='<svg style="fill:'.concat(b?"red":"none","; stroke:").concat(b?"none":"red",'" height="').concat(this.size,'" width="').concat(this.size,'" xmlns="http://www.w3.org/2000/svg">').concat(M.innerHTML,"</svg>");return M.removeChild(S),I}_edt(d,b,M){const S=this._f,O=this._d,P=this._v,T=this._z;for(let C=0;C<b;C++){for(let O=0;O<M;O++)S[O]=d[O*b+C];this._edt1d(S,O,P,T,M);for(let S=0;S<M;S++)d[S*b+C]=O[S]}for(let C=0;C<M;C++){for(let M=0;M<b;M++)S[M]=d[C*b+M];this._edt1d(S,O,P,T,b);for(let M=0;M<b;M++)d[C*b+M]=Math.sqrt(O[M])}}_edt1d(d,b,M,S,O){M[0]=0,S[0]=-Ue,S[1]=+Ue;for(let P=1,T=0;P<O;P++){let b=(d[P]+P*P-(d[M[T]]+M[T]*M[T]))/(2*P-2*M[T]);for(;b<=S[T];)T--,b=(d[P]+P*P-(d[M[T]]+M[T]*M[T]))/(2*P-2*M[T]);T++,M[T]=P,S[T]=b,S[T+1]=+Ue}for(let P=0,T=0;P<O;P++){for(;S[T+1]<P;)T++;b[P]=(P-M[T])*(P-M[T])+d[M[T]]}}}var Ve=M(152);function SpriteMosaic_c(d){return d&&"static"===d.type}class SpriteMosaic_n{constructor(d,b){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(d<=0||b<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=d,this._pageHeight=b,M>0&&(this._maxItemSize=M),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new RectangleBinPack_t(this._pageWidth,this._pageHeight);const S=Math.floor(this._pageWidth),O=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(S*O)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(d){return d>=this._mosaicPages.length?-1:this._mosaicPages[d].size[0]}getHeight(d){return d>=this._mosaicPages.length?-1:this._mosaicPages[d].size[1]}getPageTexture(d){return d<this._mosaicPages.length?this._mosaicPages[d].texture:null}has(d){return this._mosaicRects.has(d)}get itemCount(){return this._mosaicRects.size}getSpriteItem(d){return this._mosaicRects.get(d)}addSpriteItem(d,b,M,S,P,T){let C,E,A,z=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;if(this._mosaicRects.has(d))return this._mosaicRects.get(d);if(SpriteMosaic_c(M))[C,E,A]=this._allocateImage(b[0],b[1]);else{C=new Be.A(0,0,b[0],b[1]),E=this._mosaicPages.length;const d=void 0;this._mosaicPages.push({mosaicsData:M,size:[b[0]+2*Z.hM,b[1]+2*Z.hM],dirty:!0,texture:d})}if(C.width<=0||C.height<=0)return null;const B={type:"sprite",rect:C,width:b[0],height:b[1],sdf:P,simplePattern:T,rasterizationScale:z,page:E};return this._mosaicRects.set(d,B),SpriteMosaic_c(M)&&((0,O.A)("esri-mosaic-debug")&&this._showDebugSprite(b,M.data),this._copy({rect:C,spriteSize:b,spriteData:M.data,page:E,pageSize:A,repeat:S,sdf:P})),B}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const d=this._spriteCopyQueue.pop();d&&this._copy(d)}getMosaicItemPosition(d){const b=this.getSpriteItem(d),M=null===b||void 0===b?void 0:b.rect;if(!M)return null;M.width=b.width,M.height=b.height;const S=b.width,O=b.height,P=Z.hM,T=this._mosaicPages[b.page].size;return{size:[b.width,b.height],tl:[(M.x+P)/T[0],(M.y+P)/T[1]],br:[(M.x+P+S)/T[0],(M.y+P+O)/T[1]],page:b.page}}bind(d,b){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const P=this._mosaicPages[M],T=P.mosaicsData;let C=P.texture;C||(C=SpriteMosaic_p(d,P.size),P.texture=C),C.setSamplingMode(b),SpriteMosaic_c(T)?(d.bindTexture(C,S),P.dirty&&(C.setData(new Uint8Array(T.data.buffer)),C.generateMipmap(),(0,O.A)("esri-mosaic-debug")&&this._showDebugPage(M))):(T.data.loadFrame(C),d.bindTexture(C,S),C.generateMipmap()),P.dirty=!1}getTexture(d){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const M=this._mosaicPages[b],S=M.mosaicsData;let P=M.texture;return P||(P=SpriteMosaic_p(d,M.size),M.texture=P),SpriteMosaic_c(S)?M.dirty&&(P.setData(new Uint8Array(S.data.buffer)),P.generateMipmap(),(0,O.A)("esri-mosaic-debug")&&this._showDebugPage(b)):(S.data.loadFrame(P),P.generateMipmap()),M.dirty=!1,P}dispose(){this._binPack=null;for(const d of this._mosaicPages){const b=d.texture;b&&b.dispose();const M=d.mosaicsData;SpriteMosaic_c(M)||M.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(d,b,M,S,O,P,T,C,E,A,z){let B=S*b+M,I=C*P+T;if(z){I-=P;for(let T=-1;T<=A;T++,B=((T+A)%A+S)*b+M,I+=P)for(let b=-1;b<=E;b++)O[I+b]=d[B+(b+E)%E]}else for(let U=0;U<A;U++){for(let b=0;b<E;b++)O[I+b]=d[B+b];B+=b,I+=P}}_copy(d){if(d.page>=this._mosaicPages.length)return;const b=this._mosaicPages[d.page],M=b.mosaicsData;if(!SpriteMosaic_c(b.mosaicsData))throw new S.A("mapview-invalid-resource","unsuitable data type!");const O=d.spriteData,P=M.data;P&&O||console.error("Source or target images are uninitialized!"),SpriteMosaic_n._copyBits(O,d.spriteSize[0],0,0,P,d.pageSize[0],d.rect.x+Z.hM,d.rect.y+Z.hM,d.spriteSize[0],d.spriteSize[1],d.repeat),b.dirty=!0}_allocateImage(d,b){d+=2*Z.hM,b+=2*Z.hM;const M=Math.max(d,b);if(this._maxItemSize&&this._maxItemSize<M){const M=2**Math.ceil((0,Ve.p6)(d)),S=2**Math.ceil((0,Ve.p6)(b)),O=new Be.A(0,0,d,b);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(M*S)},size:[M,S],dirty:!0,texture:void 0}),[O,this._mosaicPages.length-1,[M,S]]}const S=this._binPack.allocate(d,b);if(S.width<=0){const M=this._mosaicPages[this._currentPage];return!M.dirty&&SpriteMosaic_c(M.mosaicsData)&&(M.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new RectangleBinPack_t(this._pageWidth,this._pageHeight),this._allocateImage(d,b)}return[S,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite(d,b){let[M,S]=d;const O=document.createElement("canvas");O.width=M,O.height=S,O.setAttribute("style","position: absolute; top: ".concat(4+204*We++,"px; right: 208px; width: 200px; height: 200px; border: 1px solid black;"));const P=O.getContext("2d"),T=new ImageData(M,S);T.data.set(new Uint8Array(b.buffer)),P.putImageData(T,0,0),document.body.appendChild(O)}_showDebugPage(d){var b;const M=this._mosaicPages[d],{size:[S,O],mosaicsData:P}=M;if(!SpriteMosaic_c(P))return void console.error("Could not show sprite mosaic debug for non-static resource");const T="mosaicDebugPage".concat(d),C=null!==(b=document.getElementById(T))&&void 0!==b?b:document.createElement("canvas");C.id=T,C.width=S,C.height=O,C.setAttribute("style","position: absolute; top: ".concat(4+204*d,"px; right: 4px; width: 200px; height: 200px; border: 1px solid black;"));const E=C.getContext("2d"),A=new ImageData(S,O);A.data.set(new Uint8Array(P.data.buffer)),E.putImageData(A,0,0),document.body.appendChild(C)}}let We=0;function SpriteMosaic_p(d,b){const M=new De.R;return M.width=b[0],M.height=b[1],M.wrapMode=Se.pF.CLAMP_TO_EDGE,new Ie.g(d,M,null)}var Ge=M(82380),He=M(73476);class AnimatableTextureResource_a{constructor(d,b,M,S){this._animation=d,this._frameData=null;this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=(0,He.ZH)(this._animation,M,S,(d=>{this._frameData=d,b.requestRender()}))}destroy(){this._playHandle.remove()}loadFrame(d){const b=this._frameData;if(null==b)return;const M="width"in b?b.width:b.codedWidth,S="height"in b?b.height:b.codedHeight;d.updateData(0,Z.hM,Z.hM,M,S,b),this._frameData=null}}var qe=M(73896);const je="arial-unicode-ms-regular",v=(d,b,M)=>I.A.getLogger("esri.views.2d.engine.webgl.TextureManager").error(new S.A(d,b,M));class ${static fromMosaic(d,b){return new $(d,b.page,b.sdf)}constructor(d,b,M){this.mosaicType=d,this.page=b,this.sdf=M}}class k{constructor(d){this._requestRender=d,this._resourceManager=new Ae.A,this._invalidFontsMap=new Map,this._sdfConverter=new SDFConverter_r(Z._j),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new qe.e({concurrency:10,process:async(d,b)=>{(0,Ee.Te)(b);try{return await(0,Fe.A)(d,{responseType:"image",signal:b})}catch(r){if(!(0,Ee.zf)(r))throw new S.A("mapview-invalid-resource","Could not fetch requested resource at ".concat(d),r);throw r}}}),this._spriteMosaic=new SpriteMosaic_n(2048,2048,500),this._glyphSource=new r("".concat(Ce.A.fontsUrl,"/{fontstack}/{range}.pbf")),this._glyphMosaic=new GlyphMosaic_p(1024,1024,this._glyphSource),this._rasterizer=new Rasterizer_c(this.resourceManager)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null,this._resourceManager.destroy()}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}get resourceManager(){return this._resourceManager}async rasterizeItem(d,b){if(null==d)return v("mapview-null-resource","Unable to rasterize null resource"),null;if("cim-rasterization-info"!==d.type)return v("mapview-unexpected-resource","Unable to rasterize resource"),null;const{resource:M}=d;if("text"===M.type){const d=await this._rasterizeText(M,b);for(const b of d.glyphs)this._setTextureBinding(le.Be.GLYPH,b);return d}const S=await this._rasterizeSprite(M,b);return S&&this._setTextureBinding(le.Be.SPRITE,S),S}getMosaicInfo(d,b){let M=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const S=this._getTextureBindingInfo(d,b,M);return S?{size:S.size,texture:{texture:S.texture,unit:"sprite"===S.type?Z.Pq:Z.ue}}:(v("mapview-invalid-resource","Unable to find resource for ".concat(b)),{size:[0,0],texture:{texture:null,unit:0}})}_getTextureBindingInfo(d,b,M){const S=this._bindingInfos[b-1],O=S.page,P=M?Se.Cj.LINEAR_MIPMAP_LINEAR:Se.Cj.LINEAR;switch(S.mosaicType){case le.Be.SPRITE:{const b=[this.sprites.getWidth(O),this.sprites.getHeight(O)],M=this._spriteMosaic.getTexture(d,O);return M.setSamplingMode(P),{type:"sprite",texture:M,size:b}}case le.Be.GLYPH:{const b=[this.glyphs.width,this.glyphs.height],M=this._glyphMosaic.getTexture(d,O);return this._glyphMosaic.bind(d,P,O,Z.ue),M.setSamplingMode(P),{type:"glyph",texture:M,size:b}}default:return v("mapview-texture-manager","Cannot handle unknown type ".concat(S.mosaicType)),null}}_hashMosaic(d,b){return 1|d<<1|(b.sdf?1:0)<<2|b.page<<3}_setTextureBinding(d,b){const M=this._hashMosaic(d,b);if(!this._hashToBindingIndex.has(M)){const S=$.fromMosaic(d,b),O=this._bindingInfos.length+1;this._hashToBindingIndex.set(M,O),this._bindingInfos.push(S)}b.textureBinding=this._hashToBindingIndex.get(M)}async _rasterizeText(d,b){const{font:M,textString:S}=d,P=(0,z.rK)(M),T=this._invalidFontsMap.has(P),[C,E]=(0,Re.y)(S),A=(0,Ge.bX)(C);try{const d=T?je:P;return(0,O.A)("esri-2d-stabilize-glyphs")&&await this._glyphMosaic.preloadASCIIGlyphCache(d),{type:"glyphs",glyphs:await this._glyphMosaic.getGlyphItems(d,A,b),isRightToLeft:E}}catch(l){return v("mapview-invalid-resource","Couldn't find font ".concat(P,". Falling back to Arial Unicode MS Regular")),this._invalidFontsMap.set(P,!0),{type:"glyphs",glyphs:await this._glyphMosaic.getGlyphItems(je,A,b),isRightToLeft:E}}}_hashSpriteResource(d){switch(d.type){case"path":return"path:".concat(d.path,".").concat(d.asFill?1:0);case"CIMPictureMarker":return"".concat(d.type,":").concat(d.url,":").concat(d.size);case"CIMPictureFill":return"".concat(d.type,":").concat(d.url,":").concat(d.height);case"CIMPictureStroke":return"".concat(d.type,":").concat(d.url,":").concat(d.width);case"dash":return"dash:".concat(d.capStyle,".").concat(d.dashTemplate.join(""));case"sdf":return"sdf:".concat(JSON.stringify(d.geom),".").concat(d.asFill?1:0);case"fill-style":return"fill_style:".concat(d.style);case"animated":return JSON.stringify((0,Ge.IF)(d));case"CIMHatchFill":case"CIMVectorMarker":return JSON.stringify(d)}}async _rasterizeSprite(d,b){var M;if(!d)return null;const S=(0,V.Wm)(this._hashSpriteResource(d));if(this._spriteMosaic.has(S))return this._spriteMosaic.getSpriteItem(S);if("url"in d&&d.url||"CIMPictureFill"===d.type||"CIMPictureStroke"===d.type||"CIMPictureMarker"===d.type||"CIMVectorMarker"===d.type){const b=[];W.wp.fetchResources({type:"CIMPointSymbol",symbolLayers:[d]},this._resourceManager,b),b.length>0&&await Promise.all(b)}switch(d.type){case"CIMPictureMarker":return"CIMMarkerPlacementInsidePolygon"===(null===(M=d.markerPlacement)||void 0===M?void 0:M.type)?this._rasterizeJSONResource(S,d):this._handleAsyncResource(S,d,b);case"animated":case"CIMPictureFill":case"CIMPictureStroke":case"path":return this._handleAsyncResource(S,d,b);case"sdf":case"dash":case"fill-style":case"CIMVectorMarker":case"CIMHatchFill":return this._rasterizeJSONResource(S,d)}}_rasterizeJSONResource(d,b){const M=this._rasterizer.rasterizeJSONResource(b,function j(d){switch(d.type){case"fill-style":case"CIMHatchFill":return Z.nW}return 1}(b));if(M){const{size:S,image:O,sdf:P,simplePattern:T,rasterizationScale:C}=M;return this._addItemToMosaic(d,S,{type:"static",data:O},TextureManager_A(b),P,T,C)}return null}async _handleAsyncResource(d,b,M){if(this._ongoingRasterizations.has(d))return this._ongoingRasterizations.get(d);let S;return S="path"===b.type?this._handleSVG(b,d,M):this._handleImage(b,d,M),this._ongoingRasterizations.set(d,S),S.finally((()=>this._ongoingRasterizations.delete(d))),S}async _handleSVG(d,b,M){const S=[Z._j,Z._j],{asFill:O}=d,P=await this._sdfConverter.draw(d.path,O,M);return this._addItemToMosaic(b,S,{type:"static",data:new Uint32Array(P.buffer)},!1,!0,!0)}async _handleGIFOrPNG(d,b,M){const S=d.url,O=this.resourceManager.getResource(S);if(null==O)return null;const{width:P,height:T}=O;if(O instanceof HTMLImageElement){if("animated"===d.type)return v("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;const M="colorSubstitutions"in d?d.colorSubstitutions:void 0,{size:S,sdf:C,image:E}=this._rasterizer.rasterizeImageResource(P,T,O,M);return this._addItemToMosaic(b,S,{type:"static",data:E},TextureManager_A(d),C,!1)}let C,E,A;"animated"===d.type?(C=!1,E={playAnimation:d.playAnimation,reverseAnimation:d.reverseAnimation,randomizeStartTime:d.randomizeStartTime,randomizeStartSeed:d.randomizeStartSeed,startTimeOffset:d.startTimeOffset,duration:d.duration,repeatType:d.repeatType,repeatDelay:d.repeatDelay},A=d.startGroup||0):(C=TextureManager_A(d),E={},A=0);const z=new AnimatableTextureResource_a(O,this._requestRender,E,A);return this._addItemToMosaic(b,[z.width,z.height],{type:"animated",data:z},C,!1,!1)}async _handleImage(d,b,M){const O=d.url;if(TextureManager_G(O)||L(O))return this._handleGIFOrPNG(d,b,M);if("animated"===d.type)return v("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;try{let S;const T=this.resourceManager.getResource(O);if(null!=T&&T instanceof HTMLImageElement)S=T;else{const{data:d}=await this._imageRequestQueue.push(O,{...M});S=d}if((0,Ge.UE)(O))if("width"in d&&"height"in d)S.width=(0,U.Lz)(d.width),S.height=(0,U.Lz)(d.height);else if("cim"in d){var P;const b=d;S.width=(0,U.Lz)(null!==(P=b.width)&&void 0!==P?P:b.scaleX*b.size),S.height=(0,U.Lz)(b.size)}if(!S.width||!S.height)return null;const C=S.width,E=S.height,A="colorSubstitutions"in d?d.colorSubstitutions:void 0,{size:z,sdf:B,image:I}=this._rasterizer.rasterizeImageResource(C,E,S,A);return this._addItemToMosaic(b,z,{type:"static",data:I},TextureManager_A(d),B,!1)}catch(v){if(!(0,Ee.zf)(v))throw new S.A("mapview-invalid-resource","Could not fetch requested resource at ".concat(O,". ").concat(v.message));throw v}}_addItemToMosaic(d,b,M,S,O,P,T){return this._spriteMosaic.addSpriteItem(d,b,M,S,O,P,T)}}function TextureManager_A(d){switch(d.type){case"CIMVectorMarker":case"CIMPictureMarker":return TextureManager_N(d);default:return!0}}const TextureManager_G=d=>d&&(d.includes(".gif")||(d=>null!=d&&d.startsWith("data:image/gif"))(d)),L=d=>d&&(d.includes(".png")||(d=>null!=d&&d.startsWith("data:image/png"))(d)),TextureManager_N=d=>d&&"markerPlacement"in d&&d.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===d.markerPlacement.type;class TextureUploadManager_r{constructor(d){this._queue=[],this._refreshable=d}destroy(){this._queue=[]}enqueueTextureUpdate(d,b){const M=(0,Ee.Tw)(),S=d,O=Z.Qb,P=Math.ceil(S.height/O);(0,Ee.Te)(b);for(let T=0;T<P;T++){const C=T*O,E=T===P-1,A=E?S.height-O*T:O;this._queue.push({type:"chunk",request:d,resolver:M,chunk:T,chunkOffset:C,destHeight:A,chunkIsLast:E,options:b})}return(0,Ee.NY)(b,(d=>M.reject(d))),M.promise}upload(){let d=0;for(;this._queue.length;){const b=performance.now(),M=this._queue.shift();if(M){if(null!=M.options.signal&&M.options.signal.aborted)continue;switch(M.type){case"chunk":this._uploadChunk(M);break;case"no-chunk":this._uploadNoChunk(M)}const S=performance.now()-b;if(d+=S,d+S>=Z.r1)break}}this._queue.length&&this._refreshable.requestRender()}_uploadChunk(d){const{request:b,resolver:M,chunkOffset:S,chunkIsLast:O,destHeight:P}=d,{data:T,texture:C,width:E}=b;null!=T&&(C.updateData(0,0,S,E,P,T,S),O&&M.resolve())}_uploadNoChunk(d){const{request:b,resolver:M}=d,{data:S,texture:O}=b;O.setData(S),M.resolve()}}var Xe=M(3623),Ye=M(43438),Ke=M(68052),Je=M(52273),Qe=M(54880),$e=M(83800),Ze=M(71245);const et=(0,Je.fA)(-.5,-.5);class u{constructor(){this._centerNdc=(0,$e.vt)(),this._pxToNdc=(0,$e.vt)(),this._worldDimensionsPx=(0,$e.vt)(),this._mat3=(0,E.vt)(),this._initialized=!1}dispose(){this._program=(0,P.WD)(this._program),this._quad=(0,P.WD)(this._quad)}render(d,b,M){const{context:S}=d,O=this._updateGeometry(d,M);if(null!=b){const{r:d,g:M,b:O,a:P}=b;S.setClearColor(P*d/255,P*M/255,P*O/255,P)}else S.setClearColor(0,0,0,0);if(S.setStencilFunction(Se.MT.ALWAYS,0,255),S.setStencilWriteMask(255),!O)return S.setClearStencil(1),void S.clear(S.gl.STENCIL_BUFFER_BIT|S.gl.COLOR_BUFFER_BIT);S.setClearStencil(0),S.clear(S.gl.STENCIL_BUFFER_BIT|S.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(S),S.setDepthWriteEnabled(!1),S.setDepthTestEnabled(!1),S.setColorMask(!1,!1,!1,!1),S.setBlendingEnabled(!1),S.setStencilOp(Se.eA.KEEP,Se.eA.KEEP,Se.eA.REPLACE),S.setStencilFunction(Se.MT.ALWAYS,1,255),S.setStencilTestEnabled(!0),S.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}_initialize(d){if(this._initialized)return;const b=(0,Oe.r)(d,Ze.P);b&&(this._program=b,this._quad=new Xe.A(d,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(d,b){const{state:M,pixelRatio:S}=d,{size:O,rotation:P}=M,T=Math.round(O[0]*S),C=Math.round(O[1]*S);if(!M.spatialReference.isWrappable)return!1;const E=(0,Ye.DF)(P),A=Math.abs(Math.cos(E)),z=Math.abs(Math.sin(E)),B=Math.round(T*A+C*z),I=Math.round(M.worldScreenWidth);if(B<=I)return!1;const U=T*z+C*A,V=I*S,W=(b.left-b.right)*S/T,H=(b.bottom-b.top)*S/C;(0,Qe.s)(this._worldDimensionsPx,V,U,1),(0,Qe.s)(this._pxToNdc,2/T,-2/C,1),(0,Qe.s)(this._centerNdc,W,H,1);const q=this._mat3;return(0,Ke.kN)(q,this._centerNdc),(0,Ke.hs)(q,q,this._pxToNdc),0!==P&&(0,Ke.e$)(q,q,E),(0,Ke.hs)(q,q,this._worldDimensionsPx),(0,Ke.Tl)(q,q,et),!0}}class Effect_t{constructor(){this.name=this.constructor.name}createOptions(d,b){return null}}class AnimationEffect_i extends Effect_t{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(d,b){if(null===b||void 0===b||!b.size)return;const{context:M,renderingOptions:S}=d;this._quad||(this._quad=new Xe.A(M,[0,0,1,0,0,1,1,1]));const P=M.getBoundFramebufferObject(),{x:T,y:C,width:E,height:A}=M.getViewport(),z=b.getBlock(Z.dV.Animation);if(null==z)return;const B=b.getUniforms(M);M.setViewport(0,0,b.size,b.size);const I=B.filterFlags,U=B.animation,V=(0,O.A)("featurelayer-animation-enabled")?S.labelsAnimationTime:1,W=z.getFBO(M,1);M.unbindTexture(W.colorTexture),this._computeDelta(d,W,U,I,V);const H=z.getFBO(M);M.unbindTexture(H.colorTexture),this._updateAnimationState(d,W,H),M.bindFramebuffer(P),M.setViewport(T,C,E,A)}_computeDelta(d,b,M,S,O){const{context:P,painter:T,displayLevel:C}=d,E=T.materialManager.getProgram(this._desc,["delta"]);if(P.bindFramebuffer(b),P.setColorMask(!0,!0,!0,!0),P.setClearColor(0,0,0,0),P.clear(P.gl.COLOR_BUFFER_BIT),P.useProgram(E),!("type"in S.texture)||!("type"in M.texture))throw new Error("InternalError: Expected to find texture");P.bindTexture(S.texture,S.unit),P.bindTexture(M.texture,M.unit),E.setUniform1i("u_maskTexture",S.unit),E.setUniform1i("u_sourceTexture",M.unit),E.setUniform1f("u_timeDelta",d.deltaTime),E.setUniform1f("u_animationTime",O),E.setUniform1f("u_zoomLevel",Math.round(10*C)),this._quad.draw()}_updateAnimationState(d,b,M){const{context:S,painter:O}=d,P=O.materialManager.getProgram(this._desc,["update"]);S.bindTexture(b.colorTexture,1),S.useProgram(P),P.setUniform1i("u_sourceTexture",1),S.bindFramebuffer(M),S.setColorMask(!0,!0,!0,!0),S.setClearColor(0,0,0,0),S.clear(S.gl.COLOR_BUFFER_BIT),this._quad.draw()}}var tt=M(85402);const BlendPrograms_t=d=>"#define ".concat((d=>d.replace("-","_").toUpperCase())(d),"\n");function BlendPrograms_n(d){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:BlendPrograms_t(d)+(0,tt.Q)("blend/blend.vert"),fragmentShader:BlendPrograms_t(d)+(0,tt.Q)("blend/blend.frag")}}}const BlendEffect_c=()=>I.A.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class m{constructor(){this._size=[0,0]}dispose(d){this._backBufferTexture=(0,P.WD)(this._backBufferTexture),this._quad=(0,P.WD)(this._quad)}draw(d,b,M,O,P){const{context:T,drawPhase:C}=d;if(this._setupShader(T),O&&"normal"!==O&&C!==le.S5.LABEL)return void this._drawBlended(d,b,M,O,P);const E=BlendPrograms_n("normal"),A=T.programCache.acquire(E.shaders.vertexShader,E.shaders.fragmentShader,E.attributes);if(!A)return void BlendEffect_c().error(new S.A("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));T.useProgram(A),b.setSamplingMode(M),T.bindTexture(b,0),A.setUniform1i("u_layerTexture",0),A.setUniform1f("u_opacity",P),T.setBlendingEnabled(!0),T.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA);const z=this._quad;z.draw(),z.unbind(),A.dispose()}_drawBlended(d,b,M,O,P){const{context:T,state:C,pixelRatio:E,inFadeTransition:A}=d,{size:z}=C,B=T.getBoundFramebufferObject();let I,U;null!=B?(I=B.width,U=B.height):(I=Math.round(E*z[0]),U=Math.round(E*z[1])),this._createOrResizeTexture(d,I,U);const V=this._backBufferTexture;B.copyToTexture(0,0,I,U,0,0,V),T.setStencilTestEnabled(!1),T.setStencilWriteMask(0),T.setBlendingEnabled(!0),T.setDepthTestEnabled(!1),T.setDepthWriteEnabled(!1);const W=BlendPrograms_n(O),H=T.programCache.acquire(W.shaders.vertexShader,W.shaders.fragmentShader,W.attributes);if(!H)return void BlendEffect_c().error(new S.A("mapview-BlendEffect","Error creating shader program for blend mode ".concat(O)));T.useProgram(H),V.setSamplingMode(M),T.bindTexture(V,0),H.setUniform1i("u_backbufferTexture",0),b.setSamplingMode(M),T.bindTexture(b,1),H.setUniform1i("u_layerTexture",1),H.setUniform1f("u_opacity",P),H.setUniform1f("u_inFadeOpacity",A?1:0),T.setBlendFunction(Se.dn.ONE,Se.dn.ZERO);const q=this._quad;q.draw(),q.unbind(),H.dispose(),T.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA)}_setupShader(d){this._quad||(this._quad=new Xe.A(d,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(d,b,M){const{context:S}=d;if(null===this._backBufferTexture||b!==this._size[0]||M!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(b,M);else{const d=new De.R;d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,d.width=b,d.height=M,this._backBufferTexture=new Ie.g(S,d)}this._size[0]=b,this._size[1]=M}}}class FeatureEffect_s extends Effect_t{constructor(d){super(),this.name=this.constructor.name,this.defines=[d]}dispose(){}bind(d){let{context:b,painter:M}=d;this._prev=b.getBoundFramebufferObject();const S=M.getFbos().effect0;b.bindFramebuffer(S),b.setColorMask(!0,!0,!0,!0),b.setClearColor(0,0,0,0),b.clear(b.gl.COLOR_BUFFER_BIT)}unbind(){}draw(d,b){const{context:M,painter:S}=d,O=S.getPostProcessingEffects(b),P=M.getBoundFramebufferObject();for(const{postProcessingEffect:T,effect:C}of O)T.draw(d,P,C);M.bindFramebuffer(this._prev),M.setStencilTestEnabled(!1),S.blitTexture(M,P.colorTexture,Se.Cj.NEAREST),M.setStencilTestEnabled(!0)}}var it=M(22071),rt=M(73025),st=M(40332);class HighlightRenderer_c{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(d,b){d.bindTexture(b,Z.vd),d.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",it.HQ),d.bindVAO(this._resources.quadVAO),d.drawArrays(Se.WR.TRIANGLE_STRIP,0,4),d.bindVAO()}finalBlur(d,b){d.bindTexture(b,Z.vd),d.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",it.XK),d.bindVAO(this._resources.quadVAO),d.drawArrays(Se.WR.TRIANGLE_STRIP,0,4),d.bindVAO()}renderHighlight(d,b,M){d.bindTexture(b,Z.vd),d.useProgram(this._resources.highlightProgram),M.applyHighlightOptions(d,this._resources.highlightProgram),d.bindVAO(this._resources.quadVAO),d.setBlendingEnabled(!0),d.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),d.drawArrays(Se.WR.TRIANGLE_STRIP,0,4),d.bindVAO()}_initialize(d,b,M){this._width=b,this._height=M;const S=Me.g.createVertex(d,Se._U.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),O=new Pe.Z(d,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new st._("a_position",2,Se.pe.BYTE,0,4),new st._("a_texcoord",2,Se.pe.UNSIGNED_BYTE,2,4)]},{geometry:S}),P=(0,Oe.r)(d,rt.Z),T=(0,Oe.r)(d,rt.G);d.useProgram(P),P.setUniform1i("u_texture",Z.vd),P.setUniform1i("u_shade",Z.CR),P.setUniform1f("u_sigma",it.aY),d.useProgram(T),T.setUniform1i("u_texture",Z.vd),T.setUniform1f("u_sigma",it.aY),this._resources={quadGeometry:S,quadVAO:O,highlightProgram:P,blurProgram:T}}setup(d,b,M){this._resources?(this._width=b,this._height=M):this._initialize(d,b,M)}}var at=M(50707),nt=M(79448);function HighlightSurfaces_i(d,b,M){const S=new De.R(b,M);return S.wrapMode=Se.pF.CLAMP_TO_EDGE,new at.H(d,S,new nt.q(Se.yQ.STENCIL_INDEX8,b,M))}class HighlightSurfaces_h{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(d,b,M){this._width=b,this._height=M;const S=HighlightSurfaces_i(d,b,M),O=HighlightSurfaces_i(d,b,M);this._resources={sharedBlur1Fbo:S,sharedBlur2Fbo:O}}setup(d,b,M){!this._resources||this._width===b&&this._height===M||this.dispose(),this._resources||this._initialize(d,b,M)}get sharedBlur1Tex(){return this._resources.sharedBlur1Fbo.colorTexture}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Fbo.colorTexture}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class HighlightEffect_l extends Effect_t{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new HighlightRenderer_c,this._width=void 0,this._height=void 0,this._boundFBO=null,this._hlSurfaces=new HighlightSurfaces_h,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new _}dispose(){var d,b;null!==(d=this._hlSurfaces)&&void 0!==d&&d.dispose(),null!==(b=this._hlRenderer)&&void 0!==b&&b.dispose(),this._boundFBO=null}bind(d){const{context:b,painter:M}=d,{width:S,height:O}=b.getViewport(),P=M.getFbos().effect0;this.setup(d,S,O),b.bindFramebuffer(P),b.setColorMask(!0,!0,!0,!0),b.setClearColor(0,0,0,0),b.clear(b.gl.COLOR_BUFFER_BIT)}unbind(){}setup(d,b,M){let{context:S}=d;this._width=b,this._height=M;const O=b%4,P=M%4;b+=O<2?-O:4-O,M+=P<2?-P:4-P,this._adjustedWidth=b,this._adjustedHeight=M,this._boundFBO=S.getBoundFramebufferObject();const T=Math.round(1*b),C=Math.round(1*M);this._hlRenderer.setup(S,T,C),this._hlSurfaces.setup(S,T,C)}draw(d){const{context:b,passOptions:M}=d,S=M.activeGradient,O=b.getBoundFramebufferObject();b.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),b.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),b.setStencilTestEnabled(!1),b.setClearColor(0,0,0,0),b.clear(b.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(b,O.colorTexture,Se.Cj.NEAREST,1),b.setStencilTestEnabled(!1),b.setBlendingEnabled(!1),b.setColorMask(!1,!1,!1,!0),b.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),b.setClearColor(0,0,0,0),b.clear(b.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(b,this._hlSurfaces.sharedBlur1Tex),b.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),b.setClearColor(0,0,0,0),b.clear(b.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(b,this._hlSurfaces.sharedBlur2Tex),b.bindFramebuffer(this._boundFBO),b.setBlendingEnabled(!0),b.setColorMask(!0,!0,!0,!0),b.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(b,this._hlSurfaces.sharedBlur1Tex,S),this._boundFBO=null}}class HittestEffect_n extends Effect_t{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions(d,b){let{pixelRatio:M}=d,S=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Z.c5;if(!b.length)return null;const O=b.shift(),P=O.x,T=O.y;return this._outstanding=O,{type:"hittest",distance:S*M,smallSymbolDistance:0,smallSymbolSizeThreshold:3,position:[P,T]}}bind(d){const{context:b,attributeView:M}=d;if(!M.size)return;const S=M.getBlock(Z.dV.GPGPU);if(null==S)return;const O=S.getFBO(b);b.setViewport(0,0,M.size,M.size),b.bindFramebuffer(O),b.setColorMask(!0,!0,!0,!0),b.setClearColor(0,0,0,0),b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(d){if(null==this._outstanding)return;const b=this._outstanding;this._outstanding=null,this._resolve(d,b.resolvers)}async _resolve(d,b){const{context:M,attributeView:S}=d,O=S.getBlock(Z.dV.GPGPU);if(null==O)return void b.forEach((d=>d.resolve([])));const P=O.getFBO(M),T=new Uint8Array(P.width*P.height*4);try{await P.readPixelsAsync(0,0,P.width,P.height,Se.Ab.RGBA,Se.ld.UNSIGNED_BYTE,T)}catch(u){return void b.forEach((d=>d.resolve([])))}const C=[];for(let E=0;E<T.length;E+=4){const d=E/4;T[E]&&C.push(d)}b.forEach((d=>d.resolve(C)))}}class HittestEffectVTL_r extends Effect_t{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0,this._boundFBO=null}dispose(){null!=this._fbo&&this._fbo.dispose()}bind(d){let{context:b,painter:M}=d;this._boundFBO=b.getBoundFramebufferObject();const S=M.getFbos().effect0;b.bindFramebuffer(S),b.setColorMask(!0,!0,!0,!0),b.setClearColor(0,0,0,0),b.clear(b.gl.COLOR_BUFFER_BIT)}unbind(d){let{context:b}=d;b.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw(d,b){let M=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2*Z.c5;this._resolve(d,b,M)}async _resolve(d,b,M){let{context:S,state:O,pixelRatio:P}=d;const T=S.getBoundFramebufferObject(),C=O.size[1]*P,E=Math.round(M*P),A=E/2,z=E/2;this._ensureBuffer(E),b.forEach((async(d,M)=>{const S=new Map,O=Math.floor(M.x*P-E/2),B=Math.floor(C-M.y*P-E/2);await T.readPixelsAsync(O,B,E,E,Se.Ab.RGBA,Se.ld.UNSIGNED_BYTE,this._buf);for(let b=0;b<this._buf32.length;b++){const d=this._buf32[b];if(4294967295!==d&&0!==d){const M=b%E,O=E-Math.floor(b/E),P=(A-M)*(A-M)+(z-O)*(z-O),T=S.has(d)?S.get(d):4294967295;S.set(d,Math.min(P,T))}}const I=Array.from(S).sort(((d,b)=>d[1]-b[1])).map((d=>d[0]));d.resolve(I),b.delete(M)}))}_ensureBuffer(d){this._lastSize!==d&&(this._lastSize=d,this._buf=new Uint8Array(4*d*d),this._buf32=new Uint32Array(this._buf.buffer))}}const ot=[1,0],lt=[0,1],ht=[1,.8,.6,.4,.2],ct=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class Bloom_h{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=(0,P.WD)(this._quad),this._intensityFBO=(0,P.WD)(this._intensityFBO),this._compositeFBO=(0,P.WD)(this._compositeFBO),this._mipsFBOs){for(let d=0;d<this._nMips;d++)this._mipsFBOs[d]&&(this._mipsFBOs[d].horizontal.dispose(),this._mipsFBOs[d].vertical.dispose());this._mipsFBOs=null}}draw(d,b,M){const{width:S,height:O}=b,{context:P,painter:T}=d,{materialManager:C}=T,E=P.gl,A=this._programDesc,{strength:z,radius:B,threshold:I}=M;this._quad||(this._quad=new Xe.A(P,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(d,S,O),P.setStencilTestEnabled(!1),P.setBlendingEnabled(!0),P.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),P.setStencilWriteMask(0);const U=this._quad;U.bind(),P.bindFramebuffer(this._intensityFBO);const V=C.getProgram(A.luminosityHighPass);P.useProgram(V),P.bindTexture(b.colorTexture,0),V.setUniform1i("u_texture",0),V.setUniform3fv("u_defaultColor",[0,0,0]),V.setUniform1f("u_defaultOpacity",0),V.setUniform1f("u_luminosityThreshold",I),V.setUniform1f("u_smoothWidth",.01);const W=[Math.round(S/2),Math.round(O/2)];P.setViewport(0,0,W[0],W[1]),P.setClearColor(0,0,0,0),P.clear(E.COLOR_BUFFER_BIT),U.draw(),P.setBlendingEnabled(!1);let H=this._intensityFBO.colorTexture;for(let K=0;K<this._nMips;K++){const d=C.getProgram(A.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[K]}]);P.useProgram(d),P.bindTexture(H,K+1),d.setUniform1i("u_colorTexture",K+1),d.setUniform2fv("u_texSize",W),d.setUniform2fv("u_direction",ot),P.setViewport(0,0,W[0],W[1]);const b=this._mipsFBOs[K];P.bindFramebuffer(b.horizontal),U.draw(),H=b.horizontal.colorTexture,P.bindFramebuffer(b.vertical),P.bindTexture(H,K+1),d.setUniform2fv("u_direction",lt),U.draw(),H=b.vertical.colorTexture,W[0]=Math.round(W[0]/2),W[1]=Math.round(W[1]/2)}P.setViewport(0,0,S,O);const q=C.getProgram(A.composite,[{name:"nummips",value:5}]);P.bindFramebuffer(this._compositeFBO),P.useProgram(q),q.setUniform1f("u_bloomStrength",z),q.setUniform1f("u_bloomRadius",B),q.setUniform1fv("u_bloomFactors",ht),q.setUniform3fv("u_bloomTintColors",ct),P.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),q.setUniform1i("u_blurTexture1",1),P.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),q.setUniform1i("u_blurTexture2",2),P.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),q.setUniform1i("u_blurTexture3",3),P.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),q.setUniform1i("u_blurTexture4",4),P.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),q.setUniform1i("u_blurTexture5",5),U.draw(),P.bindFramebuffer(b),P.setBlendingEnabled(!0);const Y=C.getProgram(A.blit);P.useProgram(Y),P.bindTexture(this._compositeFBO.colorTexture,6),Y.setUniform1i("u_texture",6),P.setBlendFunction(Se.dn.ONE,Se.dn.ONE),U.draw(),U.unbind(),P.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),P.setStencilTestEnabled(!0)}_createOrResizeResources(d,b,M){const{context:S}=d;if(this._compositeFBO&&this._size[0]===b&&this._size[1]===M)return;this._size[0]=b,this._size[1]=M;const O=[Math.round(b/2),Math.round(M/2)];if(this._compositeFBO)this._compositeFBO.resize(b,M);else{const d=new De.R(b,M);d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,this._compositeFBO=new at.H(S,d)}if(this._intensityFBO)this._intensityFBO.resize(O[0],O[1]);else{const d=new De.R(O[0],O[1]);d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,this._intensityFBO=new at.H(S,d)}for(let P=0;P<this._nMips;P++){if(this._mipsFBOs[P])this._mipsFBOs[P].horizontal.resize(O[0],O[1]),this._mipsFBOs[P].vertical.resize(O[0],O[1]);else{const d=new De.R(O[0],O[1]);d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,this._mipsFBOs[P]={horizontal:new at.H(S,d),vertical:new at.H(S,d)}}O[0]=Math.round(O[0]/2),O[1]=Math.round(O[1]/2)}}}const ut=[1,0],dt=[0,1];class Blur_u{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(d,b,M){const{context:S}=d,{type:O,radius:P}=M;if(0===P)return;this._createOrResizeResources(d),this._quad||(this._quad=new Xe.A(S,[-1,-1,1,-1,-1,1,1,1]));const T=this._quad;T.bind(),"blur"===O?this._gaussianBlur(d,b,P):this._radialBlur(d,b),T.unbind()}_gaussianBlur(d,b,M){const{context:S,state:O,painter:P,pixelRatio:T}=d,{size:C}=O,{materialManager:E}=P,A=this._programDesc,z=this._quad,B=[Math.round(T*C[0]),Math.round(T*C[1])],I=this._blurFBO,U=E.getProgram(A.gaussianBlur,[{name:"radius",value:Math.ceil(M)}]);S.useProgram(U),S.setBlendingEnabled(!1),S.bindFramebuffer(I),S.bindTexture(b.colorTexture,4),U.setUniform1i("u_colorTexture",4),U.setUniform2fv("u_texSize",B),U.setUniform2fv("u_direction",ut),U.setUniform1f("u_sigma",M),z.draw(),S.bindFramebuffer(b),S.setStencilWriteMask(0),S.setStencilTestEnabled(!1),S.setDepthWriteEnabled(!1),S.setDepthTestEnabled(!1),S.bindTexture(null===I||void 0===I?void 0:I.colorTexture,5),U.setUniform1i("u_colorTexture",5),U.setUniform2fv("u_direction",dt),z.draw(),S.setBlendingEnabled(!0),S.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),S.setStencilTestEnabled(!0)}_radialBlur(d,b){const{context:M,painter:S}=d,{materialManager:O}=S,P=this._programDesc,T=this._quad,C=this._blurFBO;M.bindFramebuffer(C);const E=O.getProgram(P.radialBlur);M.useProgram(E),M.setBlendingEnabled(!1),M.bindTexture(b.colorTexture,4),E.setUniform1i("u_colorTexture",4),T.draw(),M.bindFramebuffer(b),M.setStencilWriteMask(0),M.setStencilTestEnabled(!1),M.setDepthWriteEnabled(!1),M.setDepthTestEnabled(!1),M.setBlendingEnabled(!0);const A=O.getProgram(P.blit);M.useProgram(A),M.bindTexture(null===C||void 0===C?void 0:C.colorTexture,5),A.setUniform1i("u_texture",5),M.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),T.draw()}_createOrResizeResources(d){const{context:b,state:M,pixelRatio:S}=d,{size:O}=M,P=Math.round(S*O[0]),T=Math.round(S*O[1]);if(!this._blurFBO||this._size[0]!==P||this._size[1]!==T)if(this._size[0]=P,this._size[1]=T,this._blurFBO)this._blurFBO.resize(P,T);else{const d=new De.R(P,T);d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,this._blurFBO=new at.H(b,d)}}}class Colorize_n{constructor(){this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture=(0,P.WD)(this._layerFBOTexture)}draw(d,b,M){const{width:S,height:O}=b;this._createOrResizeResources(d,S,O);const{context:P,painter:T}=d,{materialManager:C}=T,E=this._programDesc,A=this._quad,z=M.colorMatrix;A.bind();const B=this._layerFBOTexture;P.bindFramebuffer(b),b.copyToTexture(0,0,S,O,0,0,B),P.setBlendingEnabled(!1),P.setStencilTestEnabled(!1);const I=C.getProgram(E);P.useProgram(I),P.bindTexture(B,2),I.setUniformMatrix4fv("u_coefficients",z),I.setUniform1i("u_colorTexture",2),A.draw(),P.setBlendingEnabled(!0),P.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),P.setStencilTestEnabled(!0),A.unbind()}_createOrResizeResources(d,b,M){const{context:S}=d;if(!this._layerFBOTexture||this._size[0]!==b||this._size[1]!==M){if(this._size[0]=b,this._size[1]=M,this._layerFBOTexture)this._layerFBOTexture.resize(b,M);else{const d=new De.R;d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,d.width=b,d.height=M,this._layerFBOTexture=new Ie.g(S,d)}this._quad||(this._quad=new Xe.A(S,[-1,-1,1,-1,-1,1,1,1]))}}}const _t=[1,0],pt=[0,1];class DropShadow_{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=(0,P.WD)(this._layerFBOTexture),this._horizontalBlurFBO=(0,P.WD)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,P.WD)(this._verticalBlurFBO)}draw(d,b,M){const{context:S,state:O,painter:P}=d,{materialManager:T}=P,C=this._programDesc,E=b.width,A=b.height,z=[Math.round(E),Math.round(A)],{blurRadius:B,offsetX:I,offsetY:V,color:W}=M,H=[(0,U.Lz)(I),(0,U.Lz)(V)];this._createOrResizeResources(d,E,A,z);const q=this._horizontalBlurFBO,Y=this._verticalBlurFBO;S.setStencilWriteMask(0),S.setStencilTestEnabled(!1),S.setDepthWriteEnabled(!1),S.setDepthTestEnabled(!1);const K=this._layerFBOTexture;b.copyToTexture(0,0,E,A,0,0,K),this._quad||(this._quad=new Xe.A(S,[-1,-1,1,-1,-1,1,1,1])),S.setViewport(0,0,z[0],z[1]);const J=this._quad;J.bind(),S.setBlendingEnabled(!1);const Q=T.getProgram(C.blur,[{name:"radius",value:Math.ceil(B)}]);S.useProgram(Q),S.bindFramebuffer(q),S.bindTexture(b.colorTexture,4),Q.setUniform1i("u_colorTexture",4),Q.setUniform2fv("u_texSize",z),Q.setUniform2fv("u_direction",_t),Q.setUniform1f("u_sigma",B),J.draw(),S.bindFramebuffer(Y),S.bindTexture(null===q||void 0===q?void 0:q.colorTexture,5),Q.setUniform1i("u_colorTexture",5),Q.setUniform2fv("u_direction",pt),J.draw(),S.bindFramebuffer(b),S.setViewport(0,0,E,A);const Z=T.getProgram(C.composite);S.useProgram(Z),S.bindTexture(null===Y||void 0===Y?void 0:Y.colorTexture,2),Z.setUniform1i("u_blurTexture",2),S.bindTexture(K,3),Z.setUniform1i("u_layerFBOTexture",3),Z.setUniform4fv("u_shadowColor",[W[3]*(W[0]/255),W[3]*(W[1]/255),W[3]*(W[2]/255),W[3]]),Z.setUniformMatrix3fv("u_displayViewMat3",O.displayMat3),Z.setUniform2fv("u_shadowOffset",H),J.draw(),S.setBlendingEnabled(!0),S.setStencilTestEnabled(!0),S.setBlendFunction(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),J.unbind()}_createOrResizeResources(d,b,M,S){const{context:O}=d;if(!this._horizontalBlurFBO||this._size[0]!==b||this._size[1]!==M){if(this._size[0]=b,this._size[1]=M,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(S[0],S[1]);else{const d=new De.R(S[0],S[1]);d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,this._horizontalBlurFBO=new at.H(O,d)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(S[0],S[1]);else{const d=new De.R(S[0],S[1]);d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,this._verticalBlurFBO=new at.H(O,d)}if(this._layerFBOTexture)this._layerFBOTexture.resize(b,M);else{const d=new De.R;d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,d.width=b,d.height=M,this._layerFBOTexture=new Ie.g(O,d)}}}}class Opacity_l{constructor(){this._size=[0,0],this._layerFBOTexture=null}dispose(){this._layerFBOTexture=(0,P.WD)(this._layerFBOTexture)}draw(d,b,M){const{width:S,height:O}=b;this._createOrResizeResources(d,S,O);const{context:P,painter:T}=d,{amount:C}=M,E=P.gl,A=this._layerFBOTexture;P.bindFramebuffer(b),b.copyToTexture(0,0,S,O,0,0,A),P.setBlendingEnabled(!0),P.setStencilTestEnabled(!1),P.setDepthTestEnabled(!1),P.setClearColor(0,0,0,0),P.clear(E.COLOR_BUFFER_BIT),T.blitTexture(P,A,Se.Cj.NEAREST,C)}_createOrResizeResources(d,b,M){const{context:S}=d;if(!this._layerFBOTexture||this._size[0]!==b||this._size[1]!==M)if(this._size[0]=b,this._size[1]=M,this._layerFBOTexture)this._layerFBOTexture.resize(b,M);else{const d=new De.R;d.internalFormat=Se.Ab.RGBA,d.wrapMode=Se.pF.CLAMP_TO_EDGE,d.samplingMode=Se.Cj.NEAREST,d.width=b,d.height=M,this._layerFBOTexture=new Ie.g(S,d)}}}function EffectManager_c(d){switch(d){case"bloom":case"blur":case"opacity":case"drop-shadow":return d;default:return"colorize"}}const mt={colorize:()=>new Colorize_n,blur:()=>new Blur_u,bloom:()=>new Bloom_h,opacity:()=>new Opacity_l,"drop-shadow":()=>new DropShadow_};class EffectManager_i{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach((d=>d.dispose())),this._effectMap.clear()}getPostProcessingEffects(d){if(!d||0===d.length)return[];const b=[];for(const M of d){const d=EffectManager_c(M.type);let S=this._effectMap.get(d);S||(S=mt[d](),this._effectMap.set(d,S)),b.push({postProcessingEffect:S,effect:M})}return b}}var ft=M(16842);class RenderPass_t{constructor(d,b){var M;this.brushes=d,this.name=b.name,this.drawPhase=b.drawPhase||le.S5.MAP,this._targetFn=b.target,this.effects=b.effects||[],this.enableDefaultDraw=null!==(M=b.enableDefaultDraw)&&void 0!==M?M:()=>!0,this.forceDrawByDisplayOrder=!!b.forceDrawByDisplayOrder}render(d){const{context:b,profiler:M}=d,S=this._targetFn(),O=this.drawPhase&d.drawPhase;if(M.recordPassStart(this.name),O){this.enableDefaultDraw()&&this._doRender(d,S),M.recordPassEnd();for(const M of this.effects){var P;if(!M.enable())continue;const O=M.apply,T=null===(P=M.args)||void 0===P?void 0:P.call(M),C=b.getViewport(),E=b.getBoundFramebufferObject(),A=d.passOptions;this._bindEffect(d,O,T),this._doRender(d,S,O.defines),this._drawAndUnbindEffect(d,O,C,E,A,T)}}}_doRender(d,b,M){if(null==b)return;const{profiler:S,context:O}=d;for(const P of this.brushes){if(S.recordBrushStart(P.name),null!=P.brushEffect){const S=O.getViewport(),T=O.getBoundFramebufferObject(),C=d.passOptions;this._bindEffect(d,P.brushEffect),this._drawWithBrush(P,d,b,M),this._drawAndUnbindEffect(d,P.brushEffect,S,T,C)}else this._drawWithBrush(P,d,b,M);S.recordBrushEnd()}}_drawWithBrush(d,b,M,S){(0,ft.Xj)(M)?(d.prepareState(b,S),d.drawMany(b,M,S)):M.visible&&(d.prepareState(b,S),d.draw(b,M,S))}_bindEffect(d,b,M){const{profiler:S}=d;S.recordPassStart(this.name+"."+b.name),b.bind(d,M);const O=b.createOptions(d,M);d.passOptions=O}_drawAndUnbindEffect(d,b,M,S,O,P){const{profiler:T,context:C}=d;d.passOptions=O,T.recordBrushStart(b.name),b.draw(d,P),b.unbind(d,P),C.bindFramebuffer(S);const{x:E,y:A,width:z,height:B}=M;C.setViewport(E,A,z,B),T.recordBrushEnd(),T.recordPassEnd()}}class TechniqueProgramCache_r{constructor(){this._programCache=new Map}destroy(){for(const d of this._programCache.values())d.destroy();this._programCache.clear()}getProgram(d,b,M,S,O){const P=d.getShaderKey(b,M,S,O);let T=this._programCache.get(P);return T||(T=d.getProgram(b,M,S,O),this._programCache.set(P,T)),T}}var gt=M(11897);class D{constructor(d,b){this.context=d,this._currentPipelineStateNeedsUpdate=!1,this._blitRenderer=new _,this._worldExtentRenderer=new u,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new p,this._blendEffect=new m,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new HighlightEffect_l,hittest:new HittestEffect_n,hittestVTL:new HittestEffectVTL_r,integrate:new AnimationEffect_i,insideEffect:new FeatureEffect_s("inside"),outsideEffect:new FeatureEffect_s("outside")},this._programCache=new TechniqueProgramCache_r,this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1},this.materialManager=new MaterialManager_e(d),this.textureManager=new k(b),this.textureUploadManager=new TextureUploadManager_r(b),this._effectsManager=new EffectManager_i,this._quadMesh=new Xe.A(d,[0,0,1,0,0,1,1,1])}dispose(){if(this._programCache.destroy(),this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,P.WD)(this._blitRenderer),this._worldExtentRenderer=(0,P.WD)(this._worldExtentRenderer),this._quadMesh.dispose(),this._brushCache&&(this._brushCache.forEach((d=>d.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos){let d;for(d in this._fbos)this._fbos[d]&&this._fbos[d].dispose()}for(const d of this._fboPool)d.dispose();if(this._fboPool.length=0,this.effects){let d;for(d in this.effects)this.effects[d]&&this.effects[d].dispose()}this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=(0,P.WD)(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy(),this._programCache=new TechniqueProgramCache_r}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getFbos(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(d,b){let M;if(this._fboPool.length>0)M=this._fboPool.pop();else{const S=new De.R(d,b);S.samplingMode=Se.Cj.NEAREST,S.wrapMode=Se.pF.CLAMP_TO_EDGE,M=new at.H(this.context,S,this._stencilBuf)}return M.width===d&&M.height===b||M.resize(d,b),M}releaseFbo(d){this._fboPool.push(d)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(d,b,M){const{context:S}=d;this._worldExtentRenderer.render(d,b,M);const{width:O,height:P}=S.getViewport();if(this.updateFBOs(O,P),this._prevFBO=S.getBoundFramebufferObject(),S.bindFramebuffer(this.getFbos().output),S.setColorMask(!0,!0,!0,!0),null!=b){const{r:d,g:M,b:O,a:P}=b;S.setClearColor(P*d/255,P*M/255,P*O/255,P)}else S.setClearColor(0,0,0,0);S.setDepthWriteEnabled(!0),S.setClearDepth(1),S.clear(S.gl.COLOR_BUFFER_BIT|S.gl.DEPTH_BUFFER_BIT),S.setDepthWriteEnabled(!1)}afterRenderPhases(d){const{context:b}=d;b.bindFramebuffer(this._prevFBO),b.setStencilFunction(Se.MT.EQUAL,1,255),b.setStencilTestEnabled(!0),b.setDepthTestEnabled(!1),this.blitTexture(b,this.getFbos().output.colorTexture,Se.Cj.NEAREST)}beforeRenderLayer(d,b,M){const{context:S,blendMode:O,effects:P,drawPhase:T,requireFBO:C}=d;if(C||x(T,O,P,M)){const d=S.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(d);const{width:b,height:M}=S.getViewport(),O=this.acquireFbo(b,M);S.bindFramebuffer(O),S.setColorMask(!0,!0,!0,!0),S.setClearColor(0,0,0,0),S.setDepthWriteEnabled(!0),S.setClearDepth(1),S.clear(S.gl.COLOR_BUFFER_BIT|S.gl.DEPTH_BUFFER_BIT),S.setDepthWriteEnabled(!1)}S.setDepthWriteEnabled(!1),S.setDepthTestEnabled(!1),S.setStencilTestEnabled(!0),S.setClearStencil(b),S.setStencilWriteMask(255),S.clear(S.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(d,b){const{context:M,blendMode:S,effects:O,requireFBO:P,drawPhase:T}=d;if(P||x(T,S,O,b)){const P=M.getBoundFramebufferObject();null!=O&&O.length>0&&T===le.S5.MAP&&(M.setColorMask(!0,!0,!0,!0),this._applyEffects(d,O,P)),M.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),M.setStencilTestEnabled(!1),M.setStencilWriteMask(0),M.setBlendingEnabled(!0),M.setBlendFunctionSeparate(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA,Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),M.setColorMask(!0,!0,!0,!0);const C=null==S||T===le.S5.HIGHLIGHT?"normal":S;this._blendEffect.draw(d,P.colorTexture,Se.Cj.NEAREST,C,b),this.releaseFbo(P)}}renderObject(d,b,M,S){const O=he.d[M];if(!O)return;let P=this._brushCache.get(O);void 0===P&&(P=new O,this._brushCache.set(O,P)),P.prepareState(d),P.draw(d,b,S)}renderObjects(d,b,M,S){const O=he.d[M];if(!O)return;let P=this._brushCache.get(O);void 0===P&&(P=new O,this._brushCache.set(O,P)),P.drawMany(d,b,S)}registerRenderPass(d){const b=d.brushes.map((d=>(this._brushCache.has(d)||this._brushCache.set(d,new d),this._brushCache.get(d))));return new RenderPass_t(b,d)}blitTexture(d,b,M){let S=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;d.setBlendingEnabled(!0),d.setBlendFunctionSeparate(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA,Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA),d.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(d,b,M,S),this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(d){return this._effectsManager.getPostProcessingEffects(d)}updateFBOs(d,b){if(d!==this._lastWidth||b!==this._lastHeight){if(this._lastWidth=d,this._lastHeight=b,this._fbos){let M;for(M in this._fbos)this._fbos[M].resize(d,b);return}const M=new De.R(d,b);M.samplingMode=Se.Cj.NEAREST,M.wrapMode=Se.pF.CLAMP_TO_EDGE;const S=new nt.q(Se.yQ.DEPTH_STENCIL,d,b);this._stencilBuf=new gt.l(this.context,S),this._fbos={output:new at.H(this.context,M,this._stencilBuf),effect0:new at.H(this.context,M,this._stencilBuf)}}}_applyEffects(d,b,M){const{context:S}=d,O=this._effectsManager.getPostProcessingEffects(b);for(const{postProcessingEffect:P,effect:T}of O)S.bindFramebuffer(M),P.draw(d,M,T);this._currentPipelineStateNeedsUpdate=!0}setShader(d){var b;this._shaderState.shader=d.shader,this._shaderState.uniforms=d.uniforms,this._shaderState.defines=d.defines,this._shaderState.optionalAttributes=d.optionalAttributes,this._shaderState.useComputeBuffer=null!==(b=d.useComputeBuffer)&&void 0!==b&&b}setPipelineState(d){d!==this._currentPipelineState&&(this._currentPipelineState=d,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(d,b){const{instance:M}=b,S=M.instanceId,{shader:O,uniforms:P,defines:T,optionalAttributes:C,useComputeBuffer:E}=this._shaderState,A=b.target.getMesh(S),z={useComputeBuffer:E,locationInfo:O.locationInfo,computeAttributeMap:O.computeAttributes},B=A.getLayout(z);if(null==B)return null;const{primitive:I,count:U,offset:V}=A.getDrawArgs(Se.WR.TRIANGLES,b.count,b.start*Uint32Array.BYTES_PER_ELEMENT,E),W=this._programCache.getProgram(O,B,P,null!==T&&void 0!==T?T:{},null!==C&&void 0!==C?C:{});W.setUniforms(P),W.bind(d),this.updatePipelineState(d),this._updateStencilRef(d,b.target);const H=A.getVAO(d,O.locationInfo,z);return d.bindVAO(H),d.drawElements(I,U,Se.pe.UNSIGNED_INT,V),d.bindVAO(null),W.cleanupTemporaryTextures(),{vertexShader:W.vertexShader,fragmentShader:W.fragmentShader}}submitDrawQuad(d){const{shader:b,uniforms:M,defines:S,optionalAttributes:O}=this._shaderState,P=this._programCache.getProgram(b,this._quadMesh.layout,M,null!==S&&void 0!==S?S:{},null!==O&&void 0!==O?O:{});P.setUniforms(M),P.bind(d),this.updatePipelineState(d),this._updateStencilRef(d,null),this._quadMesh.draw(),d.bindVAO(null),P.cleanupTemporaryTextures()}submitDrawMesh(d,b,M){const{shader:S,uniforms:O,defines:P,optionalAttributes:T}=this._shaderState,C=this._programCache.getProgram(S,b.layout,O,null!==P&&void 0!==P?P:{},null!==T&&void 0!==T?T:{});if(C.setUniforms(O),C.bind(d),this.updatePipelineState(d),this._updateStencilRef(d,null),M)for(const E of M)b.bind(d,E),b.draw(d);else for(let E=0;E<b.parts.length;E++)b.bind(d,E),b.draw(d);b.unbind(d),C.cleanupTemporaryTextures()}updatePipelineState(d){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(d))}_updatePipelineState(d){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{color:b,depth:M,stencil:S}=this._currentPipelineState;if(b){const{blendMode:M,write:S}=b;switch(d.setColorMask(...S),d.setBlendingEnabled(!0),d.setBlendEquation(Se.Tb.ADD),M){case"composite":d.setBlendFunctionSeparate(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA,Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA);break;case"additive":d.setBlendFunctionSeparate(Se.dn.ONE,Se.dn.ONE,Se.dn.ONE,Se.dn.ONE);break;case"custom":{const{blendParameters:M}=b,{dstAlpha:S,dstRGB:O,srcAlpha:P,srcRGB:T}=M;d.setBlendFunctionSeparate(T,O,P,S);break}case"delete":d.setBlendEquation(Se.Tb.REVERSE_SUBTRACT),d.setBlendFunctionSeparate(Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA,Se.dn.ONE,Se.dn.ONE_MINUS_SRC_ALPHA)}}if(M){const{test:b,write:S}=M;S?(d.setDepthWriteEnabled(!0),d.setDepthRange(S.zNear,S.zFar)):d.setDepthWriteEnabled(!1),b?(d.setDepthTestEnabled(!0),d.setDepthFunction(b)):d.setDepthTestEnabled(!1)}else d.setDepthTestEnabled(!1),d.setDepthWriteEnabled(!1);if(S){const{test:b,write:M}=S;if(b){const{compare:M,mask:S,op:O,ref:P}=b;d.setStencilTestEnabled(!0),"function"!=typeof P&&d.setStencilFunctionSeparate(Se.Y7.FRONT_AND_BACK,M,P,S),d.setStencilOpSeparate(Se.Y7.FRONT_AND_BACK,O.fail,O.zFail,O.zPass)}else d.setStencilTestEnabled(!1);if(M){const{mask:b}=M;d.setStencilWriteMask(b)}else d.setStencilWriteMask(0)}else d.setStencilTestEnabled(!1),d.setStencilWriteMask(0)}_updateStencilRef(d,b){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{stencil:M}=this._currentPipelineState;if(M){const{test:S}=M;if(S){const{compare:M,mask:O,ref:P}=S;"function"==typeof P&&d.setStencilFunctionSeparate(Se.Y7.FRONT_AND_BACK,M,P(b),O)}}}}function x(d,b,M,S){return d!==le.S5.LABEL_ALPHA&&d!==le.S5.LABEL&&d!==le.S5.HIGHLIGHT&&(1!==S||null!=b&&"normal"!==b||null!=M&&M.length>0)}var vt=M(46038),yt=M(80148);class TileReshuffleManager_s{constructor(){this._candidateTiles=[]}schedule(d){this._candidateTiles.includes(d)||this._candidateTiles.push(d)}reshuffle(d){const b=[];for(const M of this._candidateTiles)d>0?(M.reshuffle(),d--):b.push(M);this._candidateTiles=b}}var bt=M(53944),wt=M(40857),xt=M(59260),Mt=M(47579),St=M(49178);class Stage_v extends ee.m{constructor(d,b){var M;super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this._renderRequested=(0,C.v)(!1),this.stage=this,this._stationary=!0,this._reshuffleManager=new TileReshuffleManager_s,this._canvas=new l(d),this.context=new Mt.e(this._canvas.gl,null!==(M=b.contextOptions)&&void 0!==M?M:{}),this.painter=new D(this.context,this),this._cimAnalyzer=new w(this.painter.textureManager.resourceManager),(0,O.A)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),d.appendChild(this._debugOutput));const a=()=>this._highlightGradient;this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:b.timeline||new wt.K,renderingOptions:b.renderingOptions,requestRender:()=>this.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new yt.U(this.context,this._debugOutput),dataUploadCounter:0,get highlightGradient(){return a()},reshuffleManager:this._reshuffleManager,backgroundColor:b.backgroundColor},this._taskHandle=(0,T.mg)({render:d=>this.renderFrame(d)}),this._taskHandle.pause(),this._lostWebGLContextHandle=this._canvas.events.on("webgl-context-lost",(d=>this.emit("webgl-error",{error:new S.A("webgl-context-lost",d.statusMessage)}))),this._bufferPool=new vt.o,(0,bt.Wn)()}destroy(){var d;(0,bt.n_)(),this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,P.xt)(this._taskHandle),this._lostWebGLContextHandle=(0,P.xt)(this._lostWebGLContextHandle),this._canvas.destroy(),null!==(d=this._debugOutput)&&void 0!==d&&null!==(d=d.parentNode)&&void 0!==d&&d.removeChild(this._debugOutput),this._bufferPool.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get textureManager(){return this.painter.textureManager}get backgroundColor(){return this._renderParameters.backgroundColor}set backgroundColor(d){this._renderParameters.backgroundColor=d,this.requestRender()}get bufferPool(){return this._bufferPool}get cimAnalyzer(){return this._cimAnalyzer}get renderingOptions(){return this._renderingOptions}set renderingOptions(d){this._renderingOptions=d,this.requestRender()}get renderRequested(){return this._renderRequested.value}get state(){return this._state}set state(d){this._state=d,this.requestRender()}get stationary(){return this._stationary}set stationary(d){this._stationary!==d&&(this._stationary=d,this.requestRender())}trashDisplayObject(d){this._trash.add(d),this.requestRender()}untrashDisplayObject(d){return this._trash.delete(d)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}renderFrame(d){const b=this._lastFrameRenderTime?d.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=b,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=d.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=d.time,this._renderParameters.deltaTime=d.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}_createTransforms(){return{displayViewScreenMat3:(0,E.vt)()}}renderChildren(d){for(const b of this.children)b.beforeRender(d);this._reshuffleManager.reshuffle(Z.O5),this._canvas.render(d,(()=>this._renderChildren(this.children,d)));for(const b of this.children)b.afterRender(d)}_renderChildren(d,b){const M=this.context;this.painter.textureUploadManager.upload(),M.resetInfo(),b.profiler.recordStart("drawLayers"),b.dataUploadCounter=0,this.painter.beforeRenderPhases(b,b.backgroundColor,this.state.padding),b.drawPhase=le.S5.MAP;for(const S of d)S.processRender(b);if(this.children.some((d=>d.hasHighlight))){b.drawPhase=le.S5.HIGHLIGHT;for(const M of d)M.processRender(b)}if(this.children.some((d=>d.hasLabels))){b.drawPhase=le.S5.LABEL;for(const M of d)M.processRender(b)}if((0,O.A)("esri-tiles-debug")){b.drawPhase=le.S5.DEBUG;for(const M of d)M.processRender(b)}this.painter.afterRenderPhases(b),b.profiler.recordEnd("drawLayers"),M.logInfo()}doRender(d){const b=this.context,{state:M,pixelRatio:S}=d;this._canvas.resize(d),b.setViewport(0,0,S*M.size[0],S*M.size[1]),b.setDepthWriteEnabled(!0),b.setStencilWriteMask(255),this.renderChildren(d)}async takeScreenshot(d,b,M,S){const O=Math.round(this.state.size[0]*d.resolutionScale),P=Math.round(this.state.size[1]*d.resolutionScale),T=d.resolutionScale,C=this.context,E=this._state.clone();if(null!=S){const d=E.viewpoint;E.viewpoint.rotation=S,E.viewpoint=d}const A={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:E,pixelRatio:T,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:M},z=new De.R(O,P);z.wrapMode=Se.pF.CLAMP_TO_EDGE,z.internalFormat=Se.H0.RGBA8,z.isImmutable=!0;const B=new at.H(C,z,new nt.q(Se.yQ.DEPTH_STENCIL,O,P)),I=C.getBoundFramebufferObject(),U=C.getViewport();C.bindFramebuffer(B),C.setViewport(0,0,O,P),this._renderChildren(null!==b&&void 0!==b?b:this.children,A);const V=this._readbackScreenshot(B,{...d.cropArea,y:P-(d.cropArea.y+d.cropArea.height)});C.bindFramebuffer(I),C.setViewport(U.x,U.y,U.width,U.height),this.requestRender();const W=await V;let H;return 1===d.outputScale?H=W:(H=new ImageData(Math.round(W.width*d.outputScale),Math.round(W.height*d.outputScale)),(0,xt.Go)(W,H,!0)),B.dispose(),H}async _readbackScreenshot(d,b){const M=(0,St.xR)(b.width,b.height,document.createElement("canvas"));return await d.readPixelsAsync(b.x,b.y,b.width,b.height,Se.Ab.RGBA,Se.ld.UNSIGNED_BYTE,new Uint8Array(M.data.buffer)),M}_emptyTrash(){for(;this._trash.size>0;){const d=Array.from(this._trash);this._trash.clear();for(const b of d)b.processDetach()}}}var Ot=M(4253),Pt=M(41096),Tt=M(44426),Ct=M(37588),Ft=M(87149),Rt=M(30073),Et=M(63390),At=M(4270),zt=M(93170),kt=M(43401),Bt=M(76547);class MagnifierView2D_A extends zt.q{constructor(){super(),this._handles=new Rt.A,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles=(0,P.pR)(this._handles),this._disposeRenderResources(),this._resourcesTask=(0,P.DC)(this._resourcesTask)}get backgroundColor(){return this._backgroundColor}set backgroundColor(d){this._backgroundColor=d,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(d){this._magnifier=d,this._handles.removeAll(),this._handles.add([(0,Et.wB)((()=>d.version),(()=>{this.visible=d.visible&&null!=d.position&&d.size>0,this.requestRender()}),Et.Vh),(0,Et.wB)((()=>[d.maskUrl,d.overlayUrl]),(()=>this._reloadResources())),(0,Et.wB)((()=>d.size),(()=>{this._disposeRenderResources(),this.requestRender()}))])}_createTransforms(){return{displayViewScreenMat3:(0,E.vt)()}}doRender(d){const b=d.context;if(!this._resourcesTask)return void this._reloadResources();if(d.drawPhase!==le.S5.MAP||!this._canRender())return;this._updateResources(d);const M=this._magnifier;if(null==M.position)return;const S=d.pixelRatio,O=M.size*S,P=1/M.factor,T=Math.ceil(P*O);this._readbackTexture.resize(T,T);const{size:C}=d.state,E=S*C[0],A=S*C[1],z=.5*T,B=.5*T,I=(0,se.qE)(S*M.position.x,z,E-z-1),U=(0,se.qE)(A-S*M.position.y,B,A-B-1);b.setBlendingEnabled(!0);const V=I-z,W=U-B,H=this._readbackTexture;b.bindTexture(H,0),b.gl.copyTexImage2D(H.descriptor.target,0,H.descriptor.pixelFormat,V,W,T,T,0);const q=this.backgroundColor,Y=q?[q.a*q.r/255,q.a*q.g/255,q.a*q.b/255,q.a]:[1,1,1,1],K=(I+M.offset.x*S)/E*2-1,J=(U-M.offset.y*S)/A*2-1,Q=O/E*2,Z=O/A*2,ee=this._program;b.bindVAO(this._vertexArrayObject),b.bindTexture(this._overlayTexture,6),b.bindTexture(this._maskTexture,7),b.useProgram(ee),ee.setUniform4fv("u_background",Y),ee.setUniform1i("u_readbackTexture",0),ee.setUniform1i("u_overlayTexture",6),ee.setUniform1i("u_maskTexture",7),ee.setUniform4f("u_drawPos",K,J,Q,Z),ee.setUniform1i("u_maskEnabled",M.maskEnabled?1:0),ee.setUniform1i("u_overlayEnabled",M.overlayEnabled?1:0),b.setStencilTestEnabled(!1),b.setColorMask(!0,!0,!0,!0),b.drawArrays(Se.WR.TRIANGLE_STRIP,0,4),b.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const d=null!=this._magnifier?this._magnifier.maskUrl:null,b=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=(0,Ft.UT)((async S=>{const O=null==d||null==b?async function resources_s(d){const b=M.e(5359).then(M.bind(M,37740)),S=M.e(7209).then(M.bind(M,47209)),O=(0,Bt.D)((await b).default,{signal:d}),P=(0,Bt.D)((await S).default,{signal:d}),T={mask:await O,overlay:await P};return(0,Ee.Te)(d),T}(S):null,P=null!=d?(0,Fe.A)(d,{responseType:"image",signal:S}).then((d=>d.data)):O.then((d=>d.mask)),T=null!=b?(0,Fe.A)(b,{responseType:"image",signal:S}).then((d=>d.data)):O.then((d=>d.overlay)),[C,E]=await Promise.all([P,T]);this.mask=C,this.overlay=E,this._disposeRenderResources(),this.requestRender()}))}_disposeRenderResources(){this._readbackTexture=(0,P.WD)(this._readbackTexture),this._overlayTexture=(0,P.WD)(this._overlayTexture),this._maskTexture=(0,P.WD)(this._maskTexture),this._vertexArrayObject=(0,P.WD)(this._vertexArrayObject),this._program=(0,P.WD)(this._program)}_updateResources(d){if(d.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const b=d.context;this._resourcePixelRatio=d.pixelRatio;const M=Math.ceil(this._magnifier.size*d.pixelRatio);this._program=(0,kt.h)(b);const S=new Uint16Array([0,1,0,0,1,1,1,0]),O=kt.j.attributes;this._vertexArrayObject=new Pe.Z(b,O,we.VS,{geometry:Me.g.createVertex(b,Se._U.STATIC_DRAW,S)}),this.overlay.width=M,this.overlay.height=M;const P=new De.R;P.internalFormat=Se.Ab.RGBA,P.wrapMode=Se.pF.CLAMP_TO_EDGE,P.samplingMode=Se.Cj.NEAREST,P.flipped=!0,P.preMultiplyAlpha=!(0,At.XJ)(this.overlay.src)||!d.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new Ie.g(b,P,this.overlay),this.mask.width=M,this.mask.height=M,P.pixelFormat=P.internalFormat=Se.Ab.ALPHA,this._maskTexture=new Ie.g(b,P,this.mask);const T=1/this._magnifier.factor;P.pixelFormat=P.internalFormat=Se.Ab.RGBA,P.width=P.height=Math.ceil(T*M),P.samplingMode=Se.Cj.LINEAR,P.flipped=!1,this._readbackTexture=new Ie.g(b,P)}}}}]);
//# sourceMappingURL=7801.a900a757.chunk.js.map