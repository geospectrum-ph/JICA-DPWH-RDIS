"use strict";(self.webpackChunkSEEDs_v2_0_Client=self.webpackChunkSEEDs_v2_0_Client||[]).push([[2207,5059],{91003:(R,G,H)=>{H.d(G,{b:()=>i});const W=2654435761,q=2246822519,Q=3266489917,J=668265263,X=374761393;function h(R){const G=[];for(let H=0,W=R.length;H<W;H++){let W=R.charCodeAt(H);W<128?G.push(W):W<2048?G.push(192|W>>6,128|63&W):W<55296||W>=57344?G.push(224|W>>12,128|W>>6&63,128|63&W):(H++,W=65536+((1023&W)<<10|1023&R.charCodeAt(H)),G.push(240|W>>18,128|W>>12&63,128|W>>6&63,128|63&W))}return new Uint8Array(G)}class i{constructor(R){this._seed=R,this._totallen=0,this._bufs=[],this.init()}init(){return this._bufs=[],this._totallen=0,this}updateFloatArray(R){const G=[];for(const H of R)isNaN(H)?G.push("NaN"):H===1/0?G.push("Infinity"):H===-1/0?G.push("-Infinity"):0===H?G.push("0"):G.push(H.toString(16));this.update(h(G.join("")))}updateIntArray(R){const G=Int32Array.from(R);this.update(new Uint8Array(G.buffer))}updateUint8Array(R){this.update(Uint8Array.from(R))}updateWithString(R){return this.update(h(R))}update(R){return this._bufs.push(R),this._totallen+=R.length,this}digest(){const R=new Uint8Array(this._totallen);let G=0;for(const H of this._bufs)R.set(H,G),G+=H.length;return this.init(),this._xxHash32(R,this._seed)}_xxHash32(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const H=R;let $=G+X&4294967295,K=0;if(H.length>=16){const H=[G+W+q&4294967295,G+q&4294967295,G+0&4294967295,G-W&4294967295],Q=R,J=Q.length-16;let X=0;for(K=0;(4294967280&K)<=J;K+=4){const R=K,G=Q[R]+(Q[R+1]<<8),J=Q[R+2]+(Q[R+3]<<8),$=G*q+(J*q<<16);let ee=H[X]+$&4294967295;ee=ee<<13|ee>>>19;const te=65535&ee,ie=ee>>>16;H[X]=te*W+(ie*W<<16)&4294967295,X=X+1&3}$=(H[0]<<1|H[0]>>>31)+(H[1]<<7|H[1]>>>25)+(H[2]<<12|H[2]>>>20)+(H[3]<<18|H[3]>>>14)&4294967295}$=$+R.length&4294967295;const ee=R.length-4;for(;K<=ee;K+=4){const R=K,G=H[R]+(H[R+1]<<8),W=H[R+2]+(H[R+3]<<8);$=$+(G*Q+(W*Q<<16))&4294967295,$=$<<17|$>>>15,$=(65535&$)*J+(($>>>16)*J<<16)&4294967295}for(;K<H.length;++K)$+=H[K]*X,$=$<<11|$>>>21,$=(65535&$)*W+(($>>>16)*W<<16)&4294967295;return $^=$>>>15,$=((65535&$)*q&4294967295)+(($>>>16)*q<<16),$^=$>>>13,$=((65535&$)*Q&4294967295)+(($>>>16)*Q<<16),$^=$>>>16,$<0?$+4294967296:$}}},41035:(R,G,H)=>{H.d(G,{C:()=>Se,b:()=>w});var W,q,Q,J,X,$,K,ee,te,ie,re=H(57528),ne=H(18852),se=H(32573),ae=H(41933),oe=H(51291),le=H(95688),ce=H(43046),de=H(28463),he=H(88636),ue=H(82993),pe=H(89651),_e=H(39059),me=H(44187),ge=H(38013),fe=H(50390),ye=H(96767),ve=H(94539),be=H(62301),xe=H(64286);function w(R){const G=new ve.N5,{vertex:H,fragment:Se,attributes:Ce,varyings:we}=G;(0,ge.NB)(H,R),G.include(oe.d,R),G.include(ce.c,R),G.include(pe.A,R),G.include(le.g,R),Ce.add(xe.r.POSITION,"vec3"),R.vvColor&&Ce.add(xe.r.COLORFEATUREATTRIBUTE,"float"),we.add("vColor","vec4"),we.add("vpos","vec3");const Ae=R.multipassEnabled&&(R.output===se.V.Color||R.output===se.V.Alpha);Ae&&we.add("depth","float"),H.uniforms.add(new fe.E("eColor",(R=>R.color)));const Re=R.output===se.V.LinearDepth;Re&&(G.include(de.L,R),(0,ne.xJ)(G),(0,ne.Mu)(G)),H.code.add((0,ye.H)(W||(W=(0,re.A)(["\n    void main(void) {\n      vpos = position;\n      forwardNormalizedVertexColor();\n      forwardObjectAndLayerIdColor();\n\n      ","\n      ","\n      gl_Position = ","\n    }\n  "])),R.hasVertexColors?"vColor *= eColor;":R.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;",Ae?"depth = (view * vec4(vpos, 1.0)).z;":"",Re?(0,ye.H)(q||(q=(0,re.A)(["transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);"]))):(0,ye.H)(Q||(Q=(0,re.A)(["transformPosition(proj, view, vpos);"]))))),G.include(ae.HQ,R),Ae&&G.include(ue.Q,R),Se.include(me.a);const Te=R.output===se.V.Highlight;return Te&&G.include(he.Qh,R),Se.code.add((0,ye.H)(J||(J=(0,re.A)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n    vec4 fColor = vColor;\n\n    ","\n\n    if (fColor.a < ",") {\n      discard;\n    }\n\n    ","\n\n    ","\n    ",";\n    ",";\n    ","\n  }\n  "])),Ae?"terrainDepthTest(depth);":"",R.output===se.V.ObjectAndLayerIdColor?(0,ye.H)(X||(X=(0,re.A)(["fColor.a = 1.0;"]))):"",ye.H.float(_e.y),R.output===se.V.Alpha?(0,ye.H)($||($=(0,re.A)(["fragColor = vec4(fColor.a);"]))):"",R.output===se.V.Color?(0,ye.H)(K||(K=(0,re.A)(["fragColor = highlightSlice(fColor, vpos); ",""])),R.transparencyPassType===be.y.Color?"fragColor = premultiplyAlpha(fragColor);":""):"",Te?(0,ye.H)(ee||(ee=(0,re.A)(["outputHighlight();"]))):"",R.output===se.V.LinearDepth?(0,ye.H)(te||(te=(0,re.A)(["outputDepth(linearDepth);"]))):"",R.output===se.V.ObjectAndLayerIdColor?(0,ye.H)(ie||(ie=(0,re.A)(["outputObjectAndLayerIdColor();"]))):"")),G}const Se=Object.freeze(Object.defineProperty({__proto__:null,build:w},Symbol.toStringTag,{value:"Module"}))},71517:(R,G,H)=>{H.d(G,{H:()=>He,b:()=>F,c:()=>D});var W,q,Q,J,X,$,K,ee,te,ie,re,ne,se,ae,oe,le,ce,de,he,ue,pe,_e,me=H(57528),ge=H(37131),fe=H(52273),ye=H(40727),ve=H(32573),be=H(41933),xe=H(95688),Se=H(76504),Ce=H(45526),we=H(85568),Ae=H(55454),Re=H(88636),Te=H(89651),Ee=H(39059),Oe=H(44187),Pe=H(39313),Me=H(85729),Ie=H(38013),De=H(69460),Le=H(50390),Fe=H(3878),Ne=H(96767),Ve=H(94539),Ue=H(34343),Ge=H(62301),ze=H(64286);function F(R){const G=new Ve.N5,H=R.signedDistanceFieldEnabled;if(G.include(Ce.Q,R),G.include(be.HQ,R),R.occlusionPass)return G.include(we.I,R),G;const{vertex:fe,fragment:He}=G;G.include(Me.Y6),He.include(Pe.W),He.include(Oe.a),G.include(Te.A,R),G.include(xe.g,R),G.include(Ae.y),G.varyings.add("vcolor","vec4"),G.varyings.add("vtc","vec2"),G.varyings.add("vsize","vec2"),G.varyings.add("voccluded","float"),fe.uniforms.add(new Le.E("viewport",((R,G)=>G.camera.fullViewport)),new De.G("screenOffset",((R,G)=>(0,ge.hZ)(Be,2*R.screenOffset[0]*G.camera.pixelRatio,2*R.screenOffset[1]*G.camera.pixelRatio))),new De.G("anchorPosition",(R=>D(R))),new Le.E("materialColor",(R=>R.color))),(0,Ie.Nz)(fe),H&&(fe.uniforms.add(new Le.E("outlineColor",(R=>R.outlineColor))),He.uniforms.add(new Le.E("outlineColor",(R=>L(R)?R.outlineColor:ye.uY)),new Fe.m("outlineSize",(R=>L(R)?R.outlineSize:0)))),R.pixelSnappingEnabled&&fe.include(Se.K),R.hasScreenSizePerspective&&((0,Me.pM)(fe),(0,Me.OH)(fe)),R.debugDrawLabelBorder&&G.varyings.add("debugBorderCoords","vec4"),G.attributes.add(ze.r.UV0,"vec2"),G.attributes.add(ze.r.COLOR,"vec4"),G.attributes.add(ze.r.SIZE,"vec2"),G.attributes.add(ze.r.FEATUREATTRIBUTE,"vec4"),fe.code.add((0,Ne.H)(W||(W=(0,me.A)(["\n    void main(void) {\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      forwardObjectAndLayerIdColor();\n\n      if (rejectBySlice(projectAux.posModel)) {\n        // Project outside of clip plane\n        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n        return;\n      }\n      vec2 inputSize;\n      ","\n\n      ","\n\n      vec2 combinedSize = inputSize * pixelRatio;\n      vec4 quadOffset = vec4(0.0);\n      bool visible = testHUDVisibility(posProj);\n      voccluded = visible ? 0.0 : 1.0;\n    "])),R.hasScreenSizePerspective?(0,Ne.H)(q||(q=(0,me.A)(["\n            inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);\n            vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n         "]))):(0,Ne.H)(Q||(Q=(0,me.A)(["\n            inputSize = size;\n            vec2 screenOffsetScaled = screenOffset;"]))),R.vvSize?"inputSize *= vvScale(featureAttribute).xx;":""));const je=(0,Ne.H)(J||(J=(0,me.A)(["vec2 uv01 = floor(uv0);\nvec2 uv = uv0 - uv01;\nquadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;"]))),We=R.pixelSnappingEnabled?H?(0,Ne.H)(X||(X=(0,me.A)(["posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;"]))):(0,Ne.H)($||($=(0,me.A)(["posProj += quadOffset;\nif (inputSize.x == size.x) {\nposProj = alignToPixelOrigin(posProj, viewport.zw);\n}"]))):(0,Ne.H)(K||(K=(0,me.A)(["posProj += quadOffset;"])));fe.code.add((0,Ne.H)(ee||(ee=(0,me.A)(["\n    ","\n    ","\n    ","\n\n    ","\n\n    bool alphaDiscard = vcolor.a < ",";\n    ",'\n    if (alphaDiscard) {\n      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent\n      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n      return;\n    } else {\n      ',"\n      gl_Position = posProj;\n    }\n\n    vtc = uv;\n\n    ","\n    vsize = inputSize;\n    ","\n  }\n  "])),R.occlusionTestEnabled?"if (visible) {":"",je,R.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;",R.output===ve.V.ObjectAndLayerIdColor?(0,Ne.H)(te||(te=(0,me.A)(["vcolor.a = 1.0;"]))):"",Ne.H.float(Ee.y),H?"alphaDiscard = alphaDiscard && outlineColor.a < ".concat(Ne.H.float(Ee.y),";"):"",We,R.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":"",R.occlusionTestEnabled?(0,Ne.H)(ie||(ie=(0,me.A)(["} else { vtc = vec2(0.0);\n      ",""])),R.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"):"")),He.uniforms.add(new Ue.N("tex",(R=>R.texture)));const ke=R.debugDrawLabelBorder?(0,Ne.H)(re||(re=(0,me.A)(["(isBorder > 0.0 ? 0.0 : ",")"])),Ne.H.float(Ee.H)):Ne.H.float(Ee.H),qe=(0,Ne.H)(ne||(ne=(0,me.A)(["\n    ","\n\n    ","\n\n    ","\n\n    // Draw debug border with transparency, so that original texels along border are still partially visible\n    ","\n  "])),R.debugDrawLabelBorder?(0,Ne.H)(se||(se=(0,me.A)(["\n      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));"]))):"",R.sampleSignedDistanceFieldTexelCenter?(0,Ne.H)(ae||(ae=(0,me.A)(["\n      // Attempt to sample texel centers to avoid that thin cross outlines\n      // disappear with large symbol sizes.\n      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041\n      float txSize = float(textureSize(tex, 0).x);\n      float texelSize = 1.0 / txSize;\n\n      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel\n      vec2 scaleFactor = (vsize - txSize) * texelSize;\n      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;\n      "]))):(0,Ne.H)(oe||(oe=(0,me.A)(["\n      vec2 samplePos = vtc;\n      "]))),H?(0,Ne.H)(le||(le=(0,me.A)(["\n      vec4 fillPixelColor = vcolor;\n\n      // Get distance and map it into [-0.5, 0.5]\n      float d = rgba2float(texture(tex, samplePos)) - 0.5;\n\n      // Distance in output units (i.e. pixels)\n      float dist = d * vsize.x;\n\n      // Create smooth transition from the icon into its outline\n      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);\n      fillPixelColor.a *= fillAlphaFactor;\n\n      if (outlineSize > 0.25) {\n        vec4 outlinePixelColor = outlineColor;\n        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);\n\n        // Create smooth transition around outline\n        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);\n        outlinePixelColor.a *= outlineAlphaFactor;\n\n        if (\n          outlineAlphaFactor + fillAlphaFactor < "," ||\n          fillPixelColor.a + outlinePixelColor.a < ","\n        ) {\n          discard;\n        }\n\n        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)\n        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);\n        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +\n          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);\n\n        fragColor = vec4(compositeColor, compositeAlpha);\n      } else {\n        if (fillAlphaFactor < ",") {\n          discard;\n        }\n\n        fragColor = premultiplyAlpha(fillPixelColor);\n      }\n\n      // visualize SDF:\n      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);\n      "])),ke,Ne.H.float(Ee.y),ke):(0,Ne.H)(ce||(ce=(0,me.A)(["\n          vec4 texColor = texture(tex, vtc, -0.5);\n          if (texColor.a < ",") {\n            discard;\n          }\n          fragColor = texColor * premultiplyAlpha(vcolor);\n          "])),ke),R.debugDrawLabelBorder?(0,Ne.H)(de||(de=(0,me.A)(["fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);"]))):"");switch(R.output){case ve.V.Color:He.code.add((0,Ne.H)(he||(he=(0,me.A)(["\n        void main() {\n          ","\n          ","\n        }"])),qe,R.transparencyPassType===Ge.y.FrontFace?"fragColor.rgb /= fragColor.a;":""));break;case ve.V.Alpha:He.code.add((0,Ne.H)(ue||(ue=(0,me.A)(["\n        void main() {\n          ","\n          fragColor = vec4(fragColor.a);\n        }"])),qe));break;case ve.V.ObjectAndLayerIdColor:He.code.add((0,Ne.H)(pe||(pe=(0,me.A)(["\n        void main() {\n          ","\n          outputObjectAndLayerIdColor();\n        }"])),qe));break;case ve.V.Highlight:He.constants.add("occludedHighlightFlag","vec4",Re.U),He.constants.add("unoccludedHighlightFlag","vec4",Re.bO),He.code.add((0,Ne.H)(_e||(_e=(0,me.A)(["\n        void main() {\n          ","\n          if (voccluded == 1.0) {\n            fragColor = occludedHighlightFlag;\n          } else {\n            fragColor = unoccludedHighlightFlag;\n          }\n        }"])),qe))}return G}function L(R){return R.outlineColor[3]>0&&R.outlineSize>0}function D(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Be;return R.textureIsSignedDistanceField?function B(R,G,H){null!=G?(0,ge.hZ)(H,R[0]*(G[2]-G[0])+G[0],R[1]*(G[3]-G[1])+G[1]):(0,ge.hZ)(H,0,0)}(R.anchorPosition,R.distanceFieldBoundingBox,G):(0,ge.C)(G,R.anchorPosition),G}const Be=(0,fe.vt)(),He=Object.freeze(Object.defineProperty({__proto__:null,build:F,calculateAnchorPosForRendering:D},Symbol.toStringTag,{value:"Module"}))},15261:(R,G,H)=>{H.d(G,{H:()=>ie,b:()=>t});var W,q,Q=H(57528),J=H(38382),X=H(73611),$=H(3878),K=H(96767),ee=H(94539),te=H(34343);function t(R){const G=new ee.N5;G.include(J.c),G.include(X.g);const{usesHalfFloat:H}=R;return G.fragment.uniforms.add(new te.N("densityMap",(R=>R.densityMap)),new te.N("tex",(R=>R.colorRamp)),new $.m("densityNormalizer",(R=>1/(R.maxDensity-R.minDensity))),new $.m("minDensity",(R=>R.minDensity)),new $.m("densityMultiplier",(R=>3/(R.searchRadius*R.searchRadius*Math.PI)))),H&&G.constants.add("compressionFactor","float",4),G.fragment.code.add((0,K.H)(W||(W=(0,Q.A)(["\n    void main() {\n      float density = texture(densityMap, uv).r * densityMultiplier",";\n      float densityRatio = (density - minDensity) * densityNormalizer;\n\n      vec4 color = texture(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));\n\n      discardOrAdjustAlpha(color);\n      fragColor = color;\n    }\n  "])),H?(0,K.H)(q||(q=(0,Q.A)([" * compressionFactor"]))):"")),G}const ie=Object.freeze(Object.defineProperty({__proto__:null,build:t},Symbol.toStringTag,{value:"Module"}))},15645:(R,G,H)=>{H.d(G,{H:()=>ne,b:()=>t});var W,q,Q,J,X,$=H(57528),K=H(38013),ee=H(3878),te=H(96767),ie=H(94539),re=H(64286);function t(R){const G=new ie.N5,{vertex:H,fragment:ne,attributes:se,varyings:ae}=G;(0,K.NB)(H,R);const{isAttributeDriven:oe,usesHalfFloat:le}=R;return se.add(re.r.POSITION,"vec3"),se.add(re.r.UV0,"vec2"),oe&&(se.add(re.r.FEATUREATTRIBUTE,"float"),ae.add("attributeValue","float")),le&&G.constants.add("compressionFactor","float",.25),ae.add("unitCirclePos","vec2"),H.uniforms.add(new ee.m("radius",((R,G)=>{let{resolutionForScale:H,searchRadius:W}=R,{camera:q,screenToWorldRatio:Q,overlayStretch:J}=G;return 2*W*(0===H?1:H/Q)*q.pixelRatio/q.fullViewport[2]/J}))),H.code.add((0,te.H)(W||(W=(0,$.A)(["\n    void main() {\n      unitCirclePos = uv0;\n\n      vec4 posProj = proj * (view * vec4(",", 1.0));\n      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);\n\n      ","\n      gl_Position = posProj + quadOffset;\n    }\n  "])),re.r.POSITION,oe?(0,te.H)(q||(q=(0,$.A)(["attributeValue = ",";"])),re.r.FEATUREATTRIBUTE):"")),ne.code.add((0,te.H)(Q||(Q=(0,$.A)(["\n    void main() {\n      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);\n      if (radiusRatioSquared > 1.0) {\n        discard;\n      }\n\n      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;\n      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared "," ",";\n      fragColor = vec4(density);\n    }\n  "])),oe?(0,te.H)(J||(J=(0,$.A)([" * attributeValue"]))):"",le?(0,te.H)(X||(X=(0,$.A)([" * compressionFactor"]))):"")),G}const ne=Object.freeze(Object.defineProperty({__proto__:null,build:t},Symbol.toStringTag,{value:"Module"}))},32343:(R,G,H)=>{H.d(G,{L:()=>xe,b:()=>S});var W,q,Q,J,X,$,K,ee,te,ie,re,ne=H(57528),se=H(37131),ae=H(52273),oe=H(40727),le=H(41933),ce=H(76504),de=H(45526),he=H(55454),ue=H(17372),pe=H(85729),_e=H(69460),me=H(50390),ge=H(3878),fe=H(96767),ye=H(94539),ve=H(64286);function S(R){const G=new ye.N5,{vertex:H,fragment:ae}=G;return H.include(ce.K),G.include(de.Q,R),G.include(le.HQ,R),G.attributes.add(ve.r.UV0,"vec2"),H.uniforms.add(new me.E("viewport",((R,G)=>G.camera.fullViewport)),new ge.m("lineSize",((R,G)=>R.size>0?Math.max(1,R.size)*G.camera.pixelRatio:0)),new _e.G("pixelToNDC",((R,G)=>(0,se.hZ)(be,2/G.camera.fullViewport[2],2/G.camera.fullViewport[3]))),new ge.m("borderSize",((R,G)=>null!=R.borderColor?G.camera.pixelRatio:0)),new _e.G("screenOffset",((R,G)=>(0,se.hZ)(be,R.horizontalScreenOffset*G.camera.pixelRatio,0)))),G.varyings.add("coverageSampling","vec4"),G.varyings.add("lineSizes","vec2"),R.multipassEnabled&&G.varyings.add("depth","float"),R.occlusionTestEnabled&&G.include(he.y),R.hasScreenSizePerspective&&(0,pe.OH)(H),H.code.add((0,fe.H)(W||(W=(0,ne.A)(["\n    void main(void) {\n      ProjectHUDAux projectAux;\n      vec4 endPoint = projectPositionHUD(projectAux);\n\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n    ","\n\n    ","\n      // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the\n      // correct depth value\n      vec3 posView = (view * vec4(position, 1.0)).xyz;\n      ","\n\n      applyHUDViewDependentPolygonOffset(centerOffsetAndDistance.w, projectAux.absCosAngle, posView);\n      vec4 startPoint = proj * vec4(posView, 1.0);\n      // Apply screen offset to both start and end point\n      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;\n      startPoint.xy += screenOffsetNorm * startPoint.w;\n      endPoint.xy += screenOffsetNorm * endPoint.w;\n      // Align start and end to pixel origin\n      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);\n      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);\n    ","\n      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);\n      // The direction of the line in screen space\n      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);\n      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);\n    ","\n      float halfPixelSize = lineSizeScaled * 0.5;\n\n      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size\n      float padding = 1.0 + borderSizeScaled;\n      vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;\n\n      // Offset x/y from the center of the line in screen space\n      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;\n\n      // Compute a coverage varying which we can use in the fragment shader to determine\n      // how much a pixel is actually covered by the line (i.e. to anti alias the line).\n      // This works by computing two coordinates that can be linearly interpolated and then\n      // subtracted to find out how far away from the line edge we are.\n      float edgeDirection = (uv0.x * 2.0 - 1.0);\n\n      float halfBorderSize = 0.5 * borderSizeScaled;\n      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;\n      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);\n\n      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);\n\n      coverageSampling = vec4(\n        // Edge coordinate\n        outerEdgeCoverageSampler,\n\n        // Border edge coordinate\n        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,\n\n        // Line offset\n        halfPixelSize - 0.5,\n\n        // Border offset\n        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)\n      );\n\n      lineSizes = vec2(lineSizeScaled, borderSizeScaled);\n\n      gl_Position = projectedPosition;\n    }\n  "])),R.occlusionTestEnabled?(0,fe.H)(q||(q=(0,ne.A)(["\n      if (!testHUDVisibility(endPoint)) {\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }"]))):"",R.hasScreenSizePerspective?(0,fe.H)(Q||(Q=(0,ne.A)(["\n      vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);\n      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);\n        "]))):(0,fe.H)(J||(J=(0,ne.A)(["vec2 screenOffsetScaled = screenOffset;"]))),R.multipassEnabled?"depth = posView.z;":"",R.depthHudEnabled?R.depthHudAlignStartEnabled?(0,fe.H)(X||(X=(0,ne.A)(["endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);"]))):(0,fe.H)($||($=(0,ne.A)(["startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);"]))):"",R.hasScreenSizePerspective?(0,fe.H)(K||(K=(0,ne.A)(["\n      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);\n      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);\n        "]))):(0,fe.H)(ee||(ee=(0,ne.A)(["\n      float lineSizeScaled = lineSize;\n      float borderSizeScaled = borderSize;\n        "]))))),ae.uniforms.add(new me.E("uColor",(R=>m(R.color))),new me.E("borderColor",(R=>m(R.borderColor)))),R.multipassEnabled&&(ae.include(ue.H,R),ae.uniforms.add(new _e.G("inverseViewport",((R,G)=>G.inverseViewport)))),ae.code.add((0,fe.H)(te||(te=(0,ne.A)(["\n    void main() {\n      ","\n\n      // Mix between line and border coverage offsets depending on whether we need\n      // a border (based on the sidedness).\n      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);\n\n      // Mix between border and line color based on the line coverage (conceptually the line blends on top of the\n      // border background).\n      //\n      // Anti-alias by blending final result using the full (including optional border) coverage and the color alpha\n      float borderAlpha = uColor.a * borderColor.a * coverage.y;\n      float colorAlpha = uColor.a * coverage.x;\n\n      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);\n\n    ","\n  }\n  "])),R.multipassEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":"",R.depthHudEnabled?(0,fe.H)(ie||(ie=(0,ne.A)(["\n      if (finalAlpha < 0.01) {\n        discard;\n      }\n      "]))):(0,fe.H)(re||(re=(0,ne.A)(["\n      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);\n      fragColor = vec4(finalRgb, finalAlpha);\n      "]))))),G}function m(R){return null!=R?R:oe.uY}const be=(0,ae.vt)(),xe=Object.freeze(Object.defineProperty({__proto__:null,build:S},Symbol.toStringTag,{value:"Module"}))},12089:(R,G,H)=>{H.d(G,{L:()=>Ue,b:()=>M});var W,q,Q,J,X,$,K,ee,te,ie,re,ne,se,ae,oe,le,ce,de,he,ue,pe,_e,me=H(57528),ge=H(35211),fe=H(18852),ye=H(32573),ve=H(41933),be=H(76406),xe=H(28463),Se=H(96218),Ce=H(82993),we=H(39059),Ae=H(44187),Re=H(39313),Te=H(38013),Ee=H(69460),Oe=H(50390),Pe=H(3878),Me=H(96767),Ie=H(51305),De=H(94539),Le=H(34343),Fe=H(62301),Ne=H(64286),Ve=H(5157);function M(R){const G=new De.N5,H=R.multipassEnabled&&(R.output===ye.V.Color||R.output===ye.V.Alpha),Ue=R.space===Ve.lM.World;G.include(be.s,R),G.include(Se.r,R),R.output===ye.V.LinearDepth&&G.include(xe.L,R);const{vertex:Ge,fragment:ze}=G;return ze.include(Re.W),(0,Te.NB)(Ge,R),G.attributes.add(Ne.r.POSITION,"vec3"),G.attributes.add(Ne.r.PREVPOSITION,"vec3"),G.attributes.add(Ne.r.UV0,"vec2"),G.varyings.add("vColor","vec4"),G.varyings.add("vpos","vec3"),G.varyings.add("vUV","vec2"),G.varyings.add("vSize","float"),(0,fe.Mu)(G),H&&G.varyings.add("depth","float"),R.hasTip&&G.varyings.add("vLineWidth","float"),Ge.uniforms.add(new Ee.G("nearFar",((R,G)=>G.camera.nearFar)),new Oe.E("viewport",((R,G)=>G.camera.fullViewport))),Ge.code.add((0,Me.H)(W||(W=(0,me.A)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),Ge.code.add((0,Me.H)(q||(q=(0,me.A)(["void clip(vec4 pos, inout vec4 prev) {\nfloat vnp = nearFar[0] * 0.99;\nif (prev.z > -nearFar[0]) {\nfloat interpolation = (-vnp - pos.z) / (prev.z - pos.z);\nprev = mix(pos, prev, interpolation);\n}\n}"])))),Ue?(G.attributes.add(Ne.r.NORMAL,"vec3"),(0,Te.S7)(Ge),Ge.constants.add("tiltThreshold","float",.7),Ge.code.add((0,Me.H)(Q||(Q=(0,me.A)(["vec3 perpendicular(vec3 v) {\nvec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;\nvec3 n2 = cross(v, n);\nvec3 forward = vec3(0.0, 0.0, 1.0);\nfloat tiltDot = dot(forward, n);\nreturn abs(tiltDot) < tiltThreshold ? n : n2;\n}"]))))):Ge.code.add((0,Me.H)(J||(J=(0,me.A)(["vec2 perpendicular(vec2 v) {\nreturn vec2(v.y, -v.x);\n}"])))),Ge.code.add((0,Me.H)(X||(X=(0,me.A)(["\n      #define vecN ","\n\n      vecN normalizedSegment(vecN pos, vecN prev) {\n        vecN segment = pos - prev;\n        float segmentLen = length(segment);\n\n        // normalize or zero if too short\n        return (segmentLen > 0.001) ? segment / segmentLen : ",";\n      }\n\n      vecN displace(vecN pos, vecN prev, float displacementLen) {\n        vecN segment = normalizedSegment(pos, prev);\n\n        vecN displacementDirU = perpendicular(segment);\n        vecN displacementDirV = segment;\n\n        ","\n\n        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);\n      }\n    "])),Ue?"vec3":"vec2",Ue?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)",R.anchor===Ve.kJ.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":"")),R.space===Ve.lM.Screen&&(Ge.uniforms.add(new Ie.X("inverseProjectionMatrix",((R,G)=>G.camera.inverseProjectionMatrix))),Ge.code.add((0,Me.H)($||($=(0,me.A)(["vec3 inverseProject(vec4 posScreen) {\nposScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;\nreturn (inverseProjectionMatrix * posScreen).xyz;\n}"])))),Ge.code.add((0,Me.H)(K||(K=(0,me.A)(["bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {\nfloat cos = dot(rayDir, planeNormal);\nfloat t = dot(planeOrigin, planeNormal) / cos;\nintersection = t * rayDir;\nreturn abs(cos) > 0.001 && t > 0.0;\n}"])))),Ge.uniforms.add(new Pe.m("perScreenPixelRatio",((R,G)=>G.camera.perScreenPixelRatio))),Ge.code.add((0,Me.H)(ee||(ee=(0,me.A)(["\n      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {\n        // Project displaced position back to camera space\n        vec3 displacedPos = inverseProject(displacedPosScreen);\n\n        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally\n        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).\n        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));\n        vec3 planeOrigin = posLeft;\n\n        ",";\n\n        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the\n        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.\n        float offset = lineWidth * perScreenPixelRatio;\n        planeOrigin *= (1.0 - offset);\n\n        // Intersect camera ray with the plane and make sure it is within clip space\n        vec3 rayDir = normalize(displacedPos);\n        vec3 intersection;\n        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {\n          return vec4(intersection.xyz, 1.0);\n        }\n\n        // Fallback: use depth of pos or prev, whichever is closer to the camera\n        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);\n        displacedPos *= minDepth / length(displacedPos);\n        return vec4(displacedPos.xyz, 1.0);\n      }\n  "])),R.hasCap?"\n                if(prev.z > posLeft.z) {\n                  vec2 diff = posLeft.xy - posRight.xy;\n                  planeOrigin.xy += perpendicular(diff) / 2.0;\n                }\n              ":""))),(0,Te.Nz)(Ge),(0,fe.i$)(G),Ge.code.add((0,Me.H)(te||(te=(0,me.A)(["void main(void) {\nif (uv0.y == 0.0) {\ngl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n}\nelse {\nfloat lineWidth = getLineWidth();\nfloat screenMarkerSize = getScreenMarkerSize();\nvec4 pos  = view * vec4(position, 1.0);\nvec4 prev = view * vec4(prevPosition, 1.0);\nclip(pos, prev);"])))),Ue?(R.hideOnShortSegments&&Ge.code.add((0,Me.H)(ie||(ie=(0,me.A)(["if (areWorldMarkersHidden(pos, prev)) {\ngl_Position = vec4(1e038, 1e038, 1e038, 1.0);\nreturn;\n}"])))),Ge.code.add((0,Me.H)(re||(re=(0,me.A)(["pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));\nvec4 displacedPosScreen = projectAndScale(pos);"]))))):(Ge.code.add((0,Me.H)(ne||(ne=(0,me.A)(["vec4 posScreen = projectAndScale(pos);\nvec4 prevScreen = projectAndScale(prev);\nvec4 displacedPosScreen = posScreen;\ndisplacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);"])))),R.space===Ve.lM.Screen&&Ge.code.add((0,Me.H)(se||(se=(0,me.A)(["vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));\nvec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));\nvec3 lineLeft = pos.xyz + (pos.xyz - lineRight);\npos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);\ndisplacedPosScreen = projectAndScale(pos);"]))))),Ge.code.add((0,Me.H)(ae||(ae=(0,me.A)(["\n        ","\n        linearDepth = calculateLinearDepth(nearFar,pos.z);\n\n        // Convert back into NDC\n        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;\n\n        // Convert texture coordinate into [0,1]\n        vUV = (uv0 + 1.0) / 2.0;\n\n        ","\n\n        ","\n\n        vSize = screenMarkerSize;\n        vColor = getColor();\n\n        // Use camera space for slicing\n        vpos = pos.xyz;\n\n        gl_Position = displacedPosScreen;\n      }\n    }\n  "])),H?"depth = pos.z;":"",Ue?"":"vUV *= displacedPosScreen.w;",R.hasTip?"vLineWidth = lineWidth;":"")),H&&G.include(Ce.Q,R),G.include(ve.HQ,R),ze.uniforms.add(new Oe.E("intrinsicColor",(R=>R.color)),new Le.N("tex",(R=>R.markerTexture))),ze.include(Ae.a),G.constants.add("texelSize","float",1/ge.vO),ze.code.add((0,Me.H)(oe||(oe=(0,me.A)(["float markerAlpha(vec2 samplePos) {\nsamplePos += vec2(0.5, -0.5) * texelSize;\nfloat sdf = rgba2float(texture(tex, samplePos)) - 0.5;\nfloat distance = sdf * vSize;\ndistance -= 0.5;\nreturn clamp(0.5 - distance, 0.0, 1.0);\n}"])))),R.hasTip&&(G.constants.add("relativeMarkerSize","float",ge.Cz/ge.vO),G.constants.add("relativeTipLineWidth","float",ge.DZ),ze.code.add((0,Me.H)(le||(le=(0,me.A)(["\n    float tipAlpha(vec2 samplePos) {\n      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker\n      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);\n      samplePos *= vSize;\n\n      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;\n      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);\n\n      ","\n\n      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);\n      return clamp(0.5 - distance, 0.0, 1.0);\n    }\n  "])),Ue?"halfTipLineWidth *= fwidth(samplePos.y);":""))),G.constants.add("symbolAlphaCutoff","float",we.y),ze.code.add((0,Me.H)(ce||(ce=(0,me.A)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n\n    vec4 finalColor = intrinsicColor * vColor;\n\n    ","\n\n    ","\n\n    ","\n\n    if (finalColor.a < symbolAlphaCutoff) {\n      discard;\n    }\n\n    ","\n    ","\n    ","\n    ","\n    ","\n  }\n  "])),H?"terrainDepthTest(depth);":"",Ue?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;",R.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);",R.output===ye.V.ObjectAndLayerIdColor?(0,Me.H)(de||(de=(0,me.A)(["finalColor.a = 1.0;"]))):"",R.output===ye.V.Alpha?(0,Me.H)(he||(he=(0,me.A)(["fragColor = vec4(finalColor.a);"]))):"",R.output===ye.V.Color?(0,Me.H)(ue||(ue=(0,me.A)(["fragColor = highlightSlice(finalColor, vpos);"]))):"",R.output===ye.V.Color&&R.transparencyPassType===Fe.y.Color?"fragColor = premultiplyAlpha(fragColor);":"",R.output===ye.V.Highlight?(0,Me.H)(pe||(pe=(0,me.A)(["fragColor = vec4(1.0);"]))):"",R.output===ye.V.LinearDepth?(0,Me.H)(_e||(_e=(0,me.A)(["outputDepth(linearDepth);"]))):"")),G}const Ue=Object.freeze(Object.defineProperty({__proto__:null,build:M},Symbol.toStringTag,{value:"Module"}))},3506:(R,G,H)=>{H.d(G,{N:()=>he,b:()=>u});var W,q,Q,J,X,$=H(57528),K=H(32573),ee=H(41933),te=H(51291),ie=H(43046),re=H(88636),ne=H(39059),se=H(38013),ae=H(50390),oe=H(3878),le=H(96767),ce=H(94539),de=H(64286);function u(R){const G=new ce.N5,{vertex:H,fragment:he}=G;return G.include(te.d,R),G.include(ie.c,R),(0,se.NB)(H,R),G.attributes.add(de.r.POSITION,"vec3"),G.varyings.add("vpos","vec3"),H.code.add((0,le.H)(W||(W=(0,$.A)(["void main(void) {\nvpos = position;\nforwardNormalizedVertexColor();\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),R.output===K.V.Highlight&&G.include(re.Qh,R),G.include(ee.HQ,R),he.uniforms.add(new oe.m("alphaCoverage",((R,G)=>Math.min(1,R.width*G.camera.pixelRatio)))),R.hasVertexColors||he.uniforms.add(new ae.E("constantColor",(R=>R.color))),he.code.add((0,le.H)(q||(q=(0,$.A)(["\n  void main() {\n    discardBySlice(vpos);\n\n    vec4 color = ",";\n\n    ","\n\n    if (color.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n  }\n  "])),R.hasVertexColors?"vColor":"constantColor",R.output===K.V.ObjectAndLayerIdColor?(0,le.H)(Q||(Q=(0,$.A)(["color.a = 1.0;"]))):"",le.H.float(ne.y),R.output===K.V.Color?(0,le.H)(J||(J=(0,$.A)(["fragColor = highlightSlice(color, vpos);"]))):"",R.output===K.V.Highlight?(0,le.H)(X||(X=(0,$.A)(["outputHighlight();"]))):"")),G}const he=Object.freeze(Object.defineProperty({__proto__:null,build:u},Symbol.toStringTag,{value:"Module"}))},30789:(R,G,H)=>{H.d(G,{O:()=>d,a:()=>ie,b:()=>l});var W,q=H(57528),Q=H(37355),J=H(38382),X=H(3878),$=H(92046),K=H(96767),ee=H(94539),te=H(34343);class d extends K.Y{constructor(){super(...arguments),this.overlayIndex=Q.vr.INNER,this.opacity=1}}function l(){const R=new ee.N5;return R.include(J.c),R.fragment.uniforms.add(new te.N("tex",(R=>R.texture))),R.fragment.uniforms.add(new $.c("overlayIdx",(R=>R.overlayIndex))),R.fragment.uniforms.add(new X.m("opacity",(R=>R.opacity))),R.fragment.code.add((0,K.H)(W||(W=(0,q.A)(["void main() {\nvec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);\nfragColor = texture(tex, overlayUV) * opacity;\n}"])))),R}const ie=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:d,build:l},Symbol.toStringTag,{value:"Module"}))},14292:(R,G,H)=>{H.d(G,{P:()=>we,b:()=>O});var W,q,Q,J,X,$,K,ee,te,ie=H(57528),re=H(18852),ne=H(32573),se=H(41933),ae=H(51291),oe=H(93911),le=H(28463),ce=H(88636),de=H(79489),he=H(4367),ue=H(21181),pe=H(82993),_e=H(42840),me=H(10748),ge=H(39202),fe=H(44187),ye=H(38013),ve=H(20373),be=H(3878),xe=H(96767),Se=H(94539),Ce=H(62301);function O(R){const G=new Se.N5,{vertex:H,fragment:we}=G;switch((0,ye.NB)(H,R),G.varyings.add("vpos","vec3"),G.include(oe.H,R),R.output!==ne.V.Color&&R.output!==ne.V.Alpha||(G.include(ae.d,R),G.include(ge.Bz,R),G.include(re.oD,R),G.varyings.add("vnormal","vec3"),G.varyings.add("vcolor","vec4"),R.multipassEnabled&&G.varyings.add("depth","float"),H.code.add((0,xe.H)(W||(W=(0,ie.A)(["\n      void main() {\n        vpos = calculateVPos();\n        vnormal = normalize(localNormal());\n\n        ","\n        gl_Position = transformPosition(proj, view, vpos);\n\n        ","\n\n        vcolor = getColor();\n      }\n    "])),R.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":"",R.output===ne.V.Color?"forwardLinearDepth();":""))),G.include(pe.Q,R),R.output){case ne.V.Alpha:G.include(se.HQ,R),we.uniforms.add(new be.m("opacity",(R=>R.opacity))),we.code.add((0,xe.H)(q||(q=(0,ie.A)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        float combinedOpacity = vcolor.a * opacity;\n        fragColor = vec4(combinedOpacity);\n      }\n    "])),R.multipassEnabled?"terrainDepthTest(depth);":""));break;case ne.V.Color:G.include(se.HQ,R),G.include(he.kA,R),G.include(de.n,R),G.include(ge.Bz,R),G.include(_e.r,R),(0,ye.yu)(we,R),(0,he.a8)(we),(0,he.eU)(we),we.uniforms.add(H.uniforms.get("localOrigin"),new ve.t("ambient",(R=>R.ambient)),new ve.t("diffuse",(R=>R.diffuse)),new ve.t("specular",(R=>R.specular)),new be.m("opacity",(R=>R.opacity))),we.include(fe.a),(0,ue.O4)(we),we.code.add((0,xe.H)(Q||(Q=(0,ie.A)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          shadingParams.viewDirection = normalize(vpos - cameraPosition);\n          shadingParams.normalView = vnormal;\n          vec3 normal = shadingNormal(shadingParams);\n          float ssao = evaluateAmbientOcclusionInverse();\n\n          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);\n          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n          ","\n          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one\n          float combinedOpacity = vcolor.a * opacity;\n          albedo += 0.25 * specular; // don't completely ignore specular for now\n\n          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);\n          fragColor = vec4(shadedColor, combinedOpacity);\n          fragColor = highlightSlice(fragColor, vpos);\n          ","\n        }\n      "])),R.multipassEnabled?"terrainDepthTest(depth);":"",R.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":R.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;",R.transparencyPassType===Ce.y.Color?"fragColor = premultiplyAlpha(fragColor);":""));break;case ne.V.LinearDepth:case ne.V.Shadow:case ne.V.ShadowHighlight:case ne.V.ShadowExcludeHighlight:G.include(ae.d,R),(0,re.xJ)(G),G.varyings.add("depth","float"),H.code.add((0,xe.H)(J||(J=(0,ie.A)(["void main() {\nvpos = calculateVPos();\ngl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);\n}"])))),G.include(se.HQ,R),G.include(le.L,R),we.code.add((0,xe.H)(X||(X=(0,ie.A)(["void main() {\ndiscardBySlice(vpos);\noutputDepth(depth);\n}"]))));break;case ne.V.Normal:G.include(ae.d,R),G.include(me.n,R),(0,ye.S7)(H),G.varyings.add("vnormal","vec3"),H.code.add((0,xe.H)($||($=(0,ie.A)(["void main(void) {\nvpos = calculateVPos();\nvnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),G.include(se.HQ,R),we.code.add((0,xe.H)(K||(K=(0,ie.A)(["void main() {\ndiscardBySlice(vpos);\nvec3 normal = normalize(vnormal);\nif (gl_FrontFacing == false) normal = -normal;\nfragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);\n}"]))));break;case ne.V.Highlight:G.include(ae.d,R),G.include(me.n,R),G.varyings.add("vnormal","vec3"),H.code.add((0,xe.H)(ee||(ee=(0,ie.A)(["void main(void) {\nvpos = calculateVPos();\ngl_Position = transformPosition(proj, view, vpos);\n}"])))),G.include(se.HQ,R),G.include(ce.Qh,R),we.code.add((0,xe.H)(te||(te=(0,ie.A)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))))}return G}const we=Object.freeze(Object.defineProperty({__proto__:null,build:O},Symbol.toStringTag,{value:"Module"}))},56463:(R,G,H)=>{H.d(G,{P:()=>Ge,b:()=>T});var W,q,Q,J,X,$,K,ee,te,ie,re,ne,se,ae,oe,le,ce,de,he,ue,pe,_e,me=H(57528),ge=H(18852),fe=H(32573),ye=H(41933),ve=H(51291),be=H(95688),xe=H(43046),Se=H(28463),Ce=H(88636),we=H(82993),Ae=H(89651),Re=H(39059),Te=H(44187),Ee=H(38013),Oe=H(50390),Pe=H(3878),Me=H(96767),Ie=H(94539),De=H(62301),Le=H(64286),Fe=H(19154);const Ne=.70710678118,Ve=Ne,Ue=.08715574274;function T(R){const G=new Ie.N5,H=R.multipassEnabled&&(R.output===fe.V.Color||R.output===fe.V.Alpha),{vertex:Ge,fragment:ze,attributes:Be,varyings:He}=G;(0,Ee.NB)(Ge,R),G.include(ve.d,R),G.include(xe.c,R),G.include(Ae.A,R),G.include(be.g,R),R.draped?Ge.uniforms.add(new Pe.m("worldToScreenRatio",((R,G)=>1/G.screenToPCSRatio))):Be.add(Le.r.BOUNDINGRECT,"mat3"),Be.add(Le.r.POSITION,"vec3"),Be.add(Le.r.UVMAPSPACE,"vec4"),R.vvColor&&Be.add(Le.r.COLORFEATUREATTRIBUTE,"float"),He.add("vColor","vec4"),He.add("vpos","vec3"),He.add("vuv","vec2"),H&&He.add("depth","float"),Ge.uniforms.add(new Oe.E("uColor",(R=>R.color)));const je=R.style===Fe.O.ForwardDiagonal||R.style===Fe.O.BackwardDiagonal||R.style===Fe.O.DiagonalCross;je&&Ge.code.add((0,Me.H)(W||(W=(0,me.A)(["\n      const mat2 rotate45 = mat2(",", ",",\n                                 ",", ",");\n    "])),Me.H.float(Ne),Me.H.float(-Ve),Me.H.float(Ve),Me.H.float(Ne))),R.draped||((0,Ee.yu)(Ge,R),Ge.uniforms.add(new Pe.m("worldToScreenPerDistanceRatio",((R,G)=>1/G.camera.perScreenPixelRatio))),Ge.code.add((0,Me.H)(q||(q=(0,me.A)(["vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {\nfloat projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);\nreturn center + halfVector * clamp(projectedLength, -1.0, 1.0);\n}"])))),Ge.code.add((0,Me.H)(Q||(Q=(0,me.A)(["vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {\nfloat d = dot(planeNormal, planePoint);\nfloat t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);\nreturn rayOrigin + t * rayDir;\n}"])))),Ge.code.add((0,Me.H)(J||(J=(0,me.A)(["\n      float boundingRectDistanceToCamera() {\n        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);\n        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);\n        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);\n        vec3 n = normalize(cross(halfU, halfV));\n\n        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);\n\n        float viewAngle = dot(viewDir, n);\n        float minViewAngle = ",";\n\n        if (abs(viewAngle) < minViewAngle) {\n          // view direction is (almost) parallel to plane -> clamp it to min angle\n          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;\n          viewDir = normalize(viewDir + normalComponent * n);\n        }\n\n        // intersect view direction with infinite plane that contains bounding rect\n        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);\n\n        // clip to bounds by projecting to u and v line segments individually\n        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);\n        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);\n\n        // use to calculate the closest point to camera on bounding rect\n        vec3 closestPoint = uProjected + vProjected - center;\n\n        return length(closestPoint - cameraPosition);\n      }\n    "])),Me.H.float(Ue)))),Ge.code.add((0,Me.H)(X||(X=(0,me.A)(["\n    vec2 scaledUV() {\n      vec2 uv = uvMapSpace.xy ",";\n      vec2 uvCellOrigin = uvMapSpace.zw ",";\n\n      ","\n\n      // Logarithmically discretize ratio to avoid jittering\n      float step = 0.1;\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n\n      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ",");\n      return uvOffset + (uv * discreteWorldToScreenRatio);\n    }\n  "])),je?" * rotate45":"",je?" * rotate45":"",R.draped?"":(0,Me.H)($||($=(0,me.A)(["\n            float distanceToCamera = boundingRectDistanceToCamera();\n            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;\n          "]))),Me.H.float(R.patternSpacing)));const We=R.output===fe.V.LinearDepth;return We&&(G.include(Se.L,R),(0,ge.xJ)(G),(0,ge.Mu)(G)),Ge.code.add((0,Me.H)(K||(K=(0,me.A)(["\n    void main(void) {\n      vuv = scaledUV();\n      vpos = position;\n      ","\n      forwardNormalizedVertexColor();\n      forwardObjectAndLayerIdColor();\n      ","\n      gl_Position = ","\n    }\n  "])),H?"depth = (view * vec4(vpos, 1.0)).z;":"",R.hasVertexColors?"vColor *= uColor;":R.vvColor?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;",We?(0,Me.H)(ee||(ee=(0,me.A)(["transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);"]))):(0,Me.H)(te||(te=(0,me.A)(["transformPosition(proj, view, vpos);"]))))),G.include(ye.HQ,R),ze.include(Te.a),R.draped&&ze.uniforms.add(new Pe.m("texelSize",((R,G)=>1/G.camera.pixelRatio))),R.output===fe.V.Highlight&&G.include(Ce.Qh,R),H&&G.include(we.Q,R),R.output!==fe.V.Highlight&&(ze.code.add((0,Me.H)(ie||(ie=(0,me.A)(["\n      const float lineWidth = ",";\n      const float spacing = ",";\n      const float spacingINV = ",";\n\n      float coverage(float p, float txlSize) {\n        p = mod(p, spacing);\n\n        float halfTxlSize = txlSize / 2.0;\n\n        float start = p - halfTxlSize;\n        float end = p + halfTxlSize;\n\n        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;\n        coverage -= min(lineWidth, mod(start, spacing));\n        coverage -= max(lineWidth - mod(end, spacing), 0.0);\n\n        return coverage / txlSize;\n      }\n    "])),Me.H.float(R.lineWidth),Me.H.float(R.patternSpacing),Me.H.float(1/R.patternSpacing))),R.draped||ze.code.add((0,Me.H)(re||(re=(0,me.A)(["const int maxSamples = 5;\nfloat sampleAA(float p) {\nvec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));\nfloat fwidth = dxdy.x + dxdy.y;\nivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));\nvec2 invSamples = 1.0 / vec2(samples);\nfloat accumulator = 0.0;\nfor (int j = 0; j < maxSamples; j++) {\nif(j >= samples.y) {\nbreak;\n}\nfor (int i = 0; i < maxSamples; i++) {\nif(i >= samples.x) {\nbreak;\n}\nvec2 step = vec2(i,j) * invSamples - 0.5;\naccumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);\n}\n}\naccumulator /= float(samples.x * samples.y);\nreturn accumulator;\n}"]))))),ze.code.add((0,Me.H)(ne||(ne=(0,me.A)(["\n    void main() {\n      discardBySlice(vpos);\n      ","\n      vec4 color = vColor;\n      color = highlightSlice(color, vpos);\n\n      ","\n\n      ","\n\n      if (color.a < ",") {\n        discard;\n      }\n\n      ","\n\n      ","\n      ","\n      ",";\n      ","\n    }\n  "])),H?"terrainDepthTest(depth);":"",R.output!==fe.V.Highlight?(0,Me.H)(se||(se=(0,me.A)(["color.a *= ",";"])),function P(R){function o(G){return R.draped?(0,Me.H)(ue||(ue=(0,me.A)(["coverage(vuv.",", texelSize)"])),G):(0,Me.H)(pe||(pe=(0,me.A)(["sampleAA(vuv.",")"])),G)}switch(R.style){case Fe.O.ForwardDiagonal:case Fe.O.Horizontal:return o("y");case Fe.O.BackwardDiagonal:case Fe.O.Vertical:return o("x");case Fe.O.DiagonalCross:case Fe.O.Cross:return(0,Me.H)(_e||(_e=(0,me.A)(["\n        1.0 - (1.0 - ",") * (1.0 - ",")\n      "])),o("x"),o("y"));default:return"0.0"}}(R)):"",R.output===fe.V.ObjectAndLayerIdColor?(0,Me.H)(ae||(ae=(0,me.A)(["color.a = 1.0;"]))):"",Me.H.float(Re.y),R.output===fe.V.Alpha?(0,Me.H)(oe||(oe=(0,me.A)(["fragColor = vec4(color.a);"]))):"",R.output===fe.V.Color?(0,Me.H)(le||(le=(0,me.A)(["fragColor = color; ",""])),R.transparencyPassType===De.y.Color?"fragColor = premultiplyAlpha(fragColor);":""):"",R.output===fe.V.Highlight?(0,Me.H)(ce||(ce=(0,me.A)(["outputHighlight();"]))):"",R.output===fe.V.LinearDepth?(0,Me.H)(de||(de=(0,me.A)(["outputDepth(linearDepth);"]))):"",R.output===fe.V.ObjectAndLayerIdColor?(0,Me.H)(he||(he=(0,me.A)(["outputObjectAndLayerIdColor();"]))):"")),G}const Ge=Object.freeze(Object.defineProperty({__proto__:null,build:T},Symbol.toStringTag,{value:"Module"}))},60727:(R,G,H)=>{H.d(G,{R:()=>ot,b:()=>P,r:()=>at});var W,q,Q,J,X,$,K,ee,te,ie,re,ne,se,ae,oe,le,ce,de,he,ue,pe,_e,me,ge,fe,ye,ve,be,xe,Se,Ce,we,Ae,Re,Te,Ee,Oe,Pe,Me,Ie,De,Le,Fe,Ne=H(57528),Ve=H(18852),Ue=H(32573),Ge=H(41933),ze=H(95688),Be=H(76406),He=H(28463),je=H(2385),We=H(96218),ke=H(82993),qe=H(12828),Ze=H(39059),Qe=H(44187),Ye=H(38013),Je=H(69460),Xe=H(50390),$e=H(3878),Ke=H(96767),et=H(51305),tt=H(94539),it=H(62301),rt=H(64286),nt=H(5157),st=H(82363);const at=1;function P(R){const G=new tt.N5,{attributes:H,varyings:ot,constants:lt,vertex:ct,fragment:dt}=G;G.include(qe.p),G.include(Be.s,R),G.include(je.q,R);const ht=R.applyMarkerOffset&&!R.draped;ht&&(ct.uniforms.add(new $e.m("markerScale",(R=>R.markerScale))),G.include(We.r,{space:nt.lM.World,draped:!1})),R.output===Ue.V.LinearDepth&&G.include(He.L,R),G.include(ze.g,R),(0,Ye.NB)(ct,R),ct.uniforms.add(new et.X("inverseProjectionMatrix",((R,G)=>G.camera.inverseProjectionMatrix)),new Je.G("nearFar",((R,G)=>G.camera.nearFar)),new $e.m("miterLimit",(R=>"miter"!==R.join?0:R.miterLimit)),new Xe.E("viewport",((R,G)=>G.camera.fullViewport))),ct.constants.add("LARGE_HALF_FLOAT","float",65500),H.add(rt.r.POSITION,"vec3"),H.add(rt.r.PREVPOSITION,"vec3"),H.add(rt.r.NEXTPOSITION,"vec3"),H.add(rt.r.SUBDIVISIONFACTOR,"float"),H.add(rt.r.UV0,"vec2"),ot.add("vColor","vec4"),ot.add("vpos","vec3"),ot.add("vLineDistance","float"),ot.add("vLineWidth","float"),(0,Ve.Mu)(G);const ut=R.multipassEnabled&&(R.output===Ue.V.Color||R.output===Ue.V.Alpha);ut&&ot.add("depth","float");const pt=R.stippleEnabled;pt&&ot.add("vLineSizeInv","float"),lt.add("aaWidth","float",R.stippleEnabled?0:1);const _t=R.capType===st.x.ROUND,mt=R.stippleEnabled&&_t,gt=R.falloffEnabled||mt;gt&&ot.add("vLineDistanceNorm","float"),_t&&(ot.add("vSegmentSDF","float"),ot.add("vReverseSegmentSDF","float")),ct.code.add((0,Ke.H)(W||(W=(0,Ne.A)(["#define PERPENDICULAR(v) vec2(v.y, -v.x);\nfloat interp(float ncp, vec4 a, vec4 b) {\nreturn (-ncp - a.z) / (b.z - a.z);\n}\nvec2 rotate(vec2 v, float a) {\nfloat s = sin(a);\nfloat c = cos(a);\nmat2 m = mat2(c, -s, s, c);\nreturn m * v;\n}"])))),ct.code.add((0,Ke.H)(q||(q=(0,Ne.A)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),(0,Ve.i$)(G),ct.code.add((0,Ke.H)(Q||(Q=(0,Ne.A)(["\n    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {\n      float vnp = nearFar[0] * 0.99;\n\n      if(pos.z > -nearFar[0]) {\n        //current pos behind ncp --\x3e we need to clip\n        if (!isStartVertex) {\n          if(prev.z < -nearFar[0]) {\n            //previous in front of ncp\n            pos = mix(prev, pos, interp(vnp, prev, pos));\n            next = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        } else {\n          if(next.z < -nearFar[0]) {\n            //next in front of ncp\n            pos = mix(pos, next, interp(vnp, pos, next));\n            prev = pos;\n          } else {\n            pos = vec4(0.0, 0.0, 0.0, 1.0);\n          }\n        }\n      } else {\n        //current position visible\n        if (prev.z > -nearFar[0]) {\n          //previous behind ncp\n          prev = mix(pos, prev, interp(vnp, pos, prev));\n        }\n        if (next.z > -nearFar[0]) {\n          //next behind ncp\n          next = mix(next, pos, interp(vnp, next, pos));\n        }\n      }\n\n      ","\n      linearDepth = calculateLinearDepth(nearFar,pos.z);\n\n      pos = projectAndScale(pos);\n      next = projectAndScale(next);\n      prev = projectAndScale(prev);\n    }\n  "])),ut?"depth = pos.z;":"")),(0,Ye.Nz)(ct),ct.code.add((0,Ke.H)(J||(J=(0,Ne.A)(["\n  void main(void) {\n    // unpack values from uv0.y\n    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;\n\n    float coverage = 1.0;\n\n    // Check for special value of uv0.y which is used by the Renderer when graphics\n    // are removed before the VBO is recompacted. If this is the case, then we just\n    // project outside of clip space.\n    if (uv0.y == 0.0) {\n      // Project out of clip space\n      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n    else {\n      bool isJoin = abs(uv0.y) < 3.0;\n      float lineSize = getSize();\n\n      if (lineSize < 1.0) {\n        coverage = lineSize; // convert sub-pixel coverage to alpha\n        lineSize = 1.0;\n      }\n      lineSize += aaWidth;\n\n      float lineWidth = lineSize * pixelRatio;\n      vLineWidth = lineWidth;\n      ","\n\n      vec4 pos  = view * vec4(position, 1.0);\n      vec4 prev = view * vec4(prevPosition, 1.0);\n      vec4 next = view * vec4(nextPosition, 1.0);\n  "])),pt?(0,Ke.H)(X||(X=(0,Ne.A)(["vLineSizeInv = 1.0 / lineSize;"]))):"")),ht&&ct.code.add((0,Ke.H)($||($=(0,Ne.A)(["vec4 other = isStartVertex ? next : prev;\nbool markersHidden = areWorldMarkersHidden(pos, other);\nif(!isJoin && !markersHidden) {\npos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;\n}"])))),ct.code.add((0,Ke.H)(K||(K=(0,Ne.A)(["clipAndTransform(pos, prev, next, isStartVertex);\nvec2 left = (pos.xy - prev.xy);\nvec2 right = (next.xy - pos.xy);\nfloat leftLen = length(left);\nfloat rightLen = length(right);"])))),(R.stippleEnabled||_t)&&ct.code.add((0,Ke.H)(ee||(ee=(0,Ne.A)(["\n      float isEndVertex = float(!isStartVertex);\n      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);\n      vec2 segment = mix(right, left, isEndVertex);\n      ","\n    "])),_t?(0,Ke.H)(te||(te=(0,Ne.A)(["vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);"]))):"")),ct.code.add((0,Ke.H)(ie||(ie=(0,Ne.A)(["left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);\nright = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);\nvec2 capDisplacementDir = vec2(0, 0);\nvec2 joinDisplacementDir = vec2(0, 0);\nfloat displacementLen = lineWidth;\nif (isJoin) {\nbool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;\njoinDisplacementDir = normalize(left + right);\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\nif (leftLen > 0.001 && rightLen > 0.001) {\nfloat nDotSeg = dot(joinDisplacementDir, left);\ndisplacementLen /= length(nDotSeg * left - joinDisplacementDir);\nif (!isOutside) {\ndisplacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));\n}\n}\nif (isOutside && (displacementLen > miterLimit * lineWidth)) {"])))),R.roundJoins?ct.code.add((0,Ke.H)(re||(re=(0,Ne.A)(["\n        vec2 startDir = leftLen < 0.001 ? right : left;\n        startDir = PERPENDICULAR(startDir);\n\n        vec2 endDir = rightLen < 0.001 ? left : right;\n        endDir = PERPENDICULAR(endDir);\n\n        float factor = ",";\n\n        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));\n        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);\n      "])),R.stippleEnabled?(0,Ke.H)(ne||(ne=(0,Ne.A)(["min(1.0, subdivisionFactor * ",")"])),Ke.H.float((at+2)/(at+1))):(0,Ke.H)(se||(se=(0,Ne.A)(["subdivisionFactor"]))))):ct.code.add((0,Ke.H)(ae||(ae=(0,Ne.A)(["if (leftLen < 0.001) {\njoinDisplacementDir = right;\n}\nelse if (rightLen < 0.001) {\njoinDisplacementDir = left;\n}\nelse {\njoinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;\n}\njoinDisplacementDir = PERPENDICULAR(joinDisplacementDir);"]))));const ft=R.capType!==st.x.BUTT;return ct.code.add((0,Ke.H)(oe||(oe=(0,Ne.A)(["\n        displacementLen = lineWidth;\n      }\n    } else {\n      // CAP handling ---------------------------------------------------\n      joinDisplacementDir = isStartVertex ? right : left;\n      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);\n\n      ","\n    }\n  "])),ft?(0,Ke.H)(le||(le=(0,Ne.A)(["capDisplacementDir = isStartVertex ? -right : left;"]))):"")),ct.code.add((0,Ke.H)(ce||(ce=(0,Ne.A)(["\n    // Displacement (in pixels) caused by join/or cap\n    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;\n    float lineDistNorm = sign(uv0.y) * pos.w;\n\n    vLineDistance =  lineWidth * lineDistNorm;\n    ","\n\n    pos.xy += dpos;\n  "])),gt?(0,Ke.H)(de||(de=(0,Ne.A)(["vLineDistanceNorm = lineDistNorm;"]))):"")),_t&&ct.code.add((0,Ke.H)(he||(he=(0,Ne.A)(["vec2 segmentDir = normalize(segment);\nvSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;\nvReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);"])))),R.stippleEnabled&&(R.draped?ct.uniforms.add(new $e.m("worldToScreenRatio",((R,G)=>1/G.screenToPCSRatio))):ct.code.add((0,Ke.H)(ue||(ue=(0,Ne.A)(["vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);\nfloat worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);"])))),ct.code.add((0,Ke.H)(pe||(pe=(0,Ne.A)(["float segmentLengthScreenDouble = length(segment);\nfloat segmentLengthScreen = segmentLengthScreenDouble * 0.5;\nfloat discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);\nfloat segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));\nvStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;"])))),R.draped?ct.code.add((0,Ke.H)(_e||(_e=(0,Ne.A)(["float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;\nfloat startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);"])))):ct.code.add((0,Ke.H)(me||(me=(0,Ne.A)(["float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;\nfloat segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;"])))),ct.uniforms.add(new $e.m("stipplePatternPixelSize",(R=>(0,je.h)(R)))),ct.code.add((0,Ke.H)(ge||(ge=(0,Ne.A)(["float patternLength = lineSize * stipplePatternPixelSize;\nvStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);\nvStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);\nif (segmentLengthScreenDouble >= 0.001) {\nvec2 stippleDisplacement = pos.xy - segmentOrigin;\nfloat stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);\nvStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);\n}\nvStippleDistanceLimits *= pos.w;\nvStippleDistance *= pos.w;\nvStippleDistanceLimits = isJoin ?\nvStippleDistanceLimits :\nisStartVertex ?\nvec2(-1e34, vStippleDistanceLimits.y) :\nvec2(vStippleDistanceLimits.x, 1e34);"]))))),ct.code.add((0,Ke.H)(fe||(fe=(0,Ne.A)(["\n      // Convert back into NDC\n      pos.xy = (pos.xy / viewport.zw) * pos.w;\n\n      vColor = getColor();\n      vColor.a *= coverage;\n\n      ","\n\n      // transform final position to camera space for slicing\n      vpos = (inverseProjectionMatrix * pos).xyz;\n      gl_Position = pos;\n      forwardObjectAndLayerIdColor();\n    }\n  }\n  "])),R.wireframe&&!R.draped?"pos.z -= 0.001 * pos.w;":"")),ut&&G.include(ke.Q,R),G.include(Ge.HQ,R),dt.include(Qe.a),dt.code.add((0,Ke.H)(ye||(ye=(0,Ne.A)(["\n  void main() {\n    discardBySlice(vpos);\n    ","\n  "])),ut?"terrainDepthTest(depth);":"")),R.wireframe?dt.code.add((0,Ke.H)(ve||(ve=(0,Ne.A)(["vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);"])))):(_t&&dt.code.add((0,Ke.H)(be||(be=(0,Ne.A)(["\n        float sdf = min(vSegmentSDF, vReverseSegmentSDF);\n        vec2 fragmentPosition = vec2(\n          min(sdf, 0.0),\n          vLineDistance\n        ) * gl_FragCoord.w;\n\n        float fragmentRadius = length(fragmentPosition);\n        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);\n\n        if (capCoverage < ",") {\n          discard;\n        }\n      "])),Ke.H.float(Ze.y))),mt?dt.code.add((0,Ke.H)(xe||(xe=(0,Ne.A)(["\n      vec2 stipplePosition = vec2(\n        min(getStippleSDF() * 2.0 - 1.0, 0.0),\n        vLineDistanceNorm * gl_FragCoord.w\n      );\n      float stippleRadius = length(stipplePosition * vLineWidth);\n      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale\n      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);\n      float stippleAlpha = step(",", stippleCoverage);\n      "])),Ke.H.float(Ze.y))):dt.code.add((0,Ke.H)(Se||(Se=(0,Ne.A)(["float stippleAlpha = getStippleAlpha();"])))),R.output!==Ue.V.ObjectAndLayerIdColor&&dt.code.add((0,Ke.H)(Ce||(Ce=(0,Ne.A)(["discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);"])))),dt.uniforms.add(new Xe.E("intrinsicColor",(R=>R.color))),dt.code.add((0,Ke.H)(we||(we=(0,Ne.A)(["vec4 color = intrinsicColor * vColor;"])))),R.innerColorEnabled&&(dt.uniforms.add(new Xe.E("innerColor",(R=>{var G;return null!==(G=R.innerColor)&&void 0!==G?G:R.color})),new $e.m("innerWidth",((R,G)=>R.innerWidth*G.camera.pixelRatio))),dt.code.add((0,Ke.H)(Ae||(Ae=(0,Ne.A)(["float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;\nfloat innerAA = clamp(0.5 - distToInner, 0.0, 1.0);\nfloat innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);\ncolor = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);"]))))),dt.code.add((0,Ke.H)(Re||(Re=(0,Ne.A)(["vec4 finalColor = blendStipple(color, stippleAlpha);"])))),R.falloffEnabled&&(dt.uniforms.add(new $e.m("falloff",(R=>R.falloff))),dt.code.add((0,Ke.H)(Te||(Te=(0,Ne.A)(["finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);"]))))),R.stippleEnabled||dt.code.add((0,Ke.H)(Ee||(Ee=(0,Ne.A)(["float featherStartDistance = max(vLineWidth - 2.0, 0.0);\nfloat value = abs(vLineDistance) * gl_FragCoord.w;\nfloat feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);\nfinalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);"]))))),dt.code.add((0,Ke.H)(Oe||(Oe=(0,Ne.A)(["\n    ","\n\n    if (finalColor.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n    ","\n    ","\n    ","\n    ","\n  }\n  "])),R.output===Ue.V.ObjectAndLayerIdColor?(0,Ke.H)(Pe||(Pe=(0,Ne.A)(["finalColor.a = 1.0;"]))):"",Ke.H.float(Ze.y),R.output===Ue.V.Alpha?(0,Ke.H)(Me||(Me=(0,Ne.A)(["fragColor = vec4(finalColor.a);"]))):"",R.output===Ue.V.Color?(0,Ke.H)(Ie||(Ie=(0,Ne.A)(["fragColor = highlightSlice(finalColor, vpos);"]))):"",R.output===Ue.V.Color&&R.transparencyPassType===it.y.Color?"fragColor = premultiplyAlpha(fragColor);":"",R.output===Ue.V.Highlight?(0,Ke.H)(De||(De=(0,Ne.A)(["fragColor = vec4(1.0);"]))):"",R.output===Ue.V.LinearDepth?(0,Ke.H)(Le||(Le=(0,Ne.A)(["outputDepth(linearDepth);"]))):"",R.output===Ue.V.ObjectAndLayerIdColor?(0,Ke.H)(Fe||(Fe=(0,Ne.A)(["outputObjectAndLayerIdColor();"]))):"")),G}const ot=Object.freeze(Object.defineProperty({__proto__:null,build:P,ribbonlineNumRoundJoinSubdivisions:at},Symbol.toStringTag,{value:"Module"}))},88006:(R,G,H)=>{H.d(G,{T:()=>a,a:()=>te,b:()=>l});var W,q=H(57528),Q=H(83800),J=H(38382),X=H(20373),$=H(96767),K=H(94539),ee=H(34343);class a extends $.Y{constructor(){super(...arguments),this.color=(0,Q.fA)(1,1,1)}}function l(){const R=new K.N5;return R.include(J.c),R.fragment.uniforms.add(new ee.N("tex",(R=>R.texture)),new X.t("uColor",(R=>R.color))),R.fragment.code.add((0,$.H)(W||(W=(0,q.A)(["void main() {\nvec4 texColor = texture(tex, uv);\nfragColor = texColor * vec4(uColor, 1.0);\n}"])))),R}const te=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:a,build:l},Symbol.toStringTag,{value:"Module"}))},27255:(R,G,H)=>{H.d(G,{W:()=>Oe,b:()=>x});var W,q,Q,J,X,$,K,ee,te,ie,re,ne,se=H(57528),ae=H(18852),oe=H(32573),le=H(41933),ce=H(51291),de=H(95688),he=H(88636),ue=H(47963),pe=H(21181),_e=H(82993),me=H(10748),ge=H(60183),fe=H(39202),ye=H(7536),ve=H(53948),be=H(39059),xe=H(44187),Se=H(38013),Ce=H(50390),we=H(3878),Ae=H(96767),Re=H(94539),Te=H(62301),Ee=H(64286);function x(R){const G=new Re.N5,{vertex:H,fragment:Oe}=G;(0,Se.NB)(H,R),G.include(ce.d,R),G.attributes.add(Ee.r.POSITION,"vec3"),G.attributes.add(Ee.r.UV0,"vec2");const Pe=new Ce.E("waterColor",(R=>R.color));if(R.output===oe.V.Color&&R.draped)return G.varyings.add("vpos","vec3"),H.uniforms.add(Pe),H.code.add((0,Ae.H)(W||(W=(0,se.A)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),Ae.H.float(be.y))),Oe.uniforms.add(Pe),Oe.code.add((0,Ae.H)(q||(q=(0,se.A)(["void main() {\nfragColor = waterColor;\n}"])))),G;switch(R.output!==oe.V.Color&&R.output!==oe.V.Alpha||(G.include(me.n,R),G.include(ae.oD,R),G.varyings.add("vuv","vec2"),G.varyings.add("vpos","vec3"),G.varyings.add("vnormal","vec3"),G.varyings.add("vtbnMatrix","mat3"),R.multipassEnabled&&G.varyings.add("depth","float"),H.uniforms.add(Pe),H.code.add((0,Ae.H)(Q||(Q=(0,se.A)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        ","\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),Ae.H.float(be.y),R.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":"",R.output===oe.V.Color?"forwardLinearDepth();":""))),G.include(_e.Q,R),R.output){case oe.V.Alpha:G.include(le.HQ,R),Oe.uniforms.add(Pe),Oe.code.add((0,Ae.H)(J||(J=(0,se.A)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          fragColor = vec4(waterColor.a);\n        }\n      "])),R.multipassEnabled?"terrainDepthTest(depth);":""));break;case oe.V.Color:G.include(pe.qU),G.include(ue.W,{pbrMode:ge.A9.Disabled,lightingSphericalHarmonicsOrder:2}),G.include(ve.V),G.include(le.HQ,R),G.include(fe.Bz,R),G.include(ye.E,R),Oe.uniforms.add(Pe,new we.m("timeElapsed",(R=>R.timeElapsed)),H.uniforms.get("view"),H.uniforms.get("localOrigin")),(0,Se.yu)(Oe,R),Oe.include(xe.a),(0,pe.Gc)(Oe),(0,pe.O4)(Oe),Oe.code.add((0,Ae.H)(X||(X=(0,se.A)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - cameraPosition);\n        float shadow = ",";\n        vec4 vPosView = view * vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);\n\n        // gamma correction\n        fragColor = delinearizeGamma(final);\n        fragColor = highlightSlice(fragColor, vpos);\n        ","\n      }\n    "])),R.multipassEnabled?"terrainDepthTest(depth);":"",R.receiveShadows?(0,Ae.H)($||($=(0,se.A)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",R.transparencyPassType===Te.y.Color?"fragColor = premultiplyAlpha(fragColor);":""));break;case oe.V.Normal:G.include(me.n,R),G.include(ve.V,R),G.include(le.HQ,R),G.varyings.add("vpos","vec3"),G.varyings.add("vuv","vec2"),H.uniforms.add(Pe),H.code.add((0,Ae.H)(K||(K=(0,se.A)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),Ae.H.float(be.y))),Oe.uniforms.add(new we.m("timeElapsed",(R=>R.timeElapsed))),Oe.code.add((0,Ae.H)(ee||(ee=(0,se.A)(["void main() {\ndiscardBySlice(vpos);\nvec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\ntangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\nfragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n}"]))));break;case oe.V.Highlight:G.include(he.Qh,R),G.varyings.add("vpos","vec3"),H.uniforms.add(Pe),H.code.add((0,Ae.H)(te||(te=(0,se.A)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),Ae.H.float(be.y))),G.include(le.HQ,R),Oe.code.add((0,Ae.H)(ie||(ie=(0,se.A)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))));break;case oe.V.ObjectAndLayerIdColor:G.include(de.g,R),G.varyings.add("vpos","vec3"),H.uniforms.add(Pe),H.code.add((0,Ae.H)(re||(re=(0,se.A)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n        forwardObjectAndLayerIdColor();\n      }\n    "])),Ae.H.float(be.y))),G.include(le.HQ,R),Oe.code.add((0,Ae.H)(ne||(ne=(0,se.A)(["void main() {\ndiscardBySlice(vpos);\noutputObjectAndLayerIdColor();\n}"]))))}return G}const Oe=Object.freeze(Object.defineProperty({__proto__:null,build:x},Symbol.toStringTag,{value:"Module"}))},11277:(R,G,H)=>{var W;H.d(G,{u:()=>W}),function(R){R[R.KILOBYTES=1024]="KILOBYTES",R[R.MEGABYTES=1048576]="MEGABYTES",R[R.GIGABYTES=1073741824]="GIGABYTES"}(W||(W={}))},83255:(R,G,H)=>{H.d(G,{A:()=>s});var W=H(39798),q=H(63454);class s{constructor(R){this._observable=new q.I,this._set=new Set(R)}get size(){return(0,W.gc)(this._observable),this._set.size}add(R){const G=this._set.size;return this._set.add(R),this._set.size!==G&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(R){const G=this._set.delete(R);return G&&this._observable.notify(),G}entries(){return(0,W.gc)(this._observable),this._set.entries()}forEach(R,G){(0,W.gc)(this._observable),this._set.forEach(((H,W)=>R.call(G,H,W,this)),G)}has(R){return(0,W.gc)(this._observable),this._set.has(R)}keys(){return(0,W.gc)(this._observable),this._set.keys()}values(){return(0,W.gc)(this._observable),this._set.values()}[Symbol.iterator](){return(0,W.gc)(this._observable),this._set[Symbol.iterator]()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}},73602:(R,G,H)=>{H.d(G,{P:()=>j});var W=H(4180),q=H(52482),Q=H(37531),J=H(4270),X=H(51523),$=H(76402),K=H(57532),ee=H(57453),te=H(28330),ie=H(85173);function j(R){var G;const H=null!==(G=null===R||void 0===R?void 0:R.origins)&&void 0!==G?G:[void 0];return(G,W)=>{const q=function U(R,G,H){var W;if("resource"===(null===R||void 0===R?void 0:R.type))return function w(R,G,H){const W=(0,$.z4)(G,H);return{type:String,read:(R,G,H)=>{const q=(0,ie.r)(R,G,H);return W.type===String?q:"function"==typeof W.type?new W.type({url:q}):void 0},write:{writer(G,q,X,$){if(null===$||void 0===$||!$.resources)return"string"==typeof G?void(q[X]=(0,ie.t)(G,$)):void(q[X]=G.write({},$));const ee=function x(R){return null==R?null:"string"==typeof R?R:R.url}(G),re=(0,ie.t)(ee,{...$,verifyItemRelativeUrls:null!==$&&void 0!==$&&$.verifyItemRelativeUrls?{writtenUrls:$.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},ie.M.NO),ne=W.type!==String&&(!(0,Q.H)(this)||(null===$||void 0===$?void 0:$.origin)&&this.originIdOf(H)>(0,K.aB)($.origin)),se={object:this,propertyName:H,value:G,targetUrl:re,dest:q,targetPropertyName:X,context:$,params:R};null!==$&&void 0!==$&&$.portalItem&&re&&!(0,J.oP)(re)?ne&&null!==R&&void 0!==R&&R.contentAddressed?I(se):ne?function N(R){var G;const{context:H,targetUrl:W,params:q,value:Q,dest:X,targetPropertyName:$}=R;if(!H.portalItem)return;const K=H.portalItem.resourceFromPath(W),ee=S(Q,W,H),ie=(0,te.n)(ee),re=(0,J.Zo)(K.path),ne=null!==(G=null===q||void 0===q?void 0:q.compress)&&void 0!==G&&G;ie===re?(H.resources&&b({...R,resource:K,content:ee,compress:ne,updates:H.resources.toUpdate}),X[$]=W):I(R)}(se):function P(R){let{context:G,targetUrl:H,dest:W,targetPropertyName:q}=R;G.portalItem&&G.resources&&(G.resources.toKeep.push({resource:G.portalItem.resourceFromPath(H),compress:!1}),W[q]=H)}(se):null!==$&&void 0!==$&&$.portalItem&&(null==re||null!=(0,ie.i)(re)||(0,J.w8)(re)||ne)?I(se):q[X]=re}}}}(R,G,H);switch(null!==(W=null===R||void 0===R?void 0:R.type)&&void 0!==W?W:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:R,write:G}=ie.b;return{read:R,write:G}}}}(R,G,W);for(const R of H){const H=(0,ee.rM)(G,R,W);for(const R in q)H[R]=q[R]}}}function I(R){var G,H,Q,$;const{targetUrl:K,params:ee,value:re,context:ne,dest:se,targetPropertyName:ae}=R;if(!ne.portalItem)return;const oe=(0,ie.p)(K),le=S(re,K,ne);if(null!==ee&&void 0!==ee&&ee.contentAddressed&&"json"!==le.type)return void(null===(G=ne.messages)||void 0===G||G.push(new W.A("persistable:contentAddressingUnsupported",'Property "'.concat(ae,'" is trying to serializing a resource with content of type ').concat(le.type," with content addressing. Content addressing is only supported for json resources."),{content:le})));const ce=null!==ee&&void 0!==ee&&ee.contentAddressed&&"json"===le.type?(0,q.d)(le.jsonString):null!==(H=null===oe||void 0===oe?void 0:oe.filename)&&void 0!==H?H:(0,X.lk)(),de=(0,J.fj)(null!==(Q=null===ee||void 0===ee?void 0:ee.prefix)&&void 0!==Q?Q:null===oe||void 0===oe?void 0:oe.prefix,ce),he="".concat(de,".").concat((0,te.n)(le));if(null!==ee&&void 0!==ee&&ee.contentAddressed&&ne.resources&&"json"===le.type){var ue;const R=null!==(ue=ne.resources.toKeep.find((R=>{let{resource:G}=R;return G.path===he})))&&void 0!==ue?ue:ne.resources.toAdd.find((R=>{let{resource:G}=R;return G.path===he}));if(R)return void(se[ae]=R.resource.itemRelativeUrl)}const pe=ne.portalItem.resourceFromPath(he);(0,J.w8)(K)&&ne.resources&&ne.resources.pendingOperations.push((0,J.tk)(K).then((R=>{pe.path="".concat(de,".").concat((0,te.n)({type:"blob",blob:R})),se[ae]=pe.itemRelativeUrl})).catch((()=>{})));const _e=null!==($=null===ee||void 0===ee?void 0:ee.compress)&&void 0!==$&&$;ne.resources&&b({...R,resource:pe,content:le,compress:_e,updates:ne.resources.toAdd}),se[ae]=pe.itemRelativeUrl}function b(R){let{object:G,propertyName:H,updates:W,resource:q,content:Q,compress:J}=R;W.push({resource:q,content:Q,compress:J,finish:R=>{!function O(R,G,H){"string"==typeof R[G]?R[G]=H.url:R[G].url=H.url}(G,H,R)}})}function S(R,G,H){return"string"==typeof R?{type:"url",url:G}:{type:"json",jsonString:JSON.stringify(R.toJSON(H))}}},53395:(R,G,H)=>{function n(){return new Float32Array(3)}function t(R){const G=new Float32Array(3);return G[0]=R[0],G[1]=R[1],G[2]=R[2],G}function r(R,G,H){const W=new Float32Array(3);return W[0]=R,W[1]=G,W[2]=H,W}function o(){return n()}function u(){return r(1,1,1)}function c(){return r(1,0,0)}function i(){return r(0,1,0)}function a(){return r(0,0,1)}H.d(G,{fA:()=>r,o8:()=>t,vt:()=>n});const W=o(),q=u(),Q=c(),J=i(),X=a();Object.freeze(Object.defineProperty({__proto__:null,ONES:q,UNIT_X:Q,UNIT_Y:J,UNIT_Z:X,ZEROS:W,clone:t,create:n,createView:function e(R,G){return new Float32Array(R,G,3)},fromValues:r,ones:u,unitX:c,unitY:i,unitZ:a,zeros:o},Symbol.toStringTag,{value:"Module"}))},30925:(R,G,H)=>{H.d(G,{w:()=>s});var W=H(16842),q=H(17244),Q=H(60964);class s{constructor(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9,G=arguments.length>1?arguments[1]:void 0;this._compareMinX=o,this._compareMinY=l,this._toBBox=R=>R,this._maxEntries=Math.max(4,R||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),G&&("function"==typeof G?this._toBBox=G:this._initFormat(G)),this.clear()}destroy(){this.clear(),J.prune(),X.prune(),$.prune(),K.prune()}all(R){this._all(this._data,R)}search(R,G){let H=this._data;const W=this._toBBox;if(x(R,H))for(J.clear();H;){for(let q=0,Q=H.children.length;q<Q;q++){const Q=H.children[q],X=H.leaf?W(Q):Q;x(R,X)&&(H.leaf?G(Q):_(R,X)?this._all(Q,G):J.push(Q))}H=J.pop()}}collides(R){let G=this._data;const H=this._toBBox;if(!x(R,G))return!1;for(J.clear();G;){for(let W=0,q=G.children.length;W<q;W++){const q=G.children[W],Q=G.leaf?H(q):q;if(x(R,Q)){if(G.leaf||_(R,Q))return!0;J.push(q)}}G=J.pop()}return!1}load(R){if(!R.length)return this;if(R.length<this._minEntries){for(let G=0,H=R.length;G<H;G++)this.insert(R[G]);return this}let G=this._build(R.slice(0,R.length),0,R.length-1,0);if(this._data.children.length)if(this._data.height===G.height)this._splitRoot(this._data,G);else{if(this._data.height<G.height){const R=this._data;this._data=G,G=R}this._insert(G,this._data.height-G.height-1,!0)}else this._data=G;return this}insert(R){return R&&this._insert(R,this._data.height-1),this}clear(){return this._data=new w([]),this}remove(R){if(!R)return this;let G,H=this._data,q=null,Q=0,J=!1;const X=this._toBBox(R);for($.clear(),K.clear();H||$.length>0;){var ee;if(H||(H=$.pop(),q=$.data[$.length-1],Q=null!==(ee=K.pop())&&void 0!==ee?ee:0,J=!0),H.leaf&&(G=(0,W.qh)(H.children,R,H.children.length,H.indexHint),-1!==G))return H.children.splice(G,1),$.push(H),this._condense($),this;J||H.leaf||!_(H,X)?q?(Q++,H=q.children[Q],J=!1):H=null:($.push(H),K.push(Q),Q=0,q=H,H=H.children[0])}return this}toJSON(){return this._data}fromJSON(R){return this._data=R,this}_all(R,G){let H=R;for(X.clear();H;){var W;if(!0===H.leaf)for(const R of H.children)G(R);else X.pushArray(H.children);H=null!==(W=X.pop())&&void 0!==W?W:null}}_build(R,G,H,W){const q=H-G+1;let Q=this._maxEntries;if(q<=Q){const W=new w(R.slice(G,H+1));return h(W,this._toBBox),W}W||(W=Math.ceil(Math.log(q)/Math.log(Q)),Q=Math.ceil(q/Q**(W-1)));const J=new b([]);J.height=W;const X=Math.ceil(q/Q),$=X*Math.ceil(Math.sqrt(Q));f(R,G,H,$,this._compareMinX);for(let K=G;K<=H;K+=$){const G=Math.min(K+$-1,H);f(R,K,G,X,this._compareMinY);for(let H=K;H<=G;H+=X){const q=Math.min(H+X-1,G);J.children.push(this._build(R,H,q,W-1))}}return h(J,this._toBBox),J}_chooseSubtree(R,G,H,W){for(;W.push(G),!0!==G.leaf&&W.length-1!==H;){let H,W=1/0,q=1/0;for(let Q=0,J=G.children.length;Q<J;Q++){const J=G.children[Q],X=c(J),$=d(R,J)-X;$<q?(q=$,W=X<W?X:W,H=J):$===q&&X<W&&(W=X,H=J)}G=H||G.children[0]}return G}_insert(R,G,H){const W=this._toBBox,q=H?R:W(R);$.clear();const Q=this._chooseSubtree(q,this._data,G,$);for(Q.children.push(R),r(Q,q);G>=0&&$.data[G].children.length>this._maxEntries;)this._split($,G),G--;this._adjustParentBBoxes(q,$,G)}_split(R,G){const H=R.data[G],W=H.children.length,q=this._minEntries;this._chooseSplitAxis(H,q,W);const Q=this._chooseSplitIndex(H,q,W);if(!Q)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const J=H.children.splice(Q,H.children.length-Q),X=H.leaf?new w(J):new b(J);X.height=H.height,h(H,this._toBBox),h(X,this._toBBox),G?R.data[G-1].children.push(X):this._splitRoot(H,X)}_splitRoot(R,G){this._data=new b([R,G]),this._data.height=R.height+1,h(this._data,this._toBBox)}_chooseSplitIndex(R,G,H){let W,q,Q;W=q=1/0;for(let J=G;J<=H-G;J++){const G=a(R,0,J,this._toBBox),X=a(R,J,H,this._toBBox),$=u(G,X),K=c(G)+c(X);$<W?(W=$,Q=J,q=K<q?K:q):$===W&&K<q&&(q=K,Q=J)}return Q}_chooseSplitAxis(R,G,H){const W=R.leaf?this._compareMinX:o,q=R.leaf?this._compareMinY:l;this._allDistMargin(R,G,H,W)<this._allDistMargin(R,G,H,q)&&R.children.sort(W)}_allDistMargin(R,G,H,W){R.children.sort(W);const q=this._toBBox,Q=a(R,0,G,q),J=a(R,H-G,H,q);let X=m(Q)+m(J);for(let $=G;$<H-G;$++){const G=R.children[$];r(Q,R.leaf?q(G):G),X+=m(Q)}for(let $=H-G-1;$>=G;$--){const G=R.children[$];r(J,R.leaf?q(G):G),X+=m(J)}return X}_adjustParentBBoxes(R,G,H){for(let W=H;W>=0;W--)r(G.data[W],R)}_condense(R){for(let G=R.length-1;G>=0;G--){const H=R.data[G];if(0===H.children.length)if(G>0){const q=R.data[G-1],Q=q.children;Q.splice((0,W.qh)(Q,H,Q.length,q.indexHint),1)}else this.clear();else h(H,this._toBBox)}}_initFormat(R){const G=["return a"," - b",";"];this._compareMinX=new Function("a","b",G.join(R[0])),this._compareMinY=new Function("a","b",G.join(R[1])),this._toBBox=new Function("a","return {minX: a"+R[0]+", minY: a"+R[1]+", maxX: a"+R[2]+", maxY: a"+R[3]+"};")}}function h(R,G){a(R,0,R.children.length,G,R)}function a(R,G,H,W,q){q||(q=new w([])),q.minX=1/0,q.minY=1/0,q.maxX=-1/0,q.maxY=-1/0;for(let Q,J=G;J<H;J++)Q=R.children[J],r(q,R.leaf?W(Q):Q);return q}function r(R,G){R.minX=Math.min(R.minX,G.minX),R.minY=Math.min(R.minY,G.minY),R.maxX=Math.max(R.maxX,G.maxX),R.maxY=Math.max(R.maxY,G.maxY)}function o(R,G){return R.minX-G.minX}function l(R,G){return R.minY-G.minY}function c(R){return(R.maxX-R.minX)*(R.maxY-R.minY)}function m(R){return R.maxX-R.minX+(R.maxY-R.minY)}function d(R,G){return(Math.max(G.maxX,R.maxX)-Math.min(G.minX,R.minX))*(Math.max(G.maxY,R.maxY)-Math.min(G.minY,R.minY))}function u(R,G){const H=Math.max(R.minX,G.minX),W=Math.max(R.minY,G.minY),q=Math.min(R.maxX,G.maxX),Q=Math.min(R.maxY,G.maxY);return Math.max(0,q-H)*Math.max(0,Q-W)}function _(R,G){return R.minX<=G.minX&&R.minY<=G.minY&&G.maxX<=R.maxX&&G.maxY<=R.maxY}function x(R,G){return G.minX<=R.maxX&&G.minY<=R.maxY&&G.maxX>=R.minX&&G.maxY>=R.minY}function f(R,G,H,W,q){const J=[G,H];for(;J.length;){const G=J.pop(),H=J.pop();if(G-H<=W)continue;const X=H+Math.ceil((G-H)/W/2)*W;(0,Q.q)(R,X,H,G,q),J.push(H,X,X,G)}}const J=new q.A,X=new q.A,$=new q.A,K=new q.A({deallocator:void 0});class Y{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class B extends Y{constructor(){super(...arguments),this.height=1,this.indexHint=new W.vW}}class w extends B{constructor(R){super(),this.children=R,this.leaf=!0}}class b extends B{constructor(R){super(),this.children=R,this.leaf=!1}}},37531:(R,G,H)=>{function i(R){return R&&"getAtOrigin"in R&&"originOf"in R}H.d(G,{H:()=>i})},78952:(R,G,H)=>{H.d(G,{B:()=>h});var W=H(16842),q=H(58285),Q=H(89412),J=H(81618),X=H(80563);class h{constructor(R,G,H,W){let q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};this._mainMethod=G,this._transferLists=H,this._listeners=[],this._promise=(0,X.ho)(R,{...q,schedule:W}).then((R=>{if(void 0===this._thread){this._thread=R,this._promise=null,q.hasInitialize&&this.broadcast({},"initialize");for(const R of this._listeners)this._connectListener(R)}else R.close()})),this._promise.catch((G=>Q.A.getLogger("esri.core.workers.WorkerHandle").error("Failed to initialize ".concat(R," worker: ").concat(G))))}on(R,G){const H={removed:!1,eventName:R,callback:G,threadHandle:null};return this._listeners.push(H),this._connectListener(H),(0,q.hA)((()=>{H.removed=!0,(0,W.TF)(this._listeners,H),this._thread&&null!=H.threadHandle&&H.threadHandle.remove()}))}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(R,G){return this.invokeMethod(this._mainMethod,R,G)}invokeMethod(R,G,H){if(this._thread){const W=this._transferLists[R],q=W?W(G):[];return this._thread.invoke(R,G,{transferList:q,signal:H})}return this._promise?this._promise.then((()=>((0,J.Te)(H),this.invokeMethod(R,G,H)))):Promise.reject(null)}broadcast(R,G){return this._thread?Promise.all(this._thread.broadcast(G,R)).then((()=>{})):this._promise?this._promise.then((()=>this.broadcast(R,G))):Promise.reject()}get promise(){return this._promise}_connectListener(R){this._thread&&this._thread.on(R.eventName,R.callback).then((G=>{R.removed||(R.threadHandle=G)}))}}},98482:(R,G,H)=>{var W,q,Q,J,X,$,K,ee,te,ie,re,ne,se,ae,oe;H.d(G,{Pl:()=>le,Qg:()=>oe,vE:()=>ce}),function(R){R.U8="U8",R.I8="I8",R.U16="U16",R.I16="I16",R.U32="U32",R.I32="I32",R.F32="F32",R.F64="F64",R.Utf8String="Utf8String",R.NotSet="NotSet"}(W||(W={})),function(R){R.Png="Png",R.Jpeg="Jpeg",R.Dds="Dds",R.Raw="Raw",R.Dxt1="Dxt1",R.Dxt5="Dxt5",R.Etc2="Etc2",R.Astc="Astc",R.Pvrtc="Pvrtc",R.NotSet="NotSet"}(q||(q={})),function(R){R.Rgb8="Rgb8",R.Rgba8="Rgba8",R.R8="R8",R.Bgr8="Bgr8",R.Bgra8="Bgra8",R.Rg8="Rg8",R.NotSet="NotSet"}(Q||(Q={})),function(R){R.Position="Position",R.Normal="Normal",R.TexCoord="TexCoord",R.Color="Color",R.Tangent="Tangent",R.FeatureIndex="FeatureIndex",R.UvRegion="UvRegion",R.NotSet="NotSet"}(J||(J={})),function(R){R.Opaque="Opaque",R.Mask="Mask",R.Blend="Blend"}(X||(X={})),function(R){R.None="None",R.Mask="Mask",R.Alpha="Alpha",R.PreMultAlpha="PreMultAlpha",R.NotSet="NotSet"}($||($={})),function(R){R.Points="Points",R.Lines="Lines",R.LineStrip="LineStrip",R.Triangles="Triangles",R.TriangleStrip="TriangleStrip",R.NotSet="NotSet"}(K||(K={})),function(R){R.None="None",R.WrapXBit="WrapXBit",R.WrapYBit="WrapYBit",R.WrapXy="WrapXy",R.NotSet="NotSet"}(ee||(ee={})),function(R){R.Linear="Linear",R.Nearest="Nearest",R.NotSet="NotSet"}(te||(te={})),function(R){R.Linear="Linear",R.Nearest="Nearest",R.NearestMipmapNearest="NearestMipmapNearest",R.LinearMipmapNearest="LinearMipmapNearest",R.NearestMipmapLinear="NearestMipmapLinear",R.LinearMipmapLinear="LinearMipmapLinear",R.NotSet="NotSet"}(ie||(ie={})),function(R){R.FeatureId="FeatureId",R.GlobalUid="GlobalUid",R.UnspecifiedDateTime="UnspecifiedDateTime",R.EcmaIso8601DateTime="EcmaIso8601DateTime",R.EcmaIso8601DateOnly="EcmaIso8601DateOnly",R.TimeOnly="TimeOnly",R.TimeStamp="TimeStamp",R.ColorRgb="ColorRgb",R.ColorRgba="ColorRgba",R.Unrecognized="Unrecognized",R.NotSet="NotSet"}(re||(re={})),function(R){R.Texture="Texture",R.VertexAtrb="VertexAtrb",R.Implicit="Implicit",R.NotSet="NotSet"}(ne||(ne={})),function(R){R.Front="Front",R.Back="Back",R.None="None",R.NotSet="NotSet"}(se||(se={})),function(R){R.Pbr="Pbr",R.Unlit="Unlit"}(ae||(ae={})),function(R){R[R.Succeeded=0]="Succeeded",R[R.Failed=1]="Failed",R[R.MissingInputs=2]="MissingInputs"}(oe||(oe={}));const le=-1,ce=-2},39907:(R,G,H)=>{H.r(G),H.d(G,{default:()=>sg});var W=H(80671),q=H(53705),Q=H(18763),J=H(89412),X=H(81618),$=H(63390),K=H(59650),ee=H(57453),te=H(50886),ie=(H(76761),H(68682)),re=H(98482),ne=H(78952);class Lyr3DWorkerHandle_s extends ne.B{constructor(R){super("Lyr3DWorker","process",{process:R=>R.inputs},R,{hasInitialize:!0})}destroyWasm(){return this.broadcast({},"destroyWasm")}}var se=H(87022),ae=H(2001),oe=H(22123),le=H(13812),ce=H(16842),de=H(11277),he=H(39652),ue=H(58285),pe=H(17244),_e=H(49905),me=H(49049),ge=H(68052),fe=H(66912),ye=H(39393),ve=H(70655),be=(H(77912),H(54880)),xe=H(83800),Se=H(14223),Ce=H(40727),we=H(31059),Ae=H(84762),Re=H(39572),Te=H(78395);var Ee=H(48237);function projectBoundingSphere_a(R,G,H,W){if(null==G||null==W)return!1;const q=(0,Ae.t_)(G,W,Pe);if(q.projector===Ae.pO)return H[0]=R[0],H[1]=R[1],H[2]=R[2],H[3]=R[3],!0;if(null==q.projector)return!1;const{source:Q,dest:J}=q;if(J.spatialReferenceId===Ae.rz.WEB_MERCATOR){const G=Ae.w5[Q.spatialReferenceId][Ae.rz.WGS84];return null!=G&&(G(R,0,Oe,0),(0,Ae.s7)(Oe,0,H,0),H[3]=projectBoundingSphere_u(Oe[1],R[2],R[3],Re.$O.radius),!0)}if(Q.spatialReferenceId!==Ae.rz.WGS84&&Q.spatialReferenceId!==Ae.rz.CGCS2000||J.spatialReferenceId!==Ae.rz.PLATE_CARREE){var X,$;q.projector(R,0,H,0);const G=null!==(X=Q.metersPerUnit)&&void 0!==X?X:1,W=null!==($=J.metersPerUnit)&&void 0!==$?$:1;H[3]=R[3]*G/W}else{const G=Ae.w5[Q.spatialReferenceId][Ae.rz.SPHERICAL_ECEF],W=Ae.w5[Ae.rz.SPHERICAL_ECEF][Ae.rz.PLATE_CARREE];let J=R[3];null!=G&&null!=W&&(J=projectBoundingSphere_u(R[1],R[2],R[3],Re.$O.radius)),q.projector(R,0,H,0),H[3]=J}return!0}function projectBoundingSphere_u(R,G,H,W){const q=W+G;if(q<W/2||H>q)return Number.MAX_VALUE;const Q=Math.abs(Me*R)+Math.asin(H/q);return Q>=Math.PI/2?Number.MAX_VALUE:H/Math.cos(Q)}const Oe=(0,xe.vt)(),Pe=(0,Ae.Ur)(),Me=(0,Ee.kU)(1);var Ie=H(33876),De=H(49055),Le=H(21374),Fe=H(88965),Ne=H(39783),Ve=H(85922),Ue=H(2360),Ge=H(65174);var ze=H(5203);function projectBoundingRect_i(R,G,H,W){return null!=R&&((0,Te.aI)(G,W)?((0,Fe.C)(H,R),!0):(Be[0]=R[0],Be[1]=R[1],Be[2]=0,!!(0,Ie.projectBuffer)(Be,G,0,Be,W,0,1)&&(H[0]=Be[0],H[1]=Be[1],Be[0]=R[2],Be[1]=R[3],Be[2]=0,!!(0,Ie.projectBuffer)(Be,G,0,Be,W,0,1)&&(H[2]=Be[0],H[3]=Be[1],!0))))}const Be=(0,xe.vt)();var He,je,We=H(50317),ke=H(59159),qe=H(67833),Ze=H(4180),Qe=H(35598),Ye=H(97745),Je=H(51523),Xe=H(17061),$e=H(97408),Ke=H(62216);!function(R){R[R.KTX2=1]="KTX2",R[R.Basis=2]="Basis",R[R.DDS_S3TC=4]="DDS_S3TC",R[R.PNG=8]="PNG",R[R.JPG=16]="JPG",R[R.KTX_ETC2=32]="KTX_ETC2"}(He||(He={})),function(R){R[R.None=0]="None",R[R.Color=1]="Color",R[R.MetallicRoughness=2]="MetallicRoughness",R[R.Normal=4]="Normal",R[R.Occlusion=8]="Occlusion",R[R.Emissive=16]="Emissive",R[R.AlphaMask=32]="AlphaMask",R[R.ColorTextures=19]="ColorTextures",R[R.GeometryTextures=36]="GeometryTextures",R[R.GeometryTexturesPBR=44]="GeometryTexturesPBR",R[R.AllTextures=37]="AllTextures",R[R.AllTexturesPBR=63]="AllTexturesPBR"}(je||(je={}));var et=H(42954),tt=H(14666),it=H(81384);async function I3SClientMaterialUtil_m(R,G,H,W){if(null==R)return-1;const q=H.length,Q=R.data,J=R.url;if(null!=Q){if(Q instanceof HTMLImageElement||Q instanceof HTMLCanvasElement){const R=(0,tt.IR)(Q);return H.push({id:q,usage:W,data:R,encoding:He.PNG,downsampled:!1}),G.push({id:q,usage:W,encodings:[{name:void 0,encoding:He.PNG}]}),q}if(Q instanceof HTMLVideoElement)return-1;if(Q instanceof ImageData)throw new Ze.A("ImageData textures not supported yet for client side I3S nodes");if(Q instanceof Ke.Xi)throw new Ze.A("EncodedMeshTexture textures not supported yet for client side I3S nodes")}else if(null!=J){const R=new Image;R.src=J;const Q=await(0,$e.Sx)(R,R.src,!1,void 0),X=(0,tt.IR)(Q);return H.push({id:q,usage:W,data:X,encoding:He.PNG,downsampled:!1}),G.push({id:q,usage:W,encodings:[{name:void 0,encoding:He.PNG}]}),q}return-1}class I3SClientNodeLoader_h{constructor(R,G,H,W){this._uid=R,this._worker=W,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=G.indexSR,this._vertexSR=G.vertexSR,this._renderSR=G.renderSR,this._localMode=G.localMode,this._memCache=H.newCache("sl-client-mesh-data-".concat(this._uid))}get uid(){return this._uid}get worker(){return this._worker}get indexSR(){return this._indexSR}get renderSR(){return this._renderSR}createMeshNodeInfo(R,G){const H="mesh".concat(G),W=R.extent,q=W.spatialReference,Q=this._indexSR,J=function I3SClientNodeLoader_f(R,G){const{spatialReference:H}=R,W=[1,-1],q=[.5*R.width,.5*R.height,R.hasZ?.5*(R.zmax-R.zmin):0],Q=H.isGeographic?H.metersPerUnit:1,J=R.center;let X=0;if(R.hasZ)for(let $=0;$<2;++$)for(let R=0;R<2;++R)for(let H=0;H<2;++H){const K=(J.x+W[$]*q[0]-G.x)*Q,ee=(J.y+W[R]*q[1]-G.y)*Q,te=J.z+W[H]*q[2]-G.z;X=Math.max(K*K+ee*ee+te*te,X)}else for(let $=0;$<2;++$)for(let R=0;R<2;++R){const H=(J.x+W[$]*q[0]-G.x)*Q,K=(J.y+W[R]*q[1]-G.y)*Q;X=Math.max(H*H+K*K,X)}return(0,Ge.b)([G.x,G.y,G.z],Math.sqrt(X))}(W,R.origin);return projectBoundingSphere_a(J,q,J,Q),{type:"mesh",id:H,version:I3SClientNodeLoader_g(R),oid:G,mbs:J,componentNodeIds:[],unloadedMesh:R,nodeIndex:null,loadMeshPromise:null}}addMeshNode(R,G){if(null!=this.getMeshNodeIndex(G.oid))throw new Ze.A("I3SClientNodeLoader: client side mesh for feature oid=".concat(G.oid," already exists"));G.nodeIndex=R,this._id2Meta.set(G.id,G),this._oid2Meta.set(G.oid,G)}getMeshNodeIndex(R){const G=this._oid2Meta.get(R);return null==G||"mesh"!==G.type?null:G.nodeIndex}removeNode(R){const G=this._id2Meta.get(R);null!=G&&(this._id2Meta.delete(R),"mesh"===G.type&&this._oid2Meta.delete(G.oid))}async loadNodeJSON(R){const G=this._id2Meta.get(R);if(null==G)throw new Ze.A("I3SClientNodeLoader::loadNodeJSON unable to find node ".concat(R));switch(G.type){case"mesh":return this._loadMeshNodeJSON(G);case"mesh-component":return this._loadMeshComponentNodeJSON(G);default:throw new Ze.A("I3SClientNodeLoader::loadNodeJSON unable to handle node ".concat(R))}}async _loadMeshNodeJSON(R){const G=R.id,H=(await this._getMeshData(R)).loadedMesh;if(null==H.components||0===H.components.length)return{id:G,version:null,mbs:R.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null};const W=[],q=H.components;for(let Q=0;Q<q.length;++Q){const H="".concat(G,"-component").concat(Q),q={type:"mesh-component",id:H,mbs:R.mbs,componentIndex:Q,meshNodeInfo:R,textureData:new Map};this._id2Meta.set(q.id,q),R.componentNodeIds.push(H),W.push({id:q.id,href:null,mbs:q.mbs,obb:null})}return{id:G,version:null,mbs:R.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:W}}updateNodeIndex(R,G,H){const W=this._id2Meta.get(R);W&&"mesh"===W.type&&(W.nodeIndex=H)}async _loadMeshComponentNodeJSON(R){return{id:R.id,version:R.meshNodeInfo.version,mbs:R.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1}}async loadNodeData(R,G){var H;const W=this._id2Meta.get(R);if(null==W||"mesh-component"!==W.type)throw new Ze.A("Failed to load client node data for node ".concat(R," (unexpected node info)"));const q=W.meshNodeInfo,Q=await this._getMeshData(q),J=Q.loadedMesh,$=q.oid;if(null==J.components)throw new Ze.A("Failed to load client node data for node ".concat(R," (unexpected null reference)"));const K=J.components[W.componentIndex],{material:ee,requiredTextures:te,textureData:ie}=await async function I3SClientMaterialUtil_c(R){const G=[],H=[];if(null==R)return{material:{alphaMode:"opaque",alphaCutoff:.1,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:G,textureData:H};const W=function I3SClientMaterialUtil_d(R){return R.hasOwnProperty("metallicRoughnessTexture")}(R);"auto"===R.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".');const q=(0,it.Jr)({normalTexture:R.normalTexture,emissiveTexture:W?R.emissiveTexture:null,emissiveFactor:W?oe.A.toUnitRGB(R.emissiveColor):null,occlusionTexture:W?R.occlusionTexture:null,metallicRoughnessTexture:W?R.metallicRoughnessTexture:null,metallicFactor:W?R.metallic:null,roughnessFactor:W?R.roughness:null}),Q=q?it.mX[0]:W?R.metallic:0,J=q?it.mX[1]:W?R.roughness:0;return{material:{alphaMode:"auto"===R.alphaMode?"blend":R.alphaMode,alphaCutoff:R.alphaCutoff,doubleSided:R.doubleSided,cullFace:R.doubleSided?et.s2.None:et.s2.Back,normalTextureId:await I3SClientMaterialUtil_m(R.normalTexture,G,H,je.Normal),emissiveTextureId:W?await I3SClientMaterialUtil_m(R.emissiveTexture,G,H,je.Emissive):-1,occlusionTextureId:W?await I3SClientMaterialUtil_m(R.occlusionTexture,G,H,je.Occlusion):-1,emissiveFactor:W&&null!=R.emissiveColor?oe.A.toUnitRGB(R.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=R.color?oe.A.toUnitRGBA(R.color):[1,1,1,1],baseColorTextureId:await I3SClientMaterialUtil_m(R.colorTexture,G,H,je.Color),metallicRoughnessTextureId:W?await I3SClientMaterialUtil_m(R.metallicRoughnessTexture,G,H,je.MetallicRoughness):-1,metallicFactor:Q,roughnessFactor:J},wrapTextures:!0,hasParametersFromSource:q},requiredTextures:G,textureData:H}}(K.material);if(null!=ie)for(const X of ie)null!=X&&W.textureData.set(X.id,X);const re={params:{material:ee},type:"ArrayBufferView"},{vertexSpace:ne,origin:se,transform:ae}=J,le=[se.x,se.y,null!==(H=se.z)&&void 0!==H?H:0],ce={featureDataPosition:le,featureIds:[],geometries:[re]};Q.projectionPromise||((0,Qe.Lw)(this._worker,"SceneLayerWorker is needed to project mesh"),Q.projectionPromise=this._worker.project({positions:J.vertexAttributes.position,localMatrix:null===ae||void 0===ae?void 0:ae.localMatrix,vertexSpace:ne.toJSON(),origin:le,inSpatialReference:J.spatialReference.toJSON(),outSpatialReference:this._vertexSR.toJSON(),localMode:this._localMode},G));const{projected:de,original:he}=await Q.projectionPromise;J.vertexAttributes.position=he;const{transformed:ue,original:pe}=await async function I3SClientNodeLoader_p(R,G,H,W){const{transform:q,vertexAttributes:Q}=G.loadedMesh,J="source"===R.shading?Q.normal:null;if(null==J||null==q||0===q.rotationAngle&&(0,be.j)(q.scale,xe.Un))return{transformed:J,original:Q.normal};if(!G.normalsTransformPromise){(0,Qe.Lw)(H,"SceneLayerWorker is needed to transform mesh normals");const R=(0,fe.vt)();(0,ge.Ge)(R,q.localMatrix),G.normalsTransformPromise=H.transformNormals({normalMatrix:R,normals:J},W)}return G.normalsTransformPromise}(K,Q,this._worker,G);J.vertexAttributes.normal=pe,(0,X.Te)(G);const{geometryBuffer:_e,geometryDescriptor:me}=function I3SClientNodeLoader_x(R,G,H,W,q,Q){const J=1,X=G.length/3,$=3*X;let K=0,ee=0,te=!1,ie=0,re=!1,ne=0,se=!1,ae=0,oe=0,le=0;K+=rt,K+=rt,ee=K,K+=3*$*nt,null!=H&&(te=!0,ie=K,K+=3*$*nt),null!=W&&(re=!0,ne=K,K+=2*$*nt),null!=q&&(se=!0,ae=K,K+=4*$*st),oe=K,K+=J*at,le=K,K+=2*J*rt;const ce=new ArrayBuffer(K),de=new Uint8Array(ce);I3SClientNodeLoader_y(de,0,$),I3SClientNodeLoader_y(de,rt,J);const he=new Float32Array(ce,ee),ue=null!=H?new Float32Array(ce,ie):null,pe=null!=W?new Float32Array(ce,ne):null,_e=null!=q?new Uint8Array(ce,ae):null;for(let me=0;me<X;++me){const Q=3*me;for(let J=0;J<3;++J){const X=G[Q+J],$=3*X,K=9*me+3*J;if(he[K]=R[$],he[K+1]=R[$+1],he[K+2]=R[$+2],null!=ue&&(ue[K]=H[$],ue[K+1]=H[$+1],ue[K+2]=H[$+2]),null!=pe){const R=2*X,G=6*me+2*J;pe[G]=W[R],pe[G+1]=W[R+1]}if(null!=_e){const R=4*X,G=12*me+4*J;_e[G]=q[R],_e[G+1]=q[R+1],_e[G+2]=q[R+2],_e[G+3]=q[R+3]}}}return I3SClientNodeLoader_y(de,oe,Q),I3SClientNodeLoader_y(de,oe+rt,Q/2**32),I3SClientNodeLoader_y(de,le,0),I3SClientNodeLoader_y(de,le+rt,X-1),{geometryBuffer:ce,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:se,normal:te,uv0:re,uvRegion:!1,featureIndex:!0}}}(de,K.faces,ue,J.vertexAttributes.uv,J.vertexAttributes.color,$);return{geometryData:ce,attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:_e,geometryDescriptor:me,requiredTextures:te,textureData:ie,normalReferenceFrame:this._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"}}async loadAttributes(R,G,H){const W=R.numFeatures,q={};for(const{field:{name:Q}}of G)q[Q]=new Array(W);return q}async loadTextures(R,G,H){const W=R.id,q=this._id2Meta.get(W);if(null==q||"mesh-component"!==q.type)throw new Error("Failed to load textures for node ".concat(R.id," (unexpected node info)"));const Q=[];for(const J of G)Q.push(q.textureData.get(J.id)||null);return Q}async _getMeshData(R){const G=R.version,H=this._memCache.get(G);if(null==H){if(null!=R.loadMeshPromise)return R.loadMeshPromise;const r=async(H,W)=>{const q=R.unloadedMesh.clone();try{await q.load()}catch(X){W(X)}const Q=q.memoryUsage,J={loadedMesh:q,projectionPromise:null,normalsTransformPromise:null,usedMemoryInBytes:Q};this._memCache.put(G,J,Q,Ye.Ti),R.loadMeshPromise=null,H(J)};return R.loadMeshPromise=new Promise(((R,G)=>r(R,G))),R.loadMeshPromise}return H}}function I3SClientNodeLoader_y(R,G,H){R[G]=255&H,R[G+1]=255&H>>8,R[G+2]=255&H>>16,R[G+3]=255&H>>24}function I3SClientNodeLoader_g(R){var G;const H=null===(G=R.metadata.displaySource)||void 0===G?void 0:G.source;if(null==H||!Array.isArray(H)||!H.length||H[0]instanceof File)return(0,Je.lk)();const W=H;let q="";for(const Q of W)q+=Q.makeHash();return q+JSON.stringify(null!=R.transform?R.transform.toJSON():"")+((0,Xe.Hq)(R.vertexSpace)?JSON.stringify(R.vertexSpace.origin):"")}const rt=4,nt=4,st=1,at=8;var ot=H(53727);let lt=class extends Q.A{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get running(){return this.callbacks.some((R=>R.running))}runTask(R){this._sort();const G=this.callbacks,H={numIndexLoading:0,numNodesLoading:0};for(let W=0;W<G.length&&!R.done;++W)G[W].priority=G[W].runTask(R,H),this.runIndex=W}_sort(){const R=this.callbacks;let G=R.length;for(let H=this.runIndex;H>0;H--){const W=R[H-1];let q=H;for(;q<R.length&&W.priority<=R[q].priority&&(q!==G||W.priority<R[q].priority);)R[q-1]=R[q],q++;R[q-1]=W,G=q-1}this.runIndex=0}add(R){this._sort(),R.priority=1/0,this.callbacks.unshift(R),this.notifyChange("running")}remove(R){(0,ce.Xy)(this.callbacks,R),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}};(0,W._)([(0,ee.MZ)({readOnly:!0})],lt.prototype,"running",null),lt=(0,W._)([(0,ie.$)("esri.views.3d.layers.i3s.I3SFrameTask")],lt);class I3SFrameTask_l{constructor(R,G){this.task=R,this.handle=G}}const ct=new Map;function I3SFrameTask_h(R,G){let H=ct.get(R);if(null==H){const G=new lt,W=R.registerTask(ot.W6.I3S_CONTROLLER,G);H=new I3SFrameTask_l(G,W),ct.set(R,H)}return H.task.add(G),(0,ue.hA)((()=>{null!=H&&(H.task.remove(G),H.task.callbacks.length>0||(ct.delete(R),H.handle.remove(),H.task.destroy()),H=null)}))}var dt=H(4255),ht=H(65791),ut=H(72015);class ValidatedNode_s{constructor(R,G,H,W,q,Q,J,X){this.id=R,this.mbs=G,this.obb=H,this.version=W,this.resources=q,this.children=Q,this.lodSelection=J,this.numFeatures=X}}var pt=H(46257),_t=H(71138);class I3SIndex_p{constructor(R,G,H,W,q){this.childOffset=R,this.childCount=G,this.visibilityCache=H,this.ref=W,this.node=q,this.useAsHole=0,this.filterImpact=ht.TJ.NotChecked,this.traversalState=null,this.parent=-1}}class I3SIndex_b{constructor(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Array,G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array;this.nodes=R,this.children=G,this.lastTraversed=0,this.numNodesWithLoadedChildren=0}}class I3SIndex_I{get _useNodePages(){return this._pageSize>0}constructor(R,G,H,W,q,Q,J,X,$,K,ee,te,ie,re,ne,se){var ae,oe;this.viewingMode=R,this._layer=G,this._streamDataController=W,this._clientNodeLoader=q,this._viewportQueries=Q,this._logger=J,this.holeFilling=X,this._isLoaded=$,this._isReloading=K,this._isSelected=ee,this._enable=te,this._needsUpdate=ie,this._canRequest=re,this._computeVisibilityObb=ne,this._computeNodeFiltering=se,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=ht.cJ.None,this._lodConversion=R=>R,this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=I3SIndex_R(0),this._visibilityCacheVersion=I3SIndex_R(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new pe.A({deallocator:null}),this._prefetchNodes=new pe.A({deallocator:null}),this._updates=new I3SIndex_y(this._missingPagesAndNodes),this._imModificationUncategorized=new pe.A({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=(0,dt.lC)()&&null!=(null===(ae=G.associatedLayer)||void 0===ae?void 0:ae.infoFor3D),null!==(oe=G.serviceUpdateTimeStamp)&&void 0!==oe&&oe.lastUpdate&&(this._lastUpdate="".concat(G.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(H)}_init(R){if("page"===R.type){const G=R.rootPage;switch(this._urlPrefix=R.urlPrefix,this._pageSize=R.pageSize,R.lodMetric){case"maxScreenThreshold":this._lodMetric=ht.cJ.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=ht.cJ.MaxScreenThreshold,this._lodConversion=I3SIndex_k}if(this._isEditable){this._rootIndex=-1;const H=I3SIndex_V(R.rootIndex,R.pageSize),W=G.nodes[H],q={nodes:[{index:this._rootIndex,children:[R.rootIndex],mesh:void 0,obb:W.obb,lodThreshold:W.lodThreshold}]};this._addPage(I3SIndex_E(this._rootIndex,this._pageSize),q),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=R.rootIndex;this._addPage(I3SIndex_E(R.rootIndex,this._pageSize),G),this._updateParentsAndLevel()}else if("node"===R.type){this._urlPrefix=R.urlPrefix;const G=new I3SIndex_b;if(this._nodePages.set(0,G),this._isEditable){this._clientNodePage=new I3SIndex_b;const G={id:"-1",version:null,mbs:R.rootNode.mbs,obb:R.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:R.rootNode.mbs,obb:R.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new ht.ay(G.id,null),-1);const H=this._validateNode(G.id,G);H&&this._addNode(H,this._rootIndex)}else this._rootIndex=this._makeRefNode(new ht.ay(R.rootNode.id,null),-1);const H=this._validateNode(R.rootNode.id,R.rootNode);H&&this._addNode(H,0)}}addClientNodeToIndex(R,G){const H=new ht.ay(R,G),W=this._makeClientRefNode(H,-1);return this._linkChildToParentNode(-1,W),this.requestUpdate(),W}removeClientNodeFromIndex(R,G,H){this._destroyClientRefNode(R,G,H),this.requestUpdate()}_loadPage(R){this._loadingPages.add(R);const G=this._urlPrefix+R;this._streamDataController.request(G,"json").then((G=>{this._pageQueue.push({pageIndex:R,page:G})})).catch((G=>{this._loadingPages.delete(R),(0,X.zf)(G)||(this._failedPages.add(R),this._logger.error("#loadPage()",this._layer,"Error when loading page ".concat(R),G))}))}_addQueuedPages(R){for(;this._pageQueue.length>0&&!R.done;){const{pageIndex:G,page:H}=this._pageQueue.shift();this._addPage(G,H),this._loadingPages.delete(G),R.madeProgress(),this.needNodeElevationRange&&this._newPages.push(G)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(R){if(this.needNodeElevationRange)for(;this._newPages.length>0&&!R.done;){const R=this._nodePages.get(this._newPages.shift());null===R||void 0===R||R.nodes.forEach((R=>{let G=R.parent;for(;null!=G&&G!==this._rootIndex;){const R=this.getNode(G);R&&!Number.isNaN(null===R||void 0===R?void 0:R.elevationRangeMin)&&(R.invalidateElevationRange(),this.invalidateBoundingVolumeCache(G)),G=this.getParentIndex(G)}}))}}_addPage(R,G){const H=[],W=[],q=G.nodes.map(((G,q)=>{var Q,J,X;const $=H.length,K=G.children?G.children.length:0;W.push(this._rootIndex);for(let R=0;R<K;R++)H.push(G.children[R]);const ee="".concat(G.index),te=_t.ab.fromJSON(G.obb),ie=(0,Ge.b)(te.center,te.radius),re=null===(Q=G.mesh)||void 0===Q?void 0:Q.attribute,ne=null===(J=G.mesh)||void 0===J?void 0:J.geometry,se=null===(X=G.mesh)||void 0===X?void 0:X.material,ae={hasSharedResource:!1,isEmpty:null==ne,attributes:null!=(null===re||void 0===re?void 0:re.resource)?"".concat(re.resource):void 0,geometry:null!=(null===ne||void 0===ne?void 0:ne.resource)?"".concat(ne.resource):void 0,texture:null!=(null===se||void 0===se?void 0:se.resource)?"".concat(se.resource):void 0,geometryDefinition:ne?ne.definition:-1,materialDefinition:se?se.definition:-1},oe=new ht.bP(ee,I3SIndex_A(q,R,this._pageSize),ie,K,0,ae,this._lastUpdate,this._lodMetric,this._lodConversion(G.lodThreshold),ne?ne.featureCount:null);return oe.serviceObbInIndexSR=te,oe.visibilityObbInRenderSR=this._computeVisibilityObb(oe),oe.vertexCount=ne?ne.vertexCount:0,new I3SIndex_p($,K,I3SIndex_S(this._visibilityCacheVersion),null,oe)})),Q=new I3SIndex_b(q,H);-1===R?this._clientNodePage=Q:this._nodePages.set(R,Q)}_updateParentsAndLevel(){const R=new Array,t=(G,H,W)=>{const q=this._getPage(G);if(null!=q){const Q=I3SIndex_V(G,this._pageSize),J=q.nodes[Q];J.parent=null!=H?H:-1;const X=J.node;null!=X&&(X.level=W,R.push(G))}};for(t(this._rootIndex,null,0);R.length;){const G=R.pop(),H=this.getNode(G);if(null!=H)for(let R=0;R<H.childCount;R++)t(this.getChildIndex(H.index,R),G,H.level+1),this._maxLevel=Math.max(this._maxLevel,H.level+1)}}_getPage(R){const G=I3SIndex_E(R,this._pageSize);return this._getPageFromPageIndex(G)}_getPageFromPageIndex(R){return R<0?this._clientNodePage:this._nodePages.get(R)}_getNodeInternal(R){const G=this._getPage(R);return null==G?null:(G.lastTraversed=this._frameNumber,G.nodes[I3SIndex_V(R,this._pageSize)])}_addNode(R,G){R.children&&this.populateChildren(G,R.children);const H=this.getParent(G),W=null!=H?H.level+1:0;this._maxLevel=Math.max(this._maxLevel,R.children?W+1:W);const{lodMetric:q,maxError:Q}=function I3SIndex_L(R){if(R)for(let G=0;G<R.length;G++)for(const H of gt)if(H[0]===R[G].metricType)return{lodMetric:H[1],maxError:R[G].maxError};return{lodMetric:ht.cJ.None,maxError:0}}(R.lodSelection),J=this._getNodeInternal(G),X=new ht.bP(R.id,G,R.mbs,J.childCount,W,R.resources,R.version,q,Q,R.numFeatures);J.node=X,R.obb&&(X.serviceObbInIndexSR=_t.ab.fromJSON(R.obb)),X.visibilityObbInRenderSR=this._computeVisibilityObb(X);const $=J.ref;return null!=$&&(null==$.serviceMbsInIndexSR&&($.serviceMbsInIndexSR=R.mbs),X.shareServiceBVsInRenderSRWith($),$.visibilityObbInRenderSR=X.visibilityObbInRenderSR),X}_makeRefNode(R,G){const H=this._nodePages.get(0);if(G<-1)return this._makeClientRefNode(R,G);if(null==H)return-1;const W=H.nodes.length,q=new I3SIndex_p(0,0,I3SIndex_S(this._visibilityCacheVersion),R,null);return H.nodes.push(q),q.parent=G,R.invalidateServiceBVsInRenderSR(),W}_makeClientRefNode(R,G){const H=this._clientNodePage;if(null==H)return-1;if(G>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const W=-(H.nodes.length+1),q=new I3SIndex_p(0,0,I3SIndex_S(this._visibilityCacheVersion),R,null);return H.nodes.push(q),q.parent=G,R.invalidateServiceBVsInRenderSR(),W}_linkChildToParentNode(R,G){const H=this._clientNodePage;if(null==H||R>=0)return;const W=I3SIndex_V(R,this._pageSize),q=I3SIndex_V(G,this._pageSize),Q=H.nodes[W],J=Q.childOffset;H.children.splice(Q.childOffset+Q.childCount,0,G);Q.childCount+=1,null!=Q.node&&(Q.node.childCount+=1);for(const X of H.nodes)X.childOffset>J&&(X.childOffset+=1);H.nodes[q].parent=R,this._updateParentBoundingInformation(R)}_destroyClientRefNode(R,G,H){const W=this._clientNodePage;if(null==W)return;const q=this.getParentIndex(R);if(null==q)return;const Q=new Set,J=new Map,a=R=>{var H,q,J;const X=I3SIndex_V(R,this._pageSize),$=W.nodes[X];if($.childCount>0)for(let G=$.childOffset;G<$.childOffset+$.childCount;++G)a(W.children[G]);const K=null!==(H=null===(q=$.node)||void 0===q?void 0:q.id)&&void 0!==H?H:null===(J=$.ref)||void 0===J?void 0:J.id;if(null==K)throw new Error("Node has no id");G(K,R),Q.add($)};a(R);const X=W.nodes,$=W.children,K=W.nodes.map((()=>-1)),ee=[],te=[];for(let se=0;se<X.length;++se){const R=X[se];if(Q.has(R))continue;const G=ee.length,W=I3SIndex_A(se,-1,this._pageSize),q=I3SIndex_A(G,-1,this._pageSize);if(R.node&&(R.node.index=q),K[se]=q,ee.push(R),W!==q){var ie,re,ne;const G=null!==(ie=null===(re=R.node)||void 0===re?void 0:re.id)&&void 0!==ie?ie:null===(ne=R.ref)||void 0===ne?void 0:ne.id;if(null==G)throw new Error("Node has no id");H(G,W,q),J.set(W,q)}}for(let se=0;se<ee.length;++se){const R=I3SIndex_A(se,-1,this._pageSize),G=ee[se],H=te.length;for(let W=G.childOffset;W<G.childOffset+G.childCount;++W){const G=$[W];if(G>=0)te.push(G);else{const H=I3SIndex_V(G,this._pageSize),W=X[H];if(Q.has(W))continue;const q=K[H];te.push(q),W.parent=R}}G.childOffset=H,G.childCount=te.length-H,G.node&&(G.node.childCount=G.childCount)}W.nodes=ee,W.children=te,this._updateParentBoundingInformation(K[I3SIndex_V(q,this._pageSize)])}_updateParentBoundingInformation(R){let G=R;do{var H;let R=null;const W=this._clientNodeLoader.indexSR,q=this._clientNodeLoader.renderSR,Q=this._getNodeInternal(G);if(null==Q)return;for(let H=0;H<Q.childCount;H++){const Q=this.getChildIndex(G,H),J=this._getNodeInternal(Q),X=null!=J?J.ref||J.node:null;if(null!=X&&X.serviceMbsInIndexSR[3]>0)if(null==R)R=(0,Ge.c)(X.serviceMbsInIndexSR,ft);else{const G=yt,H=vt,Q=bt;projectBoundingSphere_a(X.serviceMbsInIndexSR,W,G,q),projectBoundingSphere_a(R,W,H,q),(0,Ge.u)(G,H,Q),projectBoundingSphere_a(Q,q,R,W)}}const J=Q.ref||Q.node;null!=J&&(null!=R?(null!==(H=J.serviceMbsInIndexSR)&&void 0!==H||(J.serviceMbsInIndexSR=(0,Ge.d)()),(0,Ge.c)(R,J.serviceMbsInIndexSR)):(0,ut.Q7)(J.serviceMbsInIndexSR),J.invalidateServiceBVsInRenderSR(),J.geometryObbInRenderSR=null),this.invalidateNodeVisibilityCacheInternal(Q),G=this.getParentIndex(G)}while(null!=G)}populateChildren(R,G){const H=this._getNodeInternal(R),W=this._getPage(R);H.childOffset=W.children.length,H.childCount=G.length;for(let q=0;q<G.length;q++){const H=this._makeRefNode(G[q],R);W.children.push(H)}}getNode(R){const G=this._getNodeInternal(R);return null!=G?G.node:null}getIndexById(R){let G;return this._forAllNodes(((H,W)=>{(null!=H.node&&H.node.id===R||null!=H.ref&&H.ref.id===R)&&(G=W)})),G}getNodeById(R){const G=this.getIndexById(R);return null!=G&&G>=0?this.getNode(G):null}getChildIndex(R,G){const H=this._getPage(R);if(null==H)return-1;const W=H.nodes[I3SIndex_V(R,this._pageSize)];return H.children[W.childOffset+G]}getParentIndex(R){const G=this._getPage(R);return null!=G&&R!==this._rootIndex?G.nodes[I3SIndex_V(R,this._pageSize)].parent:null}getParent(R){const G=this.getParentIndex(R);return null!=G?this.getNode(G):null}isLeaf(R){const G=this._getNodeInternal(R);return null!=G&&0===G.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes((R=>{null!=R.node&&(R.node.geometryObbInRenderSR=null)}))}invalidateVisibilityCache(){this._visibilityCacheVersion=I3SIndex_R(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(R){const G=this._getNodeInternal(R);null!=G&&this.invalidateNodeVisibilityCacheInternal(G)}invalidateNodeVisibilityCacheInternal(R){R.visibilityCache=I3SIndex_S(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(R){const G=this._getNodeInternal(R);null!=G&&(I3SIndex_x(G),this.invalidateNodeVisibilityCacheInternal(G))}updateElevationChanged(R){const G=this._getNodeInternal(R);if(null==G)return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(R);const H=null!=G.node?G.node:G.ref;null!=H&&H.invalidateElevationRange()}invalidateGeometryVisibility(R){const G=this._getNodeInternal(R),H=null===G||void 0===G?void 0:G.node;H&&(H.geometryObbInRenderSR=null,H.invalidateServiceBVsInRenderSR())}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,(R=>(R.visibilityObbInRenderSR=this._computeVisibilityObb(R),R.geometryObbInRenderSR=null,!0)))}_updateElevationRange(R){this._updateElevationRangeInternal(R,null)}_updateElevationRangeInternal(R,G){var H,W,q;const Q=this._getNodeInternal(R);if(!Q)return!1;const J=null!==(H=null===Q||void 0===Q?void 0:Q.node)&&void 0!==H?H:null===Q||void 0===Q?void 0:Q.ref;if(!J)return!1;if(J.elevationRangeValid)return null!==G&&void 0!==G&&G.expandElevationRange(J),!0;const X=new pt.H;let $=!1;for(let ie=0;ie<Q.childCount;ie++){const G=this.getChildIndex(R,ie),H=this._updateElevationRangeInternal(G,X);$=$||!H}if(0===Q.childCount||$){var K;const R=!(null!==(K=Q.node)&&void 0!==K&&K.resources.isEmpty);this._viewportQueries.expandElevationRange(J,R,X)}const ee=J.elevationRangeMin,te=J.elevationRangeMax;return ee===X.elevationRangeMin&&te===X.elevationRangeMax?(null!==G&&void 0!==G&&G.expandElevationRange(J),!0):(null!==(W=Q.node)&&void 0!==W&&W.setElevationRange(X),null!==(q=Q.ref)&&void 0!==q&&q.setElevationRange(X),this.invalidateBoundingVolumeCache(R),null!==G&&void 0!==G&&G.expandElevationRange(J),!0)}isNodeVisible(R){const G=this._getNodeInternal(R);if(null==G)return!0;const H=G.ref;if(null!=H&&!H.serviceMbsInIndexSR)return!0;if(!this.needNodeElevationRange&&I3SIndex_w(G.visibilityCache,this._visibilityCacheVersion))return I3SIndex_M(G.visibilityCache);const W=G.node,q=this._viewportQueries;if(W&&W.level>0){q.ensureElevationAgnosticBoundingVolume(W,this.viewingMode);const R=W.elevationAgnosticBoundingVolume;if(!q.isElevationAgnosticBoundingVolumeVisible(this.viewingMode,R))return G.visibilityCache=I3SIndex_C(!1,this._visibilityCacheVersion),!1}if(this.needNodeElevationRange&&this._updateElevationRange(R),!I3SIndex_w(G.visibilityCache,this._visibilityCacheVersion)){if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=W||null!=H)&&G.filterImpact===ht.TJ.NotChecked){const R=null!=W?W.serviceMbsInIndexSR:null!=H?H.serviceMbsInIndexSR:null;G.filterImpact=null!=R?this._computeNodeFiltering(R):ht.TJ.Unmodified}const R=null!=W&&G.filterImpact===ht.TJ.Culled,Q=null!=W&&W.imModificationImpact===ht.Js.Culled,J=!W||H&&!W.visibilityObbInRenderSR?null!==H&&void 0!==H?H:null:W,X=!Q&&(!J||q.isNodeVisible(J))&&!R;return G.visibilityCache=I3SIndex_C(X,this._visibilityCacheVersion),X}return I3SIndex_M(G.visibilityCache)}isGeometryVisible(R){var G;if(!this.isNodeVisible(R))return!1;const H=this._getNodeInternal(R);return!!(null==(null===H||void 0===H||null===(G=H.node)||void 0===G?void 0:G.geometryObbInRenderSR)||this.layerHasModifications&&H.node.imModificationImpact===ht.Js.NotChecked)||this._viewportQueries.isGeometryVisible(H.node)}_traverseCoverage(R,G,H,W,q){const Q=this._getPage(R);if(null==Q||0===G.childCount)return;const J=G.childOffset+G.childCount,X=new Array;for(let $=G.childOffset;$<J;++$){const R=Q.children[$],G=this._getNodeInternal(R);null!=(null===G||void 0===G?void 0:G.node)&&this.isGeometryVisible(R)&&X.push(G)}W/=X.length;for(const $ of X){const R=$.node.index;this._isLoaded(R)||this._isReloading(R)?(q.delta=Math.max(q.delta,H),q.coverage+=W):this._traverseCoverage(R,$,H+1,W,q)}}useNodeAsHole(R){if("off"===this.holeFilling)return!1;const G=this._getNodeInternal(R);if(null==G)return!1;if("always"===this.holeFilling)return!0;if(I3SIndex_w(G.useAsHole,this._version))return I3SIndex_M(G.useAsHole);const H={delta:0,coverage:0};this._traverseCoverage(R,G,0,1,H);const W=H.delta*H.coverage<=.5;return G.useAsHole=I3SIndex_C(W,this._version),W}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=I3SIndex_R(this._version)}imModificationsChanged(R){this.layerHasModifications=R,this._forAllNodes((R=>{let{node:G}=R;null!=G&&(G.imModificationImpact=ht.Js.NotChecked,G.visibilityObbInRenderSR=this._computeVisibilityObb(G),G.hasModifications&&this.invalidateGeometryVisibility(G.index))})),this.invalidateVisibilityCache()}layerFilterChanged(R){this._layerHasFilter=R,this._forAllNodes((R=>{if(null!=R){R.filterImpact=ht.TJ.NotChecked;const G=R.node;null!=G&&this.invalidateNodeVisibilityCache(G.index)}})),this.invalidateVisibilityCache()}update(R,G,H){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(G),this._invalidateElevationRangeForNewPages(G),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(R),mt.clear();let W=!0;const q=new I3SIndex_F,Q=new I3SIndex_F,J=this._imModificationUncategorized;J.clear();const X=new Set;let $=0;this.traverseVisible(((X,K,ee)=>{const te=I3SIndex_E(X,this._pageSize);if(null==K){let R=this._entryPriority(X);return R===1/0&&(R=this._entryPriority(ee)),mt.set(te,Math.max(R,mt.get(te)||0)),this._loadingPages.has(te)||this._failedPages.has(te)||(this._missingPagesAndNodes.push(te),++$),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,R))}const ie=K.node;if(this._updateNodeFeatureEstimate(ie,Q),null==ie){const R=this._entryPriority(X);return this._loadingNodes.has(X)||this._failedNodes.has(X)||(this._missingPagesAndNodes.push(X),mt.set(X,R)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,R))}const re=this._getPage(X);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(let R=0;R<K.childCount;R++){const G=re.children[K.childOffset+R],H=this._getNodeInternal(G);null==H||H.node||this._loadingNodes.has(G)||this._failedNodes.has(G)||(mt.set(G,this._entryPriority(G)),this._prefetchNodes.push(G))}if(ie.failed||ie.resources.isEmpty)return void(W&&K.childCount>0&&this._isSelected(ie)&&(W=!1));if(this._isLoaded(X)){if(q.known+=ie.memory,++q.knownNodes,this._isSelected(ie)?K.childCount>0&&(W=!1):(q.unremoved+=ie.memory,W=!1),this._needsUpdate(ie)){const R=this._entryPriority(X);mt.set(X,R),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,R),this._updates.update.push(X)}return}if(ie.memory&&(q.known+=ie.memory,++q.knownNodes),!this._isSelected(ie))return void(this._isReloading(X)&&this._updates.remove.push(X));if(K.childCount>0&&(W=!1),ie.memory?(q.missing+=ie.memory,q.known+=ie.memory,++q.knownNodes):++q.missingNodes,R.includes(ie.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(X)),void(this._updates.cancel=this._updates.cancel.filter((R=>R!==ie.index)));if(!G.done&&this._enable(ie))return void G.madeProgress();const ne=this._entryPriority(X);mt.set(X,ne),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,ne),this._updates.add.push(X),this.layerHasModifications&&H&&null!=ie&&ie.imModificationImpact===ht.Js.NotChecked&&J.push(X)}),X),this._frameNumber++,this._missingPagesAndNodes.sort(((R,G)=>R-G)),this._missingPagesAndNodes.filterInPlace(((R,G)=>G<1||this._missingPagesAndNodes.data[G-1]!==R)),this._missingPagesAndNodes.sort(((R,G)=>mt.get(R)-mt.get(G))),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=mt.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(X,$);const K=this._updates.add;K.length>0&&this.layerHasModifications&&(J.length>0&&null!==H&&void 0!==H&&H(J),K.filterInPlace((R=>{const G=this._getNodeInternal(R),H=null==(null===G||void 0===G?void 0:G.node)||G.node.imModificationImpact!==ht.Js.Culled;return H||this.invalidateNodeVisibilityCache(R),H}))),this._unloadedMemoryEstimate=q.missing-q.unremoved,q.knownNodes>3&&q.missingNodes>0&&(this._unloadedMemoryEstimate+=q.known/q.knownNodes*q.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(Q),this._featureEstimate.leavesReached=W,this._updates.add.filterInPlace((R=>mt.get(R)>=this._maxUnloadedPrio)).sort(((R,G)=>mt.get(R)-mt.get(G))),this._updates.update.sort(((R,G)=>mt.get(R)-mt.get(G))),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,mt.clear()}checkFeatureTarget(R,G){const H=this._viewportQueries.updateScreenSpaceErrorBias(G);let W=G,q=G,Q=H,J=10;for(;J--;){const H=new I3SIndex_F;if(this._updateFeatureEstimate(W,H),this._computeFeatureEstimate(H)<=R){if(W>=G||H.missingNodes>0||0===J)break;Q=W,W=.5*(W+q)}else q=W,W=.5*(W+Q)}return this._version=I3SIndex_R(this._version),this._viewportQueries.updateScreenSpaceErrorBias(H),Math.min(G,W)}_removeUnusedNodePages(R,G){if(!this._useNodePages)return;const H=R.size,W=this._nodePages,q=W.size+this._loadingPages.size+G;if(q>xt&&q>H){const G=new Array;for(const[H,q]of W)0!==q.numNodesWithLoadedChildren||R.has(H)||G.push([q.lastTraversed,H]);G.sort(((R,G)=>R[0]-G[0])).some((R=>{const G=R[1];return this._deleteNodePage(G),W.size<=xt}))}}_updateFeatureEstimate(R,G){this._version=I3SIndex_R(this._version),this._viewportQueries.updateScreenSpaceErrorBias(R),this.traverseVisible(((R,H)=>this._updateNodeFeatureEstimate(null!=H?H.node:void 0,G)))}_updateNodeFeatureEstimate(R,G){null==R||R.failed||null==R.numFeatures||this._isSelected(R)&&(null!=R.numFeatures?(G.missing+=R.numFeatures,G.known+=R.numFeatures,++G.knownNodes):++G.missingNodes)}_computeFeatureEstimate(R){let G=R.known-R.unremoved;return R.knownNodes>3&&R.missingNodes>0&&(G+=R.known/R.knownNodes*R.missingNodes),Math.max(0,G)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){return this._prefetchNodes.sort(((R,G)=>mt.get(R)-mt.get(G))),this._load(this._prefetchNodes)}_load(R){if(0===R.length||!this._canRequest())return!1;for(;R.length>0&&this._canRequest();){const G=R.pop();this._useNodePages&&G>=0?this._loadPage(G):this._loadNode(G)}return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetchNodes.length>0}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(R){if(null==R)return null;const G=R.index,H=this._getNodeInternal(G);if(!H)return null;let W=null===H||void 0===H?void 0:H.traversalState;if(W&&I3SIndex_w(W.version,this._version))return W;const q=this._viewportQueries.getLodLevel(R),Q=this._viewportQueries.hasLOD(R);let J=!0;if(Q){const R=this.getParentIndex(G);if(null!=R){const G=this._getNodeInternal(R),H=null===G||void 0===G?void 0:G.traversalState;J=!!H&&q>H.lodLevel}else J=q>0}else J=0===R.childCount;return W?(W.lodLevel=q,W.isChosen=J,W.version=I3SIndex_C(!0,this._version),W):(W=new ht.EG(Q,J,q,I3SIndex_C(!0,this._version)),H.traversalState=W,W)}async _loadNode(R){this._loadingNodes.add(R);const G=this._getNodeInternal(R).ref;if(null==G)return void this._failedNodes.add(R);const H=G.id,W=this._urlPrefix+H,o=()=>{this._loadingNodes.delete(R),0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()};let q=null;try{q=R>=0?await this._streamDataController.request(W,"json"):await this._clientNodeLoader.loadNodeJSON(H)}catch($){return o(),void((0,X.zf)($)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+W),this._failedNodes.add(R)))}o();const Q=this._validateNode(H,q);if(null==Q)return;Q.obb&&this.invalidateNodeVisibilityCache(R);const J=this._addNode(Q,R);this.nodeTraversalState(J)}_validateNode(R,G){var H,W;if(null==G||"object"!=typeof G||G.id!==R)return this._logger.error("#validateNode()",this._layer,'Invalid node. Wrong type or wrong id "'.concat(R,'"')),null;if(!Array.isArray(G.mbs))return this._logger.error("#validateNode()",this._layer,"Invalid bounding volume on node ".concat(R,".")),null;G.sharedResource&&"./shared"!==G.sharedResource.href&&"./shared/"!==G.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,'Invalid shared resource href on node "'.concat(R,'"'));const q=G.geometryData;null==q||Array.isArray(q)&&0===q.length||Array.isArray(q)&&1===q.length&&"./geometries/0"===q[0].href||this._logger.warn("#validateNode()",this._layer,'Invalid geometry data on node "'.concat(R,'"'));const Q=G.attributeData,J=this._layer.attributeStorageInfo;null==Q||Array.isArray(Q)&&!Q.some(((R,G)=>{var H,W;return R.href!=="./attributes/".concat(null!==(H=null===J||void 0===J||null===(W=J[G])||void 0===W?void 0:W.key)&&void 0!==H?H:"f_".concat(G),"/0")}))||this._logger.warn("#validateNode()",this._layer,'Invalid attribute data on node "'.concat(R,'"')),G.featureData&&G.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,"Node ".concat(R," has ").concat(G.featureData.length," bundles. Only the first bundle will be loaded."));const X=G.hasOwnProperty("obb")&&!this.ignoreServiceObb?G.obb:void 0,$=G.featureData&&1===G.featureData.length&&G.featureData[0].featureRange?G.featureData[0].featureRange[1]-G.featureData[0].featureRange[0]+1:void 0,K=Array.isArray(G.children)?G.children.map((G=>{if(null==G)return null;const i=G=>this._logger.error("#validateNode()",this._layer,"Invalid node reference on node ".concat(R,": ").concat(G));if("number"==typeof G.id)i("id ".concat(G.id," is a number instead of a string."));else if("string"!=typeof G.id||!Array.isArray(G.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(G.mbs))return i("Invalid bounding volume on reference ".concat(G.id,".")),null;G.href&&G.href!=="../"+G.id&&this._logger.error("#validateNode()",this._layer,'Invalid node href on node "'.concat(R,'"'));const H=new ht.ay("".concat(G.id),G.mbs);return H.serviceObbInIndexSR=!this.ignoreServiceObb&&G.hasOwnProperty("obb")&&G.obb?_t.ab.fromJSON(G.obb):null,H.visibilityObbInRenderSR=this._computeVisibilityObb(H),H})).filter((R=>null!=R)):null,ee=null!==(H=null===(W=G.featureData)||void 0===W?void 0:W.length)&&void 0!==H&&H,te=!0===G.isEmpty;return new ValidatedNode_s(R,G.mbs,X,"string"==typeof G.version?G.version:null,{isEmpty:!ee&&te,hasSharedResource:null!=G.sharedResource,attributes:G.attributeData?R:void 0,texture:G.textureData&&G.textureData.length>0?R:void 0,geometry:null!=G.geometryData?R:void 0},K,Array.isArray(G.lodSelection)?G.lodSelection:null,$)}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes((R=>{null!=R.node&&(R.node.failed=!1)}))}_entryPriority(R){const G=this._getNodeInternal(R),H=this.getParentIndex(R);if(null==G||null==H&&null==G.node)return null==H?1/0:this._entryPriority(H);let W=0;if(G.node&&null!=H){const R=this._getNodeInternal(H).traversalState;null!=R&&(W=R.lodLevel)}let q=this.progressiveLoadPenalty;for(let J=R;null!=J;J=this.getParentIndex(J))if(this._isLoaded(J)){q=0;break}const Q=null!=G.ref?this._viewportQueries.distToPOI(G.ref):null!=G.node?this._viewportQueries.distToPOI(G.node):0;return-Q-W*(Q+this.progressiveLoadPenalty)+q}traverseVisible(R,G){const H=this._getNodeInternal(this._rootIndex);null!=H?this._traverseVisible(this._rootIndex,null,H,R,G):R(this._rootIndex,null,null)}_traverseVisible(R,G,H,W,q){const Q=I3SIndex_E(R,this._pageSize);if(q&&q.add(Q),H.node&&0===H.childCount)return void(this.isGeometryVisible(R)&&W(R,H,G));if(!this.isNodeVisible(R))return;if(W(R,H,G),null==H.node)return;const J=this.nodeTraversalState(H.node);if(null!==J&&void 0!==J&&J.nodeHasLOD&&J.lodLevel===this._maxLodLevel)return;const X=this._getPageFromPageIndex(Q);for(let $=0;$<H.childCount;$++){const G=X.children[H.childOffset+$],Q=this._getNodeInternal(G);if(Q)this._traverseVisible(G,R,Q,W,q);else{if(q){const R=I3SIndex_E(G,this._pageSize);q.add(R)}W(G,null,R)}}}traverse(R,G){G(R)&&this.traverseDescendants(R,G)}traverseDescendants(R,G){++this._traverseDescendantsNestingLevel;const H=R.index,W=this._pageSize,q=I3SIndex_E(H,W),Q=this._getPageFromPageIndex(q);if(null==Q)return;const J=this._frameNumber,X=this._nodePages;Q.lastTraversed=J;const $=I3SIndex_V(H,W),K=Q.nodes[$],{childCount:ee}=K;if(0===ee)return;const te=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];let ie=0;const re=[];{const{childOffset:R,childCount:G}=K,{children:H}=Q;te.length=2**Math.ceil(Math.log2(ie+G));for(let W=R;W<R+G;++W){const R=H[W];R>=0?(te[ie]=R,++ie):re.push(R)}}if(re.length>0){const R=this._clientNodePage;if(R){const H=R.children;let W=0;for(;W<re.length;){const q=re[W];++W;const Q=-q-1,J=R.nodes[Q],X=J.node;if(!X)continue;if(!G(X))continue;const{childCount:$}=J;if(0===$)continue;const{childOffset:K}=J,ee=K+$;for(let R=K;R<ee;++R)re.push(H[R])}}}if(ie>0){let R=0;if(W>0){let H=q*W,$=Q,K=$.nodes;for(;R<ie;){const q=te[R];let Q;if(++R,H<=q&&q<H+W)Q=$;else{const R=q/W|0,G=X.get(R);if(void 0===G)continue;Q=G,Q.lastTraversed=J,$=Q,K=$.nodes,H=W*R}const ee=K[q-H],re=ee.node;if(null==re)continue;if(!1===G(re))continue;const{childCount:ne}=ee;if(0===ne)continue;const se=ie+ne;for(te.length<se&&(te.length=2**Math.ceil(Math.log2(ie+ne)));te.length<ie+ne;)te.length+=te.length;const ae=Q.children,{childOffset:oe}=ee,le=oe+ne;for(let R=oe;R<le;++R)te[ie]=ae[R],++ie}}else{const H=X.get(0);if(H)for(;R<ie;){const W=te[R];++R;const q=H.nodes[W],Q=q.node;if(!Q)continue;if(!G(Q))continue;const{childCount:J}=q;if(0===J)continue;te.length=Math.max(te.length,2**Math.ceil(Math.log2(ie+J)));const X=H.children,{childOffset:$}=q,K=$+J;for(let R=$;R<K;++R)te[ie]=X[R],++ie}}}--this._traverseDescendantsNestingLevel}updateChildrenLoaded(R,G){let H=this.getNode(R);for(;null!=H;){const R=H.childrenLoaded,W=R+G;H.childrenLoaded=W;const q=0===R?1:0===W?-1:0,Q=H.index;0!==q&&(this._getPage(Q).numNodesWithLoadedChildren+=q),H=this.getParent(Q)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;const R=[],t=G=>{let H=this._isLoaded(G.index)||this._isReloading(G.index)?1:0;return this.traverseDescendants(G,(R=>(H+=t(R),!1))),G.childrenLoaded!==H&&R.push(G.index),H};return t(this.rootNode),R.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+R.join(",")),R.length>0}updateElevationInfo(R,G){this.needNodeElevationRange=G&&!!R&&("relative-to-ground"===R.mode||"on-the-ground"===R.mode),this._viewportQueries.updateElevationInfo(R),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes((R=>{I3SIndex_x(R),null!=R.node&&R.node.invalidateElevationRange(),null!=R.ref&&R.ref.invalidateElevationRange()}))}_forAllNodes(R){if(null!=this._clientNodePage){const G=this._clientNodePage;for(let H=0;H<G.nodes.length;H++)R(G.nodes[H],-(H+1))}for(const[G,H]of this._nodePages){const W=G*this._pageSize;for(let G=0;G<H.nodes.length;G++)R(H.nodes[G],W+G)}}clearCaches(){if(this._useNodePages){const R=this._nodePages,G=new Set;this.traverseVisible((R=>G.add(I3SIndex_E(R,this._pageSize))));for(const[H,W]of R)if(0!==W.numNodesWithLoadedChildren||G.has(H))for(const R of W.nodes)R.traversalState=null;else this._deleteNodePage(H)}}_deleteNodePage(R){this._nodePages.delete(R)}get test(){return{addNode:(R,G)=>this._addNode(this._validateNode(R.id,R),G),getNodeInternal:R=>this._getNodeInternal(R),getPageIndex:R=>I3SIndex_E(R,this._pageSize),getIndexWithinPage:R=>I3SIndex_V(R,this._pageSize),getNodePage:R=>R<0?this._clientNodePage:this._nodePages.get(R),getChildIndices:R=>{const G=this._getNodeInternal(R),H=this._getPage(R);if(null==G||null==H)return[];const W=[];for(let q=G.childOffset;q<G.childOffset+G.childCount;++q)W.push(H.children[q]);return W},rootIndex:this._rootIndex,clientNodePage:this._clientNodePage,nodePages:this._nodePages}}}const mt=new Map;class I3SIndex_y{constructor(R){this.missing=R,this.update=new pe.A({deallocator:null}),this.add=new pe.A({deallocator:null}),this.remove=new pe.A({deallocator:null}),this.cancel=[]}reset(R){this.add.clear(),this.update.clear(),this.cancel=R}}function I3SIndex_x(R){var G,H;null!==(G=R.node)&&void 0!==G&&G.invalidateServiceBVsInRenderSR(),null===(H=R.ref)||void 0===H||H.invalidateServiceBVsInRenderSR()}function I3SIndex_S(R){return(0,ut.b$)(R,-2)}function I3SIndex_R(R){return(0,ut.b$)(R,2)}function I3SIndex_C(R,G){return G+(R?1:0)}function I3SIndex_w(R,G){return(-2&R)===G}function I3SIndex_M(R){return 1==(1&R)}function I3SIndex_E(R,G){return R<0?-1:G>0?R/G|0:0}function I3SIndex_V(R,G){return R<0?-R-1:0===G?R:R%G}function I3SIndex_A(R,G,H){return-1===G?-(R+1):0===H?R:G*H+R}const gt=[["maxScreenThreshold",ht.cJ.MaxScreenThreshold],["screenSpaceRelative",ht.cJ.ScreenSpaceRelative],["removedFeatureDiameter",ht.cJ.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",ht.cJ.DistanceRangeFromDefaultCamera]];class I3SIndex_F{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function I3SIndex_k(R){return Math.sqrt(R*(4/Math.PI))}const ft=(0,Ge.d)(),yt=(0,Ge.d)(),vt=(0,Ge.d)(),bt=(0,Ge.d)(),xt=(0,te.A)("esri-mobile")?100:300;var St;!function(R){R[R.FadeIn=0]="FadeIn",R[R.FadeOut=1]="FadeOut"}(St||(St={}));class I3SLodHandling_o{constructor(R){this._layerView=R,this._lodGlobalDirty=!1}startNodeLoading(R,G,H,W){this._maxLodLevel=W.maxLodLevel,this._index=H,this._isNodeInScaleBounds=R,this._removeNodes=G}shouldLoadNode(R){if(null==R)return!1;const G=this._index.nodeTraversalState(R);return!!this._isChosenMaxLOD(G)||!!G.isChosen&&this._childrenRequireLoading(R)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(R){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const G=this._layerView.view.resourceController.memoryController.usedMemory,H=Math.max(0,Math.floor(10*(G-1)));wt.clear(),this._lodGlobalHandling(this._index.rootNode,H,!1,!!this._layerView.nodeCrossfadingEnabled);const W=wt.length;this._removeNodes(wt,R);const q=wt.length<W;return 0!==wt.length&&(this._lodGlobalDirty=!0),wt.clear(),q}_lodGlobalHandling(R,G,H,W){if(null==R)return!1;const q=R.index,Q=this._index,J=this._layerView,X=Q.nodeTraversalState(R),$=this._isChosenMaxLOD(X),K=R.resources.isEmpty;if($&&K)return R.childrenLoaded>0&&this._removeChildrenRecursive(R),!0;const ee=J.isNodeLoaded(q);if(W&&ee&&$){const G=!H&&this.hasNoVisibleChildren(R);J.fadeNode(q,St.FadeIn,!G)}const te=ee&&(!J.isNodeFullyFadedIn||J.isNodeFullyFadedIn(q));if(ee&&(J.updateNodeState(q,$?ht.UY.Leaf:ht.UY.Hole),$))return te&&this._removeChildrenRecursive(R),te;const ie=R.childCount>0;let re=ie;if(ie)for(let ae=0;ae<R.childCount;ae++){const R=Q.getChildIndex(q,ae),J=Q.getNode(R);null!=J?Q.isGeometryVisible(R)&&!this._lodGlobalHandling(J,G,H||te,W)&&this._isNodeInScaleBounds(J)&&(re=!1):Q.isNodeVisible(R)&&(re=!1)}const ne=ee&&!$&&(re||wt.length<G);ne&&wt.push(q),!W||ne||!ee||H||re||J.fadeNode(q,St.FadeIn,!1);const se=R.resources.isEmpty;return re||te&&!ne||se}_removeChildrenRecursive(R){this._index.traverseDescendants(R,(R=>((this._layerView.isNodeLoaded(R.index)||this._layerView.isNodeReloading(R.index))&&wt.push(R.index),R.childrenLoaded>0)))}hasNoVisibleChildren(R){let G=!0;return this._index.traverseDescendants(R,(R=>!(!G||!this._index.isNodeVisible(R.index))&&(this._layerView.isNodeLoaded(R.index)?(G=!1,!1):R.childrenLoaded>0))),G}_childrenRequireLoading(R){let G=!1,H=!0;return this._index.traverseDescendants(R,(R=>{if(!H||!this._index.isNodeVisible(R.index))return!1;const W=this._index.nodeTraversalState(R);return this._isChosenMaxLOD(W)&&this._index.isGeometryVisible(R.index)&&(G=!0),this._layerView.isNodeLoaded(R.index)?(H=!1,!1):R.childrenLoaded>0})),H&&G}_isChosenMaxLOD(R){return R.isChosen&&(!R.nodeHasLOD||R.lodLevel===this._maxLodLevel)}}const wt=new pe.A({deallocator:null});var Rt=H(87149),Tt=H(66004),Et=H(4270),Pt=H(48557);var It,Dt=H(39059);!function(R){R[R.Earth=1]="Earth",R[R.Mars=2]="Mars",R[R.Moon=3]="Moon",R[R.COUNT=4]="COUNT"}(It||(It={}));var Lt=H(1382),Ft=H(60985);function I3SMaterialUtil_T(R){return R.sort(((R,G)=>R.encoding-G.encoding))}const Nt={ktx2:He.KTX2,basis:He.Basis,dds:He.DDS_S3TC,png:He.PNG,jpg:He.JPG,"ktx-etc2":He.KTX_ETC2},Vt={[et.JS.KTX2_ENCODING]:He.Basis,[et.JS.BASIS_ENCODING]:He.Basis,[et.JS.DDS_ENCODING]:He.DDS_S3TC,"image/png":He.PNG,"image/jpg":He.JPG,"image/jpeg":He.JPG,"image/ktx":He.KTX_ETC2};const I3SMaterialUtil_b=()=>({alphaMode:"opaque",alphaCutoff:Dt.H,doubleSided:!0,cullFace:et.s2.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});Ft.pF.CLAMP_TO_EDGE,Ft.pF.CLAMP_TO_EDGE,Ft.pF.REPEAT,Ft.pF.REPEAT;class I3SNodeLoader_d{constructor(R,G,H,W,q,Q){if(this._streamDataController=G,this._logger=H,this._defaultGeometrySchema=W,this._requiredAttributes=q,this._options=Q,this._logLayer=R,this._layerUrl=R.parsedUrl.path,this._geometryDefinitions=R.geometryDefinitions,R.materialDefinitions){const G=R.textureSetDefinitions;this._materialAndTextures=R.materialDefinitions.map((H=>function I3SMaterialUtil_h(R,G,H){var W,q;const Q=new Map,t=(R,G)=>{if(null==R)return-1;const H=Q.get(R.id);if(H)return H.usage|=G,H.id;const W=Q.size;return Q.set(R.id,{id:W,usage:G}),W},J=G.pbrMetallicRoughness,X=null===J||void 0===J?void 0:J.baseColorFactor,$=G.emissiveFactor,K=(0,te.A)("disable-feature:diffuse-rendering-i3s")||H?(0,it.me)({normalTexture:G.normalTexture,emissiveTexture:G.emissiveTexture,emissiveFactor:G.emissiveFactor,occlusionTexture:G.occlusionTexture,metallicRoughnessTexture:null===J||void 0===J?void 0:J.metallicRoughnessTexture,metallicFactor:null===J||void 0===J?void 0:J.metallicFactor,roughnessFactor:null===J||void 0===J?void 0:J.roughnessFactor}):(0,it.Jr)({normalTexture:G.normalTexture,emissiveTexture:G.emissiveTexture,emissiveFactor:G.emissiveFactor,occlusionTexture:G.occlusionTexture,metallicRoughnessTexture:null===J||void 0===J?void 0:J.metallicRoughnessTexture,metallicFactor:null===J||void 0===J?void 0:J.metallicFactor,roughnessFactor:null===J||void 0===J?void 0:J.roughnessFactor}),ee=K?it.mX[0]:null!==(W=null===J||void 0===J?void 0:J.metallicFactor)&&void 0!==W?W:it.Rk[0],ie=K?it.mX[1]:null!==(q=null===J||void 0===J?void 0:J.roughnessFactor)&&void 0!==q?q:it.Rk[1],re="mask"===G.alphaMode?je.Color|je.AlphaMask:je.Color,ne={baseColorFactor:X?[X[0],X[1],X[2],X[3]]:[1,1,1,1],baseColorTextureId:t(null===J||void 0===J?void 0:J.baseColorTexture,re),metallicRoughnessTextureId:t(null===J||void 0===J?void 0:J.metallicRoughnessTexture,je.MetallicRoughness),metallicFactor:ee,roughnessFactor:ie},se={alphaMode:G.alphaMode,alphaCutoff:G.alphaCutoff,doubleSided:G.doubleSided,cullFace:"none"===G.cullFace?et.s2.None:"back"===G.cullFace?et.s2.Back:"front"===G.cullFace?et.s2.Front:et.s2.None,normalTextureId:t(G.normalTexture,je.Normal),emissiveTextureId:t(G.emissiveTexture,je.Emissive),occlusionTextureId:t(G.occlusionTexture,je.Occlusion),emissiveFactor:$?[$[0],$[1],$[2]]:[0,0,0],metallicRoughness:ne,wrapTextures:!1,hasParametersFromSource:K},ae=[];return Q.forEach(((G,H)=>{let{usage:W}=G;const q=null!=R&&R[H]&&R[H].formats,Q=q?I3SMaterialUtil_T(q.map((R=>{let{name:G,format:H}=R;return{name:G,encoding:Nt[H]}}))):[];ae.push({id:H,usage:W,encodings:Q})})),{material:se,textures:ae}}(G,H,"integrated-mesh"===R.type)))}}_load(R,G,H){return this._streamDataController.request(R,G,H)}_loadAttribute(R,G,H){const W="".concat(this._layerUrl,"/nodes/").concat(R.resources.attributes,"/attributes/").concat(G.key,"/0");return this._load(W,"binary",H).then((R=>(0,Pt.m0)(G,R)))}async loadAttributes(R,G,H){const W=await Promise.allSettled(G.map((G=>this._loadAttribute(R,G.attributeStorageInfo,H)))),q={};for(let Q=0;Q<G.length;++Q){const H=W[Q],J=G[Q];if("fulfilled"===H.status){const R=H.value;q[J.name]=R}else{const G=H.reason;(0,X.QP)(G),this._logger.error("#loadAttributes",this._logLayer,"Failed to load attributeData for '".concat(J.name,"' on node '").concat(R.id,"'"),G)}}return q}async loadNodeData(R,G){var H;const W=null!=this._requiredAttributes&&R.resources.attributes?(0,Rt.Ke)(this.loadAttributes(R,this._requiredAttributes,G)):null,{bufferDefinition:q,bufferIndex:Q}=function I3SNodeLoader_(R,G){const H={bufferDefinition:null,bufferIndex:0},W=G.resources.geometryDefinition;if(null==R||null==W||W<0)return H;const q=W>=0?R[W].geometryBuffers:null;if(null==q)return H;for(let Q=0;Q<q.length;Q++){const R=q[Q];if(null==R.compressedAttributes)H.bufferIndex=Q,H.bufferDefinition=q[Q];else if("draco"===R.compressedAttributes.encoding&&!(0,te.A)("disable-feature:i3s-draco"))return H.bufferIndex=Q,H.bufferDefinition=R,H}return H}(this._geometryDefinitions,R),J=!!R.resources.geometry,X=J?(0,Rt.Ke)(this._loadGeometry(R.resources.geometry,Q,G)):null,$=R.resources.hasSharedResource?await this._loadShared(R,G):null,K=R.resources.materialDefinition,ee=this._materialAndTextures&&null!=K&&K>=0?this._materialAndTextures[K]:null!=$?function I3SMaterialUtil_F(R){var G,H;const W=null!==R&&void 0!==R&&R.materialDefinitions?Object.keys(R.materialDefinitions)[0]:null,q=null!==R&&void 0!==R&&R.textureDefinitions?Object.keys(R.textureDefinitions)[0]:null,Q=W?null===(G=R.materialDefinitions)||void 0===G?void 0:G[W]:null,J=q?null===(H=R.textureDefinitions)||void 0===H?void 0:H[q]:null,X=I3SMaterialUtil_b();if(null!=Q){const R=Q.params;R.diffuse&&(X.metallicRoughness.baseColorFactor=[R.diffuse[0],R.diffuse[1],R.diffuse[2],1]),null!=R.doubleSided&&(X.doubleSided=R.doubleSided,X.cullFace=R.doubleSided?et.s2.None:et.s2.Back),"none"!==R.cullFace&&"front"!==R.cullFace&&"back"!==R.cullFace||(X.cullFace="none"===R.cullFace?et.s2.None:"back"===R.cullFace?et.s2.Back:et.s2.Front),R.transparency&&(X.metallicRoughness.baseColorFactor[3]=(0,Ee.qE)(1-R.transparency,0,1)),(R.useVertexColorAlpha||X.metallicRoughness.baseColorFactor[3]<1)&&(X.alphaMode="blend")}const $=[];if(null!=J){const R=0;!J.wrap||"repeat"!==J.wrap[0]&&"repeat"!==J.wrap[1]||(X.wrapTextures=!0);let G=je.Color;"rgba"===J.channels&&(X.alphaMode="blend",G|=je.AlphaMask);const H=J.images.length-1,W=J.images[H],t=R=>null===R||void 0===R?void 0:R.split("/").pop(),q=Array.isArray(J.encoding)?I3SMaterialUtil_T(J.encoding.map(((R,G)=>({name:t(W.href[G]),encoding:Vt[R]||0})))):[{name:t(W.href),encoding:Vt[J.encoding]||0}];$.push({id:R,usage:G,encodings:q}),X.metallicRoughness.baseColorTextureId=R}return{material:X,textures:$}}($):null,ie=null===ee||void 0===ee?void 0:ee.material,re=null!==(H=null===ee||void 0===ee?void 0:ee.textures)&&void 0!==H?H:[],ne="".concat(R.id),se=!J&&this._options.loadFeatureData,ae=se?await this._loadFeatureData(ne,G):null,oe=se?function I3SNodeLoader_m(R){if(!R)return null;for(const G of R.featureData){const R=G.geometries;if(null!=R)for(const H of R)return{featureIds:[G.id],featureDataPosition:G.position,geometries:[H]}}return null}(ae):function I3SNodeLoader_c(R){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:R}}],featureDataPosition:[0,0,0]}}(ie),le=null==oe?function I3SNodeLoader_h(R){if(!R)return null;const G=new Array;for(const H of R.featureData)null!=H.position&&G.push({featureIds:[H.id],featureDataPosition:H.position,geometries:[]});return G}(ae):null,ce=re.length>0?(0,Rt.Ke)(this.loadTextures(R,re,G)):null;let de=null,he=null;if(X){de=(0,Rt.QA)(await X);const R=function I3SNodeLoader_g(R,G){if(!R||null===G||void 0===G||!G.materialDefinitions)return R;const H=Object.keys(G.materialDefinitions)[0];return!G.materialDefinitions[H].params.vertexRegions&&R.vertexAttributes.region&&delete(R=(0,Tt.o8)(R)).vertexAttributes.region,R}(this._defaultGeometrySchema,$);he=(0,Pt.qs)(q,R)}const ue=ce?(0,Rt.QA)(await ce):null,pe=W?(0,Rt.QA)(await W):{},_e=pe?{attributeData:pe,loadedAttributes:this._requiredAttributes}:null;if(null!=oe)return{geometryData:oe,attributeDataInfo:_e,geometryBuffer:de,geometryDescriptor:he,requiredTextures:re,textureData:ue};if(null!=le)return{pointData:le,attributeDataInfo:_e,geometryBuffer:de,geometryDescriptor:he,requiredTextures:re,textureData:ue};throw new Error}static _addAbsoluteHrefTexture(R,G){const H=R.textureDefinitions;if(null!=H)for(const W of Object.keys(H))for(const R of H[W].images)Array.isArray(R.href)?R.hrefConcat=R.href.map((R=>(0,Et.s2)(R,G))):R.hrefConcat=(0,Et.s2)(R.href,G)}static _fixTextureEncodings(R){const G=R.textureDefinitions;if(null!=G)for(const H in G){const R=G[H];if(Array.isArray(R.encoding))for(let G=0;G<R.encoding.length;G++){const H=R.encoding[G];"data:"===H.substring(0,5)&&(R.encoding[G]=H.substring(5))}else{const G=R.encoding;"data:"===G.substring(0,5)&&(R.encoding=G.substring(5))}}}async _loadShared(R,G){if(null==R.resources.geometry)return{};const H="".concat(this._layerUrl,"/nodes/").concat(R.resources.geometry,"/shared"),W=await this._load(H,"json",G);return I3SNodeLoader_d._fixTextureEncodings(W),I3SNodeLoader_d._addAbsoluteHrefTexture(W,H),W}_loadTexture(R,G,H,W,q,Q){let J=!1;return q===He.DDS_S3TC||q===He.KTX2||q===He.Basis?this._load(R,"binary",Q).then((R=>({id:G,usage:H,data:R,encoding:q,downsampled:J}))):this._load(R,"image",Q).then((R=>{let Q=R;if(W&&R.width*R.height>=4096){const G=Math.ceil(R.width/2),H=Math.ceil(R.height/2),W=document.createElement("canvas");W.width=G,W.height=H,W.getContext("2d").drawImage(R,0,0,G,H),Q=W,J=!0}return{id:G,usage:H,data:Q,encoding:q,downsampled:J}}))}loadTextures(R,G,H){const W=!!this._options.uncompressedTextureDownsamplingEnabled,q=this._options.textureUsageMask;return Promise.all(G.map((G=>{if(0==(G.usage&q))return null;const Q=function I3SMaterialUtil_D(R,G){if(null!=G)return R.find((R=>0!=(R.encoding&G)))}(G.encodings,this._options.textureEncodings);if(null==Q)return this._logger.error("#loadTextures",this._logLayer,"No known encoding for texture found on node ".concat(R.id)),Promise.reject();const J=R.resources.texture||R.id,X="".concat(this._layerUrl,"/nodes/").concat(J,"/textures/").concat(Q.name);return this._loadTexture(X,G.id,G.usage,W,Q.encoding,H)})))}_loadFeatureData(R,G){const H="".concat(this._layerUrl,"/nodes/").concat(R,"/features/0");return this._load(H,"json",G)}_loadGeometry(R,G,H){const W="".concat(this._layerUrl,"/nodes/").concat(R,"/geometries/").concat(G);return this._load(W,"binary",H)}}class I3SStreamDataController_r{constructor(R,G,H){this._requester=R,this._customParameters=G,this._apiKey=H,this._activeRequests=new Set}get busy(){return this._requester.busy}request(R,G,H){const W=new AbortController,q=(0,X.NY)(H,(()=>W.abort())),Q={signal:W.signal,query:{...this._customParameters,token:this._apiKey}},J=this._requester.request(R,G,Q),$={response:J,abortController:W,abortHandle:q};return this._activeRequests.add($),(0,X.Gk)(J,(()=>{var R;$.abortController=null,null!==(R=$.abortHandle)&&void 0!==R&&R.remove(),$.abortHandle=null,this._activeRequests.delete($)})),J}cancelAll(){this._activeRequests.forEach((R=>{var G,H;null!==(G=R.abortController)&&void 0!==G&&G.abort(),R.abortController=null,null===(H=R.abortHandle)||void 0===H||H.remove()})),this._activeRequests.clear()}}var Ut=H(78535),Gt=H(13478),zt=H(41631),Bt=H(88286);function dehydratedFeatureUtils_t(R){return"point"===R.type}class ElevationProvider_r{constructor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.array=R,this.spatialReference=G,this.offset=H}}function ElevationProvider_t(R){return"array"in R}function ElevationProvider_a(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"ground";if(dehydratedFeatureUtils_t(G))return R.getElevation(G.x,G.y,G.z||0,G.spatialReference,H);if(ElevationProvider_t(G)){var W;let q=G.offset;return R.getElevation(G.array[q++],G.array[q++],G.array[q]||0,null!==(W=G.spatialReference)&&void 0!==W?W:R.spatialReference,H)}return R.getElevation(G[0],G[1],G[2]||0,R.spatialReference,H)}var Ht,Wt=H(64286);function elevationAlignmentUtils_u(R,G,H,W,q,Q,J,X,$,K,ee){const te=kt[ee.mode];let ie,re,ne=0;if((0,Ie.projectBuffer)(R,G,H,W,$.spatialReference,q,X))return te.requiresAlignment(ee)?(ne=te.applyElevationAlignmentBuffer(W,q,Q,J,X,$,K,ee),ie=Q,re=J):(ie=W,re=q),(0,Ie.projectBuffer)(ie,$.spatialReference,re,Q,K.spatialReference,J,X)?ne:void 0}function elevationAlignmentUtils_c(R,G,H,W,q){const Q=(dehydratedFeatureUtils_t(R)?R.z:ElevationProvider_t(R)?R.array[R.offset+2]:R[2])||0;switch(H.mode){case"on-the-ground":{var J;const H=null!==(J=ElevationProvider_a(G,R,"ground"))&&void 0!==J?J:0;return q.verticalDistanceToGround=0,q.sampledElevation=H,void(q.z=H)}case"relative-to-ground":{var X;const J=null!==(X=ElevationProvider_a(G,R,"ground"))&&void 0!==X?X:0,$=H.geometryZWithOffset(Q,W);return q.verticalDistanceToGround=$,q.sampledElevation=J,void(q.z=$+J)}case"relative-to-scene":{var $;const J=null!==($=ElevationProvider_a(G,R,"scene"))&&void 0!==$?$:0,X=H.geometryZWithOffset(Q,W);return q.verticalDistanceToGround=X,q.sampledElevation=J,void(q.z=X+J)}case"absolute-height":{var K;const J=H.geometryZWithOffset(Q,W),X=null!==(K=ElevationProvider_a(G,R,"ground"))&&void 0!==K?K:0;return q.verticalDistanceToGround=J-X,q.sampledElevation=X,void(q.z=J)}default:return void(q.z=0)}}function elevationAlignmentUtils_f(R,G,H,W){return elevationAlignmentUtils_c(R,G,H,W,Zt),Zt.z}function elevationAlignmentUtils_m(R,G,H){return null==G||null==H?R.definedChanged:"on-the-ground"===G&&"on-the-ground"===H?R.staysOnTheGround:G===H||"on-the-ground"!==G&&"on-the-ground"!==H?Ht.UPDATE:R.onTheGroundChanged}function elevationAlignmentUtils_d(R){return"relative-to-ground"===R||"relative-to-scene"===R}function elevationAlignmentUtils_g(R){return"absolute-height"!==R}function elevationAlignmentUtils_p(R,G,H,W,q){elevationAlignmentUtils_c(G,H,q,W,Zt),elevationAlignmentUtils_E(R,Zt.verticalDistanceToGround);const Q=Zt.sampledElevation,J=(0,ye.C)(qt,R.transformation);return Qt[0]=G.x,Qt[1]=G.y,Qt[2]=Zt.z,(0,Bt.l)(G.spatialReference,Qt,J,W.spatialReference)?R.transformation=J:console.warn("Could not locate symbol object properly, it might be misplaced"),Q}function elevationAlignmentUtils_E(R,G){for(let H=0;H<R.geometries.length;++H){const W=R.geometries[H].getMutableAttribute(Wt.r.CENTEROFFSETANDDISTANCE);W&&W.data[3]!==G&&(W.data[3]=G,R.geometryVertexAttributeUpdated(R.geometries[H],Wt.r.CENTEROFFSETANDDISTANCE))}}class elevationAlignmentUtils_R{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}!function(R){R[R.NONE=0]="NONE",R[R.UPDATE=1]="UPDATE",R[R.RECREATE=2]="RECREATE"}(Ht||(Ht={}));const kt={"absolute-height":{applyElevationAlignmentBuffer:function elevationAlignmentUtils_y(R,G,H,W,q,Q,J,X){const $=X.calculateOffsetRenderUnits(J),K=X.featureExpressionInfoContext;G*=3,W*=3;for(let ee=0;ee<q;++ee){const q=R[G],Q=R[G+1],J=R[G+2];H[W]=q,H[W+1]=Q,H[W+2]=null==K?J+$:$,G+=3,W+=3}return 0},requiresAlignment:function elevationAlignmentUtils_T(R){const G=R.meterUnitOffset,H=R.featureExpressionInfoContext;return 0!==G||null!=H}},"on-the-ground":{applyElevationAlignmentBuffer:function elevationAlignmentUtils_v(R,G,H,W,q,Q){let J=0;const X=Q.spatialReference;G*=3,W*=3;for(let K=0;K<q;++K){var $;const q=R[G],K=R[G+1],ee=R[G+2],te=null!==($=Q.getElevation(q,K,ee,X,"ground"))&&void 0!==$?$:0;J+=te,H[W]=q,H[W+1]=K,H[W+2]=te,G+=3,W+=3}return J/q},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function elevationAlignmentUtils_h(R,G,H,W,q,Q,J,X){let $=0;const K=X.calculateOffsetRenderUnits(J),ee=X.featureExpressionInfoContext,te=Q.spatialReference;G*=3,W*=3;for(let re=0;re<q;++re){var ie;const q=R[G],J=R[G+1],X=R[G+2],re=null!==(ie=Q.getElevation(q,J,X,te,"ground"))&&void 0!==ie?ie:0;$+=re,H[W]=q,H[W+1]=J,H[W+2]=null==ee?X+re+K:re+K,G+=3,W+=3}return $/q},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function elevationAlignmentUtils_A(R,G,H,W,q,Q,J,X){let $=0;const K=X.calculateOffsetRenderUnits(J),ee=X.featureExpressionInfoContext,te=Q.spatialReference;G*=3,W*=3;for(let re=0;re<q;++re){var ie;const q=R[G],J=R[G+1],X=R[G+2],re=null!==(ie=Q.getElevation(q,J,X,te,"scene"))&&void 0!==ie?ie:0;$+=re,H[W]=q,H[W+1]=J,H[W+2]=null==ee?X+re+K:re+K,G+=3,W+=3}return $/q},requiresAlignment:()=>!0}},qt=(0,ve.vt)(),Zt=new elevationAlignmentUtils_R,Qt=(0,xe.vt)();H(30174);var Yt=H(31670),Jt=H(98664);function hydratedFeatures_o(R){return"declaredClass"in R}function hydratedFeatures_m(R){return"declaredClass"in R}function hydratedFeatures_c(R,G){return R?function hydratedFeatures_l(R){return"declaredClass"in R}(R)?R:new le.A({layer:G,sourceLayer:G,visible:R.visible,symbol:(0,Tt.o8)(R.symbol),attributes:(0,Tt.o8)(R.attributes),geometry:hydratedFeatures_u(R.geometry)}):null}function hydratedFeatures_u(R){return null==R?null:hydratedFeatures_o(R)?R:(0,Yt.rS)(function hydratedFeatures_f(R){const{wkid:G,wkt:H,wkt2:W,latestWkid:q}=R.spatialReference,Q={wkid:G,wkt:H,wkt2:W,latestWkid:q};switch(R.type){case"point":{const{x:G,y:H,z:W,m:q}=R;return{x:G,y:H,z:W,m:q,spatialReference:Q}}case"polygon":{const{rings:G,hasZ:H,hasM:W}=R;return{rings:hydratedFeatures_p(G),hasZ:H,hasM:W,spatialReference:Q}}case"polyline":{const{paths:G,hasZ:H,hasM:W}=R;return{paths:hydratedFeatures_p(G),hasZ:H,hasM:W,spatialReference:Q}}case"extent":{const{xmin:G,xmax:H,ymin:W,ymax:q,zmin:J,zmax:X,mmin:$,mmax:K,hasZ:ee,hasM:te}=R;return{xmin:G,xmax:H,ymin:W,ymax:q,zmin:J,zmax:X,mmin:$,mmax:K,hasZ:ee,hasM:te,spatialReference:Q}}case"multipoint":{const{points:G,hasZ:H,hasM:W}=R;return{points:hydratedFeatures_d(G)?hydratedFeatures_h(G):G,hasZ:H,hasM:W,spatialReference:Q}}default:return}}(R))}function hydratedFeatures_p(R){return function hydratedFeatures_y(R){for(const G of R)if(0!==G.length)return hydratedFeatures_d(G);return!1}(R)?R.map((R=>hydratedFeatures_h(R))):R}function hydratedFeatures_h(R){return R.map((R=>Array.from(R)))}function hydratedFeatures_d(R){return R.length>0&&((0,_e.vZ)(R[0])||(0,_e.aI)(R[0]))}var $t=H(39368);async function featureExpressionInfoUtils_a(R,G,H,W){const q=null===R||void 0===R?void 0:R.expression;if("string"!=typeof q)return null;const Q=featureExpressionInfoUtils_m(q);if(null!=Q)return{cachedResult:Q};const J=await(0,$t.lw)();(0,X.Te)(H);const $=J.arcadeUtils,K=$.createSyntaxTree(q);return $.dependsOnView(K)?(null!=W&&W.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:$.createFunction(K),context:$.createExecContext(null,{sr:G}),modules:J}}}function featureExpressionInfoUtils_s(R,G,H){return R.arcadeUtils.createFeature(G.attributes,G.geometry,H)}function featureExpressionInfoUtils_l(R,G){if(null!=R&&!featureExpressionInfoUtils_p(R)){if(!G||!R.arcade)return void J.A.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils").errorOncePerTick("Arcade support required but not provided");const H=G;H._geometry&&(H._geometry=hydratedFeatures_u(H._geometry)),R.arcade.modules.arcadeUtils.updateExecContext(R.arcade.context,G)}}function featureExpressionInfoUtils_d(R){var G,H;let W=arguments.length>1&&void 0!==arguments[1]&&arguments[1],q=null===R||void 0===R?void 0:R.featureExpressionInfo;const Q=null===(G=q)||void 0===G?void 0:G.expression;return W||"0"===Q||(q=null),null!==(H=q)&&void 0!==H?H:null}const Kt={cachedResult:0};function featureExpressionInfoUtils_p(R){return null!=R.cachedResult}function featureExpressionInfoUtils_m(R){return"0"===R?0:null}class ElevationContext_o{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(R){this._unit=R,this._metersPerElevationInfoUnit=(0,ae.Ao)(R)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(R){this._meterUnitOffset=R,this._renderUnitOffset=0}set offsetElevationInfoUnits(R){this._meterUnitOffset=R*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(R){this._renderUnitOffset+=R}geometryZWithOffset(R,G){const H=this.calculateOffsetRenderUnits(G);return null!=this.featureExpressionInfoContext?H:R+H}calculateOffsetRenderUnits(R){let G=this._meterUnitOffset;const H=this.featureExpressionInfoContext;return null!=H&&(G+=function featureExpressionInfoUtils_i(R){if(null!=R){if(featureExpressionInfoUtils_p(R))return R.cachedResult;const G=R.arcade;let H=null===G||void 0===G?void 0:G.modules.arcadeUtils.executeFunction(G.func,G.context);return"number"!=typeof H&&(R.cachedResult=0,H=0),H}return 0}(H)*this._metersPerElevationInfoUnit),G/R.unitInMeters+this._renderUnitOffset}setFromElevationInfo(R){var G;this.mode=R.mode,this.unit=(0,ae.Tg)(R.unit)?R.unit:"meters",this.offsetElevationInfoUnits=null!==(G=R.offset)&&void 0!==G?G:0}updateFeatureExpressionInfoContext(R,G,H){if(null==R)return void(this._featureExpressionInfoContext=null);const W=null===R||void 0===R?void 0:R.arcade;W&&null!=G&&null!=H?(this._featureExpressionInfoContext=function featureExpressionInfoUtils_o(R){return{cachedResult:R.cachedResult,arcade:R.arcade?{func:R.arcade.func,context:R.arcade.modules.arcadeUtils.createExecContext(null,{sr:R.arcade.context.spatialReference}),modules:R.arcade.modules}:null}}(R),featureExpressionInfoUtils_l(this._featureExpressionInfoContext,featureExpressionInfoUtils_s(W.modules,G,H))):this._featureExpressionInfoContext=R}static fromElevationInfo(R){const G=new ElevationContext_o;return null!=R&&G.setFromElevationInfo(R),G}}const ei=1e5;class I3SViewportQueries_q{constructor(R,G,H,W,q,Q,J,X){let $=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{};this._indexSR=R,this._renderCoordsHelper=G,this._clippingArea=q,this._elevationProvider=Q,this._viewingMode=J,this._options=$,this._frustum=(0,zt.vt)(),this._frustumMbs=(0,Ce.vt)(),this._useFrustumCulling=!1,this._poi=(0,xe.vt)(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new _t.ab,this._tmp1=(0,xe.vt)(),this._tmp2=(0,xe.vt)(),this._tmp3=(0,xe.vt)(),this._tmp0=(0,xe.vt)(),this._screenspaceErrorBias=$.screenspaceErrorBias||1,this._progressiveLoadFactor=$.progressiveLoadFactor||1,this.updateCamera(H,W);const K=this._renderCoordsHelper.spatialReference;this._renderSR=K,this._renderSRSphericalPCPF=(0,Gt.lO)(K),this._isGlobalMode=K===this._renderSRSphericalPCPF,this.updateElevationInfo(X),this._tmpPoint=(0,We.T)(0,0,0,R),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(K.isWebMercator||(0,Te.r1)(K)),this._indexSREllipsoidRadius=(0,Ut.tO)(this._indexSR).radius,this._indexSRSphericalPCPF=(0,Gt.lO)(R),this._projectorIndexSRToIndexSRSphericalPCPF=(0,Ae.jd)(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(R){null!=R?(this._elevationContext=ElevationContext_o.fromElevationInfo(R),this._elevationContext.updateFeatureExpressionInfoContext(function featureExpressionInfoUtils_u(R){const G=null===R||void 0===R?void 0:R.expression;if("string"==typeof G){const R=featureExpressionInfoUtils_m(G);if(null!=R)return{cachedResult:R}}return null}(featureExpressionInfoUtils_d(R,!1)))):this._elevationContext=null}updateCamera(R,G){if(this._useFrustumCulling=G,G){(0,zt.ui)(R.viewMatrix,R.projectionMatrix,this._frustum,ii);{const G=R.eye,H=ti;(0,be.n)(H,R.viewForward);const W=ri;(0,be.z)(W,ii[4],G);const q=.5*(0,be.k)(W,W)/(0,be.k)(H,W),Q=this._frustumMbs;(0,be.r)(Q,G,H,q);const J=1+q;Q[3]=J}}this._screenSizeFactor=1/(R.perScreenPixelRatio/2),this._camPos=R.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(R){this._poi=R}updateScreenSpaceErrorBias(R){const G=this._screenspaceErrorBias;return this._screenspaceErrorBias=R,G}updateClippingArea(R){this._clippingArea=R}expandElevationRange(R,G,H){var W,q;if(null==this._elevationContext)return;const Q=R.serviceMbsInIndexSR;if(!Q)return;const J="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){const R=this._elevationProvider.getSphereElevationBounds(Q,this._indexSR,J);return void(R&&H.expandElevationRange(R))}const X=Q[0],$=Q[1],K=Q[2],ee=this._elevationProvider.getElevation(X,$,K,this._indexSR,J);ee&&H.expandElevationRangeValues(ee,ee);const te=G?null:null===(W=(q=this._elevationProvider).getRootElevationBounds)||void 0===W?void 0:W.call(q);te&&H.expandElevationRange(te)}getServiceMbsInRenderSR(R){const G=R.serviceMbsInRenderSR;if((0,ut.hB)(G))return G;R.serviceMbsInIndexSR&&(0,Se.c)(G,R.serviceMbsInIndexSR);const H=R.elevationRangeMin;if(this._elevationContext&&Number.isFinite(H)){let W=0,q=0;const Q=R.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":W=this._elevationContext.geometryZWithOffset(G[2],this._renderCoordsHelper)+H-G[2],q=Q-H;break;case"on-the-ground":W=H-G[2],q=Q-H}G[2]+=W+.5*q,G[3]+=.5*q}else this._elevationContext&&G[3]<ei&&(this._tmpPoint.x=G[0],this._tmpPoint.y=G[1],this._tmpPoint.z=G[2],G[2]=elevationAlignmentUtils_f(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return projectBoundingSphere_a(G,this._indexSR,G,this._renderSR),G}getAndUpdateVisibilityObbInRenderSR(R){{const G=R.visibilityObbInRenderSR;if(G)return G}const G=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:H,serviceObbInIndexSR:W}=R;if(null==W||!H||!W.isValid||this._isECEFOBBInLocalMode&&(W.halfSizeX>G||W.halfSizeY>G||W.halfSizeZ>G))return null;{let G=R.serviceObbInRenderSR;if(null==G)G=new _t.ab,R.serviceObbInRenderSR=G;else if(G.isValid)return G;const q=H[3];let Q=0,J=0;const X=W.centerZ,$=this._renderCoordsHelper,K=this._elevationContext;if(K&&R.elevationRangeValid){const G=R.elevationRangeMin,H=R.elevationRangeMax;switch(K.mode){case"relative-to-ground":Q=K.geometryZWithOffset(X,$)+G-X,J=H-G;break;case"on-the-ground":Q=G-X,J=H-G}}else if(K&&q<ei){const R=this._tmpPoint;R.x=W.centerX,R.y=W.centerY,R.z=X,Q=elevationAlignmentUtils_f(R,this._elevationProvider,K,$)-X}const ee=J>0,te=ee?this._tmpObb:G;return W.transform(te,this._indexSR,this._renderSR,Q,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),ee&&(0,_t.gm)(te,0,J,this._viewingMode,G),G}}getNodeObbInRenderSRIndependentOfElevationOffset(R){{var G,H;const W=null!==(G=null!==(H=R.visibilityObbInRenderSR)&&void 0!==H?H:R.serviceObbInRenderSR)&&void 0!==G?G:null;if(null!==W&&void 0!==W&&W.isValid)return W}const W=R.serviceObbInIndexSR;return W?(W.transform(si,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),si):null}ensureElevationAgnosticBoundingVolume(R,G){-1===R.elevationAgnosticBoundingVolume[3]&&(G===qe.RT.Global?this._updateElevationAgnosticBoundingVolumeGlobal(R):this._updateElevationAgnosticBoundingVolumeLocal(R))}_updateElevationAgnosticBoundingVolumeGlobal(R){const G=this.getNodeObbInRenderSRIndependentOfElevationOffset(R),H=R.elevationAgnosticBoundingVolume,W=ai;let q=-1;if(G){G.getCenter(W),(0,be.n)(W,W),G.getCorners(oi);for(const R of oi){(0,be.n)(R,R);const G=(0,be.k)(R,W);if(G<=0)return void(H[3]=-1);const Q=Math.sqrt(1-G*G);q=Math.max(q,Q)}}else{const G=R.serviceMbsInRenderSR;if(!(0,ut.hB)(G))return void(H[3]=-1);{const R=(0,be.c)(ai,(0,Ge.g)(G)),H=G[3],W=(0,be.D)(R);q=0===H?0:W<H?-1:H/W,(0,be.n)(R,R)}}(0,Se.b)(H,W);H[3]=q+.001}_updateElevationAgnosticBoundingVolumeLocal(R){const G=R.elevationAgnosticBoundingVolume,H=this.getNodeObbInRenderSRIndependentOfElevationOffset(R);if(H){const R=H.getCenter(ai);R[2]=0,(0,Se.b)(G,R);let W=0;const q=li;H.getCorners(oi);for(const G of oi){G[2]=0;const R=(0,be.w)(q,G);W=Math.max(W,R)}G[3]=Math.sqrt(W)}else{const H=R.serviceMbsInRenderSR;if((0,ut.hB)(H)){const R=(0,be.c)(ai,(0,Ge.g)(H));R[2]=0,(0,Se.b)(G,R),G[3]=H[3]}}}isNodeVisible(R){const G=this.getServiceMbsInRenderSR(R);if(!this._isMBSinClippingArea(G))return!1;if(!this._useFrustumCulling)return!0;const H=this.getAndUpdateVisibilityObbInRenderSR(R);return H?H.isVisible(this._frustum):(0,zt.m7)(this._frustum,(0,Ge.w)(G))}isElevationAgnosticBoundingVolumeVisible(R,G){return!this._useFrustumCulling||-1===G[3]||(R===qe.RT.Global?this._isConeVisibleInFrustum(G):this._isCylinderVisibleInFrustum(G))}_isConeVisibleInFrustum(R){const G=this._frustumMbs,H=G,W=(0,be.D)(H),q=G[3],Q=R,J=(0,be.k)(Q,H),X=R[3];if(X>.9)return!0;if(W<=q)return!0;{const R=(0,be.h)(ni,Q,J);if((0,be.o)(R,H)<q)return!0}const $=J/W;if(J<=0)return-$<q;const K=Math.sqrt(1-$*$);if(K<X)return!0;const ee=q/W;return K*Math.sqrt(1-ee*ee)-ee*$<X}_isCylinderVisibleInFrustum(R){const G=this._frustumMbs,H=G,W=G[3],q=(0,be.c)(ni,H);q[2]=0;const Q=R[3];return(0,be.o)(q,R)<=Q+W}isGeometryVisible(R){var G;if(!this._useFrustumCulling)return!0;const H=R.geometryObbInRenderSR;return null!==(G=null===H||void 0===H?void 0:H.isVisible(this._frustum))&&void 0!==G?G:this.isNodeVisible(R)}_isMBSinClippingArea(R){return null==this._clippingArea||(0,ut.aM)(this._clippingArea,R)!==ut.JA.OUTSIDE}_screenSpaceDiameterMbs(R,G){const H=this.getServiceMbsInRenderSR(R),W=Math.sqrt((0,be.a)((0,Ge.g)(H),this._camPos)),q=W-H[3];return this._updateMinMaxDistance(W),q<0?.5*Number.MAX_VALUE:G/q*this._screenSizeFactor}calcCameraDistance(R){return this.calcCameraDistanceToCenter(R)-this.getServiceMbsInRenderSR(R)[3]}calcCameraDistanceToCenter(R){const G=this.getServiceMbsInRenderSR(R),H=(0,be.q)((0,Ge.g)(G),this._camPos);return this._updateMinMaxDistance(H),H}calcAngleDependentLoD(R){const G=this.getServiceMbsInRenderSR(R),H=G[3],W=(Math.abs(G[0]*(G[0]-this._camPos[0])+G[1]*(G[1]-this._camPos[1])+G[2]*(G[2]-this._camPos[2]))/(0,be.l)((0,Ge.g)(G))+H)/(0,be.q)((0,Ge.g)(G),this._camPos);return Math.min(1,W)}hasLOD(R){return R.lodMetric!==ht.cJ.None}_getDistancePlanarMode(R,G){const H=R[0]-G[0],W=R[1]-G[1],q=R[2]-G[2],Q=H*H+W*W,J=G[3];if(Q<=J*J)return Math.abs(q);const X=Math.sqrt(Q)-J;return Math.sqrt(q*q+X*X)}_getDistanceGlobeMode(R,G){const H=(0,be.l)((0,Ge.g)(G)),W=(0,be.l)(R)-H;(0,be.h)(this._tmp0,R,(0,be.k)(R,(0,Ge.g)(G))/(0,be.p)(R));const q=(0,be.a)((0,Ge.g)(G),this._tmp0),Q=G[3];if(q<=Q*Q)return Math.abs(W);{const q=(0,be.h)(this._tmp0,(0,Ge.g)(G),1/H),J=H,X=Q*Q/2/J,$=(0,be.h)(this._tmp1,q,J-X),K=R,ee=(0,be.f)(this._tmp2,K,$),te=(0,be.f)(this._tmp2,ee,(0,be.h)(this._tmp3,q,(0,be.k)(q,ee))),ie=(0,be.g)(this._tmp2,$,(0,be.h)(this._tmp2,te,Q/(0,be.l)(te)));let re=(0,be.q)(K,ie);if(W>=2e5){const R=(0,be.f)(this._tmp1,K,ie);let G=(0,be.k)(R,q)/(0,be.l)(R);G<.08&&(G=1e-4),re/=G}return re}}_getDistance(R,G){return this._isGlobalMode?this._getDistanceGlobeMode(R,G):this._getDistancePlanarMode(R,G)}_updateMinMaxDistance(R){R>0?(this.minDistance=Math.min(this.minDistance,R),this.maxDistance=Math.max(this.maxDistance,R)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-R))}getLodLevel(R){if(R.lodMetric===ht.cJ.None)return 0;if(0===R.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const G=this._progressiveLoadFactor*this._screenspaceErrorBias,H=this._screenspaceErrorBias;return this.evaluateLODmetric(R,G)?this.evaluateLODmetric(R,H)?2:1:0}return this.evaluateLODmetric(R,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(R,G){switch(R.lodMetric){case ht.cJ.ScreenSpaceRelative:{const H=this.getServiceMbsInRenderSR(R),W=this._getDistance(this._camPos,H),q=2*W/this._screenSizeFactor,Q=W+H[3];return this._updateMinMaxDistance(Q),R.maxError*G<=q}case ht.cJ.MaxScreenThreshold:{let H=this._screenSpaceDiameterMbs(R,R.serviceMbsInIndexSR[3]*G);return this._options.angleDependentLoD&&(H*=this.calcAngleDependentLoD(R)),H<R.maxError}case ht.cJ.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(R,R.maxError)*G<10;case ht.cJ.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(R)>R.maxError*G}return!1}distToPOI(R){const G=this.getServiceMbsInRenderSR(R);return(0,be.q)((0,Ge.g)(G),this._poi)-G[3]}distCameraToPOI(){return(0,be.q)(this._camPos,this._poi)}}const ti=(0,xe.vt)(),ii=(0,zt.Qy)(),ri=(0,xe.vt)(),ni=(0,xe.vt)(),si=new _t.ab,ai=(0,xe.vt)(),oi=[(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)()],li=(0,xe.vt)();function extentUtils_u(R,G,H){if(null==R||null==H)return!1;let W=!0;return ci[0]=null!=R.xmin?R.xmin:0,ci[1]=null!=R.ymin?R.ymin:0,ci[2]=null!=R.zmin?R.zmin:0,W=W&&(0,Ie.projectBuffer)(ci,R.spatialReference,0,ci,H,0,1),G[0]=ci[0],G[1]=ci[1],ci[0]=null!=R.xmax?R.xmax:0,ci[1]=null!=R.ymax?R.ymax:0,ci[2]=null!=R.zmax?R.zmax:0,W=W&&(0,Ie.projectBuffer)(ci,R.spatialReference,0,ci,H,0,1),G[2]=ci[0],G[3]=ci[1],null==R.xmin&&(G[0]=-1/0),null==R.ymin&&(G[1]=-1/0),null==R.xmax&&(G[2]=1/0),null==R.ymax&&(G[3]=1/0),W}const ci=(0,xe.vt)();var di;!function(R){R[R.ELEVATION=0]="ELEVATION",R[R.BASEMAP=1]="BASEMAP",R[R.I3S_INDEX=2]="I3S_INDEX",R[R.I3S_DATA=3]="I3S_DATA",R[R.SYMBOLOGY=4]="SYMBOLOGY"}(di||(di={}));(()=>{const R=new Array;R[di.ELEVATION]=10,R[di.BASEMAP]=10,R[di.I3S_INDEX]=10,R[di.I3S_DATA]=10,R[di.SYMBOLOGY]=5})();const hi=.1;let ui=class extends Q.A{constructor(R){super(R),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new Ye.F,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles((0,K.mg)({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(R){null==R||R<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<R&&this._updateQuality(1),this._maxMemory=R)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(R){null!=R&&(this._additionalCacheMemory=R)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(R,G){return new Ye.Mn(R,this._cacheStorage,G)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let R=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(R)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>hi&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,R=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const G=.05;R=this._updateQuality(this._quality+G)}else this._quality<1&&(this._canFastRecover=!0);this._updating=R}_updateQuality(R){return(R=Math.min(Math.max(R,hi),1))!==this._quality&&(this._quality=R,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((R=>!!R.updating))}_updateMemory(){var R,G,H,W;if(!this.view)return;null===(R=this.view._stage)||void 0===R||null===(R=R.renderer)||void 0===R||R.tick();const q=null===(G=this.view._stage)||void 0===G||null===(G=G.renderer)||void 0===G?void 0:G.usedMemory;let Q=(null!==(H=null===(W=this.view.basemapTerrain)||void 0===W?void 0:W.usedMemory)&&void 0!==H?H:0)+(q?q.fbos+q.edges+q.plugins:0),X=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((R=>{if(function MemoryManagedView_e(R){return"usedMemory"in R&&"unloadedMemory"in R&&"ignoresMemoryFactor"in R}(R)){const G=R.ignoresMemoryFactor?this._quality:1;Q+=R.usedMemory*G,X+=R.unloadedMemory*G}}));const $=null==this._warnMemoryUsage||Math.round(10*Q)!==Math.round(10*this._warnMemoryUsage),K=1048576*this.maxMemory;if(Q>K&&$){this._warnMemoryUsage=Q;const e=R=>(R/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",R=Math.round(100*this._quality);J.A.getLogger(this).warn("Memory Limit exceeded! Limit: ".concat(e(K)," Current: ").concat(e(Q)," Projected: ").concat(e(Q+X)," Quality: ").concat(R,"%"))}this._usedMemory=Q/K,this._memoryPredicted=(Q+X)/K;const ee=K-Q;this._cacheStorage.maxSize=Math.max(0,ee+1048576*this.additionalCacheMemory)}get test(){const R=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const G=R._numQualityChanges;return R._numQualityChanges=0,G},disableMemCache:()=>R.disableMemCache()}}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],ui.prototype,"view",void 0),(0,W._)([(0,ee.MZ)()],ui.prototype,"maxMemory",null),(0,W._)([(0,ee.MZ)()],ui.prototype,"additionalCacheMemory",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],ui.prototype,"memoryFactor",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],ui.prototype,"updating",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],ui.prototype,"usedMemory",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],ui.prototype,"usedCacheMemory",null),(0,W._)([(0,ee.MZ)()],ui.prototype,"_quality",void 0),(0,W._)([(0,ee.MZ)()],ui.prototype,"_usedMemory",void 0),(0,W._)([(0,ee.MZ)()],ui.prototype,"_updating",void 0),(0,W._)([(0,ee.MZ)()],ui.prototype,"_stableQuality",void 0),(0,W._)([(0,ee.MZ)()],ui.prototype,"_maxMemory",void 0),(0,W._)([(0,ee.MZ)()],ui.prototype,"_additionalCacheMemory",void 0),ui=(0,W._)([(0,ie.$)("esri.views.3d.support.MemoryController")],ui);var pi=H(18715);const _i=1e-4;let mi=class extends((0,ze.g)(Q.A)){get isMeshPyramid(){var R;return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===(null===(R=this.layer.store)||void 0===R?void 0:R.lodType)}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const R=this.layerView.view.resourceController.createStreamDataRequester(di.I3S_INDEX);return new I3SStreamDataController_r(R,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const R=this.layerView.view.resourceController.createStreamDataRequester(di.I3S_DATA);return new I3SStreamDataController_r(R,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return(0,ut.Dd)(this.layer)}get crsIndex(){return(0,ut.Rm)(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const R=this._index.rootNode;if(R)return this._updateViewData(),this._index.isNodeVisible(R.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(R){super(R),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this.worker=null,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new pe.A({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new pe.A,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._idleQueue=new ke.T,this._elevationUpdateNodes=new pe.A({deallocator:null}),this._errorCount=0}initialize(){const{layerView:R,layer:G}=this;this._disableMemCache=!R.loadCachedGPUData||!R.addCachedGPUData,this._lodHandling=new I3SLodHandling_o(R),this._defaultGeometrySchema=G.store.defaultGeometrySchema,this.disableIDBCache=(0,te.A)("disable-feature:idb-cache"),"fields"in G&&(this._fields=G.fields,this._attributeStorageInfo=G.attributeStorageInfo),this.addResolvingPromise(Promise.all([G.indexInfo,G.when(),R.when()]).then((H=>{let[W]=H;if(this.destroyed||!R||R.destroyed||!W)return;const{view:q,clientGeometry:Q}=R,{resourceController:X}=q;if(this._setClippingArea(q.clippingArea),this.addHandles([(0,$.wB)((()=>{var R;return null===q||void 0===q||null===(R=q.pointsOfInterest)||void 0===R||null===(R=R.focus)||void 0===R?void 0:R.renderLocation}),(R=>this._pointOfInterestChanged(R)),$.Vh),(0,$.wB)((()=>q.quality),(()=>this._setCameraDirty()),$.OH),(0,$.wB)((()=>R.contentVisible),(R=>{const G=R?()=>this._updateIdleState(!0):()=>this._updateViewData(),H=R?()=>this._updateIdleState(!1):()=>{};R&&null!=this._index&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(R||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=G,this._idleStateCallbacks.idleEnd=H):this._idleStateCallbacks=X.scheduler.registerIdleStateCallbacks(G,H)}),$.Vh),I3SFrameTask_h(R.view.resourceController.scheduler,this),(0,$.wB)((()=>R.uncompressedTextureDownsamplingEnabled),(()=>this.restartNodeLoading())),(0,$.wB)((()=>[this.featureTarget,this.fixedFeatureTarget]),(()=>{this._setCameraDirty(),this._stableFeatureLOD=!1})),(0,$.wB)((()=>{var R;return null===(R=q.state)||void 0===R?void 0:R.contentCamera}),(()=>this._setCameraDirty())),(0,$.wB)((()=>G.elevationInfo),(R=>this._elevationInfoChanged(R))),(0,$.wB)((()=>G.effectiveScaleRange),(()=>this._scaleBoundsChanged())),(0,$.wB)((()=>R.lodFactor),(()=>this._setCameraDirty())),(0,$.wB)((()=>R.availableFields),(()=>this._requiredFieldsChange())),(0,$.wB)((()=>R.holeFilling),(R=>null!=this._index&&(this._index.holeFilling=R)))]),this._updateScaleHandles(),this._viewportQueries=new I3SViewportQueries_q(this.crsIndex,q.renderCoordsHelper,q.state.contentCamera,!q.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?q.basemapTerrain:q.elevationProvider,(0,qe.yX)(q.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._clientNodeLoader=new I3SClientNodeLoader_h(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:q.renderCoordsHelper.spatialReference,localMode:"local"===q.viewingMode},q.resourceController.memoryController,this.worker),this._index=new I3SIndex_I((0,qe.yX)(q.viewingMode),G,W,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,J.A.getLogger(this),R.holeFilling,(G=>R.isNodeLoaded(G)),(G=>R.isNodeReloading(G)),(R=>this._shouldLoadNode(R)),(R=>this._enableFromGPUCache(R,ht.UY.Leaf)),(R=>this._needsUpdate(R)),(()=>!this.indexStreamController.busy),(G=>{var H,W;return null!==(H=null===(W=R.computeVisibilityObb)||void 0===W?void 0:W.call(R,G))&&void 0!==H?H:null}),null!==R&&void 0!==R&&R.computeNodeFiltering?G=>R.computeNodeFiltering(G):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D),this._index.imModificationsChanged(!!R.hasModifications),this._index.layerFilterChanged(!!R.hasGeometryFilter),null!=Q){for(const R of Q)this._addMesh(R.mesh,R.oid);this.addHandles(Q.on("change",(R=>{for(const G of R.removed)this._removeMesh(G.oid);for(const G of R.added)this._addMesh(G.mesh,G.oid)})))}this._startNodeLoading()}))),this._tmpPoint=(0,We.T)(0,0,0,this.crsIndex)}updateNodeModificationStatus(R){const G=this._index,H=this.layerView;null!=G&&(null===H||void 0===H?void 0:H.updateNodeModificationStatus)&&(this._modificationsNodeFilteringArray.clear(),R.forAll((R=>{const H=G.getNode(R);null!=H&&this._modificationsNodeFilteringArray.push(H)})),H.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,gi.prune(),null!=fi&&(fi.hide(),fi=null)}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const R=this._attributeStorageInfo,G=this._fields,H=this.layer.objectIdField;return this.layerView.availableFields.map((H=>{const W=I3SOnDemandController_K(R,H),q=I3SOnDemandController_K(G,H);return W>=0&&q>=0?{index:W,name:G[q].name,field:G[q],attributeStorageInfo:R[W]}:null})).filter((R=>null!=R&&R.name!==H))}_requiredFieldsChange(){const R=this._getRequiredAttributes();I3SOnDemandController_$(this._requiredAttributes,R)||(this._requiredAttributes=R,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(R){const G=(0,Fe.vt)();extentUtils_u(R,G,this.layerView.view.renderSpatialReference)?this._clippingArea=G:this._clippingArea=null}_pointOfInterestChanged(R){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(R),null!=this._index&&(this._index.progressiveLoadPenalty=yi.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(R){this._setClippingArea(R),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_addMesh(R,G){if(null==this._index)return;const H=this._clientNodeLoader.createMeshNodeInfo(R,G),W=this._index.addClientNodeToIndex(H.id,H.mbs);this._clientNodeLoader.addMeshNode(W,H),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}_removeMesh(R){const G=this._clientNodeLoader.getMeshNodeIndex(R);if(null!=G){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");{const e=(R,G)=>{var H,W,q,Q;this.layerView.removeNode(G),this._loadedNodeScales.delete(G),this._clientNodeLoader.removeNode(R),this.layerView.deleteCachedNodeData&&null!=R&&this.layerView.deleteCachedNodeData(R),null===(H=(W=this.layerView).deleteCachedGPUData)||void 0===H||H.call(W,null===(q=(Q=this.layerView).loadCachedGPUData)||void 0===q?void 0:q.call(Q,G))},i=(R,G,H)=>{this._clientNodeLoader.updateNodeIndex(R,G,H),this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(G,H)};this._index.removeClientNodeFromIndex(G,e,i),this.notifyChange("rootNodeVisible")}}}updateElevationChanged(R,G){const H=this._index;if(null==(null===H||void 0===H?void 0:H.rootNode)||null==G)return null;this.crsIndex.equals(G)||(projectBoundingRect_i(R,G,vi,this.crsIndex),R=vi);const W=this._elevationUpdateNodes;return W.clear(),(0,ut.II)(R,H.rootNode,H,(R=>W.push(R.index))),W.length&&(W.forAll((R=>H.updateElevationChanged(R))),this._setCameraDirty()),W}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(R){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(R):null}_elevationInfoChanged(R){null!=this._index&&(this._index.updateElevationInfo(R,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}_updateScaleHandles(){const R="scale-bounds";this.removeHandles(R),this._areScaleBoundsActive&&this.addHandles(this.layerView.view.basemapTerrain.on("scale-change",(R=>this._scaleUpdateHandler(R))),R)}_scaleBoundsChanged(){this._areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(R){this._updateScaleInBoundingRect(R.extent,R.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(R,G){const H=this._index;null!=H&&null!=H.rootNode&&projectBoundingRect_i(R,G,vi,this.crsIndex)&&this._loadedNodeScales.forEach(((R,G)=>{const W=H.getNode(G);null!=W&&(0,Fe.m7)(vi,W.serviceMbsInIndexSR)&&this._loadedNodeScales.set(G,this._computeScale(W))}))}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(R,G){return this._idleQueue.push(R,G)}reschedule(R,G){return this._idleQueue.unshift(R,G)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get _areScaleBoundsActive(){const{minScale:R,maxScale:G}=(0,pi.Cf)(this.layer);return this.scaleVisibilityEnabled&&(R>0||G>0)}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}async _loadNodeData(R,G){return R.index<0?this._clientNodeLoader.loadNodeData(R.id,G):this._nodeLoader.loadNodeData(R,G)}async _loadAttributes(R,G,H){return(R.index<0?this._clientNodeLoader:this._nodeLoader).loadAttributes(R,G,H)}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(R){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?this._disableMemCache=R:this._disableMemCache=!0}runTask(R,G){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(R,G),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}_processWithErrorLogging(R,G){try{this._process(R,G)}catch(H){this._errorCount<50?J.A.getLogger(this).error("Error during processing: ".concat(H," at ").concat(H.stack)):50===this._errorCount&&J.A.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(R,G){this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(R)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(R.enabled=!1),R.run((()=>this._processIndex(R))),this._updateFeatureLOD(),R.run((()=>this._processCache(R))),this._isIntegratedMesh&&(R.enabled=!0),R.run((()=>this._processNodes(R,G))),this._idleQueue.runTask(R),R.run((()=>this._prefetchIndex())),G.numIndexLoading+=this._index.indexLoading,G.numNodesLoading+=this._downloadingCount,R.run((()=>this._lodHandling.lodGlobalHandling(R))),this._evaluateUpdating())}_processIndex(R){if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),R,(R=>this.updateNodeModificationStatus(R))),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const G=this._index.featureEstimate.leavesReached;this._index.isLoading||G===this._get("leavesReached")||this._set("leavesReached",G)}return this._index.load()}_prefetchIndex(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||null==this._index||null==this._viewportQueries)return;const R=!this._index.isLoading,G=this.featureTarget*this._baseLOD,H=this._index.featureEstimate;if(H.estimate=H.estimate||G/2,this._index.indexMissing>500){if(this._featureLOD<=_i)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(R&&H.estimate<G){if(H.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const R=Math.min(10,Math.max(G/H.estimate,1.001));this._featureLOD*=R;const W=this._lod,q=this._index.checkFeatureTarget(G,W);q!==W&&(this._featureLOD=q/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(H.estimate>1.2*G||R&&H.estimate>G))return;if(this._featureLOD<=_i)return;this._featureLOD/=1+.25*(H.estimate/G-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(_i,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(R){const G=this._index;if(null==G)return!1;for(;this._newLoadingNodes.length>0&&!R.done;){const H=this._newLoadingNodes.pop();for(let W=G.getParent(H);null!=W&&!this.layerView.isNodeLoaded(W.index)&&this._isNodeInScaleBounds(W);W=G.getParent(W.index))if(this._enableFromGPUCache(W,ht.UY.Hole)){R.madeProgress();break}}return R.hasProgressed}_processNodes(R,G){if(null==this._index)return!1;let H=(this._isIdle?100:2)-this._loadingNodes.size;const W=this._index.updates;for(W.cancel.forEach(this._cancelNode,this),W.cancel=[];W.remove.length>0&&!R.done;)this.layerView.removeNode(W.remove.pop()),R.madeProgress();for(;W.update.length>0&&!R.done;){const G=this._index.getNode(W.update.pop());null!=G&&(this._updateLoadedNode(G),R.madeProgress())}for(;W.add.length>0&&!R.done&&H>0;){--H;const q=this._index.getNode(W.add.back());if(null==q||q.cacheState!==ht.iF.Cached&&!this._hasNodeLoadToken(G))break;W.add.pop(),this._loadNode(q),R.madeProgress()}return R.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach((R=>R.abort())),this._loadingNodes.clear(),this._updatingNodes.forEach((R=>R.abort())),this._updatingNodes.clear()}_cancelNode(R){const G=this._loadingNodes.get(R);G&&(G.abort(),this._loadingNodes.delete(R))}_hasNodeLoadToken(R){return!(!this._isIdle&&R.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<30&&!this.dataStreamController.busy}_evaluateUpdating(){let R=!1,G=0;if(this.layerView){if(this.layerView.contentVisible){const H=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;R=!!(H>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===H&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(H,this._progressMaxNumNodes),G=1-H/this._progressMaxNumNodes}else R=this._cameraDirty,G=R?0:1;this.updating=R,this.updatingProgress=G}}_updateViewData(){if(!this._cameraDirty||null==this._index||null==this._viewportQueries)return;const R=this.layerView.view,{contentCamera:G,fixedContentCamera:H}=R.state;this.screenSizeFactor=1/(G.perScreenPixelRatio/2),this._viewportQueries.updateCamera(G,!H||this.isGraphics3D),this._viewportQueries.setPointOfInterest(R.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=yi.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const R=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(R>0?R:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-hi)/.4}isGeometryVisible(R){var G;return!(null===(G=this._index)||void 0===G||!G.isGeometryVisible(R.index))}updateVisibility(R){var G;null===(G=this._index)||void 0===G||G.invalidateNodeVisibilityCache(R)}invalidateGeometryVisibility(R){var G;null===(G=this._index)||void 0===G||G.invalidateGeometryVisibility(R)}invalidateVisibilityObbs(){var R;null===(R=this._index)||void 0===R||R.invalidateVisibilityObbs()}modificationsChanged(){var R;null!==(R=this._index)&&void 0!==R&&R.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(R){return!(!this._lodHandling.shouldLoadNode(R)||this._shouldDropNode(R))&&!(null==this._index||!this._index.isGeometryVisible(R.index))&&this._isNodeInScaleBounds(R)}_shouldDropNode(R){if(null==this._viewportQueries)return!1;const G=this._lodDropFactor;return!(G>=1||!this._lodHandling.hasNoVisibleChildren(R))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(R))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*G}_startNodeLoading(){this._restartNodeLoading=!1;const R=this._index;if(this._updatesDisabled||null==R||null==this._viewportQueries)return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const G={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new I3SNodeLoader_d(this.layer,this.dataStreamController,J.A.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,G),R.requestUpdate(),this._lodHandling.startNodeLoading((R=>this._isNodeInScaleBounds(R)),((R,G)=>this._removeNodes(R,G,bi.fadeout)),R,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(R){const G=this._index;if(null==G||null==this._viewportQueries)return!1;gi.clear(),this.layerView.getLoadedNodeIndices(gi);const H=0===this._viewportQueries.maxDistance,W=H?()=>!1:R=>this._shouldDropNode(R);return gi.filterInPlace((R=>{const H=G.getNode(R);return null==H||!G.isGeometryVisible(R)||W(H)||!this._isNodeInScaleBounds(H)})),gi.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(gi,R,bi.pop),!(H&&this._lodDropFactor<1)&&(0===gi.length||(gi.clear(),!1))}markNodeToRemove(R){gi.push(R)}removeMarkedNodes(){this._removeNodes(gi,ot.Bb,bi.pop)}_removeNodes(R,G,H){const W=R.length;if(0!==W&&!G.done){for(null!=this._index&&this._index.requestUpdate();R.length>0&&!G.done;){const W=R.pop(),q=this._index;H===bi.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=q&&q.isGeometryVisible(W)?this.layerView.fadeNode(W,St.FadeOut,!0):this.layerView.removeNode(W),G.madeProgress()}if(this._loadedNodeScales.size>0)for(let G=R.length;G<W;G++){const H=R.data[G];this._loadedNodeScales.delete(H)}}}_needsUpdate(R){if(R.resources.isEmpty||this._updatingNodes.has(R.index))return!1;const G=this.layerView.getLoadedAttributes(R.index);return null!=G&&G!==this._requiredAttributes}async _updateLoadedNode(R){const G=new AbortController;this._updatingNodes.set(R.index,G),this._evaluateUpdating();try{const H=I3SOnDemandController_$(this.layerView.getLoadedAttributes(R.index),this._requiredAttributes);let W=null;W=H?this.layerView.getAttributeData(R.index):await this._loadAttributes(R,this._requiredAttributes,G.signal),await this.schedule((()=>this.layerView.updateAttributes(R.index,{loadedAttributes:this._requiredAttributes,attributeData:W},G.signal)),G.signal)}catch(H){if(!(0,X.zf)(H))return this.layerView.updateAttributes(R.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},G.signal)}this._updatingNodes.delete(R.index),this._evaluateUpdating()}_loadNode(R){if(this._loadingNodes.has(R.index))return void J.A.getLogger(this).error("already loading node "+R.index);const G=new AbortController;this._loadingNodes.set(R.index,G),this._evaluateUpdating(),this._loadAndAddNode(R,G.signal).then((H=>{H&&null!=this._index&&this._loadingNodes.get(R.index)===G&&(this._loadingNodes.delete(R.index),this._index.requestUpdate())})).catch((R=>{if(!(0,X.zf)(R))throw R})).finally((()=>{this._loadingNodes.get(R.index)===G&&this._loadingNodes.delete(R.index),this._evaluateUpdating()}))}_loadAndAddNode(R,G){return R.cacheState===ht.iF.Uncached?this._loadUncached(R,G).then((()=>!1)):this._loadCached(R,G).then((G=>!G&&(R.cacheState=ht.iF.Uncached,!0))).catch((G=>!(0,X.zf)(G)&&(R.cacheState=ht.iF.Uncached,!0)))}_enableFromGPUCache(R,G){if(this._disableMemCache||null==this._index)return!1;if(G===ht.UY.Hole&&!this._index.useNodeAsHole(R.index))return!0;const H=this._loadCachedGPUData(R);return!!H&&(this.layerView.addCachedGPUData(R,H,G),this._nodeAdded(),!0)}_loadCachedGPUData(R){const G=this.layerView.loadCachedGPUData(R.index);return null!=(null===G||void 0===G?void 0:G.attributeInfo)&&I3SOnDemandController_$(G.attributeInfo.loadedAttributes,this._requiredAttributes)?G:(this.layerView.deleteCachedGPUData(G),null)}_nodeAdded(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(R,G){const H=this._index;null!=H&&H.updateChildrenLoaded(R,G?1:-1)}async _loadCached(R,G){if(this._enableFromGPUCache(R,ht.UY.Leaf))return!0;const H=this.layerView;if(this.disableIDBCache||!H.loadCachedNodeData||!H.addCachedNodeData)return!1;const W=R.index>=0?(G,H)=>this._nodeLoader.loadTextures(R,G,H):(G,H)=>this._clientNodeLoader.loadTextures(R,G,H),q=await this.schedule((()=>H.loadCachedNodeData(R,G,W)),G);if(null==q)return!1;const Q=this._requiredAttributes,J=await this.reschedule((()=>this._loadAttributes(R,Q,G)),G);return await this.reschedule((()=>H.addCachedNodeData(R,q,{loadedAttributes:Q,attributeData:J},G)),G),this._nodeAdded(),!0}_loadUncached(R,G){return this._downloadingCount++,this._loadNodeData(R,G).catch((R=>{throw this._downloadingCount--,R})).then((H=>(this._downloadingCount--,this.schedule((()=>this.layerView.addNode(R,H,G)),G)))).then((()=>{this._nodeAdded(),R.cacheState=ht.iF.Cached})).catch((G=>{if(!(0,X.zf)(G))throw J.A.getLogger(this).error("#loadNodeData()",this.layer,"Failed to load node '".concat(R.id,"'"),G),R.failed=!0,null!=this._index&&this._index.requestUpdate(),G}))}_updateIdleState(R){R!==this._isIdle&&(this._isIdle=R,this._evaluateUpdating(),R&&this._index&&null!=this._index&&this._index.resetFailedNodes())}_getScale(R){if(this._loadedNodeScales.has(R.index))return this._loadedNodeScales.get(R.index);const G=this._computeScale(R);return this.layerView.isNodeLoaded(R.index)&&this._loadedNodeScales.set(R.index,G),G}_computeScale(R){this._tmpPoint.x=R.serviceMbsInIndexSR[0],this._tmpPoint.y=R.serviceMbsInIndexSR[1],this._tmpPoint.z=R.serviceMbsInIndexSR[2];const G=R.serviceMbsInIndexSR[3];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,G)}_isNodeInScaleBounds(R){if(!this._areScaleBoundsActive)return!0;const G=this._getScale(R),{minScale:H,maxScale:W}=(0,pi.Cf)(this.layer);return(0,pi.JU)(G,H,W)}get test(){const R=this;return{index:this._index,set disableUpdates(G){R._updatesDisabled=G,G?R.cancelNodeLoading():R.requestUpdate()},set disableIDBCache(G){R.disableIDBCache=G},set ignoreServiceObb(G){null!=R._index&&(R._index.ignoreServiceObb=G)},shouldLoadNode:G=>R._shouldLoadNode(G)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}geometryFilterChanged(R){const G=this._index;null!=G&&G.layerFilterChanged(R),this._setCameraDirty()}};(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"isMeshPyramid",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"isGraphics3D",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"useMaximumNumberOfFeatures",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"indexStreamController",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"dataStreamController",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"crsVertex",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"crsIndex",null),(0,W._)([(0,ee.MZ)()],mi.prototype,"screenSizeFactor",void 0),(0,W._)([(0,ee.MZ)()],mi.prototype,"featureTarget",void 0),(0,W._)([(0,ee.MZ)()],mi.prototype,"fixedFeatureTarget",void 0),(0,W._)([(0,ee.MZ)()],mi.prototype,"layerView",void 0),(0,W._)([(0,ee.MZ)()],mi.prototype,"layer",null),(0,W._)([(0,ee.MZ)()],mi.prototype,"updating",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"running",null),(0,W._)([(0,ee.MZ)()],mi.prototype,"updatingProgress",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],mi.prototype,"leavesReached",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],mi.prototype,"scaleVisibilityEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],mi.prototype,"worker",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0,dependsOn:[]})],mi.prototype,"rootNodeVisible",null),mi=(0,W._)([(0,ie.$)("esri.layers.graphics.controllers.I3SOnDemandController")],mi);const gi=new pe.A({deallocator:null});let fi;function I3SOnDemandController_$(R,G){return null!=R&&R.length===G.length&&R.every((R=>I3SOnDemandController_K(G,R.name)>=0))}function I3SOnDemandController_K(R,G){const H=G.toLowerCase();for(let W=0;W<R.length;W++)if(R[W].name.toLowerCase()===H)return W;return-1}const yi={factorIM:.2,factor3dObject:.05,distancePenalty:10},vi=(0,Fe.vt)();var bi;!function(R){R[R.pop=0]="pop",R[R.fadeout=1]="fadeout"}(bi||(bi={}));var xi=H(57022),Si=(H(63831),H(56428)),Ci=H(22132),wi=(H(41007),H(21343),H(49376)),Ai=H(61163),Ri=(H(1804),H(26374),H(2725),H(66178),H(52902),H(55088),H(27150),H(16534)),Ti=(H(53440),H(69719)),Ei=H(54208),Oi=H(48997),Pi=H(78658),Mi=H(42640),Ii=H(70948);function rendererConversion_t(R){return null==R||"simple"===R.type||"unique-value"===R.type||"class-breaks"===R.type||"dictionary"===R.type||"heatmap"===R.type}function rendererConversion_s(R,G){if(null==R)return null;if(!rendererConversion_t(R))return new Ze.A("renderer-conversion-3d:unsupported-renderer","Unsupported renderer of type '".concat(R.type||R.declaredClass,"'"),{renderer:R});switch(R.type){case"simple":return function rendererConversion_u(R){return rendererConversion_l(R,(0,Ii.t)(R.symbol).error)}(R);case"unique-value":return function rendererConversion_i(R,G){var H;const W={...Ii.c,...G},q=null===(H=R.uniqueValueInfos)||void 0===H?void 0:H.map((R=>(0,Ii.t)(R.symbol,W).error)).filter(ce.Ru),Q=(0,Ii.t)(R.defaultSymbol,W);return Q.error&&null!==q&&void 0!==q&&q.unshift(Q.error),rendererConversion_l(R,q)}(R,G);case"class-breaks":return function rendererConversion_a(R){const G=R.classBreakInfos.map((R=>(0,Ii.t)(R.symbol).error)).filter(ce.Ru),H=(0,Ii.t)(R.defaultSymbol);return H.error&&G.unshift(H.error),rendererConversion_l(R,G)}(R);case"dictionary":case"heatmap":return null}return null}function rendererConversion_l(R,G){if(!G)return null;let H;if(H=Array.isArray(G)?G:[G],H.length>0){const G=H.map((R=>R.details.symbol.type||R.details.symbol.declaredClass)).filter((R=>!!R));G.sort();const W=[];return G.forEach(((R,H)=>{0!==H&&R===G[H-1]||W.push(R)})),new Ze.A("renderer-conversion-3d:unsupported-symbols","Renderer contains symbols (".concat(W.join(", "),") which are not supported in 3D"),{renderer:R,symbolErrors:H})}return null}var Di=H(18214),Li=H(67305),Fi=H(80190),Ni=H(3191),Vi=H(31999),Ui=H(5623),Gi=H(99442),zi=H(75332);const Bi=Ni.A.fromSimpleMarkerSymbol(Gi.UK),Hi=Li.A.fromSimpleLineSymbol(Gi.A7),ji=Vi.A.fromSimpleFillSymbol(Gi.Cx),Wi=new Fi.A({symbolLayers:new he.A([new Di.A({material:{color:zi.fT},edges:new Ui.A({size:"1px",color:zi.JR})})])});function defaults3D_j(R){if(null==R)return null;switch(R.type){case"mesh":return Wi;case"point":case"multipoint":return Bi;case"polyline":return Hi;case"polygon":case"extent":return ji}return null}var ki=H(188),qi=H(28915);const Zi=3,Qi=3,Yi=10;var Ji,Xi=H(52273),$i=H(53395),Ki=H(69903),er=H(52941),tr=H(7212);!function(R){R.length=function t(R,G){const H=R[G],W=R[G+1],q=R[G+2];return Math.sqrt(H*H+W*W+q*q)},R.normalize=function c(R,G){const H=R[G],W=R[G+1],q=R[G+2],Q=1/Math.sqrt(H*H+W*W+q*q);R[G]*=Q,R[G+1]*=Q,R[G+2]*=Q},R.scale=function o(R,G,H){R[G]*=H,R[G+1]*=H,R[G+2]*=H},R.add=function r(R,G,H,W,q){let Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:G;(q=q||R)[Q]=R[G]+H[W],q[Q+1]=R[G+1]+H[W+1],q[Q+2]=R[G+2]+H[W+2]},R.subtract=function u(R,G,H,W,q){let Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:G;(q=q||R)[Q]=R[G]-H[W],q[Q+1]=R[G+1]-H[W+1],q[Q+2]=R[G+2]-H[W+2]}}(Ji||(Ji={}));var ir=H(12298),rr=H(67862),nr=H(22650);const sr=Ji,ar=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],or=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],lr=[0,0,1,0,1,1,0,1],cr=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],dr=new Array(36);for(let ag=0;ag<6;ag++)for(let R=0;R<6;R++)dr[6*ag+R]=ag;const hr=new Array(36);for(let ag=0;ag<6;ag++)hr[6*ag]=0,hr[6*ag+1]=1,hr[6*ag+2]=2,hr[6*ag+3]=2,hr[6*ag+4]=3,hr[6*ag+5]=0;const ur=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],pr=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],_r=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],mr=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];const gr=(0,$i.fA)(-.5,0,-.5),fr=(0,$i.fA)(.5,0,-.5),yr=(0,$i.fA)(0,0,.5),vr=(0,$i.fA)(0,.5,0),br=(0,$i.vt)(),xr=(0,$i.vt)(),Sr=(0,$i.vt)(),Cr=(0,$i.vt)(),wr=(0,$i.vt)();(0,be.f)(br,gr,vr),(0,be.f)(xr,gr,fr),(0,be.b)(Sr,br,xr),(0,be.n)(Sr,Sr),(0,be.f)(br,fr,vr),(0,be.f)(xr,fr,yr),(0,be.b)(Cr,br,xr),(0,be.n)(Cr,Cr),(0,be.f)(br,yr,vr),(0,be.f)(xr,yr,gr),(0,be.b)(wr,br,xr),(0,be.n)(wr,wr);const Ar=[gr,fr,yr,vr],Rr=[0,-1,0,Sr[0],Sr[1],Sr[2],Cr[0],Cr[1],Cr[2],wr[0],wr[1],wr[2]],Tr=[0,1,2,3,1,0,3,2,1,3,0,2],Er=[0,0,0,1,1,1,2,2,2,3,3,3];function GeometryUtil_rt(R,G,H,W){const q=function GeometryUtil_lt(R,G,H){const W=R;let q,Q;if(H)q=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],Q=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const R=W*(1+Math.sqrt(5))/2;q=[-W,R,0,W,R,0,-W,-R,0,W,-R,0,0,-W,R,0,W,R,0,-W,-R,0,W,-R,R,0,-W,R,0,W,-R,0,-W,-R,0,W],Q=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let $=0;$<q.length;$+=3)sr.scale(q,$,R/sr.length(q,$));let J={};function h(G,H){G>H&&([G,H]=[H,G]);const W=G.toString()+"."+H.toString();if(J[W])return J[W];let Q=q.length;return q.length+=3,sr.add(q,3*G,q,3*H,q,Q),sr.scale(q,Q,R/sr.length(q,Q)),Q/=3,J[W]=Q,Q}for(let $=0;$<G;$++){const R=Q.length,G=new Array(4*R);for(let H=0;H<R;H+=3){const R=Q[H],W=Q[H+1],q=Q[H+2],J=h(R,W),X=h(W,q),$=h(q,R),K=4*H;G[K]=R,G[K+1]=J,G[K+2]=$,G[K+3]=W,G[K+4]=X,G[K+5]=J,G[K+6]=q,G[K+7]=$,G[K+8]=X,G[K+9]=J,G[K+10]=X,G[K+11]=$}Q=G,J={}}const X=(0,Ve.Wz)(q);for(let $=0;$<X.length;$+=3)sr.normalize(X,$);return[[Wt.r.POSITION,new tr.n((0,Ve.Wz)(q),Q,3,!0)],[Wt.r.NORMAL,new tr.n(X,Q,3,!0)]]}(G,H,W);return new rr.V(R,q)}function GeometryUtil_ht(R,G,H,W,q,Q,J,X){var $;let K=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null;const ee=H?(0,xe.o8)(H):(0,xe.vt)(),te=G?(0,xe.o8)(G):(0,xe.fA)(0,0,1);null!==($=J)&&void 0!==$||(J=(0,Xi.vt)());const ie=W?[255*W[0],255*W[1],255*W[2],W.length>3?255*W[3]:255]:[255,255,255,255],re=null!=q&&2===q.length?q:[1,1],ne=(0,Ue.EH)(1),se=[[Wt.r.POSITION,new tr.n(ee,ne,3,!0)],[Wt.r.NORMAL,new tr.n(te,ne,3,!0)],[Wt.r.UV0,new tr.n(J,ne,J.length)],[Wt.r.COLOR,new tr.n(ie,ne,4,!0)],[Wt.r.SIZE,new tr.n(re,ne,2)]];if(null!=Q&&(Q=[Q[0],Q[1],Q[2],Q[3]],se.push([Wt.r.CENTEROFFSETANDDISTANCE,new tr.n(Q,ne,4)])),X){const R=[X[0],X[1],X[2],X[3]];se.push([Wt.r.FEATUREATTRIBUTE,new tr.n(R,ne,4)])}return new rr.V(R,se,null,ir.X.Point,K)}function GeometryUtil_at(R,G,H,W,q){let Q=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],J=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],X=0;const $=H,K=G;let ee=(0,$i.fA)(0,X,0),te=(0,$i.fA)(0,X+K,0),ie=(0,$i.fA)(0,-1,0),re=(0,$i.fA)(0,1,0);q&&(X=K,te=(0,$i.fA)(0,0,0),ee=(0,$i.fA)(0,X,0),ie=(0,$i.fA)(0,1,0),re=(0,$i.fA)(0,-1,0));const ne=[te,ee],se=[ie,re],ae=W+2,oe=Math.sqrt(K*K+$*$);if(q)for(let pe=W-1;pe>=0;pe--){const R=pe*(2*Math.PI/W),G=(0,$i.fA)(Math.cos(R)*$,X,Math.sin(R)*$);ne.push(G);const H=(0,$i.fA)(K*Math.cos(R)/oe,-$/oe,K*Math.sin(R)/oe);se.push(H)}else for(let pe=0;pe<W;pe++){const R=pe*(2*Math.PI/W),G=(0,$i.fA)(Math.cos(R)*$,X,Math.sin(R)*$);ne.push(G);const H=(0,$i.fA)(K*Math.cos(R)/oe,$/oe,K*Math.sin(R)/oe);se.push(H)}const le=new Array,ce=new Array;if(Q){for(let R=3;R<ne.length;R++)le.push(1),le.push(R-1),le.push(R),ce.push(0),ce.push(0),ce.push(0);le.push(ne.length-1),le.push(2),le.push(1),ce.push(0),ce.push(0),ce.push(0)}if(J){for(let R=3;R<ne.length;R++)le.push(R),le.push(R-1),le.push(0),ce.push(R),ce.push(R-1),ce.push(1);le.push(0),le.push(2),le.push(ne.length-1),ce.push(1),ce.push(2),ce.push(se.length-1)}const de=(0,Ve.oe)(3*ae);for(let pe=0;pe<ae;pe++)de[3*pe]=ne[pe][0],de[3*pe+1]=ne[pe][1],de[3*pe+2]=ne[pe][2];const he=(0,Ve.oe)(3*ae);for(let pe=0;pe<ae;pe++)he[3*pe]=se[pe][0],he[3*pe+1]=se[pe][1],he[3*pe+2]=se[pe][2];const ue=[[Wt.r.POSITION,new tr.n(de,le,3,!0)],[Wt.r.NORMAL,new tr.n(he,ce,3,!0)]];return new rr.V(R,ue)}function Mt(R,G,H,W,q){return!(Math.abs((0,be.k)(G,R))>q)&&((0,be.b)(H,R,G),(0,be.n)(H,H),(0,be.b)(W,H,R),(0,be.n)(W,W),!0)}function At(R,G,H,W,q,Q,J){return Mt(R,G,q,Q,J)||Mt(R,H,q,Q,J)||Mt(R,W,q,Q,J)}(0,xe.vt)();class LodResources_s{constructor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.geometry=R,this.textures=G}}class LodResources_r{constructor(R,G,H){this.components=R,this.minScreenSpaceRadius=G,this.pivotOffset=H;const W=this.geometries;this.numVertices=W.reduce(((R,G)=>R+G.attributes.get(Wt.r.POSITION).indices.length),0)}get geometries(){return(0,ce.Am)(this.components.map((R=>R.geometry)))}}class LodResources_n{constructor(R){this.levels=R,this.levels.sort(((R,G)=>R.minScreenSpaceRadius===G.minScreenSpaceRadius?R.numVertices-G.numVertices:R.minScreenSpaceRadius-G.minScreenSpaceRadius))}}function LodResources_c(R){const G=[];return R.levels.forEach((R=>R.components.forEach((R=>G.push(R.geometry.material))))),(0,ce.Am)(G)}function LodResources_o(R){const G=new Array;return R.levels.forEach((R=>R.components.forEach((R=>{null!=R.textures&&G.push(...R.textures)})))),(0,ce.Am)(G)}function LodResources_i(R){const G=new Array;return R.levels.forEach((R=>R.components.forEach((R=>G.push(R.geometry))))),(0,ce.Am)(G)}function primitiveObjectSymbolUtils_S(R,G){const m=function(R,G){let H=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new LodResources_n(R.map((R=>{const W=G(R.tesselation);return H&&function Ot(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:R;const H=R.attributes,W=H.get(Wt.r.POSITION).data,q=H.get(Wt.r.NORMAL).data;if(q){const R=G.getMutableAttribute(Wt.r.NORMAL).data;for(let G=0;G<q.length;G+=3){const H=q[G+1];R[G+1]=-q[G+2],R[G+2]=H}}if(W){const R=G.getMutableAttribute(Wt.r.POSITION).data;for(let G=0;G<W.length;G+=3){const H=W[G+1];R[G+1]=-W[G+2],R[G+2]=H}}}(W),new LodResources_r([new LodResources_s(W)],R.minScreenSpaceRadius)})))};switch(R){case"sphere":return m([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(R=>GeometryUtil_rt(G,.5,R,!0)));case"cube":return m([{tesselation:0,minScreenSpaceRadius:0}],(()=>function GeometryUtil_G(R,G){Array.isArray(G)||(G=[G,G,G]);const H=new Array(24);for(let W=0;W<8;W++)H[3*W]=ar[W][0]*G[0],H[3*W+1]=ar[W][1]*G[1],H[3*W+2]=ar[W][2]*G[2];return new rr.V(R,[[Wt.r.POSITION,new tr.n(H,cr,3,!0)],[Wt.r.NORMAL,new tr.n(or,dr,3)],[Wt.r.UV0,new tr.n(lr,hr,2)]])}(G,1)));case"cone":return m(Or,(R=>GeometryUtil_at(G,1,.5,R,!1)),!0);case"inverted-cone":return m(Or,(R=>GeometryUtil_at(G,1,.5,R,!0)),!0);case"cylinder":return m(Or,(R=>function GeometryUtil_ft(R,G,H,W,q,Q,J){var X;const $=q?(0,$i.o8)(q):(0,$i.fA)(1,0,0),K=Q?(0,$i.o8)(Q):(0,$i.fA)(0,0,0);null!==(X=J)&&void 0!==X||(J=!0);const ee=(0,$i.vt)();(0,be.n)(ee,$);const te=(0,$i.vt)();(0,be.h)(te,ee,Math.abs(G));const ie=(0,$i.vt)();(0,be.h)(ie,te,-.5),(0,be.g)(ie,ie,K);const re=(0,$i.fA)(0,1,0);Math.abs(1-(0,be.k)(ee,re))<.2&&(0,be.s)(re,0,0,1);const ne=(0,$i.vt)();(0,be.b)(ne,ee,re),(0,be.n)(ne,ne),(0,be.b)(re,ne,ee);const se=2*W+(J?2:0),ae=W+(J?2:0),oe=(0,Ve.oe)(3*se),le=(0,Ve.oe)(3*ae),ce=(0,Ve.oe)(2*se),de=new Array(3*W*(J?4:2)),he=new Array(3*W*(J?4:2));J&&(oe[3*(se-2)]=ie[0],oe[3*(se-2)+1]=ie[1],oe[3*(se-2)+2]=ie[2],ce[2*(se-2)]=0,ce[2*(se-2)+1]=0,oe[3*(se-1)]=oe[3*(se-2)]+te[0],oe[3*(se-1)+1]=oe[3*(se-2)+1]+te[1],oe[3*(se-1)+2]=oe[3*(se-2)+2]+te[2],ce[2*(se-1)]=1,ce[2*(se-1)+1]=1,le[3*(ae-2)]=-ee[0],le[3*(ae-2)+1]=-ee[1],le[3*(ae-2)+2]=-ee[2],le[3*(ae-1)]=ee[0],le[3*(ae-1)+1]=ee[1],le[3*(ae-1)+2]=ee[2]);const V=(R,G,H)=>{de[R]=G,he[R]=H};let ue=0;const pe=(0,$i.vt)(),_e=(0,$i.vt)();for(let ge=0;ge<W;ge++){const R=ge*(2*Math.PI/W);(0,be.h)(pe,re,Math.sin(R)),(0,be.h)(_e,ne,Math.cos(R)),(0,be.g)(pe,pe,_e),le[3*ge]=pe[0],le[3*ge+1]=pe[1],le[3*ge+2]=pe[2],(0,be.h)(pe,pe,H),(0,be.g)(pe,pe,ie),oe[3*ge]=pe[0],oe[3*ge+1]=pe[1],oe[3*ge+2]=pe[2],ce[2*ge]=ge/W,ce[2*ge+1]=0,oe[3*(ge+W)]=oe[3*ge]+te[0],oe[3*(ge+W)+1]=oe[3*ge+1]+te[1],oe[3*(ge+W)+2]=oe[3*ge+2]+te[2],ce[2*(ge+W)]=ge/W,ce[2*ge+1]=1;const G=(ge+1)%W;V(ue++,ge,ge),V(ue++,ge+W,ge),V(ue++,G,G),V(ue++,G,G),V(ue++,ge+W,ge),V(ue++,G+W,G)}if(J){for(let R=0;R<W;R++){const G=(R+1)%W;V(ue++,se-2,ae-2),V(ue++,R,ae-2),V(ue++,G,ae-2)}for(let R=0;R<W;R++){const G=(R+1)%W;V(ue++,R+W,ae-1),V(ue++,se-1,ae-1),V(ue++,G+W,ae-1)}}const me=[[Wt.r.POSITION,new tr.n(oe,de,3,!0)],[Wt.r.NORMAL,new tr.n(le,he,3,!0)],[Wt.r.UV0,new tr.n(ce,de,2,!0)]];return new rr.V(R,me)}(G,1,.5,R,[0,0,1],[0,0,.5])));case"tetrahedron":return m([{tesselation:0,minScreenSpaceRadius:0}],(()=>function GeometryUtil_ot(R,G){Array.isArray(G)||(G=[G,G,G]);const H=new Array(12);for(let W=0;W<4;W++)H[3*W]=Ar[W][0]*G[0],H[3*W+1]=Ar[W][1]*G[1],H[3*W+2]=Ar[W][2]*G[2];return new rr.V(R,[[Wt.r.POSITION,new tr.n(H,Tr,3,!0)],[Wt.r.NORMAL,new tr.n(Rr,Er,3)]])}(G,1)),!0);case"diamond":return m([{tesselation:0,minScreenSpaceRadius:0}],(()=>function GeometryUtil_z(R,G){Array.isArray(G)||(G=[G,G,G]);const H=new Array(18);for(let W=0;W<6;W++)H[3*W]=ur[W][0]*G[0],H[3*W+1]=ur[W][1]*G[1],H[3*W+2]=ur[W][2]*G[2];return new rr.V(R,[[Wt.r.POSITION,new tr.n(H,_r,3,!0)],[Wt.r.NORMAL,new tr.n(pr,mr,3)]])}(G,1)),!0);default:return}}const Or=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class SymbolComplexity_e{constructor(R){var G,H,W,q;this.estimated=!1,this.verticesPerFeature=null!==(G=R.verticesPerFeature)&&void 0!==G?G:0,this.verticesPerCoordinate=null!==(H=R.verticesPerCoordinate)&&void 0!==H?H:0,this.drawCallsPerFeature=null!==(W=R.drawCallsPerFeature)&&void 0!==W?W:0,this.memory=null!==(q=R.memory)&&void 0!==q?q:new SymbolComplexity_a}}class SymbolComplexity_t extends SymbolComplexity_e{constructor(R){super(R),this.estimated=!0}}class SymbolComplexity_s extends SymbolComplexity_e{constructor(R,G){super(G),this.numComplexities=R}}class SymbolComplexity_r extends SymbolComplexity_t{constructor(R,G){super(G),this.numComplexities=R}}class SymbolComplexity_a{constructor(){this.bytesPerFeature=0,this.bytesPerFeatureLabel=0,this.resourceBytes=0,this.draped={bytesPerFeature:0,bytesPerFeatureLabel:0}}}var Pr=H(25694),Mr=H(2528);const Ir=new SymbolComplexity_t({});function defaultSymbolComplexity_F(R){let G=0,H=0,W=0,q=!1,Q=0;const J=new SymbolComplexity_a;for(const X of R)null!=X&&(G+=X.verticesPerFeature,H+=X.verticesPerCoordinate,W+=X.drawCallsPerFeature,J.bytesPerFeature+=X.memory.bytesPerFeature,J.bytesPerFeatureLabel+=X.memory.bytesPerFeatureLabel,J.resourceBytes+=X.memory.resourceBytes,J.draped.bytesPerFeature+=X.memory.bytesPerFeature,J.draped.bytesPerFeatureLabel+=X.memory.bytesPerFeatureLabel,q=q||X.estimated,++Q);return q?new SymbolComplexity_r(Q,{verticesPerFeature:G,verticesPerCoordinate:H,drawCallsPerFeature:W,memory:J}):new SymbolComplexity_s(Q,{verticesPerFeature:G,verticesPerCoordinate:H,drawCallsPerFeature:W,memory:J})}const Dr={};function defaultSymbolComplexity_L(R,G){var H,W,q;const Q=defaultSymbolComplexity_C(R,G),J=(0,Pr.RF)(G)?2:0;switch(G.type){case"extrude":return new SymbolComplexity_e({verticesPerFeature:-12,verticesPerCoordinate:12,drawCallsPerFeature:J,memory:Q});case"fill":if("mesh-3d"===R.type)return new SymbolComplexity_e({drawCallsPerFeature:J,memory:Q});if(null!=G.outline&&G.outline.size>0)return new SymbolComplexity_e({verticesPerFeature:-12,verticesPerCoordinate:9,memory:Q});case"water":return new SymbolComplexity_e({verticesPerFeature:-6,verticesPerCoordinate:3,memory:Q});case"line":return new SymbolComplexity_e({verticesPerFeature:-6,verticesPerCoordinate:6,memory:Q});case"object":return null!==(H=G.resource)&&void 0!==H&&H.href?new SymbolComplexity_t({verticesPerFeature:100,memory:Q}):{...defaultSymbolComplexity_f(null!==(W=null===(q=G.resource)||void 0===q?void 0:q.primitive)&&void 0!==W?W:qi.r),memory:Q};case"path":{var X;let R=0,H=0;switch(G.profile){case"circle":R=Yi;break;case"quad":R=4;break;default:return void(0,ki.Xb)(G.profile)}switch(null!==(X=G.join)&&void 0!==X?X:"simple"){case"round":H=Zi;break;case"miter":case"bevel":H=1;break;default:return}const W=2*R,q=R*H*2,J=q+W;let $=-2*q-W;switch(G.cap){case"none":break;case"butt":case"square":$+=2*(R-1);break;case"round":$+=2*(R*(Qi-1)*2+R);break;default:return}return new SymbolComplexity_e({verticesPerFeature:$,verticesPerCoordinate:J,memory:Q})}case"text":case"icon":return new SymbolComplexity_e({verticesPerFeature:6,memory:Q});default:return}}function defaultSymbolComplexity_C(R,G){const H="point-3d"===R.type;switch(G.type){case"extrude":return G.edges&&G.edges.size>0?Lr.EXTRUDE_EDGES:Lr.EXTRUDE;case"fill":return null!=G.outline&&G.outline.size>0?Lr.FILL_OUTLINE:Lr.FILL;case"water":return Lr.FILL;case"line":return"round"===G.join?Lr.LINE_ROUND:Lr.LINE_MITER;case"path":switch(G.join){case"round":switch(G.profile){case"circle":return Lr.PATH_ROUND_CIRCLE;case"quad":return Lr.PATH_ROUND_QUAD;default:return void(0,ki.Xb)(G.profile)}case"miter":case"bevel":switch(G.profile){case"circle":return Lr.PATH_MITER_CIRCLE;case"quad":return Lr.PATH_MITER_QUAD;default:return void(0,ki.Xb)(G.profile)}default:return}case"object":return H?Lr.OBJECT_POINT:Lr.OBJECT_POLYGON;case"icon":case"text":return H?Lr.ICON_POINT:Lr.ICON_POLYGON;default:return}}function defaultSymbolComplexity_f(R){const G=Dr[R];if(G)return G;const H=defaultSymbolComplexity_w(primitiveObjectSymbolUtils_S(R,new Mr.$U({})).levels);return Dr[R]=new SymbolComplexity_e({verticesPerFeature:H}),Dr[R]}function defaultSymbolComplexity_w(R){return R.reduce(((R,G,H)=>R+G.numVertices*(1/10**H)),0)/R.reduce(((R,G,H)=>R+1/10**H),0)}const Lr={ICON_POINT:{bytesPerFeature:2379.8272296852992,bytesPerFeatureLabel:852.246235,resourceBytes:0,draped:{bytesPerFeature:1868.2382921559424,bytesPerFeatureLabel:839.205415}},ICON_POLYGON:{bytesPerFeature:2957.8429876524656,bytesPerFeatureLabel:862.5307816666666,resourceBytes:0,draped:{bytesPerFeature:2579.7767085451133,bytesPerFeatureLabel:856.9298550000001}},OBJECT_POINT:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999,resourceBytes:0,draped:{bytesPerFeature:603.543820573039,bytesPerFeatureLabel:717.4551849999999}},OBJECT_POLYGON:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998,resourceBytes:0,draped:{bytesPerFeature:1111.1693389308373,bytesPerFeatureLabel:707.4535949999998}},LINE_MITER:{bytesPerFeature:3081.208408220661,bytesPerFeatureLabel:858.6749016666668,resourceBytes:0,draped:{bytesPerFeature:2682.57863388475,bytesPerFeatureLabel:844.6118016666666}},LINE_ROUND:{bytesPerFeature:3209.3236242927915,bytesPerFeatureLabel:858.1810416666667,resourceBytes:0,draped:{bytesPerFeature:2687.6256038096126,bytesPerFeatureLabel:849.578535}},PATH_MITER_CIRCLE:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415,resourceBytes:0,draped:{bytesPerFeature:38708.74276663992,bytesPerFeatureLabel:858.70415}},PATH_ROUND_CIRCLE:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001,resourceBytes:0,draped:{bytesPerFeature:42098.00590216518,bytesPerFeatureLabel:868.3632500000001}},PATH_MITER_QUAD:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355,resourceBytes:0,draped:{bytesPerFeature:25037.823002405767,bytesPerFeatureLabel:835.93355}},PATH_ROUND_QUAD:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955,resourceBytes:0,draped:{bytesPerFeature:40320.254760224525,bytesPerFeatureLabel:851.66955}},FILL:{bytesPerFeature:3147.43349219103,bytesPerFeatureLabel:850.7598550000001,resourceBytes:0,draped:{bytesPerFeature:2673.7898488975106,bytesPerFeatureLabel:846.6459950000002}},FILL_OUTLINE:{bytesPerFeature:4565.099993465867,bytesPerFeatureLabel:855.334515,resourceBytes:0,draped:{bytesPerFeature:3904.46969705314,bytesPerFeatureLabel:844.7081016666667}},EXTRUDE:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333,resourceBytes:0,draped:{bytesPerFeature:7551.2282834569505,bytesPerFeatureLabel:849.5513283333333}},EXTRUDE_EDGES:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335,resourceBytes:0,draped:{bytesPerFeature:2959.8379634500698,bytesPerFeatureLabel:602.0969283333335}}};class DisplayFeatureLimit_e{constructor(R,G,H){this.maximumTotalNumberOfVertices=R,this.maximumNumberOfFeatures=G,this.averageSymbolComplexity=H}}var Fr,Nr;H(22156);class ElevationQuery_l{constructor(R,G){this.spatialReference=R,this._view=G}getElevation(R,G,H){return this._view.elevationProvider.getElevation(R,G,0,this.spatialReference,H)}async queryElevation(R,G,H,W,q){return this._view.elevationProvider.queryElevation(R,G,0,this.spatialReference,q,H,W)}}!function(R){R[R.USER=1]="USER",R[R.SCALE_RANGE=2]="SCALE_RANGE",R[R.FILTER=4]="FILTER",R[R.DECONFLICTION=8]="DECONFLICTION",R[R.ALL_GRAPHIC=15]="ALL_GRAPHIC",R[R.ALL_LABEL=255]="ALL_LABEL"}(Fr||(Fr={})),function(R){R[R.GRAPHIC=1]="GRAPHIC",R[R.LABEL=16]="LABEL"}(Nr||(Nr={}));var Vr=H(73067),Ur=H(57224),Gr=H(41156),zr=H(19464);const Br=(0,Le.vt)();let Hr=class extends Q.A{constructor(R){super(R),this.events=new Vr.A,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(R,G)=>"graphic"in R?R.graphic.attributes[G]:zr.T.getAttribute(R,G),getAttributes:R=>"graphic"in R?R.graphic.attributes:zr.T.getAttributes(R),getObjectId:R=>{var G;return"graphic"in R?null!==(G=(0,Mi.RW)(R.graphic,this.objectIdField))&&void 0!==G?G:void 0:zr.T.getObjectId(R)},getGeometry:R=>"graphic"in R?R.getAsOptimizedGeometry(this.hasZ,this.hasM):zr.T.getGeometry(R),getCentroid:(R,G)=>{if("graphic"in R){let H=null;null!=R.centroid?H=R.centroid:"point"===R.graphic.geometry.type&&(0,Ei.projectPoint)(R.graphic.geometry,jr,this.viewSpatialReference)&&(H=jr);const W=new Array(2+(G.hasZ?1:0)+(G.hasM?1:0));return null==H?(W[0]=0,W[1]=0,W[2]=0,W[3]=0):(W[0]=H.x,W[1]=H.y,G.hasZ&&(W[2]=H.hasZ?H.z:0),G.hasM&&(W[G.hasZ?3:2]=H.hasM?H.m:0)),new Gr.A([],W)}return zr.T.getCentroid(R,G)},cloneWithGeometry:(R,G)=>"graphic"in R?new Ur.Om(G,this.featureAdapter.getAttributes(R),null,this.featureAdapter.getObjectId(R)):zr.T.cloneWithGeometry(R,G)}}forEachInBounds(R,G){this.getSpatialIndex().forEachInBounds(R,G)}forEachBounds(R,G){const H=this.getSpatialIndex();for(const W of R){const R=this.featureAdapter.getObjectId(W);null!=H.getBounds(R,Br)&&G(Br)}}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Hr.prototype,"getSpatialIndex",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Hr.prototype,"forEach",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Hr.prototype,"hasZ",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Hr.prototype,"hasM",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Hr.prototype,"objectIdField",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Hr.prototype,"viewSpatialReference",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Hr.prototype,"featureSpatialReference",void 0),Hr=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],Hr);const jr={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};class Graphics3DGraphicCreationContext_r{constructor(R,G,H){this.graphic=R,this.renderingInfo=G,this.layer=H}}class Graphics3DSymbolCreationContext_e{constructor(R,G){this.scheduler=R,this.schedule=G,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}}var Wr=H(8913),kr=H(62555),qr=H(87843);function GeometryWithMapPositions_e(R){return null!=R.mapPositions}function ElevationAligners_u(R,G,H,W,q){const Q=R.stageObject,J=Q.geometries;let X=0;for(const $ of J){if(!GeometryWithMapPositions_e($))continue;const{update:R,averageGeometrySampledElevation:J}=ElevationAligners_M($,G,H,W,q);X+=J,R&&Q.geometryVertexAttributeUpdated($,Wt.r.POSITION)}return X/J.length}function ElevationAligners_p(R,G,H,W,q,Q){const J=R.stageObject,X=G.centerPointInElevationSR;let $=0;J.usesVerticalDistanceToGround?(W(X,en),elevationAlignmentUtils_E(J,en.verticalDistanceToGround),$=en.sampledElevation):(W(X,en),"absolute-height"!==G.mode&&($=en.sampledElevation));const K=(0,ye.C)(Zr,null!==Q&&void 0!==Q?Q:J.transformation),ee=(0,be.s)(Kr,K[12],K[13],K[14]);qr.b.TESTS_DISABLE_OPTIMIZATIONS?(Yr[0]=X.x,Yr[1]=X.y,Yr[2]=en.z,(0,Bt.l)(X.spatialReference,Yr,K,q.spatialReference)&&(Q?(0,ye.C)(Q,K):J.transformation=K)):q.setAltitudeOfTransformation(en.z,K);const te=Qr/q.unitInMeters;return(Math.abs(K[12]-ee[0])>=te||Math.abs(K[13]-ee[1])>=te||Math.abs(K[14]-ee[2])>=te)&&(Q?(0,ye.C)(Q,K):J.transformation=K),$}const Zr=(0,ve.vt)();function ElevationAligners_b(R,G,H,W,q){const Q=R.graphics3DSymbolLayer.lodRenderer;if(null==Q)return 0;const J=G.centerPointInElevationSR;W(J,en);const X="absolute-height"!==G.mode?en.sampledElevation:0,$=Q.instanceData,K=R.instanceIndex,ee=$r;$.getGlobalTransform(K,ee);const te=(0,be.s)(Kr,ee[12],ee[13],ee[14]);qr.b.TESTS_DISABLE_OPTIMIZATIONS?(Yr[0]=J.x,Yr[1]=J.y,Yr[2]=en.z,(0,Bt.l)(J.spatialReference,Yr,ee,q.spatialReference)&&$.setGlobalTransform(K,ee)):q.setAltitudeOfTransformation(en.z,ee);const ie=Qr/q.unitInMeters;return(qr.b.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(ee[12]-te[0])>=ie||Math.abs(ee[13]-te[1])>=ie||Math.abs(ee[14]-te[2])>=ie)&&$.setGlobalTransform(K,ee),X}function ElevationAligners_I(R,G,H,W,q){const Q=R.stageObject,J=Q.geometries;if(0===J.length)return 0;let X=0,$=null,K=0,ee=!1;for(const te of J){if(!GeometryWithMapPositions_e(te))continue;const R=te.attributes.get(Wt.r.POSITION);if(R!==$){const{update:Q,averageGeometrySampledElevation:J}=ElevationAligners_M(te,G,H,W,q);K=J,$=R,ee=Q}ee&&Q.geometryVertexAttributeUpdated(te,Wt.r.POSITION),X+=K}return X/J.length}const Qr=.01,Yr=(0,xe.vt)(),Jr=(0,xe.vt)(),Xr=(0,xe.vt)(),$r=(0,ve.vt)(),Kr=(0,xe.vt)(),en=new elevationAlignmentUtils_R;function ElevationAligners_M(R,G,H,W,q){let Q=!1;const J=R.transformation,X=G.requiresSampledElevationInfo;Jr[0]=J[12],Jr[1]=J[13],Jr[2]=J[14],R.invalidateBoundingInfo();const $=R.getMutableAttribute(Wt.r.POSITION),K=$.data,ee=$.size,te=K.length/ee,ie=new ElevationProvider_r(R.mapPositions,H);let re=0,ne=0;for(let se=0;se<te;se++){if(Xr[0]=K[re],Xr[1]=K[re+1],Xr[2]=K[re+2],W(ie,en),X&&(ne+=en.sampledElevation),qr.b.TESTS_DISABLE_OPTIMIZATIONS)K[re]=ie.array[ie.offset],K[re+1]=ie.array[ie.offset+1],K[re+2]=en.z,(0,Ie.projectBuffer)(K,H,re,K,q.spatialReference,re,1),K[re]-=Jr[0],K[re+1]-=Jr[1],K[re+2]-=Jr[2],Q=!0;else{Yr[0]=K[re]+Jr[0],Yr[1]=K[re+1]+Jr[1],Yr[2]=K[re+2]+Jr[2],q.setAltitude(Yr,en.z),K[re]=Yr[0]-Jr[0],K[re+1]=Yr[1]-Jr[1],K[re+2]=Yr[2]-Jr[2];const R=Qr/q.unitInMeters;(Math.abs(Xr[0]-K[re])>=R||Math.abs(Xr[1]-K[re+1])>=R||Math.abs(Xr[2]-K[re+2])>=R)&&(Q=!0)}re+=ee,ie.offset+=3}return ne/=te,{update:Q,averageGeometrySampledElevation:ne}}var tn=H(61077),rn=H(78966);function graphicUtils_b(R,G){if("point"===R.type)return graphicUtils_M(R,G,!1);if(hydratedFeatures_o(R))switch(R.type){case"extent":return graphicUtils_M(R.center,G,!1);case"polygon":return graphicUtils_M(R.centroid,G,!1);case"polyline":return graphicUtils_M(graphicUtils_w(R),G,!0);case"mesh":return graphicUtils_M(R.origin,G,!1)}else switch(R.type){case"extent":return graphicUtils_M(function graphicUtils_z(R){return(0,We.T)(.5*(R.xmax+R.xmin),.5*(R.ymax+R.ymin),null!=R.zmin&&null!=R.zmax&&isFinite(R.zmin)&&isFinite(R.zmax)?.5*(R.zmax+R.zmin):void 0,R.spatialReference)}(R),G,!0);case"polygon":return graphicUtils_M(function graphicUtils_R(R){const G=R.rings[0];if(!G||0===G.length)return null;const H=(0,tn.S8)(R.rings,!!R.hasZ);return(0,We.T)(H[0],H[1],H[2],R.spatialReference)}(R),G,!0);case"polyline":return graphicUtils_M(graphicUtils_w(R),G,!0)}}function graphicUtils_w(R){const G=R.paths[0];if(!G||0===G.length)return null;const H=(0,rn.$H)(G,(0,rn.Yl)(G)/2);return(0,We.T)(H[0],H[1],H[2],R.spatialReference)}function graphicUtils_M(R,G,H){const W=H?R:function hydratedFeatures_x(R,G){if(!R)return null;let H;if(hydratedFeatures_m(R)){if(null==G)return R.clone();if(hydratedFeatures_m(G))return G.copy(R)}return null!=G?(H=G,H.x=R.x,H.y=R.y,H.spatialReference=R.spatialReference,R.hasZ?(H.z=R.z,H.hasZ=R.hasZ):(H.z=void 0,H.hasZ=!1),R.hasM?(H.m=R.m,H.hasM=!0):(H.m=void 0,H.hasM=!1)):(H=(0,We.T)(R.x,R.y,R.z,R.spatialReference),R.hasM&&(H.m=R.m,H.hasM=!0)),H}(R);return G&&R?(0,Ei.projectPoint)(R,W,G)?W:null:W}function graphicUtils_F(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const W=(0,Ce.o8)(Ce.Un);return null!=R&&(W[0]=R[0],W[1]=R[1],W[2]=R[2]),null!=G?W[3]=G:null!=R&&R.length>3&&(W[3]=R[3]),H&&(W[0]*=H,W[1]*=H,W[2]*=H,W[3]*=H),W}function graphicUtils_B(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:xe.Un,G=arguments.length>1?arguments[1]:void 0,H=arguments.length>2?arguments[2]:void 0,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const q=new Array(3);if(null==G||null==H)q[0]=1,q[1]=1,q[2]=1;else{let W,Q=0;for(let J=2;J>=0;J--){const X=R[J];let $;const K=null!=X,ee=0===J&&!W&&!K,te=H[J];"symbol-value"===X||ee?$=0!==te?G[J]/te:1:K&&"proportional"!==X&&isFinite(X)&&($=0!==te?X/te:1),null!=$&&(q[J]=$,W=$,Q=Math.max(Q,Math.abs($)))}for(let R=2;R>=0;R--)null==q[R]?q[R]=W:0===q[R]&&(q[R]=.001*Q)}for(let Q=2;Q>=0;Q--)q[Q]/=W;return(0,xe.ci)(q)}function graphicUtils_I(R){return graphicUtils_S(function graphicUtils_D(R){return null!=R.isPrimitive}(R)?[R.width,R.depth,R.height]:R)?null:"Symbol sizes may not be negative values"}function graphicUtils_S(R){const n=R=>null==R||R>=0;return Array.isArray(R)?R.every(n):n(R)}function graphicUtils_k(R,G,H){if(null!=H.minDemResolution)return H.minDemResolution;const W=(0,me.GA)(G),q=(0,Le.VL)(R)*W,Q=(0,Le.yr)(R)*W,J=(0,Le.uJ)(R)*(G.isGeographic?1:W);return 0===q&&0===Q&&0===J?H.minDemResolutionForPoints:.01*Math.max(q,Q,J)}var nn=H(21910);class Graphics3DObject3DGraphicLayer_m{constructor(R,G,H){this.baseMaterial=R,this.edgeMaterials=G,this.properties=H}}class Graphics3DObject3DGraphicLayer_p{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(R,G,H,W,q,Q,J){let X=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.graphics3DSymbolLayer=R,this.stageObject=G,this._uniqueGeometries=H,this._uniqueMaterials=W,this._sharedResource=q,this.elevationAligner=Q,this.elevationContext=J,this._edgeState=X,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(R){this._stageLayer=R;const G=R.stage;G.addMany(this._uniqueMaterials),G.addMany(this._uniqueGeometries),G.add(this.stageObject)}destroy(){var R,G;if(!this._stageLayer)return;const H=this._stageLayer.stage;H.removeMany(this._uniqueMaterials),H.removeMany(this._uniqueGeometries),H.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1),null!==(R=H.renderer.edgeView)&&void 0!==R&&R.removeObject(this.stageObject),this.stageObject.dispose(),null!==(G=this._sharedResource)&&void 0!==G&&G.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(R,G){if(null==this._edgeState)return;const H=Graphics3DObject3DGraphicLayer_v(this._edgeState.baseMaterial);let W=!1;for(const q of this._edgeState.edgeMaterials)q.objectTransparency!==H&&(q.objectTransparency=H,W=!0);W&&this.resetEdgeObject(G),this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[R])}slicePlaneEnabledChanged(R,G){null!=this._edgeState&&(this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:R},!G),this._edgeState.properties.hasSlicePlane=R)}setVisibility(R){if(null!=this._stageLayer&&this._visible!==R&&(this._visible=R,this.stageObject.visible=R,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),this._edgeState)){const G=this._stageLayer.stage.renderer.ensureEdgeView();G.hasObject(this.stageObject)?G.updateObjectVisibility(this.stageObject,R):R&&this._addOrUpdateEdgeObject(G,!1)}}get visible(){return this._visible}alignWithElevation(R,G,H,W){if(null==this.elevationAligner)return;null!=H&&featureExpressionInfoUtils_l(this.elevationContext.featureExpressionInfoContext,H);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,R.spatialReference,((H,W)=>elevationAlignmentUtils_c(H,R,this.elevationContext,G,W)),G),this.resetEdgeObject(W)}alignWithAbsoluteElevation(R,G,H){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,((G,H)=>{H.sampledElevation=R,H.verticalDistanceToGround=0,H.z=R}),G),this.resetEdgeObject(H)}getCenterObjectSpace(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,xe.vt)();return(0,be.c)(R,(0,Ge.g)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Le.vt)();const G=this.stageObject.boundingVolumeObjectSpace;return(0,Le.Ne)(R,G.min),(0,Le.vI)(R,G.max),R}computeAttachmentOrigin(R){const G=this.stageObject.effectiveTransformation;if(this.useObjectOriginAsAttachmentOrigin)R.render.origin[0]+=G[12],R.render.origin[1]+=G[13],R.render.origin[2]+=G[14],R.render.num++;else for(const H of this.stageObject.geometries)H.computeAttachmentOrigin(on)&&((0,be.e)(on,on,G),(0,be.g)(R.render.origin,R.render.origin,on),R.render.num++)}async getProjectedBoundingBox(R,G,H,W,q){const Q=this.getBoundingBoxObjectSpace(q),J=ln,X=(0,Le.fT)(Q)?1:J.length;for(let ie=0;ie<X;ie++){const R=J[ie];an[0]=Q[R[0]],an[1]=Q[R[1]],an[2]=Q[R[2]],(0,be.e)(an,an,this.stageObject.transformation),sn[3*ie]=an[0],sn[3*ie+1]=an[1],sn[3*ie+2]=an[2]}if(!R(sn,0,X))return null;(0,Le.Ie)(Q);let $=null;this.calculateRelativeScreenBounds&&($=this.calculateRelativeScreenBounds());for(let ie=0;ie<3*X;ie+=3){for(let R=0;R<3;R++)Q[R]=Math.min(Q[R],sn[ie+R]),Q[R+3]=Math.max(Q[R+3],sn[ie+R]);$&&H.push({location:sn.slice(ie,ie+3),screenSpaceBoundingRect:$})}if(null!==G&&void 0!==G&&G.service&&"absolute-height"!==this.elevationContext.mode){var K;(0,Le.gX)(Q,on);const R="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let H=0;if(G.useViewElevation)H=null!==(K=G.service.getElevation(on[0],on[1],R))&&void 0!==K?K:0;else try{var ee;const q=graphicUtils_k(Q,G.service.spatialReference,G);H=null!==(ee=await G.service.queryElevation(on[0],on[1],W,q,R))&&void 0!==ee?ee:0}catch(te){}(0,Le.cY)(Q,0,0,-this.alignedSampledElevation+H)}return Q}addObjectState(R,G){R===et.Mg.Highlight&&G.addObject(this.stageObject,this.stageObject.highlight()),R===et.Mg.MaskOccludee&&G.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(R){R.removeObject(this.stageObject)}resetEdgeObject(R){if(null==this._edgeState)return;const G=this._stageLayer.stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(G,R):G.removeObject(this.stageObject)}_addOrUpdateEdgeObject(R,G){const H=this._edgeState;if(null==H)return;const W=Graphics3DObject3DGraphicLayer_v(H.baseMaterial);for(const q of H.edgeMaterials)q.objectTransparency=W;R.addOrUpdateObject3D(this.stageObject,H.edgeMaterials,H.properties,!G).then((()=>{var R;return null===(R=this._stageLayer)||void 0===R?void 0:R.sync()}))}}function Graphics3DObject3DGraphicLayer_v(R){return R.isVisible()?R.parameters.transparent?nn.x.TRANSPARENT:nn.x.OPAQUE:nn.x.INVISIBLE}const sn=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],an=(0,xe.vt)(),on=(0,xe.vt)(),ln=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class Graphics3DObjectMetadata_t{constructor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.labelText=G,this.elevationOffset=null!==R&&void 0!==R?R:0}}var cn,dn;!function(R){R[R.RecreateSymbol=0]="RecreateSymbol",R[R.RecreateGraphics=1]="RecreateGraphics",R[R.FastUpdate=2]="FastUpdate"}(cn||(cn={}));class Loadable_r{constructor(R){this.schedule=R,this._abortController=null,this._loadStatus=dn.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(R,G){var H,W;return this._loadStatus===dn.LOADED?(R&&R(),null!==(H=this._loader)&&void 0!==H?H:Promise.resolve()):this._loadStatus===dn.FAILED?(G&&G(this._loadError),null!==(W=this._loader)&&void 0!==W?W:Promise.resolve()):(null==this._loader&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=dn.LOADED}),(R=>{throw this._loadError=R,this._abortController=null,this._loadStatus=dn.FAILED,!(0,X.zf)(R)&&this.logger&&R.message&&this.logger.warn(R.message),R}))),this._loader.then(R,G).catch((()=>{})),this._loader)}abortLoad(){null!=this._abortController?this._abortController=(0,Qe.DC)(this._abortController):this._loadStatus===dn.LOADING&&(this._loadStatus=dn.FAILED),this._loader=null}}!function(R){R[R.LOADING=0]="LOADING",R[R.LOADED=1]="LOADED",R[R.FAILED=2]="FAILED"}(dn||(dn={}));var hn=H(89568);const Graphics3DSymbolLayer_u=()=>J.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Graphics3DSymbolLayer_h extends Loadable_r{constructor(R,G,H,W){super(H.schedule),this.symbol=R,this.symbolLayer=G,this._context=H,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this._materials=[],this.usedMemory=0,this.logger=Graphics3DSymbolLayer_u(),this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=W.renderPriority,this._renderPriorityStep=W.renderPriorityStep,this._elevationContext=new ElevationContext_o,this.complexity=this.computeComplexity(),this.ignoreDrivers=W.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=Graphics3DSymbolLayer_f(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get materials(){return this._materials}_drivenPropertiesChanged(R){if(this.ignoreDrivers)return!1;const G=this._drivenProperties,H=Graphics3DSymbolLayer_f(R);return H.color!==G.color||H.opacity!==G.opacity||H.opacityAlwaysOpaque!==G.opacityAlwaysOpaque||H.size!==G.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(R,G,H,W){const q=R.projectionSuccess,Q="polygons"in R?R.polygons:null,J="".concat(W," geometry failed to be created");let X=null;q?!this._logGeometryValidationWarnings(G,H,W)&&Q&&0===Q.length&&"rings"===H&&G.length>0&&G[0].length>2&&(X="".concat(J," (filled rings should use clockwise winding - try reversing the order of vertices)")):X="".concat(J," (failed to project geometry to view spatial reference)"),X&&Graphics3DSymbolLayer_u().warnOncePerTick(X)}_logGeometryValidationWarnings(R,G,H){const W="".concat(H," geometry failed to be created");return!R.length||1===R.length&&!R[0].length?(Graphics3DSymbolLayer_u().warnOncePerTick("".concat(W," (no ").concat(G," were defined)")),!0):(!Array.isArray(R)||!Array.isArray(R[0]))&&(Graphics3DSymbolLayer_u().warnOncePerTick("".concat(W," (").concat(G," should be defined as a 2D array)")),!0)}_validateGeometry(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(null!=G&&!G.includes(R.type))return this.logger.warn("unsupported geometry type for "+H+" symbol: ".concat(R.type)),!1;if("point"===R.type){const G=R;if(!isFinite(G.x)||!isFinite(G.y))return Graphics3DSymbolLayer_u().warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return un}_defaultElevationInfoZ(){return pn}_updateElevationContext(){null!=this._elevationInfoOverride?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(R){return R.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getDefaultElevationInfo(R);return this._elevationContext.mode||G.mode}setElevationInfoOverride(R){this._elevationInfoOverride=R,this._updateElevationContext()}setGraphicElevationContext(R){var G,H;let W=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new ElevationContext_o;const q=R.geometry,Q=this.getDefaultElevationInfo(q);W.unit=null!=this._elevationContext.unit?this._elevationContext.unit:Q.unit,W.mode=this.getGeometryElevationMode(q,Q),W.offsetMeters=null!==(G=null!==(H=this._elevationContext.meterUnitOffset)&&void 0!==H?H:Q.offset)&&void 0!==G?G:0;const J=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===W.mode;J&&(W.mode="relative-to-ground",W.offsetMeters=0);const X=J?Kt:this._elevationContext.featureExpressionInfoContext;return W.updateFeatureExpressionInfoContext(X,R,this._context.layer),W}prepareSymbolLayerPatch(R){}updateGeometry(R,G){return!1}updateTransform(R,G,H,W){return!1}onRemoveGraphic(R){}_getLayerOpacity(){var R;if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return null!==(R=this._context.graphicsCoreOwner.fullOpacity)&&void 0!==R?R:0;const G=this._context.layer.opacity;return null!==G&&void 0!==G?G:1}_getCombinedOpacity(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_n,H=1;return this.draped||(H*=this._getLayerOpacity()),this._drivenProperties.opacity||(null!=R?H*=R.a:G.hasIntrinsicColor||(H=0)),H}_getCombinedOpacityAndColor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_n;const H=this._getCombinedOpacity(R,G);if(this._drivenProperties.color)return graphicUtils_F(null,H);return graphicUtils_F(null!=R?oe.A.toUnitRGB(R):xe.Un,H)}_getVertexOpacityAndColor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const H=graphicUtils_F(this._drivenProperties.color?R.color:null,this._drivenProperties.opacity?R.opacity:null);return G&&(H[0]*=G,H[1]*=G,H[2]*=G,H[3]*=G),H}isFastUpdatesEnabled(){return null!=this._fastUpdates}computeComplexity(){return defaultSymbolComplexity_L(this.symbol,this.symbolLayer)}globalPropertyChanged(R,G,H){switch(R){case"opacity":return this.layerOpacityChanged(G,H),!0;case"elevationInfo":{const R=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(G,H,R)!==Ht.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(G,H);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(R,G,H){let W=Ht.UPDATE;return R.forEach((R=>{const q=G(R);if(null!=q){const G=R.graphic;this.setGraphicElevationContext(G,q.elevationContext),q.needsElevationUpdates=H(q.elevationContext.mode)}else W=Ht.RECREATE})),W}applyRendererDiff(R,G){return cn.RecreateSymbol}getFastUpdateAttrValues(R){if(!this._fastUpdates)return null;const G=this._fastUpdates.visualVariables,H=G.size?(0,hn.ul)(G.size.field,R):0,W=G.color?(0,hn.ul)(G.color.field,R):0,q=G.opacity?(0,hn.ul)(G.opacity.field,R):0;return(0,Ce.fA)(H,W,q,0)}get draped(){return this._draped}ensureDrapedStatus(R){return null==this._draped?(this._draped=R,!0):(R!==this.draped&&Graphics3DSymbolLayer_u().warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>{var R,G,H,W,q,Q,J,X;return{size:null!==(R=null===(G=this._fastUpdates)||void 0===G||null===(G=G.visualVariables.size)||void 0===G?void 0:G.field)&&void 0!==R?R:null,color:null!==(H=null===(W=this._fastUpdates)||void 0===W||null===(W=W.visualVariables.color)||void 0===W?void 0:W.field)&&void 0!==H?H:null,opacity:null!==(q=null===(Q=this._fastUpdates)||void 0===Q||null===(Q=Q.visualVariables.opacity)||void 0===Q?void 0:Q.field)&&void 0!==q?q:null,rotation:null!==(J=null===(X=this._fastUpdates)||void 0===X||null===(X=X.visualVariables.rotation)||void 0===X?void 0:X.field)&&void 0!==J?J:null}}}}}function Graphics3DSymbolLayer_f(R){const G={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return R&&"visualVariables"in R&&R.visualVariables&&R.visualVariables.forEach((R=>{switch(R.type){case"color":if(G.color=!0,R.stops)for(let H=0;H<R.stops.length;H++){const W=R.stops[H].color;W&&(G.opacity=!0,W.a<1&&(G.opacityAlwaysOpaque=!1))}break;case"opacity":G.opacity=!0,G.opacityAlwaysOpaque=!1;break;case"size":G.size=!0}})),G}const un={mode:"on-the-ground",offset:0,unit:"meters"},pn={mode:"absolute-height",offset:0,unit:"meters"},_n={hasIntrinsicColor:!1};var mn=H(85792),gn=H(65518),fn=H(81666),yn=H(85728),vn=H(83279);class Object3D_O extends fn.J{get geometries(){return this._geometries}get transformation(){var R;return null!==(R=this._transformation)&&void 0!==R?R:ve.zK}set transformation(R){var G;this._transformation=(0,ye.C)(null!==(G=this._transformation)&&void 0!==G?G:(0,ve.vt)(),R),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(R){var G;this._shaderTransformation=R?(0,ye.C)(null!==(G=this._shaderTransformation)&&void 0!==G?G:(0,ve.vt)(),R):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){var R;return null!==(R=this.shaderTransformation)&&void 0!==R?R:this.transformation}constructor(){var R,G;let H=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.type=ir.X.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=null===(R=H.castShadow)||void 0===R||R,this.usesVerticalDistanceToGround=null!==(G=H.usesVerticalDistanceToGround)&&void 0!==G&&G,this.graphicUid=H.graphicUid,this.layerUid=H.layerUid,H.isElevationSource&&(this.lastValidElevationBB=new Object3D_A),this._geometries=H.geometries?Array.from(H.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(R){(0,nr.vA)(null==this._parentLayer||null==R,"Object3D can only be added to a single Layer"),this._parentLayer=R}addGeometry(R){R.visible=this._visible,this._geometries.push(R),this._emit("geometryAdded",{object:this,geometry:R}),this._invalidateBoundingVolume()}removeGeometry(R){const G=this._geometries.splice(R,1)[0];G&&(this._emit("geometryRemoved",{object:this,geometry:G}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(R,G){let H=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._emit("attributesChanged",{object:this,geometry:R,attribute:G,sync:H}),(0,Wt.b)(G)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(R){if(this._visible!==R){this._visible=R;for(const R of this._geometries)R.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const R=new yn.X(et.Mg.MaskOccludee);for(const G of this._geometries)G.occludees=(0,vn.Ci)(G.occludees,R);return this._emit("occlusionChanged",this),R}removeOcclude(R){for(const G of this._geometries)G.occludees=(0,vn.PC)(G.occludees,R);this._emit("occlusionChanged",this)}highlight(){const R=new yn.X(et.Mg.Highlight);for(const G of this._geometries)G.highlights=(0,vn.Ci)(G.highlights,R);return this._emit("highlightChanged",this),R}removeHighlight(R){for(const G of this._geometries)G.highlights=(0,vn.PC)(G.highlights,R);this._emit("highlightChanged",this)}getCombinedStaticTransformation(R,G){return(0,ye.lw)(G,this.transformation,R.transformation)}getCombinedShaderTransformation(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,ve.vt)();return(0,ye.lw)(G,this.effectiveTransformation,R.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Object3D_M,this._validateBoundingVolume(this._bvWorldSpace,wn.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Object3D_M,this._validateBoundingVolume(this._bvObjectSpace,wn.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(R,G){const H=G===wn.ObjectSpace;for(const W of this._geometries){const G=W.boundingInfo;G&&Object3D_L(G,R,H?W.transformation:this.getCombinedShaderTransformation(W))}(0,be.m)((0,Ge.g)(R.bounds),R.min,R.max,.5);for(const W of this._geometries){const G=W.boundingInfo;if(null==G)continue;const q=H?W.transformation:this.getCombinedShaderTransformation(W),Q=(0,gn.hG)(q);(0,be.e)(Cn,G.center,q);const J=(0,be.q)(Cn,(0,Ge.g)(R.bounds)),X=G.radius*Q;R.bounds[3]=Math.max(R.bounds[3],J+X)}}_invalidateBoundingVolume(){var R;const G=null===(R=this._bvWorldSpace)||void 0===R?void 0:R.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&G&&this._parentLayer.notifyObjectBBChanged(this,G)}_emit(R,G){this._parentLayer&&this._parentLayer.events.emit(R,G)}get test(){const R=this;return{hasGeometry:G=>R._geometries.includes(G),getGeometryIndex:G=>R._geometries.indexOf(G)}}}class Object3D_A{constructor(){this.min=(0,xe.fA)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,xe.fA)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Object3D_M extends Object3D_A{constructor(){super(...arguments),this.bounds=(0,Ge.d)()}}function Object3D_L(R,G,H){const W=R.bbMin,q=R.bbMax;if((0,ye.tZ)(H)){const R=(0,be.s)(bn,H[12],H[13],H[14]);(0,be.g)(xn,W,R),(0,be.g)(Sn,q,R);for(let H=0;H<3;++H)G.min[H]=Math.min(G.min[H],xn[H]),G.max[H]=Math.max(G.max[H],Sn[H])}else if((0,be.e)(xn,W,H),(0,be.j)(W,q))for(let Q=0;Q<3;++Q)G.min[Q]=Math.min(G.min[Q],xn[Q]),G.max[Q]=Math.max(G.max[Q],xn[Q]);else{(0,be.e)(Sn,q,H);for(let R=0;R<3;++R)G.min[R]=Math.min(G.min[R],xn[R],Sn[R]),G.max[R]=Math.max(G.max[R],xn[R],Sn[R]);for(let R=0;R<3;++R){(0,be.c)(xn,W),(0,be.c)(Sn,q),xn[R]=q[R],Sn[R]=W[R],(0,be.e)(xn,xn,H),(0,be.e)(Sn,Sn,H);for(let R=0;R<3;++R)G.min[R]=Math.min(G.min[R],xn[R],Sn[R]),G.max[R]=Math.max(G.max[R],xn[R],Sn[R])}}}const bn=(0,xe.vt)(),xn=(0,xe.vt)(),Sn=(0,xe.vt)(),Cn=(0,xe.vt)();var wn;function pointUtils_c(R,G,H,W,q){const Q=R.clippingExtent;if((0,mn.g)(G,An,R.elevationProvider.spatialReference),null!=Q&&!(0,Le.Uc)(Q,An))return null;(0,mn.g)(G,An,R.renderCoordsHelper.spatialReference),H.localOrigin=R.localOriginFactory.getOrigin(An);const J=new Object3D_O({geometries:[H],castShadow:!1,layerUid:R.layer.uid,graphicUid:q,usesVerticalDistanceToGround:!0});return{object:J,sampledElevation:elevationAlignmentUtils_p(J,G,R.elevationProvider,R.renderCoordsHelper,W)}}function pointUtils_p(R,G,H){const W=R.elevationContext,q=H.spatialReference;(0,mn.g)(G,An,q),W.centerPointInElevationSR=(0,We.T)(An[0],An[1],G.hasZ?An[2]:0,null!=q?q:null)}function pointUtils_m(R){switch(R.type){case"point":return R;case"polygon":case"extent":return graphicUtils_b(R);case"polyline":{const G=R.paths[0];if(!G||0===G.length)return null;const H=(0,rn.$H)(G,(0,rn.Yl)(G)/2);return(0,We.T)(H[0],H[1],H[2],R.spatialReference)}case"mesh":return R.origin}return null}!function(R){R[R.WorldSpace=0]="WorldSpace",R[R.ObjectSpace=1]="ObjectSpace"}(wn||(wn={}));const An=(0,xe.vt)();var Rn=H(40102),Tn=H(73245),En=H(32573),On=H(59192),Pn=H(7919),Mn=H(43834),In=H(47789),Dn=H(83202),Ln=H(24589),Fn=H(21679),Nn=H(57088),Vn=H(32343),Un=H(43474);class LineCalloutTechnique_h extends Ln.w{initializeConfiguration(R,G){G.spherical=R.viewingMode===qe.RT.Global}initializeProgram(R){return new Nn.B(R.rctx,LineCalloutTechnique_h.shader.get().build(this.configuration),Fn.D)}setPipelineState(R){const G=R?Ft.MT.ALWAYS:Ft.MT.LESS;return this.configuration.depthHudEnabled?(0,Un.Ey)({depthTest:{func:G},depthWrite:Un.kn}):(0,Un.Ey)({blending:(0,Un.p3)(Ft.dn.ONE,Ft.dn.SRC_ALPHA,Ft.dn.ONE_MINUS_SRC_ALPHA,Ft.dn.ONE_MINUS_SRC_ALPHA),depthTest:{func:G},colorWrite:Un.wE})}initializePipeline(){return this.setPipelineState(this.configuration.multipassEnabled)}}LineCalloutTechnique_h.shader=new Dn.$(Vn.L,(()=>H.e(8281).then(H.bind(H,18281))));var Gn=H(88335),zn=H(96952);class LineCalloutTechniqueConfiguration_s extends zn.E{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.multipassEnabled=!1}}(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"spherical",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"occlusionTestEnabled",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"hasVerticalOffset",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"hasScreenSizePerspective",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"depthHudEnabled",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"depthHudAlignStartEnabled",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"hasSlicePlane",void 0),(0,W._)([(0,Gn.W)()],LineCalloutTechniqueConfiguration_s.prototype,"multipassEnabled",void 0),(0,W._)([(0,Gn.W)({constValue:!0})],LineCalloutTechniqueConfiguration_s.prototype,"hasSliceInVertexProgram",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],LineCalloutTechniqueConfiguration_s.prototype,"draped",void 0);class LineCalloutMaterial_d extends Pn.im{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(R){super(R,new LineCalloutMaterial_m),this.produces=new Map([[Mn.N.LINE_CALLOUTS,R=>R===En.V.Color],[Mn.N.LINE_CALLOUTS_HUD_DEPTH,R=>R===En.V.Color]]),this._configuration=new LineCalloutTechniqueConfiguration_s,this._uniqueMaterialIdentifier=LineCalloutMaterial_d.uniqueMaterialIdentifier(this.parameters)}passParameters(){return this.parameters}getConfiguration(R,G){const H=(null===G||void 0===G?void 0:G.slot)!==Mn.N.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=null!=this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration.depthHudEnabled=H,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration}intersect(){}createGLMaterial(R){return new LineCalloutMaterial_p(R)}createBufferWriter(){return new LineCalloutMaterial_S}validateParameters(R){const G=LineCalloutMaterial_d.uniqueMaterialIdentifier(R);G!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=G)}static uniqueMaterialIdentifier(R){var G;return JSON.stringify({horizontalScreenOffset:null!==(G=R.horizontalScreenOffset)&&void 0!==G?G:0,centerOffsetUnits:R.centerOffsetUnits||"world"})}}class LineCalloutMaterial_p extends On.A{beginSlot(R){return this.ensureTechnique(LineCalloutTechnique_h,R)}}class LineCalloutMaterial_m extends Pn.qA{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const Bn=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec3f(Wt.r.NORMAL).vec2f(Wt.r.UV0).vec4f(Wt.r.CENTEROFFSETANDDISTANCE),Hn=[(0,Rn.fA)(0,0),(0,Rn.fA)(1,0),(0,Rn.fA)(0,1),(0,Rn.fA)(1,0),(0,Rn.fA)(1,1),(0,Rn.fA)(0,1)];class LineCalloutMaterial_S{constructor(){this.vertexBufferLayout=Bn}elementCount(R){return 6*R.attributes.get(Wt.r.POSITION).indices.length}write(R,G,H,W,q){(0,In.Hk)(H.attributes.get(Wt.r.POSITION),R,W.position,q,6),(0,In.p1)(H.attributes.get(Wt.r.NORMAL),G,W.normal,q,6),(0,In.Ut)(H.attributes.get(Wt.r.CENTEROFFSETANDDISTANCE),W.centerOffsetAndDistance,q,6);for(let Q=0;Q<Hn.length;++Q)W.uv0.setVec(q+Q,Hn[Q])}}class Graphics3DLineCalloutSymbolLayer_E extends Graphics3DSymbolLayer_h{constructor(R,G){super(R,null,G,kn),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new LineCalloutMaterial_d(this._materialParameters),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}_perInstanceMaterialParameters(R){var G;const H=this._materialParameters;return H.horizontalScreenOffset=null!==(G=R.horizontalScreenOffset)&&void 0!==G?G:0,H.centerOffsetUnits=R.centerOffsetUnits||"world",H}get _materialParameters(){var R;const G=new LineCalloutMaterial_m,H=this.symbol,W=H.callout;if(G.color=null!=W.color?oe.A.toUnitRGBA(W.color):[0,0,0,0],G.color[3]*=this._getLayerOpacity(),G.size=(0,kr.Lz)(W.size||0),H.verticalOffset){const{screenLength:R,minWorldLength:W,maxWorldLength:q}=H.verticalOffset;G.verticalOffset={screenLength:(0,kr.Lz)(R),minWorldLength:W||0,maxWorldLength:null!=q?q:1/0}}G.borderColor=null!=(null===(R=W.border)||void 0===R?void 0:R.color)?oe.A.toUnitRGBA(W.border.color):null;const q="object"===H.symbolLayers.at(0).type,Q="label-3d"===H.type;return G.occlusionTest=!q,G.shaderPolygonOffset=q?0:void 0,G.depthHUDAlignStart=Q,G.hasSlicePlane=this._context.slicePlaneEnabled,G.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,G}_defaultElevationInfoNoZ(){return Wn}createGraphics3DGraphic(R){const G=R.renderingInfo,H=R.graphic,W=this.setGraphicElevationContext(H,new ElevationContext_o,G.elevationOffset||0),q=G.symbol,Q="on-the-ground"===this._elevationContext.mode&&("cim"===q.type||!q.symbolLayers.some((R=>"object"===R.type||"text"===R.type)));if("label-3d"!==q.type&&Q)return null;if("point-3d"===q.type&&q.symbolLayers.every((R=>"text"===R.type&&!(0,Wr.Ie)(R))))return null;const J=graphicUtils_b(H.geometry);return null==J?null:this._createAs3DShape(J,W,G,H.uid)}layerOpacityChanged(){var R;null===(R=this._materials[0])||void 0===R||R.setParameters(this._materialParameters)}layerElevationInfoChanged(R,G,H){const W=this._elevationContext.mode,q=elevationAlignmentUtils_m(Graphics3DLineCalloutSymbolLayer_E.elevationModeChangeTypes,H,W);return q!==Ht.UPDATE||R.forEach((R=>{const H=G(R);null!=H&&this.updateGraphicElevationContext(R.graphic,H)})),q}slicePlaneEnabledChanged(){var R;return null!==(R=this._materials[0])&&void 0!==R&&R.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return super.setGraphicElevationContext(R,G),G.addOffsetRenderUnits(H),G}updateGraphicElevationContext(R,G){this.setGraphicElevationContext(R,G.elevationContext,null!=G.metadata?G.metadata.elevationOffset:0),G.needsElevationUpdates=elevationAlignmentUtils_d(G.elevationContext.mode)}computeComplexity(){return new SymbolComplexity_e({verticesPerFeature:6})}_createVertexData(R){const{translation:G,centerOffset:H}=R,W=new tr.n(G?[G[0],G[1],G[2]]:[0,0,0],jn,3,!0),q=new tr.n(H?[H[0],H[1],H[2],H[3]]:[0,0,0,1],jn,4,!0);return[[Wt.r.POSITION,W],[Wt.r.NORMAL,new tr.n([0,0,1],jn,3,!0)],[Wt.r.CENTEROFFSETANDDISTANCE,q]]}_getOrCreateMaterial(R){var G;const H=this._perInstanceMaterialParameters(R),W=LineCalloutMaterial_d.uniqueMaterialIdentifier(H);if(W===(null===(G=this._materials[0])||void 0===G?void 0:G.uniqueMaterialIdentifier))return{material:this._materials[0],isUnique:!1};if(null!=R.materialCollection){let G=R.materialCollection.get(W);return null==G&&(G=new LineCalloutMaterial_d(H),R.materialCollection.add(W,G)),{material:G,isUnique:!1}}return{material:new LineCalloutMaterial_d(H),isUnique:!0}}_createAs3DShape(R,G,H,W){const q=this._context.layer.uid,Q=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:W,layerUid:q}),J=this._getOrCreateMaterial(H),X=new rr.V(J.material,this._createVertexData(H),null,ir.X.Point,Q),$=pointUtils_c(this._context,R,X,G,W);if(null==$)return null;const K=new Graphics3DObject3DGraphicLayer_p(this,$.object,[X],J.isUnique?[J.material]:null,null,ElevationAligners_p,G);return K.metadata=new Graphics3DObjectMetadata_t(H.elevationOffset),K.alignedSampledElevation=$.sampledElevation,K.needsElevationUpdates=elevationAlignmentUtils_d(G.mode),pointUtils_p(K,R,this._context.elevationProvider),K}}Graphics3DLineCalloutSymbolLayer_E.elevationModeChangeTypes={definedChanged:Ht.UPDATE,staysOnTheGround:Ht.UPDATE,onTheGroundChanged:Ht.RECREATE};const jn=[0],Wn={mode:"relative-to-ground",offset:0},kn={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class Graphics3DLineCalloutSymbolLayer_w{constructor(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,xe.vt)(),W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,Ce.vt)(),q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"world",J=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,X=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.renderer=R,this.symbol=G,this.translation=H,this.centerOffset=W,this.horizontalScreenOffset=q,this.centerOffsetUnits=Q,this.elevationOffset=J,this.materialCollection=X}}const Graphics3DCalloutSymbolLayerFactory_t=()=>J.A.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function Graphics3DCalloutSymbolLayerFactory_e(R,G){if(!(0,Wr.YX)(R))return Graphics3DCalloutSymbolLayerFactory_t().error("Graphics3DCalloutSymbolLayerFactory#make","symbol of type '".concat(R.type,"' does not support callouts")),null;if(!R.callout)return null;const H=qn[R.callout.type];return H?new H(R,G):(Graphics3DCalloutSymbolLayerFactory_t().error("Graphics3DCalloutSymbolLayerFactory#make","unknown or unsupported callout type ".concat(R.callout.type)),null)}const qn={line:Graphics3DLineCalloutSymbolLayer_E};var Zn=H(39587),Qn=H(83157),Yn=H(37131),Jn=H(48343),Xn=H(32050);const $n=new Qn.A(Array,(R=>(0,Le.hZ)(R,Le.v_)),null,10,5),Kn=(0,Fe.vt)();class Graphics3DGraphic_A{get labelLayers(){return this._labelLayers||ce.tR}get extent(){return this._extent}get isElevationSource(){return this.layers.some((R=>null===R||void 0===R?void 0:R.isElevationSource))}constructor(R,G,H,W,q){this.graphic=R,this.graphics3DSymbol=G,this.layers=H,this._visibleFlags=Fr.ALL_LABEL,this.deconflictionPriority=0,++G.referenced,this._featureExpressionFeature=q?featureExpressionInfoUtils_s(q,R,W):null}initialize(R){this._layer=R,this._forEachSymbolLayerGraphic((G=>{G.initialize(R),G.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((R=>R.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic((R=>R.destroy())),this._labelLayers=null}addLabelGraphic(R,G){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(R),R.initialize(G),R.setVisibility(this.isVisible(Nr.LABEL))}setCalloutGraphic(R){this._calloutLayer=R,this._layer&&(R.initialize(this._layer),R.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let R=!1;return this._forEachSymbolLayerGraphic((G=>{"draped"===G.type&&(R=!0)})),R}isVisible(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Nr.GRAPHIC,G=arguments.length>1?arguments[1]:void 0;const H=G?this._visibleFlags|G|Nr.LABEL*G:this._visibleFlags;return R===Nr.GRAPHIC?(H&Fr.ALL_GRAPHIC)===Fr.ALL_GRAPHIC:(H&Fr.ALL_LABEL)===Fr.ALL_LABEL}setVisibilityFlag(R,G,H){const W=this.isVisible(R);H?this._visibleFlags|=R*G:this._visibleFlags&=~(R*G);const q=this.isVisible(R);if(W===q)return!1;if(R===Nr.LABEL)this._forEachLabelGraphic((R=>R.setVisibility(q)));else{this._forEachSymbolLayerGraphic((R=>R.setVisibility(q)));const R=this.isVisible(Nr.LABEL);this._forEachLabelGraphic((G=>G.setVisibility(R)))}return!0}getVisibilityFlag(R,G){return 0!=(this._visibleFlags&R*G)}computeExtent(R){if(!this._extent){const G=this.graphic.geometry;if(null==G)return!1;this._extent=(0,Fe.vt)(),(0,Mi.iQ)(G,this._extent);const H=G.spatialReference;if(!(0,Te.aI)(H,R)&&!projectBoundingRect_i(this._extent,H,this._extent,R))return this._extent=null,!1}return!0}getAsOptimizedGeometry(R,G){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,R,G)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(R,G,H){let W=R.geometry;return"mesh"!==W.type&&"extent"!==W.type||(W=Jn.A.fromExtent("mesh"===W.type?W.extent:W)),(0,Xn.Ux)(W,G,H)}get usedMemory(){let R=(0,Zn.eY)(this.graphic.attributes);return this._forEachSymbolLayerGraphic((G=>R+=G.graphics3DSymbolLayer.usedMemory)),R}computeAttachmentOrigin(){const R={render:{origin:(0,xe.vt)(),num:0},draped:{origin:(0,Xi.vt)(),num:0}};for(const G of this.layers)null!=G&&G.computeAttachmentOrigin(R);return R.render.num>1&&(0,be.h)(R.render.origin,R.render.origin,1/R.render.num),R.draped.num>1&&(0,Yn.hs)(R.draped.origin,R.draped.origin,1/R.draped.num),R}async getProjectedBoundingBox(R,G,H,W,q){return q||(q={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),q.boundingBox?(0,Le.Ie)(q.boundingBox):q.boundingBox=(0,Le.Ie)(),q.requiresDrapedElevation=!1,await(0,Rt.jJ)(this.layers,(async Q=>{if(null==Q)return;const J="draped"===Q.type?G:R,X=$n.acquire(),$=await Q.getProjectedBoundingBox(J,H,q.screenSpaceObjects,W,X);isFinite($[2])&&isFinite($[5])||(q.requiresDrapedElevation=!0),$&&(0,Le.RF)(q.boundingBox,X),$n.release(X)})),(0,Le.vQ)(q.boundingBox)||(0,Fe.vQ)((0,Le.ES)(q.boundingBox,Kn))?q:null}needsElevationUpdates(){var R,G;for(const H of this.layers)if(null!=H&&("object3d"===H.type||"lod-instance"===H.type)&&H.needsElevationUpdates)return!0;return null!==(R=null===(G=this._labelLayers)||void 0===G?void 0:G.some((R=>{var G;return null!==(G=null===R||void 0===R?void 0:R.needsElevationUpdates)&&void 0!==G&&G})))&&void 0!==R&&R}alignWithElevation(R,G,H){this._forEachRenderedGraphic((W=>{"object3d"!==W.type&&"lod-instance"!==W.type||W.alignWithElevation(R,G,this._featureExpressionFeature,H)}))}alignWithAbsoluteElevation(R,G,H){this._forEachRenderedGraphic((W=>{"object3d"===W.type&&W.alignWithAbsoluteElevation(R,G,H)}))}addObjectStateSet(R,G){this._forEachSymbolLayerGraphic((H=>H.addObjectState(R,G)))}removeObjectState(R){this._forEachSymbolLayerGraphic((G=>G.removeObjectState(R)))}_forEachGraphicList(R,G){null===R||void 0===R||R.forEach((R=>R&&G(R)))}_forEachSymbolLayerGraphic(R){this._forEachGraphicList(this.layers,R),this._calloutLayer&&R(this._calloutLayer)}_forEachLabelGraphic(R){this._forEachGraphicList(this._labelLayers,R)}_forEachRenderedGraphic(R){this._forEachSymbolLayerGraphic(R),this._forEachLabelGraphic(R)}get test(){const R=this;return{addLabelLayer:G=>{R._labelLayers||(R._labelLayers=new Array),R._labelLayers.push(G)}}}}var _s=H(42687),xs=H(98504),Ss=H(32051);function renderingInfoUtils_o(R,G){if(!R||R.symbol)return null;const H=null===G||void 0===G?void 0:G.renderer;return R&&null!=H&&H.getObservationRenderer?H.getObservationRenderer(R):H}function renderingInfoUtils_i(R,G){var H;const W=renderingInfoUtils_o(R,G),q=function renderingInfoUtils_r(R,G){if(null!=R.symbol)return R.symbol;const H=renderingInfoUtils_o(R,G);return null!=H&&"dot-density"!==H.type?H.getSymbol(R,G):null}(R,G);if(null==q)return null;const Q={renderer:W,symbol:q};if(null==W||!("visualVariables"in W)||!W.visualVariables)return Q;const J=null!==(H=(0,Si.getVisualVariableValues)(W,R,G))&&void 0!==H?H:[],X=["proportional","proportional","proportional"];for(const{variable:$,value:K}of J)switch($.type){case"color":Q.color=K.toRgba();break;case"size":if("outline"===$.target)Q.outlineSize=K;else{const R=$.axis,G=$.useSymbolValue?"symbol-value":K;switch(R){case"width":X[0]=G;break;case"depth":X[1]=G;break;case"height":X[2]=G;break;case"width-and-depth":X[0]=X[1]=G;break;default:X[0]=X[1]=X[2]=G}}break;case"opacity":Q.opacity=K;break;case"rotation":switch($.axis){case"tilt":Q.tilt=K;break;case"roll":Q.roll=K;break;default:Q.heading=K}}return"proportional"===X[0]&&"proportional"===X[1]&&"proportional"===X[2]||(Q.size=X),Q}async function renderingInfoUtils_l(R,G){var H;const W=renderingInfoUtils_o(R,G),q=await async function renderingInfoUtils_n(R,G){if(null!=R.symbol)return R.symbol;const H=renderingInfoUtils_o(R,G);return null!=H?H.getSymbolAsync(R,G):null}(R,G);if(!q)return null;const Q={renderer:W,symbol:q};if(!W||!("visualVariables"in W)||!W.visualVariables)return Q;const J=null!==(H=(0,Si.getVisualVariableValues)(W,R,G))&&void 0!==H?H:[],X=["proportional","proportional","proportional"];for(const{variable:$,value:K}of J)if("color"===$.type)Q.color=oe.A.toUnitRGBA(K);else if("size"===$.type)if("outline"===$.target)Q.outlineSize=K;else{const R=$.axis,G=$.useSymbolValue?"symbol-value":K;"width"===R?X[0]=G:"depth"===R?X[1]=G:"height"===R?X[2]=G:X[0]=X[1]="width-and-depth"===R?G:X[2]=G}else"opacity"===$.type?Q.opacity=K:"rotation"===$.type&&"tilt"===$.axis?Q.tilt=K:"rotation"===$.type&&"roll"===$.axis?Q.roll=K:"rotation"===$.type&&(Q.heading=K);return(isFinite(X[0])||isFinite(X[1])||isFinite(X[2]))&&(Q.size=X),Q}var Cs,ws,As,Rs=H(79081),Ts=H(47233),Es=H(43713);!function(R){R[R.RasterImage=0]="RasterImage",R[R.Features=1]="Features"}(Cs||(Cs={})),function(R){R[R.MapLayer=0]="MapLayer",R[R.ViewLayer=1]="ViewLayer",R[R.Outline=2]="Outline",R[R.SnappingHint=3]="SnappingHint"}(ws||(ws={})),function(R){R[R.WithRasterImage=0]="WithRasterImage",R[R.WithoutRasterImage=1]="WithoutRasterImage"}(As||(As={}));var Os,Ms=H(37355);class LocalOriginFactory_s{constructor(R,G){this.vec3=R,this.id=G}}function LocalOriginFactory_t(R,G,H,W){return new LocalOriginFactory_s((0,xe.fA)(R,G,H),W)}class Overlay_n{constructor(){this._extent=(0,Fe.vt)(),this.resolution=0,this.renderLocalOrigin=LocalOriginFactory_t(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Overlay_r}get extent(){return this._extent}setupGeometryViewsCyclical(R){this.setupGeometryViewsDirect();const G=.001*R.range;if(this._extent[0]-G<=R.min){const G=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,Fe.cY)(this._extent,R.range,0,G)}if(this._extent[2]+G>=R.max){const G=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,Fe.cY)(this._extent,-R.range,0,G)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,Fe.C)(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let R=0;R<this.canvasGeometries.numViews;R++){const G=this.canvasGeometries.extents[R];if(G[0]!==G[2]&&G[1]!==G[3])return!0}return!1}}class Overlay_r{constructor(){this.extents=[(0,Fe.vt)(),(0,Fe.vt)(),(0,Fe.vt)()],this.numViews=0}}!function(R){R[R.Color=0]="Color",R[R.ColorNoRasterImage=1]="ColorNoRasterImage",R[R.Highlight=2]="Highlight",R[R.WaterNormal=3]="WaterNormal",R[R.Occluded=4]="Occluded",R[R.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(Os||(Os={}));class OverlayFramebufferObject_t{constructor(R,G,H){this._fbos=R,this._format=G,this._name=H}get valid(){var R;return null!=(null===(R=this._handle)||void 0===R?void 0:R.getTexture())}dispose(){this._handle=(0,Qe.Gz)(this._handle)}get texture(){var R;return null===(R=this._handle)||void 0===R?void 0:R.getTexture()}bind(R,G,H){var W,q,Q;this._handle&&this._handle.fbo.width===G&&this._handle.fbo.height===H||(null!==(W=this._handle)&&void 0!==W&&W.release(),this._handle=this._fbos.acquire(G,H,this._name,this._format)),R.unbindTexture(null===(q=this._handle)||void 0===q?void 0:q.fbo.colorTexture),R.bindFramebuffer(null===(Q=this._handle)||void 0===Q?void 0:Q.fbo)}generateMipMap(){var R,G;(null===(R=this._handle)||void 0===R||null===(R=R.getTexture())||void 0===R||null===(R=R.descriptor)||void 0===R?void 0:R.hasMipmap)&&(null===(G=this._handle)||void 0===G||null===(G=G.getTexture())||void 0===G||G.generateMipmap())}}var Ds=H(17887);class OverlayRenderTargets_a{constructor(R,G,H,W){let q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ds.N.RGBA_MIPMAP;this.output=H,this.content=W,this.fbo=new OverlayFramebufferObject_t(R,q,G)}get valid(){return this.fbo.valid}}class OverlayRenderTargets_s{constructor(R){this.targets=[new OverlayRenderTargets_a(R,"overlay color",En.V.Color,Os.Color),new OverlayRenderTargets_a(R,"overlay IM color",En.V.Color,Os.ColorNoRasterImage),new OverlayRenderTargets_a(R,"overlay highlight",En.V.Highlight,Os.Highlight,Ds.N.RGBA4),new OverlayRenderTargets_a(R,"overlay water",En.V.Normal,Os.WaterNormal),new OverlayRenderTargets_a(R,"overlay occluded",En.V.Color,Os.Occluded)],(0,te.A)("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new OverlayRenderTargets_a(R,"overlay oid",En.V.ObjectAndLayerIdColor,Os.ObjectAndLayerIdColor))}getTexture(R){var G;return null===(G=this.targets[R])||void 0===G?void 0:G.fbo.texture}dispose(){for(const R of this.targets)R.fbo.dispose()}computeValidity(){return this.targets.reduce(((R,G,H)=>G.valid?R|=1<<H:R),0)}}var Ls,Fs=H(54898);Fs.Zo;!function(R){R[R.Material=0]="Material",R[R.ShadowMap=1]="ShadowMap",R[R.Highlight=2]="Highlight"}(Ls||(Ls={}));H(21181);var Ns=H(60183),Vs=(H(7536),H(91839));H(45981);Vs.n;H(3878);var Us,Gs=H(96767);H(34343);!function(R){R[R.Disabled=0]="Disabled",R[R.Enabled=1]="Enabled",R[R.EnabledWithWater=2]="EnabledWithWater",R[R.COUNT=3]="COUNT"}(Us||(Us={}));Vs.n;(0,Ce.vt)();var zs=H(88006),Bs=H(88813);class ShaderTechniqueRepository_r{constructor(R){this._context=R,this._perConstructorInstances=new Bs.O,this._frameCounter=0,this._keepAliveFrameCount=Hs}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((R=>R.forEach((R=>R.technique.destroy())))),this._perConstructorInstances.clear()}acquire(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ws;const H=G.key;let W=this._perConstructorInstances.get(R,H);if(null==W){const q=new R(this._context,G,(()=>this.release(q)));W=new ShaderTechniqueRepository_s(q),this._perConstructorInstances.set(R,H,W)}return++W.refCount,W.technique}releaseAndAcquire(R,G,H){if(null!=H){if(G.key===H.key)return H;this.release(H)}return this.acquire(R,G)}release(R){if(null==R||this._perConstructorInstances.empty)return;const G=this._perConstructorInstances.get(R.constructor,R.key);null!=G&&(--G.refCount,0===G.refCount&&(G.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Hs&&this._perConstructorInstances.forEach(((R,G)=>{R.forEach(((R,H)=>{0===R.refCount&&R.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(R.technique.destroy(),this._perConstructorInstances.delete(G,H))}))}))}async reloadAll(){const R=new Array;this._perConstructorInstances.forEach(((G,H)=>{R.push((async(R,G)=>{const H=G.shader;H&&(await H.reload(),R.forEach((R=>R.technique.reload(this._context))))})(G,H))})),await Promise.all(R)}}class ShaderTechniqueRepository_s{constructor(R){this.technique=R,this.refCount=0,this.refZeroFrame=0}}const Hs=-1,Ws=new Gn.K;var ks,qs=H(2930),Zs=H(40006);let Qs=ks=class extends Q.A{constructor(R){super(R),this._ray=(0,er.vt)(),this._viewport=(0,Ce.fA)(0,0,1,1),this._padding=(0,Ce.fA)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,Xi.fA)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,ve.vt)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,ve.vt)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,ve.vt)(),this._frustumDirty=!0,this._frustum=(0,zt.vt)(),this._fullViewport=(0,Ce.vt)(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=(0,xe.vt)(),this._up=(0,xe.vt)(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(R){this._pixelRatio=R>0?R:1}get rows(){return this._rows}set rows(R){this._rows=Math.max(1,R)}get columns(){return this._columns}set columns(R){this._columns=Math.max(1,R)}get eye(){return this._ray.origin}set eye(R){this._compareAndSetView(R,this._ray.origin)}get center(){return this._center}set center(R){this._compareAndSetView(R,this._center,"_center")}get ray(){return(0,be.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(R){this._compareAndSetView(R,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(R){(0,ye.C)(this._viewMatrix,R),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),(0,be.s)((0,xe.vt)(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),(0,be.s)((0,xe.vt)(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),(0,be.s)((0,xe.vt)(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(R){this._nearFar[0]!==R&&(this._nearFar[0]=R,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(R){this._nearFar[1]!==R&&(this._nearFar[1]=R,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(R){this.x=R[0],this.y=R[1],this.width=R[2],this.height=R[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const R=(0,Se.d)((0,Ce.vt)(),this._viewport,1/this.pixelRatio),G=this._get("screenViewport");return G&&(0,Se.e)(R,G)?G:R}get screenPadding(){if(1===this.pixelRatio)return this._padding;const R=(0,Se.d)((0,Ce.vt)(),this._padding,1/this.pixelRatio),G=this._get("screenPadding");return G&&(0,Se.e)(R,G)?G:R}get x(){return this._viewport[0]}set x(R){R+=this._padding[ea.LEFT],this._viewport[0]!==R&&(this._viewport[0]=R,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(R){R+=this._padding[ea.BOTTOM],this._viewport[1]!==R&&(this._viewport[1]=R,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(R){this._viewport[2]!==R&&(this._viewport[2]=R,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(R){this._viewport[3]!==R&&(this._viewport[3]=R,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[ea.RIGHT]+this._padding[ea.LEFT]}set fullWidth(R){this.width=R-(this._padding[ea.RIGHT]+this._padding[ea.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[ea.TOP]+this._padding[ea.BOTTOM]}set fullHeight(R){this.height=R-(this._padding[ea.TOP]+this._padding[ea.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[ea.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[ea.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(R){(0,Se.a)(this._padding,R)||(this._viewport[0]+=R[ea.LEFT]-this._padding[ea.LEFT],this._viewport[1]+=R[ea.BOTTOM]-this._padding[ea.BOTTOM],this._viewport[2]-=R[ea.RIGHT]+R[ea.LEFT]-(this._padding[ea.RIGHT]+this._padding[ea.LEFT]),this._viewport[3]-=R[ea.TOP]+R[ea.BOTTOM]-(this._padding[ea.TOP]+this._padding[ea.BOTTOM]),(0,Se.c)(this._padding,R),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,ye.lw)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const R=this.width,G=this.height,H=this.near*Math.tan(this.fovY/2)*2,W=H*this._aspect,q=H/this.rows,Q=W/this.columns,J=-W/2+this.column*Q,X=J+Q,$=-H/2+this.row*q,K=$+q,ee=(0,ye.$h)((0,ve.vt)(),J*(1+2*this._padding[ea.LEFT]/R),X*(1+2*this._padding[ea.RIGHT]/R),$*(1+2*this._padding[ea.BOTTOM]/G),K*(1+2*this._padding[ea.TOP]/G),this.near,this.far),te=this._get("projectionMatrix");return te&&(0,ye.aI)(te,ee)?te:ee}get inverseProjectionMatrix(){return(0,ye.B8)((0,ve.vt)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,ve.vt)()}get fov(){return this._fov}set fov(R){this._fov=R,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return function fov_n(R,G,H){return 2*Math.atan(G*Math.tan(.5*R)/Math.sqrt(G*G+H*H))}(this._fov,this.width,this.height)}set fovX(R){this._fov=function fov_t(R,G,H){return 2*Math.atan(Math.sqrt(G*G+H*H)*Math.tan(.5*R)/G)}(R,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return function fov_r(R,G,H){return 2*Math.atan(H*Math.tan(.5*R)/Math.sqrt(G*G+H*H))}(this._fov,this.width,this.height)}set fovY(R){this._fov=function fov_a(R,G,H){return 2*Math.atan(Math.sqrt(G*G+H*H)*Math.tan(.5*R)/H)}(R,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,be.q)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,ye.B8)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,ye.mg)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(R){const G=2*R-1;return 2*this.near*this.far/(this.far+this.near-G*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}copyFrom(R){(0,be.c)(this._ray.origin,R.eye),this.center=R.center,this.up=R.up,(0,Se.c)(this._viewport,R.viewport),this.notifyChange("_viewport"),(0,Se.c)(this._padding,R.padding),this.notifyChange("_padding"),(0,Yn.C)(this._nearFar,R.nearFar),this.notifyChange("_nearFar"),this._fov=R.fov,this.row=R.row,this.column=R.column,this.rows=R.rows,this.columns=R.columns,this.relativeElevation=R.relativeElevation;const G=R;return this._viewDirty=G._viewDirty,this._viewDirty||((0,ye.C)(this._viewMatrix,R.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=G._frustumDirty,this._frustumDirty||((0,zt.C)(this._frustum,R.frustum),this._frustumDirty=!1),G._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,ye.C)(this._viewInverseTransposeMatrix,R.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,Se.c)(this._fullViewport,R.fullViewport),this.pixelRatio=R.pixelRatio,this}copyViewFrom(R){this.eye=R.eye,this.center=R.center,this.up=R.up}clone(){return(new ks).copyFrom(this)}equals(R){return(0,be.j)(this.eye,R.eye)&&(0,be.j)(this.center,R.center)&&(0,be.j)(this.up,R.up)&&(0,Se.a)(this._viewport,R.viewport)&&(0,Se.a)(this._padding,R.padding)&&(0,Yn.t2)(this.nearFar,R.nearFar)&&this._fov===R.fov&&this.pixelRatio===R.pixelRatio&&this.relativeElevation===R.relativeElevation&&this.row===R.row&&this.column===R.column&&this.rows===R.rows&&this.columns===R.columns}almostEquals(R){const G=Math.max(1,1/this.pixelRatio,1/R.pixelRatio);if(Math.abs(R.fov-this._fov)>=.001||(0,Se.f)(R.screenPadding,this.screenPadding)>=G||(0,Se.f)(this.screenViewport,R.screenViewport)>=G||this.row!==R.row||this.column!==R.column||this.rows!==R.rows||this.columns!==R.columns)return!1;(0,be.z)(Xs,R.eye,R.center),(0,be.z)($s,this.eye,this.center);const H=(0,be.k)(Xs,$s),W=(0,be.x)(Xs),q=(0,be.x)($s),Q=5e-4;return H*H>=(1-1e-10)*W*q&&(0,be.w)(R.eye,this.eye)<Math.max(W,q)*Q*Q}computeRenderPixelSizeAt(R){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(R))}computeRenderPixelSizeAtDist(R){return R*this.perRenderPixelRatio}computeScreenPixelSizeAt(R){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(R))}_viewDirectionDistance(R){return Math.abs((0,Zs.gr)(this.viewForward,(0,be.f)(Xs,R,this.eye)))}computeScreenPixelSizeAtDist(R){return R*this.perScreenPixelRatio}computeDistanceFromRadius(R,G){return R/Math.tan(Math.min(this.fovX,this.fovY)/(2*(G||1)))}getScreenCenter(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,kr.gs)();return R[0]=(this.padding[ea.LEFT]+this.width/2)/this.pixelRatio,R[1]=(this.padding[ea.TOP]+this.height/2)/this.pixelRatio,R}getRenderCenter(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return R[0]=this.padding[ea.LEFT]+this.width*G,R[1]=this.padding[ea.BOTTOM]+this.height*H,R[2]=.5,R}setGLViewport(R){const G=this.viewport,H=this.padding;R.setViewport(G[0]-H[3],G[1]-H[2],G[2]+H[1]+H[3],G[3]+H[0]+H[2])}applyProjection(R,G){R!==Ys&&(0,be.c)(Ys,R),Ys[3]=1,(0,Se.t)(Ys,Ys,this.projectionMatrix);const H=Math.abs(Ys[3]);(0,be.h)(Ys,Ys,1/H);const W=this.fullViewport;G[0]=(0,Ee.Cc)(0,W[0]+W[2],.5+.5*Ys[0]),G[1]=(0,Ee.Cc)(0,W[1]+W[3],.5+.5*Ys[1]),G[2]=.5*(Ys[2]+1),G[3]=H}unapplyProjection(R,G){const H=this.fullViewport;Ys[0]=(R[0]/(H[0]+H[2])*2-1)*R[3],Ys[1]=(R[1]/(H[1]+H[3])*2-1)*R[3],Ys[2]=(2*R[2]-1)*R[3],Ys[3]=R[3],null!=this.inverseProjectionMatrix&&((0,Se.t)(Ys,Ys,this.inverseProjectionMatrix),G[0]=Ys[0],G[1]=Ys[1],G[2]=Ys[2])}projectToScreen(R,G){return this.projectToRenderScreen(R,Ks),this.renderToScreen(Ks,G),G}projectToRenderScreen(R,G){if(Ys[0]=R[0],Ys[1]=R[1],Ys[2]=R[2],Ys[3]=1,(0,Se.t)(Ys,Ys,this.viewProjectionMatrix),0===Ys[3])return null;const H=Ys;(0,be.h)(H,H,1/Math.abs(Ys[3]));const W=this.fullViewport,q=(0,Ee.Cc)(0,W[0]+W[2],.5+.5*H[0]),Q=(0,Ee.Cc)(0,W[1]+W[3],.5+.5*H[1]);return"x"in G?(G.x=q,G.y=Q):(G[0]=q,G[1]=Q,G.length>2&&(G[2]=.5*(H[2]+1))),G}unprojectFromScreen(R,G){return this.unprojectFromRenderScreen(this.screenToRender(R,Ks),G)}unprojectFromRenderScreen(R,G){if((0,ye.lw)(Js,this.projectionMatrix,this.viewMatrix),!(0,ye.B8)(Js,Js))return null;const H=this.fullViewport;return Ys[0]=2*(R[0]-H[0])/H[2]-1,Ys[1]=2*(R[1]-H[1])/H[3]-1,Ys[2]=2*R[2]-1,Ys[3]=1,(0,Se.t)(Ys,Ys,Js),0===Ys[3]?null:(G[0]=Ys[0]/Ys[3],G[1]=Ys[1]/Ys[3],G[2]=Ys[2]/Ys[3],G)}constrainWindowSize(R,G,H,W){const q=R*this.pixelRatio,Q=G*this.pixelRatio,J=Math.max(q-H/2,0),X=Math.max(this.fullHeight-Q-W/2,0),$=-Math.min(q-H/2,0),K=-Math.min(this.fullHeight-Q-W/2,0),ee=H-$- -Math.min(this.fullWidth-q-H/2,0),te=W-K- -Math.min(Q-W/2,0);return[Math.round(J),Math.round(X),Math.round(ee),Math.round(te)]}computeUp(R){R===qe.RT.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(R,G){const H=R[0]*this.pixelRatio,W=this.fullHeight-R[1]*this.pixelRatio;return G[0]=H,G[1]=W,G}renderToScreen(R,G){const H=R[0]/this.pixelRatio,W=(this.fullHeight-R[1])/this.pixelRatio;G[0]=H,G[1]=W}_computeUpGlobal(){(0,be.f)(Xs,this.center,this.eye);const R=(0,be.l)(this.center);R<1?((0,be.s)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,be.k)(Xs,this.center))>.9999*(0,be.l)(Xs)*R||((0,be.b)(this._up,Xs,this.center),(0,be.b)(this._up,this._up,Xs),(0,be.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,be.E)(Xs,this.eye,this.center),Math.abs(Xs[2])<=.9999&&((0,be.h)(Xs,Xs,Xs[2]),(0,be.s)(this._up,-Xs[0],-Xs[1],1-Xs[2]),(0,be.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";"number"==typeof R[0]&&isFinite(R[0])&&"number"==typeof R[1]&&isFinite(R[1])&&"number"==typeof R[2]&&isFinite(R[2])?(0,be.j)(R,G)||((0,be.c)(G,R),this._markViewDirty(),H.length&&this.notifyChange(H)):J.A.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,zt.ui)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,ye.t5)(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,W._)([(0,ee.MZ)()],Qs.prototype,"_viewport",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_padding",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_fov",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_nearFar",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_viewDirty",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_viewMatrix",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_pixelRatio",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"pixelRatio",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"row",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"column",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_rows",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"rows",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_columns",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"columns",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"eye",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"center",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_center",void 0),(0,W._)([(0,ee.MZ)()],Qs.prototype,"up",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"_up",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"viewForward",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"viewUp",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"viewRight",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"nearFar",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"near",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"far",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"viewport",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"screenViewport",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"screenPadding",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"x",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"y",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"width",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"height",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"fullWidth",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"fullHeight",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"_aspect",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"padding",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"projectionMatrix",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Qs.prototype,"inverseProjectionMatrix",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"fov",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"fovX",null),(0,W._)([(0,ee.MZ)()],Qs.prototype,"fovY",null),Qs=ks=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.lib.Camera")],Qs);const Ys=(0,Ce.vt)(),Js=(0,ve.vt)(),Xs=(0,xe.vt)(),$s=(0,xe.vt)(),Ks=(0,kr.r_)();var ea;!function(R){R[R.TOP=0]="TOP",R[R.RIGHT=1]="RIGHT",R[R.BOTTOM=2]="BOTTOM",R[R.LEFT=3]="LEFT"}(ea||(ea={}));class GLMaterialRepository_s{constructor(R,G,H,W){this._textureRepository=R,this._techniqueRepository=G,this.materialChanged=H,this.requestRender=W,this._id2glMaterialRef=new Bs.O}dispose(){this._textureRepository.destroy()}acquire(R,G,H){this._ownMaterial(R);const W=R.produces.get(G);if(!W||!W(H))return null;let q=this._id2glMaterialRef.get(H,R.id);if(null==q){const G=R.createGLMaterial({material:R,techniqueRep:this._techniqueRepository,textureRepository:this._textureRepository,output:H});q=new GLMaterialRepository_o(G),this._id2glMaterialRef.set(H,R.id,q)}return q.ref(),q.glMaterial}release(R,G){const H=this._id2glMaterialRef.get(G,R.id);null!=H&&(H.unref(),H.referenced||((0,Qe.WD)(H.glMaterial),this._id2glMaterialRef.delete(G,R.id)))}_ownMaterial(R){R.repository&&R.repository!==this&&J.A.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),R.repository=this}}class GLMaterialRepository_o{constructor(R){this.glMaterial=R,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,(0,nr.vA)(this._refCnt>=0)}get referenced(){return this._refCnt>0}}const ta=!1,ia=null;var ra=H(30073);const na=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var sa,aa=H(23008);!function(R){R[R.ASYNC=0]="ASYNC",R[R.SYNC=1]="SYNC"}(sa||(sa={}));class WebGLLayer_a extends fn.J{get objects(){return this._objects}constructor(R,G){var H,W,q,Q;let J=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";super(),this.stage=R,this.apiLayerUid=J,this.type=ir.X.Layer,this.events=new Vr.A,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new pe.A,this._objectsAdded=new pe.A,this._handles=new ra.A,this.apiLayerUid=J,this.visible=null===(H=null===G||void 0===G?void 0:G.visible)||void 0===H||H,this.pickable=null===(W=null===G||void 0===G?void 0:G.pickable)||void 0===W||W,this.updatePolicy=null!==(q=null===G||void 0===G?void 0:G.updatePolicy)&&void 0!==q?q:sa.ASYNC,this._disableOctree=null!==(Q=null===G||void 0===G?void 0:G.disableOctree)&&void 0!==Q&&Q,R.add(this);for(const X of na)this._handles.add(this.events.on(X,(G=>R.handleEvent(X,G))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(R){this._objects.push(R),R.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:R}),null!=this._octree&&this._objectsAdded.push(R)}remove(R){this._objects.removeUnordered(R)&&(R.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:R}),null!=this._octree&&(this._objectsAdded.removeUnordered(R)||this._octree.remove([R])))}addMany(R){this._objects.pushArray(R);for(const G of R)G.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:R}),null!=this._octree&&this._objectsAdded.pushArray(R)}removeMany(R){const G=new Array;if(this._objects.removeUnorderedMany(R,R.length,G),0!==G.length){for(const R of G)R.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:G}),null!=this._octree){for(let R=0;R<G.length;)this._objectsAdded.removeUnordered(G[R])?(G[R]=G[G.length-1],G.length-=1):++R;this._octree.remove(G)}}}sync(){this.updatePolicy!==sa.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(R,G){null==this._octree||this._objectsAdded.includes(R)||this._octree.update(R,G)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.length>50&&!this._disableOctree?(this._octree=new aa.A((R=>R.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=(0,Qe.pR)(this._octree),this._objectsAdded.clear()}}var oa=H(11870),la=H(44828),ca=H(5157),da=H(60727),ha=H(55082),ua=H(15547),pa=H(62301);const _a=new Map([[Wt.r.POSITION,0],[Wt.r.PREVPOSITION,1],[Wt.r.NEXTPOSITION,2],[Wt.r.SUBDIVISIONFACTOR,3],[Wt.r.UV0,4],[Wt.r.COLOR,5],[Wt.r.COLORFEATUREATTRIBUTE,5],[Wt.r.SIZE,6],[Wt.r.SIZEFEATUREATTRIBUTE,6],[Wt.r.OPACITYFEATUREATTRIBUTE,7],[Wt.r.OBJECTANDLAYERIDCOLOR,8]]);class RibbonLineTechnique_W extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,RibbonLineTechnique_W.shader.get().build(this.configuration),_a)}_makePipelineState(R,G){const H=this.configuration,W=R===pa.y.NONE,q=R===pa.y.FrontFace,Q=(0,En.cb)(H.output);return(0,Un.Ey)({blending:H.output===En.V.Color||H.output===En.V.Alpha?W?ha.V0:(0,ha.ez)(R):null,depthTest:{func:(0,ha.K_)(R)},depthWrite:W?H.writeDepth||Q?Un.kn:null:(0,ha.XO)(R),colorWrite:Un.wE,stencilWrite:H.hasOccludees?ua.v0:null,stencilTest:H.hasOccludees?G?ua.a9:ua.qh:null,polygonOffset:W||q?H.hasPolygonOffset?ma:null:ha.SE})}initializePipeline(){const R=this.configuration;if(R.occluder){const G=R.hasPolygonOffset?ma:null;this._occluderPipelineTransparent=(0,Un.Ey)({blending:ha.V0,polygonOffset:G,depthTest:ua.sf,depthWrite:null,colorWrite:Un.wE,stencilWrite:null,stencilTest:ua.mK}),this._occluderPipelineOpaque=(0,Un.Ey)({blending:ha.V0,polygonOffset:G,depthTest:ua.sf,depthWrite:null,colorWrite:Un.wE,stencilWrite:ua.r8,stencilTest:ua.I$}),this._occluderPipelineMaskWrite=(0,Un.Ey)({blending:null,polygonOffset:G,depthTest:ua.m,depthWrite:null,colorWrite:null,stencilWrite:ua.v0,stencilTest:ua.a9})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Ft.WR.LINES:Ft.WR.TRIANGLE_STRIP}getPipeline(R,G,H){return R?this._occludeePipelineState:this.configuration.occluder?H?this._occluderPipelineTransparent:G?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}RibbonLineTechnique_W.shader=new Dn.$(da.R,(()=>H.e(9409).then(H.bind(H,59409))));const ma={factor:0,units:-4};var ga,fa=H(82363);!function(R){R[R.LEFT_JOIN_START=-2]="LEFT_JOIN_START",R[R.LEFT_JOIN_END=-1]="LEFT_JOIN_END",R[R.LEFT_CAP_START=-4]="LEFT_CAP_START",R[R.LEFT_CAP_END=-5]="LEFT_CAP_END",R[R.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",R[R.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",R[R.RIGHT_CAP_START=4]="RIGHT_CAP_START",R[R.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(ga||(ga={}));class RibbonLineMaterial_H extends Pn.im{constructor(R){super(R,new RibbonLineMaterial_k),this._configuration=new fa.Q,this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>R===En.V.Highlight||R===En.V.ObjectAndLayerIdColor||(R===En.V.Color||R===En.V.Alpha)&&this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil],[Mn.N.OPAQUE_NO_SSAO_DEPTH,R=>R===En.V.LinearDepth],[Mn.N.OCCLUDER_MATERIAL,R=>(0,En.Mo)(R)&&this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil],[Mn.N.TRANSPARENT_OCCLUDER_MATERIAL,R=>(0,En.Mo)(R)&&this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil],[Mn.N.TRANSPARENT_MATERIAL,R=>(R===En.V.Color||R===En.V.Alpha)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==Pn.m$.OccludeAndTransparentStencil],[Mn.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,R=>(R===En.V.Color||R===En.V.Alpha)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==Pn.m$.OccludeAndTransparentStencil],[Mn.N.DRAPED_MATERIAL,R=>(0,En.i3)(R)]]),this._vertexAttributeLocations=_a}getConfiguration(R,G){this._configuration.output=R,this._configuration.draped=G.slot===Mn.N.DRAPED_MATERIAL;const H=null!=this.parameters.stipplePattern&&R!==En.V.Highlight;return this._configuration.stippleEnabled=H,this._configuration.stippleOffColorEnabled=H&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=H&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&function RibbonLineMaterial_Y(R){return R.anchor===ca.kJ.Tip&&R.hideOnShortSegments&&"begin-end"===R.placement&&R.worldSpace}(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=G.transparencyPassType,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration.cullAboveGround=G.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(R,G,H,W,q,Q){if(!H.options.selectionMode)return;const J=R.attributes.get(Wt.r.POSITION).data,X=R.attributes.get(Wt.r.SIZE);let $=this.parameters.width;if(this.parameters.vvSize){const G=R.attributes.get(Wt.r.SIZEFEATUREATTRIBUTE).data[0];$*=(0,Ee.qE)(this.parameters.vvSize.offset[0]+G*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else X&&($*=X.data[0]);const K=W[0],ee=W[1],te=($/2+4)*R.screenToWorldRatio;let ie=Number.MAX_VALUE,re=0;for(let ne=0;ne<J.length-5;ne+=3){const R=J[ne],G=J[ne+1],H=K-R,W=ee-G,q=J[ne+3]-R,Q=J[ne+4]-G,X=(0,Ee.qE)((q*H+Q*W)/(q*q+Q*Q),0,1),$=q*X-H,te=Q*X-W,se=$*$+te*te;se<ie&&(ie=se,re=ne/3)}ie<te*te&&q(Q.dist,Q.normal,re,!1)}intersect(R,G,H,W,q,Q){if(!H.options.selectionMode||!R.visible)return;if(!(0,nr.zH)(G))return void J.A.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const X=R.attributes,$=X.get(Wt.r.POSITION).data;let K=this.parameters.width;if(this.parameters.vvSize){const R=X.get(Wt.r.SIZEFEATUREATTRIBUTE).data[0];K*=(0,Ee.qE)(this.parameters.vvSize.offset[0]+R*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else X.has(Wt.r.SIZE)&&(K*=X.get(Wt.r.SIZE).data[0]);const ee=H.camera,te=Sa;(0,Yn.C)(te,H.point);const ie=K*ee.pixelRatio/2+4*ee.pixelRatio;(0,be.s)(Ia[0],te[0]-ie,te[1]+ie,0),(0,be.s)(Ia[1],te[0]+ie,te[1]+ie,0),(0,be.s)(Ia[2],te[0]+ie,te[1]-ie,0),(0,be.s)(Ia[3],te[0]-ie,te[1]-ie,0);for(let J=0;J<4;J++)if(!ee.unprojectFromRenderScreen(Ia[J],Da[J]))return;(0,Ki.Cr)(ee.eye,Da[0],Da[1],La),(0,Ki.Cr)(ee.eye,Da[1],Da[2],Fa),(0,Ki.Cr)(ee.eye,Da[2],Da[3],Na),(0,Ki.Cr)(ee.eye,Da[3],Da[0],Va);let re=Number.MAX_VALUE,ne=0;const se=RibbonLineMaterial_W(this.parameters,X)?$.length-2:$.length-5;for(let J=0;J<se;J+=3){ya[0]=$[J]+G[12],ya[1]=$[J+1]+G[13],ya[2]=$[J+2]+G[14];const R=(J+3)%$.length;if(va[0]=$[R]+G[12],va[1]=$[R+1]+G[13],va[2]=$[R+2]+G[14],(0,Ki.mN)(La,ya)<0&&(0,Ki.mN)(La,va)<0||(0,Ki.mN)(Fa,ya)<0&&(0,Ki.mN)(Fa,va)<0||(0,Ki.mN)(Na,ya)<0&&(0,Ki.mN)(Na,va)<0||(0,Ki.mN)(Va,ya)<0&&(0,Ki.mN)(Va,va)<0)continue;if(ee.projectToRenderScreen(ya,Ca),ee.projectToRenderScreen(va,wa),Ca[2]<0&&wa[2]>0){(0,be.f)(ba,ya,va);const R=ee.frustum,G=-(0,Ki.mN)(R[zt.FB.NEAR],ya)/(0,be.k)(ba,(0,Ki.Qj)(R[zt.FB.NEAR]));(0,be.h)(ba,ba,G),(0,be.g)(ya,ya,ba),ee.projectToRenderScreen(ya,Ca)}else if(Ca[2]>0&&wa[2]<0){(0,be.f)(ba,va,ya);const R=ee.frustum,G=-(0,Ki.mN)(R[zt.FB.NEAR],va)/(0,be.k)(ba,(0,Ki.Qj)(R[zt.FB.NEAR]));(0,be.h)(ba,ba,G),(0,be.g)(va,va,ba),ee.projectToRenderScreen(va,wa)}else if(Ca[2]<0&&wa[2]<0)continue;Ca[2]=0,wa[2]=0;const H=(0,oa.kb)((0,oa.Cr)(Ca,wa,Ta),te);H<re&&(re=H,(0,be.c)(Aa,ya),(0,be.c)(Ra,va),ne=J/3)}const ae=H.rayBegin,oe=H.rayEnd;if(re<ie*ie){let R=Number.MAX_VALUE;if((0,oa.ld)((0,oa.Cr)(Aa,Ra,Ta),(0,oa.Cr)(ae,oe,Ea),xa)){(0,be.f)(xa,xa,ae);const G=(0,be.l)(xa);(0,be.h)(xa,xa,1/G),R=G/(0,be.q)(ae,oe)}Q(R,xa,ne,!1)}}get _layout(){const R=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec3f(Wt.r.PREVPOSITION).vec3f(Wt.r.NEXTPOSITION).f32(Wt.r.SUBDIVISIONFACTOR).vec2f(Wt.r.UV0);return this.parameters.vvSize?R.f32(Wt.r.SIZEFEATUREATTRIBUTE):R.f32(Wt.r.SIZE),this.parameters.vvColor?R.f32(Wt.r.COLORFEATUREATTRIBUTE):R.vec4f(Wt.r.COLOR),this.parameters.vvOpacity&&R.f32(Wt.r.OPACITYFEATUREATTRIBUTE),(0,te.A)("enable-feature:objectAndLayerId-rendering")&&R.vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR),R}createBufferWriter(){return new RibbonLineMaterial_V(this._layout,this.parameters)}createGLMaterial(R){return new RibbonLineMaterial_z(R)}validateParameters(R){"miter"!==R.join&&(R.miterLimit=0),null!=R.markerParameters&&(R.markerScale=R.markerParameters.width/R.width)}}class RibbonLineMaterial_z extends On.A{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(R){R.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:R.hasOccludees})}beginSlot(R){this._output!==En.V.Color&&this._output!==En.V.Alpha||this._updateOccludeeState(R);const G=this._material.parameters.stipplePattern;return this._stipplePattern!==G&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(G,this._stipplePattern)}),this._stipplePattern=G),this.ensureTechnique(RibbonLineTechnique_W,R)}}class RibbonLineMaterial_k extends la.S{constructor(){super(...arguments),this.width=0,this.color=Ce.Un,this.join="miter",this.cap=fa.x.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class RibbonLineMaterial_V{constructor(R,G){this.vertexBufferLayout=R,this._parameters=G,this.numJoinSubdivisions=0;const H=G.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=H;break;case"round":this.numJoinSubdivisions=da.r+H}}_isClosed(R){return RibbonLineMaterial_W(this._parameters,R.attributes)}allocate(R){return this.vertexBufferLayout.createBuffer(R)}elementCount(R){const G=R.attributes.get(Wt.r.POSITION).indices.length/2+1,H=this._isClosed(R);let W=H?2:4;return W+=((H?G:G-1)-(H?0:1))*(2*this.numJoinSubdivisions+4),W+=2,this._parameters.wireframe&&(W=2+4*(W-2)),W}write(R,G,H,W,q){var Q,J,X,$,K;const ee=Oa,ie=Pa,re=Ma,ne=H.attributes.get(Wt.r.POSITION),se=ne.indices,ae=ne.data.length/3,oe=null===(Q=H.attributes.get(Wt.r.DISTANCETOSTART))||void 0===Q?void 0:Q.data;se&&se.length!==2*(ae-1)&&console.warn("RibbonLineMaterial does not support indices");const le=null!==(J=null!==(X=null===($=H.attributes.get(Wt.r.SIZEFEATUREATTRIBUTE))||void 0===$?void 0:$.data[0])&&void 0!==X?X:null===(K=H.attributes.get(Wt.r.SIZE))||void 0===K?void 0:K.data[0])&&void 0!==J?J:1;let ce=[1,1,1,1],de=0;const he=this.vertexBufferLayout.fields.has(Wt.r.COLORFEATUREATTRIBUTE);he?de=H.attributes.get(Wt.r.COLORFEATUREATTRIBUTE).data[0]:H.attributes.has(Wt.r.COLOR)&&(ce=H.attributes.get(Wt.r.COLOR).data);const ue=(0,te.A)("enable-feature:objectAndLayerId-rendering")?H.objectAndLayerIdColor:null,pe=this.vertexBufferLayout.fields.has(Wt.r.OPACITYFEATUREATTRIBUTE),_e=pe?H.attributes.get(Wt.r.OPACITYFEATUREATTRIBUTE).data[0]:0,me=new Float32Array(W.buffer),ge=(0,te.A)("enable-feature:objectAndLayerId-rendering")?new Uint8Array(W.buffer):null,fe=this.vertexBufferLayout.stride/4;let ye=q*fe;const ve=ye;let xe=0;const Se=oe?(R,G,H)=>xe=oe[H]:(R,G,H)=>xe+=(0,be.q)(R,G),Ce=(0,te.A)("enable-feature:objectAndLayerId-rendering"),y=(R,G,H,W,q,Q,J)=>{if(me[ye++]=G[0],me[ye++]=G[1],me[ye++]=G[2],me[ye++]=R[0],me[ye++]=R[1],me[ye++]=R[2],me[ye++]=H[0],me[ye++]=H[1],me[ye++]=H[2],me[ye++]=W,me[ye++]=J,me[ye++]=q,me[ye++]=le,he)me[ye++]=de;else{const R=Math.min(4*Q,ce.length-4);me[ye++]=ce[R],me[ye++]=ce[R+1],me[ye++]=ce[R+2],me[ye++]=ce[R+3]}pe&&(me[ye++]=_e),Ce&&(null!=ue&&(ge[4*ye]=ue[0],ge[4*ye+1]=ue[1],ge[4*ye+2]=ue[2],ge[4*ye+3]=ue[3]),ye++)};ye+=fe,(0,be.s)(ie,ne.data[0],ne.data[1],ne.data[2]),R&&(0,be.e)(ie,ie,R);const we=this._isClosed(H);if(we){const G=ne.data.length-3;(0,be.s)(ee,ne.data[G],ne.data[G+1],ne.data[G+2]),R&&(0,be.e)(ee,ee,R)}else(0,be.s)(re,ne.data[3],ne.data[4],ne.data[5]),R&&(0,be.e)(re,re,R),y(ie,ie,re,1,ga.LEFT_CAP_START,0,0),y(ie,ie,re,1,ga.RIGHT_CAP_START,0,0),(0,be.c)(ee,ie),(0,be.c)(ie,re);const Ae=we?0:1,Re=we?ae:ae-1;for(let te=Ae;te<Re;te++){const G=(te+1)%ae*3;(0,be.s)(re,ne.data[G],ne.data[G+1],ne.data[G+2]),R&&(0,be.e)(re,re,R),Se(ee,ie,te),y(ee,ie,re,0,ga.LEFT_JOIN_END,te,xe),y(ee,ie,re,0,ga.RIGHT_JOIN_END,te,xe);const H=this.numJoinSubdivisions;for(let R=0;R<H;++R){const G=(R+1)/(H+1);y(ee,ie,re,G,ga.LEFT_JOIN_END,te,xe),y(ee,ie,re,G,ga.RIGHT_JOIN_END,te,xe)}y(ee,ie,re,1,ga.LEFT_JOIN_START,te,xe),y(ee,ie,re,1,ga.RIGHT_JOIN_START,te,xe),(0,be.c)(ee,ie),(0,be.c)(ie,re)}we?((0,be.s)(re,ne.data[3],ne.data[4],ne.data[5]),R&&(0,be.e)(re,re,R),xe=Se(ee,ie,Re),y(ee,ie,re,0,ga.LEFT_JOIN_END,Ae,xe),y(ee,ie,re,0,ga.RIGHT_JOIN_END,Ae,xe)):(xe=Se(ee,ie,Re),y(ee,ie,ie,0,ga.LEFT_CAP_END,Re,xe),y(ee,ie,ie,0,ga.RIGHT_CAP_END,Re,xe)),RibbonLineMaterial_Z(me,ve+fe,me,ve,fe),ye=RibbonLineMaterial_Z(me,ye-fe,me,ye,fe),this._parameters.wireframe&&this._addWireframeVertices(W,ve,ye,fe)}_addWireframeVertices(R,G,H,W){const q=new Float32Array(R.buffer,H*Float32Array.BYTES_PER_ELEMENT),Q=new Float32Array(R.buffer,G*Float32Array.BYTES_PER_ELEMENT,H-G);let J=0;const o=R=>J=RibbonLineMaterial_Z(Q,R,q,J,W);for(let X=0;X<Q.length-1;X+=2*W)o(X),o(X+2*W),o(X+1*W),o(X+2*W),o(X+1*W),o(X+3*W)}}function RibbonLineMaterial_Z(R,G,H,W,q){for(let Q=0;Q<q;Q++)H[W++]=R[G++];return W}function RibbonLineMaterial_W(R,G){return!!R.isClosed&&G.get(Wt.r.POSITION).indices.length>2}const ya=(0,xe.vt)(),va=(0,xe.vt)(),ba=(0,xe.vt)(),xa=(0,xe.vt)(),Sa=(0,xe.vt)(),Ca=(0,kr.r_)(),wa=(0,kr.r_)(),Aa=(0,xe.vt)(),Ra=(0,xe.vt)(),Ta=(0,oa.vt)(),Ea=(0,oa.vt)(),Oa=(0,xe.vt)(),Pa=(0,xe.vt)(),Ma=(0,xe.vt)(),Ia=[(0,kr.r_)(),(0,kr.r_)(),(0,kr.r_)(),(0,kr.r_)()],Da=[(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)()],La=(0,Ki.vt)(),Fa=(0,Ki.vt)(),Na=(0,Ki.vt)(),Va=(0,Ki.vt)();class GridLocalOriginFactory_{constructor(R){this._originSR=R,this._rootOriginId="root/"+(0,wi.c)(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(R){const G=this._origins.get(this._rootOriginId);if(null==G){const G=ia;if(null!=G)return this._origins.set(this._rootOriginId,LocalOriginFactory_t(G[0],G[1],G[2],this._rootOriginId)),this.getOrigin(R);const H=LocalOriginFactory_t(R[0]+Math.random()-.5,R[1]+Math.random()-.5,R[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,H),H}const H=this._gridSize,W=Math.round(R[0]/H),q=Math.round(R[1]/H),Q=Math.round(R[2]/H),J="".concat(W,"/").concat(q,"/").concat(Q);let X=this._origins.get(J);const $=.5*H;if((0,be.f)(Ua,R,G.vec3),Ua[0]=Math.abs(Ua[0]),Ua[1]=Math.abs(Ua[1]),Ua[2]=Math.abs(Ua[2]),Ua[0]<$&&Ua[1]<$&&Ua[2]<$){if(X){const G=Math.max(...Ua);if((0,be.f)(Ua,R,X.vec3),Ua[0]=Math.abs(Ua[0]),Ua[1]=Math.abs(Ua[1]),Ua[2]=Math.abs(Ua[2]),Math.max(...Ua)<G)return X}return G}return X||(X=LocalOriginFactory_t(W*H,q*H,Q*H,J),this._origins.set(J,X)),X}_drawOriginBox(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,Ce.fA)(1,1,0,1);const H=window.view,W=H._stage,q=G.toString();if(!this._objects.has(q)){this._material=new RibbonLineMaterial_H({width:2,color:G}),W.add(this._material);const R=new WebGLLayer_a(W,{pickable:!1}),H=new Object3D_O({castShadow:!1});W.add(H),R.add(H),this._objects.set(q,H)}const Q=this._objects.get(q),J=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],X=J.length,$=new Array(3*X),K=new Array,ee=.5*this._gridSize;for(let ie=0;ie<X;ie++)$[3*ie]=R[0]+(1&J[ie]?ee:-ee),$[3*ie+1]=R[1]+(2&J[ie]?ee:-ee),$[3*ie+2]=R[2]+(4&J[ie]?ee:-ee),ie>0&&K.push(ie-1,ie);(0,Ie.projectBuffer)($,this._originSR,0,$,H.renderSpatialReference,0,X);const te=new rr.V(this._material,[[Wt.r.POSITION,new tr.n($,K,3,!0)]],null,ir.X.Line);W.add(te),Q.addGeometry(te)}get test(){const R=this;return{set gridSize(G){R._gridSize=G}}}}const Ua=(0,xe.vt)();var Ga=H(73905),za=H(41201),Ba=H(95249),Ha=H(17372),ja=H(82993),Wa=H(65728);class BindParameters_m{constructor(R,G){this.shadowMap=R,this.slicePlane=G,this.slot=Mn.N.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=pa.y.NONE,this.alignPixelEnabled=!1,this.decorations=et.ID.ON,this.overlayStretch=1,this._camera=new Qs,this._inverseViewport=(0,Xi.vt)(),this.oldLighting=new Wa.TA,this.newLighting=new Wa.TA,this._fadedLighting=new Wa.TA,this._lighting=this.newLighting,this.ssr=new BindParameters_c,this.multipassEnabled=!1,this.multipassTerrain=new ja.h,this.multipassGeometry=new Ha.U,this.hudRenderStyle=Ba.D.Occluded,this.cloudsFade=new za.ny}get camera(){return this._camera}set camera(R){this._camera=R,this._inverseViewport[0]=1/R.fullViewport[2],this._inverseViewport[1]=1/R.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(R){const{oldLighting:G,newLighting:H}=this;R>=1?this._lighting=H:(this._fadedLighting.lerpLighting(G,H,R),this._lighting=this._fadedLighting)}}class BindParameters_c{constructor(){this.fadeFactor=1,this.reprojectionMatrix=(0,ve.vt)()}}class RenderContext_a{constructor(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.rctx=R,this.sliceHelper=H,this.lastFrameCamera=new Qs,this.output=En.V.Color,this.renderOccludedMask=ka,this.bindParameters=new BindParameters_m(G,null!=H?H.plane:null),this.bindParameters.alignPixelEnabled=!0}}const ka=Pn.m$.Occlude|Pn.m$.OccludeAndTransparent|Pn.m$.OccludeAndTransparentStencil;let qa=class extends Qs{constructor(){super(...arguments),this._projectionMatrix=(0,ve.vt)()}get projectionMatrix(){return this._projectionMatrix}};(0,W._)([(0,ee.MZ)()],qa.prototype,"_projectionMatrix",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],qa.prototype,"projectionMatrix",null),qa=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.lib.CascadeCamera")],qa);var Za,Qa=H(83663);!function(R){R[R.Highlight=0]="Highlight",R[R.ExcludeHighlight=1]="ExcludeHighlight"}(Za||(Za={}));class ShadowMap_q{constructor(){this.camera=new qa,this.lightMat=(0,ve.vt)()}}class ShadowMap_G{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class ShadowMap_X{constructor(R,G){this._fbos=R,this._viewingMode=G,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new ShadowMap_G,this._projectionView=(0,ve.vt)(),this._projectionViewInverse=(0,ve.vt)(),this._modelViewLight=(0,ve.vt)(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,Ce.vt)(),this._cascades=[new ShadowMap_q,new ShadowMap_q,new ShadowMap_q,new ShadowMap_q],this._lastOrigin=null,this._maxTextureWidth=Math.min((0,te.A)("esri-mobile")?4096:16384,R.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var R;return null===(R=this._handle)||void 0===R?void 0:R.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return(0,Se.s)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=(0,Qe.Gz)(this._handle),this._discardSnapshots()}set maxCascades(R){this.settings.maxNumCascadesHighQuality=(0,Ee.qE)(Math.floor(R),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(R){this._enabled=R,R||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let R=0;R<this._numCascades;++R)no[R]=this._cascades[R];return no.length=this._numCascades,no}start(R,G,H,W,q){(0,nr.vA)(this.enabled);const{near:Q,far:J}=this._clampNearFar(H);this._computeCascadeDistances(Q,J,W),this._textureHeight=this._computeTextureHeight(R,q,W),this._setupMatrices(R,G);const{viewMatrix:X,projectionMatrix:$}=R;for(let K=0;K<this._numCascades;++K)this._constructCascade(K,$,X,G);this._lastOrigin=null,this.clear()}finish(){var R;(0,nr.vA)(this.enabled),null===(R=this._handle)||void 0===R||R.detachDepth()}getShadowMapMatrices(R){if(!this._lastOrigin||!(0,be.j)(R,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,xe.vt)(),(0,be.c)(this._lastOrigin,R);for(let G=0;G<this._numCascades;++G){(0,ye.Tl)(so,this._cascades[G].lightMat,R);for(let R=0;R<16;++R)ao[16*G+R]=so[R]}}return ao}moveSnapshot(R){var G,H;(0,nr.vA)(this.enabled),null!==(G=this._handle)&&void 0!==G&&G.detachDepth(),null!==(H=this._snapshots[R])&&void 0!==H&&H.release(),this._snapshots[R]=this._handle,this._handle=null,this.clear()}copySnapshot(R){var G,H,W;const q=null===(G=this._handle)||void 0===G||null===(G=G.getTexture())||void 0===G?void 0:G.descriptor;if(!this.enabled||!q)return;null===(H=this._snapshots[R])||void 0===H||H.release();const{width:Q,height:J}=q,X=R===Za.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[R]=this._fbos.acquire(Q,J,X,Ds.N.RGBA4);const $=this._fbos.rctx;this._bindFbo();const K=$.bindTexture(null===(W=this._snapshots[R])||void 0===W?void 0:W.getTexture(),Qa.g.TEXTURE_UNIT_FOR_UPDATES);$.gl.copyTexSubImage2D(Ft.Ap.TEXTURE_2D,0,0,0,0,0,Q,J),$.bindTexture(K,Qa.g.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(R){var G;return this.enabled?null===(G=this._snapshots[R])||void 0===G?void 0:G.getTexture():null}clear(){const R=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),R.setClearColor(1,1,1,1),R.clearSafe(Ft.hn.COLOR_BUFFER_BIT|Ft.hn.DEPTH_BUFFER_BIT)}_computeTextureHeight(R,G,H){const W=Math.min(window.devicePixelRatio,G)/R.pixelRatio,q=H?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,Q=(0,tt.Mv)(Math.floor(Math.max(R.fullWidth,R.fullHeight)*W*q)),J=Math.min(this._maxTextureWidth,this._numCascades*Q);return(0,tt.uT)(J/this._numCascades)}_ensureFbo(){var R,G,H,W;(null===(R=this._handle)||void 0===R?void 0:R.fbo.width)===this._textureWidth&&(null===(G=this._handle)||void 0===G?void 0:G.fbo.height)===this._textureHeight||(null!==(H=this._handle)&&void 0!==H&&H.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",Ds.N.RGBA4)),null===(W=this._handle)||void 0===W||W.acquireDepth(Ds.z.DEPTH16_BUFFER)}_discardSnapshot(R){this._snapshots[R]=(0,Qe.Gz)(this._snapshots[R])}_discardSnapshots(){for(let R=0;R<this._snapshots.length;++R)this._discardSnapshot(R);this._snapshots.length=0}_bindFbo(){var R;const G=this._fbos.rctx;G.unbindTexture(this.depthTexture),G.bindFramebuffer(null===(R=this._handle)||void 0===R?void 0:R.fbo)}_constructCascade(R,G,H,W){const q=this._cascades[R],Q=-this._cascadeDistances[R],J=-this._cascadeDistances[R+1],X=(G[10]*Q+G[14])/Math.abs(G[11]*Q+G[15]),$=(G[10]*J+G[14])/Math.abs(G[11]*J+G[15]);(0,nr.vA)(X<$);for(let ie=0;ie<8;++ie){(0,Se.s)(Ja,ie%4==0||ie%4==3?-1:1,ie%4==0||ie%4==1?-1:1,ie<4?X:$,1);const R=Xa[ie];(0,Se.t)(R,Ja,this._projectionViewInverse),R[0]/=R[3],R[1]/=R[3],R[2]/=R[3]}(0,be.F)(ro,Xa[0]),q.camera.viewMatrix=(0,ye.Tl)(Ya,this._modelViewLight,ro);for(let ie=0;ie<8;++ie)(0,be.e)(Xa[ie],Xa[ie],q.camera.viewMatrix);let K=Xa[0][2],ee=Xa[0][2];for(let ie=1;ie<8;++ie)K=Math.min(K,Xa[ie][2]),ee=Math.max(ee,Xa[ie][2]);K-=200,ee+=200,q.camera.near=-ee,q.camera.far=-K,function jt(R,G,H,W,q){const Q=1/Xa[0][3],J=1/Xa[4][3];(0,nr.vA)(Q<J);let X=Q+Math.sqrt(Q*J);const $=Math.sin((0,Ee.XM)(R[2]*G[0]+R[6]*G[1]+R[10]*G[2]));X/=$,function ShadowMap_ft(R,G,H,W,q,Q,J,X){(0,Yn.hZ)(oo,0,0);for(let he=0;he<4;++he)(0,Yn.WQ)(oo,oo,R[he]);(0,Yn.hs)(oo,oo,.25),(0,Yn.hZ)(lo,0,0);for(let he=4;he<8;++he)(0,Yn.WQ)(lo,lo,R[he]);(0,Yn.hs)(lo,lo,.25),(0,Yn.Cc)(co[0],R[4],R[5],.5),(0,Yn.Cc)(co[1],R[5],R[6],.5),(0,Yn.Cc)(co[2],R[6],R[7],.5),(0,Yn.Cc)(co[3],R[7],R[4],.5);let $=0,K=(0,Yn.hG)(co[0],oo);for(let he=1;he<4;++he){const R=(0,Yn.hG)(co[he],oo);R<K&&(K=R,$=he)}(0,Yn.Re)(ho,co[$],R[$+4]);const ee=ho[0];let te,ie;ho[0]=-ho[1],ho[1]=ee,(0,Yn.Re)(uo,lo,oo),(0,Yn.Om)(uo,ho)<0&&(0,Yn.ze)(ho,ho),(0,Yn.Cc)(ho,ho,uo,H),(0,Yn.S8)(ho,ho),te=ie=(0,Yn.Om)((0,Yn.Re)(po,R[0],oo),ho);for(let he=1;he<8;++he){const G=(0,Yn.Om)((0,Yn.Re)(po,R[he],oo),ho);G<te?te=G:G>ie&&(ie=G)}(0,Yn.C)(W,oo),(0,Yn.hs)(po,ho,te-G),(0,Yn.WQ)(W,W,po);let re=-1,ne=1,se=0,ae=0;for(let he=0;he<8;++he){(0,Yn.Re)(_o,R[he],W),(0,Yn.S8)(_o,_o);const G=ho[0]*_o[1]-ho[1]*_o[0];G>0?G>re&&(re=G,se=he):G<ne&&(ne=G,ae=he)}(0,nr.MX)(re>0,"leftArea"),(0,nr.MX)(ne<0,"rightArea"),(0,Yn.hs)(mo,ho,te),(0,Yn.WQ)(mo,mo,oo),(0,Yn.hs)(go,ho,ie),(0,Yn.WQ)(go,go,oo),fo[0]=-ho[1],fo[1]=ho[0];const oe=(0,nr.L)(W,R[ae],go,(0,Yn.WQ)(po,go,fo),1,q),le=(0,nr.L)(W,R[se],go,po,1,Q),ce=(0,nr.L)(W,R[se],mo,(0,Yn.WQ)(po,mo,fo),1,J),de=(0,nr.L)(W,R[ae],mo,po,1,X);(0,nr.MX)(oe,"rayRay"),(0,nr.MX)(le,"rayRay"),(0,nr.MX)(ce,"rayRay"),(0,nr.MX)(de,"rayRay")}(Xa,X,$,$a,Ka,eo,to,io),function Ct(R,G,H,W,q){(0,Yn.Re)(vo,H,W),(0,Yn.hs)(vo,vo,.5),bo[0]=vo[0],bo[1]=vo[1],bo[2]=0,bo[3]=vo[1],bo[4]=-vo[0],bo[5]=0,bo[6]=vo[0]*vo[0]+vo[1]*vo[1],bo[7]=vo[0]*vo[1]-vo[1]*vo[0],bo[8]=1,bo[ShadowMap_pt(0,2)]=-(0,Yn.Om)(ShadowMap_bt(bo,0),R),bo[ShadowMap_pt(1,2)]=-(0,Yn.Om)(ShadowMap_bt(bo,1),R);let Q=(0,Yn.Om)(ShadowMap_bt(bo,0),H)+bo[ShadowMap_pt(0,2)],J=(0,Yn.Om)(ShadowMap_bt(bo,1),H)+bo[ShadowMap_pt(1,2)],X=(0,Yn.Om)(ShadowMap_bt(bo,0),W)+bo[ShadowMap_pt(0,2)],$=(0,Yn.Om)(ShadowMap_bt(bo,1),W)+bo[ShadowMap_pt(1,2)];Q=-(Q+X)/(J+$),bo[ShadowMap_pt(0,0)]+=bo[ShadowMap_pt(1,0)]*Q,bo[ShadowMap_pt(0,1)]+=bo[ShadowMap_pt(1,1)]*Q,bo[ShadowMap_pt(0,2)]+=bo[ShadowMap_pt(1,2)]*Q,Q=1/((0,Yn.Om)(ShadowMap_bt(bo,0),H)+bo[ShadowMap_pt(0,2)]),J=1/((0,Yn.Om)(ShadowMap_bt(bo,1),H)+bo[ShadowMap_pt(1,2)]),bo[ShadowMap_pt(0,0)]*=Q,bo[ShadowMap_pt(0,1)]*=Q,bo[ShadowMap_pt(0,2)]*=Q,bo[ShadowMap_pt(1,0)]*=J,bo[ShadowMap_pt(1,1)]*=J,bo[ShadowMap_pt(1,2)]*=J,bo[ShadowMap_pt(2,0)]=bo[ShadowMap_pt(1,0)],bo[ShadowMap_pt(2,1)]=bo[ShadowMap_pt(1,1)],bo[ShadowMap_pt(2,2)]=bo[ShadowMap_pt(1,2)],bo[ShadowMap_pt(1,2)]+=1,Q=(0,Yn.Om)(ShadowMap_bt(bo,1),G)+bo[ShadowMap_pt(1,2)],J=(0,Yn.Om)(ShadowMap_bt(bo,2),G)+bo[ShadowMap_pt(2,2)],X=(0,Yn.Om)(ShadowMap_bt(bo,1),H)+bo[ShadowMap_pt(1,2)],$=(0,Yn.Om)(ShadowMap_bt(bo,2),H)+bo[ShadowMap_pt(2,2)],Q=-.5*(Q/J+X/$),bo[ShadowMap_pt(1,0)]+=bo[ShadowMap_pt(2,0)]*Q,bo[ShadowMap_pt(1,1)]+=bo[ShadowMap_pt(2,1)]*Q,bo[ShadowMap_pt(1,2)]+=bo[ShadowMap_pt(2,2)]*Q,Q=(0,Yn.Om)(ShadowMap_bt(bo,1),G)+bo[ShadowMap_pt(1,2)],J=(0,Yn.Om)(ShadowMap_bt(bo,2),G)+bo[ShadowMap_pt(2,2)],X=-J/Q,bo[ShadowMap_pt(1,0)]*=X,bo[ShadowMap_pt(1,1)]*=X,bo[ShadowMap_pt(1,2)]*=X,q[0]=bo[0],q[1]=bo[1],q[2]=0,q[3]=bo[2],q[4]=bo[3],q[5]=bo[4],q[6]=0,q[7]=bo[5],q[8]=0,q[9]=0,q[10]=1,q[11]=0,q[12]=bo[6],q[13]=bo[7],q[14]=0,q[15]=bo[8]}($a,Ka,to,io,q.projectionMatrix),q.projectionMatrix[10]=2/(H-W),q.projectionMatrix[14]=-(H+W)/(H-W)}(H,W,K,ee,q.camera),(0,ye.lw)(q.lightMat,q.camera.projectionMatrix,q.camera.viewMatrix);const te=this._textureHeight;q.camera.viewport=[R*te,0,te,te]}_setupMatrices(R,G){(0,ye.lw)(this._projectionView,R.projectionMatrix,R.viewMatrix),(0,ye.B8)(this._projectionViewInverse,this._projectionView);const H=this._viewingMode===qe.RT.Global?R.eye:(0,be.s)(ro,0,0,1);(0,ye.t5)(this._modelViewLight,[0,0,0],[-G[0],-G[1],-G[2]],H)}_clampNearFar(R){let{near:G,far:H}=R;return G<2&&(G=2),H<2&&(H=2),G>=H&&(G=2,H=4),{near:G,far:H}}_computeCascadeDistances(R,G,H){const W=H?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor((0,nr.kL)(G/R,4)),W);const q=(G-R)/this._numCascades,Q=(G/R)**(1/this._numCascades);let J=R,X=R;for(let $=0;$<this._numCascades+1;++$)this._cascadeDistances[$]=(0,Ee.Cc)(J,X,this.settings.splitSchemeLambda),J*=Q,X+=q}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const Ya=(0,ve.vt)(),Ja=(0,Ce.vt)(),Xa=[];for(let ag=0;ag<8;++ag)Xa.push((0,Ce.vt)());const $a=(0,Xi.vt)(),Ka=(0,Xi.vt)(),eo=(0,Xi.vt)(),to=(0,Xi.vt)(),io=(0,Xi.vt)(),ro=(0,xe.vt)(),no=[],so=(0,ve.vt)(),ao=ve.zK.concat(ve.zK,ve.zK,ve.zK,ve.zK),oo=(0,Xi.vt)(),lo=(0,Xi.vt)(),co=[(0,Xi.vt)(),(0,Xi.vt)(),(0,Xi.vt)(),(0,Xi.vt)()],ho=(0,Xi.vt)(),uo=(0,Xi.vt)(),po=(0,Xi.vt)(),_o=(0,Xi.vt)(),mo=(0,Xi.vt)(),go=(0,Xi.vt)(),fo=(0,Xi.vt)();function ShadowMap_pt(R,G){return 3*G+R}const yo=(0,Xi.vt)();function ShadowMap_bt(R,G){return(0,Yn.hZ)(yo,R[G],R[G+3]),yo}const vo=(0,Xi.vt)(),bo=(0,fe.vt)();var xo,So;!function(R){R[R.OBJECT=0]="OBJECT",R[R.HUD=1]="HUD",R[R.TERRAIN=2]="TERRAIN",R[R.OVERLAY=3]="OVERLAY",R[R.I3S=4]="I3S",R[R.PCL=5]="PCL",R[R.LOD=6]="LOD",R[R.VOXEL=7]="VOXEL",R[R.TILES3D=8]="TILES3D"}(xo||(xo={}));class IntersectorInterfaces_e{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=So.ALL}}!function(R){R[R.MIN=0]="MIN",R[R.MINMAX=1]="MINMAX",R[R.ALL=2]="ALL"}(So||(So={}));class IntersectorTarget_t{constructor(R,G,H){this.object=R,this.geometryId=G,this.triangleNr=H}}class IntersectorTarget_r extends IntersectorTarget_t{constructor(R,G,H,W){super(R,G,H),this.center=null!=W?(0,xe.o8)(W):null}}class IntersectorTarget_e{constructor(R){this.layerUid=R}}class IntersectorTarget_o extends IntersectorTarget_e{constructor(R,G){super(R),this.graphicUid=G}}var Co=H(9299),wo=H(6744),Ao=H(86276);const boundedPlane_U=()=>J.A.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");const Ro=class boundedPlane_z{constructor(){this.plane=(0,Ki.vt)(),this.origin=(0,xe.vt)(),this.basis1=(0,xe.vt)(),this.basis2=(0,xe.vt)()}};function boundedPlane_W(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:To;return{plane:(0,Ki.vt)(R.plane),origin:(0,xe.o8)(R.origin),basis1:(0,xe.o8)(R.basis1),basis2:(0,xe.o8)(R.basis2)}}function boundedPlane_Z(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:boundedPlane_W();return boundedPlane_H(R.origin,R.basis1,R.basis2,G)}function boundedPlane_H(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:boundedPlane_W();return(0,be.c)(W.origin,R),(0,be.c)(W.basis1,G),(0,be.c)(W.basis2,H),boundedPlane_J(W),function Ps(R,G){Math.abs((0,be.k)(R.basis1,R.basis2)/((0,be.l)(R.basis1)*(0,be.l)(R.basis2)))>1e-6&&boundedPlane_U().warn(G,"Provided basis vectors are not perpendicular"),Math.abs((0,be.k)(R.basis1,ds(R)))>1e-6&&boundedPlane_U().warn(G,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,be.k)(ds(R),R.origin)-R.plane[3])>1e-6&&boundedPlane_U().warn(G,"Plane offset is not consistent with plane origin")}(W,"fromValues()"),W}function boundedPlane_J(R){(0,Ki.mR)(R.basis2,R.basis1,R.origin,R.plane)}function boundedPlane_K(R,G,H){R!==H&&boundedPlane_Z(R,H);const W=(0,be.h)(Ao.rq.get(),ds(R),G);return(0,be.g)(H.origin,H.origin,W),H.plane[3]-=G,H}function boundedPlane_$(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:boundedPlane_W();const H=(R[2]-R[0])/2,W=(R[3]-R[1])/2;return(0,be.s)(G.origin,R[0]+H,R[1]+W,0),(0,be.s)(G.basis1,H,0,0),(0,be.s)(G.basis2,0,W,0),(0,Ki.fA)(0,0,1,0,G.plane),G}function ss(R,G,H){return!!(0,Ki.Ui)(R.plane,G,H)&&js(R,H)}function is(R,G,H){const W=Eo.get();vs(R,G,W,Eo.get());let q=Number.POSITIVE_INFINITY;for(const Q of Io){const J=ys(R,Q,Oo.get()),X=Ao.rq.get();if((0,Ki.T7)(W,J,X)){const R=(0,be.E)(Ao.rq.get(),G.origin,X),W=Math.abs((0,Ee.XM)((0,be.k)(G.direction,R)));W<q&&(q=W,(0,be.c)(H,X))}}return q===Number.POSITIVE_INFINITY?ns(R,G,H):H}function ns(R,G,H){if(ss(R,G,H))return H;const W=Eo.get(),q=Eo.get();vs(R,G,W,q);let Q=Number.POSITIVE_INFINITY;for(const J of Io){const X=ys(R,J,Oo.get()),$=Ao.rq.get();if((0,Ki.gv)(W,X,$)){const R=(0,er.kb)(G,$);if(!(0,Ki.Tj)(q,$))continue;R<Q&&(Q=R,(0,be.c)(H,$))}}return es(R,G.origin)<Q&&rs(R,G.origin,H),H}function rs(R,G,H){const W=(0,Ki._I)(R.plane,G,Ao.rq.get()),q=(0,oa.H6)(Is(R,R.basis1),W,-1,1,Ao.rq.get()),Q=(0,oa.H6)(Is(R,R.basis2),W,-1,1,Ao.rq.get());return(0,be.f)(H,(0,be.g)(Ao.rq.get(),q,Q),R.origin),H}function os(R,G,H){const{origin:W,basis1:q,basis2:Q}=R,J=(0,be.f)(Ao.rq.get(),G,W),X=(0,Zs.gr)(q,J),$=(0,Zs.gr)(Q,J),K=(0,Zs.gr)(ds(R),J);return(0,be.s)(H,X,$,K)}function es(R,G){const H=os(R,G,Ao.rq.get()),{basis1:W,basis2:q}=R,Q=(0,be.l)(W),J=(0,be.l)(q),X=Math.max(Math.abs(H[0])-Q,0),$=Math.max(Math.abs(H[1])-J,0),K=H[2];return X*X+$*$+K*K}function bs(R,G){const H=-R.plane[3];return(0,Zs.gr)(ds(R),G)-H}function ds(R){return(0,Ki.Qj)(R.plane)}function js(R,G){const H=(0,be.f)(Ao.rq.get(),G,R.origin),W=(0,be.p)(R.basis1),q=(0,be.p)(R.basis2),Q=(0,be.k)(R.basis1,H),J=(0,be.k)(R.basis2,H);return-Q-W<0&&Q-W<0&&-J-q<0&&J-q<0}function Is(R,G){const H=Oo.get();return(0,be.c)(H.origin,R.origin),(0,be.c)(H.vector,G),H}function ys(R,G,H){const{basis1:W,basis2:q,origin:Q}=R,J=(0,be.h)(Ao.rq.get(),W,G.origin[0]),X=(0,be.h)(Ao.rq.get(),q,G.origin[1]);(0,be.g)(H.origin,J,X),(0,be.g)(H.origin,H.origin,Q);const $=(0,be.h)(Ao.rq.get(),W,G.direction[0]),K=(0,be.h)(Ao.rq.get(),q,G.direction[1]);return(0,be.h)(H.vector,(0,be.g)($,$,K),2),H}function vs(R,G,H,W){const q=ds(R);(0,Ki.mR)(q,G.direction,G.origin,H),(0,Ki.mR)((0,Ki.Qj)(H),q,G.origin,W)}const To={plane:(0,Ki.vt)(),origin:(0,xe.fA)(0,0,0),basis1:(0,xe.fA)(1,0,0),basis2:(0,xe.fA)(0,1,0)},Eo=new Co.I(Ki.vt),Oo=new Co.I(oa.vt),Po=(0,xe.vt)(),Mo=new Co.I((()=>boundedPlane_W())),Io=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],Do=(0,ve.vt)(),Lo=(0,ve.vt)();Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:Ro,altitudeAt:bs,axisAt:function gs(R,G,H,W){return function hs(R,G,H){switch(G){case wo._.X:(0,be.c)(H,R.basis1),(0,be.n)(H,H);break;case wo._.Y:(0,be.c)(H,R.basis2),(0,be.n)(H,H);break;case wo._.Z:(0,be.c)(H,ds(R))}return H}(R,H,W)},closestPoint:ns,closestPointOnSilhouette:is,copy:boundedPlane_Z,copyWithoutVerify:function boundedPlane_D(R,G){(0,be.c)(G.origin,R.origin),(0,be.c)(G.basis1,R.basis1),(0,be.c)(G.basis2,R.basis2),(0,Ki.C)(G.plane,R.plane)},create:boundedPlane_W,distance:function as(R,G){return Math.sqrt(es(R,G))},distance2:es,distanceToSilhouette:function cs(R,G){let H=Number.NEGATIVE_INFINITY;for(const W of Io){const q=ys(R,W,Oo.get()),Q=(0,oa.kb)(q,G);Q>H&&(H=Q)}return Math.sqrt(H)},elevate:boundedPlane_K,equals:function ps(R,G){return(0,be.j)(R.basis1,G.basis1)&&(0,be.j)(R.basis2,G.basis2)&&(0,be.j)(R.origin,G.origin)},extrusionContainsPoint:function us(R,G){return(0,Ki.Tj)(R.plane,G)&&js(R,G)},fromAABoundingRect:boundedPlane_$,fromValues:boundedPlane_H,intersectRay:ss,intersectRayClosestSilhouette:function ts(R,G,H){if(ss(R,G,H))return H;const W=is(R,G,Ao.rq.get());return(0,be.g)(H,G.origin,(0,be.h)(Ao.rq.get(),G.direction,(0,be.q)(G.origin,W)/(0,be.l)(G.direction))),H},normal:ds,projectPoint:rs,projectPointLocal:os,rotate:function ms(R,G,H,W){return R!==W&&boundedPlane_Z(R,W),(0,ye.$0)(Lo,G,H),(0,be.e)(W.basis1,R.basis1,Lo),(0,be.e)(W.basis2,R.basis2,Lo),boundedPlane_J(W),W},setAltitudeAt:function fs(R,G,H,W){const q=bs(R,G),Q=(0,be.h)(Po,ds(R),H-q);return(0,be.g)(W,G,Q),W},setExtent:function boundedPlane_Q(R,G,H){return boundedPlane_$(G,H),boundedPlane_K(H,bs(R,R.origin),H),H},transform:function ls(R,G,H){return R!==H&&boundedPlane_Z(R,H),(0,ye.B8)(Do,G),(0,ye.mg)(Do,Do),(0,be.e)(H.basis1,R.basis1,Do),(0,be.e)(H.basis2,R.basis2,Do),(0,be.e)((0,Ki.Qj)(H.plane),(0,Ki.Qj)(R.plane),Do),(0,be.e)(H.origin,R.origin,G),(0,Ki.mP)(H.plane,H.plane,H.origin),H},up:To,updateUnboundedPlane:boundedPlane_J,wrap:function boundedPlane_X(R,G,H){const W=Mo.get();return W.origin=R,W.basis1=G,W.basis2=H,W.plane=(0,Ki.LV)(0,0,0,0),boundedPlane_J(W),W}},Symbol.toStringTag,{value:"Module"}));function intersectorUtils_o(R){return null!=(null===R||void 0===R?void 0:R.dist)}(0,xe.vt)();class Intersector_i extends IntersectorTarget_o{constructor(R,G,H){super(R,G),this.triangleNr=H}}class ChangeSet_s{constructor(){this.adds=new pe.A,this.removes=new pe.A,this.updates=new pe.A({allocator:R=>R||new ChangeSet_r,deallocator:R=>(R.renderGeometry=null,R)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class ChangeSet_r{}class ChangeSet_t{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var Fo=H(49630);const No=1e-5;class Intersector_b{constructor(R){this.options=new IntersectorInterfaces_e,this._results=new Intersector_A,this.transform=new Fo.dg,this.tolerance=No,this.verticalOffset=null,this._ray=(0,er.vt)(),this._rayEnd=(0,xe.vt)(),this._rayBeginTransformed=(0,xe.vt)(),this._rayEndTransformed=(0,xe.vt)(),this.viewingMode=null!==R&&void 0!==R?R:qe.RT.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(R,G,H){this.resetWithRay((0,er.Cr)(R,G,this._ray),H)}resetWithRay(R,G){this.camera=G,R!==this._ray&&(0,er.C)(R,this._ray),0!==this.options.verticalOffset?this.viewingMode===qe.RT.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,be.g)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,G=arguments.length>1?arguments[1]:void 0,H=arguments.length>2?arguments[2]:void 0,W=arguments.length>3?arguments[3]:void 0,q=arguments.length>4?arguments[4]:void 0;this.point=G,this.filterPredicate=W,this.tolerance=null!==H&&void 0!==H?H:No;const Q=(0,Fo.ou)(this.verticalOffset);if(R&&R.length>0){const G=q?R=>{q(R)&&this.intersectObject(R)}:R=>{this.intersectObject(R)};for(const H of R){var J;const R=null===(J=H.getSpatialQueryAccelerator)||void 0===J?void 0:J.call(H);null!=R?(null!=Q?R.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,G,Q):R.forEachAlongRay(this._ray.origin,this._ray.direction,G),this.options.selectionMode&&this.options.hud&&R.forEachDegenerateObject(G)):H.objects.forAll((R=>G(R)))}}this.sortResults()}intersectObject(R){const G=R.geometries;if(!G)return;const H=R.effectiveTransformation,W=(0,Fo.ou)(this.verticalOffset);for(const q of G){if(!q.visible)continue;const{material:G,id:Q}=q;this.transform.setAndInvalidateLazyTransforms(H,q.transformation),(0,be.e)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),(0,be.e)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const J=this.transform.transform;null!=W&&(W.objectTransform=this.transform),G.intersect(q,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((G,H,W,q,X,$)=>{if(G>=0){if(null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,G))return;const K=q?this._results.hud:this._results,ee=q?q=>{const J=new IntersectorTarget_r(R,Q,W,$);q.set(xo.HUD,J,G,H,ve.zK,X)}:q=>q.set(xo.OBJECT,{object:R,geometryId:Q,triangleNr:W},G,H,J,X);if((null==K.min.drapedLayerOrder||X>=K.min.drapedLayerOrder)&&(null==K.min.dist||G<K.min.dist)&&ee(K.min),this.options.store!==So.MIN&&(null==K.max.drapedLayerOrder||X<K.max.drapedLayerOrder)&&(null==K.max.dist||G>K.max.dist)&&ee(K.max),this.options.store===So.ALL)if(q){const R=new Intersector_I(this._ray);ee(R),this._results.hud.all.push(R)}else{const R=new Intersector_B(this._ray);ee(R),this._results.all.push(R)}}}))}}sortResults(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._results.all).sort(((R,G)=>{var H,W;return R.dist!==G.dist?(null!==(H=R.dist)&&void 0!==H?H:0)-(null!==(W=G.dist)&&void 0!==W?W:0):R.drapedLayerOrder!==G.drapedLayerOrder?Intersector_x(R.drapedLayerOrder,G.drapedLayerOrder):Intersector_x(R.drapedLayerGraphicOrder,G.drapedLayerGraphicOrder)}))}}function Intersector_x(R,G){return(null!==G&&void 0!==G?G:-Number.MAX_VALUE)-(null!==R&&void 0!==R?R:-Number.MAX_VALUE)}function Intersector_T(R){return new Intersector_b(R)}class Intersector_A{constructor(){this.min=new Intersector_B((0,er.vt)()),this.max=new Intersector_B((0,er.vt)()),this.hud={min:new Intersector_I((0,er.vt)()),max:new Intersector_I((0,er.vt)()),all:new Array},this.ground=new Intersector_B((0,er.vt)()),this.all=[]}init(R){this.min.init(R),this.max.init(R),this.ground.init(R),this.all.length=0,this.hud.min.init(R),this.hud.max.init(R),this.hud.all.length=0}}class Intersector_B{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?((0,be.h)(Vo,this.ray.direction,this.dist),(0,be.l)(Vo)):null}getIntersectionPoint(R){return!!intersectorUtils_o(this)&&((0,be.h)(Vo,this.ray.direction,this.dist),(0,be.g)(R,this.ray.origin,Vo),!0)}getTransformedNormal(R){return(0,be.c)(Uo,this.normal),Uo[3]=0,(0,Se.t)(Uo,Uo,this.transformation),(0,be.c)(R,Uo),(0,be.n)(R,R)}constructor(R){this.intersector=xo.OBJECT,this.normal=(0,xe.vt)(),this.transformation=(0,ve.vt)(),this._ray=(0,er.vt)(),this.init(R)}init(R){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=xo.OBJECT,(0,er.C)(R,this._ray)}set(R,G,H,W,q,Q,J){this.intersector=R,this.dist=H,(0,be.c)(this.normal,null!==W&&void 0!==W?W:xe.Cb),(0,ye.C)(this.transformation,null!==q&&void 0!==q?q:ve.zK),this.target=G,this.drapedLayerOrder=Q,this.drapedLayerGraphicOrder=J}copy(R){(0,er.C)(R.ray,this._ray),this.intersector=R.intersector,this.dist=R.dist,this.target=R.target,this.drapedLayerOrder=R.drapedLayerOrder,this.drapedLayerGraphicOrder=R.drapedLayerGraphicOrder,(0,be.c)(this.normal,R.normal),(0,ye.C)(this.transformation,R.transformation)}}class Intersector_I extends Intersector_B{constructor(){super(...arguments),this.intersector=xo.HUD}}function Intersector_G(R){return new Intersector_B(R)}const Vo=(0,xe.vt)(),Uo=(0,Ce.vt)();var Go,zo,Bo;function rendererUtils_n(R){return R.geometry.indexCount>=1}!function(R){R[R.ADD=0]="ADD",R[R.UPDATE=1]="UPDATE",R[R.REMOVE=2]="REMOVE"}(Go||(Go={})),function(R){R[R.NONE=0]="NONE",R[R.VISIBILITY=1]="VISIBILITY",R[R.GEOMETRY=2]="GEOMETRY",R[R.TRANSFORMATION=4]="TRANSFORMATION",R[R.HIGHLIGHT=8]="HIGHLIGHT",R[R.OCCLUDEE=16]="OCCLUDEE"}(zo||(zo={})),function(R){R[R.Default=0]="Default",R[R.Screenshot=1]="Screenshot",R[R.ObjectAndLayerID=2]="ObjectAndLayerID"}(Bo||(Bo={}));var Ho=H(27361);class GLMaterials_t{constructor(R,G){this._material=R,this._repository=G,this._map=new Map}dispose(){this._map.forEach(((R,G)=>{null!=R&&this._repository.release(this._material,G)}))}load(R,G,H){const W=this._material.produces.get(G);if(!W||!W(H))return null;this._map.has(H)||this._map.set(H,this._repository.acquire(this._material,G,H));const q=this._map.get(H);if(null!=q){if(q.ensureResources(R)===et.Am.LOADED)return q;this._repository.requestRender()}return null}}class DrawParameters_s extends Fs.gy{constructor(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,xe.vt)();super(),this.origin=R,this.slicePlaneLocalOrigin=this.origin}}class BufferRange_t{constructor(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.from=R,this.to=G}get numElements(){return this.to-this.from}}function BufferRange_o(R){const G=new Map;R.forAll((R=>G.set(R.from,R)));let H=!0;for(;H;){H=!1;for(let W=0;W<R.length;++W){const q=R.data[W],Q=G.get(q.to);if(!Q)return;q.to=Q.to,G.delete(Q.from),R.removeUnordered(Q),H=!0}}}class Instance_s extends BufferRange_t{constructor(R,G,H){super(G,H),this.geometry=R}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class DrawCommand_t{constructor(){this.first=0,this.count=0}}class PerBufferData_n{constructor(){this._numElements=0,this._instances=new Map,this.holes=new pe.A({allocator:R=>R||new BufferRange_t,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=PerBufferData_o(),this.drawCommandsHighlight=PerBufferData_o(),this.drawCommandsOccludees=PerBufferData_o(),this.drawCommandsShadowHighlightRest=PerBufferData_o()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(R,G){this.deleteInstance(R),this._instances.set(R,G),this._numElements+=G.numElements}deleteInstance(R){const G=this._instances.get(R);G&&(this._numElements-=G.numElements,this._instances.delete(R))}updateInstance(R,G,H){const W=this._instances.get(R);W&&(this._numElements-=W.numElements,W.from=G,W.to=H,this._numElements+=W.numElements)}updateDrawState(R){R.isVisible?(R.hasHighlights&&(this.hasHighlights=!0),R.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(R){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const G=this.drawCommandsDefault.pushNew(),H=this.holes.front();return null!=this.vao&&1===this.holes.length&&H.to===Math.floor(this.vao.byteSize/R)?(G.first=0,void(G.count=H.from)):(G.first=1/0,G.count=0,this._instances.forEach((R=>{G.first=Math.min(G.first,R.from),G.count=Math.max(G.count,R.to)})),void(G.count-=G.first))}const G=Array.from(this._instances.values()).sort(((R,G)=>R.from===G.from?R.to-G.to:R.from-G.from));for(const H of G)H.isVisible&&(PerBufferData_h(H.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,H),PerBufferData_h(H.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,H))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function PerBufferData_o(){return new pe.A({allocator:R=>R||new DrawCommand_t,deallocator:R=>R})}function PerBufferData_h(R,G){const H=R.back();if(null==H){const H=R.pushNew();return H.first=G.from,void(H.count=G.numElements)}if(function PerBufferData_r(R,G){return R.first+R.count>=G.from}(H,G)){const R=G.from-H.first+G.numElements;H.count=R}else{const H=R.pushNew();H.first=G.from,H.count=G.numElements}}class PerOriginData_s{constructor(R){this.origin=R,this.buffers=new Array}dispose(){this.buffers.forEach((R=>R.vao.dispose())),this.buffers.length=0}findBuffer(R){return this.buffers.find((G=>G.instances.has(R)))}}class MemCachePool_c{constructor(R,G){this._cache=R(G,((R,G,H)=>this._remove(R,G,H)))}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(R){return this._cache.getSize(R)}pop(R){const G=this._cache.peek(R);if(!G)return;const H=G.pop();if(G.length>0){if(H){const W=this._cache.getSize(R)-Math.round(H.usedMemory);this._cache.updateSize(R,G,W)}}else this._cache.pop(R);return H}put(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ye.Cn;const W=this._cache.peek(R);if(!W)return void this._cache.put(R,[G],G.usedMemory,H);W.push(G);const q=this._cache.getSize(R)+Math.round(G.usedMemory);this._cache.updateSize(R,W,q)}_remove(R,G,H){switch(G){case Ye.k2.ALL:return R.forEach((R=>R.dispose())),0;case Ye.k2.SOME:{const G=R.shift();return G&&(H-=Math.round(G.usedMemory),G.dispose()),H}}}}var jo=H(77127);class VertexArrayObject_r extends jo.Z{}var Wo=H(25078);class VaoCache_s{constructor(R,G,H){this._rctx=R,this._locations=G,this._layout=H,this._cache=new MemCachePool_c(R.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(R){const G=R.toString();let H=this._cache.pop(G);return H||(H=new VertexArrayObject_r(this._rctx,this._locations,{geometry:this._layout},{geometry:Wo.g.createVertex(this._rctx,Ft._U.STATIC_DRAW)}),H.vertexBuffers.geometry.setSize(R),H)}deleteVao(R){if(null==R)return;const G=R.byteSize.toString();this._cache.put(G,R)}}let ko=class extends qs.Ot{constructor(R){super(R),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=(0,Qe.WD)(this._glMaterials),this._dataByOrigin.forEach((R=>R.dispose())),this._dataByOrigin.clear(),this._vaoCache=(0,Qe.WD)(this._vaoCache)}initialize(){this.material.produces.forEach(((R,G)=>{this._produces.set(G,(G=>!(0===this._dataByOrigin.size||!(G!==En.V.Highlight&&G!==En.V.ShadowHighlight||this._hasHighlights))&&R(G)))}))}get produces(){return this._produces}initializeRenderContext(R,G){const{rctx:H}=R.renderContext;this._glMaterials=new GLMaterials_t(this.material,null!==G&&void 0!==G?G:R.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new VaoCache_s(H,this.material.vertexAttributeLocations,(0,Ho.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(R){return this.material.queryRenderOccludedState(R)}get materialReference(){return this.material}get numGeometries(){let R=0;return this._dataByOrigin.forEach((G=>R+=G.buffers.reduce(((R,G)=>R+G.instances.size),0))),R}get usedMemory(){let R=0;return this._dataByOrigin.forEach((G=>R+=G.buffers.reduce(((R,G)=>R+G.vao.usedMemory),0))),R}forEachGeometry(R){this._dataByOrigin.forEach((G=>G.buffers.forEach((G=>G.instances.forEach((G=>R(G.geometry)))))))}modify(R){this._updateGeometries(R.updates),this._addAndRemoveGeometries(R.adds,R.removes),this._updateDrawCommands()}_updateGeometries(R){const G=this._bufferWriter;if(null===G)return;const H=G.vertexBufferLayout.stride/4;for(const W of R){const R=W.renderGeometry,q=this._dataByOrigin.get(R.localOrigin.id),Q=null===q||void 0===q?void 0:q.findBuffer(R.id);if(null==Q)return;const J=Q.instances.get(R.id);if(W.updateType&(zo.GEOMETRY|zo.TRANSFORMATION)){const W=MergedRenderer_U(G.elementCount(J.geometry.geometry)*H),q=G.vertexBufferLayout.createView(W.buffer);this._writeGeometry(R,q,0),Q.vao.vertexBuffers.geometry.setSubData(W,J.from*H,0,J.numElements*H)}W.updateType&(zo.HIGHLIGHT|zo.OCCLUDEE|zo.VISIBILITY)&&(Q.drawCommandsDirty=!0)}}_computeDeltas(R,G){const H=new Bs.O;for(const W of R){const R=W.localOrigin;if(null==R)continue;let G=H.get(R.id,null);null==G&&(G=new MergedRenderer_S(R.vec3),H.set(R.id,null,G)),G.changes.push(W)}for(const W of G){const R=W.localOrigin;if(null==R)continue;const G=this._dataByOrigin.get(R.id),q=null===G||void 0===G?void 0:G.findBuffer(W.id);if(null==q)continue;let Q=H.get(R.id,q);null==Q&&(Q=new MergedRenderer_S(R.vec3),H.set(R.id,q,Q)),Q.changes.push(W)}return H}_addAndRemoveGeometries(R,G){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:H,_dataByOrigin:W}=this,q=H.vertexBufferLayout.stride/4,Q=this._computeDeltas(R,G);Q.forEach(((R,G)=>{const J=R.get(null),X=null!=J?J.changes:[];Q.delete(G,null);let $=W.get(G);if(R.forEach(((R,J)=>{if(Q.delete(G,J),null==J)return void(0,nr.vA)(!1,"No VAO for removed geometries");if(J.instances.size===R.changes.length)return this._vaoCache.deleteVao(J.vao),(0,ce.Xy)($.buffers,J),void(0===$.buffers.length&&0===X.length&&W.delete(G));const K=J.numElements,ee=J.vao.byteSize/4,te=X.reduce(((R,G)=>R+H.elementCount(G.geometry)),0),ie=R.changes.reduce(((R,G)=>R+H.elementCount(G.geometry)),0),re=Math.min((K+te-ie)*q,el),ne=re>ee;re>Jo&&re<ee/2?(R.changes.forEach((R=>{let{id:G}=R;return J.deleteInstance(G)})),J.instances.forEach((R=>{let{geometry:G}=R;return X.push(G)})),this._vaoCache.deleteVao(J.vao),(0,ce.Xy)($.buffers,J)):ne?this._applyAndRebuild(J,X,R):this._applyRemoves(J,R)})),X.length>0)for(null==$&&($=new PerOriginData_s(J.origin),W.set(G,$)),$.buffers.forEach((R=>this._applyAdds(R,X)));X.length>0;)$.buffers.push(this._applyAndRebuild(new PerBufferData_n,X,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((R=>{R.buffers.forEach((R=>{R.drawCommandsDirty&&(R.hasHiddenInstances=!1,R.hasHighlights=!1,R.hasOccludees=!1,(0,Ti.Bs)(R.instances,(G=>(R.updateDrawState(G),R.hasHiddenInstances&&R.hasHighlights&&R.hasOccludees))),R.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||R.hasHighlights,this._hasOccludees=this._hasOccludees||R.hasOccludees}))}))}_applyAndRebuild(R,G,H){if(null!=H)for(const re of H.changes)R.deleteInstance(re.id);const W=this._bufferWriter,q=W.vertexBufferLayout.stride,Q=q/4,J=Math.floor(el/Q);let X=R.numElements;for(;G.length>0;){const H=G.pop(),q=W.elementCount(H.geometry);if(X+q>J&&X>0){G.push(H);break}X+=q;const Q=new Instance_s(H,0,0);(0,nr.vA)(null==R.instances.get(H.id)),R.addInstance(H.id,Q)}const $=X*Q,K=MergedRenderer_U($),ee=W.vertexBufferLayout.createView(K.buffer);let te=0;R.hasHiddenInstances=!1,R.hasHighlights=!1,R.hasOccludees=!1,R.instances.forEach(((G,H)=>{this._writeGeometry(G.geometry,ee,te);const q=te;te+=W.elementCount(G.geometry.geometry),R.updateInstance(H,q,te),R.updateDrawState(G)})),this._vaoCache.deleteVao(R.vao),R.vao=this._vaoCache.newVao(MergedRenderer_q($)),R.vao.vertexBuffers.geometry.setSubData(K,0,0,te*Q),R.holes.clear();const ie=R.holes.pushNew();return ie.from=te,ie.to=Math.floor(R.vao.byteSize/q),R.updateDrawCommands(q),R}_applyRemoves(R,G){if(0===G.changes.length||null===this._bufferWriter)return;for(const J of G.changes){const G=J.id,H=R.instances.get(G);if(!H)continue;R.deleteInstance(G);const W=Yo.back();if(W){if(W.to===H.from){W.to=H.to;continue}if(W.from===H.to){W.from=H.from;continue}}const q=Yo.pushNew();q.from=H.from,q.to=H.to}BufferRange_o(Yo);const H=this._bufferWriter.vertexBufferLayout.stride/4,W=Yo.reduce(((R,G)=>Math.max(R,G.numElements)),0)*H,q=MergedRenderer_U(W);q.fill(0,0,W);const Q=R.vao.vertexBuffers.geometry;Yo.forAll((R=>Q.setSubData(q,R.from*H,0,R.numElements*H))),R.holes.pushArray(Yo.data,Yo.length),Yo.forAll(((R,G)=>Yo.data[G]=null)),Yo.clear(),R.drawCommandsDirty=!0}_applyAdds(R,G){if(0===G.length||null===this._bufferWriter)return;if(!function PerBufferData_a(R){return null!=R.vao}(R))return void this._applyAndRebuild(R,G,null);const H=this._bufferWriter,W=H.vertexBufferLayout.stride/4,q=R.numElements,Q=G.reduce(((R,G)=>R+H.elementCount(G.geometry)),0),J=Math.min((q+Q)*W,el),X=4*J;if(R.vao.byteSize<MergedRenderer_q(el-Jo)&&X>R.vao.byteSize)return void this._applyAndRebuild(R,G,null);BufferRange_o(R.holes);const $=new Array;for(const ae of G){const G=H.elementCount(ae.geometry),W=MergedRenderer_x(R.holes,G);$.push(W)}const K=R.vao.vertexBuffers.geometry;let ee=0,te=0,ie=0;const re=MergedRenderer_U(J),ne=H.vertexBufferLayout.createView(re.buffer);G.forEach(((G,q)=>{const Q=$[q];if(null==Q)return;if(ie!==Q){const R=ie-te;R>0&&K.setSubData(re,te*W,0,R*W),te=Q,ee=0}const J=H.elementCount(G.geometry);this._writeGeometry(G,ne,ee),ee+=J,ie=Q+J;const X=new Instance_s(G,Q,Q+J);(0,nr.vA)(null==R.instances.get(G.id)),R.addInstance(G.id,X),R.drawCommandsDirty=!0}));const se=ie-te;se>0&&K.setSubData(re,te*W,0,se*W),(0,ce.$i)(G,((R,G)=>null==$[G]))}_writeGeometry(R,G,H){if(null===this._bufferWriter)return;const W=R.localOrigin.vec3;(0,nr.M_)(qo,-W[0],-W[1],-W[2]);const q=(0,ye.lw)(Zo,qo,R.transformation);(0,ye.B8)(Qo,q),(0,ye.mg)(Qo,Qo),this._bufferWriter.write(q,Qo,R.geometry,G,H)}updateAnimation(R){return this.material.update(R)}prepareTechnique(R){if(!this.material.shouldRender(R))return null;const{output:G,bindParameters:H}=R,W=this.material.produces.get(H.slot);if(!W||!W(G))return null;const q=G===En.V.Highlight||G===En.V.ShadowHighlight;if(q&&!this._hasHighlights)return null;const Q=G===En.V.ShadowExcludeHighlight,J=!(q||Q);for(const X of this._dataByOrigin.values())for(const W of X.buffers){if(q&&!W.hasHighlights)continue;const X=(q?W.drawCommandsHighlight:Q&&W.needsMultipleCommands()?W.drawCommandsShadowHighlightRest:W.drawCommandsDefault)||null,$=J&&W.drawCommandsOccludees||null;if(null!==X&&void 0!==X&&X.length||null!==$&&void 0!==$&&$.length){const W=this._glMaterials.load(R.rctx,H.slot,G),q=null!=W?W.beginSlot(H):null;if(null!=q)return q}}return null}renderNode(R,G){const{output:H,bindParameters:W}=R,q=H===En.V.Highlight||H===En.V.ShadowHighlight,Q=H===En.V.ShadowExcludeHighlight,J=!(q||Q),X=R.rctx,$=R.bindParameters.slot===Mn.N.OCCLUDER_MATERIAL,K=R.bindParameters.slot===Mn.N.TRANSPARENT_OCCLUDER_MATERIAL;X.runAppleAmdDriverHelper(),X.bindTechnique(G,W,this.material.parameters);for(const ee of this._dataByOrigin.values())for(const R of ee.buffers){if(q&&!R.hasHighlights)continue;const H=(q?R.drawCommandsHighlight:Q&&R.needsMultipleCommands()?R.drawCommandsShadowHighlightRest:R.drawCommandsDefault)||null,te=J&&R.drawCommandsOccludees||null;(null!==H&&void 0!==H&&H.length||null!==te&&void 0!==te&&te.length)&&(G.program.bindDraw(new DrawParameters_s(ee.origin),W,this.material.parameters),G.ensureAttributeLocations(R.vao),X.bindVAO(R.vao),null!==H&&void 0!==H&&H.length&&(X.setPipelineState(G.getPipeline(!1,$,K)),H.forAll((R=>X.drawArrays(G.primitiveType,R.first,R.count)))),(null===te||void 0===te?void 0:te.length)&&(X.setPipelineState(G.getPipeline(!0,$,K)),te.forAll((R=>X.drawArrays(G.primitiveType,R.first,R.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],ko.prototype,"material",void 0),ko=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],ko);class MergedRenderer_S{constructor(R){this.origin=R,this.changes=new Array}}function MergedRenderer_x(R,G){let H;if(!R.some((R=>!(R.numElements<G)&&(H=R,!0))))return null;const W=H.from;return H.from+=G,H.from>=H.to&&R.removeUnordered(H),W}const qo=(0,ve.vt)(),Zo=(0,ve.vt)(),Qo=(0,ve.vt)(),Yo=new pe.A({allocator:R=>R||new BufferRange_t,deallocator:null}),Jo=65536,Xo=4*Jo,$o=1024,Ko=16777216,el=Ko/4;let tl=new Float32Array(Jo);function MergedRenderer_U(R){return tl.length<R&&(tl=new Float32Array(R)),tl}function MergedRenderer_q(R){const G=4*R;return G<=$o?$o:G<Xo?(0,Ee.cU)(G):Math.max(Math.min(Math.ceil(1.5*G/Xo)*Xo,Ko),G)}let il=class extends Q.A{constructor(R){super(R),this._pending=new SortedRenderGeometryRenderer_G,this._changes=new ChangeSet_s,this._materialRenderers=new pe.A,this._sortedMaterialRenderers=new pe.A,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll((R=>R.destroy())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return this._materialRenderers.some((R=>0!==R.numGeometries&&!R.queryRenderOccludedState(Pn.m$.Occlude)))}get isEmpty(){return!this.updating&&0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(R){var G;if(null==R)return 0;const H=this._materialRenderers.find((G=>G.materialReference===R));return null!==(G=null===H||void 0===H?void 0:H.usedMemory)&&void 0!==G?G:0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const R=function rendererUtils_t(R){const G=new Map,o=R=>{let H=G.get(R);return H||(H=new ChangeSet_t,G.set(R,H)),H};return R.removes.forAll((R=>{rendererUtils_n(R)&&o(R.material).removes.push(R)})),R.adds.forAll((R=>{rendererUtils_n(R)&&o(R.material).adds.push(R)})),R.updates.forAll((R=>{rendererUtils_n(R.renderGeometry)&&o(R.renderGeometry.material).updates.push(R)})),G}(this._changes);let G=!1;return R.forEach(((R,H)=>{let W=this._materialRenderers.find((R=>R.materialReference===H));if(!W&&R.adds.length>0){const R=new ko({material:H});R.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),W=R,this._materialRenderers.push(W),G=!0}W&&(W.modify(R),0===W.numGeometries&&(this._materialRenderers.removeUnordered(W),W.destroy(),G=!0))})),this._changes.clear(),G&&this._updateSortedMaterialRenderers(),this._hasHighlights=this._materialRenderers.some((R=>{const G=R.produces.get(Mn.N.DRAPED_MATERIAL);return!!G&&G(En.V.Highlight)})),this._hasWater=this._materialRenderers.some((R=>{const G=R.produces.get(Mn.N.DRAPED_WATER);return!!G&&G(En.V.Normal)})),this.notifyChange("updating"),!0}addGeometries(R,G){if(0===R.length)return;const H=this._validateRenderGeometries(R);for(const q of H)this._geometries.set(q.id,q);const W=this._pending.empty;for(const q of H)this._pending.adds.add(q);W&&this.notifyChange("updating"),G===Go.UPDATE&&this._notifyGraphicGeometryChanged(R)}removeGeometries(R,G){const H=this._pending.empty,W=this._pending.adds;for(const q of R)W.has(q)?(this._pending.removed.add(q),W.delete(q)):this._pending.removed.has(q)||this._pending.removes.add(q),this._geometries.delete(q.id);H&&!this._pending.empty&&this.notifyChange("updating"),G===Go.UPDATE&&this._notifyGraphicGeometryChanged(R)}modifyGeometries(R,G){const H=0===this._changes.updates.length;for(const W of R){const R=this._changes.updates.pushNew();R.renderGeometry=this._validateRenderGeometry(W),R.updateType=G}switch(H&&this._changes.updates.length>0&&this.notifyChange("updating"),G){case zo.TRANSFORMATION:case zo.GEOMETRY:return this._notifyGraphicGeometryChanged(R);case zo.VISIBILITY:return this._notifyGraphicVisibilityChanged(R)}}updateAnimation(R){let G=!1;return this._sortedMaterialRenderers.forAll((H=>G=!!H.updateAnimation&&H.updateAnimation(R)||G)),G}shouldRender(R){return this._sortedMaterialRenderers.some((G=>G.prepareTechnique(R)))}render(R){this._sortedMaterialRenderers.forAll((G=>{const H=G.prepareTechnique(R);null!=H&&G.renderNode(R,H)}))}intersect(R,G,H,W,q){return this._geometries.forEach((Q=>{if(W&&!W(Q))return;this._intersectRenderGeometry(Q,H,G,0,R,q);const J=this.rendererContext.longitudeCyclical;J&&(Q.boundingSphere[0]-Q.boundingSphere[3]<J.min&&this._intersectRenderGeometry(Q,H,G,J.range,R,q),Q.boundingSphere[0]+Q.boundingSphere[3]>J.max&&this._intersectRenderGeometry(Q,H,G,-J.range,R,q)),q++})),q}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll(((R,G)=>{R.drapedPriority=G,this._sortedMaterialRenderers.push(R)})),this._sortedMaterialRenderers.sort(((R,G)=>{var H,W,q,Q;return(null===(H=G.materialReference)||void 0===H?void 0:H.renderPriority)===(null===(W=R.materialReference)||void 0===W?void 0:W.renderPriority)?R.drapedPriority-G.drapedPriority:((null===(q=G.materialReference)||void 0===q?void 0:q.renderPriority)||0)-((null===(Q=R.materialReference)||void 0===Q?void 0:Q.renderPriority)||0)}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let R=0;R<this._changes.updates.length;){const G=this._changes.updates.data[R];this._pending.has(G.renderGeometry)?this._changes.updates.removeUnorderedIndex(R):R++}this._pending.clear()}_intersectRenderGeometry(R,G,H,W,q,Q){if(!R.visible)return;let J=0;W+=R.transformation[12],J=R.transformation[13],rl[0]=H[0]-W,rl[1]=H[1]-J,R.screenToWorldRatio=this.rendererContext.screenToWorldRatio,R.material.intersectDraped(R,null,q,rl,((H,W,J)=>{!function SortedRenderGeometryRenderer_v(R,G,H,W,q,Q,J){const X=new Intersector_i(Q,J,G),h=G=>{G.set(xo.OVERLAY,X,R.dist,R.normal,R.transformation,H,W)};if((null==q.results.min.drapedLayerOrder||H>=q.results.min.drapedLayerOrder)&&(null==q.results.min.dist||q.results.ground.dist<=q.results.min.dist)&&h(q.results.min),q.options.store!==So.MIN&&(null==q.results.max.drapedLayerOrder||H<q.results.max.drapedLayerOrder)&&(null==q.results.max.dist||q.results.ground.dist>q.results.max.dist)&&h(q.results.max),q.options.store===So.ALL){const R=Intersector_G(q.ray);h(R),q.results.all.push(R)}}(G,J,Q,R.material.renderPriority,q,R.layerUid,R.graphicUid)}),G)}_notifyGraphicGeometryChanged(R){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let G;for(const H of R){const R=H.graphicUid;null!=R&&R!==G&&(this.drapeSource.notifyGraphicGeometryChanged(R),G=R)}}_notifyGraphicVisibilityChanged(R){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let G;for(const H of R){const R=H.graphicUid;null!=R&&R!==G&&(this.drapeSource.notifyGraphicVisibilityChanged(R),G=R)}}_validateRenderGeometries(R){for(const G of R)this._validateRenderGeometry(G);return R}_validateRenderGeometry(R){return null==R.localOrigin&&(R.localOrigin=this._localOriginFactory.getOrigin((0,Ge.g)(R.boundingSphere))),R}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,W._)([(0,ee.MZ)()],il.prototype,"drapeSource",void 0),(0,W._)([(0,ee.MZ)()],il.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],il.prototype,"rctx",null),(0,W._)([(0,ee.MZ)({constructOnly:!0})],il.prototype,"rendererContext",void 0),(0,W._)([(0,ee.MZ)()],il.prototype,"_materialRepository",null),(0,W._)([(0,ee.MZ)()],il.prototype,"_localOriginFactory",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],il.prototype,"isEmpty",null),(0,W._)([(0,ee.MZ)()],il.prototype,"_materialRenderers",void 0),(0,W._)([(0,ee.MZ)()],il.prototype,"_geometries",void 0),il=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],il);class SortedRenderGeometryRenderer_G{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(R){return this.adds.has(R)||this.removes.has(R)||this.removed.has(R)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const rl=(0,Xi.vt)();class TextureTechnique_m extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,TextureTechnique_m.shader.get().build(),Fn.D)}initializePipeline(){return this.configuration.hasAlpha?(0,Un.Ey)({blending:(0,Un.p3)(Ft.dn.SRC_ALPHA,Ft.dn.ONE,Ft.dn.ONE_MINUS_SRC_ALPHA,Ft.dn.ONE_MINUS_SRC_ALPHA),colorWrite:Un.wE}):(0,Un.Ey)({colorWrite:Un.wE})}}TextureTechnique_m.shader=new Dn.$(zs.a,(()=>H.e(1073).then(H.bind(H,1073))));class TextureTechniqueConfiguration_r extends Gn.K{constructor(){super(...arguments),this.hasAlpha=!1}}(0,W._)([(0,Gn.W)()],TextureTechniqueConfiguration_r.prototype,"hasAlpha",void 0);var nl=H(9387),sl=H(30789);class OverlayCompositingTechnique_n extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,OverlayCompositingTechnique_n.shader.get().build(),Fn.D)}initializePipeline(){return(0,Un.Ey)({blending:(0,Un.ox)(Ft.dn.ONE,Ft.dn.ONE_MINUS_SRC_ALPHA),colorWrite:Un.wE})}}OverlayCompositingTechnique_n.shader=new Dn.$(sl.a,(()=>H.e(8971).then(H.bind(H,48971))));var al=H(83881);let ol=class extends qs.RW{constructor(R){super(R),this._overlays=null,this._renderTargets=null,this._overlayParameters=new sl.O,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new pe.A,this._passParameters=new zs.T,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Qs,this.worldToPCSRatio=1,this.events=new Vr.A,this.longitudeCyclical=null,this.produces=new Map([[Mn.N.DRAPED_MATERIAL,R=>R!==En.V.Highlight||this.hasHighlights],[Mn.N.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const R=this.view._stage.renderer.fboCache,G=this.view._stage.renderView,{waterTextures:H,stippleTextures:W,markerTextures:q}=G;this._shaderTechniques=new ShaderTechniqueRepository_r({rctx:this._rctx,viewingMode:qe.RT.Local,stippleTextureRepository:W,markerTextureRepository:q,waterTextureRepository:H}),this._renderContext=new RenderContext_a(this._rctx,new ShadowMap_X(R,this.view.state.viewingMode),null),this.addHandles([(0,$.wB)((()=>H.updating),(()=>this.events.emit("content-changed")),$.pc),(0,$.wB)((()=>this.spatialReference),(R=>this._localOriginFactory=new GridLocalOriginFactory_(R)),$.pc),(0,$.on)((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new GLMaterialRepository_s(G.textureRepository,this._shaderTechniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=Mn.N.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=pa.y.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new nl.$p((0,xe.fA)(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(ot.W6.STAGE,this))}destroy(){this._renderers.forEach((R=>R.destroy())),this._renderers.clear(),this._debugTextureTechnique=(0,Qe.Gz)(this._debugTextureTechnique),this._passParameters.texture=(0,Qe.WD)(this._passParameters.texture),this._shaderTechniques=(0,Qe.pR)(this._shaderTechniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(R){this.pluginContext=R}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||(0,Ti.Bs)(this._renderers,(R=>R.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMemoryForMaterial(R){return Array.from(this._renderers.values()).reduce(((G,H)=>G+H.getMemoryForMaterial(R)),0)}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((R=>R.drapeSource.layer)).filter((R=>!!R))}createGeometryDrapeSourceRenderer(R){return this.createDrapeSourceRenderer(R,il)}createDrapeSourceRenderer(R,G,H){const W=this._renderers.get(R);null!=W&&W.destroy();const q=new G({...H,rendererContext:this,drapeSource:R});return this._renderers.set(R,q),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in R&&this.addHandles((0,$.wB)((()=>R.fullOpacity),(()=>this.events.emit("content-changed"))),R),q}removeDrapeSourceRenderer(R){if(null==R)return;const G=this._renderers.get(R);null!=G&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(R),this.removeHandles(R),G.destroy())}computeValidity(){var R,G;return null!==(R=null===(G=this._renderTargets)||void 0===G?void 0:G.computeValidity())&&void 0!==R?R:0}releaseRenderTargets(){var R;null===(R=this._renderTargets)||void 0===R||R.dispose()}get overlays(){var R;return null!==(R=this._overlays)&&void 0!==R?R:[]}ensureDrapeTargets(R){this._hasTargetWithoutRasterImage=!!this._overlays&&(0,Es.bw)(R,(R=>R.drapeTargetType===As.WithoutRasterImage))}ensureDrapeSources(R){this._overlays?(this._hasDrapedFeatureSource=(0,Es.bw)(R,(R=>R.drapeSourceType===Cs.Features)),this._hasDrapedRasterSource=(0,Es.bw)(R,(R=>R.drapeSourceType===Cs.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._bindParameters.overlayStretch;null==this._overlays&&(this._renderTargets=new OverlayRenderTargets_s(this.view._stage.renderer.fboCache),this._overlays=[new Overlay_n,new Overlay_n]),this.ensureDrapeTargets(R),this.ensureDrapeSources(G),this._bindParameters.overlayStretch=H}disposeOverlays(){this._overlays=null,this._renderTargets=(0,Qe.WD)(this._renderTargets),this.events.emit("textures-disposed")}getTexture(R){var G,H;if(null!=R)return R===Os.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?null===(G=this._renderTargets)||void 0===G?void 0:G.getTexture(Os.Color):null===(H=this._renderTargets)||void 0===H?void 0:H.getTexture(R)}get running(){return this.updating}runTask(R){this._processDrapeSources(R,(()=>!0))}_processDrapeSources(R,G){let H=!1;for(const[W,q]of this._renderers){if(R.done)break;(W.destroyed||G(W))&&q.commitChanges()&&(H=!0,R.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,H=!0,this._updateSortedDrapeSourceRenderers()),H&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=(0,Ti.Bs)(this._renderers,(R=>R.hasHighlights)),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(ot.Bb,(R=>R.updatePolicy===sa.SYNC))}get isEmpty(){return!qr.b.OVERLAY_DRAW_DEBUG_TEXTURE&&!(0,Ti.Bs)(this._renderers,(R=>!R.isEmpty))}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const R=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=cl;const G=this._sortedRenderers.some((R=>{let{renderer:G}=R;return G.shouldRender(this._renderContext)}));return this._renderContext.renderOccludedMask=R,G}renders(R){return qr.b.OVERLAY_DRAW_DEBUG_TEXTURE&&R!==Os.Occluded||this._sortedRenderers.some((R=>{let{renderer:G}=R;return G.shouldRender(this._renderContext)}))}get mode(){var R,G;return this.isEmpty?Us.Disabled:null!==(R=this._renderTargets)&&void 0!==R&&R.getTexture(Os.WaterNormal)?Us.EnabledWithWater:null!==(G=this._renderTargets)&&void 0!==G&&G.getTexture(Os.Color)?Us.Enabled:Us.Disabled}updateAnimation(R){let G=!1;return this._renderers.forEach((H=>G=H.updateAnimation(R)||G)),G}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(R){if(this._overlays&&this._renderTargets){for(const R of this._overlays)this.longitudeCyclical?R.setupGeometryViewsCyclical(this.longitudeCyclical):R.setupGeometryViewsDirect();for(const G of this._renderTargets.targets){if(G.content===Os.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const H=this._drawTarget(Ms.vr.INNER,G,R),W=this._drawTarget(Ms.vr.OUTER,G,R);(H||W)&&G.fbo.generateMipMap()}}}_drawTarget(R,G,H){const W=this._overlays[R],q=W.canvasGeometries;if(0===q.numViews)return!1;const{alignPixelEnabled:Q,contentPixelRatio:J}=H;this._screenToWorldRatio=J*W.mapUnitsPerPixel/this._bindParameters.overlayStretch;const X=G.output;if(this.isEmpty||X===En.V.Highlight&&!this.hasHighlights||X===En.V.Normal&&!this.hasWater||!W.hasSomeSizedView())return!1;const $=this._rctx;if(this._camera.pixelRatio=W.pixelRatio*J,this._renderContext.output=X,this._bindParameters.alignPixelEnabled=Q,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=X===En.V.Normal?Mn.N.DRAPED_WATER:Mn.N.DRAPED_MATERIAL,G.content===Os.Occluded&&(this._renderContext.renderOccludedMask=cl),!this.renders(G.content))return this._renderContext.renderOccludedMask=ka,!1;const K=W.resolution;this._rctx.setViewport(R===Ms.vr.INNER?0:K,0,K,K);const ee=2*W.resolution,te=W.resolution,ie=G.fbo;if(ie.bind($,ee,te),R===Ms.vr.INNER&&($.setClearColor(0,0,0,0),$.clearSafe(Ft.hn.COLOR_BUFFER_BIT)),qr.b.OVERLAY_DRAW_DEBUG_TEXTURE&&G.content!==Os.Occluded)for(let re=0;re<q.numViews;re++)this._setViewParameters(q.extents[re],W),this._ensureDebugPatternResources(W.resolution,ll[R]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll((H=>{let{drapeSource:Q,renderer:J}=H;if(G.content===Os.ColorNoRasterImage&&Q.drapeSourceType===Cs.RasterImage)return;const{fullOpacity:K}=Q,re=null!=K&&K<1&&X===En.V.Color?this.bindTemporaryFramebuffer(ee,te):null;for(let R=0;R<q.numViews;R++)this._setViewParameters(q.extents[R],W),J.render(this._renderContext);if(re){ie.bind($,ee,te),this._overlayParameters.texture=re.getTexture(),this._overlayParameters.opacity=K,this._overlayParameters.overlayIndex=R;const G=this.pluginContext.techniqueRepository.acquire(OverlayCompositingTechnique_n);this._rctx.bindTechnique(G,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),G.release(),re.release()}})),$.bindFramebuffer(null),this._renderContext.renderOccludedMask=ka,!0}bindTemporaryFramebuffer(R,G){const H=this.view._stage.renderer.fboCache,W=H.acquire(R,G,"overlay tmp");return H.rctx.unbindTexture(W.fbo.colorTexture),H.rctx.bindFramebuffer(W.fbo),H.rctx.clearSafe(Ft.hn.COLOR_BUFFER_BIT),W}async reloadShaders(){await this._shaderTechniques.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(R,G,H,W){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let q=0;for(const{renderer:X}of this._sortedRenderers){var Q,J;q=null!==(Q=null===(J=X.intersect)||void 0===J?void 0:J.call(X,R,G,H,W,q))&&void 0!==Q?Q:q}}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const R=this.view.map.allLayers,G=R.length;this._renderers.forEach(((H,W)=>{var q;const Q=R.indexOf(W.layer),J=Q>=0,X=null!==(q=W.renderGroup)&&void 0!==q?q:J?ws.MapLayer:ws.ViewLayer,$=G*X+(J?Q:0);this._sortedRenderers.push(new OverlayRenderer_ee(W,H,$))})),this._sortedRenderers.sort(((R,G)=>R.index-G.index))}_setViewParameters(R,G){const H=this._camera;H.viewport=[0,0,G.resolution,G.resolution],(0,ye.v3)(H.projectionMatrix,0,R[2]-R[0],0,R[3]-R[1],H.near,H.far),(0,ye.kN)(H.viewMatrix,[-R[0],-R[1],0])}_updateHasWater(){const R=(0,Ti.Bs)(this._renderers,(R=>R.hasWater));R!==this._hasWater&&(this._hasWater=R,this.events.emit("has-water",R))}_ensureDebugPatternResources(R,G){if((0,be.s)(this._passParameters.color,G[0],G[1],G[2]),this._passParameters.texture)return;const H=new Uint8Array(R*R*4);let W=0;for(let J=0;J<R;J++)for(let G=0;G<R;G++){const q=Math.floor(G/10),Q=Math.floor(J/10);q<2||Q<2||10*q>R-20||10*Q>R-20?(H[W++]=255,H[W++]=255,H[W++]=255,H[W++]=255):(H[W++]=255,H[W++]=255,H[W++]=255,H[W++]=1&q&&1&Q?1&G^1&J?0:255:1&q^1&Q?0:128)}const q=new al.R(R);q.samplingMode=Ft.Cj.NEAREST,this._passParameters.texture=new Qa.g(this._rctx,q,H);const Q=new TextureTechniqueConfiguration_r;Q.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniques.acquire(TextureTechnique_m,Q)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),sortedDrapeSources:Array.from(this._sortedRenderers).map((R=>{let{drapeSource:G}=R;return G})),getDrapeSourceRenderer:R=>this._renderers.get(R)}}};(0,W._)([(0,ee.MZ)()],ol.prototype,"hasHighlights",void 0),(0,W._)([(0,ee.MZ)()],ol.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,W._)([(0,ee.MZ)()],ol.prototype,"_shaderTechniques",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],ol.prototype,"view",void 0),(0,W._)([(0,ee.MZ)()],ol.prototype,"worldToPCSRatio",void 0),(0,W._)([(0,ee.MZ)()],ol.prototype,"spatialReference",void 0),(0,W._)([(0,ee.MZ)({type:Boolean,readOnly:!0})],ol.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],ol.prototype,"isEmpty",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],ol.prototype,"rendersOccludedDraped",null),ol=(0,W._)([(0,ie.$)("esri.views.3d.terrain.OverlayRenderer")],ol);class OverlayRenderer_ee{constructor(R,G,H){this.drapeSource=R,this.renderer=G,this.index=H}}const ll=[[1,.5,.5],[.5,.5,1]],cl=Pn.m$.OccludeAndTransparent;function polygon_p(R,G,H,W){const q=(0,Ts.jp)(R.rings,!!R.hasZ&&"on-the-ground"!==W.mode,Ts.Wq.CCW_IS_HOLE,R.spatialReference),Q=(0,Ne.jh)(q.position.length),J=elevationAlignmentUtils_u(q.position,R.spatialReference,0,Q,0,q.position,0,q.position.length/3,G,H,W),X=null!=J;return new polygon_f(q.position,Q,polygon_u(q.polygons,q.position,Q),polygon_l(q.outlines,q.position,Q),X,J)}function polygon_c(R,G){const H=(0,Ts.jp)(R.rings,!1,Ts.Wq.CCW_IS_HOLE),W=(0,Ie.projectBuffer)(H.position,R.spatialReference,0,H.position,G,0,H.position.length/3);for(let q=2;q<H.position.length;q+=3)H.position[q]=-2;return{position:H.position,polygons:polygon_u(H.polygons,H.position),outlines:polygon_l(H.outlines,H.position),projectionSuccess:W}}function polygon_l(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return R.filter((R=>{let{count:G}=R;return G>1})).map((R=>{let{index:W,count:q}=R;const Q=3*W,J=3*q;return null!=H?new polygon_a(W,q,(0,Ne.l5)(G,Q,J),(0,Ne.l5)(H,Q,J)):new polygon_h(W,q,(0,Ne.l5)(G,Q,J))}))}function polygon_u(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const W=new Array;for(const{index:q,count:Q,holeIndices:J,pathLengths:X}of R){if(Q<=1)continue;const R=3*q,$=3*Q,K=J.map((R=>R-q)),ee=null!=H?new polygon_g(q,Q,(0,Ne.l5)(G,3*q,3*Q),(0,Ne.l5)(H,R,$),K,X):new polygon_m(q,Q,(0,Ne.l5)(G,3*q,3*Q),K,X);W.push(ee)}return W}class polygon_h{constructor(R,G,H){this.index=R,this.count=G,this.position=H}}class polygon_a extends polygon_h{constructor(R,G,H,W){super(R,G,H),this.mapPositions=W}}class polygon_g extends polygon_a{constructor(R,G,H,W,q,Q){super(R,G,H,W),this.holeIndices=q,this.pathLengths=Q}}class polygon_m extends polygon_h{constructor(R,G,H,W,q){super(R,G,H),this.holeIndices=W,this.pathLengths=q}}class polygon_f{constructor(R,G,H,W,q,Q){this.position=R,this.mapPositions=G,this.polygons=H,this.outlines=W,this.projectionSuccess=q,this.sampledElevation=Q}}var dl=H(54350),hl=H(78368);const ul=["polygon","extent"];function Graphics3DExtrudeSymbolLayer_ee(R,G,H,W,q,Q){const J=(0,Ue.EH)(G.length),X=[[Wt.r.POSITION,new tr.n(W.positions,G,3,!0)],[Wt.r.NORMALCOMPRESSED,new tr.n(W.normals,G,2,!0)],[Wt.r.COLOR,new tr.n(q,J,4,!0)]];return new rr.V(R,X,W.elevation,ir.X.Mesh,Q,H)}function Graphics3DExtrudeSymbolLayer_te(R,G,H,W,q,Q,J,X,$,K,ee,te,ie){const re=H.length/3;let ne=0,se=2*W.count;!function Graphics3DExtrudeSymbolLayer_re(R,G,H,W,q,Q,J,X,$,K,ee,te,ie,re,ne,se,ae){(0,be.c)(xl,se);const oe=ne>0?1:-1;let le=3*H,ce=0,de=3*ce,he=W,ue=3*he;for(let me=0;me<W;++me)ae&&(xl[0]=R[le],xl[1]=R[le+1],xl[2]=R[le+2],(0,be.n)(xl,xl)),X[de]=R[le],X[de+1]=R[le+1],X[de+2]=R[le+2],$[de]=G[le],$[de+1]=G[le+1],$[de+2]=G[le+2],K[de]=-oe*xl[0],K[de+1]=-oe*xl[1],K[de+2]=-oe*xl[2],ee[ce]=0,X[ue]=R[le]+ne*xl[0],X[ue+1]=R[le+1]+ne*xl[1],X[ue+2]=R[le+2]+ne*xl[2],$[ue]=G[le],$[ue+1]=G[le+1],$[ue+2]=G[le+2],K[ue]=oe*xl[0],K[ue+1]=oe*xl[1],K[ue+2]=oe*xl[2],ee[he]=ne,de+=3,ue+=3,le+=3,ce+=1,he+=1;le=3*Q,de=0,ue=3*re;const pe=ne<0?wl:Cl,_e=ne<0?Cl:wl;for(let me=0;me<J;++me)ie[de]=q[le+pe[0]],ie[de+1]=q[le+pe[1]],ie[de+2]=q[le+pe[2]],te[ue]=q[le+_e[0]]+W,te[ue+1]=q[le+_e[1]]+W,te[ue+2]=q[le+_e[2]]+W,de+=3,ue+=3,le+=3}(R,G,W.index,W.count,H,0,re,q,Q,J,X,$,K,se,ee,te,ie);let ae=2*W.count;se=0,Graphics3DExtrudeSymbolLayer_ne(q,Q,X,J,ne,W.pathLengths[0],W.count,ae,$,se,ee),ae+=4*W.pathLengths[0],se+=2*W.pathLengths[0],ne+=W.pathLengths[0];for(let oe=1;oe<W.pathLengths.length;++oe)Graphics3DExtrudeSymbolLayer_ne(q,Q,X,J,ne,W.pathLengths[oe],W.count,ae,$,se,ee),ae+=4*W.pathLengths[oe],se+=2*W.pathLengths[oe],ne+=W.pathLengths[oe]}function Graphics3DExtrudeSymbolLayer_se(R,G,H,W,q,Q,J){W[Q]=W[J],J*=3,R[Q*=3]=R[J],R[Q+1]=R[J+1],R[Q+2]=R[J+2],G[Q]=G[J],G[Q+1]=G[J+1],G[Q+2]=G[J+2],H[Q]=q[0],H[Q+1]=q[1],H[Q+2]=q[2]}const pl=(0,xe.vt)();function Graphics3DExtrudeSymbolLayer_ne(R,G,H,W,q,Q,J,X,$,K,ee){let te=q,ie=q+1,re=q+J,ne=q+J+1,se=X,ae=X+1,oe=X+2*Q,le=X+2*Q+1;ee<0&&(te=q+J+1,ne=q),K*=3;for(let ce=0;ce<Q;++ce)ce===Q-1&&(ee>0?(ie=q,ne=q+J):(ie=q,te=q+J)),Graphics3DExtrudeSymbolLayer_he(R,te,ie,re,pl),Graphics3DExtrudeSymbolLayer_se(R,G,W,H,pl,se,te),Graphics3DExtrudeSymbolLayer_se(R,G,W,H,pl,ae,ie),Graphics3DExtrudeSymbolLayer_se(R,G,W,H,pl,oe,re),Graphics3DExtrudeSymbolLayer_se(R,G,W,H,pl,le,ne),$[K++]=se,$[K++]=oe,$[K++]=le,$[K++]=se,$[K++]=le,$[K++]=ae,te++,ie++,re++,ne++,se+=2,ae+=2,oe+=2,le+=2}const _l=(0,xe.vt)(),ml=(0,xe.vt)(),gl=(0,xe.vt)(),fl=(0,xe.vt)(),yl=(0,xe.vt)();function Graphics3DExtrudeSymbolLayer_he(R,G,H,W,q){G*=3,H*=3,W*=3,(0,be.s)(_l,R[G++],R[G++],R[G++]),(0,be.s)(ml,R[H++],R[H++],R[H++]),(0,be.s)(gl,R[W++],R[W++],R[W++]),(0,be.f)(fl,ml,_l),(0,be.f)(yl,gl,_l),(0,be.b)(q,yl,fl),(0,be.n)(q,q)}const vl=(0,xe.vt)();const bl=(0,xe.vt)(),xl=(0,xe.vt)(),Sl=new elevationAlignmentUtils_R,Cl=[0,2,1],wl=[0,1,2],Al=.01;var Rl;!function(R){R[R.Main=0]="Main",R[R.Bottom=1]="Bottom"}(Rl||(Rl={}));class Graphics3DExtrudeSymbolLayer_je{constructor(R,G,H,W){this.positions=R,this.elevation=G,this.normals=H,this.heights=W}}var Tl=H(4389),El=H(8809),Ol=H(85060),Pl=H(3067),Ml=H(29304),Il=H(4341),Dl=H(35775),Ll=H(80047),Fl=H(37517);const Nl=Ce.uY,Vl=4;class Graphics3DDrapedGraphicLayer_l{constructor(R,G,H,W){this.graphics3DSymbolLayer=R,this.renderGeometries=G,this.boundingBox=H,this._drapeSourceRenderer=W,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(R){this.stage=R.stage}setVisibility(R){if(null!=this.stage&&this._visible!==R){if(this._visible=R,R&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,Go.ADD);if(R||this._addedToStage){for(const R of this.renderGeometries)R.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,zo.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,Go.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,xe.vt)();return(0,be.s)(R,0,0,0)}getBoundingBoxObjectSpace(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Le.vt)();return(0,Le.Ie)(R)}addObjectState(R,G){R===et.Mg.Highlight&&(this.renderGeometries.forEach((R=>{const H=R.geometry.addHighlight();G.addRenderGeometry(R,H,this)})),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,zo.HIGHLIGHT))}removeObjectState(R){this.renderGeometries.forEach((G=>{R.removeRenderGeometry(G)}))}removeRenderGeometryObjectState(R,G){R.geometry.removeHighlight(G),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,zo.HIGHLIGHT)}computeAttachmentOrigin(R){for(const G of this.renderGeometries)G.geometry.computeAttachmentOrigin(zl)&&(R.draped.origin[0]+=zl[0],R.draped.origin[1]+=zl[1],R.draped.num++)}async getProjectedBoundingBox(R,G,H,W,q){(0,Le.Ie)(q);for(let J=0;J<this.renderGeometries.length;J++){const G=this.renderGeometries[J];this._getRenderGeometryProjectedBoundingRect(G,R,Ul,H),(0,Le.DC)(q,Ul)}if(G){let R;(0,Le.gX)(q,zl);const H=graphicUtils_k(q,G.service.spatialReference,G);try{R=await G.service.queryElevation(zl[0],zl[1],W,H,"ground")}catch(Q){}null!=R&&(q[2]=Math.min(q[2],R),q[5]=Math.max(q[5],R))}return q}_getRenderGeometryProjectedBoundingRect(R,G,H,W){if(this.boundingBox)(0,Le.hZ)(Gl,this.boundingBox);else{const G=R.boundingSphere,H=G[3];Gl[0]=G[0]-H,Gl[1]=G[1]-H,Gl[2]=G[2]-H,Gl[3]=G[0]+H,Gl[4]=G[1]+H,Gl[5]=G[2]+H}return G(Gl,0,2),this.calculateRelativeScreenBounds&&W.push({location:(0,Le.gX)(Gl),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,Le.ES)(Gl,H)}}const Ul=(0,Fe.vt)(),Gl=(0,Le.vt)(),zl=(0,xe.vt)();function TextHelperCanvas_a(R,G,H){return R.canvas||(R.canvas=document.createElement("canvas")),R.canvas.width=G,R.canvas.height=H,R.canvas}function FontMetrics_e(R){const{size:G}=R.definition,H=R.fontString(G);let W=Bl.get(H);if(!W){const q=TextHelperCanvas_a(Hl,0,0).getContext("2d");R.setFontProperties(q,G);const Q=q.measureText(jl);W=new FontMetrics_s(Q.actualBoundingBoxAscent,Q.actualBoundingBoxDescent),Bl.set(H,W)}return W}const Bl=new Map;class FontMetrics_s{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(R,G){this.maxAscent=R,this.maxDescent=G}}const Hl={canvas:null},jl=(()=>{let R="";for(let G=32;G<127;G++)R+=String.fromCharCode(G);return R})(),Wl=1;class TextRenderer_r{constructor(R,G,H,W){this.text=R,this._alignment=G,this._parameters=H,this._maxSize=W,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key="TextRenderer-".concat(this._parameters.key,"-").concat(this._alignment,"--").concat(R),this._lines=R.replaceAll(" ","\xa0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let R=this._metrics.firstLineAscent;for(let G=0;G<this._lines.length-1;G++)R+=this._lineSpacing;return R+=this._metrics.lastLineDescent,Math.ceil(R+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const R=TextHelperCanvas_a(Zl,Yl,Yl).getContext("2d"),G=this._parameters.definition.pixelRatio,H=this._fontSize*G;this._parameters.setFontProperties(R,H);let W=2*this._haloSize;const q=this._parameters.definition.font;"italic"!==q.style&&"oblique"!==q.style&&"bold"!==q.weight&&"bolder"!==q.weight||(W+=.3*R.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let Q=0,J=0,X=0,$=0,K=0;this._lines.forEach(((H,q)=>{const ee=R.measureText(H),te=ee.width/G,ie=te+W;this._textWidths.push(te),this._lineWidths.push(ie),Q=Math.max(Q,ie),$=Math.max($,ee.actualBoundingBoxAscent/G),K=Math.max(K,ee.actualBoundingBoxDescent/G),0===q&&(J=ee.actualBoundingBoxAscent/G),q===this._lines.length-1&&(X=ee.actualBoundingBoxDescent/G)}));const ee=FontMetrics_e(this._parameters),te=Math.max($,ee.maxAscent),ie=Math.max(K,ee.maxDescent),re=J,ne="underline"===this._parameters.definition.font.decoration?ie:X,se=Q;this._metricsCached=new TextRenderer_c(re,ne,te,ie,se)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*Ql}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,Wl)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const R=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(R,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(R){switch(this._alignment){case ql.Left:return this._horizontalPadding;case ql.Center:return(this.displayWidth-this._lineWidths[R])/2;case ql.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[R]}}render(R,G,H){R.save();const W=G/=this.renderPixelRatio,q=H/=this.renderPixelRatio,Q=this._haloSize,J=this._firstLineYOffset+this._metrics.firstLineAscent;G+=Q,H+=J;const X=this._haloSize>0;X&&this._renderHalo(R,W,q,Q,J),this._parameters.setFontProperties(R,this._renderedFontSize);for(let $=0;$<this._lines.length;++$){const W=this._lines[$],q=this._getLineXOffset($);X&&(R.globalCompositeOperation="destination-out",R.fillStyle="rgb(0, 0, 0)",this._fillText(R,W,G+q,H),this._renderLineDecoration(R,G+q,H,this._textWidths[$])),R.globalCompositeOperation="source-over",R.fillStyle=this._parameters.textStyle,this._fillText(R,W,G+this._getLineXOffset($),H),this._renderLineDecoration(R,G+q,H,this._textWidths[$]),H+=this._lineSpacing}if(qr.b.TEXT_SHOW_BASELINE){R.strokeStyle=Jl,R.setLineDash([2,2]),R.lineWidth=1;let G=q+J;for(let H=0;H<this._lines.length;++H)this._drawLine(R,[W,G],[W+this.displayWidth,G]),G+=this._lineSpacing}if(qr.b.TEXT_SHOW_BORDER&&(R.strokeStyle=Jl,R.setLineDash([]),R.lineWidth=1,this._drawBox(R,[W,q],[this.displayWidth,this.displayHeight])),this._hasBackground){const G=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(R,W,q,G),R.globalCompositeOperation="destination-over",R.fillStyle=this._parameters.backgroundStyle,R.fill()}R.restore()}_renderLineDecoration(R,G,H,W){let q=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if("none"===this._parameters.definition.font.decoration||0===W)return;const Q=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":H+=2*Q;break;case"line-through":H-=.33*this._midLineAscent}const J=q?this._haloSize:0;R.strokeStyle=q?this._parameters.haloStyle:this._parameters.textStyle,R.lineWidth=this._toRenderUnit(Q+2*J),R.beginPath(),R.moveTo(this._toRenderUnit(G-J),this._toRenderUnit(H)),R.lineTo(this._toRenderUnit(G+W+J),this._toRenderUnit(H)),R.stroke()}_roundedRect(R,G,H,W){G=this._toRenderUnit(G),H=this._toRenderUnit(H);const q=this.renderedWidth,Q=this.renderedHeight;0!==W?(W=(0,Ee.qE)(W,0,Math.floor(Q/2)),R.beginPath(),R.moveTo(G,H+W),R.arcTo(G,H,G+W,H,W),R.lineTo(G+q-W,H),R.arcTo(G+q,H,G+q,H+W,W),R.lineTo(G+q,H+Q-W),R.arcTo(G+q,H+Q,G+q-W,H+Q,W),R.lineTo(G+W,H+Q),R.arcTo(G,H+Q,G,H+Q-W,W),R.closePath()):R.rect(G,H,q,Q)}_renderHalo(R,G,H,W,q){const Q=this.renderedWidth,J=this.renderedHeight,X=TextHelperCanvas_a(Zl,Math.max(Q,Yl),Math.max(J,Yl)),$=X.getContext("2d");$.clearRect(0,0,Q,J),this._parameters.setFontProperties($,this._renderedFontSize),$.fillStyle=this._parameters.haloStyle,$.strokeStyle=this._parameters.haloStyle;const K=this._renderedHaloSize<3;$.lineJoin=K?"miter":"round",K?this._renderHaloEmulated($,W,q):this._renderHaloNative($,W,q);let ee=q;for(let te=0;te<this._lines.length;++te){const R=this._getLineXOffset(te);this._renderLineDecoration($,W+R,ee,this._textWidths[te],!0),ee+=this._lineSpacing}R.globalAlpha=this._parameters.definition.halo.color[3],R.drawImage(X,0,0,Q,J,this._toRenderUnit(G),this._toRenderUnit(H),Q,J),R.globalAlpha=1}_renderHaloEmulated(R,G,H){for(let W=0;W<this._lines.length;++W){const q=this._lines[W],Q=this._getLineXOffset(W);for(const[W,J]of kl)this._fillText(R,q,G+Q+this._haloSize*W,H+this._haloSize*J);H+=this._lineSpacing}}_renderHaloNative(R,G,H){const W=2*this._haloSize;for(let q=0;q<this._lines.length;++q){const Q=this._lines[q],J=this._getLineXOffset(q),X=5,$=.1;for(let q=0;q<X;q++){const K=1-(X-1)*$+q*$;R.lineWidth=this._toRenderUnit(K*W),this._strokeText(R,Q,G+J,H)}H+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(R){return R*this.renderPixelRatio}_toRoundedRenderUnit(R){return Math.round(R*this.renderPixelRatio)}_fillText(R,G,H,W){R.fillText(G,this._toRenderUnit(H),this._toRenderUnit(W))}_strokeText(R,G,H,W){R.strokeText(G,this._toRenderUnit(H),this._toRenderUnit(W))}_drawLine(R,G,H){R.beginPath(),R.moveTo(this._toRoundedRenderUnit(G[0])+.5,this._toRoundedRenderUnit(G[1])+.5),R.lineTo(this._toRoundedRenderUnit(H[0])+.5,this._toRoundedRenderUnit(H[1])+.5),R.stroke()}_drawBox(R,G,H){const W=this._toRenderUnit(G[0]),q=this._toRenderUnit(G[1]),Q=this._toRenderUnit(H[0]),J=this._toRenderUnit(H[1]),X=Math.floor(W)+.5,$=Math.ceil(W+Q)-.5,K=Math.floor(q)+.5,ee=Math.ceil(q+J)-.5;R.beginPath(),R.moveTo(X,K),R.lineTo($,K),R.lineTo($,ee),R.lineTo(X,ee),R.lineTo(X,K),R.stroke()}}const kl=[];{const R=16;for(let G=0;G<360;G+=360/R)kl.push([Math.cos(Math.PI*G/180),Math.sin(Math.PI*G/180)])}var ql;!function(R){R[R.Left=0]="Left",R[R.Center=1]="Center",R[R.Right=2]="Right"}(ql||(ql={}));const Zl={canvas:null},Ql=.2,Yl=512,Jl="rgb(255, 0, 255, 0.5)";class TextRenderer_c{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(R,G,H,W,q){this.firstLineAscent=R,this.lastLineDescent=G,this.maxLineAscent=H,this.maxLineDescent=W,this.displayWidth=q}}const Xl=Object.freeze({left:0,center:.5,right:1}),$l=Object.freeze({"bottom-left":(0,Xi.fA)(0,0),bottom:(0,Xi.fA)(.5,0),"bottom-right":(0,Xi.fA)(1,0),left:(0,Xi.fA)(0,.5),center:(0,Xi.fA)(.5,.5),right:(0,Xi.fA)(1,.5),"top-left":(0,Xi.fA)(0,1),top:(0,Xi.fA)(.5,1),"top-right":(0,Xi.fA)(1,1)});function placementUtils_f(R){switch(R){case"left":return ql.Left;case"right":return ql.Right;default:return ql.Center}}function placementUtils_a(R){switch(R){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}var Kl=H(21740);class RenderGeometry_m{constructor(R){var G;let H=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.geometry=R,this.screenToWorldRatio=1,this._transformation=(0,ve.vt)(),this._shaderTransformation=null,this._boundingSphere=null,this.id=(0,wi.c)(),this.layerUid=H.layerUid,this.graphicUid=H.graphicUid,this.castShadow=null!==(G=H.castShadow)&&void 0!==G&&G,null!=H.objectShaderTransformation&&this.objectShaderTransformationChanged(H.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(R){(0,ye.C)(this._transformation,R),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(R){var G;null==R?this._shaderTransformation=null:(null!==(G=this._shaderTransformation)&&void 0!==G||(this._shaderTransformation=(0,ve.vt)()),(0,ye.lw)(this._shaderTransformation,R,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){var R;return this.boundingInfo?(null==this._boundingSphere&&(null!==(R=this._boundingSphere)&&void 0!==R||(this._boundingSphere=(0,Ge.d)()),(0,be.e)((0,Ge.g)(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*(0,gn.hG)(this.shaderTransformation)),this._boundingSphere):Ge.N}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){var R;return null!==(R=this._shaderTransformation)&&void 0!==R?R:this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(R){this.geometry.visible=R}}function mat4_t(R){return function mat4_n(R){return R instanceof Float32Array&&R.length>=16}(R)||function mat4_r(R){return Array.isArray(R)&&R.length>=16}(R)}var ec=H(59278),tc=H(45526),ic=H(68387),rc=H(96164);class ScaleInfo_c{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var nc=H(40362),sc=H(71517);class HUDMaterialTechnique_g extends Ln.w{initializeConfiguration(R,G){G.spherical=R.viewingMode===qe.RT.Global}initializeProgram(R){return new Nn.B(R.rctx,HUDMaterialTechnique_g.shader.get().build(this.configuration),Fn.D)}initializePipeline(){const R=this.configuration.transparencyPassType,G=this.configuration,H=R===pa.y.NONE,W=R===pa.y.FrontFace,q=this.configuration.hasPolygonOffset?ac:null,Q=G.draped?null:(H||W)&&G.output!==En.V.Highlight&&(G.depthEnabled||G.occlusionPass)?Un.kn:null;return(0,Un.Ey)({blending:G.output===En.V.Color||G.output===En.V.Alpha||G.output===En.V.Highlight?H?oc:(0,ha.ez)(R):null,depthTest:G.draped?null:{func:Ft.MT.LEQUAL},depthWrite:Q,colorWrite:Un.wE,polygonOffset:q})}get primitiveType(){return this.configuration.occlusionPass?Ft.WR.POINTS:Ft.WR.TRIANGLES}}HUDMaterialTechnique_g.shader=new Dn.$(sc.H,(()=>H.e(6711).then(H.bind(H,26711))));const ac={factor:0,units:-4},oc=(0,Un.ox)(Ft.dn.ONE,Ft.dn.ONE_MINUS_SRC_ALPHA);class HUDMaterialTechniqueConfiguration_r extends zn.E{constructor(){super(...arguments),this.output=En.V.Color,this.transparencyPassType=pa.y.NONE,this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}}(0,W._)([(0,Gn.W)({count:En.V.COUNT})],HUDMaterialTechniqueConfiguration_r.prototype,"output",void 0),(0,W._)([(0,Gn.W)({count:pa.y.COUNT})],HUDMaterialTechniqueConfiguration_r.prototype,"transparencyPassType",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"spherical",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"occlusionTestEnabled",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"signedDistanceFieldEnabled",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"vvSize",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"vvColor",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"hasVerticalOffset",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"hasScreenSizePerspective",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"debugDrawLabelBorder",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"hasSlicePlane",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"hasPolygonOffset",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"depthEnabled",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"pixelSnappingEnabled",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"draped",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"multipassEnabled",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"cullAboveGround",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"occlusionPass",void 0),(0,W._)([(0,Gn.W)()],HUDMaterialTechniqueConfiguration_r.prototype,"objectAndLayerIdColorInstanced",void 0),(0,W._)([(0,Gn.W)({constValue:!0})],HUDMaterialTechniqueConfiguration_r.prototype,"hasSliceInVertexProgram",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],HUDMaterialTechniqueConfiguration_r.prototype,"hasVvInstancing",void 0);class HUDMaterial_Q extends Pn.im{constructor(R){super(R,new HUDMaterial_Ae),this._configuration=new HUDMaterialTechniqueConfiguration_r,this.produces=new Map([[Mn.N.HUD_MATERIAL,R=>(0,En.L0)(R)&&!this.parameters.drawInSecondSlot],[Mn.N.LABEL_MATERIAL,R=>(0,En.L0)(R)&&this.parameters.drawInSecondSlot],[Mn.N.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[Mn.N.DRAPED_MATERIAL,R=>(0,En.L0)(R)]])}getConfiguration(R,G){return this._configuration.output=R,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=G.slot===Mn.N.OCCLUSION_PIXELS&&this.parameters.occlusionTest,R===En.V.Color&&(this._configuration.debugDrawLabelBorder=!!qr.b.LABELS_SHOW_BORDER),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=G.transparencyPassType,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration.cullAboveGround=G.multipassTerrain.cullAboveGround,this._configuration}intersect(R,G,H,W,q,Q){if(!(H.options.selectionMode&&H.options.hud&&R.visible&&H.point))return;const J=this.parameters,X=H.point,$=H.camera;let{scaleX:K,scaleY:ee}=this._getScreenScale(R);K*=$.pixelRatio,ee*=$.pixelRatio,(0,ge.z0)(_c,G),R.attributes.has(Wt.r.FEATUREATTRIBUTE)&&function HUDMaterial_te(R){const G=R[0],H=R[1],W=R[2],q=R[3],Q=R[4],J=R[5],X=R[6],$=R[7],K=R[8],ee=1/Math.sqrt(G*G+H*H+W*W),te=1/Math.sqrt(q*q+Q*Q+J*J),ie=1/Math.sqrt(X*X+$*$+K*K);return R[0]=G*ee,R[1]=H*ee,R[2]=W*ee,R[3]=q*te,R[4]=Q*te,R[5]=J*te,R[6]=X*ie,R[7]=$*ie,R[8]=K*ie,R}(_c);const te=R.attributes.get(Wt.r.POSITION),ie=R.attributes.get(Wt.r.SIZE),re=R.attributes.get(Wt.r.NORMAL),ne=R.attributes.get(Wt.r.CENTEROFFSETANDDISTANCE);(0,nr.vA)(te.size>=3);const se=(0,sc.c)(J),ae="screen"===this.parameters.centerOffsetUnits;for(let oe=0;oe<te.data.length/te.size;oe++){const R=oe*te.size;(0,be.s)(cc,te.data[R],te.data[R+1],te.data[R+2]),(0,be.e)(cc,cc,G);const W=oe*ie.size;Cc[0]=ie.data[W]*K,Cc[1]=ie.data[W+1]*ee,(0,be.e)(cc,cc,$.viewMatrix);const q=oe*ne.size;if((0,be.s)(fc,ne.data[q],ne.data[q+1],ne.data[q+2]),!ae&&(cc[0]+=fc[0],cc[1]+=fc[1],0!==fc[2])){const R=fc[2];(0,be.n)(fc,cc),(0,be.f)(cc,cc,(0,be.h)(fc,fc,R))}const le=oe*re.size;if((0,be.s)(dc,re.data[le],re.data[le+1],re.data[le+2]),this._normalAndViewAngle(dc,_c,$,bc),this._applyVerticalOffsetTransformationView(cc,bc,$,lc),$.applyProjection(cc,hc),hc[0]>-1){ae&&(fc[0]||fc[1])&&(hc[0]+=fc[0]*$.pixelRatio,0!==fc[1]&&(hc[1]+=(0,rc.m0)(fc[1],lc.factorAlignment)*$.pixelRatio),$.unapplyProjection(hc,cc)),hc[0]+=this.parameters.screenOffset[0]*$.pixelRatio,hc[1]+=this.parameters.screenOffset[1]*$.pixelRatio,hc[0]=Math.floor(hc[0]),hc[1]=Math.floor(hc[1]),(0,rc.MD)(Cc,lc.factor,Cc);const R=xc*$.pixelRatio;let G=0;if(J.textureIsSignedDistanceField&&(G=J.outlineSize*$.pixelRatio/2),HUDMaterial_re(X,hc[0],hc[1],Cc,R,G,J,se)){const R=H.ray;if((0,be.e)(pc,cc,(0,ye.B8)(gc,$.viewMatrix)),hc[0]=X[0],hc[1]=X[1],$.unprojectFromRenderScreen(hc,cc)){const G=(0,xe.vt)();(0,be.c)(G,R.direction);const H=1/(0,be.l)(G);(0,be.h)(G,G,H),Q((0,be.q)(R.origin,cc)*H,G,-1,!0,1,pc)}}}}}intersectDraped(R,G,H,W,q,Q){const J=R.attributes.get(Wt.r.POSITION),X=R.attributes.get(Wt.r.SIZE),$=this.parameters,K=(0,sc.c)($);let{scaleX:ee,scaleY:te}=this._getScreenScale(R);ee*=R.screenToWorldRatio,te*=R.screenToWorldRatio;const ie=Sc*R.screenToWorldRatio;for(let re=0;re<J.data.length/J.size;re++){const G=re*J.size,H=J.data[G],ne=J.data[G+1],se=re*X.size;Cc[0]=X.data[se]*ee,Cc[1]=X.data[se+1]*te;let ae=0;$.textureIsSignedDistanceField&&(ae=$.outlineSize*R.screenToWorldRatio/2),HUDMaterial_re(W,H,ne,Cc,ie,ae,$,K)&&q(Q.dist,Q.normal,-1,!1)}}createBufferWriter(){return new HUDMaterial_Ee(this)}_normalAndViewAngle(R,G,H,W){return mat4_t(G)&&(G=(0,ge.z0)(mc,G)),(0,be.t)(W.normal,R,G),(0,be.e)(W.normal,W.normal,H.viewInverseTransposeMatrix),W.cosAngle=(0,be.k)(uc,wc),W}_updateScaleInfo(R,G,H){const W=this.parameters;null!=W.screenSizePerspective?(0,rc.cJ)(H,G,W.screenSizePerspective,R.factor):(R.factor.scale=1,R.factor.factor=0,R.factor.minScaleFactor=0),null!=W.screenSizePerspectiveAlignment?(0,rc.cJ)(H,G,W.screenSizePerspectiveAlignment,R.factorAlignment):(R.factorAlignment.factor=R.factor.factor,R.factorAlignment.scale=R.factor.scale,R.factorAlignment.minScaleFactor=R.factor.minScaleFactor)}applyShaderOffsetsView(R,G,H,W,q,Q,J){const X=this._normalAndViewAngle(G,H,q,bc);return this._applyVerticalGroundOffsetView(R,X,q,J),this._applyVerticalOffsetTransformationView(J,X,q,Q),this._applyPolygonOffsetView(J,X,W[3],q,J),this._applyCenterOffsetView(J,W,J),J}applyShaderOffsetsNDC(R,G,H,W,q){return this._applyCenterOffsetNDC(R,G,H,W),null!=q&&(0,be.c)(q,W),this._applyPolygonOffsetNDC(W,G,H,W),W}_applyPolygonOffsetView(R,G,H,W,q){const Q=W.aboveGround?1:-1;let J=Math.sign(H);0===J&&(J=Q);const X=Q*J;if(this.parameters.shaderPolygonOffset<=0)return(0,be.c)(q,R);const $=(0,Ee.qE)(Math.abs(G.cosAngle),.01,1),K=1-Math.sqrt(1-$*$)/$/W.viewport[2];return(0,be.h)(q,R,X>0?K:1/K),q}_applyVerticalGroundOffsetView(R,G,H,W){const q=(0,be.l)(R),Q=H.aboveGround?1:-1,J=H.computeRenderPixelSizeAtDist(q)*tc.R,X=(0,be.h)(cc,G.normal,Q*J);return(0,be.g)(W,R,X),W}_applyVerticalOffsetTransformationView(R,G,H,W){var q,Q;const J=this.parameters;if(null===(q=J.verticalOffset)||void 0===q||!q.screenLength){if(J.screenSizePerspective||J.screenSizePerspectiveAlignment){const H=(0,be.l)(R);this._updateScaleInfo(W,H,G.cosAngle)}else W.factor.scale=1,W.factorAlignment.scale=1;return R}const X=(0,be.l)(R),$=null!==(Q=J.screenSizePerspectiveAlignment)&&void 0!==Q?Q:J.screenSizePerspective,K=(0,nc.kE)(H,X,J.verticalOffset,G.cosAngle,$);return this._updateScaleInfo(W,X,G.cosAngle),(0,be.h)(G.normal,G.normal,K),(0,be.g)(R,R,G.normal)}_applyCenterOffsetView(R,G,H){const W="screen"!==this.parameters.centerOffsetUnits;return H!==R&&(0,be.c)(H,R),W&&(H[0]+=G[0],H[1]+=G[1],G[2]&&((0,be.n)(dc,H),(0,be.g)(H,H,(0,be.h)(dc,dc,G[2])))),H}_applyCenterOffsetNDC(R,G,H,W){const q="screen"!==this.parameters.centerOffsetUnits;return W!==R&&(0,be.c)(W,R),q||(W[0]+=G[0]/H.fullWidth*2,W[1]+=G[1]/H.fullHeight*2),W}_applyPolygonOffsetNDC(R,G,H,W){const q=this.parameters.shaderPolygonOffset;if(R!==W&&(0,be.c)(W,R),q){const R=H.aboveGround?1:-1,Q=R*Math.sign(G[3]);W[2]-=(Q||R)*q}return W}createGLMaterial(R){return new HUDMaterial_$(R)}calculateRelativeScreenBounds(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,Fe.vt)();return function HUDMaterial_ee(R,G,H,W){W[0]=R.anchorPosition[0]*-G[0]+R.screenOffset[0]*H,W[1]=R.anchorPosition[1]*-G[1]+R.screenOffset[1]*H}(this.parameters,R,G,H),H[2]=H[0]+R[0],H[3]=H[1]+R[1],H}_getScreenScale(R){const G=R.attributes.get(Wt.r.FEATUREATTRIBUTE);if(null==G)return{scaleX:1,scaleY:1};const H=(0,Ce.ci)(G.data,vc),[W,q]=(0,hn.VC)(yc,this.parameters,H);return{scaleX:W,scaleY:q}}}class HUDMaterial_$ extends ic.m{constructor(R){super({...R,...R.material.parameters})}selectProgram(R){return this.ensureTechnique(HUDMaterialTechnique_g,R)}beginSlot(R){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(R)}}function HUDMaterial_re(R,G,H,W,q,Q,J,X){let $=G-q-(X[0]>0?W[0]*X[0]:0),K=$+W[0]+2*q,ee=H-q-(X[1]>0?W[1]*X[1]:0),te=ee+W[1]+2*q;const ie=J.distanceFieldBoundingBox;return J.textureIsSignedDistanceField&&null!=ie&&($+=W[0]*ie[0],ee+=W[1]*ie[1],K-=W[0]*(1-ie[2]),te-=W[1]*(1-ie[3]),$-=Q,K+=Q,ee-=Q,te+=Q),R[0]>$&&R[0]<K&&R[1]>ee&&R[1]<te}const lc=new class ScaleInfo_t{constructor(){this.factor=new ScaleInfo_c,this.factorAlignment=new ScaleInfo_c}},cc=(0,xe.vt)(),dc=(0,xe.vt)(),hc=(0,Ce.vt)(),uc=(0,xe.vt)(),pc=(0,xe.vt)(),_c=(0,fe.vt)(),mc=(0,fe.vt)(),gc=(0,ve.vt)(),fc=(0,xe.vt)(),yc=(0,xe.vt)(),vc=(0,Ce.vt)(),bc={normal:uc,cosAngle:0},xc=1,Sc=2,Cc=[0,0],wc=(0,xe.fA)(0,0,1);class HUDMaterial_Ae extends ic.N{constructor(){super(...arguments),this.renderOccluded=Pn.m$.Occlude,this.isDecoration=!1,this.color=(0,Ce.fA)(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=(0,Xi.fA)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,Ce.fA)(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.draped=!1}}const Ac=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec3f(Wt.r.NORMAL).vec2f(Wt.r.UV0).vec4u8(Wt.r.COLOR).vec2f(Wt.r.SIZE).vec4f(Wt.r.CENTEROFFSETANDDISTANCE).vec4f(Wt.r.FEATUREATTRIBUTE),Rc=Ac.clone().vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR);class HUDMaterial_Ee{constructor(R){this._material=R,this.vertexBufferLayout=(0,te.A)("enable-feature:objectAndLayerId-rendering")?Rc:Ac}elementCount(R){return 6*R.attributes.get(Wt.r.POSITION).indices.length}write(R,G,H,W,q){(0,In.Hk)(H.attributes.get(Wt.r.POSITION),R,W.position,q,6),(0,In.p1)(H.attributes.get(Wt.r.NORMAL),G,W.normal,q,6);const Q=H.attributes.get(Wt.r.UV0).data;let J,X,$,K;if(null==Q||Q.length<4){const R=this._material.parameters;J=0,X=0,$=R.texCoordScale[0],K=R.texCoordScale[1]}else J=Q[0],X=Q[1],$=Q[2],K=Q[3];$=Math.min(1.99999,$+1),K=Math.min(1.99999,K+1);let ee=H.attributes.get(Wt.r.POSITION).indices.length,te=q;const ie=W.uv0;for(let oe=0;oe<ee;++oe)ie.set(te,0,J),ie.set(te,1,X),te++,ie.set(te,0,$),ie.set(te,1,X),te++,ie.set(te,0,$),ie.set(te,1,K),te++,ie.set(te,0,$),ie.set(te,1,K),te++,ie.set(te,0,J),ie.set(te,1,K),te++,ie.set(te,0,J),ie.set(te,1,X),te++;(0,In.tb)(H.attributes.get(Wt.r.COLOR),4,W.color,q,6);const{data:re,indices:ne}=H.attributes.get(Wt.r.SIZE);ee=ne.length;const se=W.size;te=q;for(let oe=0;oe<ee;++oe){const R=re[2*ne[oe]],G=re[2*ne[oe]+1];for(let H=0;H<6;++H)se.set(te,0,R),se.set(te,1,G),te++}if(H.attributes.get(Wt.r.CENTEROFFSETANDDISTANCE)?(0,In.Ut)(H.attributes.get(Wt.r.CENTEROFFSETANDDISTANCE),W.centerOffsetAndDistance,q,6):(0,In.Pq)(W.centerOffsetAndDistance,q,6*ee),H.attributes.get(Wt.r.FEATUREATTRIBUTE)?(0,In.Ut)(H.attributes.get(Wt.r.FEATUREATTRIBUTE),W.featureAttribute,q,6):(0,In.Pq)(W.featureAttribute,q,6*ee),null!=H.objectAndLayerIdColor){var ae;const R=null===(ae=H.attributes.get(Wt.r.POSITION))||void 0===ae?void 0:ae.indices;if(R){const G=R.length,Q=W.getField(Wt.r.OBJECTANDLAYERIDCOLOR,ec.XP);(0,In.tH)(H.objectAndLayerIdColor,Q,G,q,6)}}}}const Tc=(0,xe.fA)(0,0,1),Ec=Kl.CN,Oc=[Ec/2,Ec/2,1-Ec/2,1-Ec/2],Pc=[Kl.Q_*Ec,Kl.Q_*Ec];class Graphics3DIconSymbolLayer_le extends Graphics3DSymbolLayer_h{getCachedSize(){return{size:this._getIconSize()}}constructor(R,G,H,W){super(R,G,H,W),this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(R){this._validateOrThrow();const G=this._prepareMaterialParameters(),H=this._getPrimitive();if(null!=H)this._prepareResourcesPrimitive(G,H);else{const H=(0,Ll.N7)(this.symbolLayer),W=(0,Et.r$)(H);W&&"application/json"===W.mediaType?await this._prepareResourcesCIM(G,JSON.parse(W.data),R):await this._prepareResourcesHref(G,H,R)}}_validateOrThrow(){if(this._drivenProperties.size)return;const R=graphicUtils_I(this._getIconSize());if(R)throw new Ze.A("graphics3diconsymbollayer:invalid-size",R)}_getIconSize(){const R=this.symbolLayer,G=Math.round(null!=R.size?(0,kr.Lz)(R.size):16);return this._drivenProperties.size?Math.max(G,64):G}_generateTextureCIM(R){let G=this._cimData;if(G&&G.symbol||this.logger.error("Can't create texture, CIM data is undefined"),G.primitiveOverrides){G=(0,Tt.o8)(G);const H=G.primitiveOverrides;Ol.$.evaluateOverrides(H,R,this._arcadeInfo.geometryType,null,null),Ol.$.applyOverrides(G.symbol,H)}const H=(0,Tl.Wm)(JSON.stringify(G));let W=this._cimSymbolTextures.get(H);if(W)return W;const q=this._context.sharedResources.cimSymbolRasterizer,Q=this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null;Q&&Ol.$.applyDictionaryTextOverrides(G.symbol,R,Q,null);const J=null!=this._cimScaleFactorOrFunction?(0,Pl.s4)(this._cimScaleFactorOrFunction,R):1;1!==J&&G.symbol&&(0,Ml.Km)(G.symbol,J,!0);const X=El.wp.getEnvelope(G,null,q.resourceManager);if(X&&X.width&&X.height){var $,K;const R=X.x+X.width/2,H=X.y+X.height/2,Q=q.rasterize({type:"cim",data:G},X.width,X.height,R,H,1,"esriGeometryPoint"),J=new Dl.Q({x:-X.x/X.width-.5,y:(X.height+X.y)/X.height-.5});this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",J),W=new Lt.g(Q,{width:null!==($=null===Q||void 0===Q?void 0:Q.width)&&void 0!==$?$:1,height:null!==(K=null===Q||void 0===Q?void 0:Q.height)&&void 0!==K?K:1})}else W=new Lt.g(new ImageData(1,1),{width:1,height:1});return this._cimSymbolTextures.set(H,W),this._context.stage.add(W),W}_prepareMaterialParameters(){const R={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},G=this.symbol;if(function Graphics3DIconSymbolLayer_ce(R){return R&&"point-3d"===R.type&&R.hasVisibleVerticalOffset()}(G)){const{screenLength:H,minWorldLength:W,maxWorldLength:q}=G.verticalOffset;R.verticalOffset={screenLength:(0,kr.Lz)(H),minWorldLength:W||0,maxWorldLength:null!=q?q:1/0}}return this._context.screenSizePerspectiveEnabled&&(R.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),R.occlusionTest=!0,R.hasSlicePlane=this._context.slicePlaneEnabled,R}_prepareResourcesPrimitive(R,G){const H=this._getOutlineSize();if(Graphics3DIconSymbolLayer_he(G)&&0===H)throw new Error("Nothing to render");if(this._outlineSize=H,R.color=this._getFillColor(),R.outlineColor=this._getOutlineColor(),R.outlineSize=this._outlineSize,null!=this._context.sharedResources.textures){const H=this._context.sharedResources.textures.fromData("".concat(G,"-icon"),(()=>(0,Kl.sZ)(G)));this._textureHandle=H,R.textureId=H.texture.id}R.textureIsSignedDistanceField=!0,R.sampleSignedDistanceFieldTexelCenter=(0,Kl.ny)(G),R.distanceFieldBoundingBox=Oc;const W=this._getIconSize();this._size=[W,W],this._symbolTextureRatio=1/Ec,this._createMaterialAndAddToStage(R,this._context.stage)}async _prepareResourcesHref(R,G,H){this._outlineSize=this._getOutlineSize(),R.color=this._getFillColor(),R.outlineColor=this._getOutlineColor(),R.outlineSize=this._outlineSize,R.textureIsSignedDistanceField=!1;const W=this._getIconSize(),q=W*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(null!=this._context.sharedResources.textures){const Q=await(0,Rt.Ke)(this._context.sharedResources.textures.fromUrl(G,q,{signal:H}));if(!1===Q.ok)throw(0,X.QP)(Q.error),new Ze.A("graphics3diconsymbollayer:request-failed","Failed to load (Request for icon resource failed: ".concat(G,")"));this._textureHandle=Q.value;const J=Q.value.texture;this._size=this._computeSizeFromTexture(J,W),R.textureId=J.id}this._createMaterialAndAddToStage(R,this._context.stage)}async _prepareResourcesCIM(R,G,W){if(this._cimData=G,!this._context.sharedResources.cimSymbolRasterizer){const R=(await H.e(4416).then(H.bind(H,74416))).CIMSymbolRasterizer;(0,X.Te)(W),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new R(this._context.renderCoordsHelper.spatialReference))}const q=this._context.sharedResources.cimSymbolRasterizer,Q=[],J=G,$=null===J||void 0===J?void 0:J.symbol;El.wp.fetchResources($,q.resourceManager,Q,W),El.wp.fetchFonts($,q.resourceManager,Q);const K=this._context.layer.fields?this._context.layer.fields.map((R=>R.toJSON())):[],ee=this._context.renderCoordsHelper.spatialReference;if(this._arcadeInfo={spatialReference:ee,fields:K,geometryType:"esriGeometryPoint"},null!==J&&void 0!==J&&J.primitiveOverrides&&Q.push(Ol.$.createRenderExpressions(J.primitiveOverrides,this._arcadeInfo)),Q.length>0&&(await Promise.all(Q),(0,X.Te)(W)),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const R=this._context.renderer;if(R.scaleExpression){const G=R.scaleExpression,H=await(0,$t.Ad)(G,this._context.layer.spatialReference,K);this._cimScaleFactorOrFunction=(R,G,W)=>{const q=(0,Fl.A)(H,R,{$view:W},"esriGeometryPoint",G);return null!==q?q:1}}}(0,X.Te)(W),this._cimMaterialParametersInfo=R,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||Il.r}_getOutlineSize(){var R;let G=0;const H=this.symbolLayer;return null!=(null===(R=H.outline)||void 0===R?void 0:R.size)?Math.max((0,kr.Lz)(H.outline.size),0):(G=Graphics3DIconSymbolLayer_he(this._getPrimitive())?1.5:0,Math.max(G,0))}_getOutlineColor(){var R;const G=this._getLayerOpacity(),H=this.symbolLayer,W=null===H||void 0===H||null===(R=H.outline)||void 0===R?void 0:R.color;if(null!=W){const R=oe.A.toUnitRGB(W),H=W.a*G;return[R[0],R[1],R[2],H]}return[0,0,0,0]}_getFillColor(){var R;if(Graphics3DIconSymbolLayer_he(this._getPrimitive()))return Nl;const G=null==this._getPrimitive(),H=null===(R=this.symbolLayer)||void 0===R||null===(R=R.material)||void 0===R?void 0:R.color;return this._getCombinedOpacityAndColor(H,{hasIntrinsicColor:G})}_getAnchorPos(R,G){return"relative"===R?(0,Xi.fA)((G.x||0)+.5,.5-(G.y||0)):R in $l?$l[R]:$l.center}_createMaterialAndAddToStage(R,G){if(this._cimData){var H;this._fastUpdates=null;let W=R.textureId?this._cimSymbolMaterials.get(R.textureId):null;return W||(W=new HUDMaterial_Q(R),this._cimSymbolMaterials.set(null!==(H=R.textureId)&&void 0!==H?H:0,W),G.add(W)),W}return this._fastUpdates=(0,hn.s_)(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(R={...R,...this._fastUpdates.materialParameters}),this._materials[0]=new HUDMaterial_Q(R),G.add(this._materials[0]),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((R=>{R.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=(0,Qe.DC)(this._patchTask),this._forEachMaterial((R=>this._context.stage.remove(R))),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((R=>this._context.stage.remove(R))),this._cimSymbolTextures.clear(),this._textureHandle=(0,Qe.Gz)(this._textureHandle)}_getScaleFactor(R,G){if(this._drivenProperties.size&&R.size){for(let G=0;G<3;G++){const H=R.size[G];H&&"symbol-value"!==H&&"proportional"!==H&&(R.size[G]=(0,kr.Lz)(H))}if("symbol-value"===R.size[0])return 1;if(isFinite(+R.size[0]))return+R.size[0]/G;if(isFinite(+R.size[2]))return+R.size[2]/G}return 1}createGraphics3DGraphic(R){var G;const H=R.graphic;if(!this._validateGeometry(H.geometry))return null;let W,q=[0,0];if(this._cimData){if(!this._cimData.symbol)return null;const R=this._generateTextureCIM(H),G={textureId:R.id,...this._cimMaterialParametersInfo};W=this._createMaterialAndAddToStage(G,this._context.stage),q=[R.parameters.width,R.parameters.height]}else q=this._size,W=this._materials[0];const Q=pointUtils_m(H.geometry);if(null==Q)return this.logger.warn("unsupported geometry type for icon symbol: ".concat(H.geometry.type)),null;const J=R.renderingInfo,X=this._getVertexOpacityAndColor(J);let $=1;if(null===(G=this._fastUpdates)||void 0===G||!G.visualVariables.size){const R=q[0]>q[1]?q[0]:q[1];$=this._getScaleFactor(J,R)}$*=this._symbolTextureRatio;const K=(0,Xi.fA)(q[0]*$,q[1]*$),ee=this.setGraphicElevationContext(H);return this.ensureDrapedStatus("on-the-ground"===ee.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(H,Q,W,X,K,R.layer.uid):this._createAs3DShape(H,Q,W,X,K,ee,H.uid)}layerOpacityChanged(){const R=this._getFillColor(),G=this._getOutlineColor();this._forEachMaterial((H=>{H.setParameters({color:R}),H.setParameters({outlineColor:G})}))}layerElevationInfoChanged(R,G,H){const W=this._elevationContext.mode,q=elevationAlignmentUtils_m(Graphics3DIconSymbolLayer_le.elevationModeChangeTypes,H,W);if(q!==Ht.UPDATE)return q;const Q=elevationAlignmentUtils_d(W)||"absolute-height"===W;return this.updateGraphics3DGraphicElevationInfo(R,G,(()=>Q))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((R=>{R.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return null!=this._getPrimitive()}applyRendererDiff(R,G){for(const W in R.diff){var H;if("visualVariables"!==W)return cn.RecreateSymbol;if(!(0,hn.J_)(this._fastUpdates,G,this._fastVisualVariableConvertOptions()))return cn.RecreateSymbol;null===(H=this._materials[0])||void 0===H||H.setParameters(this._fastUpdates.materialParameters)}return cn.FastUpdate}prepareSymbolLayerPatch(R){var G;if(null!==(G=this._patchTask)&&void 0!==G&&G.abort(),"partial"!==R.diff.type)return;const H=R.diff.diff;this._preparePatchResource(R,H)}_preparePatchResource(R,G){var H;if(!G.resource||"partial"!==G.resource.type)return;const W=G.resource.diff;if("complete"!==(null===W||void 0===W||null===(H=W.href)||void 0===H?void 0:H.type))return;const q=W.href.newValue,{textures:Q}=this._context.sharedResources;if(null==q||null==Q)return;const J=this._getIconSize(),$=J*this._context.graphicsCoreOwner.view.state.pixelRatio;R.symbolLayerStatePatches.push((()=>{this._patchTask=(0,Qe.DC)(this._patchTask),this._patchTask=(0,Rt.UT)((R=>this._context.schedule((async(R,G)=>{const H=await(0,Rt.Ke)(Q.fromUrl(q,$,{signal:G}));(0,X.Te)(G);const W=!H.ok;if(W&&(0,X.QP)(H.error),this._textureHandle=(0,Qe.Gz)(this._textureHandle),this._patchTask=null,W){this._forEachMaterial((R=>{R.visible=!1,R.setParameters({textureId:null})}));const R="Failed to load (Request for icon resource failed: ".concat(q,")");return void this.logger.error(new Ze.A("graphics3diconsymbollayer:request-failed",R))}this._textureHandle=H.value;const K=H.value.texture;this._size=this._computeSizeFromTexture(K,J),this._forEachMaterial((R=>{R.setParameters({textureId:K.id}),R.visible=!0}))}),R)))})),delete W.href}_defaultElevationInfoNoZ(){return Mc}_createAs3DShape(R,G,H,W,q,Q,J){const X=this.getFastUpdateAttrValues(R),$=this._context.layer.uid,K=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:J,layerUid:$}),ee=GeometryUtil_ht(H,Tc,null,W,q,Ic,null,X,K),te=pointUtils_c(this._context,G,ee,Q,J);if(null==te)return null;const ie=new Graphics3DObject3DGraphicLayer_p(this,te.object,[ee],null,null,ElevationAligners_p,Q);return ie.alignedSampledElevation=te.sampledElevation,ie.needsElevationUpdates=elevationAlignmentUtils_d(Q.mode)||"absolute-height"===Q.mode,ie.getScreenSize=this._createScreenSizeGetter(q,X),ie.calculateRelativeScreenBounds=R=>H.calculateRelativeScreenBounds(ie.getScreenSize(),1,R),pointUtils_p(ie,G,this._context.elevationProvider),ie}_createAsOverlay(R,G,H,W,q,Q){H.renderPriority=this._renderPriority;const J=(0,xe.vt)();(0,mn.g)(G,J,this._context.overlaySR),J[2]=-2;const X=this._context.clippingExtent;if(null!=X&&!(0,Le.Uc)(X,J))return null;const $=this.getFastUpdateAttrValues(R),K=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:R.uid,layerUid:this._context.layer.uid}),ee=GeometryUtil_ht(H,Tc,J,W,q,null,null,$,K),te=new RenderGeometry_m(ee,{layerUid:Q,graphicUid:R.uid}),ie=new Graphics3DDrapedGraphicLayer_l(this,[te],null,this._context.drapeSourceRenderer);return ie.getScreenSize=this._createScreenSizeGetter(q,$),ie.calculateRelativeScreenBounds=R=>H.calculateRelativeScreenBounds(ie.getScreenSize(),1,R),ie}_createScreenSizeGetter(R,G){var H=this;const W=this._outlineSize+2;if(this._fastUpdates&&G){const q=R[0]/this._symbolTextureRatio,Q=R[1]/this._symbolTextureRatio;return function(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Xi.vt)();const[J,X]=(0,hn.VC)(Dc,H._fastUpdates.materialParameters,G);return R[0]=J*q+W,R[1]=X*Q+W,R}}const q=R[0]/this._symbolTextureRatio+W,Q=R[1]/this._symbolTextureRatio+W;return function(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Xi.vt)();return R[0]=q,R[1]=Q,R}}_fastVisualVariableConvertOptions(){const R=Math.max(this._size[0],this._size[1]),G=(0,xe.fA)(R,R,R),H=(0,kr.PN)(1),W=R*H,q=(0,xe.fA)(W,W,W);return new hn.wI({size:!0,color:!0,rotation:!0,opacity:!1},G,q,H)}_forEachMaterial(R){this._materials.forEach(R),this._cimSymbolMaterials.forEach(R)}_computeSizeFromTexture(R,G){var H,W;let{parameters:q}=R;const Q=(null!==(H=q.width)&&void 0!==H?H:1)/(null!==(W=q.height)&&void 0!==W?W:1);return Q>1?[G,Math.round(G/Q)]:[Math.round(G*Q),G]}test(){return{...super.test(),material:this._materials[0]}}}function Graphics3DIconSymbolLayer_he(R){return null!=R&&("cross"===R||"x"===R)}Graphics3DIconSymbolLayer_le.PRIMITIVE_SIZE=Pc,Graphics3DIconSymbolLayer_le.elevationModeChangeTypes={definedChanged:Ht.UPDATE,staysOnTheGround:Ht.NONE,onTheGroundChanged:Ht.RECREATE};const Mc={mode:"relative-to-ground",offset:0},Ic=(0,Ce.fA)(0,0,0,1),Dc=(0,xe.vt)();function lineUtils_n(R){switch(R){case"butt":return fa.x.BUTT;case"square":return fa.x.SQUARE;case"round":return fa.x.ROUND;default:return null}}function lineUtils_r(R){return"diamond"===R?"kite":R}function line_b(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const W=[],q=G.mapPositions;!function line_g(R,G){const{attributeData:{position:H},removeDuplicateStartEnd:W}=R,q=function line_A(R){const G=R.length;return R[0]===R[G-3]&&R[1]===R[G-2]&&R[2]===R[G-1]}(H)&&W,Q=H.length/3-(q?1:0),J=new Array(2*(Q-1)),X=q?H.slice(0,-3):H;let $=0;for(let K=0;K<Q-1;K++)J[$++]=K,J[$++]=K+1;G.push([Wt.r.POSITION,new tr.n(X,J,3,q)])}(G,W);const Q=W[0][1].data,J=W[0][1].indices.length,X=(0,Ue.EH)(J);return function line_h(R,G,H){if(null!=R.attributeData.colorFeature)return;const W=R.attributeData.color;G.push([Wt.r.COLOR,new tr.n(null!==W&&void 0!==W?W:Ce.Un,H,4)])}(G,W,X),function line_j(R,G,H){var W;null==R.attributeData.sizeFeature&&G.push([Wt.r.SIZE,new tr.n([null!==(W=R.attributeData.size)&&void 0!==W?W:1],H,1,!0)])}(G,W,X),function line_T(R,G,H){R.attributeData.normal&&G.push([Wt.r.NORMAL,new tr.n(R.attributeData.normal,H,3)])}(G,W,X),function line_D(R,G,H){null!=R.attributeData.colorFeature&&G.push([Wt.r.COLORFEATUREATTRIBUTE,new tr.n([R.attributeData.colorFeature],H,1,!0)])}(G,W,X),function line_w(R,G,H){null!=R.attributeData.sizeFeature&&G.push([Wt.r.SIZEFEATUREATTRIBUTE,new tr.n([R.attributeData.sizeFeature],H,1,!0)])}(G,W,X),function line_y(R,G,H){null!=R.attributeData.opacityFeature&&G.push([Wt.r.OPACITYFEATUREATTRIBUTE,new tr.n([R.attributeData.opacityFeature],H,1,!0)])}(G,W,X),function line_E(R,G,H){if(null==R.overlayInfo||R.overlayInfo.renderCoordsHelper.viewingMode!==qe.RT.Global||!R.overlayInfo.spatialReference.isGeographic)return;const W=(0,Ne.jh)(H.length),q=(0,Ut.tO)(R.overlayInfo.spatialReference);for(let te=0;te<W.length;te+=3)(0,Ae.RC)(H,te,W,te,q);const Q=H.length/3,J=(0,Ve.oe)(Q+1);let X=Lc,$=Fc,K=0,ee=0;(0,Yn.hZ)(X,W[ee++],W[ee++]),ee++,J[0]=0;for(let te=1;te<Q+1;++te)te===Q&&(ee=0),(0,Yn.hZ)($,W[ee++],W[ee++]),ee++,K+=(0,Yn.xg)(X,$),J[te]=K,[X,$]=[$,X];G.push([Wt.r.DISTANCETOSTART,new tr.n(J,G[0][1].indices,1,!0)])}(G,W,Q),new rr.V(R,W,q,ir.X.Line,H)}const Lc=(0,Xi.vt)(),Fc=(0,Xi.vt)();function line_c(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const W=new Array;for(const{index:q,count:Q}of R){if(Q<=1)continue;const R=3*q,J=3*Q;W.push({position:(0,Ne.l5)(G,3*q,3*Q),mapPositions:null!=H?(0,Ne.l5)(H,R,J):void 0})}return W}var Nc=H(12089);const Vc=new Map([[Wt.r.POSITION,0],[Wt.r.PREVPOSITION,1],[Wt.r.UV0,2],[Wt.r.NORMAL,3],[Wt.r.COLOR,4],[Wt.r.COLORFEATUREATTRIBUTE,4],[Wt.r.SIZE,5],[Wt.r.SIZEFEATUREATTRIBUTE,5],[Wt.r.OPACITYFEATUREATTRIBUTE,6]]);class LineMarkerTechnique_j extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,LineMarkerTechnique_j.shader.get().build(this.configuration),Vc)}_makePipelineState(R,G){const H=this.configuration,W=R===pa.y.NONE;return(0,Un.Ey)({blending:H.output===En.V.Color||H.output===En.V.Alpha?W?ha.V0:(0,ha.ez)(R):null,depthTest:H.space===ca.lM.Draped?null:{func:(0,ha.K_)(R)},depthWrite:H.space===ca.lM.Draped?null:W?H.writeDepth?Un.kn:null:(0,ha.XO)(R),colorWrite:Un.wE,stencilWrite:H.hasOccludees?ua.v0:null,stencilTest:H.hasOccludees?G?ua.a9:ua.qh:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=(0,Un.Ey)({blending:ha.V0,depthTest:ua.sf,depthWrite:null,colorWrite:Un.wE,stencilWrite:null,stencilTest:ua.mK}),this._occluderPipelineOpaque=(0,Un.Ey)({blending:ha.V0,depthTest:ua.sf,depthWrite:null,colorWrite:Un.wE,stencilWrite:ua.r8,stencilTest:ua.I$}),this._occluderPipelineMaskWrite=(0,Un.Ey)({blending:null,depthTest:ua.m,depthWrite:null,colorWrite:null,stencilWrite:ua.v0,stencilTest:ua.a9})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipeline(R,G,H){return R?this._occludeePipelineState:this.configuration.occluder?H?this._occluderPipelineTransparent:G?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}LineMarkerTechnique_j.shader=new Dn.$(Nc.L,(()=>H.e(9771).then(H.bind(H,59771))));class LineMarkerMaterial_v extends Pn.im{constructor(R){super(R,new LineMarkerMaterial_S),this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>R===En.V.Highlight||(0,En.j8)(R)&&this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil],[Mn.N.OPAQUE_NO_SSAO_DEPTH,R=>R===En.V.LinearDepth],[Mn.N.OCCLUDER_MATERIAL,R=>(0,En.MU)(R)&&this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil],[Mn.N.TRANSPARENT_OCCLUDER_MATERIAL,R=>(0,En.MU)(R)&&this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil],[Mn.N.TRANSPARENT_MATERIAL,R=>(0,En.j8)(R)&&this.parameters.writeDepth],[Mn.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,R=>(0,En.j8)(R)&&!this.parameters.writeDepth],[Mn.N.DRAPED_MATERIAL,R=>R===En.V.Color||R===En.V.Highlight]]),this._vertexAttributeLocations=Vc,this._configuration=new ca.Dt,this._layout=this.createLayout()}getConfiguration(R,G){return this._configuration.output=R,this._configuration.space=G.slot===Mn.N.DRAPED_MATERIAL?ca.lM.Draped:this.parameters.worldSpace?ca.lM.World:ca.lM.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==fa.x.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===Pn.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=G.transparencyPassType,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration.cullAboveGround=G.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const R=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec3f(Wt.r.PREVPOSITION).vec2f(Wt.r.UV0);return this.parameters.worldSpace&&R.vec3f(Wt.r.NORMAL),this.parameters.vvSize?R.f32(Wt.r.SIZEFEATUREATTRIBUTE):R.f32(Wt.r.SIZE),this.parameters.vvColor?R.f32(Wt.r.COLORFEATUREATTRIBUTE):R.vec4f(Wt.r.COLOR),this.parameters.vvOpacity&&R.f32(Wt.r.OPACITYFEATUREATTRIBUTE),R}createBufferWriter(){return new LineMarkerMaterial_g(this._layout,this.parameters)}createGLMaterial(R){return new LineMarkerMaterial_O(R)}}class LineMarkerMaterial_O extends ic.m{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(R){const G=this._material.parameters.markerPrimitive;return G!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(G,this._markerPrimitive)}),this._markerPrimitive=G),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(LineMarkerTechnique_j,R)}_updateOccludeeState(R){R.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:R.hasOccludees})}beginSlot(R){return this._output!==En.V.Color&&this._output!==En.V.Alpha||this._updateOccludeeState(R),this._updateParameters(R)}}class LineMarkerMaterial_S extends la.S{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=fa.x.BUTT,this.anchor=ca.kJ.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}}class LineMarkerMaterial_g{constructor(R,G){this.vertexBufferLayout=R,this._parameters=G}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(R,G,H,W,q){const Q=H.attributes.get(Wt.r.POSITION).data,J=Q.length/3;let X=[1,0,0];const $=H.attributes.get(Wt.r.NORMAL);this._parameters.worldSpace&&null!=$&&(X=$.data);let K=1,ee=0;this._parameters.vvSize?ee=H.attributes.get(Wt.r.SIZEFEATUREATTRIBUTE).data[0]:H.attributes.has(Wt.r.SIZE)&&(K=H.attributes.get(Wt.r.SIZE).data[0]);let te=[1,1,1,1],ie=0;this._parameters.vvColor?ie=H.attributes.get(Wt.r.COLORFEATUREATTRIBUTE).data[0]:H.attributes.has(Wt.r.COLOR)&&(te=H.attributes.get(Wt.r.COLOR).data);let re=0;this._parameters.vvOpacity&&(re=H.attributes.get(Wt.r.OPACITYFEATUREATTRIBUTE).data[0]);const ne=new Float32Array(W.buffer);let se=q*(this.vertexBufferLayout.stride/4);const v=(R,G,H,W)=>{if(ne[se++]=R[0],ne[se++]=R[1],ne[se++]=R[2],ne[se++]=G[0],ne[se++]=G[1],ne[se++]=G[2],ne[se++]=H[0],ne[se++]=H[1],this._parameters.worldSpace&&(ne[se++]=X[0],ne[se++]=X[1],ne[se++]=X[2]),this._parameters.vvSize?ne[se++]=ee:ne[se++]=K,this._parameters.vvColor)ne[se++]=ie;else{const R=Math.min(4*W,te.length-4);ne[se++]=te[R],ne[se++]=te[R+1],ne[se++]=te[R+2],ne[se++]=te[R+3]}this._parameters.vvOpacity&&(ne[se++]=re)};let ae;!function(R){R[R.ASCENDING=1]="ASCENDING",R[R.DESCENDING=-1]="DESCENDING"}(ae||(ae={}));const S=(G,H)=>{const W=(0,be.s)(Uc,Q[3*G],Q[3*G+1],Q[3*G+2]),q=Gc;let X=G+H;do{(0,be.s)(q,Q[3*X],Q[3*X+1],Q[3*X+2]),X+=H}while((0,be.G)(W,q)&&X>=0&&X<J);R&&((0,be.e)(W,W,R),(0,be.e)(q,q,R)),v(W,q,[-1,-1],G),v(W,q,[1,-1],G),v(W,q,[1,1],G),v(W,q,[-1,-1],G),v(W,q,[1,1],G),v(W,q,[-1,1],G)},oe=this._parameters.placement;"begin"!==oe&&"begin-end"!==oe||S(0,ae.ASCENDING),"end"!==oe&&"begin-end"!==oe||S(J-1,ae.DESCENDING)}}const Uc=(0,xe.vt)(),Gc=(0,xe.vt)(),zc={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},Bc={dash:zc.dash,"dash-dot":[...zc.dash,...zc.dot],dot:zc.dot,"long-dash":zc["long-dash"],"long-dash-dot":[...zc["long-dash"],...zc.dot],"long-dash-dot-dot":[...zc["long-dash"],...zc.dot,...zc.dot],none:null,"short-dash":zc["short-dash"],"short-dash-dot":[...zc["short-dash"],...zc["short-dot"]],"short-dash-dot-dot":[...zc["short-dash"],...zc["short-dot"],...zc["short-dot"]],"short-dot":zc["short-dot"],solid:null},Hc=8;function lineStippleUtils_n(R){return null!=R&&"style"===R.type?function lineStippleUtils_l(R){return null!=R?function lineStippleUtils_s(R,G){return null==R?R:{pattern:R.slice(),pixelRatio:G}}(Bc[R],Hc):null}(R.style):null}var jc=H(84661);const Wc=["polyline","polygon","extent"],kc=new hn.wI({size:!0,color:!0,rotation:!1,opacity:!0});class Graphics3DLineSymbolLayer_O extends Graphics3DSymbolLayer_h{constructor(R,G,H,W){super(R,G,H,W)}async doLoad(){if(this._fastUpdates=(0,hn.s_)(this._context.renderer,kc),!this._drivenProperties.size&&(null!=this.symbolLayer.size?this.symbolLayer.size:(0,kr.PN)(1))<0)throw new Ze.A("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}_getMaterialParameters(R){var G,H;let W=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const q=this._getCombinedOpacityAndColor(W&&this._markerColor||this._materialColor);this._patternHidesLine&&!W&&(q[3]=0);const Q={width:this._computeMaterialWidth(null===(G=this.symbolLayer)||void 0===G?void 0:G.size),color:q,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:lineUtils_n(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:R,stipplePattern:lineStippleUtils_n(this.symbolLayer.pattern)};return null!==(H=this._fastUpdates)&&void 0!==H&&H.visualVariables?{...Q,...this._fastUpdates.materialParameters}:Q}get _materialColor(){var R;return null===(R=this.symbolLayer.material)||void 0===R?void 0:R.color}get _markerColor(){var R;return null===(R=this.symbolLayer.marker)||void 0===R?void 0:R.color}get _lineMaterial(){return null==this._materials[Zc.Line]&&(this._materials[Zc.Line]=new RibbonLineMaterial_H(this._getMaterialParameters(!1)),this._context.stage.add(this._materials[Zc.Line])),this._materials[Zc.Line]}get _ringMaterial(){return null==this._materials[Zc.Ring]&&(this._materials[Zc.Ring]=new RibbonLineMaterial_H(this._getMaterialParameters(!0)),this._context.stage.add(this._materials[Zc.Ring])),this._materials[Zc.Ring]}get _wireframeLineMaterial(){return null==this._materials[Zc.LineWireframe]&&(this._materials[Zc.LineWireframe]=new RibbonLineMaterial_H({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._materials[Zc.LineWireframe])),this._materials[Zc.LineWireframe]}get _wireframeRingMaterial(){return null==this._materials[Zc.RingWireframe]&&(this._materials[Zc.RingWireframe]=new RibbonLineMaterial_H({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._materials[Zc.RingWireframe])),this._materials[Zc.RingWireframe]}get _markerMaterial(){return null==this._materials[Zc.Marker]&&null!=this.symbolLayer.marker&&(this._materials[Zc.Marker]=new LineMarkerMaterial_v({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,markerPrimitive:lineUtils_r(this.symbolLayer.marker.style)}),this._context.stage.add(this._materials[Zc.Marker])),this._materials[Zc.Marker]}destroy(){super.destroy(),this._forEachMaterial((R=>this._context.stage.remove(R))),this._materials.length=0}_getDrivenSize(R){return this._drivenProperties.size&&R.size?(0,kr.Lz)(function renderingInfoUtils_s(R){for(let G=0;G<3;G++){const H=R[G];if("number"==typeof H)return isFinite(H)?H:0}return 0}(R.size)):1}_getDrivenColor(R){const G=(0,Ce.fA)(1,1,1,1);return this._drivenProperties.color&&R.color&&(G[0]=R.color[0],G[1]=R.color[1],G[2]=R.color[2],R.color.length>0&&(G[3]=R.color[3])),this._drivenProperties.opacity&&R.opacity&&(G[3]=R.opacity),G}createGraphics3DGraphic(R){const G=R.graphic;if(!this._validateGeometry(G.geometry,Wc,this.symbolLayer.type))return null;const H=this.setGraphicElevationContext(G);return this.ensureDrapedStatus("on-the-ground"===H.mode),this.draped?this._createAsOverlay(R,this._context.layer.uid):this._createAs3DShape(R,H,G.uid)}applyRendererDiff(R,G){for(const H in R.diff){if("visualVariables"!==H)return cn.RecreateSymbol;{const R=this._fastUpdates;if(!(0,hn.J_)(R,G,kc))return cn.RecreateSymbol;this._forEachMaterial((G=>null===G||void 0===G?void 0:G.setParameters(R.materialParameters)))}}return cn.FastUpdate}prepareSymbolLayerPatch(R){var G,H,W;if("partial"!==R.diff.type)return;const q=R.diff.diff,Q={};"complete"===(null===(G=q.size)||void 0===G?void 0:G.type)&&(Q.width=this._computeMaterialWidth(q.size.newValue),delete q.size),"complete"===(null===(H=q.cap)||void 0===H?void 0:H.type)&&(Q.cap=lineUtils_n(null!==(W=q.cap.newValue)&&void 0!==W?W:"butt"),delete q.cap);const J=this._prepareMarkerPatch(R,q);this._prepareMaterialPatch(R,q,J),R.symbolLayerStatePatches.push((()=>this._forEachMaterial((R=>null===R||void 0===R?void 0:R.setParameters(Q)))))}layerOpacityChanged(){this._forEachMaterial(((R,G)=>this._updateMaterialLayerOpacity(R,G===Zc.Marker)))}_forEachMaterial(R){this._materials.forEach(R)}_updateMaterialLayerOpacity(R){var G;let H=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(null==R)return;const W=R.parameters.color,q=null===(G=this.symbolLayer)||void 0===G||null===(G=G.material)||void 0===G?void 0:G.color,Q=this._patternHidesLine&&!H?0:this._getCombinedOpacity(q),J=(0,Ce.fA)(W[0],W[1],W[2],Q);R.setParameters({color:J})}layerElevationInfoChanged(R,G,H){const W=this._elevationContext.mode,q=elevationAlignmentUtils_m(Graphics3DLineSymbolLayer_O.elevationModeChangeTypes,H,W);if(q!==Ht.UPDATE)return q;const Q=elevationAlignmentUtils_d(W);return this.updateGraphics3DGraphicElevationInfo(R,G,(()=>Q))}slicePlaneEnabledChanged(){const R={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial((G=>null===G||void 0===G?void 0:G.setParameters(R))),!0}physicalBasedRenderingChanged(){return!0}_getGeometryAsPolygonOrPolyline(R){switch(R.type){case"extent":if(R instanceof jc.A)return Jn.A.fromExtent(R);break;case"polygon":case"polyline":return R}return null}_createAs3DShape(R,G,H){const W=R.graphic,q=this._getGeometryAsPolygonOrPolyline(W.geometry),Q="polygon"===q.type?q.rings:q.paths,J=new Array,X=(0,Le.vt)(),$=function line_p(R,G,H,W){const q="polygon"===R.type?Ts.Wq.CCW_IS_HOLE:Ts.Wq.NONE,Q="polygon"===R.type?R.rings:R.paths,{position:J,outlines:X}=(0,Ts.jp)(Q,!!R.hasZ,q,R.spatialReference),$=(0,Ne.jh)(J.length),K=elevationAlignmentUtils_u(J,R.spatialReference,0,$,0,J,0,J.length/3,G,H,W),ee=null!=K;return{lines:ee?line_c(X,J,$):[],projectionSuccess:ee,sampledElevation:K}}(q,this._context.elevationProvider,this._context.renderCoordsHelper,G),K="polygon"===q.type?"rings":"paths";this._logGeometryCreationWarnings($,Q,K,"LineSymbol3DLayer");for(let ie=0;ie<$.lines.length;ie++){const G=$.lines[ie],W=G.position,Q=G.mapPositions;if(null!=this._context.clippingExtent&&((0,Le.Ie)(X),(0,Le.Hq)(X,Q),!(0,Le.KG)(X,this._context.clippingExtent)))continue;const K=this._createGeometry("polygon"===q.type?this._ringMaterial:this._lineMaterial,R,W,Q,q.type,qc.ELEVATED,H);J.push(K),qr.b.LINE_WIREFRAMES&&J.push(K.instantiate({material:"polygon"===q.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),null!=this._markerMaterial&&J.push(K.instantiate({material:this._markerMaterial}))}if(0===J.length)return null;const ee=new Object3D_O({geometries:J,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:H}),te=new Graphics3DObject3DGraphicLayer_p(this,ee,J,null,null,ElevationAligners_I,G);return te.alignedSampledElevation=$.sampledElevation,te.needsElevationUpdates=elevationAlignmentUtils_d(G.mode),te}_createGeometry(R,G,H,W,q,Q,J){var X,$,K;const ee=Q===qc.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,te="polygon"===q,ie=null===(X=this._fastUpdates)||void 0===X?void 0:X.visualVariables.color,re=null===($=this._fastUpdates)||void 0===$?void 0:$.visualVariables.size,ne=null===(K=this._fastUpdates)||void 0===K?void 0:K.visualVariables.opacity,se=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:J,layerUid:this._context.layer.uid});return line_b(R,{overlayInfo:ee,removeDuplicateStartEnd:te,mapPositions:W,attributeData:{position:H,size:re?null:this._getDrivenSize(G.renderingInfo),color:ie?null:this._getDrivenColor(G.renderingInfo),sizeFeature:re?(0,hn.ul)(re.field,G.graphic):null,colorFeature:ie?(0,hn.ul)(ie.field,G.graphic):null,opacityFeature:ne?(0,hn.ul)(ne.field,G.graphic):null}},se)}_createAsOverlay(R,G){const H=R.graphic,W=this._getGeometryAsPolygonOrPolyline(H.geometry),q="polygon"===W.type?W.rings:W.paths,Q="polygon"===W.type?this._ringMaterial:this._lineMaterial;Q.renderPriority=this._renderPriority;const J=qr.b.LINE_WIREFRAMES?"polygon"===W.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,X=this._markerMaterial;null!=J&&(J.renderPriority=this._renderPriority-.001),null!=X&&(X.renderPriority=this._renderPriority-.002);const $=new Array,K=(0,Le.vt)(),ee=(0,Le.Ie)(),te=function line_l(R,G){const H="polygon"===R.type?Ts.Wq.CCW_IS_HOLE:Ts.Wq.NONE,W="polygon"===R.type?R.rings:R.paths,{position:q,outlines:Q}=(0,Ts.jp)(W,!1,H),J=(0,Ie.projectBuffer)(q,R.spatialReference,0,q,G,0,q.length/3);for(let X=2;X<q.length;X+=3)q[X]=-2;return{lines:J?line_c(Q,q):[],projectionSuccess:J}}(W,this._context.overlaySR),ie="polygon"===W.type?"rings":"paths";this._logGeometryCreationWarnings(te,q,ie,"LineSymbol3DLayer");for(const re of te.lines){if((0,Le.Ie)(K),(0,Le.Hq)(K,re.position),!(0,Le.KG)(K,this._context.clippingExtent))continue;(0,Le.RF)(ee,K);const a=q=>{const Q=this._createGeometry(q,R,re.position,void 0,W.type,qc.DRAPED,H.uid),J=new RenderGeometry_m(Q,{layerUid:G,graphicUid:H.uid});$.push(J)};if(null!=X){a(X);const R=this.symbolLayer.marker.placement;"begin"!==R&&"begin-end"!==R||(0,Le.Hq)(K,re.position,0,1),"end"!==R&&"begin-end"!==R||(0,Le.Hq)(K,re.position,re.position.length-3,1)}a(Q),qr.b.LINE_WIREFRAMES&&a(J)}return new Graphics3DDrapedGraphicLayer_l(this,$,ee,this._context.drapeSourceRenderer)}get _patternHidesLine(){const R=this.symbolLayer.pattern;return null!=R&&"style"===R.type&&"none"===R.style}_computeMaterialWidth(R){var G,H;return R=null!==(G=R)&&void 0!==G?G:(0,kr.PN)(1),this._drivenProperties.size?null!==(H=this._fastUpdates)&&void 0!==H&&H.visualVariables.size?(0,kr.Lz)(1):1:(0,kr.Lz)(R)}_prepareMaterialPatch(R,G,H){var W,q;const Q=G.material;if(null==Q)return void(H.changed&&H.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._materials[Zc.Marker],R));if("collection"===Q.type)return;const J="complete"===Q.type?null===(W=Q.newValue)||void 0===W?void 0:W.color:"complete"===(null===(q=Q.diff.color)||void 0===q?void 0:q.type)?Q.diff.color.newValue:null,X=this._getCombinedOpacityAndColor(J);H.useMaterialColor&&this._patchMaterialColor((0,Ce.o8)(X),this._materials[Zc.Marker],R),this._patternHidesLine&&(X[3]=0),this._patchMaterialColor(X,this._materials[Zc.Line],R),delete G.material}_prepareMarkerPatch(R,G){var H;const W=G.marker,q=this._markerMaterial;if(null==W||"partial"!==W.type||null==W.diff||null!=W.diff.placement||null!=W.diff.style&&"complete"!==W.diff.style.type||null!=W.diff.color&&"complete"!==W.diff.color.type||null==q)return{changed:!1,useMaterialColor:null==this._markerColor};const Q=W.diff.color,J=null!=Q,X=J?Q.newValue:null,$=null==X&&null==this._markerColor;X&&this._patchMaterialColor(this._getCombinedOpacityAndColor(X),q,R);const K=null===(H=W.diff.style)||void 0===H?void 0:H.newValue;return K&&R.symbolLayerStatePatches.push((()=>q.setParameters({markerPrimitive:lineUtils_r(K)}))),delete G.marker,{changed:J,useMaterialColor:$}}_patchMaterialColor(R,G,H){null!=G&&H.symbolLayerStatePatches.push((()=>G.setParameters({color:R})))}}var qc,Zc;function projectVectorToPoint_t(R,G,H){return!!(0,De.F)(R,G,Qc,H.spatialReference)&&(H.x=Qc[0],H.y=Qc[1],H.z=Qc[2],!0)}Graphics3DLineSymbolLayer_O.elevationModeChangeTypes={definedChanged:Ht.RECREATE,staysOnTheGround:Ht.NONE,onTheGroundChanged:Ht.RECREATE},function(R){R[R.DRAPED=0]="DRAPED",R[R.ELEVATED=1]="ELEVATED"}(qc||(qc={})),function(R){R[R.Line=0]="Line",R[R.Ring=1]="Ring",R[R.LineWireframe=2]="LineWireframe",R[R.RingWireframe=3]="RingWireframe",R[R.Marker=4]="Marker"}(Zc||(Zc={}));const Qc=(0,xe.vt)();var Yc,Jc=H(18053),Xc=H(93960),$c=H(56185),Kc=H(20148),ed=H(38559);!function(R){R[R.EnableFastUpdates=0]="EnableFastUpdates",R[R.DisableFastUpdates=1]="DisableFastUpdates",R[R.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"}(Yc||(Yc={}));var td=H(71759);class Graphics3DMeshObject3DGraphicLayer_c extends Graphics3DObject3DGraphicLayer_p{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(R,G){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:H}=this,W=H.geometries.slice();H.removeAllGeometries();const q=(0,ye.sC)(id,H.transformation),Q=G.getOrigin(q);for(const J of W){const G=R(J.material),W=J.instantiate({material:G});W.localOrigin=Q,H.addGeometry(W)}this._originalGeometries=W}disableFastTransformUpdates(R){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:G}=this,H=G.geometries.map((G=>R(G.material)));G.removeAllGeometries();for(let W=0;W<this._originalGeometries.length;W++){const R=this._originalGeometries[W],q=H[W];q.setParameters({modelTransformation:null}),q===R.material?G.addGeometry(R):G.addGeometry(R.instantiate({material:q}))}this._originalGeometries.length=0}updateFastLocalOrigin(R,G,H){var W;if(!this._fastTransformUpdatesEnabled)return;const{stageObject:q}=this;if(0===q.geometries.length)return;const Q=q.geometries[0].localOrigin,J=(0,ye.sC)(id,R),X=H.getOrigin(J);if(X===Q)return;const $=null!==(W=null===G||void 0===G?void 0:G.localMatrix)&&void 0!==W?W:ve.zK;q.shaderTransformation=null,q.transformation=R,q.geometries.forEach((R=>{R.transformation=$,R.localOrigin=X}))}updateTransform(R,G,H){var W;const{stageObject:q}=this,Q=null!==(W=null===G||void 0===G?void 0:G.localMatrix)&&void 0!==W?W:ve.zK;if(!this._fastTransformUpdatesEnabled)return q.shaderTransformation=null,q.transformation=R,q.geometries.forEach((R=>{R.transformation=Q})),void(this._fastUpdateEdgeTransform()||this.resetEdgeObject(H));const J=q.transformation,X=q.geometries[0].transformation,$=R,K=Q,ee=(0,ye.lw)(rd,J,X),te=(0,ye.lw)(nd,$,K),ie=(0,ye.lw)(ad,te,(0,ye.B8)(ad,X));q.shaderTransformation=ie,this._setFastMaterialTransformation({matA:ee,matB:te}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(H)}alignWithElevation(R,G,H,W){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(R,G,H,W);null!=H&&featureExpressionInfoUtils_l(this.elevationContext.featureExpressionInfoContext,H);const{stageObject:q}=this;if(!q.geometries[0].material.parameters.modelTransformation)return;const Q=q.transformation,J=q.geometries[0].transformation,X=(0,ye.lw)(rd,Q,J),$=q.effectiveTransformation,K=(0,ye.C)(sd,$);this.alignedSampledElevation=ElevationAligners_p(this,this.elevationContext,R.spatialReference,((H,W)=>elevationAlignmentUtils_c(H,R,this.elevationContext,G,W)),G,K),q.shaderTransformation=K;const ee=q.geometries[0].transformation,te=(0,ye.lw)(nd,K,ee);this._setFastMaterialTransformation({matA:X,matB:te}),this._fastUpdateEdgeTransform()||this.resetEdgeObject(W)}_setFastMaterialTransformation(R){let{matA:G,matB:H}=R;const{stageObject:W}=this;if(0===W.geometries.length)return;const q=W.geometries[0].localOrigin,Q=(0,ye.kN)(cd,(0,be.h)(id,q.vec3,-1)),J=(0,ye.lw)(od,Q,G),X=(0,ye.lw)(ld,Q,H),$=(0,ye.B8)(od,J),K=(0,ye.lw)(ld,X,$);for(const ee of W.geometries)ee.material.setParameters({modelTransformation:K})}_fastUpdateEdgeTransform(){return this._stageLayer.stage.renderer.ensureEdgeView().fastUpdateObject3DEdgesTransform(this.stageObject)}}const id=(0,xe.vt)(),rd=(0,ve.vt)(),nd=(0,ve.vt)(),sd=(0,ve.vt)(),ad=(0,ve.vt)(),od=(0,ve.vt)(),ld=(0,ve.vt)(),cd=(0,ve.vt)();class MeshFastUpdateProcessor_r{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(R,G,H){R.enableFastTransformUpdates((R=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(R))return R;const H=G.byMaterial(R);return this._fastTransformOriginalMaterials.set(R,H),G.delete(R),R}const W=new Mr.$U(R.parameters);return H.stage.add(W),this._fastTransformClonedMaterials.set(W,R),W}),H.localOriginFactory)}disable(R,G,H){const W=new Set,q=new Set;R.disableFastTransformUpdates((R=>{if(!this._fastTransformClonedMaterials.has(R)){const H=R,Q=this._fastTransformOriginalMaterials.get(H);return G.has(Q.uid)?(W.add(H),G.byUid(Q.uid).material):(q.add(H),Q.material)}const Q=R,J=this._fastTransformClonedMaterials.get(Q);return this._fastTransformClonedMaterials.delete(Q),H.stage.remove(Q),J}));for(const Q of W)this._fastTransformOriginalMaterials.delete(Q),H.stage.remove(Q);for(const Q of q){const R=this._fastTransformOriginalMaterials.get(Q);this._fastTransformOriginalMaterials.delete(Q),G.set(R.uid,R)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(R,G,H){this._graphicReferenceCount--,this.disable(R,G,H)}forEachMaterialInfo(R){this._fastTransformOriginalMaterials.forEach(R)}forEachClonedMaterial(R){this._fastTransformClonedMaterials.forEach(R)}destroy(R){R.removeMany(Array.from(this._fastTransformClonedMaterials.keys())),R.removeMany(Array.from(this._fastTransformOriginalMaterials.values(),(R=>{let{material:G}=R;return G}))),this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}}class MeshFastUpdateProcessor_t{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),(R=>R.material))}byUid(R){return this._byUid.get(R)}byMaterial(R){return this._byMaterial.get(R)}set(R,G){this._byUid.set(R,G),this._byMaterial.set(G.material,G)}delete(R){var G;const H=null===(G=this._byMaterial.get(R))||void 0===G?void 0:G.uid;H&&(this._byUid.delete(H),this._byMaterial.delete(R))}has(R){return this._byUid.has(R)}forEachMaterialInfo(R){this._byUid.forEach(R)}clear(){this._byUid.clear(),this._byMaterial.clear()}}var dd=H(73934),hd=H(59649);const ud=(0,Tn.BP)().vec3f(Wt.r.POSITION),pd=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec2f(Wt.r.UV0),_d=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec4u8(Wt.r.COLOR),md=((0,Tn.BP)().vec3f(Wt.r.POSITION).vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR),(0,Tn.BP)().vec3f(Wt.r.POSITION).vec2f(Wt.r.UV0).vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR));(0,Tn.BP)().vec3f(Wt.r.POSITION).vec4u8(Wt.r.COLOR).vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR);var gd=H(3506);class NativeLineTechnique_S extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,NativeLineTechnique_S.shader.get().build(this.configuration),Fn.D)}initializePipeline(){const R=this.configuration,G=(0,Un.p3)(Ft.dn.SRC_ALPHA,Ft.dn.ONE,Ft.dn.ONE_MINUS_SRC_ALPHA,Ft.dn.ONE_MINUS_SRC_ALPHA),i=function(G){let H=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,W=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,Un.Ey)({blending:H,depthTest:ua.m,depthWrite:W,colorWrite:Un.wE,stencilWrite:R.hasOccludees?ua.v0:null,stencilTest:R.hasOccludees?G?ua.a9:ua.qh:null})};return R.output===En.V.Color?(this._occludeePipelineState=i(!0,R.transparent?G:null,Un.kn),i(!1,R.transparent?G:null,Un.kn)):i(!1)}get primitiveType(){return Ft.WR.LINES}getPipeline(R){return R?this._occludeePipelineState:super.getPipeline()}}NativeLineTechnique_S.shader=new Dn.$(gd.N,(()=>H.e(2376).then(H.bind(H,32376))));class NativeLineTechniqueConfiguration_s extends zn.E{constructor(){super(...arguments),this.output=En.V.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1}}(0,W._)([(0,Gn.W)({count:En.V.COUNT})],NativeLineTechniqueConfiguration_s.prototype,"output",void 0),(0,W._)([(0,Gn.W)()],NativeLineTechniqueConfiguration_s.prototype,"hasSlicePlane",void 0),(0,W._)([(0,Gn.W)()],NativeLineTechniqueConfiguration_s.prototype,"hasVertexColors",void 0),(0,W._)([(0,Gn.W)()],NativeLineTechniqueConfiguration_s.prototype,"transparent",void 0),(0,W._)([(0,Gn.W)()],NativeLineTechniqueConfiguration_s.prototype,"hasOccludees",void 0);class NativeLineMaterial_V extends Pn.im{constructor(R){super(R,new NativeLineMaterial_U),this._configuration=new NativeLineTechniqueConfiguration_s,this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>R===En.V.Color||R===En.V.Highlight||R===En.V.ObjectAndLayerIdColor]])}getConfiguration(R){return this._configuration.output=R,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration}intersect(R,G,H,W,q,Q){if(!H.options.selectionMode||!R.visible)return;if(!(0,nr.zH)(G))return void J.A.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const X=R.attributes.get(Wt.r.POSITION).data,$=H.camera,K=Td;(0,Yn.C)(K,H.point);(0,be.s)(Ed[0],K[0]-2,K[1]+2,0),(0,be.s)(Ed[1],K[0]+2,K[1]+2,0),(0,be.s)(Ed[2],K[0]+2,K[1]-2,0),(0,be.s)(Ed[3],K[0]-2,K[1]-2,0);for(let J=0;J<4;J++)if(!$.unprojectFromRenderScreen(Ed[J],Od[J]))return;(0,Ki.Cr)($.eye,Od[0],Od[1],Pd),(0,Ki.Cr)($.eye,Od[1],Od[2],Md),(0,Ki.Cr)($.eye,Od[2],Od[3],Id),(0,Ki.Cr)($.eye,Od[3],Od[0],Dd);let ee=Number.MAX_VALUE,te=0;for(let J=0;J<X.length-5;J+=3){if(fd[0]=X[J]+G[12],fd[1]=X[J+1]+G[13],fd[2]=X[J+2]+G[14],yd[0]=X[J+3]+G[12],yd[1]=X[J+4]+G[13],yd[2]=X[J+5]+G[14],(0,Ki.mN)(Pd,fd)<0&&(0,Ki.mN)(Pd,yd)<0||(0,Ki.mN)(Md,fd)<0&&(0,Ki.mN)(Md,yd)<0||(0,Ki.mN)(Id,fd)<0&&(0,Ki.mN)(Id,yd)<0||(0,Ki.mN)(Dd,fd)<0&&(0,Ki.mN)(Dd,yd)<0)continue;if($.projectToRenderScreen(fd,xd),$.projectToRenderScreen(yd,Sd),xd[2]<0&&Sd[2]>0){(0,be.f)(vd,fd,yd);const R=$.frustum,G=-(0,Ki.mN)(R[zt.FB.NEAR],fd)/(0,be.k)(vd,(0,Ki.Qj)(R[zt.FB.NEAR]));(0,be.h)(vd,vd,G),(0,be.g)(fd,fd,vd),$.projectToRenderScreen(fd,xd)}else if(xd[2]>0&&Sd[2]<0){(0,be.f)(vd,yd,fd);const R=$.frustum,G=-(0,Ki.mN)(R[zt.FB.NEAR],yd)/(0,be.k)(vd,(0,Ki.Qj)(R[zt.FB.NEAR]));(0,be.h)(vd,vd,G),(0,be.g)(yd,yd,vd),$.projectToRenderScreen(yd,Sd)}else if(xd[2]<0&&Sd[2]<0)continue;xd[2]=0,Sd[2]=0;const R=(0,oa.kb)((0,oa.Cr)(xd,Sd,Ad),K);R<ee&&(ee=R,(0,be.c)(Cd,fd),(0,be.c)(wd,yd),te=J/3)}const ie=H.rayBegin,re=H.rayEnd;if(ee<4){let R=Number.MAX_VALUE;if((0,oa.ld)((0,oa.Cr)(Cd,wd,Ad),(0,oa.Cr)(ie,re,Rd),bd)){(0,be.f)(bd,bd,ie);const G=(0,be.l)(bd);(0,be.h)(bd,bd,1/G),R=G/(0,be.q)(ie,re)}Q(R,bd,te,!1)}}intersectDraped(R,G,H,W,q,Q){if(!H.options.selectionMode)return;const J=R.attributes.get(Wt.r.POSITION).data,X=R.attributes.get(Wt.r.SIZE),$=X?X.data[0]:0,K=W[0],ee=W[1],te=(($+1)/2+4)*R.screenToWorldRatio;let ie=Number.MAX_VALUE,re=0;for(let ne=0;ne<J.length-5;ne+=3){const R=J[ne],G=J[ne+1],H=K-R,W=ee-G,q=J[ne+3]-R,Q=J[ne+4]-G,X=(0,Ee.qE)((q*H+Q*W)/(q*q+Q*Q),0,1),$=q*X-H,te=Q*X-W,se=$*$+te*te;se<ie&&(ie=se,re=ne/3)}ie<te*te&&q(Q.dist,Q.normal,re,!1)}createGLMaterial(R){return new NativeLineMaterial_I(R)}createBufferWriter(){const R=this.parameters.hasVertexColors?_d:ud;return new hd.Z(R)}}class NativeLineMaterial_I extends On.A{_updateOccludeeState(R){R.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:R.hasOccludees})}beginSlot(R){return this._output===En.V.Color&&this._updateOccludeeState(R),this.ensureTechnique(NativeLineTechnique_S,R)}}class NativeLineMaterial_U extends Pn.qA{constructor(){super(...arguments),this.color=Ce.Un,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.hasOccludees=!1}}const fd=(0,xe.vt)(),yd=(0,xe.vt)(),vd=(0,xe.vt)(),bd=(0,xe.vt)(),xd=(0,kr.r_)(),Sd=(0,kr.r_)(),Cd=(0,xe.vt)(),wd=(0,xe.vt)(),Ad=(0,oa.vt)(),Rd=(0,oa.vt)(),Td=(0,xe.vt)(),Ed=[(0,kr.r_)(),(0,kr.r_)(),(0,kr.r_)(),(0,kr.r_)()],Od=[(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)(),(0,xe.vt)()],Pd=(0,Ki.vt)(),Md=(0,Ki.vt)(),Id=(0,Ki.vt)(),Dd=(0,Ki.vt)(),Ld=["mesh"];class Graphics3DMeshFillSymbolLayer_Re{constructor(R,G,H){this.normals=R,this.indices=G,this.didFlipNormals=H}}const Fd=(0,xe.vt)(),Nd=(0,xe.vt)(),Vd=(0,xe.vt)(),Ud=(0,xe.vt)(),Gd=(0,xe.vt)(),zd=(0,ve.vt)(),Bd=(0,fe.vt)(),Hd=(0,ve.vt)(),jd=(0,Le.vt)(),Wd=[new Jc.A],kd=new $c.A;var qd;!function(R){R[R.NONE=0]="NONE",R[R.RENDER=1]="RENDER"}(qd||(qd={}));var Zd=H(88277);class Graphics3DLodInstanceGraphicLayer_p{constructor(R,G,H,W){this.graphics3DSymbolLayer=R,this.instanceIndex=G,this.elevationAligner=H,this.elevationContext=W,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(R){const G=this._lodRenderer.instanceData;R!==G.getVisible(this.instanceIndex)&&G.setVisible(this.instanceIndex,R)}destroy(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(R,G,H){if(this.elevationAligner){featureExpressionInfoUtils_l(this.elevationContext.featureExpressionInfoContext,H);const n=(H,W)=>elevationAlignmentUtils_c(H,R,this.elevationContext,G,W),W=this.elevationAligner(this,this.elevationContext,R.spatialReference,n,G);null!=W&&(this.alignedSampledElevation=W)}}getCenterObjectSpace(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,xe.vt)();return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,$d),(0,be.e)(R,this._lodRenderer.baseBoundingSphere.center,$d)}getBoundingBoxObjectSpace(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Le.vt)();this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,$d);const G=this._lodRenderer.baseBoundingBox;(0,Le.Ie)(R);for(let H=0;H<8;++H)(0,be.s)(Yd,0==(1&H)?G[0]:G[3],0==(2&H)?G[1]:G[4],0==(4&H)?G[2]:G[5]),(0,be.e)(Yd,Yd,$d),(0,Le.iT)(R,Yd);return R}computeAttachmentOrigin(R){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,$d),R.render.origin[0]+=$d[12],R.render.origin[1]+=$d[13],R.render.origin[2]+=$d[14],R.render.num++}async getProjectedBoundingBox(R,G,H,W,q){const Q=this.getBoundingBoxObjectSpace(q),J=Xd,X=(0,Le.fT)(Q)?1:J.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,$d);for(let ee=0;ee<X;ee++){const R=J[ee];Yd[0]=Q[R[0]],Yd[1]=Q[R[1]],Yd[2]=Q[R[2]],(0,be.e)(Yd,Yd,$d),Qd[3*ee]=Yd[0],Qd[3*ee+1]=Yd[1],Qd[3*ee+2]=Yd[2]}if(!R(Qd,0,X))return null;(0,Le.Ie)(Q);let $=null;this.calculateRelativeScreenBounds&&($=this.calculateRelativeScreenBounds());for(let ee=0;ee<3*X;ee+=3){for(let R=0;R<3;R++)Q[R]=Math.min(Q[R],Qd[ee+R]),Q[R+3]=Math.max(Q[R+3],Qd[ee+R]);$&&H.push({location:Qd.slice(ee,ee+3),screenSpaceBoundingRect:$})}if(G&&((0,Le.gX)(Q,Jd),"absolute-height"!==this.elevationContext.mode)){let R;const H=graphicUtils_k(Q,G.service.spatialReference,G);try{R=await G.service.queryElevation(Jd[0],Jd[1],W,H,"ground")}catch(K){}null!=R&&(0,Le.cY)(Q,0,0,-this.alignedSampledElevation+R)}return Q}addObjectState(R,G){if(R===et.Mg.Highlight){const H=new yn.X(R);this._addHighlightId(H),G.addExternal((R=>{this._removeHighlightId(R)}),H)}}removeObjectState(R){this._highlights.forEach((G=>R.remove(G)))}_addHighlightId(R){this._highlights.add(R),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(R){this._highlights.delete(R),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const Qd=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Yd=(0,xe.vt)(),Jd=(0,xe.vt)(),Xd=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],$d=(0,ve.vt)();function lodResourceUtils_n(R,G){const H=R.stageResources.geometries.map((G=>new LodResources_s(G,R.stageResources.textures))),W=null==R.lodThreshold||0===R.lodThreshold&&G>0?function lodResourceUtils_s(R){const G=R.reduce(((R,G)=>{let{geometry:H}=G;return R+H.indexCount/3}),0);return Math.sqrt(G*Kd/Math.PI)}(H):R.lodThreshold;return new LodResources_r(H,W,R.pivotOffset)}const Kd=20;var eh=H(27790),th=H(48886),ih=H(32658);class BackedBufferObject_r{constructor(R,G,H){this._elementSize=G,this._buffer=Wo.g.createVertex(R,Ft._U.STATIC_DRAW),this.resize(H)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const q=new Uint8Array(this.array,R*this.elementSize,(G-R)*this.elementSize);new Uint8Array(H.array,W*this.elementSize).set(q)}transferAll(){this._buffer.setData(this._array)}transferRange(R,G){const H=R*this._elementSize,W=G*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),H,H,W)}resize(R){const G=R*this._elementSize,H=new ArrayBuffer(G);this._array&&(R>=this._capacity?new Uint8Array(H).set(new Uint8Array(this._array)):new Uint8Array(H).set(new Uint8Array(this._array).subarray(0,R*this._elementSize))),this._array=H,this._buffer.setSize(G),this._capacity=R}}class RenderInstanceData_c{constructor(R){this.modelOriginHi=R.getField(Wt.r.INSTANCEMODELORIGINHI,ec.xs),this.modelOriginLo=R.getField(Wt.r.INSTANCEMODELORIGINLO,ec.xs),this.model=R.getField(Wt.r.INSTANCEMODEL,ec.jZ),this.modelNormal=R.getField(Wt.r.INSTANCEMODELNORMAL,ec.jZ),this.featureAttribute=R.getField(Wt.r.INSTANCEFEATUREATTRIBUTE,ec.Eq),this.color=R.getField(Wt.r.INSTANCECOLOR,ec.XP),this.objectAndLayerIdColor=R.getField(Wt.r.INSTANCEOBJECTANDLAYERIDCOLOR,ec.XP)}}class RenderInstanceData_f{constructor(R,G){this._rctx=R,this._instanceBufferLayout=G,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const R=this._headIndex,G=this._tailIndex;return R>=G?R-G:R+this._capacity-G}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){var R,G;return null!==(R=null===(G=this._buffer)||void 0===G?void 0:G.usedMemory)&&void 0!==R?R:0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,nr.vA)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,nr.vA)(this._updating,"not updating"),this.size<ce.$U*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,nr.vA)(this._updating,"not updating"),this.isFull&&this._grow();const R=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=R,this._captureFirstIndex=!1),this._incrementHead(),(0,nr.vA)(this._headIndex!==this._tailIndex,"invalid pointers"),R}freeTail(){(0,nr.vA)(this._updating,"not updating"),(0,nr.vA)(this.size>0,"invalid size");const R=this._tailIndex===this._firstIndex;this._incrementTail(),R&&(this._firstIndex=this._tailIndex)}_grow(){const R=Math.max(rh,Math.floor(this._capacity*ce.Ji));this._resize(R)}_shrink(){const R=Math.max(rh,Math.floor(this._capacity*ce.He));this._resize(R)}_resize(R){if((0,nr.vA)(this._updating,"not updating"),R===this._capacity)return;const G=new BackedBufferObject_r(this._rctx,this._instanceBufferLayout.stride,R);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const R=this.size,H=this._compactInstances(G);(0,nr.vA)(H===R,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=H,this._prevHeadIndex=0}this._resized=!0,this._capacity=R,this._buffer=G,this._view=new RenderInstanceData_c(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(R){const G=this._headIndex,H=this._tailIndex;return H<G?(this._buffer.copyRange(H,G,R),G-H):H>G?(this._buffer.copyRange(H,this._capacity,R),G>0&&this._buffer.copyRange(0,G,R,this._capacity-H),G+(this._capacity-H)):0}_incrementHead(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._headIndex=(this._headIndex+R)%this._capacity}_incrementTail(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._tailIndex=(this._tailIndex+R)%this._capacity}_transferRange(R,G){R<G?this._buffer.transferRange(R,G):R>G&&(G>0&&this._buffer.transferRange(0,G),this._buffer.transferRange(R,this._capacity))}}const rh=64;var nh;!function(R){R[R.ALLOCATED=1]="ALLOCATED",R[R.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",R[R.VISIBLE=4]="VISIBLE",R[R.HIGHLIGHT=8]="HIGHLIGHT",R[R.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",R[R.REMOVE=32]="REMOVE",R[R.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",R[R.ACTIVE=18]="ACTIVE"}(nh||(nh={}));class InstanceData_R{constructor(R){this.localTransform=R.getField(Wt.r.LOCALTRANSFORM,ec.E$),this.globalTransform=R.getField(Wt.r.GLOBALTRANSFORM,ec.E$),this.modelOrigin=R.getField(Wt.r.MODELORIGIN,ec.Xm),this.model=R.getField(Wt.r.INSTANCEMODEL,ec.jZ),this.modelNormal=R.getField(Wt.r.INSTANCEMODELNORMAL,ec.jZ),this.modelScaleFactors=R.getField(Wt.r.MODELSCALEFACTORS,ec.gH),this.boundingSphere=R.getField(Wt.r.BOUNDINGSPHERE,ec.Aj),this.featureAttribute=R.getField(Wt.r.FEATUREATTRIBUTE,ec.Eq),this.color=R.getField(Wt.r.COLOR,ec.XP),this.objectAndLayerIdColor=R.getField(Wt.r.OBJECTANDLAYERIDCOLOR,ec.XP),this.state=R.getField(Wt.r.STATE,ec.SL),this.lodLevel=R.getField(Wt.r.LODLEVEL,ec.SL)}}let sh=class extends Q.A{constructor(R,G){super(R),this.events=new Vr.A,this._capacity=0,this._size=0,this._next=0,this._layout=function InstanceData_C(R){let G=(0,Tn.BP)().mat4f64(Wt.r.LOCALTRANSFORM).mat4f64(Wt.r.GLOBALTRANSFORM).vec4f64(Wt.r.BOUNDINGSPHERE).vec3f64(Wt.r.MODELORIGIN).mat3f(Wt.r.INSTANCEMODEL).mat3f(Wt.r.INSTANCEMODELNORMAL).vec2f(Wt.r.MODELSCALEFACTORS);return R.includes(Wt.r.FEATUREATTRIBUTE)&&(G=G.vec4f(Wt.r.FEATUREATTRIBUTE)),R.includes(Wt.r.COLOR)&&(G=G.vec4u8(Wt.r.COLOR)),R.includes(Wt.r.OBJECTANDLAYERIDCOLOR)&&(G=G.vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR)),G=G.u8(Wt.r.STATE).u8(Wt.r.LODLEVEL),G}(G),this._capacity=rh,this._buffer=this._layout.createBuffer(this._capacity),this._view=new InstanceData_R(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const R=this._findSlot();return this._view.state.set(R,nh.ALLOCATED),this._size++,this.events.emit("instances-changed"),R}removeInstance(R){const G=this._view.state;(0,nr.vA)(R>=0&&R<this._capacity&&0!=(G.get(R)&nh.ALLOCATED),"invalid instance handle"),this._getStateFlag(R,nh.ACTIVE)?this._setStateFlags(R,nh.REMOVE):this.freeInstance(R),this.events.emit("instances-changed")}freeInstance(R){const G=this._view.state;(0,nr.vA)(R>=0&&R<this._capacity&&0!=(G.get(R)&nh.ALLOCATED),"invalid instance handle"),G.set(R,0),this._size--}setLocalTransform(R,G){let H=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.localTransform.setMat(R,G),H&&this.updateModelTransform(R)}getLocalTransform(R,G){this._view.localTransform.getMat(R,G)}setGlobalTransform(R,G){let H=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._view.globalTransform.setMat(R,G),H&&this.updateModelTransform(R)}getGlobalTransform(R,G){this._view.globalTransform.getMat(R,G)}updateModelTransform(R){const G=this._view,H=ah,W=oh;G.localTransform.getMat(R,lh),G.globalTransform.getMat(R,ch);const q=(0,ye.lw)(ch,ch,lh);(0,be.s)(H,q[12],q[13],q[14]),G.modelOrigin.setVec(R,H),(0,ge.z0)(W,q),G.model.setMat(R,W);const Q=(0,gn.wp)(ah,q);Q.sort(),G.modelScaleFactors.set(R,0,Q[1]),G.modelScaleFactors.set(R,1,Q[2]),(0,ge.B8)(W,W),(0,ge.mg)(W,W),G.modelNormal.setMat(R,W),this._setStateFlags(R,nh.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:R})}getModelTransform(R,G){const H=this._view;H.model.getMat(R,oh),H.modelOrigin.getVec(R,ah),G[0]=oh[0],G[1]=oh[1],G[2]=oh[2],G[3]=0,G[4]=oh[3],G[5]=oh[4],G[6]=oh[5],G[7]=0,G[8]=oh[6],G[9]=oh[7],G[10]=oh[8],G[11]=0,G[12]=ah[0],G[13]=ah[1],G[14]=ah[2],G[15]=1}applyShaderTransformation(R,G){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,R,G)}getCombinedModelTransform(R,G){return this.getModelTransform(R,G),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,R,G),G}getCombinedLocalTransform(R,G){this._view.localTransform.getMat(R,G),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,R,G)}getCombinedMaxScaleFactor(R){let G=this._view.modelScaleFactors.get(R,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(ah,this,R),G*=Math.max(ah[0],ah[1],ah[2])),G}getCombinedMedianScaleFactor(R){let G=this._view.modelScaleFactors.get(R,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(ah,this,R),G*=function InstanceData_w(R,G,H){return Math.max(Math.min(R,G),Math.min(Math.max(R,G),H))}(ah[0],ah[1],ah[2])),G}getModel(R,G){this._view.model.getMat(R,G)}setFeatureAttribute(R,G){this._view.featureAttribute.setVec(R,G)}getFeatureAttribute(R,G){this._view.featureAttribute.getVec(R,G)}setColor(R,G){this._view.color.setVec(R,G)}setObjectAndLayerIdColor(R,G){this._view.objectAndLayerIdColor.setVec(R,G)}setVisible(R,G){G!==this.getVisible(R)&&(this._setStateFlag(R,nh.VISIBLE,G),this.events.emit("instance-visibility-changed",{index:R}))}getVisible(R){return this._getStateFlag(R,nh.VISIBLE)}setHighlight(R,G){G!==this.getHighlight(R)&&(this._setStateFlag(R,nh.HIGHLIGHT,G),this.events.emit("instance-highlight-changed"))}getHighlight(R){return this._getStateFlag(R,nh.HIGHLIGHT)}getState(R){return this._view.state.get(R)}getLodLevel(R){return this._view.lodLevel.get(R)}countFlags(R){let G=0;for(let H=0;H<this._capacity;++H)this.getState(H)&R&&++G;return G}_setStateFlags(R,G){const H=this._view.state;G=H.get(R)|G,H.set(R,G)}_clearStateFlags(R,G){const H=this._view.state;G=H.get(R)&~G,H.set(R,G)}_setStateFlag(R,G,H){H?this._setStateFlags(R,G):this._clearStateFlags(R,G)}_getStateFlag(R,G){return!!(this._view.state.get(R)&G)}_grow(){this._capacity=Math.max(rh,Math.floor(this._capacity*ce.Ji)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new InstanceData_R(this._buffer)}_findSlot(){const R=this._view.state;let G=this._next;for(;R.get(G)&nh.ALLOCATED;)G=G+1===this._capacity?0:G+1;return this._next=G+1===this._capacity?0:G+1,G}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],sh.prototype,"shaderTransformation",void 0),(0,W._)([(0,ee.MZ)()],sh.prototype,"_size",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],sh.prototype,"size",null),sh=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],sh);const ah=(0,xe.vt)(),oh=(0,fe.vt)(),lh=(0,ve.vt)(),ch=(0,ve.vt)();class InstanceOctree_n extends aa.A{constructor(R,G){super((R=>(0,Ge.w)(this._instanceData.view.boundingSphere.getVec(R,this._tmpSphere))),{maximumDepth:25}),this._instanceData=R,this._boundingSphere=G,this._tmpSphere=(0,Ge.d)(),this._tmpMat4=(0,ve.vt)()}addInstance(R){const G=this._instanceData.view.boundingSphere,H=this._instanceData.getCombinedModelTransform(R,this._tmpMat4);(0,be.e)((0,Ge.g)(this._tmpSphere),this._boundingSphere.center,H),this._tmpSphere[3]=this._boundingSphere.radius*(0,gn.hG)(H),G.setVec(R,this._tmpSphere),this.add([R])}removeInstance(R){this.remove([R])}}class LevelSelector_e{constructor(R,G){this._worldSpaceRadius=R,this._minScreenSpaceRadii=G}selectLevel(R,G,H){const W=H.computeScreenPixelSizeAt(R),q=this._worldSpaceRadius*G/W;let Q=0;for(let J=1;J<this._minScreenSpaceRadii.length;++J)q>=this._minScreenSpaceRadii[J]&&(Q=J);return Q}}class Intersector_s extends IntersectorTarget_o{constructor(R,G,H,W,q,Q){super(R,G),this.layerUid=R,this.graphicUid=G,this.geometryId=H,this.triangleNr=W,this.baseBoundingSphere=q,this.numLodLevels=Q}}class LodComponentData_u{constructor(R,G){const H=R.renderContext.rctx,W=G.geometry;this._materialRepository=R.materialRepository,W.material.setParameters({instancedDoublePrecision:!0});const q=W.material.createBufferWriter(),Q=q.vertexBufferLayout,J=q.elementCount(W),X=Q.createBuffer(J);q.write(null,null,W,X,0),this.geometry=W,this.material=W.material,this.glMaterials=new GLMaterials_t(W.material,this._materialRepository),this.vertexBufferLayout=Q,this.vbo=Wo.g.createVertex(H,Ft._U.STATIC_DRAW,X.buffer),this.vao=new VertexArrayObject_r(H,Fn.D,{geometry:(0,Ho.U)(Q)},{geometry:this.vbo}),this.vertexCount=J}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(R,G,H,W,q,Q,J,X){const $=this.geometry.id;this.material.intersect(this.geometry,R.transform.transform,R,H,W,((H,W,K,ee,te)=>{if(H>=0){if(null!=G&&!G(R.rayBegin,R.rayEnd,H))return;const ee=new Intersector_s(Q.layerUid,Q.graphicUid(q),$,K,J,X);if((null==R.results.min.drapedLayerOrder||te>=R.results.min.drapedLayerOrder)&&(null==R.results.min.dist||H<R.results.min.dist)&&R.results.min.set(xo.LOD,ee,H,W,R.transform.transform,te),R.options.store!==So.MIN&&(null==R.results.max.drapedLayerOrder||te>=R.results.max.drapedLayerOrder)&&(null==R.results.max.dist||H>R.results.max.dist)&&R.results.max.set(xo.LOD,ee,H,W,R.transform.transform,te),R.options.store===So.ALL){const G=Intersector_G(R.results.min.ray);G.set(xo.LOD,ee,H,W,R.transform.transform,te),R.results.all.push(G)}}}))}}class LodLevel_a{static async create(R,G,H){const W=await Promise.allSettled(G.components.map((G=>R.controller.schedule((()=>new LodComponentData_u(R,G)),H)))),q=W.map((R=>"fulfilled"===R.status?R.value:null)).filter(ce.Ru);if((0,X.G4)(H)||q.length!==W.length){q.forEach((R=>R.destroy())),(0,X.Te)(H);for(const R of W)if("rejected"===R.status)throw R.reason}return new LodLevel_a(G.minScreenSpaceRadius,q)}constructor(R,G){this.minScreenSpaceRadius=R,this.components=G}destroy(){this.components.forEach((R=>R.destroy()))}intersect(R,G,H,W,q,Q,J){this.components.forEach((X=>X.intersect(R,G,H,W,q,Q,this.boundingSphere,J)))}get boundingBox(){if(null==this._boundingBox){const R=(0,Le.Ie)();this.components.forEach((G=>{null!=G.boundingInfo&&((0,Le.iT)(R,G.boundingInfo.bbMin),(0,Le.iT)(R,G.boundingInfo.bbMax))})),this._boundingBox=R}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const R=this.boundingBox,G=(0,xe.vt)();(0,Le.gX)(R,G),this._boundingSphere={center:G,radius:.5*(0,Le._F)(R)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((R,G)=>R+G.triangleCount),0)}}var dh=H(96347),hh=H(76879);let uh=class extends qs.S{constructor(R,G){super(R),this.type=xo.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[new Array],this._highlightRenderInstanceData=[new Array],this._allRenderInstanceData=[this._defaultRenderInstanceData[0],this._highlightRenderInstanceData[0]],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new Qs,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>this._produces(R)],[Mn.N.TRANSPARENT_MATERIAL,R=>!!this._hasTransparentLevels()&&this._produces(R)]]),this._instanceData=new sh({shaderTransformation:R.shaderTransformation},R.optionalFields),this.addHandles(G.registerTask(ot.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function LodRenderer_q(R){let G=(0,Tn.BP)().vec3f(Wt.r.INSTANCEMODELORIGINHI).vec3f(Wt.r.INSTANCEMODELORIGINLO).mat3f(Wt.r.INSTANCEMODEL).mat3f(Wt.r.INSTANCEMODELNORMAL);return null!=R&&R.includes("featureAttribute")&&(G=G.vec4f(Wt.r.INSTANCEFEATUREATTRIBUTE)),null!=R&&R.includes("color")&&(G=G.vec4u8(Wt.r.INSTANCECOLOR)),null!=R&&R.includes("objectAndLayerIdColor")&&(G=G.vec4u8(Wt.r.INSTANCEOBJECTANDLAYERIDCOLOR)),G}(this.optionalFields),this._glInstanceBufferLayout=(0,Ho.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(R=>{let{index:G}=R;this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(G)})),this._instanceData.events.on("instance-visibility-changed",(R=>{let{index:G}=R;this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(G)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(R){this._slicePlane=R}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get usedMemory(){return this._allRenderInstanceData.reduce(((R,G)=>G.reduce(((R,G)=>R+G.usedMemory),R)),0)}get renderStats(){const R=this._instanceData.size,G=[];return this._levels.forEach(((R,H)=>{const W=this._allRenderInstanceData[0][H].size+this._allRenderInstanceData[1][H].size,q=R.triangleCount;G.push({renderedInstances:W,renderedTriangles:W*q,trianglesPerInstance:q})})),{totalInstances:R,renderedInstances:G.reduce(((R,G)=>R+G.renderedInstances),0),renderedTriangles:G.reduce(((R,G)=>R+G.renderedTriangles),0),levels:G}}async initializeRenderContext(R,G){this._context=R;const H=R.renderContext.rctx,W=await Promise.allSettled(this.symbol.levels.map((W=>(this._defaultRenderInstanceData[0].push(new RenderInstanceData_f(H,this._instanceBufferLayout)),this._highlightRenderInstanceData[0].push(new RenderInstanceData_f(H,this._instanceBufferLayout)),LodLevel_a.create(R,W,G))))),q=W.map((R=>"fulfilled"===R.status?R.value:null)).filter(ce.Ru);if((0,X.G4)(G)||q.length!==W.length){q.forEach((R=>R.destroy())),(0,X.Te)(G);for(const R of W)if("rejected"===R.status)throw R.reason}this._levels=q,this._levelSelector=(R=>{const G=R.baseBoundingSphere.radius,H=R.levels.map((R=>R.minScreenSpaceRadius));return new LevelSelector_e(G,H)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((R=>R.destroy())),this._defaultRenderInstanceData[0].forEach((R=>R.destroy())),this._highlightRenderInstanceData[0].forEach((R=>R.destroy()))}_hasTransparentLevels(){return this._levels.some((R=>R.components.some((R=>{const G=R.material.produces.get(Mn.N.TRANSPARENT_MATERIAL);return G&&G(En.V.Color)}))))}hasHighlights(){return this._highlightRenderInstanceData[0].some((R=>R.size>0))}_produces(R){return R!==En.V.Highlight&&R!==En.V.ShadowHighlight||this.hasHighlights()}prepareRender(R){if(!qr.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const G=R.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(R.bindParameters.contentCamera),G||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(ot.Bb),this._needFullCycle=!1)}}prepareTechniques(R){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(R.output))return null;const G=this._getInstanceDatas(R.output);if(!G)return null;const H=new Array;return G.forEach((G=>this.levels.forEach(((W,q)=>{W.components.forEach((W=>H.push(this._beginComponent(R,G[q],W))))})))),H}renderNode(R,G){const H=this._getInstanceDatas(R.output);if(!H||null==G)return;let W=0;R.rctx.bindVAO(),H.forEach((H=>this.levels.forEach(((q,Q)=>{q.components.forEach((q=>this._renderComponent(R,G[W++],H[Q],q,Q)))}))))}_getInstanceDatas(R){const G=R!==En.V.Highlight&&R!==En.V.ShadowHighlight,H=R!==En.V.ShadowExcludeHighlight;return G&&H?this._allRenderInstanceData:G?this._defaultRenderInstanceData:H?this._highlightRenderInstanceData:null}intersect(R,G,H,W){if(!this.baseMaterial.isVisible()||null==this._octree)return;const q=(0,xe.vt)();(0,be.f)(q,W,H);const n=q=>{this._instanceData.getCombinedModelTransform(q,mh),R.transform.set(mh),(0,be.e)(gh,H,R.transform.inverse),(0,be.e)(fh,W,R.transform.inverse);const Q=this._instanceData.getState(q),J=this._instanceData.getLodLevel(q),X=this._levels.length;(0,nr.vA)(0!=(Q&nh.ACTIVE),"invalid instance state"),(0,nr.vA)(J>=0&&J<X,"invaid lod level"),this._levels[J].intersect(R,G,gh,fh,q,this.metadata,X)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(n):this._octree.forEachAlongRay(H,q,n)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){var R;const G=this._instanceData,H=null===(R=G.view)||void 0===R?void 0:R.state;if(!H)return null;this._octreeCached=new InstanceOctree_n(G,this.baseBoundingSphere);for(let R=0;R<G.capacity;++R)H.get(R)&nh.ACTIVE&&this._octreeCached.addInstance(R)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,Qe.pR)(this._octreeCached)}queryDepthRange(R){if(null==this._octree)return{near:1/0,far:-1/0};const G=R.viewForward,H=this._octree.findClosest(G,aa.A.DepthOrder.FRONT_TO_BACK,R.frustum),W=this._octree.findClosest(G,aa.A.DepthOrder.BACK_TO_FRONT,R.frustum);if(null==H||null==W)return{near:1/0,far:-1/0};const q=R.eye,Q=this._instanceData.view;Q.boundingSphere.getVec(H,_h),(0,be.f)(_h,_h,q);const J=(0,be.k)(_h,G)-_h[3];Q.boundingSphere.getVec(W,_h),(0,be.f)(_h,_h,q);const X=(0,be.k)(_h,G)+_h[3];return{near:Math.max(R.near,J),far:Math.min(R.far,X)}}_requestUpdateCycle(){let R=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,R&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((R=>R.forEach((R=>R.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(R){const{_enableLevelSelection:G,_camera:H,_levelSelector:W}=this;this._allRenderInstanceData.forEach((R=>R.forEach((R=>R.beginUpdate()))));const q=this._instanceData,Q=q.view;let J=q.size;const X=q.capacity;let $=this._instanceIndex;const K=Math.ceil(X/500);for(let ee=0;ee<J&&!R.done;++ee){$===this._cycleStartIndex&&this._startUpdateCycle();const ee=Q.state.get($);let te=0;if(!(ee&nh.ALLOCATED)){$=$+1===X?0:$+1,J++;continue}const ie=Q.lodLevel.get($);if(ee&nh.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[0][ie].freeTail(),ee&nh.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[0][ie].freeTail(),ee&nh.REMOVE)q.freeInstance($);else if(ee&nh.VISIBLE){let R=0;G&&(Q.modelOrigin.getVec($,ph),R=W.selectLevel(ph,q.getCombinedMedianScaleFactor($),H)),te=ee&~(nh.ACTIVE|nh.TRANSFORM_CHANGED),R>=0&&(ee&nh.HIGHLIGHT?(LodRenderer_P(this._highlightRenderInstanceData[0][R],Q,$),te|=nh.HIGHLIGHT_ACTIVE):(LodRenderer_P(this._defaultRenderInstanceData[0][R],Q,$),te|=nh.DEFAULT_ACTIVE)),Q.state.set($,te),Q.lodLevel.set($,R)}else te=ee&~(nh.ACTIVE|nh.TRANSFORM_CHANGED),Q.state.set($,te);if(null!=this._octreeCached){const R=!!(ee&nh.ACTIVE),G=!!(te&nh.ACTIVE);!R&&G?this._octreeCached.addInstance($):R&&!G?this._octreeCached.removeInstance($):R&&G&&ee&nh.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance($),this._octreeCached.addInstance($))}$=$+1===X?0:$+1,$%K==0&&R.madeProgress()}this._instanceIndex=$,this._allRenderInstanceData.forEach((R=>R.forEach((R=>R.endUpdate())))),this._context.requestRender()}_beginComponent(R,G,H){if(0===G.size)return null;const W=H.glMaterials.load(R.rctx,R.bindParameters.slot,R.output);return null!=W?W.beginSlot(R.bindParameters):null}_renderComponent(R,G,H,W,q){if(!G)return;const{bindParameters:Q,rctx:J}=R;J.runAppleAmdDriverHelper();const X=J.bindTechnique(G,Q,W.material.parameters,vh);J.bindVAO(W.vao),G.ensureAttributeLocations(W.vao),qr.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&R.output===En.V.Color&&(X.setUniform4fv("externalColor",yh[Math.min(q,yh.length-1)]),X.setUniform1i("colorMixMode",nc.Um.replace));const $=H.capacity,K=H.headIndex,ee=H.tailIndex,te=H.firstIndex,ie=this._glInstanceBufferLayout,m=(R,q)=>{(0,hh.yu)(J,Fn.D,H.buffer,ie,R),J.drawArraysInstanced(G.primitiveType,0,W.vertexCount,q-R),(0,hh.Hi)(J,Fn.D,H.buffer,ie)};W.material.parameters.transparent&&null!=te?K>ee?((0,nr.vA)(te>=ee&&te<=K,"invalid firstIndex"),m(te,K),m(ee,te)):K<ee&&(te<=K?((0,nr.vA)(te>=0&&te<=K,"invalid firstIndex"),m(te,K),m(ee,$),m(0,te)):((0,nr.vA)(te>=ee&&te<=$,"invalid firstIndex"),m(te,$),m(0,K),m(ee,te))):K>ee?m(ee,K):K<ee&&(m(0,K),m(ee,$)),J.bindVAO(null)}};function LodRenderer_P(R,G,H){const W=R.allocateHead();!function LodRenderer_G(R,G,H,W){(0,vn.Vk)(R.modelOrigin,G,H.modelOriginHi,H.modelOriginLo,W),H.model.copyFrom(W,R.model,G),H.modelNormal.copyFrom(W,R.modelNormal,G),R.color&&H.color&&H.color.copyFrom(W,R.color,G),R.objectAndLayerIdColor&&H.objectAndLayerIdColor&&H.objectAndLayerIdColor.copyFrom(W,R.objectAndLayerIdColor,G),R.featureAttribute&&H.featureAttribute&&H.featureAttribute.copyFrom(W,R.featureAttribute,G)}(G,H,R.view,W)}(0,W._)([(0,ee.MZ)({constructOnly:!0})],uh.prototype,"symbol",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],uh.prototype,"optionalFields",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],uh.prototype,"metadata",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],uh.prototype,"shaderTransformation",void 0),(0,W._)([(0,ee.MZ)()],uh.prototype,"_instanceData",void 0),(0,W._)([(0,ee.MZ)()],uh.prototype,"_cycleStartIndex",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],uh.prototype,"_enableLevelSelection",null),(0,W._)([(0,ee.MZ)()],uh.prototype,"_updateCyclesWithStaticCamera",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],uh.prototype,"running",null),uh=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],uh);const ph=(0,xe.vt)(),_h=(0,Ce.vt)(),mh=(0,ve.vt)(),gh=(0,xe.vt)(),fh=(0,xe.vt)(),yh=[(0,Ce.fA)(1,0,1,1),(0,Ce.fA)(0,0,1,1),(0,Ce.fA)(0,1,0,1),(0,Ce.fA)(1,1,0,1),(0,Ce.fA)(1,0,0,1)],vh=new dh.V;class Graphics3DObjectSymbolLayer_me{constructor(R,G,H,W,q,Q,J,X,$,K,ee,te){this.lodResources=R,this.lodRenderer=G,this.stageResources=H,this.originalMaterialParameters=W,this.resourceSize=q,this.isEsriSymbolResource=Q,this.isWosr=J,this.resourceBoundingBox=X,this.symbolSize=$,this.extentPadding=K,this.physicalBasedRenderingEnabled=ee,this.pivotOffset=te}}const bh=(0,xe.vt)(),xh=(0,ve.vt)(),Sh=(0,ve.vt)(),Ch=(0,Ce.vt)(),wh=new elevationAlignmentUtils_R;class Path_r{constructor(R,G,H,W){this.vertices=R,this.positionsES=G,this.offset=W;const q=R.length,Q=Math.floor(q/2),J=this.offset+3*Q,X=H[J],$=H[J+1],K=H[J+2];this.origin=(0,xe.fA)(X,$,K),this.positions=(0,Ve.oe)(3*q);const ee=this.offset+3*q;for(let te=this.offset;te<ee;te+=3)this.positions[te]=H[te]-X,this.positions[te+1]=H[te+1]-$,this.positions[te+2]=H[te+2]-K;this.updatePathVertexInformation()}get usedMemory(){return(0,_e.Ek)(this.positions)}updatePathVertexInformation(){const R=this.vertices.length,G=this.vertices[0];let H=this.offset;const W=this.positions;G.vRight[0]=W[H+3]-W[H],G.vRight[1]=W[H+4]-W[H+1],G.vRight[2]=W[H+5]-W[H+2],H+=3;let q=(0,be.l)(G.vRight);G.vMinSiblingLength=q,(0,be.n)(G.vRight,G.vRight);let Q=G;for(let J=1;J<R;++J){const G=this.vertices[J];if(G.vLeft=Q.vRight,J<R-1){G.vRight[0]=W[H+3]-W[H],G.vRight[1]=W[H+4]-W[H+1],G.vRight[2]=W[H+5]-W[H+2];const R=(0,be.l)(G.vRight);G.vMinSiblingLength=Math.min(q,R),q=R,(0,be.n)(G.vRight,G.vRight)}else(0,be.c)(G.vRight,G.vLeft),G.vMinSiblingLength=q;Q=G,H+=3}}}class PathBuilder_h{constructor(R,G,H,W,q){let Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.path=R,this.profile=G,this.extruder=H,this.startCap=W,this.endCap=q,this.options=Q,this._extrusionVertexCount=0;const J=this.path.vertices.length-2;this.numExtrusionProfiles=H.numProfilesPerJoin()*J+2,this.numVerticesTotal=G.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;const X=this.startCap.numVertices;this.numVerticesTotal+=X,this.endCap.vertexBufferStart=this.numVerticesTotal;const $=this.endCap.numVertices;this.numVerticesTotal+=$,this.pathVertexData=(0,Ue.JH)(1*this.numVerticesTotal),this.profileRightAxes=(0,Ve.oe)(4*this.numVerticesTotal),this.profileUpAxes=(0,Ve.oe)(4*this.numVerticesTotal),this.profileVertexAndNormals=(0,Ve.oe)(4*this.numVerticesTotal),this.positions=(0,Ve.AK)(R.positions,R.offset,3*R.vertices.length),this._rebuildGeometry(),this.buildTopology()}get usedMemory(){return(0,_e.Ek)(this.pathVertexData,this.profileRightAxes,this.profileUpAxes,this.profileVertexAndNormals)+this.path.usedMemory+this.profile.usedMemory}emitVertex(R,G,H,W,q){const Q=4*this._extrusionVertexCount;if(this.profileRightAxes[Q]=G.right[0],this.profileRightAxes[Q+1]=G.right[1],this.profileRightAxes[Q+2]=G.right[2],this.profileUpAxes[Q]=G.up[0],this.profileUpAxes[Q+1]=G.up[1],this.profileUpAxes[Q+2]=G.up[2],this.profileVertexAndNormals[Q]=H[0],this.profileVertexAndNormals[Q+1]=H[1],this.profileVertexAndNormals[Q+2]=W[0],this.profileVertexAndNormals[Q+3]=W[1],this.pathVertexData[this._extrusionVertexCount]=R,q){const G=this.path.vertices[R],H=G.maxStretchDistance;this.profileRightAxes[Q+3]=G.rotationRight[0]*H,this.profileUpAxes[Q+3]=G.rotationRight[1]*H}else this.profileRightAxes[Q+3]=0,this.profileUpAxes[Q+3]=0;++this._extrusionVertexCount}emitCapVertex(R,G,H,W,q,Q){const J=4*this._extrusionVertexCount;this.profileRightAxes[J]=G.right[0],this.profileRightAxes[J+1]=G.right[1],this.profileRightAxes[J+2]=G.right[2],this.profileRightAxes[J+3]=q,this.profileUpAxes[J]=G.up[0],this.profileUpAxes[J+1]=G.up[1],this.profileUpAxes[J+2]=G.up[2],this.profileUpAxes[J+3]=Q,this.profileVertexAndNormals[J]=H[0],this.profileVertexAndNormals[J+1]=H[1],this.profileVertexAndNormals[J+2]=W[0],this.profileVertexAndNormals[J+3]=W[1],this.pathVertexData[this._extrusionVertexCount]=R,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;const{positions:R,offset:G,vertices:H}=this.path;this.positions=(0,Ve.AK)(R,G,3*H.length);let W=0;const h=(R,G,H,q,Q)=>this.emitCapVertex(W,R,G,H,q,Q),o=(R,G,H,q)=>this.emitVertex(W,R,G,H,q);for(this.startCap.rebuildConnectingProfileGeometry(H[W],this.profile,h),W=1;W<H.length-1;++W)this.extruder.extrude(H[W],this.profile,o);this.endCap.rebuildConnectingProfileGeometry(H[W],this.profile,h),W=0,this.startCap.rebuildCapGeometry(H[W],h),W=H.length-1,this.endCap.rebuildCapGeometry(H[W],h)}buildTopology(){const R=this.profile.vertices.length,G=this.profile.numSegments,H=this.numExtrusionProfiles-1;let W=G*H*2*3;this.startCap.indexBufferStart=W,this.startCap.firstProfileVertexIndex=0,W+=this.startCap.numIndices,this.endCap.indexBufferStart=W,this.endCap.firstProfileVertexIndex=R*(this.numExtrusionProfiles-1);const q=new Array,Q=new Array,J=new Array,n=(R,G,H)=>{q.push(R),q.push(G),q.push(H),Q.push(R),Q.push(G),Q.push(H),J.push(this.pathVertexData[R]),J.push(this.pathVertexData[G]),J.push(this.pathVertexData[H])};for(let X=0;X<G;++X){const G=this.profile.indices[2*X],W=this.profile.indices[2*X+1];for(let q=0;q<H;++q){const H=q*R+G,Q=(q+1)*R+W,J=q*R+W;n(H,(q+1)*R+G,Q),n(H,Q,J)}}this.startCap.buildTopology(this.path.vertices[0],n),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],n),this.vertexIndices=(0,Ue.Dg)(q),this.normalIndices=(0,Ue.Dg)(Q),this.pathVertexIndices=(0,Ue.Dg)(J)}onPathChanged(){this._rebuildGeometry()}}class PathCapBuilder_o{rebuildConnectingProfileGeometry(R,G,H){for(let W=0;W<G.vertices.length;++W)H(R.frame,G.vertices[W],G.normals[W],0,0)}}class PathCapBuilder_l extends PathCapBuilder_o{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}}class PathCapBuilder_f extends PathCapBuilder_o{constructor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,H=arguments.length>2&&void 0!==arguments[2]&&arguments[2];super(),this.profile=R,this.profilePlaneOffset=G,this.flip=H}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(R,G,H){const W=this.profilePlaneOffset;for(let q=0;q<G.vertices.length;++q)H(R.frame,G.vertices[q],G.normals[q],W,0)}rebuildCapGeometry(R,G){const H=this.profile,W=this.flip?1:-1,q=this.profilePlaneOffset,Q=Rh;(0,Yn.hZ)(Q,0,0);for(let J=0;J<H.vertices.length;++J)G(R.frame,H.vertices[J],Q,q,W)}buildTopology(R,G){const H=this.profile,W=this.vertexBufferStart+H.indices[0];for(let q=1;q<H.numSegments;++q){const R=H.indices[2*q],Q=H.indices[2*q+1],J=this.vertexBufferStart+R,X=this.vertexBufferStart+Q;this.flip?G(X,J,W):G(W,J,X)}}}class PathCapBuilder_h extends PathCapBuilder_o{constructor(R){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=R.profile,this.flip=R.flip,this.sign=this.flip?1:-1,this.breakNormals=R.breakNormals,this.numSegments=R.subdivisions}get numVertices(){let R=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(R+=this.profile.vertices.length),R}get numIndices(){let R=0;const G=this.profile;R+=2*G.numSegments*(this.numSegments-1);for(let H=0;H<G.numSegments;++H){const W=G.indices[2*H],q=G.indices[2*H+1];G.poleIndices[W]===G.poleIndices[q]?R+=1:R+=2}return 3*R}rebuildCapGeometry(R,G){const H=this.profile,W=R.frame,q=.5*this.sign,Q=Ah,J=Rh;(0,Yn.hZ)(J,0,0);for(const X of H.poles)X.normal?G(W,X.position,X.normal,q,0):G(W,X.position,J,q,this.sign);if(this.breakNormals)for(let X=0;X<H.vertices.length;++X)G(W,H.vertices[X],H.normals[X],0,0);for(let X=0;X<this.numSegments-1;++X){const R=(1-(X+1)/this.numSegments)*Math.PI*.5,$=Math.sin(R),K=Math.cos(R);for(let X=0;X<H.vertices.length;++X){const R=H.poles[H.poleIndices[X]];(0,Yn.Re)(Q,H.vertices[X],R.position),(0,Yn.hs)(Q,Q,$),R.normal?((0,Yn.WQ)(Q,Q,R.position),G(W,Q,R.normal,q*K,0)):((0,Yn.S8)(J,Q),(0,Yn.hs)(J,J,$),(0,Yn.WQ)(Q,Q,R.position),G(W,Q,J,q*K,this.sign*K))}}}buildTopology(R,G){const H=this.profile,W=this.breakNormals?this.vertexBufferStart+H.poles.length:this.firstProfileVertexIndex,q=this.breakNormals?this.vertexBufferStart+H.poles.length+H.vertices.length:this.vertexBufferStart+H.poles.length;for(let Q=0;Q<H.numSegments;++Q){const R=H.indices[2*Q],J=H.indices[2*Q+1],X=this.vertexBufferStart+H.poleIndices[R],$=this.vertexBufferStart+H.poleIndices[J];let K=W+R,ee=W+J;for(let W=0;W<this.numSegments-1;++W){const Q=q+W*H.vertices.length+R,X=q+W*H.vertices.length+J;this.flip?(G(Q,ee,K),G(ee,Q,X)):(G(K,ee,Q),G(X,Q,ee)),K=Q,ee=X}this.flip?(G(X,ee,K),X!==$&&G(X,$,ee)):(G(K,ee,X),X!==$&&G(ee,$,X))}}}const Ah=(0,Xi.vt)(),Rh=(0,Xi.vt)();class PathExtruder_c{numProfilesPerJoin(){return 1}extrude(R,G,H){for(let W=0;W<G.vertices.length;++W)H(R.frame,G.vertices[W],G.normals[W],!1)}}class PathExtruder_a{constructor(R,G){this.cutoffAngle=R,this.numBendSubdivisions=G}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(R,G,H){const W=Oh,{rotationAngle:q,rotationRight:Q,frame:J}=R;if(Math.abs(q)>=this.cutoffAngle){const X=R.rotationFrameUp;for(let $=0;$<this.numBendSubdivisions+1;++$){(0,ye.$0)(Eh,.5*-q+$*q/this.numBendSubdivisions,X),PathExtruder_m(W,J,Eh);for(let X=0;X<G.vertices.length;++X)(0,Yn.Om)(G.vertices[X],Q)*q>=0?H(W,G.vertices[X],G.normals[X],!1):H(J,R.applyMiterStretch(Th,G.vertices[X]),G.normals[X],!0)}}else for(let X=0;X<this.numBendSubdivisions+1;++X)for(let W=0;W<G.vertices.length;++W){const X=(0,Yn.Om)(G.vertices[W],Q)*q>=0;H(J,R.applyMiterStretch(Th,G.vertices[W]),G.normals[W],!X)}}}class PathExtruder_l{constructor(){this.up=(0,xe.vt)(),this.right=(0,xe.vt)()}}function PathExtruder_m(R,G,H){(0,be.e)(R.up,G.up,H),(0,be.e)(R.right,G.right,H)}const Th=(0,Xi.vt)(),Eh=(0,ve.vt)(),Oh=new PathExtruder_l;class PathGeometry_e extends rr.V{constructor(R,G,H,W,q,Q){super(R,G,null,ir.X.Mesh,Q),this.path=H,this.geometrySR=W,this.stencilWidth=q}}var Ph;function PathGeometry_n(R){return"path"in R}!function(R){R[R.World=0]="World",R[R.Path=1]="Path"}(Ph||(Ph={}));class PathGeometryData_d{constructor(R){this.builder=R}onPathChanged(R){this.builder.onPathChanged()}}class PathGeometryData_f extends PathGeometryData_d{constructor(R){super(R),this.vertexAttributeColor=(0,Ce.fA)(255,255,255,255),this.size=new Array,this.vertexAttributePosition=(0,Ve.oe)(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(R){this.vertexAttributeColor[0]=255*R[0],this.vertexAttributeColor[1]=255*R[1],this.vertexAttributeColor[2]=255*R[2],this.vertexAttributeColor[3]=255*(R.length>3?R[3]:1)}bake(R){this.size=R;const{numVerticesTotal:G,pathVertexData:H,path:W,positions:q,profileRightAxes:Q,profileUpAxes:J,profileVertexAndNormals:X}=this.builder;for(let $=0;$<G;++$){let G=H[$];const K=0===G||G===W.vertices.length-1;G*=3;const ee=Fh;let te=0,ie=0;const re=4*$,ne=(0,be.s)(Nh,Q[re],Q[re+1],Q[re+2]),se=(0,be.s)(Vh,J[re],J[re+1],J[re+2]),ae=(0,Yn.hZ)(Mh,X[re]*R[0],X[re+1]*R[1]);if(K)(0,be.b)(ee,se,ne),te=Q[re+3]*R[0],ie=J[re+3];else{const R=Ih,G=Dh;(0,Yn.hZ)(R,Q[re+3],J[re+3]);const H=(0,Yn.Bw)(R);(0,Yn.S8)(R,R);const W=(0,Yn.Om)(ae,R);if(Math.abs(W)>H){(0,Yn.hZ)(G,-R[1],R[0]);const q=(0,Yn.Om)(ae,G);(0,Yn.hs)(R,R,H*Math.sign(W)),(0,Yn.hs)(G,G,q),(0,Yn.WQ)(ae,R,G)}(0,be.s)(ee,0,0,0)}const oe=(0,be.s)(Lh,ne[0]*ae[0]+se[0]*ae[1],ne[1]*ae[0]+se[1]*ae[1],ne[2]*ae[0]+se[2]*ae[1]),le=3*$;this.vertexAttributePosition[le]=q[G]+oe[0]+ee[0]*te,this.vertexAttributePosition[le+1]=q[G+1]+oe[1]+ee[1]*te,this.vertexAttributePosition[le+2]=q[G+2]+oe[2]+ee[2]*te;const ce=(0,Yn.hZ)(Mh,X[re+2],X[re+3]);(0,hl.aT)(this.vertexAttributeNormal,$,ne[0]*ce[0]+se[0]*ce[1]+ee[0]*ie,ne[1]*ce[0]+se[1]*ce[1]+ee[1]*ie,ne[2]*ce[0]+se[2]*ce[1]+ee[2]*ie)}}createGeometryData(){const R=this.builder.vertexIndices.length,{normalIndices:G,vertexIndices:H}=this.builder;return[[Wt.r.POSITION,new tr.n(this.vertexAttributePosition,H,3,!0)],[Wt.r.NORMALCOMPRESSED,new tr.n(this.vertexAttributeNormal,G,2,!0)],[Wt.r.COLOR,new tr.n(this.vertexAttributeColor,(0,Ue.EH)(R),4)]]}onPathChanged(R){super.onPathChanged(R),this.bake(this.size)}intersect(R,G,H){const W=this.builder.vertexIndices,q=new tr.K(this.vertexAttributePosition,3),Q=W.length/3;(0,nc.Z$)(R,G,0,Q,W,q,void 0,void 0,H)}}class PathGeometryData_g extends PathGeometryData_d{constructor(R,G,H,W){super(R),this.sizeAttributeValue=G,this.colorAttributeValue=H,this.opacityAttributeValue=W,this.vvData=null,this.baked=new PathGeometryData_f(R),this.vvData=(0,Ve.oe)(4*this.builder.path.vertices.length);for(let q=0;q<this.builder.path.vertices.length;++q){this.vvData[4*q]=G,this.vvData[4*q+1]=H,this.vvData[4*q+2]=W;const R=0===q||q===this.builder.path.vertices.length-1;this.vvData[4*q+3]=R?1:0}}createGeometryData(){const{positions:R,profileRightAxes:G,profileUpAxes:H,profileVertexAndNormals:W,pathVertexIndices:q,vertexIndices:Q}=this.builder;return[[Wt.r.POSITION,new tr.n(R,q,3,!0)],[Wt.r.PROFILERIGHT,new tr.n(G,Q,4,!0)],[Wt.r.PROFILEUP,new tr.n(H,Q,4,!0)],[Wt.r.PROFILEVERTEXANDNORMAL,new tr.n(W,Q,4,!0)],[Wt.r.FEATUREVALUE,new tr.n(this.vvData,q,4,!0)]]}onPathChanged(R){super.onPathChanged(R);const G=R.getMutableAttribute(Wt.r.POSITION);G&&(G.data=this.builder.positions)}}const Mh=(0,Xi.vt)(),Ih=(0,Xi.vt)(),Dh=(0,Xi.vt)(),Lh=(0,xe.vt)(),Fh=(0,xe.vt)(),Nh=(0,xe.vt)(),Vh=(0,xe.vt)();const Uh=(0,xe.vt)();class PathProfile_o{constructor(){this.vertices=new Array,this.normals=new Array,this.indices=new Array,this.poles=new Array,this.poleIndices=new Array}addVertex(R,G){return this.vertices.push((0,Xi.o8)(R)),this.normals.push((0,Xi.o8)(G)),this.vertices.length-1}addPole(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.poles.push({position:(0,Xi.o8)(R),normal:G?(0,Xi.o8)(G):null}),this.poles.length-1}addSegment(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.indices.push(R.v0),this.indices.push(R.v1),G&&(this.poleIndices.push(G.v0),this.poleIndices.push(G.v1))}get numSegments(){return this.indices.length/2}translate(R,G){for(const H of this.vertices)H[0]+=R,H[1]+=G;for(const H of this.poles)H.position[0]+=R,H.position[1]+=G}get usedMemory(){return this.vertices.length*(0,_e.Ek)(this.vertices[0])*2+(0,_e.Ek)(this.indices)}}const Gh={top:[0,-.5],bottom:[0,.5]};function PathProfile_i(R){const G=Yi,H=new PathProfile_o,W={v0:0,v1:0};H.addPole((0,Xi.fA)(0,0));for(let Q=0;Q<G;++Q){const R=2*Q*Math.PI/G,W=Math.cos(R),q=Math.sin(R),J=(0,Xi.fA)(.5*W,.5*q),X=(0,Xi.fA)(W,q);H.addVertex(J,X)}for(let Q=0;Q<G-1;++Q){const R={v0:Q,v1:Q+1};H.addSegment(R,W)}const q={v0:G-1,v1:0};if(H.addSegment(q,W),"center"!==R){const G=Gh[R];H.translate(G[0],G[1])}return H}const zh={center:PathProfile_i("center"),top:PathProfile_i("top"),bottom:PathProfile_i("bottom")},Bh={center:PathProfile_c("center"),top:PathProfile_c("top"),bottom:PathProfile_c("bottom")};function PathProfile_c(R){const G=new PathProfile_o,H=(0,Xi.fA)(-.5,-.5),W=(0,Xi.fA)(.5,-.5),q=(0,Xi.fA)(.5,.5),Q=(0,Xi.fA)(-.5,.5),J=(0,Xi.fA)(0,-1),X=(0,Xi.fA)(1,0),$=(0,Xi.fA)(0,1),K=(0,Xi.fA)(-1,0);if(G.addPole((0,Xi.fA)(0,.5),$),G.addPole((0,Xi.fA)(0,.5)),G.addPole((0,Xi.fA)(0,-.5)),G.addPole((0,Xi.fA)(0,-.5),J),G.addVertex(H,J),G.addVertex(W,J),G.addSegment({v0:0,v1:1},{v0:3,v1:3}),G.addVertex(W,X),G.addVertex(q,X),G.addSegment({v0:2,v1:3},{v0:2,v1:1}),G.addVertex(q,$),G.addVertex(Q,$),G.addSegment({v0:4,v1:5},{v0:0,v1:0}),G.addVertex(Q,K),G.addVertex(H,K),G.addSegment({v0:6,v1:7},{v0:1,v1:2}),"center"!==R){const H=Gh[R];G.translate(H[0],H[1])}return G}var Hh=H(43438);function mat2_a(R,G,H,W,q){return R[0]=G,R[1]=H,R[2]=W,R[3]=q,R}function mat2_s(R,G,H){const W=G[0],q=G[1],Q=G[2],J=G[3],X=H[0],$=H[1],K=H[2],ee=H[3];return R[0]=W*X+Q*$,R[1]=q*X+J*$,R[2]=W*K+Q*ee,R[3]=q*K+J*ee,R}function mat2_p(R,G,H){return R[0]=G[0]-H[0],R[1]=G[1]-H[1],R[2]=G[2]-H[2],R[3]=G[3]-H[3],R}const jh=mat2_s,Wh=mat2_p;Object.freeze(Object.defineProperty({__proto__:null,LDU:function mat2_m(R,G,H,W){return R[2]=W[2]/W[0],H[0]=W[0],H[1]=W[1],H[3]=W[3]-R[2]*H[1],[R,G,H]},add:function mat2_d(R,G,H){return R[0]=G[0]+H[0],R[1]=G[1]+H[1],R[2]=G[2]+H[2],R[3]=G[3]+H[3],R},adjoint:function mat2_e(R,G){const H=G[0];return R[0]=G[3],R[1]=-G[1],R[2]=-G[2],R[3]=H,R},copy:function mat2_n(R,G){return R[0]=G[0],R[1]=G[1],R[2]=G[2],R[3]=G[3],R},determinant:function mat2_c(R){return R[0]*R[3]-R[2]*R[1]},equals:function mat2_x(R,G){const H=R[0],W=R[1],q=R[2],Q=R[3],J=G[0],X=G[1],$=G[2],K=G[3],ee=(0,Hh.FD)();return Math.abs(H-J)<=ee*Math.max(1,Math.abs(H),Math.abs(J))&&Math.abs(W-X)<=ee*Math.max(1,Math.abs(W),Math.abs(X))&&Math.abs(q-$)<=ee*Math.max(1,Math.abs(q),Math.abs($))&&Math.abs(Q-K)<=ee*Math.max(1,Math.abs(Q),Math.abs(K))},exactEquals:function mat2_y(R,G){return R[0]===G[0]&&R[1]===G[1]&&R[2]===G[2]&&R[3]===G[3]},frob:function mat2_b(R){return Math.sqrt(R[0]**2+R[1]**2+R[2]**2+R[3]**2)},fromRotation:function mat2_l(R,G){const H=Math.sin(G),W=Math.cos(G);return R[0]=W,R[1]=H,R[2]=-H,R[3]=W,R},fromScaling:function mat2_M(R,G){return R[0]=G[0],R[1]=0,R[2]=0,R[3]=G[1],R},identity:function mat2_r(R){return R[0]=1,R[1]=0,R[2]=0,R[3]=1,R},invert:function mat2_o(R,G){const H=G[0],W=G[1],q=G[2],Q=G[3];let J=H*Q-q*W;return J?(J=1/J,R[0]=Q*J,R[1]=-W*J,R[2]=-q*J,R[3]=H*J,R):null},mul:jh,multiply:mat2_s,multiplyScalar:function mat2_S(R,G,H){return R[0]=G[0]*H,R[1]=G[1]*H,R[2]=G[2]*H,R[3]=G[3]*H,R},multiplyScalarAndAdd:function mat2_j(R,G,H,W){return R[0]=G[0]+H[0]*W,R[1]=G[1]+H[1]*W,R[2]=G[2]+H[2]*W,R[3]=G[3]+H[3]*W,R},rotate:function mat2_i(R,G,H){const W=G[0],q=G[1],Q=G[2],J=G[3],X=Math.sin(H),$=Math.cos(H);return R[0]=W*$+Q*X,R[1]=q*$+J*X,R[2]=W*-X+Q*$,R[3]=q*-X+J*$,R},scale:function mat2_f(R,G,H){const W=G[0],q=G[1],Q=G[2],J=G[3],X=H[0],$=H[1];return R[0]=W*X,R[1]=q*X,R[2]=Q*$,R[3]=J*$,R},set:mat2_a,str:function mat2_h(R){return"mat2("+R[0]+", "+R[1]+", "+R[2]+", "+R[3]+")"},sub:Wh,subtract:mat2_p,transpose:function mat2_u(R,G){if(R===G){const H=G[1];R[1]=G[2],R[2]=H}else R[0]=G[0],R[1]=G[2],R[2]=G[1],R[3]=G[3];return R}},Symbol.toStringTag,{value:"Module"}));function mat2f64_e(){return[1,0,0,1]}Object.freeze(Object.defineProperty({__proto__:null,clone:function mat2f64_r(R){return[R[0],R[1],R[2],R[3]]},create:mat2f64_e,createView:function mat2f64_n(R,G){return new Float64Array(R,G,4)},fromValues:function mat2f64_t(R,G,H,W){return[R,G,H,W]}},Symbol.toStringTag,{value:"Module"}));class PathVertex_R{constructor(){this.vLeft=(0,xe.vt)(),this.vRight=(0,xe.vt)(),this.vMinSiblingLength=0,this.frame=new PathExtruder_l}setFrameFromUpVector(R){(0,be.c)(this.frame.up,R),(0,be.g)(Kh,this.vLeft,this.vRight),(0,be.n)(Kh,Kh),(0,be.h)($h,this.frame.up,(0,be.k)(Kh,this.frame.up)),(0,be.f)(eu,Kh,$h),(0,be.n)(eu,eu),(0,be.b)(this.frame.right,eu,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}}class PathVertex_x extends PathVertex_R{get rotationFrameUp(){return this.frame.up}get rotationRight(){return Xi.Cw}get rotationAngle(){return(0,be.h)(Jh,this.frame.up,(0,be.k)(this.frame.up,this.vLeft)),(0,be.f)(Jh,this.vLeft,Jh),(0,be.F)(Jh,Jh),(0,be.n)(Jh,Jh),(0,be.h)(Xh,this.frame.up,(0,be.k)(this.frame.up,this.vRight)),(0,be.f)(Xh,this.vRight,Xh),(0,be.n)(Xh,Xh),(0,be.b)(Yh,this.rotationFrameUp,this.vLeft),Math.sign((0,be.k)(Yh,this.vRight))*(Math.PI-(0,Ee.XM)((0,be.k)(Jh,Xh)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(R,G){const H=this.rotationAngle;if(Math.abs(H)<=0)return G;const W=(0,Ee.J_)(Math.cos(.5*H));return(0,Yn.hZ)(R,(W-1+1)*G[0],G[1])}}class PathVertex_L extends PathVertex_R{get rotationFrameUp(){const R=Math.sign((0,be.k)(this.frame.right,this.vRight));return(0,be.b)(kh,this.vRight,this.vLeft),(0,be.h)(kh,kh,R),(0,be.n)(kh,kh)}get rotationRight(){const R=this.rotationFrameUp,G=(0,be.k)(R,this.frame.up),H=(0,be.k)(R,this.frame.right);return(0,be.h)(Zh,this.frame.up,-H),(0,be.h)(Qh,this.frame.right,G),(0,be.g)(Zh,Zh,Qh),(0,be.n)(Zh,Zh),function PathVertex_j(R,G,H){(0,Yn.hZ)(R,(0,be.k)(H,G.right),(0,be.k)(H,G.up))}(qh,this.frame,Zh),qh}get rotationAngle(){const R=Math.sign((0,be.k)(this.frame.right,this.vRight));return(0,be.F)(Yh,this.vLeft),-R*(Math.PI-(0,Ee.XM)((0,be.k)(Yh,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*(0,Ee.J_)(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(R,G){const H=this.rotationAngle;if(0===Math.abs(H))return G;const W=(0,Ee.J_)(Math.cos(.5*H)),q=this.rotationRight,Q=mat2_a(tu,1+(W-1)*q[0]*q[0],(W-1)*q[0]*q[1],(W-1)*q[0]*q[1],1+(W-1)*q[1]*q[1]);return(0,Yn.ZF)(R,G,Q)}}function PathVertex_A(R){switch(R){case Ph.World:return new PathVertex_x;case Ph.Path:return new PathVertex_L}}const kh=(0,xe.vt)(),qh=(0,Xi.vt)(),Zh=(0,xe.vt)(),Qh=(0,xe.vt)(),Yh=(0,xe.vt)(),Jh=(0,xe.vt)(),Xh=(0,xe.vt)(),$h=(0,xe.vt)(),Kh=(0,xe.vt)(),eu=(0,xe.vt)(),tu=[1,0,0,1];var iu=H(42840),ru=H(93911),nu=H(14292);const su=new Map([[Wt.r.POSITION,0],[Wt.r.PROFILERIGHT,1],[Wt.r.PROFILEUP,2],[Wt.r.PROFILEVERTEXANDNORMAL,3],[Wt.r.FEATUREVALUE,4]]);class PathTechnique_N extends ru.W{constructor(){super(...arguments),this.ambient=(0,xe.fA)(.2,.2,.2),this.diffuse=(0,xe.fA)(.8,.8,.8),this.specular=(0,xe.fA)(0,0,0),this.opacity=1,this.origin=(0,xe.vt)(),this.modelTransformation=null}}class PathTechnique_C extends Ln.w{initializeConfiguration(R,G){G.spherical=R.viewingMode===qe.RT.Global,G.doublePrecisionRequiresObfuscation=R.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(R){return new Nn.B(R.rctx,PathTechnique_C.shader.get().build(this.configuration),su)}initializePipeline(){const R=this.configuration.transparencyPassType,G=this.configuration,H=R===pa.y.NONE,W=R===pa.y.FrontFace;return(0,Un.Ey)({blending:G.output!==En.V.Color&&G.output!==En.V.Alpha||!G.transparent?null:H?ha.V0:(0,ha.ez)(R),culling:G.hasSlicePlane&&!G.transparent&&G.doubleSidedMode!==iu.W.None?Un.hG:null,depthTest:{func:(0,ha.K_)(R)},depthWrite:H||W?Un.kn:null,colorWrite:Un.wE,stencilWrite:G.hasOccludees?ua.v0:null,stencilTest:G.hasOccludees?ua.qh:null,polygonOffset:H||W?null:ha.SE})}}PathTechnique_C.shader=new Dn.$(nu.P,(()=>H.e(7969).then(H.bind(H,30350))));class PathTechnique_V extends zn.E{constructor(){super(...arguments),this.output=En.V.Color,this.doubleSidedMode=iu.W.None,this.transparencyPassType=pa.y.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}}(0,W._)([(0,Gn.W)({count:En.V.COUNT})],PathTechnique_V.prototype,"output",void 0),(0,W._)([(0,Gn.W)({count:iu.W.COUNT})],PathTechnique_V.prototype,"doubleSidedMode",void 0),(0,W._)([(0,Gn.W)({count:pa.y.COUNT})],PathTechnique_V.prototype,"transparencyPassType",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"spherical",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"receiveShadows",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"receiveAmbientOcclusion",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"vvSize",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"vvColor",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"vvOpacity",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"hasSlicePlane",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"transparent",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"hasOccludees",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"multipassEnabled",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"cullAboveGround",void 0),(0,W._)([(0,Gn.W)()],PathTechnique_V.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PathTechnique_V.prototype,"occlusionPass",void 0),(0,W._)([(0,Gn.W)({constValue:Ns.A9.Disabled})],PathTechnique_V.prototype,"pbrMode",void 0),(0,W._)([(0,Gn.W)({constValue:!0})],PathTechnique_V.prototype,"hasVvInstancing",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PathTechnique_V.prototype,"useCustomDTRExponentForWater",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PathTechnique_V.prototype,"useFillLights",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PathTechnique_V.prototype,"hasColorTexture",void 0);class PathMaterial_g extends Pn.im{constructor(R){super(R,new PathMaterial_),this.supportsEdges=!0,this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>(this.parameters.castShadows&&(0,En.PJ)(R)||(0,En.XY)(R))&&!this.parameters.transparent],[Mn.N.TRANSPARENT_MATERIAL,R=>(this.parameters.castShadows&&(0,En.PJ)(R)||(0,En.XY)(R))&&this.parameters.transparent]]),this._vertexAttributeLocations=su,this._configuration=new PathTechnique_V,this._vertexBufferLayout=PathMaterial_g.getVertexBufferLayout()}getConfiguration(R,G){return this._configuration.output=R,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,R!==En.V.Color&&R!==En.V.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?iu.W.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?iu.W.WindingOrder:iu.W.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=null!=G.ssao),this._configuration.transparencyPassType=G.transparencyPassType,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration.cullAboveGround=G.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(R){return R!==En.V.Shadow&&R!==En.V.ShadowExcludeHighlight&&R!==En.V.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(R,G,H,W,q,Q){const J=R;if(!PathGeometry_n(J))return;const X=J.path,$=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSize){const{offset:R,factor:G,minSize:H,maxSize:W}=this.parameters.vvSize,q=X.sizeAttributeValue;$[0]*=(0,Ee.qE)(R[0]+q*G[0],H[0],W[0]),$[1]*=(0,Ee.qE)(R[2]+q*G[2],H[2],W[2])}const K=Math.max($[0],$[1]),ee=R.boundingInfo;if(null==ee)return void this._intersectTriangles(X,$,W,q,Q);const te=(0,Le.fA)(ee.bbMin[0]-K,ee.bbMin[1]-K,ee.bbMin[2]-K,ee.bbMax[0]+K,ee.bbMax[1]+K,ee.bbMax[2]+K),ie=[q[0]-W[0],q[1]-W[1],q[2]-W[2]],re=Math.sqrt(ie[0]*ie[0]+ie[1]*ie[1]+ie[2]*ie[2]),ne=[re/ie[0],re/ie[1],re/ie[2]];(0,nc.Wb)(te,W,ne,H.tolerance)&&this._intersectTriangles(X,$,W,q,Q)}_intersectTriangles(R,G,H,W,q){R.baked.size&&R.baked.size[0]===G[0]&&R.baked.size[1]===G[1]||R.baked.bake(G),R.baked.intersect(H,W,q)}createBufferWriter(){return new hd.Z(this._vertexBufferLayout)}createGLMaterial(R){return new PathMaterial_v(R)}static getVertexBufferLayout(){return(0,Tn.BP)().vec3f(Wt.r.POSITION).vec4f(Wt.r.PROFILERIGHT).vec4f(Wt.r.PROFILEUP).vec4f(Wt.r.PROFILEVERTEXANDNORMAL).vec4f(Wt.r.FEATUREVALUE)}}class PathMaterial_v extends On.A{_updateOccludeeState(R){R.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:R.hasOccludees})}_updateShadowState(R){null!=this.technique&&R.shadowMap.enabled===this.technique.configuration.receiveShadows||this._material.setParameters({receiveShadows:R.shadowMap.enabled})}beginSlot(R){return this._output!==En.V.Color&&this._output!==En.V.Alpha||(this._updateShadowState(R),this._updateOccludeeState(R)),this.ensureTechnique(PathTechnique_C,R)}}class PathMaterial_ extends PathTechnique_N{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}}const au=["polyline"];function Graphics3DPathSymbolLayer_ie(R,G,H){const{origin:W,positions:q}=R;let Q=R.offset;switch(G){default:case Ph.World:for(const G of R.vertices)ou[0]=q[Q++]+W[0],ou[1]=q[Q++]+W[1],ou[2]=q[Q++]+W[2],H.worldUpAtPosition(ou,ou),G.setFrameFromUpVector(ou);break;case Ph.Path:ou[0]=q[Q]+W[0],ou[1]=q[Q+1]+W[1],ou[2]=q[Q+2]+W[2],H.worldUpAtPosition(ou,ou),function pathGeometryUtils_l(R,G){let H=null;const W=R.vertices.length,q=.99619469809,Q=(0,xe.vt)(),J=(0,xe.vt)(),X=(0,xe.vt)(),$=(0,xe.vt)(),K=(0,xe.vt)(),ee=(0,xe.vt)(),te=(0,Ki.vt)();let ie=R.vertices[0];(0,be.c)(J,G),(0,be.s)(Q,0,1,0),At(ie.vRight,J,Q,Q,X,J,q),(0,be.c)(ie.frame.up,J),(0,be.c)(ie.frame.right,X);const re=R.positions;let ne=R.offset;H=ie;for(let se=1;se<W;++se){ie=R.vertices[se],(0,be.g)(K,ie.vLeft,ie.vRight);let G=(0,be.l)(K);G>0?(G=1/Math.sqrt(G),K[0]=K[0]*G,K[1]=K[1]*G,K[2]=K[2]*G):(K[0]=ie.vRight[0],K[1]=ie.vRight[1],K[2]=ie.vRight[2]),ee[0]=re[ne]+H.frame.up[0],ee[1]=re[ne+1]+H.frame.up[1],ee[2]=re[ne+2]+H.frame.up[2],ne+=3;const W=(0,be.s)(Uh,re[ne],re[ne+1],re[ne+2]);(0,Ki.O_)(W,K,te),(0,Ki.Ui)(te,(0,er.LV)(ee,ie.vLeft),$)?($[0]-=re[ne],$[1]-=re[ne+1],$[2]-=re[ne+2],(0,be.n)(J,$),(0,be.b)(X,K,J),(0,be.n)(X,X)):At(K,H.frame.up,H.frame.right,Q,X,J,q),(0,be.c)(ie.frame.up,J),(0,be.c)(ie.frame.right,X),H=ie}}(R,ou)}}function Graphics3DPathSymbolLayer_re(R,G,H){switch(R){case"symbol-value":return H;case"proportional":return G;default:return R}}function Graphics3DPathSymbolLayer_se(R,G,H,W){let q=0;const{origin:Q,vertices:J,positions:X,positionsES:$}=R,K=R.offset+3*J.length;for(let ee=R.offset;ee<K;ee+=3)(0,be.s)(ou,$[ee],$[ee+1],$[ee+2]),H(ou,lu),q+=lu.sampledElevation,ou[0]=X[ee]+Q[0],ou[1]=X[ee+1]+Q[1],ou[2]=X[ee+2]+Q[2],W.setAltitude(ou,lu.z),X[ee]=ou[0]-Q[0],X[ee+1]=ou[1]-Q[1],X[ee+2]=ou[2]-Q[2];return R.updatePathVertexInformation(),q/J.length}const ou=(0,xe.vt)(),lu=new elevationAlignmentUtils_R;function uvUtils_M(R,G,H,W){let q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;(0,be.s)(uu,1,0,0),(0,be.s)(pu,0,1,0),(0,be.s)(_u,0,0,1),function uvUtils_D(R,G){(0,be.s)(wu,0,0,0);for(let H=0;H<G.length-3;H+=3)wu[0]+=G[H],wu[1]+=G[H+1],wu[2]+=G[H+2];(0,be.h)(R,wu,1/(G.length/3-1))}(cu,H),(0,Ki.ci)(hu,H)&&function uvUtils_O(R,G,H,W,q,Q){null!=q?(q.basisMatrixAtPosition(Q,bu),(0,be.s)(xu,bu[0],bu[1],bu[2]),(0,be.s)(Su,bu[4],bu[5],bu[6]),(0,be.s)(Cu,bu[8],bu[9],bu[10])):((0,be.s)(xu,1,0,0),(0,be.s)(Su,0,1,0),(0,be.s)(Cu,0,0,1));const J=(0,Ki.Qj)(R);(0,be.k)(J,Cu)<0&&(0,be.h)(J,J,-1),(0,be.c)(W,J);const X=(0,be.k)(J,Su),$=(0,be.k)(J,xu);Math.abs(X)>Math.abs($)?((0,be.r)(G,xu,J,-$),(0,be.n)(G,G),(0,be.b)(H,G,J),(0,be.n)(H,H),(0,be.h)(H,H,-1)):((0,be.r)(H,Su,J,-X),(0,be.n)(H,H),(0,be.b)(G,H,J),(0,be.n)(G,G))}(hu,uu,pu,_u,W,cu),(0,Yn.hZ)(mu,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,Yn.hZ)(gu,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let ee=0;ee<H.length;ee+=3){(0,be.s)(du,H[ee],H[ee+1],H[ee+2]);const R=(0,be.k)(uu,du),G=(0,be.k)(pu,du);mu[0]=Math.min(mu[0],R),mu[1]=Math.min(mu[1],G),gu[0]=Math.max(gu[0],R),gu[1]=Math.max(gu[1],G)}const Q=(0,be.k)(_u,cu);uvUtils_q(fu,mu[0],mu[1],Q,uu,pu,_u),uvUtils_q(yu,gu[0],mu[1],Q,uu,pu,_u),uvUtils_q(vu,mu[0],gu[1],Q,uu,pu,_u),(0,be.f)(yu,yu,fu),(0,be.h)(yu,yu,.5),(0,be.f)(vu,vu,fu),(0,be.h)(vu,vu,.5),(0,be.g)(fu,fu,yu),(0,be.g)(fu,fu,vu);const J=mu[0]%q,X=mu[1]%q,$=mu[0]-J,K=mu[1]-X;for(let ee=0;ee<H.length;ee+=3){(0,be.s)(du,H[ee],H[ee+1],H[ee+2]);const W=ee/3,Q=4*W;R[Q]=((0,be.k)(uu,du)-$)/q,R[Q+1]=((0,be.k)(pu,du)-K)/q,R[Q+2]=$/q,R[Q+3]=K/q;const J=9*W;for(let R=0;R<3;R++)G[J+R]=fu[R],G[J+R+3]=yu[R],G[J+R+6]=vu[R]}}const cu=(0,xe.vt)(),du=(0,xe.vt)(),hu=(0,Ki.vt)(),uu=(0,xe.vt)(),pu=(0,xe.vt)(),_u=(0,xe.vt)(),mu=(0,Xi.vt)(),gu=(0,Xi.vt)(),fu=(0,xe.vt)(),yu=(0,xe.vt)(),vu=(0,xe.vt)();const bu=(0,ve.vt)(),xu=(0,xe.vt)(),Su=(0,xe.vt)(),Cu=(0,xe.vt)();const wu=(0,xe.vt)();function uvUtils_q(R,G,H,W,q,Q,J){(0,be.s)(R,G*q[0]+H*Q[0]+W*J[0],G*q[1]+H*Q[1]+W*J[1],G*q[2]+H*Q[2]+W*J[2])}class TriangleMaterial_e extends Pn.im{intersect(R,G,H,W,q,Q){return(0,nc.Uy)(R,H,W,q,void 0,Q)}}var Au=H(41035);la.S;class ColorMaterialTechnique_T extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,ColorMaterialTechnique_T.shader.get().build(this.configuration),Fn.D)}_createPipeline(R,G){const H=this.configuration,W=R===pa.y.NONE,q=R===pa.y.FrontFace;return(0,Un.Ey)({blending:H.output!==En.V.Color&&H.output!==En.V.Alpha||!H.transparent?null:W?ha.V0:(0,ha.ez)(R),culling:(0,Un.Xt)(H.cullFace),depthTest:H.draped?null:{func:(0,ha.K_)(R)},depthWrite:H.draped?null:(W||q)&&H.writeDepth?Un.kn:null,colorWrite:Un.wE,stencilWrite:H.hasOccludees?ua.v0:null,stencilTest:H.hasOccludees?G?ua.a9:ua.qh:null,polygonOffset:W||q?H.polygonOffset?Ru:null:(0,ha.aB)(H.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipeline(R){return R?this._occludeePipelineState:super.getPipeline()}}ColorMaterialTechnique_T.shader=new Dn.$(Au.C,(()=>H.e(5989).then(H.bind(H,65989))));const Ru={factor:1,units:1};class ColorMaterialTechniqueConfiguration_i extends zn.E{constructor(){super(...arguments),this.output=En.V.Color,this.cullFace=et.s2.None,this.transparencyPassType=pa.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1}}(0,W._)([(0,Gn.W)({count:En.V.COUNT})],ColorMaterialTechniqueConfiguration_i.prototype,"output",void 0),(0,W._)([(0,Gn.W)({count:et.s2.COUNT})],ColorMaterialTechniqueConfiguration_i.prototype,"cullFace",void 0),(0,W._)([(0,Gn.W)({count:pa.y.COUNT})],ColorMaterialTechniqueConfiguration_i.prototype,"transparencyPassType",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"hasSlicePlane",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"hasVertexColors",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"transparent",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"polygonOffset",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"enableOffset",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"writeDepth",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"hasOccludees",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"multipassEnabled",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"cullAboveGround",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"objectAndLayerIdColorInstanced",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"vvColor",void 0),(0,W._)([(0,Gn.W)()],ColorMaterialTechniqueConfiguration_i.prototype,"draped",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],ColorMaterialTechniqueConfiguration_i.prototype,"occlusionPass",void 0),(0,W._)([(0,Gn.W)({constValue:!0})],ColorMaterialTechniqueConfiguration_i.prototype,"hasVvInstancing",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],ColorMaterialTechniqueConfiguration_i.prototype,"vvSize",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],ColorMaterialTechniqueConfiguration_i.prototype,"vvOpacity",void 0);class ColorMaterial_ extends TriangleMaterial_e{constructor(R){super(R,new ColorMaterial_T),this.supportsEdges=!0,this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>R===En.V.Highlight||(0,En.BF)(R)&&!this._isTransparent],[Mn.N.OPAQUE_NO_SSAO_DEPTH,R=>R===En.V.LinearDepth&&this.parameters.writeLinearDepth&&!this._isTransparent],[Mn.N.TRANSPARENT_MATERIAL,R=>(0,En.BF)(R)&&this._isTransparent&&this.parameters.writeDepth],[Mn.N.TRANSPARENT_NO_SSAO_DEPTH,R=>R===En.V.LinearDepth&&this.parameters.writeLinearDepth&&this._isTransparent&&this.parameters.writeDepth],[Mn.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,R=>((0,En.BF)(R)||R===En.V.LinearDepth&&this.parameters.writeLinearDepth)&&this._isTransparent&&!this.parameters.writeDepth],[Mn.N.DRAPED_MATERIAL,R=>(0,En.i3)(R)]]),this._configuration=new ColorMaterialTechniqueConfiguration_i}getConfiguration(R,G){return this._configuration.output=R,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=G.transparencyPassType,this._configuration.enableOffset=G.camera.relativeElevation<ha.xt,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration.cullAboveGround=G.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}createGLMaterial(R){return new ColorMaterial_d(R)}createBufferWriter(){const R=(0,Tn.BP)().vec3f(Wt.r.POSITION);return(0,te.A)("enable-feature:objectAndLayerId-rendering")&&R.vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?R.f32(Wt.r.COLORFEATUREATTRIBUTE):R.vec4u8(Wt.r.COLOR),new hd.Z(R)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}}class ColorMaterial_d extends On.A{_updateOccludeeState(R){R.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:R.hasOccludees})}beginSlot(R){return this._output!==En.V.Color&&this._output!==En.V.Alpha||this._updateOccludeeState(R),this.ensureTechnique(ColorMaterialTechnique_T,R)}}class ColorMaterial_T extends la.S{constructor(){super(...arguments),this.color=Ce.uY,this.forceTransparentMode=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=et.s2.None,this.hasOccludees=!1,this.draped=!1}}var Tu=H(19154),Eu=H(56463);class PatternTechnique_S extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,PatternTechnique_S.shader.get().build(this.configuration),(0,te.A)("enable-feature:objectAndLayerId-rendering")?Mu:Pu)}_setPipelineState(R,G){const H=this.configuration,W=R===pa.y.NONE,q=R===pa.y.FrontFace;return(0,Un.Ey)({blending:H.output===En.V.Color||H.output===En.V.Alpha?W?ha.V0:(0,ha.ez)(R):null,culling:(0,Un.Xt)(H.cullFace),depthTest:H.draped?null:{func:(0,ha.K_)(R)},depthWrite:H.draped?null:W?Un.kn:(0,ha.XO)(R),colorWrite:Un.wE,stencilWrite:H.hasOccludees?ua.v0:null,stencilTest:H.hasOccludees?G?ua.a9:ua.qh:null,polygonOffset:W||q?H.polygonOffset?Ou:null:(0,ha.aB)(H.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipeline(R){return R?this._occludeePipelineState:super.getPipeline()}}PatternTechnique_S.shader=new Dn.$(Eu.P,(()=>H.e(2477).then(H.bind(H,92477))));const Ou={factor:1,units:1};class PatternTechnique_A extends zn.E{constructor(){super(...arguments),this.output=En.V.Color,this.cullFace=et.s2.None,this.transparencyPassType=pa.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.multipassEnabled=!1,this.cullAboveGround=!1,this.vvColor=!1,this.objectAndLayerIdColorInstanced=!1}}(0,W._)([(0,Gn.W)({count:En.V.COUNT})],PatternTechnique_A.prototype,"output",void 0),(0,W._)([(0,Gn.W)({count:et.s2.COUNT})],PatternTechnique_A.prototype,"cullFace",void 0),(0,W._)([(0,Gn.W)({count:Tu.O.COUNT})],PatternTechnique_A.prototype,"style",void 0),(0,W._)([(0,Gn.W)({count:pa.y.COUNT})],PatternTechnique_A.prototype,"transparencyPassType",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"hasSlicePlane",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"hasVertexColors",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"polygonOffset",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"hasOccludees",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"patternSpacing",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"lineWidth",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"enableOffset",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"draped",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"multipassEnabled",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"cullAboveGround",void 0),(0,W._)([(0,Gn.W)()],PatternTechnique_A.prototype,"vvColor",void 0),(0,W._)([(0,Gn.W)({constValue:!0})],PatternTechnique_A.prototype,"writeDepth",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PatternTechnique_A.prototype,"occlusionPass",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PatternTechnique_A.prototype,"hasVvInstancing",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PatternTechnique_A.prototype,"vvSize",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],PatternTechnique_A.prototype,"vvOpacity",void 0);const Pu=new Map([[Wt.r.POSITION,0],[Wt.r.COLOR,3],[Wt.r.UVMAPSPACE,4],[Wt.r.COLORFEATUREATTRIBUTE,5],[Wt.r.BOUNDINGRECT,6]]),Mu=new Map([[Wt.r.POSITION,0],[Wt.r.COLOR,3],[Wt.r.UVMAPSPACE,4],[Wt.r.COLORFEATUREATTRIBUTE,5],[Wt.r.BOUNDINGRECT,6],[Wt.r.OBJECTANDLAYERIDCOLOR,9]]);class PatternMaterial_P extends TriangleMaterial_e{constructor(R){super(R,new PatternMaterial_S),this.supportsEdges=!0,this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>(0,En.u5)(R)],[Mn.N.TRANSPARENT_MATERIAL,R=>(0,En.j8)(R)],[Mn.N.TRANSPARENT_NO_SSAO_DEPTH,R=>R===En.V.LinearDepth&&this.parameters.writeLinearDepth],[Mn.N.DRAPED_MATERIAL,R=>this.parameters.draped&&R===En.V.Color||(0,En.u5)(R)]]),this._vertexAttributeLocations=(0,te.A)("enable-feature:objectAndLayerId-rendering")?Mu:Pu,this._configuration=new PatternTechnique_A}getConfiguration(R,G){return this._configuration.output=R,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=G.transparencyPassType,this._configuration.enableOffset=G.camera.relativeElevation<ha.xt,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration.cullAboveGround=G.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}createGLMaterial(R){return new PatternMaterial_v(R)}createBufferWriter(){const R=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec4f(Wt.r.UVMAPSPACE);return this.parameters.draped||R.mat3f(Wt.r.BOUNDINGRECT),this.parameters.vvColor?R.f32(Wt.r.COLORFEATUREATTRIBUTE):R.vec4u8(Wt.r.COLOR),(0,te.A)("enable-feature:objectAndLayerId-rendering")&&R.vec4u8(Wt.r.OBJECTANDLAYERIDCOLOR),new PatternMaterial_E(R)}}class PatternMaterial_v extends On.A{_updateParameters(R){return this.ensureTechnique(PatternTechnique_S,R)}_updateOccludeeState(R){R.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:R.hasOccludees})}beginSlot(R){return this._output!==En.V.Color&&this._output!==En.V.Alpha||this._updateOccludeeState(R),this._updateParameters(R)}}class PatternMaterial_E extends hd.Z{write(R,G,H,W,q){(0,In.SA)(H,this.vertexBufferLayout,R,G,W,q);for(const Q of this.vertexBufferLayout.fields.keys()){const G=H.attributes.get(Q),J=null===G||void 0===G?void 0:G.indices;if(G&&J)switch(Q){case Wt.r.UVMAPSPACE:{(0,nr.vA)(4===G.size);const R=W.getField(Q,ec.Eq);R&&(0,In.Ut)(G,R,q);break}case Wt.r.BOUNDINGRECT:{(0,nr.vA)(9===G.size);const H=W.getField(Q,ec.jZ);H&&this.writeBoundingRect(G,R,H,q);break}}}}writeBoundingRect(R,G,H,W){const{data:q,indices:Q}=R,J=G,X=H.typedBuffer,$=H.typedBufferStride,K=Q.length;W*=$;for(let ee=0;ee<K;++ee){const R=9*Q[ee],G=q[R],H=q[R+1],K=q[R+2];X[W]=J[0]*G+J[4]*H+J[8]*K+J[12],X[W+1]=J[1]*G+J[5]*H+J[9]*K+J[13],X[W+2]=J[2]*G+J[6]*H+J[10]*K+J[14];for(let Q=3;Q<9;++Q)X[W+Q]=q[R+Q];W+=$}}}class PatternMaterial_S extends la.S{constructor(){super(...arguments),this.color=(0,Ce.fA)(1,1,1,1),this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=et.s2.None,this.hasOccludees=!1,this.style=Tu.O.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}function patternUtils_s(R,G){var H;const W=null!==(H=null===R||void 0===R?void 0:R.pattern)&&void 0!==H?H:null;return null==W?new ColorMaterial_(G):"none"===W.style||"solid"===W.style?("none"===W.style&&(G.color=(0,Ce.fA)(0,0,0,0),G.forceTransparentMode=!0),new ColorMaterial_(G)):(G.style=function patternUtils_l(R){switch(R){case"horizontal":return Tu.O.Horizontal;case"vertical":return Tu.O.Vertical;case"cross":return Tu.O.Cross;case"forward-diagonal":return Tu.O.ForwardDiagonal;case"backward-diagonal":return Tu.O.BackwardDiagonal;case"diagonal-cross":return Tu.O.DiagonalCross;default:return}}(W.style),new PatternMaterial_P(G))}function patternUtils_u(R,G){if(function patternUtils_c(R){return R.material instanceof PatternMaterial_P&&!R.material.parameters.draped}(R)){const H=R.attributes.get(Wt.r.POSITION).data;uvUtils_M(R.getMutableAttribute(Wt.r.UVMAPSPACE).data,R.getMutableAttribute(Wt.r.BOUNDINGRECT).data,H,G)}}function patternUtils_m(R,G,H,W,q){const Q=ElevationAligners_u(R,G,H,W,q),J=R.stageObject.geometries;for(const X of J)patternUtils_u(X,q);return Q}const Iu=["polyline","polygon","extent"],Du=new hn.wI({size:!1,color:!0,rotation:!1,opacity:!1});class Graphics3DPolygonFillSymbolLayer_N extends Graphics3DSymbolLayer_h{constructor(R,G,H,W){super(R,G,H,W),this._needsUV=!1}async doLoad(){this._fastUpdates=(0,hn.s_)(this._context.renderer,Du)}_createMaterials(){var R,G;if(this._materials.length>0)return;const H=null===(R=this.symbolLayer)||void 0===R||null===(R=R.material)||void 0===R?void 0:R.color,W=this._getCombinedOpacityAndColor(H);this._materials[Fu.Fill]=patternUtils_s(this.symbolLayer,{color:W,forceTransparentMode:this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...null===(G=this._fastUpdates)||void 0===G?void 0:G.materialParameters}),this._needsUV=this._materials[Fu.Fill]instanceof PatternMaterial_P;const q=this.symbolLayer.outline;if(this._isValidOutline(q)){const R=lineStippleUtils_n(q.pattern);this._materials[Fu.Outline]=new RibbonLineMaterial_H({width:(0,kr.Lz)(q.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:R,cap:lineUtils_n(q.patternCap||"butt")})}this._context.stage.addMany(this._materials)}_isValidOutline(R){return null!=(null===R||void 0===R?void 0:R.size)&&R.size>0&&null!=R.color&&(null==R.pattern||"style"!==R.pattern.type||"none"!==R.pattern.style)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(R){const G=R.graphic;if(!this._validateGeometry(G.geometry,Iu,this.symbolLayer.type))return null;const H=this._getVertexOpacityAndColor(R.renderingInfo,255),W=this.setGraphicElevationContext(G);return this.ensureDrapedStatus("on-the-ground"===W.mode),this._createMaterials(),this.draped?this._createAsOverlay(G,H):this._createAs3DShape(G,H,W)}applyRendererDiff(R,G){for(const W in R.diff){var H;if("visualVariables"!==W)return cn.RecreateSymbol;if(!(0,hn.J_)(this._fastUpdates,G,Du))return cn.RecreateSymbol;null===(H=this._materials[Fu.Fill])||void 0===H||H.setParameters(this._fastUpdates.materialParameters)}return cn.FastUpdate}layerOpacityChanged(){if(null!=this._materials[Fu.Fill]){var R;const G=this._materials[Fu.Fill].parameters.color,H=null===(R=this.symbolLayer)||void 0===R||null===(R=R.material)||void 0===R?void 0:R.color,W=this._getCombinedOpacity(H);this._materials[Fu.Fill].setParameters({color:[G[0],G[1],G[2],W],forceTransparentMode:this.needsDrivenTransparentPass})}if(null!=this._materials[Fu.Outline]){const R=this._materials[Fu.Outline].parameters.color;this._materials[Fu.Outline].setParameters({color:[R[0],R[1],R[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(R,G,H){const W=this._elevationContext.mode,q=elevationAlignmentUtils_m(Graphics3DPolygonFillSymbolLayer_N.elevationModeChangeTypes,H,W);if(q!==Ht.UPDATE)return q;const Q=elevationAlignmentUtils_d(W);return this.updateGraphics3DGraphicElevationInfo(R,G,(()=>Q))}slicePlaneEnabledChanged(){var R;if(null!==(R=this._materials[Fu.Fill])&&void 0!==R&&R.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[Fu.Outline]){const R={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[Fu.Outline].setParameters(R)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(R,G,H){var W;const q=(0,Rs.dE)(R.geometry);if(!q)return null;const Q=polygon_p(q,this._context.elevationProvider,this._context.renderCoordsHelper,H),J=new Graphics3DPolygonFillSymbolLayer_k(Q,G,this._context.layer.uid,R.uid),X=J.renderData.position.length/3;if(this._needsUV&&(J.uvMapSpace=(0,Ve.oe)(4*X,!0),J.boundingRect=(0,Ne.jh)(9*X,!0),uvUtils_M(J.uvMapSpace,J.boundingRect,J.renderData.position,this._context.renderCoordsHelper)),J.objectAndLayerIdColor=null===(W=this._context.stage.renderView)||void 0===W?void 0:W.getObjectAndLayerIdColor(J),this._createAs3DShapeFill(R,J),this._materials[Fu.Outline]&&this._createAs3DShapeOutline(J),this._logGeometryCreationWarnings(J.renderData,q.rings,"rings","FillSymbol3DLayer"),0===J.outGeometries.length)return null;const $=new Object3D_O({geometries:J.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:R.uid}),K=new Graphics3DObject3DGraphicLayer_p(this,$,J.outGeometries,null,null,patternUtils_m,H);return K.alignedSampledElevation=J.renderData.sampledElevation,K.needsElevationUpdates=elevationAlignmentUtils_d(H.mode),K}_createAs3DShapeFill(R,G){const H=G.renderData.polygons;for(const{position:q,mapPositions:Q,holeIndices:J,index:X,count:$}of H){var W;if(null!=this._context.clippingExtent&&((0,Le.Ie)(Lu),(0,Le.Hq)(Lu,Q),!(0,Le.KG)(Lu,this._context.clippingExtent)))continue;const H=(0,Rs.v7)(Q,J,this._context.elevationProvider.spatialReference);if(0===H.length)continue;const K=null===(W=this._fastUpdates)||void 0===W?void 0:W.visualVariables.color,ee=(0,Rs.a4)({material:this._materials[Fu.Fill],indices:H,mapPositions:Q,attributeData:{position:q,color:K?null:G.color,colorFeature:K?(0,hn.ul)(K.field,R):null,uvMapSpace:this._needsUV?(0,Ve.AK)(G.uvMapSpace,4*X,4*$):null,boundingRect:this._needsUV?(0,Ne.l5)(G.boundingRect,9*X,9*$):null,objectAndLayerIdColor:G.objectAndLayerIdColor}});G.outGeometries.push(ee)}}_createAs3DShapeOutline(R){if(null==this._materials[Fu.Outline])return;const G=R.renderData.outlines;for(const{mapPositions:H,position:W}of G){if(null!=this._context.clippingExtent&&((0,Le.Ie)(Lu),(0,Le.Hq)(Lu,H),!(0,Le.KG)(Lu,this._context.clippingExtent)))continue;const G=line_b(this._materials[Fu.Outline],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:H,attributeData:{position:W}},R.objectAndLayerIdColor);R.outGeometries.push(G)}}_createAsOverlay(R,G){var H;const W=(0,Rs.dE)(R.geometry);if(null==W)return null;this._materials[Fu.Fill].renderPriority=this._renderPriority+this._renderPriorityStep/2,null!=this._materials[Fu.Outline]&&(this._materials[Fu.Outline].renderPriority=this._renderPriority);const q=polygon_c(W,this._context.overlaySR),Q=new Graphics3DPolygonFillSymbolLayer_q(q,G,this._context.layer.uid,R.uid),J=Q.renderData.position.length/3;return this._needsUV&&(Q.uvMapSpace=(0,Ve.oe)(4*J,!0),function uvUtils_T(R,G,H,W){let q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if(H.isGeographic&&W===qe.RT.Global){const R=(0,Ne.jh)(G.length),W=G.length,q=(0,Ut.tO)(H);for(let H=0;H<W;H+=3)(0,Ae.RC)(G,H,R,H,q);G=R}(0,Yn.hZ)(mu,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let K=0;K<G.length;K+=3)mu[0]=Math.min(mu[0],G[K]),mu[1]=Math.min(mu[1],G[K+1]);const Q=mu[0]%q,J=mu[1]%q,X=mu[0]-Q,$=mu[1]-J;for(let K=0;K<G.length;K+=3){const H=K/3*4;R[H]=(G[K]-X)/q,R[H+1]=(G[K+1]-$)/q,R[H+2]=X/q,R[H+3]=$/q}}(Q.uvMapSpace,Q.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),Q.outBoundingBox=(0,Le.Ie)(),Q.objectAndLayerIdColor=null===(H=this._context.stage.renderView)||void 0===H?void 0:H.getObjectAndLayerIdColor(Q),this._createAsOverlayFill(R,Q),this._materials[Fu.Outline]&&this._createAsOverlayOutline(Q),this._logGeometryCreationWarnings(Q.renderData,W.rings,"rings","FillSymbol3DLayer"),0===Q.outGeometries.length?null:new Graphics3DDrapedGraphicLayer_l(this,Q.outGeometries,Q.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(R,G){const H=G.renderData.polygons;for(const{position:q,holeIndices:Q,index:J,count:X}of H){var W;const H=(0,Le.Ie)(Lu);if((0,Le.Hq)(H,q),!(0,Le.KG)(H,this._context.clippingExtent))continue;const $=(0,_s.e)(q,Q,3);if(0===$.length)continue;(0,Le.RF)(G.outBoundingBox,H);const K=null===(W=this._fastUpdates)||void 0===W?void 0:W.visualVariables.color,ee=(0,Rs.a4)({material:this._materials[Fu.Fill],indices:$,attributeData:{position:q,color:K?null:G.color,colorFeature:K?(0,hn.ul)(K.field,R):null,uvMapSpace:this._needsUV?(0,Ve.AK)(G.uvMapSpace,4*J,4*X):null,objectAndLayerIdColor:G.objectAndLayerIdColor}});G.outGeometries.push(new RenderGeometry_m(ee,G))}}_createAsOverlayOutline(R){if(null==this._materials[Fu.Outline])return;const G=R.renderData.outlines;for(let H=0;H<G.length;++H){const{position:W}=G[H];if((0,Le.Ie)(Lu),(0,Le.Hq)(Lu,W),!(0,Le.KG)(Lu,this._context.clippingExtent))continue;(0,Le.RF)(R.outBoundingBox,Lu);const q=line_b(this._materials[Fu.Outline],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:W}},R.objectAndLayerIdColor);R.outGeometries.push(new RenderGeometry_m(q,R))}}_getOutlineOpacity(){var R;const G=null===(R=this.symbolLayer)||void 0===R||null===(R=R.outline)||void 0===R?void 0:R.color;return(this.draped?1:this._getLayerOpacity())*(null!=G?G.a:0)}_getOutlineColor(){var R;const G=null===(R=this.symbolLayer)||void 0===R||null===(R=R.outline)||void 0===R?void 0:R.color,H=this._getOutlineOpacity();return graphicUtils_F(null!=G?oe.A.toUnitRGB(G):null,H)}test(){return{...super.test(),createAsOverlay:(R,G)=>this._createAsOverlay(R,G),createAs3DShape:(R,G,H)=>this._createAs3DShape(R,G,H)}}}Graphics3DPolygonFillSymbolLayer_N.elevationModeChangeTypes={definedChanged:Ht.RECREATE,staysOnTheGround:Ht.NONE,onTheGroundChanged:Ht.RECREATE};const Lu=(0,Le.vt)();class Graphics3DPolygonFillSymbolLayer_k extends Rs.JQ{constructor(R,G,H,W){super(R,H,W),this.color=G}}class Graphics3DPolygonFillSymbolLayer_q extends Rs.JQ{constructor(R,G,H,W){super(R,H,W),this.color=G}}var Fu;!function(R){R[R.Fill=0]="Fill",R[R.Outline=1]="Outline"}(Fu||(Fu={}));class LabelParameters_i{constructor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"center",H=arguments.length>2&&void 0!==arguments[2]&&arguments[2],W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,Xi.vt)(),q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,Ce.fA)(0,0,0,-1),Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"world",J=arguments.length>6&&void 0!==arguments[6]?arguments[6]:(0,xe.vt)(),X=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0;this.verticalOffset=R,this.anchor=G,this.hasLabelVerticalOffset=H,this.screenOffset=W,this.centerOffset=q,this.centerOffsetUnits=Q,this.translation=J,this.elevationOffset=X}}class LabelParameters_r{constructor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"center",H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"center",W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,Xi.vt)();this.placement=R,this.horizontalPlacement=G,this.verticalPlacement=H,this.text=W,this.displaySize=q}}var Nu=H(77480);class TextRenderParameters_l{constructor(R){this.definition=R,this.key=JSON.stringify(R),this.haloSize=Math.round(R.halo.size),this.textStyle=this._colorToRGBA(R.color),this.haloStyle=this._colorToRGB(R.halo.color),this.backgroundStyle=0!==R.background.color[3]?this._colorToRGBA(R.background.color):null}fontString(R){const G=this.definition.font;return"".concat(G.style," ").concat(G.weight," ").concat(R,"px ").concat(G.family,", ").concat("sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji")}setFontProperties(R,G){R.font=this.fontString(G),R.textAlign="left",R.textBaseline="alphabetic"}_colorToRGB(R){return"rgb(".concat(R.slice(0,3).map((R=>Math.floor(255*R))).toString(),")")}_colorToRGBA(R){return"rgba(".concat(R.slice(0,3).map((R=>Math.floor(255*R))).toString(),",").concat(R[3],")")}static async fromSymbol(R,G){var H,W,q,Q,X,$,K,ee,te,ie;const re=null===R||void 0===R||null===(H=R.material)||void 0===H?void 0:H.color,ne=null!==(W=oe.A.toUnitRGBA(re))&&void 0!==W?W:Ce.uY,se=null!=R.size?(0,kr.Lz)(R.size):12,ae=R.lineHeight,le=null!=R.background?oe.A.toUnitRGBA(R.background.color):Ce.uY,ce={family:null!==(q=null===(Q=R.font)||void 0===Q?void 0:Q.family)&&void 0!==q?q:"sans-serif",decoration:null!==(X=null===($=R.font)||void 0===$?void 0:$.decoration)&&void 0!==X?X:"none",weight:null!==(K=null===(ee=R.font)||void 0===ee?void 0:ee.weight)&&void 0!==K?K:"normal",style:null!==(te=null===(ie=R.font)||void 0===ie?void 0:ie.style)&&void 0!==te?te:"normal"},de=R.halo,he=null!=(null===de||void 0===de?void 0:de.color)&&de.size>0?{size:(0,kr.Lz)(de.size),color:oe.A.toUnitRGBA(de.color)}:{size:0,color:Ce.uY},ue=new TextRenderParameters_l({color:ne,size:se,background:{color:le,padding:null!=R.background?[.65*se,.5*se]:[0,0],borderRadius:null!=R.background?se*(6/16):0},lineSpacingFactor:ae,font:ce,halo:he,pixelRatio:G});if(R.font){let G=!1;const H=ue.fontString(se);try{G=(await document.fonts.load(H)).some((R=>!(0,Nu.NZ)(R)))}catch(pe){J.A.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce("Failed to preload font '".concat(H,"'. Some text symbology may be rendered using the default browser font."))}if(!G&&!Vu.has(R.font.family))try{await(0,Nu.Al)(R.font)}catch(pe){}}return ue}}const Vu=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);var Uu=H(16848);const Gu=4096;let zu=class extends Q.A{constructor(R){super(R),this.type=ir.X.Texture,this.id=(0,wi.c)(),this.events=new Vr.A,this._glTexture=null,this._atlas=new TextTextureAtlas_k(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=(0,Qe.WD)(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){return ju=ta?Bu:0,[Gu-Bu-ju,Gu-Bu-ju-Hu]}load(R){if(this._glTexture)return this._glTexture;const G=new al.R;return G.wrapMode=Ft.pF.CLAMP_TO_EDGE,G.samplingMode=Ft.Cj.LINEAR_MIPMAP_LINEAR,G.hasMipmap=!0,G.preMultiplyAlpha=!0,G.maxAnisotropy=R.parameters.maxMaxAnisotropy,this._glTexture=new Qa.g(R,G,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(ot.W6.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=(0,Qe.xt)(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=(0,Qe.WD)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(R){this._canvas.setAttribute("width",R.width.toString()),this._canvas.setAttribute("height",R.height.toString())}_resizeAtlas(R,G){var H,W;const{width:q,height:Q}=this._atlas;q===R&&Q===G||(this._atlas.width=R,this._atlas.height=G,null!==(H=this._glTexture)&&void 0!==H&&H.resize(R,G),null!==(W=this._glTexture)&&void 0!==W&&W.updateData(0,0,0,q,Q,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach((R=>{const G=this._stageObjects.get(R.textRenderer.key);null===G||void 0===G||G.forEach((G=>TextTextureAtlas_y(G,R)))})),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(R,G,H,W){const q=this._atlas;if(q.width<H||q.height<W)return!1;let Q=q.cursors.get(W);if(!Q){if(q.height<q.nextY+W)return!1;Q=[new TextTextureAtlas_E(q.nextY)],q.cursors.set(W,Q),q.nextY+=W}let J=Q.find((R=>q.width>=R.x+H));if(null==J){if(q.height<q.nextY+W)return!1;J=new TextTextureAtlas_E(q.nextY),q.nextY+=W,Q.push(J)}return R.setNewPosition(J),this._elements.set(G,R),this._elementsToRender.set(G,R),J.x+=H,!0}_ensureStageObjects(R){const G=this._stageObjects.get(R);if(G)return G;const H=new Set;return this._stageObjects.set(R,H),H}_addStageObject(R,G){this._ensureStageObjects(R).add(G)}_removeStageObject(R,G){const H=this._stageObjects.get(R);(null===H||void 0===H?void 0:H.delete(G))&&(G.geometries[0].setAttributeData(Wt.r.SIZE,[0,0]),G.geometryVertexAttributeUpdated(G.geometries[0],Wt.r.SIZE),this._elementsToRender.delete(R))}_processAddition(R){const G=R.textRenderer.key;if(this._needsRepack)return void this._elements.set(G,R);const H=this._atlas,W=R.textRenderer.renderedWidth,q=R.textRenderer.renderedHeight,Q=W+Bu,J=q+Bu+Hu;if(!this._addAtlasElement(R,G,Q,J)){if(this._canRepack)this._reset();else if(H.width<Q){const R=Math.min((0,tt.Mv)(Math.max(Q,1.5*H.width)),Gu);this._resizeAtlas(R,H.height)}else{const R=H.nextY+J,G=Math.min((0,tt.Mv)(Math.max(R,1.5*H.height)),Gu);if(G>H.height)this._resizeAtlas(H.width,G);else if(H.width<Gu){const R=Math.min((0,tt.Mv)(1.5*H.width),Gu);this._resizeAtlas(R,H.height)}}this._elements.set(G,R)}}_renderElement(R){const G=R.commitNewPosition(),H=R.textRenderer;this._ctx.clearRect(G[0]-Bu,G[1]-Bu,H.renderedWidth+2*Bu,H.renderedHeight+2*Bu),H.render(this._ctx,G[0],G[1]);const W=this._stageObjects.get(H.key);null===W||void 0===W||W.forEach((G=>TextTextureAtlas_y(G,R)))}get running(){return this.updating}runTask(R){if(null==this._glTexture)return Uu.G;for(;this._needsRepack&&(this._canRepack||this._atlas.height<Gu&&this._atlas.height<Gu);){this._canRepack=this._needsRepack=!1;const G=this._elements;this._elements=new Map,G.forEach((R=>this._processAddition(R))),R.madeProgress()}if(this._elementsToRender.size>0){for(const[G,H]of this._elementsToRender){if(R.done)break;this._renderElement(H),this._elementsToRender.delete(G),R.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addTextTexture(R,G){const H=R.key;this._addStageObject(H,G);let W=this._elements.get(H);null==W&&(W=new TextTextureAtlas_O(this._atlas,R),this._processAddition(W),this.setDirty()),function TextTextureAtlas_v(R,G){R.geometries[0].setAttributeData(Wt.r.SIZE,[G.textRenderer.displayWidth,G.textRenderer.displayHeight]),R.geometryVertexAttributeUpdated(R.geometries[0],Wt.r.SIZE)}(G,W),TextTextureAtlas_y(G,W)}removeTextTexture(R,G){const H=R.key;if(!this._elements.get(H))return;this._removeStageObject(H,G);const W=this._stageObjects.get(H);W&&0!==W.size||this._elements.delete(H),0===(null===W||void 0===W?void 0:W.size)&&this._stageObjects.delete(H),this._canRepack=!0}setDirty(){this._glTexture&&(this.updating=!0)}get test(){const{_elements:R,_stageObjects:G,_atlas:H}=this,W=this;return{elements:R,stageObjects:G,atlas:H,resizeAtlas:(R,G)=>W._resizeAtlas(R,G),run:R=>W.runTask(R)}}};function TextTextureAtlas_y(R,G){R.geometries[0].setAttributeData(Wt.r.UV0,G.uv),R.geometryVertexAttributeUpdated(R.geometries[0],Wt.r.UV0,!0)}(0,W._)([(0,ee.MZ)({constructOnly:!0})],zu.prototype,"view",void 0),(0,W._)([(0,ee.MZ)({type:Boolean})],zu.prototype,"updating",void 0),zu=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],zu);const Bu=2,Hu=2;class TextTextureAtlas_O{constructor(R,G){this._atlas=R,this.textRenderer=G,this._uv=(0,Ce.vt)(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return Ce.uY;const{renderedWidth:R,renderedHeight:G}=this.textRenderer;return(0,Se.s)(this._uv,this._xOffset/this._atlas.width,(this._yOffset+G)/this._atlas.height,(this._xOffset+R)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(R){this._newPosition[0]=R.x,this._newPosition[1]=R.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class TextTextureAtlas_k{constructor(R,G){this.width=R,this.height=G,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=ju}}class TextTextureAtlas_E{constructor(R){this.y=R,this.x=ju}}let ju=0;class TextTextureFactory_i{constructor(R,G,H){this._renderer=new TextRenderer_r(R,G,H,zu.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const R=TextHelperCanvas_a(Wu,this._renderer.renderedWidth,this._renderer.renderedHeight),G=R.getContext("2d");return G.save(),this._renderer.render(G,0,0),G.restore(),new Lt.g(R,{wrap:{s:Ft.pF.CLAMP_TO_EDGE,t:Ft.pF.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}}const Wu={canvas:null},ku=(0,xe.fA)(0,0,1);function Graphics3DTextSymbolLayer_A(R,G,H){R&&R.forEach((R=>{const W=G(R);null!=W&&H(W,R.graphic)}))}const qu={mode:"relative-to-ground",offset:0};var Zu=H(93437),Qu=(H(53948),H(27255));class WaterTechnique_S extends Ln.w{initializeConfiguration(R,G){G.spherical=R.viewingMode===qe.RT.Global,G.doublePrecisionRequiresObfuscation=R.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(R){return new Nn.B(R.rctx,WaterTechnique_S.shader.get().build(this.configuration),Fn.D)}_setPipelineState(R){const G=this.configuration,H=R===pa.y.NONE,W=R===pa.y.FrontFace;return(0,Un.Ey)({blending:G.output!==En.V.Normal&&G.output!==En.V.Highlight&&G.output!==En.V.ObjectAndLayerIdColor&&G.transparent?H?ha.V0:(0,ha.ez)(R):null,depthTest:G.draped?null:{func:(0,ha.K_)(R)},depthWrite:G.draped?null:H?G.writeDepth?Un.kn:null:(0,ha.XO)(R),colorWrite:Un.wE,polygonOffset:H||W?null:(0,ha.aB)(G.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}WaterTechnique_S.shader=new Dn.$(Qu.W,(()=>H.e(4601).then(H.bind(H,14601))));class WaterTechnique_T extends zn.E{constructor(){super(...arguments),this.output=En.V.Color,this.transparencyPassType=pa.y.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}}(0,W._)([(0,Gn.W)({count:En.V.COUNT})],WaterTechnique_T.prototype,"output",void 0),(0,W._)([(0,Gn.W)({count:pa.y.COUNT})],WaterTechnique_T.prototype,"transparencyPassType",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"spherical",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"receiveShadows",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"hasSlicePlane",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"transparent",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"enableOffset",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"writeDepth",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"hasScreenSpaceReflections",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"hasCloudsReflections",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"objectAndLayerIdColorInstanced",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"draped",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"multipassEnabled",void 0),(0,W._)([(0,Gn.W)()],WaterTechnique_T.prototype,"cullAboveGround",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],WaterTechnique_T.prototype,"occlusionPass",void 0),(0,W._)([(0,Gn.W)({constValue:Ns.A9.Water})],WaterTechnique_T.prototype,"pbrMode",void 0),(0,W._)([(0,Gn.W)({constValue:!0})],WaterTechnique_T.prototype,"useCustomDTRExponentForWater",void 0),(0,W._)([(0,Gn.W)({constValue:!0})],WaterTechnique_T.prototype,"highStepCount",void 0),(0,W._)([(0,Gn.W)({constValue:!1})],WaterTechnique_T.prototype,"useFillLights",void 0);class WaterGLMaterial_s extends On.A{_updateShadowState(R){R.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:R.shadowMap.enabled})}_updateSSRState(R){const G=null!=R.ssr.lastFrameColor;G!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:G})}_updateCloudsReflectionState(R){const G=null!=R.cloudsFade.data;G!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:G})}ensureResources(R){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(R)}beginSlot(R){return this._output===En.V.Color&&(this._updateShadowState(R),this._updateSSRState(R),this._updateCloudsReflectionState(R)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(WaterTechnique_S,R)}}class WaterMaterial_ extends TriangleMaterial_e{constructor(R){super(R,new WaterMaterial_S),this._configuration=new WaterTechnique_T,this._animation=new Zu.a,this.produces=new Map([[Mn.N.OPAQUE_MATERIAL,R=>(0,En.j8)(R)&&!this.parameters.transparent||(0,En.u5)(R)],[Mn.N.TRANSPARENT_MATERIAL,R=>(0,En.j8)(R)&&this.parameters.transparent||(0,En.u5)(R)],[Mn.N.DRAPED_MATERIAL,R=>this.parameters.draped&&R===En.V.Color||(0,En.u5)(R)],[Mn.N.DRAPED_WATER,R=>R===En.V.Normal]])}getConfiguration(R,G){return this._configuration.output=R,this._configuration.writeDepth=!0,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=G.transparencyPassType,this._configuration.enableOffset=G.camera.relativeElevation<ha.xt,this._configuration.multipassEnabled=G.multipassEnabled,this._configuration.cullAboveGround=G.multipassTerrain.cullAboveGround,this._configuration}update(R){const G=Math.min(R.camera.relativeElevation,R.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*G<Yu;const H=this._animation.advance(R);return this.setParameters({timeElapsed:(0,Ga.y)(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&H}createGLMaterial(R){return new WaterGLMaterial_s(R)}createBufferWriter(){return new hd.Z((0,te.A)("enable-feature:objectAndLayerId-rendering")?md:pd)}get test(){return{animationEnabled:this._animation.enabled}}}class WaterMaterial_S extends Pn.qA{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=(0,Xi.fA)(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=(0,Ce.fA)(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=(0,xe.vt)(),this.modelTransformation=null}}const Yu=35e3,Ju={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},Xu=["polyline","polygon","extent"];class Graphics3DWaterSymbolLayer_I extends Graphics3DSymbolLayer_h{constructor(R,G,H,W){super(R,G,H,W)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials.length=0}createGraphics3DGraphic(R){const G=R.graphic;if(!this._validateGeometry(G.geometry,Xu,this.symbolLayer.type))return null;const H=this.setGraphicElevationContext(G);return this.ensureDrapedStatus("on-the-ground"===H.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(G):this._createAs3DShape(G,H,G.uid)}ensureMaterial(){if(this._materials[0])return;const R=new WaterMaterial_S,G=this.symbolLayer.color;null!=G&&(R.color=oe.A.toUnitRGBA(G));const H=this._getCombinedOpacity(G,{hasIntrinsicColor:!0});R.color=[R.color[0],R.color[1],R.color[2],H],R.transparent=H<1||this.needsDrivenTransparentPass,R.waveDirection=null!=this.symbolLayer.waveDirection?Graphics3DWaterSymbolLayer_I.headingVectorFromAngle(this.symbolLayer.waveDirection):(0,Xi.fA)(0,0);const W=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,q=Ju[W];R.waveStrength=q.waveStrength,R.waveTextureRepeat=q.textureRepeat,R.waveVelocity=q.waveVelocity,R.flowStrength=q.perturbationStrength,R.hasSlicePlane=this._context.slicePlaneEnabled,R.draped=this.draped,this._materials[0]=new WaterMaterial_(R),this._context.stage.add(this._materials[0])}layerOpacityChanged(){if(null==this._materials[0])return;const R=this._materials[0].parameters.color,G=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),H=G<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[R[0],R[1],R[2],G],transparent:H})}layerElevationInfoChanged(R,G,H){const W=this._elevationContext.mode,q=elevationAlignmentUtils_m(Graphics3DWaterSymbolLayer_I.elevationModeChangeTypes,H,W);if(q!==Ht.UPDATE)return q;const Q=elevationAlignmentUtils_d(W);return this.updateGraphics3DGraphicElevationInfo(R,G,(()=>Q))}slicePlaneEnabledChanged(){var R;return null!==(R=this._materials[0])&&void 0!==R&&R.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(R,G,H){var W;const q=(0,Rs.dE)(R.geometry);if(null==q)return null;const Q=polygon_p(q,this._context.elevationProvider,this._context.renderCoordsHelper,G),J=Q.position.length/3,X=(0,Ne.jh)(2*J);this._createUVCoordsFromVertices(X,Q.mapPositions,J,this._context.elevationProvider.spatialReference);const $=new Graphics3DWaterSymbolLayer_z(Q,X,this._context.layer.uid,R.uid);if($.objectAndLayerIdColor=null===(W=this._context.stage.renderView)||void 0===W?void 0:W.getObjectAndLayerIdColor($),this._create3DShapeGeometries($),this._logGeometryCreationWarnings($.renderData,q.rings,"rings","WaterSymbol3DLayer"),0===$.outGeometries.length)return null;const K=new Object3D_O({geometries:$.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:H}),ee=new Graphics3DObject3DGraphicLayer_p(this,K,$.outGeometries,null,null,ElevationAligners_u,G);return ee.alignedSampledElevation=$.renderData.sampledElevation,ee.needsElevationUpdates=elevationAlignmentUtils_d(G.mode),ee}_createUVCoordsFromVertices(R,G,H,W){const q=(0,me.GA)(W);(0,Fe.Ie)(Ku);for(let X=0;X<H;X++)(0,Yn.hZ)(ep,G[3*X],G[3*X+1]),(0,Fe.tK)(Ku,ep);(0,Se.d)(Ku,Ku,q);const Q=Ku[0]%Graphics3DWaterSymbolLayer_I.unitSizeOfTexture,J=Ku[1]%Graphics3DWaterSymbolLayer_I.unitSizeOfTexture;$u[0]=Ku[0]-Q,$u[1]=Ku[1]-J;for(let X=0;X<H;X++)R[2*X]=(G[3*X]*q-$u[0])/Graphics3DWaterSymbolLayer_I.unitSizeOfTexture,R[2*X+1]=(G[3*X+1]*q-$u[1])/Graphics3DWaterSymbolLayer_I.unitSizeOfTexture}_create3DShapeGeometries(R){const G=R.renderData.polygons,H=R.uvCoords;for(const{count:W,index:q,position:Q,mapPositions:J,holeIndices:X}of G){if(null!=this._context.clippingExtent&&((0,Le.Ie)(tp),(0,Le.Hq)(tp,J),!(0,Le.KG)(tp,this._context.clippingExtent)))continue;const G=(0,_s.e)(J,X,3);if(0===G.length)continue;const $=(0,Ne.l5)(H,2*q,2*W),K=(0,Rs.SY)({material:this._materials[0],indices:G,mapPositions:J,attributeData:{position:Q,uv0:$}},R.objectAndLayerIdColor);R.outGeometries.push(K)}}_createAsOverlay(R){var G;const H=(0,Rs.dE)(R.geometry);if(null==H)return null;this._materials[0].renderPriority=this._renderPriority;const W=polygon_c(H,this._context.overlaySR),q=W.position.length/3,Q=(0,Ne.jh)(2*q);this._createUVCoordsFromVertices(Q,W.position,q,this._context.overlaySR);const J=new Graphics3DWaterSymbolLayer_F(W,Q,this._context.layer.uid,R.uid);return J.objectAndLayerIdColor=null===(G=this._context.stage.renderView)||void 0===G?void 0:G.getObjectAndLayerIdColor(J),J.outBoundingBox=(0,Le.Ie)(),this._createAsOverlayWater(J),this._logGeometryCreationWarnings(J.renderData,H.rings,"rings","WaterSymbol3DLayer"),0===J.outGeometries.length?null:new Graphics3DDrapedGraphicLayer_l(this,J.outGeometries,J.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(R){const G=R.uvCoords,H=R.renderData.polygons;for(const{position:W,holeIndices:q,index:Q,count:J}of H){if((0,Le.Ie)(tp),(0,Le.Hq)(tp,W),!(0,Le.KG)(tp,this._context.clippingExtent))continue;(0,Le.RF)(R.outBoundingBox,tp);const H=(0,_s.e)(W,q,3);if(0===H.length)continue;const X=(0,Ne.l5)(G,2*Q,2*J),$=(0,Rs.SY)({material:this._materials[0],indices:H,attributeData:{position:W,uv0:X}},R.objectAndLayerIdColor);R.outGeometries.push(new RenderGeometry_m($,R))}}static headingVectorFromAngle(R){const G=(0,Xi.vt)(),H=(0,Hh.DF)(R);return G[0]=Math.sin(H),G[1]=Math.cos(H),G}test(){return{...super.test(),create3DShape:R=>this._createAs3DShape(R.graphic,R.elevationContext,R.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}Graphics3DWaterSymbolLayer_I.unitSizeOfTexture=100,Graphics3DWaterSymbolLayer_I.elevationModeChangeTypes={definedChanged:Ht.RECREATE,staysOnTheGround:Ht.NONE,onTheGroundChanged:Ht.RECREATE};const $u=(0,Xi.vt)(),Ku=(0,Fe.vt)(),ep=(0,Xi.vt)(),tp=(0,Le.vt)();class Graphics3DWaterSymbolLayer_z extends Rs.JQ{constructor(R,G,H,W){super(R,H,W),this.uvCoords=G}}class Graphics3DWaterSymbolLayer_F extends Rs.JQ{constructor(R,G,H,W){super(R,H,W),this.uvCoords=G}}function Graphics3DSymbolLayerFactory_c(R,G,H,W){var q;const Q=(null===(q=rp[R.type])||void 0===q?void 0:q[G.type])||ip[G.type];return Q?new Q(R,G,H,W):(J.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make","unknown symbol type ".concat(G.type)),null)}const ip={icon:Graphics3DIconSymbolLayer_le,object:class Graphics3DObjectSymbolLayer_pe extends Graphics3DSymbolLayer_h{getCachedSize(){const[R,G,H]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:R,depth:G,height:H}}constructor(R,G,H,W){super(R,G,H,W),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=H.physicalBasedRenderingEnabled}async doLoad(R){if(!this._drivenProperties.size&&graphicUtils_I(this.symbolLayer))throw new Error;if(this._isPrimitive){const G=this.symbolLayer.resource,H=G&&function primitiveObjectSymbolUtils_d(R){switch(R){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(G.primitive)?G.primitive:qi.r;this._resources=await this._createResourcesForPrimitive(H,R)}else{var G;const H=await async function webStyleUtils_r(R){var G;if(null===R||null==R.styleName&&null==R.styleUrl)return null;const H=R.name;if(null==H)throw new Ze.A("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference");const W={portal:R.portal},q=await(0,th.cF)(R,W).catch((()=>null));if(null===q)return null;const Q=(0,ih.p)(H,q.data);if(Q&&(null===(G=Q.formatInfos)||void 0===G||!G.some((R=>"gltf_basisu"===R.type))))return null;const J=await(0,ih.I)(q,H,W,"webRef",((R,G)=>(0,th.o5)(R,G,["gltf_basisu","gltf"]))).catch((()=>null));if(null===J||"point-3d"!==J.type)return null;const X=J.symbolLayers.items[0];return"object"===X.type?X.resource:null}(this.symbol.styleOrigin),W=null!==(G=null===H||void 0===H?void 0:H.href)&&void 0!==G?G:this.symbolLayer.resource.href;this._resources=await this._createResourcesForUrl(W,R)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return null!=this._resources?this._resources.extentPadding:0}get _isPrimitive(){var R;return!(null!==(R=this.symbolLayer.resource)&&void 0!==R&&R.href)}get lodRenderer(){var R;return null===(R=this._resources)||void 0===R?void 0:R.lodRenderer}get materials(){var R,G;return null!==(R=null===(G=this._resources)||void 0===G?void 0:G.stageResources.materials)&&void 0!==R?R:[]}_setMaterialTransparencyParameters(R){var G;let H=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null===(G=this.symbolLayer)||void 0===G||null===(G=G.material)||void 0===G?void 0:G.color;const W=this._getCombinedOpacity(H),q=W<1||this.needsDrivenTransparentPass;return R.transparent=q,R.opacity=W,R.cullFace=q?et.s2.None:et.s2.Back,R}async _createResourcesForPrimitive(R,G){const H=this.symbolLayer,W=(0,Le.vt)((0,Zd.Fq)(R)),q=(0,xe.ci)((0,Le.Ej)(W)),Q=(0,xe.ci)((0,Zd.Bb)(q,H)),J=(0,be.l)(Q),X={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:[...it.mX],ambient:xe.Un,diffuse:xe.Un,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},$=!!X.usePBR;this._setMaterialTransparencyParameters(X);const K=this.symbol;if("point-3d"===K.type&&K.verticalOffset){const{screenLength:R,minWorldLength:G,maxWorldLength:H}=K.verticalOffset;X.verticalOffset={screenLength:(0,kr.Lz)(R),minWorldLength:G||0,maxWorldLength:null!=H?H:1/0},X.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(X.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)X.externalColor=Ce.Un;else{const R=null!=H.material?H.material.color:null,G=null!=R?oe.A.toUnitRGBA(R):Ce.Un;X.externalColor=G}this._fastUpdates=(0,hn.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(W,Q,q,null)),X.isInstanced=!0,this._fastUpdates?(Object.assign(X,this._fastUpdates.materialParameters),this._optionalFields.push(Wt.r.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(X.hasInstancedColor=!0,this._optionalFields.push(Wt.r.COLOR)),(0,te.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(Wt.r.OBJECTANDLAYERIDCOLOR);const ee=primitiveObjectSymbolUtils_S(R,new Mr.$U(X));if(!ee)throw new Error("Unknown object symbol primitive: ".concat(R));const ie=LodResources_c(ee).map((R=>({opacity:1,transparent:R.parameters.transparent}))),re=await this._createStageResources(ee,$,G),ne=await this._createLodRenderer(ee,G);return new Graphics3DObjectSymbolLayer_me(ee,ne,re,ie,q,!1,!1,W,Q,J,$,null)}async _createResourcesForUrl(R,G){var H;const W={materialParameters:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=(0,hn.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(W.materialParameters,this._fastUpdates.materialParameters),this._optionalFields.push(Wt.r.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(W.materialParameters.hasInstancedColor=!0,this._optionalFields.push(Wt.r.COLOR)),(0,te.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(Wt.r.OBJECTANDLAYERIDCOLOR);const q=this.symbol;if("point-3d"===q.type&&q.verticalOffset){const{screenLength:R,minWorldLength:G,maxWorldLength:H}=q.verticalOffset;W.materialParameters.verticalOffset={screenLength:(0,kr.Lz)(R),minWorldLength:G||0,maxWorldLength:null!=H?H:1/0},W.materialParameters.castShadows=!1}const Q=this._context.physicalBasedRenderingEnabled;W.signal=G,W.usePBR=Q,W.skipHighLods=this._context.skipHighSymbolLods;const J=await(0,eh.fetch)(R,W),X=J.isEsriSymbolResource,$=J.isWosr,K=function lodResourceUtils_r(R){return new LodResources_n(R.map(((R,G)=>lodResourceUtils_n(R,G))))}(J.lods),ee=this._context,ie=this.symbolLayer.material,re=this._getExternalColorParameters(ie),ne=null===(H=this.symbolLayer)||void 0===H||null===(H=H.material)||void 0===H?void 0:H.color,se=this._getCombinedOpacity(ne,{hasIntrinsicColor:!0}),ae=this.needsDrivenTransparentPass,oe=LodResources_c(K),le=LodResources_c(K).map((R=>({opacity:R.parameters.opacity||1,transparent:R.parameters.transparent})));oe.forEach((R=>{const G=R.parameters;R.setParameters(re);const H=G.opacity*se,W=H<1||ae||G.transparent;R.setParameters({opacity:H,transparent:W}),ee.screenSizePerspectiveEnabled&&R.setParameters({screenSizePerspective:ee.sharedResources.screenSizePerspectiveSettings})}));const ce=J.referenceBoundingBox,de=(0,xe.ci)((0,Le.Ej)(ce)),he=(0,xe.ci)(K.levels[0].pivotOffset),ue=(0,xe.ci)((0,Zd.Bb)(de,this.symbolLayer)),pe=(0,be.l)(ue),_e=this._fastUpdates;(0,hn.J_)(_e,this._context.renderer,this._fastVisualVariableConvertOptions(ce,ue,de,he))&&oe.forEach((R=>R.setParameters(_e.materialParameters)));const me=await this._createStageResources(K,Q,G),ge=await this._createLodRenderer(K,G);return new Graphics3DObjectSymbolLayer_me(K,ge,me,le,de,X,$,ce,ue,pe,Q,he)}_addDisposeResource(R){this._disposeResourceHandles.push(R)}async _createStageResources(R,G,H){const W=this._context.stage,q=LodResources_c(R);G!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),W.addMany(q),this._addDisposeResource((()=>W.removeMany(q)));const Q=LodResources_o(R);W.addMany(Q),this._addDisposeResource((()=>{Q.forEach((R=>R.unload())),W.removeMany(Q)})),await Promise.all(Q.map((R=>this._context.stage.schedule((()=>R.load(W.renderView.renderingContext)),H)))),(0,X.Te)(H);const J=LodResources_i(R);return W.addMany(J),this._addDisposeResource((()=>W.removeMany(J))),{materials:q,textures:Q,geometries:J}}async _createLodRenderer(R,G){const H=this._context.stage,W={layerUid:this._context.layer.uid,graphicUid:R=>this._instanceIndexToGraphicUid.get(R),notifyGraphicGeometryChanged:R=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(R)),notifyGraphicVisibilityChanged:R=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(R))},q=this._fastUpdates,Q=q?{applyTransform:(R,G,H)=>{R.getFeatureAttribute(G,Ch),(0,ye.C)(H,(0,hn.b3)(q.materialParameters,Ch,H))},scaleFactor:(R,G,H)=>{G.getFeatureAttribute(H,Ch),(0,hn.VC)(R,q.materialParameters,Ch)}}:null,J=new uh({symbol:R,optionalFields:this._optionalFields,metadata:W,shaderTransformation:Q},this._context.scheduler);return J.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((()=>{H.removeRenderPlugin(J),J.destroy()})),await H.addRenderPlugin(J,G),J}_getExternalColorParameters(R){const G={};return this._drivenProperties.color?G.externalColor=Ce.Un:null!=(null===R||void 0===R?void 0:R.color)?G.externalColor=oe.A.toUnitRGBA(R.color):(G.externalColor=Ce.Un,G.colorMixMode="ignore"),G}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach((R=>R())),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(R){const G=R.graphic;if(!this._validateGeometry(G.geometry))return null;const H=pointUtils_m(G.geometry);if(null==H)return this.logger.warn("unsupported geometry type for icon symbol: ".concat(G.geometry.type)),null;const W=this.setGraphicElevationContext(G),q=R.renderingInfo;return this._createAs3DShape(G,H,q,W,G.uid,R.layer.uid)}notifyDestroyGraphicLayer(R){this._instanceIndexToGraphicUid.delete(R.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null==this._resources)return;const R=this._drivenProperties.opacity,G=!this._isPrimitive,H=this._resources.stageResources.materials,W=this._resources.originalMaterialParameters;for(let Q=0;Q<H.length;Q++){var q;const J=H[Q],X=null===(q=this.symbolLayer)||void 0===q||null===(q=q.material)||void 0===q?void 0:q.color,$=W[Q],K=this._getCombinedOpacity(X,{hasIntrinsicColor:G})*$.opacity,ee=K<1||R||$.transparent;J.setParameters({opacity:K,transparent:ee}),this._isPrimitive&&J.setParameters({cullFace:ee?et.s2.None:et.s2.Back})}}layerElevationInfoChanged(R,G){return this.updateGraphics3DGraphicElevationInfo(R,G,elevationAlignmentUtils_g)}slicePlaneEnabledChanged(){if(null==this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const R of this._resources.stageResources.materials)R.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const{stageResources:R,isWosr:G}=this._resources;for(const H of R.materials)this._isPrimitive?H.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):G||H.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(R,G){if(null==this._resources)return cn.RecreateSymbol;const{stageResources:{materials:H},lodRenderer:W,resourceBoundingBox:q,symbolSize:Q,resourceSize:J,pivotOffset:X}=this._resources;for(const $ in R.diff){if("visualVariables"!==$)return cn.RecreateSymbol;if(!(0,hn.J_)(this._fastUpdates,G,this._fastVisualVariableConvertOptions(q,Q,J,X)))return cn.RecreateSymbol;for(const R of H)R.setParameters(this._fastUpdates.materialParameters);W.notifyShaderTransformationChanged()}return cn.FastUpdate}computeComplexity(){if(null==this._resources)return super.computeComplexity();const R=this._resources.lodResources,G=defaultSymbolComplexity_w(R.levels),H=LodResources_i(R).reduce(((R,G)=>R+(R=>Array.from(R.attributes.values()).reduce(((R,G)=>R+(0,_e.Ek)(G.data,G.indices)),0))(G)),0),W=LodResources_o(R).reduce(((R,G)=>R+G.memoryEstimate),0)+H,q={...defaultSymbolComplexity_C(this.symbol,this.symbolLayer),resourceBytes:W};return new SymbolComplexity_e({verticesPerFeature:G,memory:q})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(R,G,H,W,q,Q){if(!this._hasLodRenderer()||null==this._resources)return null;const J=this.getFastUpdateAttrValues(R),X=this._context.clippingExtent;if((0,mn.g)(G,bh,this._context.elevationProvider.spatialReference),null!=X&&!(0,Le.Uc)(X,bh))return null;const $=this._requiresTerrainElevation(W),K=this._computeGlobalTransform(G,W,Sh,wh),ee=this._computeLocalTransform(this._resources,this.symbolLayer,H,xh),te=this._resources.lodRenderer.instanceData,ie=te.addInstance();this._instanceIndexToGraphicUid.set(ie,q),te.setLocalTransform(ie,ee,!1),te.setGlobalTransform(ie,K),J&&te.setFeatureAttribute(ie,J),null==this._fastUpdates&&this._hasPerInstanceColor()&&te.setColor(ie,graphicUtils_F(H.color,H.opacity,255)),null!=this._context.stage.renderView.objectAndLayerIdRenderHelper&&te.setObjectAndLayerIdColor(ie,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:q,layerUid:Q}));const re=new Graphics3DLodInstanceGraphicLayer_p(this,ie,ElevationAligners_b,W);return $&&(re.alignedSampledElevation=wh.sampledElevation),re.needsElevationUpdates=elevationAlignmentUtils_g(W.mode),pointUtils_p(re,G,this._context.elevationProvider),re}_computeGlobalTransform(R,G,H,W){return elevationAlignmentUtils_c(R,this._context.elevationProvider,G,this._context.renderCoordsHelper,W),bh[0]=R.x,bh[1]=R.y,bh[2]=W.z,(0,Bt.l)(R.spatialReference,bh,H,this._context.renderCoordsHelper.spatialReference),H}_computeLocalTransform(R,G,H,W){return(0,ye.D_)(W),this._applyObjectRotation(H,!1,W),this._applyObjectRotation(G,!0,W),this._applyObjectScale(R,H,W),this._applyAnchor(R,G,W),W}_applyObjectScale(R,G,H){var W;if(null!==(W=this._fastUpdates)&&void 0!==W&&W.requiresShaderTransformation)return;const q=graphicUtils_B(this._drivenProperties.size&&G.size?G.size:R.symbolSize,R.symbolSize,R.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===q[0]&&1===q[1]&&1===q[2]||(0,ye.hs)(H,H,q)}prepareSymbolLayerPatch(R){if("partial"!==R.diff.type)return;const G=R.diff.diff;this._preparePatchTransform(R,G),this._preparePatchColor(R,G)}updateGeometry(R,G){if(null==this._resources)return!0;const H=G&&pointUtils_m(G);if(null==H)return!1;const W=this.getGeometryElevationMode(G);return R.elevationContext.mode===W&&(this._computeGlobalTransform(H,R.elevationContext,Sh,wh),this._requiresTerrainElevation(R.elevationContext)&&(R.alignedSampledElevation=wh.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(R.instanceIndex,Sh,!0),pointUtils_p(R,H,this._context.elevationProvider),!0)}_preparePatchTransform(R,G){if(!(G.heading||G.tilt||G.roll||G.width||G.height||G.depth||G.anchor||G.anchorPosition))return;if(null==this._resources)return;const s=(R,G,H)=>{var W;return null!==(W=null!=R&&"complete"===R.type?R.newValue:G)&&void 0!==W?W:H},H=s(G.heading,this.symbolLayer.heading,0),W=s(G.tilt,this.symbolLayer.tilt,0),q=s(G.roll,this.symbolLayer.roll,0),Q=s(G.width,this.symbolLayer.width,void 0),J=s(G.height,this.symbolLayer.height,void 0),X=s(G.depth,this.symbolLayer.depth,void 0),$=s(G.anchor,this.symbolLayer.anchor,void 0),K=s(G.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete G.heading,delete G.tilt,delete G.roll,delete G.width,delete G.height,delete G.depth,delete G.anchor,delete G.anchorPosition;const ee={heading:H,tilt:W,roll:q,anchor:$,anchorPosition:K},te=this._resources;this.loadStatus===dn.LOADED&&R.symbolLayerStatePatches.push((()=>{te.symbolSize=(0,xe.ci)((0,Zd.Bb)(te.resourceSize,{width:Q,height:J,depth:X,isPrimitive:this.symbolLayer.isPrimitive}))})),R.graphics3DGraphicPatches.push(((R,G)=>{const H=this._computeLocalTransform(te,ee,G,xh),W=R.instanceIndex;te.lodRenderer.instanceData.setLocalTransform(W,H,!0)}))}_preparePatchColor(R,G){if(!G.material||"partial"!==G.material.type)return;const H=G.material.diff;if(!H.color||"complete"!==H.color.type||null==H.color.newValue||null==H.color.oldValue)return;const W=H.color.newValue,q=null!=W?oe.A.toUnitRGBA(W):Ce.Un;delete H.color;const Q=this._resources;null!=Q&&R.graphics3DGraphicPatches.push((R=>{let G;this._hasPerInstanceColor()?(Q.lodRenderer.instanceData.setColor(R.instanceIndex,q),G=this._setMaterialTransparencyParameters({},W)):G=this._setMaterialTransparencyParameters({externalColor:q},W);for(const H of Q.stageResources.materials)H.setParameters(G)}))}_requiresTerrainElevation(R){return"absolute-height"!==R.mode}_applyObjectRotation(R,G,H){var W;if(null===(W=this._fastUpdates)||void 0===W||!W.requiresShaderTransformation||!G)return function graphicUtils_U(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,ve.vt)();return R&&(0,ye.Qr)(W,W,-R/180*Math.PI),G&&(0,ye.eL)(W,W,G/180*Math.PI),H&&(0,ye.Z8)(W,W,H/180*Math.PI),W}(R.heading,R.tilt,R.roll,H)}_computeAnchor(R,G,H){const W=(0,xe.vt)();switch(H.anchor){case"center":(0,be.c)(W,(0,Le.gX)(R)),(0,be.F)(W,W);break;case"top":{const G=(0,Le.gX)(R);(0,be.s)(W,-G[0],-G[1],-R[5]);break}case"bottom":{const G=(0,Le.gX)(R);(0,be.s)(W,-G[0],-G[1],-R[2]);break}case"relative":{const G=(0,Le.gX)(R),q=(0,Le.Ej)(R),Q=H.anchorPosition,J=Q?(0,xe.fA)(Q.x,Q.y,Q.z):xe.uY;(0,be.B)(W,q,J),(0,be.g)(W,W,G),(0,be.F)(W,W);break}default:null!=G?(0,be.F)(W,G):(0,be.c)(W,xe.uY)}return W}_applyAnchor(R,G,H){var W;if(null!==(W=this._fastUpdates)&&void 0!==W&&W.requiresShaderTransformation)return;const q=this._computeAnchor(R.resourceBoundingBox,R.pivotOffset,G);q&&(0,ye.Tl)(H,H,q)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(R,G,H,W){const q=null!=R?(0,xe.ci)((0,Le.Ej)(R)):xe.Un,Q=null!=R?this._computeAnchor(R,W,this.symbolLayer):xe.uY,J=this._context.renderCoordsHelper.unitInMeters,X=graphicUtils_B(null!=G?G:void 0,G,H,J),$=(0,xe.fA)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new hn.wI({size:!0,color:!0,rotation:!0,opacity:!1},q,null!==G&&void 0!==G?G:xe.Un,J,Q,X,$)}},line:Graphics3DLineSymbolLayer_O,path:class Graphics3DPathSymbolLayer_te extends Graphics3DSymbolLayer_h{constructor(R,G,H,W){super(R,G,H,W),this._intrinsicSize=(0,Xi.fA)(1,1),this._upVectorAlignment=Ph.Path,this._stencilWidth=.1,this.usedMemory=0,this.ensureDrapedStatus(!1)}async doLoad(){var R,G,H;const W=null!=this.symbolLayer.width?this.symbolLayer.width:this.symbolLayer.height,q=null!=this.symbolLayer.height?this.symbolLayer.height:W;this._vvConvertOptions=new hn.wI({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[W,1,q],this._context.renderCoordsHelper.unitInMeters),this._fastUpdates=(null===(R=this._context.renderer)||void 0===R||null===(R=R.visualVariables)||void 0===R?void 0:R.length)>0?(0,hn.s_)(this._context.renderer,this._vvConvertOptions):null;const Q=this.symbolLayer.anchor||"center";this._upVectorAlignment="heading"===this.symbolLayer.profileRotation?Ph.World:Ph.Path;const J=this.symbolLayer.profile||"circle";switch(J){default:case"circle":this._profile=zh[Q];break;case"quad":this._profile=Bh[Q]}switch(this.symbolLayer.join){case"round":this._extruder=new PathExtruder_a(0,Zi);break;case"bevel":this._extruder=new PathExtruder_a(0,1);break;case"miter":this._extruder=new PathExtruder_a(.8*Math.PI,1);break;default:this._extruder=new PathExtruder_c}const X=this.symbolLayer.cap||"butt";switch(X){case"none":this._startCap=new PathCapBuilder_l,this._endCap=new PathCapBuilder_l;break;case"butt":default:this._startCap=new PathCapBuilder_f(this._profile,0),this._endCap=new PathCapBuilder_f(this._profile,0,!0);break;case"square":this._startCap=new PathCapBuilder_f(this._profile,-.5),this._endCap=new PathCapBuilder_f(this._profile,.5,!0);break;case"round":{const R="quad"===J;this._startCap=new PathCapBuilder_h({profile:this._profile,flip:!1,breakNormals:R,subdivisions:Qi}),this._endCap=new PathCapBuilder_h({profile:this._profile,flip:!0,breakNormals:R,subdivisions:Qi});break}}const $=null===(G=this.symbolLayer)||void 0===G||null===(G=G.material)||void 0===G?void 0:G.color,K=this._getCombinedOpacityAndColor($),ee=(0,xe.ci)(K),te=K[3],ie=te<1||this.needsDrivenTransparentPass,re={diffuse:ee,ambient:ee,opacity:te,transparent:ie,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:ie||"none"===X?et.s2.None:et.s2.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&((0,Yn.hZ)(this._intrinsicSize,W,q),!graphicUtils_S(this._intrinsicSize[0])||!graphicUtils_S(this._intrinsicSize[1])))throw new Ze.A("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(null!==(H=this._fastUpdates)&&void 0!==H&&H.visualVariables.size||(0,Yn.hs)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates){const R={...re,...this._fastUpdates.materialParameters,size:(0,Xi.ci)(this._intrinsicSize)};this._materials[0]=new PathMaterial_g(R)}else re.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,re.normalType=dl.W.Compressed,this._materials[0]=new Mr.$U(re);this._materials[0].setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._materials[0])}destroy(){super.destroy(),this._context.stage.remove(this._materials[0]),this._materials[0]=null,this._materials.length=0}createGraphics3DGraphic(R){const G=R.graphic;if(!this._validateGeometry(G.geometry,au,this.symbolLayer.type))return null;const H=this.setGraphicElevationContext(G),W=R.renderingInfo;return this._createAs3DShape(G,W,H,G.uid)}layerOpacityChanged(){var R,G;const H=null===(R=this.symbolLayer)||void 0===R||null===(R=R.material)||void 0===R?void 0:R.color,W=this._getCombinedOpacity(H),q=W<1||this.needsDrivenTransparentPass;null===(G=this._materials[0])||void 0===G||G.setParameters({opacity:W,transparent:q})}layerElevationInfoChanged(R,G){return this.updateGraphics3DGraphicElevationInfo(R,G,elevationAlignmentUtils_g)}slicePlaneEnabledChanged(){var R;return null!==(R=this._materials[0])&&void 0!==R&&R.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){var R;return null!==(R=this._materials[0])&&void 0!==R&&R.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(R,G){for(const W in R.diff){var H;if("visualVariables"!==W)return cn.RecreateSymbol;if(!(0,hn.J_)(this._fastUpdates,G,this._vvConvertOptions))return cn.RecreateSymbol;null===(H=this._materials[0])||void 0===H||H.setParameters(this._fastUpdates.materialParameters)}return cn.FastUpdate}_getVertexData(R){let G=0;const H=R.paths,W=[],q=R.spatialReference,Q=this._context.elevationProvider.spatialReference,J=this._context.renderCoordsHelper.spatialReference;for(const ee of H)G+=ee.length;const X=(0,Ne.jh)(3*G);let $,K=0;for(const ee of H){W.push({offset:K,numVertices:ee.length});for(const G of ee)X[K++]=G[0],X[K++]=G[1],X[K++]=R.hasZ?G[2]:0}return null==Q||q.equals(Q)||(0,Ie.projectBuffer)(X,q,0,X,Q,0,G)?(null==Q||Q.equals(J)?$=(0,Ne.xm)(X):($=(0,Ne.jh)(3*G),(0,Ie.projectBuffer)(X,Q,0,$,J,0,G)),{pathVertexDataInfos:W,vertexDataES:X,vertexDataRS:$}):null}_createAs3DShape(R,G,H,W){this.usedMemory=0;const q=R.geometry,Q=this._getVertexData(q);if(null==Q)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===Q.pathVertexDataInfos.length)return 0!==q.paths.length&&q.paths.some((R=>R.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;const J=new Array,X=q.spatialReference,$=(0,Le.vt)(),K=this._context.renderCoordsHelper,ee=new ElevationProvider_r(Q.vertexDataES);for(const ce of Q.pathVertexDataInfos){const q=ce.numVertices;if(q<2)continue;const oe=ce.offset;if(null!=this._context.clippingExtent&&((0,Le.Ie)($),(0,Le.Hq)($,Q.vertexDataES,oe,q),!(0,Le.KG)($,this._context.clippingExtent)))continue;const le=new Array,de=oe+3*q;for(let R=oe;R<de;R+=3){ee.offset=R;const G=elevationAlignmentUtils_f(ee,this._context.elevationProvider,H,K);(0,be.s)(ou,Q.vertexDataRS[R],Q.vertexDataRS[R+1],Q.vertexDataRS[R+2]),K.setAltitude(ou,G),Q.vertexDataRS[R]=ou[0],Q.vertexDataRS[R+1]=ou[1],Q.vertexDataRS[R+2]=ou[2],le.push(PathVertex_A(this._upVectorAlignment))}const he=new Path_r(le,Q.vertexDataES,Q.vertexDataRS,oe);Graphics3DPathSymbolLayer_ie(he,this._upVectorAlignment,this._context.renderCoordsHelper);const ue=new PathBuilder_h(he,this._profile,this._extruder,this._startCap,this._endCap);let pe=null;if(this._fastUpdates){var te,ie,re,ne,se,ae;const G=this._fastUpdates.visualVariables,H=null!==(te=(0,hn.ul)(null===(ie=G.size)||void 0===ie?void 0:ie.field,R))&&void 0!==te?te:0,W=null!==(re=(0,hn.ul)(null===(ne=G.color)||void 0===ne?void 0:ne.field,R))&&void 0!==re?re:0,q=null!==(se=(0,hn.ul)(null===(ae=G.opacity)||void 0===ae?void 0:ae.field,R))&&void 0!==se?se:0;pe=new PathGeometryData_g(ue,H,W,q)}else{const R=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const H=G.size;R[0]*=Graphics3DPathSymbolLayer_re(H[0],"symbol-value"===H[2]?this.symbolLayer.height||0:H[2],this.symbolLayer.width||0),R[1]*=Graphics3DPathSymbolLayer_re(H[2],"symbol-value"===H[0]?this.symbolLayer.width||0:H[0],this.symbolLayer.height||0)}let H;this._drivenProperties.color&&(H=G.color),this._drivenProperties.opacity&&null!=G.opacity&&(H=H?[H[0],H[1],H[2],G.opacity]:[1,1,1,G.opacity]);const W=new PathGeometryData_f(ue);W.bake(R),H&&W.bakeVertexColors(H),pe=W}const _e=pe.createGeometryData(),me=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:W,layerUid:this._context.layer.uid}),ge=new PathGeometry_e(this._materials[0],_e,pe,X,this._stencilWidth,me);ge.transformation=(0,ye.Tl)((0,ve.vt)(),ve.zK,ue.path.origin),J.push(ge),this.usedMemory+=ue.usedMemory}if(0===J.length)return null;const oe=new Object3D_O({geometries:J,layerUid:this._context.layer.uid,graphicUid:W}),le=new Graphics3DObject3DGraphicLayer_p(this,oe,J,null,null,((R,G,H,W,q)=>function Graphics3DPathSymbolLayer_ae(R,G,H,W,q){const Q=R.stageObject,J=Q.geometries;let X=0;for(const $ of J){if(!PathGeometry_n($))continue;const R=$.path,J=R.builder.path;X+=Graphics3DPathSymbolLayer_se(J,G,H,W),q!==Ph.World&&Graphics3DPathSymbolLayer_ie(J,q,W),R.onPathChanged($),$.invalidateBoundingInfo(),Q.geometryVertexAttributeUpdated($,Wt.r.POSITION)}return X/J.length}(R,G,W,q,this._upVectorAlignment)),H);return le.alignedSampledElevation=0,le.needsElevationUpdates=elevationAlignmentUtils_g(H.mode),le}},fill:Graphics3DPolygonFillSymbolLayer_N,extrude:class Graphics3DExtrudeSymbolLayer_$ extends Graphics3DSymbolLayer_h{constructor(R,G,H,W){super(R,G,H,W),this.ensureDrapedStatus(!1)}async doLoad(){var R;if(!this._drivenProperties.size){const R=graphicUtils_I(this._getSymbolSize());if(R)throw new Ze.A("graphics3dextrudesymbollayer:invalid-size",R)}const G=null===(R=this.symbolLayer)||void 0===R||null===(R=R.material)||void 0===R?void 0:R.color,H=this._getCombinedOpacityAndColor(G),W=(0,xe.ci)(H),q=H[3],Q=q<1||this.needsDrivenTransparentPass,J={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:W,ambient:W,opacity:q,transparent:Q,cullFace:Q?et.s2.None:et.s2.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:dl.W.Compressed};this._materials[Rl.Main]=new Mr.$U(J),this._materials[Rl.Bottom]=new Mr.$U({...J,cullFace:et.s2.Back}),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(R){const G=R.graphic;if(!this._validateGeometry(G.geometry,ul,this.symbolLayer.type))return null;const H=this._getVertexOpacityAndColor(R.renderingInfo,255),W=this.setGraphicElevationContext(G);return this._createAs3DShape(G,R.renderingInfo,H,W,G.uid)}layerOpacityChanged(R,G){var H,W,q;const Q=null===(H=this.symbolLayer)||void 0===H||null===(H=H.material)||void 0===H?void 0:H.color,J=this._getCombinedOpacity(Q),X=J<1||this.needsDrivenTransparentPass;null!==(W=this._materials[Rl.Main])&&void 0!==W&&W.setParameters({opacity:J,transparent:X}),null===(q=this._materials[Rl.Bottom])||void 0===q||q.setParameters({opacity:J,transparent:X});const $=this._getLayerOpacity();R.forEach((R=>{const H=G(R);null!=H&&H.layerOpacityChanged($,this._context.isAsync)}))}layerElevationInfoChanged(R,G){return this.updateGraphics3DGraphicElevationInfo(R,G,elevationAlignmentUtils_g)}slicePlaneEnabledChanged(R,G){var H,W;return null!==(H=this._materials[Rl.Main])&&void 0!==H&&H.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),null!==(W=this._materials[Rl.Bottom])&&void 0!==W&&W.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),R.forEach((R=>{const H=G(R);null!=H&&H.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){var R,G;const H={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return null!==(R=this._materials[Rl.Main])&&void 0!==R&&R.setParameters(H),null!==(G=this._materials[Rl.Bottom])&&void 0!==G&&G.setParameters(H),!0}_getExtrusionSize(R){var G;let H;return H=R.size&&this._drivenProperties.size?null!==(G=function renderingInfoUtils_a(R){const G=R[arguments.length>1&&void 0!==arguments[1]?arguments[1]:0];return"number"==typeof G&&isFinite(G)?G:null}(R.size,2))&&void 0!==G?G:0:this._getSymbolSize(),H/=this._context.renderCoordsHelper.unitInMeters,H}applyRendererDiff(R,G){return this._drivenPropertiesChanged(G)?cn.RecreateSymbol:cn.RecreateGraphics}async queryForSnapping(R,G,H,W){var q;const Q=this._getExtrusionSize(H)*this._context.renderCoordsHelper.unitInMeters/(0,me.G9)(G),{objectId:J,target:X}=R,$=(0,Tt.o8)(X);switch($.z=(null!==(q=$.z)&&void 0!==q?q:0)+Q,R.type){case"edge":{var K,ee;const{start:G,end:H}=R,W=(0,Tt.o8)(G),q=(0,Tt.o8)(H);return W.z=(null!==(K=W.z)&&void 0!==K?K:0)+Q,q.z=(null!==(ee=q.z)&&void 0!==ee?ee:0)+Q,[(0,Ss.P)(J,$,1/0,W,q)]}case"vertex":return[(0,Ss.k)(J,$,1/0),(0,Ss.P)(J,X,1/0,X,$)];default:return[]}}_getSymbolSize(){var R;return null!==(R=this.symbolLayer.size)&&void 0!==R?R:1}_createAs3DShape(R,G,H,W,q){const Q=(0,Rs.dE)(R.geometry);if(null==Q)return null;if(0===Q.rings.length||!Q.rings.some((R=>R.length>0)))return this._logGeometryValidationWarnings(Q.rings,"rings","ExtrudeSymbol3DLayer"),null;const J=polygon_p(Q,this._context.elevationProvider,this._context.renderCoordsHelper,W);this._logGeometryCreationWarnings(J,Q.rings,"rings","ExtrudeSymbol3DLayer");const X=graphicUtils_b(Q);if(null==X)return null;const $=new Array,K=new Array,ee=(0,Le.vt)(),te=(0,ve.vt)(),ie=(0,xe.vt)(),re=this._context.renderCoordsHelper.viewingMode===qe.RT.Global;re||this._context.renderCoordsHelper.worldUpAtPosition(null,ie),(0,Bt.l)(Q.spatialReference,[X.x,X.y,0],te,this._context.renderCoordsHelper.spatialReference);const ne=(0,ve.vt)();(0,ye.B8)(ne,te);const se=(0,fe.vt)();(0,ge.Ge)(se,ne);const{polygons:ae,mapPositions:oe,position:le}=J;for(const pe of ae){const R=pe.count;if(this._context.clippingExtent&&((0,Le.Ie)(ee),(0,Le.Hq)(ee,pe.mapPositions),!(0,Le.KG)(ee,this._context.clippingExtent)))continue;const W=(0,_s.e)(pe.mapPositions,pe.holeIndices,3);if(0===W.length)continue;const Q=W.length,J=6*R,X=(0,Ue.my)(J+Q),te=(0,Ue.my)(Q),se=(0,Ne.jh)(3*J),ae=(0,Ne.jh)(3*J),ce=(0,Ne.jh)(3*J),de=(0,Ne.jh)(J);Graphics3DExtrudeSymbolLayer_te(le,oe,W,pe,se,ce,ae,de,X,te,this._getExtrusionSize(G),ie,re),(0,xs.a)(se,se,ne);const he=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:q,layerUid:this._context.layer.uid}),ue=new Graphics3DExtrudeSymbolLayer_je(se,ce,(0,hl.fA)(ae),de);$.push(Graphics3DExtrudeSymbolLayer_ee(this._materials[Rl.Main],X,X.length-te.length,ue,H,he),Graphics3DExtrudeSymbolLayer_ee(this._materials[Rl.Bottom],te,0,ue,H,he)),K.push(ue.heights)}if(0===$.length)return null;const ce=new Object3D_O({geometries:$,layerUid:this._context.layer.uid,graphicUid:q,isElevationSource:!0});ce.transformation=te;const de=(0,Pr.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),he=null!=de?{baseMaterial:this._materials[Rl.Main],edgeMaterials:[de],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,ue=new Graphics3DObject3DGraphicLayer_p(this,ce,$,null,null,((R,G,H,W,q)=>function Graphics3DExtrudeSymbolLayer_ge(R,G,H,W,q,Q){const J=R.stageObject,X=J.geometries,$=X.length,K="absolute-height"!==G.mode;let ee=0;const te=J.transformation,ie=(0,ye.Qw)((0,ve.vt)(),te);for(let re=0;re<$;re+=2){const R=X[re];if(!GeometryWithMapPositions_e(R))continue;const G=R.getMutableAttribute(Wt.r.POSITION).data,$=Q[re/2],ne=new ElevationProvider_r(R.mapPositions),se=G.length/3;let ae=0,oe=!1,le=0;for(let Q=0;Q<se;Q++){vl[0]=G[ae],vl[1]=G[ae+1],vl[2]=G[ae+2],W(ne,Sl),K&&(le+=Sl.sampledElevation),qr.b.TESTS_DISABLE_OPTIMIZATIONS?((0,be.s)(bl,ne.array[ne.offset],ne.array[ne.offset+1],Sl.z+$[ae/3]),null!=H&&q.toRenderCoords(bl,H,bl),(0,be.e)(bl,bl,ie)):((0,be.s)(bl,G[ae],G[ae+1],G[ae+2]),(0,be.e)(bl,bl,te),q.setAltitude(bl,Sl.z+$[ae/3]),(0,be.e)(bl,bl,ie)),G[ae]=bl[0],G[ae+1]=bl[1],G[ae+2]=bl[2];const R=Al/q.unitInMeters;(Math.abs(vl[0]-G[ae])>=R||Math.abs(vl[1]-G[ae+1])>=R||Math.abs(vl[2]-G[ae+2])>=R)&&(oe=!0),ne.offset+=3,ae+=3}oe&&(R.invalidateBoundingInfo(),J.geometryVertexAttributeUpdated(X[re],Wt.r.POSITION),X[re+1].invalidateBoundingInfo(),J.geometryVertexAttributeUpdated(X[re+1],Wt.r.POSITION)),ee+=le/se}return ee/$}(R,G,H,W,q,K)),W,he);return ue.alignedSampledElevation=J.sampledElevation,ue.needsElevationUpdates=elevationAlignmentUtils_g(W.mode),ue}},text:class Graphics3DTextSymbolLayer_D extends Graphics3DSymbolLayer_h{constructor(R,G,H,W){super(R,G,H,W),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const R=graphicUtils_I(this.symbolLayer.size);if(R)throw new Ze.A("graphics3dtextsymbollayer:invalid-size",R)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const R=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await TextRenderParameters_l.fromSymbol(this.symbolLayer,R)}destroy(){super.destroy()}createGraphics3DGraphic(R){const G=R.graphic,H=pointUtils_m(G.geometry);if(null==H)return this.logger.warn("unsupported geometry type for text symbol: ".concat(G.geometry.type)),null;const W=this.symbolLayer.text;if(null==W||""===W)return null;const q=(0,Wr.YX)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=q&&!(0,Wr.Ie)(this.symbolLayer))return this.logger.errorOncePerTick("Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '".concat(this.symbolLayer.horizontalAlignment,"' alignment)")),null;const{verticalAlignment:Q}=this.symbolLayer,J=new LabelParameters_i(q);!function placementUtils_h(R,G){switch(R){case"top":return(0,Yn.hZ)(G,0,Wl);case"bottom":return(0,Yn.hZ)(G,0,-Wl);default:return(0,Yn.C)(G,Xi.uY)}}(Q,J.screenOffset);const X=new LabelParameters_r(J,this.symbolLayer.horizontalAlignment,function placementUtils_u(R){return"middle"===R?"center":R}(Q));return this._createAs3DShape(G,H,W,X)}createLabel(R,G,H,W,q){const Q=R.graphic,J=pointUtils_m(Q.geometry);if(null==J)return this.logger.warn("unsupported geometry type for label: ".concat(Q.geometry.type)),null;const X=G.text;return!X||/^\s+$/.test(X)?null:this._createAs3DShape(Q,J,X,G,H,W,q)}setGraphicElevationContext(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return super.setGraphicElevationContext(R,G),G.addOffsetRenderUnits(H),G}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(R,G){return Graphics3DTextSymbolLayer_A(R,G,((R,G)=>{this.updateGraphicElevationContext(G,R)})),Ht.UPDATE}slicePlaneEnabledChanged(R,G){return Graphics3DTextSymbolLayer_A(R,G,(R=>{for(const G of R.stageObject.geometries)G.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}updateGraphicElevationContext(R,G){const H=G.elevationContext;this.setGraphicElevationContext(R,H,null!=G.metadata?G.metadata.elevationOffset:0),G.needsElevationUpdates=elevationAlignmentUtils_d(H.mode)||"absolute-height"===H.mode}_defaultElevationInfoNoZ(){return qu}_createAs3DShape(R,G,H,W){var q;let Q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,J=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,$=arguments.length>6&&void 0!==arguments[6]?arguments[6]:()=>W.placement.elevationOffset;const K=this.setGraphicElevationContext(R,new ElevationContext_o,W.placement.elevationOffset),ee="polyline"===(null===(q=R.geometry)||void 0===q?void 0:q.type),te=R.uid;let ie=null,re=null;if(null==J){const R=placementUtils_f(W.horizontalPlacement);ie=new TextTextureFactory_i(H,R,this._textRenderParameters);let G=null;if(null!=this._context.sharedResources.textures){re=this._context.sharedResources.textures.fromData(ie.key,(()=>ie.create())),re.texture.events.on("unloaded",(()=>{var R;return null===(R=G)||void 0===R?void 0:R.release()}));const R=this._context.stage.renderView.textureRepository.acquire(re.texture.id);if(null==R||(0,X.$X)(R))return re.release(),null;G=R}}const ne=function Graphics3DTextSymbolLayer_T(R,G){if("baseline"===G.verticalPlacement){const H=Xl[G.horizontalPlacement],W=null!=R?R.baselineAnchorY:0;return(0,Xi.fA)(H,W)}const H=function placementUtils_m(R,G){switch(G){case"bottom":return"left"===R?"bottom-left":"right"===R?"bottom-right":"bottom";case"center":return R;case"top":return"left"===R?"top-left":"right"===R?"top-right":"top"}}(G.horizontalPlacement,G.verticalPlacement);return $l[H]}(ie,W),se={occlusionTest:!0,screenOffset:W.placement.screenOffset,anchorPosition:ne,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:W.placement.centerOffsetUnits,drawInSecondSlot:!0};if(J?se.textureId=J.id:re&&(se.textureId=re.texture.id),null!=W.placement.verticalOffset){const{screenLength:R,minWorldLength:G,maxWorldLength:H}=W.placement.verticalOffset;se.verticalOffset={screenLength:(0,kr.Lz)(R),minWorldLength:G||0,maxWorldLength:null!=H?H:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:R,screenSizePerspectiveSettingsLabels:G}=this._context.sharedResources,H=FontMetrics_e(this._textRenderParameters);se.screenSizePerspective=G.overrideFontHeight(H.maxHeight),se.screenSizePerspectiveAlignment=R}ee&&(se.shaderPolygonOffset=1e-4),se.hasSlicePlane=this._context.slicePlaneEnabled;const ae=Q?((R,G)=>{const H=JSON.stringify(G);let W=R.get(H);return null==W&&(W=new HUDMaterial_Q(G),R.add(H,W)),W})(Q,se):new HUDMaterial_Q(se),oe=W.placement.translation,le=ie?(0,Xi.fA)(ie.displayWidth,ie.displayHeight):Xi.uY,ce=W.placement.centerOffset,de=GeometryUtil_ht(ae,ku,oe,null,le,ce,(0,Xi.vt)(),null),he=pointUtils_c(this._context,G,de,K,te);if(null==he)return null;const ue=new Graphics3DObject3DGraphicLayer_p(this,he.object,[de],null==Q?[ae]:null,re,((G,H,q,Q,J,X)=>{const K=$()||W.placement.elevationOffset;return ElevationAligners_p(G,this.setGraphicElevationContext(R,H,K),0,Q,J,X)}),K);ue.alignedSampledElevation=he.sampledElevation,ue.needsElevationUpdates=elevationAlignmentUtils_d(K.mode)||"absolute-height"===K.mode,ue.getScreenSize=function(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Xi.vt)();return R[0]=ie?ie.displayWidth:W.displaySize[0],R[1]=ie?ie.displayHeight:W.displaySize[1],R};const pe=new Graphics3DObjectMetadata_t(W.placement.elevationOffset,H);return ue.metadata=pe,pointUtils_p(ue,G,this._context.elevationProvider),ue}},water:Graphics3DWaterSymbolLayer_I};const rp={"mesh-3d":{fill:class Graphics3DMeshFillSymbolLayer_je extends Graphics3DSymbolLayer_h{constructor(R,G,H,W){super(R,G,H,W),this._materialInfoCache=new MeshFastUpdateProcessor_t,this._fastUpdateProcessor=new MeshFastUpdateProcessor_r,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){qr.b.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new NativeLineMaterial_V({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new NativeLineMaterial_V({color:[0,1,1,1]}))}destroy(){super.destroy(),this._textures.forEach((R=>R.unload())),this._context.stage.removeMany(this._materialInfoCache.materials),this._context.stage.removeMany(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy(this._context.stage)}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(R){const G=R.graphic;if(!this._validateGeometry(G.geometry,Ld,"fill on mesh-3d"))return null;const H=this.setGraphicElevationContext(G),W=R.renderingInfo;return this._createAs3DShape(G,W,H,G.uid)}onRemoveGraphic(R){this._fastUpdateProcessor.onRemoveGraphic(R,this._materialInfoCache,this._context)}layerOpacityChanged(R,G){const H=this._getLayerOpacity();this._updateMaterialParameters((R=>{R.material.setParameters({layerOpacity:H});const G=R.material.parameters;this._setMaterialTransparentParameter(G,R),R.material.setParameters({transparent:G.transparent})})),R.forEach((R=>{var W;return null===(W=G(R))||void 0===W?void 0:W.layerOpacityChanged(H,this._context.isAsync)}))}layerElevationInfoChanged(R,G){return this.updateGraphics3DGraphicElevationInfo(R,G,elevationAlignmentUtils_g)}slicePlaneEnabledChanged(R,G){return this._updateMaterialParameters((R=>{let{material:G}=R;G.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})})),R.forEach((R=>{var H;return null===(H=G(R))||void 0===H?void 0:H.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const R=this._usePBR();return this._updateMaterialParameters((G=>{let{material:H}=G;return H.setParameters({usePBR:R})})),!0}updateTransform(R,G,H,W){var q;const Q=R.fastTransformUpdatesEnabled;switch(W){case Yc.EnableFastUpdates:if(Q)return!0;break;case Yc.DisableFastUpdates:if(!Q)return!0;break;default:if(!Q)return!1}const J=this._context.renderCoordsHelper.spatialReference,X=Hd,{origin:$,transform:K}=H;if(!(0,Bt.l)(G,(0,be.s)(Nd,$.x,$.y,null!==(q=$.z)&&void 0!==q?q:0),X,J))return!1;switch(W){case Yc.EnableFastUpdates:this._fastUpdateProcessor.enable(R,this._materialInfoCache,this._context);break;case Yc.DisableFastUpdates:this._fastUpdateProcessor.disable(R,this._materialInfoCache,this._context);break;case Yc.UpdateFastLocalOrigin:R.updateFastLocalOrigin(X,K,this._context.localOriginFactory)}const{elevationContext:ee}=R;ee.centerPointInElevationSR=this._getCenterPointInElevationSR(X);const{elevationProvider:te,renderCoordsHelper:ie}=this._context;return R.alignedSampledElevation=ElevationAligners_p(R,ee,te.spatialReference,((R,G)=>elevationAlignmentUtils_c(R,te,ee,ie,G)),ie,X),R.updateTransform(X,K,this._context.isAsync),!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(R){return null==R?"-":R instanceof oe.A?R.toHex():R.contentHash}_materialPropertiesDefault(R,G){const H=this._requiresSymbolVertexColors(),W=!!R.vertexAttributes.color,q=!!R.vertexAttributes.tangent;return{hasSymbolVertexColors:H,hasVertexColors:W,hasVertexTangents:q,uid:"vc:".concat(W,",vt:").concat(q,",vct").concat(G,",svc:").concat(H)}}_textureTransformUid(R){const{offset:G,scale:H,rotation:W}=null!==R&&void 0!==R?R:kd;return"".concat(G[0],",").concat(G[1],",").concat(W,",").concat(H[0],",").concat(H[1])}_materialProperties(R,G,H){const W=this._materialPropertiesDefault(R,H);if(!G.material)return W;const{color:q,colorTexture:Q,colorTextureTransform:J,normalTexture:X,normalTextureTransform:$,doubleSided:K,alphaCutoff:ee,alphaMode:te}=G.material,ie=this._colorOrTextureUid(q),re=this._colorOrTextureUid(Q),ne=this._textureTransformUid(J),se=this._colorOrTextureUid(X),ae=this._textureTransformUid($);if(W.color=q,W.colorTexture=Q,W.normalTexture=X,W.uid="".concat(W.uid,",cmuid:").concat(ie,",ctmuid:").concat(re,",cttuid:").concat(ne,",ntmuid:").concat(se,",nttuid:").concat(ae,",ds:").concat(K,",ac:").concat(ee,",am:").concat(te),G.material instanceof Xc.A){const{metallic:R,roughness:H,metallicRoughnessTexture:q,metallicRoughnessTextureTransform:Q,emissiveColor:X,emissiveTexture:K,emissiveTextureTransform:ee,occlusionTexture:te,occlusionTextureTransform:ie}=G.material,re=this._colorOrTextureUid(q),ne=this._textureTransformUid(Q),se=this._colorOrTextureUid(X),ae=this._colorOrTextureUid(K),oe=this._textureTransformUid(ee),le=this._colorOrTextureUid(te),ce=this._textureTransformUid(ie);W.metallic=R,W.roughness=H,W.metallicRoughnessTexture=q,W.emissiveColor=X,W.emissiveTexture=K,W.occlusionTexture=te,W.colorTextureTransform=this._convertTextureTransform(J),W.normalTextureTransform=this._convertTextureTransform($),W.emissiveTextureTransform=this._convertTextureTransform(ee),W.occlusionTextureTransform=this._convertTextureTransform(ie),W.metallicRoughnessTextureTransform=this._convertTextureTransform(Q),W.uid="".concat(W.uid,",mrm:").concat(R,",mrr:").concat(H,",mrt:").concat(re,",mrtt:").concat(ne,",emuid:").concat(se,",etmuid:").concat(ae,",ett:").concat(oe,",otmuid:").concat(le,",ott:").concat(ce)}return W}_convertTextureTransform(R){if(!R)return null;const{scale:G,offset:H,rotation:W}=R;return{scale:G,offset:H,rotation:(0,Ee.kU)(W)}}_setInternalColorValueParameters(R,G){G.diffuse=oe.A.toUnitRGB(R),G.opacity=R.a}_getLoadableTextureResource(R){var G;return null!==(G=R.data)&&void 0!==G?G:R.url}_getInternalTextureId(R){const G=this._getInternalTexture(R,et.sf.Opaque);return null===G||void 0===G?void 0:G.id}_getInternalTexture(R,G){const H=this._getLoadableTextureResource(R);if(!H)return null;const W="".concat(R.contentHash,"/").concat(G);let q=this._textures.get(W);if(!q){let Q=null;const J=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,X={wrap:this._castTextureWrap(R.wrap),noUnpackFlip:!0,maxAnisotropy:J,mipmap:J>1};(0,Ke.x3)(H)?(Q=H.data,X.preMultiplyAlpha=!1,X.encoding=H.encoding):(Q=H,X.preMultiplyAlpha=G!==et.sf.Opaque,X.downsampleUncompressed=this._context.graphicsCoreOwner.view.qualitySettings.graphics3D.uncompressedTextureDownsamplingEnabled),q=new Lt.g(Q,X),this._textures.set(W,q),q.load(this._context.stage.renderView.renderingContext),this._context.stage.add(q)}return q}_castTextureWrap(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"repeat";if("string"==typeof R){const G=this._castTextureWrapIndividual(R);return{s:G,t:G}}return{s:this._castTextureWrapIndividual(R.horizontal),t:this._castTextureWrapIndividual(R.vertical)}}_castTextureWrapIndividual(R){switch(R){case"clamp":return Ft.pF.CLAMP_TO_EDGE;case"mirror":return Ft.pF.MIRRORED_REPEAT;default:return Ft.pF.REPEAT}}_setInternalMaterialParameters(R,G){var H,W;if(null!=R.color&&this._setInternalColorValueParameters(R.color,G),null!=R.colorTexture){const H=this._getInternalTexture(R.colorTexture,G.textureAlphaMode);H?(G.textureId=H.id,G.textureAlphaPremultiplied=!!H.parameters.preMultiplyAlpha):G.textureId=void 0}R.normalTexture&&(G.normalTextureId=this._getInternalTextureId(R.normalTexture)),R.emissiveColor&&(G.emissiveFactor=oe.A.toUnitRGB(R.emissiveColor)),R.emissiveTexture&&(G.emissiveTextureId=this._getInternalTextureId(R.emissiveTexture)),R.occlusionTexture&&(G.occlusionTextureId=this._getInternalTextureId(R.occlusionTexture)),R.metallicRoughnessTexture&&(G.metallicRoughnessTextureId=this._getInternalTextureId(R.metallicRoughnessTexture)),G.colorTextureTransformMatrix=(0,td.G)(R.colorTextureTransform),G.normalTextureTransformMatrix=(0,td.G)(R.normalTextureTransform);const q=null!=(null===(H=R.normalTextureTransform)||void 0===H?void 0:H.scale)?null===(W=R.normalTextureTransform)||void 0===W?void 0:W.scale:Xi.Un;G.scale=[q[0],q[1]],G.occlusionTextureTransformMatrix=(0,td.G)(R.occlusionTextureTransform),G.emissiveTextureTransformMatrix=(0,td.G)(R.emissiveTextureTransform),G.metallicRoughnessTextureTransformMatrix=(0,td.G)(R.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(R){var G,H;const W=this._drivenProperties.color;let q=null!==(G=null===(H=this.symbolLayer.material)||void 0===H?void 0:H.colorMixMode)&&void 0!==G?G:null;if(W)R.externalColor=Ce.Un;else{var Q,J;const G=null!==(Q=null===(J=this.symbolLayer.material)||void 0===J?void 0:J.color)&&void 0!==Q?Q:null;G?R.externalColor=oe.A.toUnitRGBA(G):(q=null,R.externalColor=Ce.Un)}q&&(R.colorMixMode=q),R.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(R){const G=R.vertexAttributes.color;if(null==G)return!1;for(let H=3;H<G.length;H+=4)if(255!==G[H])return!0;return!1}_getOrCreateMaterial(R,G){var H,W,q;const Q=null===(H=G.material)||void 0===H?void 0:H.color,J=null===(W=G.material)||void 0===W?void 0:W.colorTexture,X=null===(q=G.material)||void 0===q?void 0:q.alphaMode,$="blend"===X,K=!("opaque"===X)&&(this._hasTransparentVertexColors(R)||null!=Q&&Q.a<1||(null===J||void 0===J?void 0:J.transparent)||$),ee=this._materialProperties(R,G,K),te=this._materialInfoCache.byUid(ee.uid);if(te)return te.material;const ie={uid:ee.uid,material:null,isComponentTransparent:K,alphaMode:G.material?G.material.alphaMode:"opaque"},re=(0,it.Jr)({normalTexture:ee.normalTexture,metallicRoughnessTexture:ee.metallicRoughnessTexture,metallicFactor:ee.metallic,roughnessFactor:ee.roughness,emissiveTexture:ee.emissiveTexture,emissiveFactor:oe.A.toUnitRGB(ee.emissiveColor),occlusionTexture:ee.occlusionTexture}),ne={usePBR:this._usePBR(),isSchematic:re,hasVertexColors:ee.hasVertexColors,hasSymbolColors:ee.hasSymbolVertexColors,hasVertexTangents:ee.hasVertexTangents,ambient:xe.uY,diffuse:xe.Un,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:et.s2.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};ne.mrrFactors=re?[...it.mX]:[ee.metallic,ee.roughness,it.Rk[2]],G.material&&(ne.doubleSided=G.material.doubleSided,ne.cullFace=G.material.doubleSided?et.s2.None:et.s2.Back,ne.textureAlphaCutoff=G.material.alphaCutoff),this._setExternalMaterialParameters(ne),this._setMaterialTransparentParameter(ne,ie),this._setInternalMaterialParameters(ee,ne);const se=new Mr.$U(ne);return ie.material=se,this._materialInfoCache.set(ee.uid,ie),this._context.stage.add(se),se}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(R,G){R.transparent=this.needsDrivenTransparentPass||G.isComponentTransparent||R.layerOpacity<1||R.opacity<1||R.externalColor&&R.externalColor[3]<1,"auto"===G.alphaMode?R.textureAlphaMode=R.transparent?et.sf.MaskBlend:et.sf.Opaque:R.textureAlphaMode="opaque"===G.alphaMode?et.sf.Opaque:"mask"===G.alphaMode?et.sf.Mask:et.sf.Blend}_addDebugNormals(R,G){const H=G.length,W=R.spatialReference.isGeographic?20015077/180:1,q=.1*Math.max(R.extent.width*W,R.extent.height*W,R.extent.zmax-R.extent.zmin),Q=[],J=[],X=[],$=[];for(let ie=0;ie<H;ie++){const R=G[ie],H=R.attributes.get(Wt.r.POSITION),W=R.attributes.get(Wt.r.NORMAL),K=H.data,ee=H.indices,te=W.data,re=W.indices;for(let G=0;G<ee.length;G++){const R=3*ee[G],H=3*re[G];for(let G=0;G<3;G++)Q.push(K[R+G]);for(let G=0;G<3;G++)Q.push(K[R+G]+te[H+G]*q);if(J.push(J.length),J.push(J.length),G%3==0){this._calculateFaceNormal(K,ee,G,Gd),this._getFaceVertices(K,ee,G,Nd,Vd,Ud),(0,be.g)(Nd,Nd,Vd),(0,be.g)(Nd,Nd,Ud),(0,be.h)(Nd,Nd,1/3);for(let R=0;R<3;R++)X.push(Nd[R]);for(let R=0;R<3;R++)X.push(Nd[R]+Gd[R]*q);$.push($.length),$.push($.length)}}}const K=G[0].transformation,ee=new rr.V(this._debugVertexNormalMaterial,[[Wt.r.POSITION,new tr.n(Q,J,3,!0)]],null,ir.X.Line);G.push(ee),ee.transformation=K;const te=new rr.V(this._debugFaceNormalMaterial,[[Wt.r.POSITION,new tr.n(X,$,3,!0)]],null,ir.X.Line);te.transformation=K,G.push(te)}_createAs3DShape(R,G,H,W){const q=R.geometry;if("mesh"!==q.type)return null;const Q=this._createGeometryInfo(q,G,W);if(null==Q)return null;const{geometries:J,objectTransformation:X}=Q;qr.b.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(q,J);const $=new Object3D_O({geometries:J,layerUid:this._context.layer.uid,graphicUid:W,isElevationSource:!0});$.transformation=X;const K=(0,Pr.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),ee=K?new Graphics3DObject3DGraphicLayer_m(J[0].material,[K],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,te=new Graphics3DMeshObject3DGraphicLayer_c(this,$,J,null,null,ElevationAligners_p,H,ee);this._fastUpdateProcessor.onAddGraphic(),te.needsElevationUpdates=elevationAlignmentUtils_g(H.mode),te.useObjectOriginAsAttachmentOrigin=!0,H.centerPointInElevationSR=this._getCenterPointInElevationSR($.transformation);const{elevationProvider:ie,renderCoordsHelper:re}=this._context;return te.alignedSampledElevation=ElevationAligners_p(te,H,ie.spatialReference,((R,G)=>elevationAlignmentUtils_c(R,ie,H,re,G)),re),te}_getCenterPointInElevationSR(R){const G=(0,We.T)(0,0,0,null!=this._context.elevationProvider.spatialReference?this._context.elevationProvider.spatialReference:null);return projectVectorToPoint_t([R[12],R[13],R[14]],this._context.renderCoordsHelper.spatialReference,G),G}_createComponentNormals(R,G,H,W){switch(H.shading||"flat"){default:case"source":return this._createComponentNormalsSource(R,G,H,W);case"flat":return this._createComponentNormalsFlat(R,W);case"smooth":return this._createComponentNormalsSmooth(R,W)}}_createComponentNormalsSource(R,G,H,W){if(null==G)return this._createComponentNormalsFlat(R,W);let q=!1;if(!H.trustSourceNormals)for(let Q=0;Q<W.length;Q+=3){this._calculateFaceNormal(R,W,Q,Gd);for(let R=0;R<3;R++){const H=3*W[Q+R];Nd[0]=G[H],Nd[1]=G[H+1],Nd[2]=G[H+2],(0,be.k)(Gd,Nd)<0&&(G[H]=-G[H],G[H+1]=-G[H+1],G[H+2]=-G[H+2],q=!0)}}return new Graphics3DMeshFillSymbolLayer_Re(G,W,q)}_createComponentNormalsFlat(R,G){const H=(0,Ve.oe)(G.length),W=new Array(3*G.length);for(let q=0;q<G.length;q+=3){const Q=this._calculateFaceNormal(R,G,q,Gd);for(let R=0;R<3;R++)H[q+R]=Q[R],W[q+R]=q/3}return new Graphics3DMeshFillSymbolLayer_Re(H,W,!1)}_createComponentNormalsSmooth(R,G){const H={};for(let Q=0;Q<G.length;Q+=3){const W=this._calculateFaceNormal(R,G,Q,Gd);for(let R=0;R<3;R++){const q=G[Q+R];let J=H[q];J||(J={normal:(0,xe.vt)(),count:0},H[q]=J),(0,be.g)(J.normal,J.normal,W),J.count++}}const W=(0,Ve.oe)(3*G.length),q=new Array(3*G.length);for(let Q=0;Q<G.length;Q++){const R=H[G[Q]];1!==R.count&&((0,be.n)(R.normal,R.normal),R.count=1);for(let G=0;G<3;G++)W[3*Q+G]=R.normal[G];q[Q]=Q}return new Graphics3DMeshFillSymbolLayer_Re(W,q,!1)}_getFaceVertices(R,G,H,W,q,Q){const J=3*G[H],X=3*G[H+1],$=3*G[H+2];W[0]=R[J],W[1]=R[J+1],W[2]=R[J+2],q[0]=R[X],q[1]=R[X+1],q[2]=R[X+2],Q[0]=R[$],Q[1]=R[$+1],Q[2]=R[$+2]}_calculateFaceNormal(R,G,H,W){return this._getFaceVertices(R,G,H,Nd,Vd,Ud),(0,be.f)(Vd,Vd,Nd),(0,be.f)(Ud,Ud,Nd),(0,be.b)(Nd,Vd,Ud),(0,be.n)(W,Nd),W}_getOrCreateComponents(R){var G;return null!==(G=R.components)&&void 0!==G?G:Wd}_createPositionBuffer(R,G){let H=R.vertexAttributes.position;const W=G.reprojection===qd.RENDER?G.transformBeforeProject:null;if(W&&(H=(0,xs.a)(new Float64Array(H.length),H,W)),G.reprojection===qd.NONE)return G.needsBufferCopy?new Float64Array(H):H;const q=W?H:new Float64Array(H.length);return(0,Ie.projectBuffer)(H,R.spatialReference,0,q,this._context.renderCoordsHelper.spatialReference,0,H.length/3),q}_createNormalBuffer(R,G,H){let W=R.vertexAttributes.normal;if(null==W)return null;const q=H.reprojection===qd.RENDER?H.transformBeforeProject:null;if(q&&(W=(0,ed.qs)(W,new Float32Array(W.length),q)),"local"===this._context.graphicsCoreOwner.view.viewingMode||H.reprojection===qd.NONE)return H.needsBufferCopy&&R.vertexAttributes.normal===W?new Float32Array(W):W;const Q=R.vertexAttributes.position,J=q?W:new Float32Array(W.length);return(0,ed.X4)(W,Q,G,R.spatialReference,J)}_createTangentBuffer(R,G,H){let W=R.vertexAttributes.tangent;if(null==W)return null;const q=H.reprojection===qd.RENDER?H.transformBeforeProject:null;if(q&&(W=(0,ed.KM)(W,new Float32Array(W.length),q)),"local"===this._context.graphicsCoreOwner.view.viewingMode||H.reprojection===qd.NONE)return H.needsBufferCopy&&R.vertexAttributes.normal===W?new Float32Array(W):W;const Q=R.vertexAttributes.position,J=q?W:new Float32Array(W.length);return(0,ed.xA)(W,Q,G,R.spatialReference,J)}_createColorBuffer(R){return R.vertexAttributes.color}_createSymbolColorBuffer(R){if(this._requiresSymbolVertexColors()){var G;const H=this._getVertexOpacityAndColor(R),W=(0,dd.Eb)(null===(G=this.symbolLayer)||void 0===G||null===(G=G.material)||void 0===G?void 0:G.colorMixMode),q=new Uint8Array(4);return(0,dd._j)(H,W,q),q}return null}_createBuffers(R,G){const H=R.vertexAttributes&&R.vertexAttributes.position;if(!H)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const W=R.vertexAttributes.normal,q=R.vertexAttributes.uv,Q=R.vertexAttributes.tangent;if(W&&W.length!==H.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(Q&&Q.length/4!=H.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(q&&q.length/2!=H.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const J=this._computeReprojectionInfo(R),X=this._createPositionBuffer(R,J),$=this._createColorBuffer(R),K=this._createSymbolColorBuffer(G),ee=this._createNormalBuffer(R,X,J),te=this._createTangentBuffer(R,X,J);return{positionBuffer:X,normalBuffer:ee,tangentBuffer:te,uvBuffer:q,colorBuffer:$,symbolColorBuffer:K,objectTransformation:J.reprojection===qd.NONE&&J.objectTransformation?J.objectTransformation:this._transformOriginLocal(R,X,ee,te),geometryTransformation:J.reprojection===qd.NONE&&J.geometryTransformation?J.geometryTransformation:(0,ve.vt)()}}_computeReprojectionInfo(R){const{vertexSpace:G}=R,H="georeferenced"===G.type?(0,Te.aI)(this._context.renderCoordsHelper.spatialReference,R.spatialReference)?qd.NONE:qd.RENDER:qd.NONE;if((0,Xe.Hq)(G)){var W,q;const Q=G.origin,J=(0,ve.vt)(),X=null!==(W=null===(q=R.transform)||void 0===q?void 0:q.localMatrix)&&void 0!==W?W:ve.zK;if(H===qd.NONE)return(0,Bt.l)(R.spatialReference,Q,J,this._context.renderCoordsHelper.spatialReference),{reprojection:H,objectTransformation:J,geometryTransformation:(0,ve.o8)(X),needsBufferCopy:!1};const $=(0,ye.kN)((0,ve.vt)(),Q);return(0,ye.lw)($,$,X),{reprojection:H,transformBeforeProject:$,needsBufferCopy:!0}}return{reprojection:H,needsBufferCopy:!0}}_transformOriginLocal(R,G,H,W){var q;const Q=this._context.renderCoordsHelper.spatialReference,J=R.anchor;Fd[0]=J.x,Fd[1]=J.y,Fd[2]=null!==(q=J.z)&&void 0!==q?q:0;const X=(0,ve.vt)();return(0,Bt.l)(R.spatialReference,Fd,X,Q),(0,ye.B8)(zd,X),(0,xs.a)(G,G,zd),(H||W)&&((0,ge.z0)(Bd,X),(0,ge.mg)(Bd,Bd),H&&(0,xs.b)(H,H,Bd),W&&(0,xs.b)(W,W,Bd,4)),X}_validateFaces(R,G){const H=R.vertexAttributes.position.length/3,W=G.faces;if(W){let R=-1;for(let G=0;G<W.length;G++){const H=W[G];H>R&&(R=H)}if(H<=R)return this.logger.warn("Vertex index ".concat(R," is out of bounds of the mesh position buffer")),!1}else if(H%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(R,G){var H;return null!==(H=G.faces)&&void 0!==H?H:(0,Ue.tM)(R.vertexAttributes.position.length/3)}_isOutsideClippingArea(R){var G;if(!this._context.clippingExtent)return!1;const H=null===(G=R.vertexAttributes)||void 0===G?void 0:G.position;if(!H)return!1;const W=this._context.elevationProvider.spatialReference,q=(0,Kc.project)({positions:H,transform:R.transform,vertexSpace:R.vertexSpace,inSpatialReference:R.spatialReference,outSpatialReference:null!==W&&void 0!==W?W:R.spatialReference,localMode:this._context.stage.viewingMode===qe.RT.Local}),Q=q.length/3;return(0,Le.Ie)(jd),(0,Le.Hq)(jd,q,0,Q),!(0,Le.KG)(jd,this._context.clippingExtent)}_createGeometryInfo(R,G,H){if(!(0,Ei.canProjectWithoutEngine)(R.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(!this._validateVertexSpace(R))return null;if(this._isOutsideClippingArea(R))return null;const W=this._createBuffers(R,G);if(null==W)return null;const{positionBuffer:q,uvBuffer:Q,colorBuffer:J,symbolColorBuffer:X,normalBuffer:$,tangentBuffer:K,objectTransformation:ee,geometryTransformation:te}=W,ie=this._getOrCreateComponents(R),re=new Array;let ne=!1;const se=(0,ye.sC)(Nd,ee),ae=this._context.localOriginFactory.getOrigin(se);for(const oe of ie){if(!this._validateFaces(R,oe))return null;const G=this._getOrCreateFaces(R,oe);if(0===G.length)continue;const W=this._createComponentNormals(q,$,oe,G);W.didFlipNormals&&(ne=!0);const ee=[[Wt.r.POSITION,new tr.n(q,G,3,!0)],[Wt.r.NORMAL,new tr.n(W.normals,W.indices,3,!0)]];J&&ee.push([Wt.r.COLOR,new tr.n(J,G,4,!0)]),X&&ee.push([Wt.r.SYMBOLCOLOR,new tr.n(X,(0,Ue.EH)(G.length),4,!0)]),Q&&ee.push([Wt.r.UV0,new tr.n(Q,G,2,!0)]),K&&ee.push([Wt.r.TANGENT,new tr.n(K,G,4,!0)]);const ie=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:H,layerUid:this._context.layer.uid}),se=this._getOrCreateMaterial(R,oe),le=new rr.V(se,ee,null,ir.X.Mesh,ie);le.transformation=te,le.localOrigin=ae,re.push(le)}return ne&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:re,objectTransformation:ee}}_updateMaterialParameters(R){this._materialInfoCache.forEachMaterialInfo(R),this._fastUpdateProcessor.forEachMaterialInfo(R),this._fastUpdateProcessor.forEachClonedMaterial(((R,G)=>{G.setParameters(R.parameters)}))}_validateVertexSpace(R){const{_context:{graphicsCoreOwner:{view:{state:{viewingMode:G}}}}}=this,{vertexSpace:H}=R;return G!==qe.RT.Local||"local"!==H.type||(this.logger.warn("Displaying a mesh with a local vertex space in a view in local viewing mode is not supported."),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}}}};class Graphics3DSymbol_m extends Loadable_r{set symbol(R){this._symbol=R,R.symbolLayers.forEach(((G,H)=>{const W=this.symbolLayers[H];null!=W&&(W.symbol=R,W.symbolLayer=G)}))}get symbol(){return this._symbol}constructor(R,G,H){super(G.schedule),this._symbol=R,this._context=G,this._backgroundLayers=H,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(R){let G=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(G=this._backgroundLayers.concat(G));const H=G.length;for(;this.symbolLayers.length<G.length;)this.symbolLayers.push(null);this.symbolLayers.length=G.length;const W=[];for(let q=0;q<H;q++){const Q=G.at(q);if(!1===Q.enabled)continue;np.renderPriority=1-(1+q)/H,np.renderPriorityStep=1/H,np.ignoreDrivers=Q.ignoreDrivers;const J=Graphics3DSymbolLayerFactory_c(this.symbol,Q,this._context,np),$=(0,X.NY)(R,(()=>{this.symbolLayers[q]=null,J.destroy()}));$&&W.push($),this.symbolLayers[q]=J}if(await(0,Rt.jJ)(this.symbolLayers,(async(R,G)=>{if(null!=R)try{await R.load(),this._extentPadding+=Math.max(this._extentPadding,R.extentPadding)}catch{this.symbolLayers[G]=null}})),W.forEach((R=>R.remove())),(0,X.Te)(R),this.symbolLayers.length&&!this.symbolLayers.some((R=>!!R)))throw new Error}getSymbolLayerSize(R){const G=this.symbolLayers[R];return null!=G?G.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((R=>null===R||void 0===R?void 0:R.queryForSnapping))}createGraphics3DGraphic(R,G){var H;const W=R.graphic,q=this.symbolLayers.map((G=>{var H;return null!==(H=null===G||void 0===G?void 0:G.createGraphics3DGraphic(R))&&void 0!==H?H:null})),Q=this._context.arcade||(null===(H=this._context.featureExpressionInfoContext)||void 0===H||null===(H=H.arcade)||void 0===H?void 0:H.modules)||null;return new Graphics3DGraphic_A(W,G||this,q,R.layer,Q)}get complexity(){return defaultSymbolComplexity_F(this.symbolLayers.map((R=>null!=R?R.complexity:null)))}globalPropertyChanged(R,G){const H=this.symbolLayers.length;for(let W=0;W<H;W++){const H=this.symbolLayers[W],o=R=>{const G=R.layers[W];return G instanceof Graphics3DObject3DGraphicLayer_p?G:null};if(null!=H&&!H.globalPropertyChanged(R,G,o))return!1}return!0}applyRendererDiff(R,G){return this.loadStatus!==dn.LOADED?cn.RecreateSymbol:this.symbolLayers.reduce(((H,W)=>H!==cn.RecreateSymbol&&null!=W?Math.min(H,W.applyRendererDiff(R,G)):H),cn.FastUpdate)}prepareSymbolPatch(R){if(this.loadStatus===dn.FAILED)return;if("partial"!==R.diff.type)return;const G=R.diff.diff;if(!G.symbolLayers||"partial"!==G.symbolLayers.type)return;const H=G.symbolLayers.diff;this.symbolLayers.forEach(((G,W)=>{if(null==G)return;const q=H[W];if(q){const H={diff:q,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};G.prepareSymbolLayerPatch(H),R.symbolStatePatches.push(...H.symbolLayerStatePatches),H.graphics3DGraphicPatches.length&&R.graphics3DGraphicPatches.push(((R,G)=>{const q=R.layers[W];null!=q&&H.graphics3DGraphicPatches.forEach((R=>R(q,G)))}))}}))}updateGeometry(R,G){return this._updateGeometryOrTransform(R,((R,H)=>R.updateGeometry(H,G)))}updateTransform(R,G,H,W){return this._updateGeometryOrTransform(R,((R,q)=>R.updateTransform(q,G,H,W)))}_updateGeometryOrTransform(R,G){for(let H=0;H<this.symbolLayers.length;H++){const W=this.symbolLayers[H];if(null==W)continue;const q=R.layers[H];if(!q||!G(W,q))return!1}return!0}onRemoveGraphic(R){for(let G=0;G<this.symbolLayers.length;G++){const H=this.symbolLayers[G];if(null==H)continue;const W=R.layers[G];null!=W&&H.onRemoveGraphic(W)}}getFastUpdateStatus(){let R=0,G=0,H=0;return this.symbolLayers.forEach((W=>{null!=W&&(W.loadStatus===dn.LOADING?R++:W.isFastUpdatesEnabled()?H++:G++)})),{loading:R,slow:G,fast:H}}async queryForSnapping(R,G,H,W){const q=this.symbolLayers.filter(ce.Ru).filter((R=>null!=R.queryForSnapping)).map((q=>q.queryForSnapping(R,G,H,W))),Q=await Promise.all(q);return(0,X.Te)(W),Q.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const R of this.symbolLayers)null!=R&&R.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const np=new class Graphics3DSymbolCreationContext_s{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};class Graphics3DPointSymbol_s extends Graphics3DSymbol_m{constructor(R,G,H){super(R,G,H),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=Graphics3DCalloutSymbolLayerFactory_e(this.symbol,G))}async doLoad(R){const G=this._calloutSymbolLayer?(0,Rt.Ke)(this._calloutSymbolLayer.load()):null;try{await super.doLoad(R),(0,X.Te)(R)}catch(W){var H;throw null!==(H=this._calloutSymbolLayer)&&void 0!==H&&H.abortLoad(),W}G&&await G}destroy(){super.destroy(),this._calloutSymbolLayer=(0,Qe.pR)(this._calloutSymbolLayer)}createGraphics3DGraphic(R,G){const H=super.createGraphics3DGraphic(R,G);if(null!=this._calloutSymbolLayer&&null!=H){const G=this._createCalloutGraphic(R);G&&H.setCalloutGraphic(G)}return H}globalPropertyChanged(R,G){return!!super.globalPropertyChanged(R,G)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(R,G,(R=>R.calloutLayer)))}updateGeometry(R,G){const H=super.updateGeometry(R,G);if(H&&this._calloutSymbolLayer){const H=R.calloutLayer;if(H)return this._calloutSymbolLayer.updateGeometry(H,G)}return H}_createCalloutGraphic(R){const G=R.renderingInfo;return R.renderingInfo=new Graphics3DLineCalloutSymbolLayer_w(G.renderer,G.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(R)}}class Graphics3DWebStyleSymbol_i extends Loadable_r{constructor(R,G,H){super(G),this.symbol=R,this._convert=H,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(R){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getSymbolLayerSize(R):null}get symbolLayers(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.extentPadding:0}async doLoad(R){const G=await this.symbol.fetchSymbol({signal:R});G.id=this.symbol.id,this.graphics3DSymbol=this._convert(G),null!=this.graphics3DSymbol&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(R){return null!=this.graphics3DSymbol?this.graphics3DSymbol.createGraphics3DGraphic(R,this):null}get complexity(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.complexity:Ir}globalPropertyChanged(R,G){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.globalPropertyChanged(R,G)}applyRendererDiff(R,G){return null!=this.graphics3DSymbol?this.graphics3DSymbol.applyRendererDiff(R,G):cn.RecreateSymbol}prepareSymbolPatch(R){null!=this.graphics3DSymbol&&this.graphics3DSymbol.prepareSymbolPatch(R)}updateGeometry(R,G){return null!=this.graphics3DSymbol&&this.graphics3DSymbol.updateGeometry(R,G)}updateTransform(R,G,H,W){var q,Q;return null!==(q=null===(Q=this.graphics3DSymbol)||void 0===Q?void 0:Q.updateTransform(R,G,H,W))&&void 0!==q&&q}onRemoveGraphic(){}getFastUpdateStatus(){return null!=this.graphics3DSymbol?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){null!=this.graphics3DSymbol&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}class GraphicsCorePerformanceInfo_s{constructor(R,G,H){this.visible=R,this.missing=G,this.pending=H}}class GraphicStateTracking_e{constructor(R){var G;this._graphicsCore=R,this._idToState=new Map,this._states=new Set;const H=null===(G=R.owner.layer)||void 0===G?void 0:G.objectIdField;H?(this._getGraphicId=R=>(0,Mi.RW)(R,H),this._getGraphics3DGraphicById=R=>this._graphicsCore.getGraphics3DGraphicByObjectId(R)):(this._getGraphicId=R=>R.uid,this._getGraphics3DGraphicById=R=>this._graphicsCore.getGraphics3DGraphicById(R))}destroy(){this._idToState.clear(),this._states.forEach(((R,G)=>this.remove(G)))}add(R){const G=(0,ue.hA)((()=>this.remove(R)));if(this._states.has(R))return G;const H=this._getGraphicId(R.graphic),W=this._getGraphics3DGraphicById(H);return this._states.has(R)||this._states.add(R),this._ensureStateList(H).push(R),R.displaying=null!=W&&W.isVisible(),R.isDraped=null!=W&&W.isDraped,R.tracking=!0,null!=W&&R.emit("changed"),G}remove(R){if(this._states.has(R)){if(this._idToState.size){const G=this._getGraphicId(R.graphic),H=this._idToState.get(G);H&&((0,ce.TF)(H,R),0===H.length&&this._idToState.delete(G))}this._states.delete(R),R.tracking=!1,R.displaying=!1}}addGraphic(R){this._forEachState(R,(G=>{G.displaying=R.isVisible(),G.isDraped=R.isDraped,G.emit("changed")}))}removeGraphic(R){this._forEachState(R,(R=>{R.displaying=!1,R.isDraped=!1}))}updateGraphicGeometry(R){this._forEachState(R,(R=>R.emit("changed")))}updateGraphicVisibility(R){this._forEachState(R,(G=>G.displaying=R.isVisible()))}allGraphicsDeleted(){this._states.forEach((R=>R.displaying=!1))}_ensureStateList(R){const G=this._idToState.get(R);if(G)return G;const H=new Array;return this._idToState.set(R,H),H}_forEachState(R,G){if(0===this._states.size||0===this._idToState.size)return;const H=this._getGraphicId(R.graphic),W=this._idToState.get(H);null!=W&&W.forEach(G)}}var sp=H(30925);let ap=class extends Q.A{constructor(R){super(R),this._index=new sp.w(9,(0,te.A)("esri-csp-restrictions")?R=>({minX:R.extent[0],minY:R.extent[1],maxX:R.extent[2],maxY:R.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(R){this._addMany(R)}destroy(){this._missing.clear(),this._index=(0,Qe.pR)(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(R,G,H){null!=G&&G.equals(this.spatialReference)&&(op.minX=R[0],op.minY=R[1],op.maxX=R[2],op.maxY=R[3],this.update(),this._index.search(op,(R=>H(R.graphic.uid))))}add(R){this._missing.add(R),this.updating=!0}remove(R){if(this._missing.delete(R))return void(this.updating=this._missing.size>0);this._index.remove(R);const G=(0,Mi.RW)(R.graphic,this._get("objectIdField"));null!=G&&this._boundsByFeature.delete(G)}_addMany(R){if(0===R.length)return;const G=this._get("objectIdField");for(const H of R){H.computeExtent(this.spatialReference);const R=(0,Mi.RW)(H.graphic,G);null!=R&&this._boundsByFeature.set(R,H.extent)}this._index.load(R)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(R,G){op.minX=R[0],op.minY=R[1],op.maxX=R[2],op.maxY=R[3],this.update(),this._index.search(op,(R=>{G(R)}))}getBounds(R,G){this.update();const H=this._boundsByFeature.get(R);return H?(0,Le.Jt)(G,H):null}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],ap.prototype,"spatialReference",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],ap.prototype,"hasZ",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],ap.prototype,"hasM",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],ap.prototype,"objectIdField",void 0),(0,W._)([(0,ee.MZ)()],ap.prototype,"updating",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],ap.prototype,"updatingRemaining",null),ap=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.SpatialIndex2D")],ap);const op={minX:0,minY:0,maxX:0,maxY:0};class ElevationUpdateEvent_e{constructor(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"scene";this.context=R,this.extent=(0,Fe.Ie)()}}const lp=Symbol("layerHandles");let cp=class extends(Vr.A.EventedMixin(Q.A)){get spatialReference(){var R;return null===(R=this.view)||void 0===R?void 0:R.spatialReference}constructor(R){super(R),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=Intersector_T(this.view.state.viewingMode),this._intersector.options.store=So.MIN;const R=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=R[2],this._zmax=R[5];const G=this.stageLayer.events;this.addHandles([G.on(["layerObjectAdded","layerObjectRemoved","geometryAdded","geometryRemoved"],(R=>{let{object:G}=R;return this._objectChanged(G)})),G.on("attributesChanged",(R=>{let{attribute:G,object:H}=R;return(0,Wt.b)(G)&&this._objectChanged(H)})),G.on(["transformationChanged","shaderTransformationChanged"],(R=>this._objectChanged(R)))],lp)}dispose(){this.removeHandles(lp)}elevationInfoChanged(){const R=null!=this.layer?this.layer.elevationInfo:null;if(null!=R&&"on-the-ground"!==R.mode){var G,H;const W=(0,me.G9)(this.layer.spatialReference),q=(0,ae.Ao)(null!==(G=R.unit)&&void 0!==G?G:"meters");this._elevationOffset=(null!==(H=R.offset)&&void 0!==H?H:0)*q/W}else this._elevationOffset=0}getElevation(R,G,H,W){if(up[0]=R,up[1]=G,up[2]=H,!this._renderCoordsHelper.toRenderCoords(up,W,up))return J.A.getLogger(this).error("could not project point for elevation alignment"),null;const q=this._elevationOffset,Q=this._zmin+q,X=this._zmax+q;this._renderCoordsHelper.setAltitude(pp,X,up),this._renderCoordsHelper.setAltitude(_p,Q,up);return this._intersector.reset(pp,_p,null),this._intersector.intersect(this._intersectLayers,null,1,null,(R=>!!R.lastValidElevationBB)),this._intersector.results.min.getIntersectionPoint(up)?this._renderCoordsHelper.getAltitude(up):null}_objectChanged(R){const G=this.spatialReference;if(!R.lastValidElevationBB||!G)return;(0,Le.Ie)(dp);const H=R.lastValidElevationBB;H.isEmpty()||this._expandExtent(G,H.min,H.max,dp);const{min:W,max:q}=R.boundingVolumeWorldSpace;this._expandExtent(G,W,q,dp),(0,Le.ES)(dp,hp.extent),this._zmin=Math.min(this._zmin,dp[2]),this._zmax=Math.max(this._zmax,dp[5]),hp.spatialReference=G,this.emit("elevation-change",hp),(0,be.c)(H.min,W),(0,be.c)(H.max,q)}_computeLayerExtent(R,G){return(0,Le.Ie)(dp),null!=R&&G.objects.forAll((G=>this._expandExtent(R,G.boundingVolumeWorldSpace.min,G.boundingVolumeWorldSpace.max,dp))),dp}_expandExtent(R,G,H,W){for(let q=0;q<8;++q)up[0]=1&q?G[0]:H[0],up[1]=2&q?G[1]:H[1],up[2]=4&q?G[2]:H[2],this._renderCoordsHelper.fromRenderCoords(up,up,R),(0,Le.iT)(W,up);return W}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],cp.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],cp.prototype,"stageLayer",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],cp.prototype,"view",void 0),(0,W._)([(0,ee.MZ)()],cp.prototype,"spatialReference",null),cp=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.StageLayerElevationProvider")],cp);const dp=(0,Le.Ie)(),hp=new ElevationUpdateEvent_e,up=(0,xe.vt)(),pp=(0,xe.vt)(),_p=(0,xe.vt)();var mp,gp=H(89846),fp=H(54217),yp=H(57264),vp=H(74967),bp=H(22027),xp=H(80899);const Sp=(0,xe.vt)(),Cp=(0,Le.vt)();let wp=mp=class extends Q.A{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){var R;return this._spatialIndex||(this._spatialIndex=new ap({objectIdField:null===(R=this.owner.layer)||void 0===R?void 0:R.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){var R;return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?sa.ASYNC:null!==(R=this._forcedUpdatePolicy)&&void 0!==R?R:this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){var R,G,H;return!!(this.dataUpdating||null!==(R=this._elevationAlignment)&&void 0!==R&&R.updating||null!==(G=this._scaleVisibility)&&void 0!==G&&G.updating||null!==(H=this._filterVisibility)&&void 0!==H&&H.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){var R;return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||null!==(R=this._spatialIndex)&&void 0!==R&&R.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||this._loadingSymbols>0)}get running(){var R;return this._pendingUpdates.size>0||!(null===(R=this._spatialIndex)||void 0===R||!R.updating)||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){var R;return this.owner.suspended||!(null===(R=this.owner.suspendInfo)||void 0===R||!R.outsideOfView)}get updatingRemaining(){var R,G;return this.updating?this._pendingUpdates.size+.1*((null===(R=this._spatialIndex)||void 0===R?void 0:R.updatingRemaining)||0)+.1*((null===(G=this._elevationAlignment)||void 0===G?void 0:G.updatingRemaining)||0):0}get displayFeatureLimit(){var R,G,H,W,q;const Q=this.owner&&this.owner.view&&this.owner.view.qualitySettings,J=null!==(R=null===Q||void 0===Q?void 0:Q.graphics3D.minTotalNumberOfFeatures)&&void 0!==R?R:0,X=null!==(G=null===Q||void 0===Q?void 0:Q.graphics3D.maxTotalNumberOfFeatures)&&void 0!==G?G:0,$=null!==(H=null===Q||void 0===Q?void 0:Q.graphics3D.maxNumberOfDrawCalls)&&void 0!==H?H:0,K=null!==(W=null===Q||void 0===Q?void 0:Q.graphics3D.maxTotalNumberOfVertices)&&void 0!==W?W:0,ee=this.averageSymbolComplexity,te=Math.max(1,null!==(q=null===ee||void 0===ee?void 0:ee.verticesPerFeature)&&void 0!==q?q:1),ie=ee&&ee.drawCallsPerFeature>0&&$>0?$/ee.drawCallsPerFeature:X,re=Math.ceil(K/te),ne=Math.max(J,Math.min(X,re,ie)),se=this._get("displayFeatureLimit");return se&&se.maximumTotalNumberOfVertices===K&&se.averageSymbolComplexity===ee&&se.maximumNumberOfFeatures===ne?se:new DisplayFeatureLimit_e(K,ne,ee)}get averageSymbolComplexity(){const R=function defaultSymbolComplexity_d(R){const G=defaultSymbolComplexity_F(R);return G.numComplexities>0&&(G.verticesPerFeature/=G.numComplexities,G.verticesPerCoordinate/=G.numComplexities,G.drawCallsPerFeature/=G.numComplexities,G.memory.bytesPerFeature/=G.numComplexities,G.memory.bytesPerFeatureLabel/=G.numComplexities,G.memory.resourceBytes/=G.numComplexities,G.memory.draped.bytesPerFeature/=G.numComplexities,G.memory.draped.bytesPerFeatureLabel/=G.numComplexities),G}(this._symbolComplexities),G=this._get("averageSymbolComplexity");return 0===R.numComplexities||null!=G&&(R.estimated&&(G.verticesPerFeature>=R.verticesPerFeature||G.verticesPerCoordinate>=R.verticesPerCoordinate||G.drawCallsPerFeature>=R.drawCallsPerFeature)||G.verticesPerFeature===R.verticesPerFeature&&G.verticesPerCoordinate===R.verticesPerCoordinate&&G.drawCallsPerFeature===R.drawCallsPerFeature)?G:R}get usedMemory(){const R=null!=this.averageSymbolComplexity&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,G=this._getSymbolComplexitiesUsed().reduce(((R,G)=>R+G.memory.resourceBytes),0),H=this.owner.view._stage.renderer,W=this.owner.view.basemapTerrain.overlayManager.renderer,q=Array.from(this._symbols.values()).reduce(((R,G)=>{var q;return R+(null!==(q=null===G||void 0===G?void 0:G.symbolLayers.reduce(((R,G)=>{var q;return R+(null!==(q=null===G||void 0===G?void 0:G.materials.reduce(((R,G)=>{var q,Q;return G?R+(null!==(q=null===(Q=H.plugins.getMaterialRenderer(G))||void 0===Q?void 0:Q.usedMemory)&&void 0!==q?q:0)+W.getMemoryForMaterial(G):R}),0))&&void 0!==q?q:0)}),0))&&void 0!==q?q:0)}),0);return this._usedMemory+R+G+q}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const R=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*R}if(null!=this.averageSymbolComplexity){const R=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+R}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(R){var G,H;if("web-style"===R.type)return R.clone();const W=this._symbolConversionCache.get(R.id);if(null!=W)return W;const q=(0,Ii.t)(R,{geometryType:null!==(G=null===(H=this.layer)||void 0===H?void 0:H.geometryType)&&void 0!==G?G:void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(R)}),Q=q.symbol||null;return null==Q&&q.error&&J.A.getLogger(this).error(q.error.message),this._symbolConversionCache.set(R.id,Q),Q}_getSymbolComplexitiesUsedOrRenderer(R){if(null==R)return[];const G=R.getSymbols(),H="backgroundFillSymbol"in R?R.backgroundFillSymbol:null;if(!H&&(null===G||void 0===G||!G.length))return[];const W=[],q=this._getSymbolComplexityUsedOrRenderer(H);null!=q&&W.push(q);for(const Q of G){const R=this._getSymbolComplexityUsedOrRenderer(Q);null!=R&&W.push(R)}return W}_getSymbolComplexityUsedOrRenderer(R){if(null==R)return null;const G=this._symbols.get(R.id);if(null!=G)return G.complexity;const H=this._getConvertedSymbol(R);return null!=H?function defaultSymbolComplexity_m(R){return"web-style"===R.type?Ir:defaultSymbolComplexity_F(R.symbolLayers.toArray().map((G=>defaultSymbolComplexity_L(R,G))))}(H):null}_getSymbolComplexitiesUsed(){const R=[];return this._symbols.forEach((G=>{null!=G&&R.push(G.complexity)})),R}get _objectIdField(){return this.layer.objectIdField}constructor(R){super(R),this._propertiesPool=new gp.M({computedExtent:jc.A},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=ot.nu,this._dataUpdateQueue=new ke.T,this._updateQueue=new ke.T,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new pe.A({allocator:R=>R||new Graphics3DCore_Me,deallocator:R=>(R.clear(),R)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new pe.A,this.preferredUpdatePolicy=sa.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=R.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",(R=>R.destroy())),this.symbolCreationContext=new Graphics3DSymbolCreationContext_e(R.owner.view.resourceController.scheduler,((R,G)=>this._updateQueue.push(R,G)))}initialize(){var R;this._featureStore=new Hr({objectIdField:null===(R=this.owner.layer)||void 0===R?void 0:R.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:R=>this.graphics3DGraphics.forEach(R)});const e=(R,G,H)=>this.spatialIndex.queryGraphicUIDsInExtent(R,G,H),{componentFactories:G}=this;if(null!=G.elevationAlignment){const R=G.elevationAlignment(this,e);this._elevationAlignment=R}if(null!=G.scaleVisibility){const R=G.scaleVisibility(this,e);this._scaleVisibility=R}if(null!=G.filterVisibility){const R=G.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:R=>this.modifyGraphics3DGraphicVisibilities((G=>G.setVisibilityFlag(Nr.GRAPHIC,Fr.FILTER,R((0,Mi.RW)(G.graphic,this._objectIdField))))),setAllFeaturesVisibility:R=>this.modifyGraphics3DGraphicVisibilities((G=>G.setVisibilityFlag(Nr.GRAPHIC,Fr.FILTER,R))),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities((R=>R.setVisibilityFlag(Nr.GRAPHIC,Fr.FILTER,!0)))});this._filterVisibility=R}if(null!=G.deconflictor){const R=G.deconflictor(this);this._deconflictor=R}if(null!=G.labeler&&null!=this._scaleVisibility){const R=G.labeler(this,this._scaleVisibility);this._labeler=R}if(null!=G.objectStates){const R=G.objectStates(this);this._objectStates=R}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}async _initializeAsync(){var R,G,H;const W=null===(R=this._initializeAbortController)||void 0===R?void 0:R.signal,q=this.owner.view;this._viewElevationProvider=new ElevationQuery_l(this._viewSpatialReference,q),this._initializeStage(q,this.layer.uid);const Q=q.sharedSymbolResources;this.symbolCreationContext.sharedResources=Q,this._sharedSymbolResourcesOwnerHandle=Q.addGraphicsOwner(this.owner),null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=Q.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=q.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new GridLocalOriginFactory_(q.renderSpatialReference),this.symbolCreationContext.elevationProvider=q.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=R=>this.notifyGraphicGeometryChanged(R),this.symbolCreationContext.notifyGraphicVisibilityChanged=R=>this.notifyGraphicVisibilityChanged(R);const K=featureExpressionInfoUtils_d(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await featureExpressionInfoUtils_a(K,this._viewSpatialReference,W,J.A.getLogger(this)),(0,X.Te)(W),this.symbolCreationContext.screenSizePerspectiveEnabled=q.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!(null===(G=this.owner.view.qualitySettings)||void 0===G||!G.physicallyBasedRenderingEnabled),this.symbolCreationContext.skipHighSymbolLods=!(null===(H=this.owner.view.qualitySettings)||void 0===H||null===(H=H.graphics3D)||void 0===H||!H.skipHighSymbolLods),"drapeSourceType"in this.owner){const{owner:R}=this;this.symbolCreationContext.drapeSourceRenderer=q.basemapTerrain.overlayManager.registerGeometryDrapeSource(R),this.addHandles((0,ue.hA)((()=>q.basemapTerrain.overlayManager.unregisterDrapeSource(R))))}this.addHandles([(0,$.wB)((()=>this.suspendedOrOutsideOfView),(()=>this._updateQueue.unshift((()=>this._updateLayerVisibility()),null))),(0,$.wB)((()=>{var R,G;return[null===(R=this.layer)||void 0===R?void 0:R.screenSizePerspectiveEnabled,null===(G=this.owner.view)||void 0===G?void 0:G.screenSizePerspectiveEnabled]}),(()=>{var R;const G=q.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;G!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=G,null!==(R=this._labeler)&&void 0!==R&&R.reset(),this.recreateAllGraphicsAndSymbols())})),(0,$.wB)((()=>this.owner.slicePlaneEnabled),(R=>this._slicePlaneEnabledChange(!!R))),(0,$.wB)((()=>{var R;return null===(R=this.owner.view.state)||void 0===R?void 0:R.rasterPixelRatio}),(()=>this._pixelRatioChange())),(0,$.wB)((()=>{var R;return!(null===(R=this.owner.view.qualitySettings)||void 0===R||!R.physicallyBasedRenderingEnabled)}),(R=>this._physicalBasedRenderingChange(R))),(0,$.wB)((()=>{var R;return!(null===(R=this.owner.view.qualitySettings)||void 0===R||null===(R=R.graphics3D)||void 0===R||!R.skipHighSymbolLods)}),(R=>this._skipHighSymbolLoDsChange(R))),(0,$.z7)((()=>{var R;return null===(R=q.basemapTerrain)||void 0===R?void 0:R.tilingScheme}),(R=>{if(R.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==q.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=q.basemapTerrain.spatialReference),this.hasHandles("loaded-graphics"))this.recreateAllGraphics();else{const e=()=>{var R;return null===(R=this.owner)||void 0===R?void 0:R.loadedGraphics};this.addHandles([(0,$.on)(e,"change",(R=>{this._graphicsCollectionChanged(R),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")}}),{initial:!0}),(0,$.wB)((()=>this.effectiveUpdatePolicy),(R=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=R),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===sa.ASYNC,R===sa.SYNC&&this.runTask(ot.Bb)}),$.pc)]),this._frameTaskHandle=q.resourceController.scheduler.registerTask(ot.W6.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this.addHandles((0,$.wB)((()=>this.layer.featureReduction),(()=>this._deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((()=>{})),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){var R,G;this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=ot.nu,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),null!==(R=this.owner.view)&&void 0!==R&&null!==(R=R.deconflictor)&&void 0!==R&&R.removeGraphicsOwner(this),null!==(G=this.owner.view)&&void 0!==G&&null!==(G=G.labeler)&&void 0!==G&&G.removeGraphicsOwner(this),this._elevationAlignment=(0,Qe.pR)(this._elevationAlignment),this._scaleVisibility=(0,Qe.pR)(this._scaleVisibility),this._filterVisibility=(0,Qe.pR)(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=(0,Qe.pR)(this._objectStates),this.clear(),this._featureStore=(0,Qe.pR)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,Qe.xt)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,Qe.pR)(this._graphicStateTracking),this.stage&&(this.stageLayer=(0,Qe.pR)(this.stageLayer),this.stage=null),this._set("owner",null);for(const H in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[H].reject(new Ze.A("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,Qe.xt)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,Qe.pR)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,Qe.pR)(this._spatialIndex)}clear(){var R,G;null!==(R=this._objectStates)&&void 0!==R&&R.allGraphicsDeleted(),null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((R=>R.destroy())),null!==(G=this._spatialIndex)&&void 0!==G&&G.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(Qe.pR),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("dataUpdating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}_initializeStage(R,G){this.stage=R._stage,this.stageLayer=new WebGLLayer_a(this.stage,{pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},G);const H=this.stageLayer.events;H.on("transformationChanged",(R=>this.notifyGraphicGeometryChanged(R.graphicUid))),H.on("shaderTransformationChanged",(R=>this.notifyGraphicGeometryChanged(R.graphicUid))),H.on("visibilityChanged",(R=>this.notifyGraphicVisibilityChanged(R.graphicUid))),H.on("geometryAdded",(R=>this.notifyGraphicGeometryChanged(R.object.graphicUid))),H.on("geometryRemoved",(R=>this.notifyGraphicGeometryChanged(R.object.graphicUid))),H.on("attributesChanged",(R=>(0,Wt.b)(R.attribute)&&this.notifyGraphicGeometryChanged(R.object.graphicUid)))}notifyGraphicGeometryChanged(R){if(null==this._graphicStateTracking||null==R)return;const G=this.graphics3DGraphics.get(R);G&&this._graphicStateTracking.updateGraphicGeometry(G)}notifyGraphicVisibilityChanged(R){if(null==this._graphicStateTracking||null==R)return;const G=this.graphics3DGraphics.get(R);G&&this._graphicStateTracking.updateGraphicVisibility(G)}_updateLayerVisibility(){const R=this.displayFeatureLimit.maximumNumberOfFeatures,G=this._numberOfGraphics>R*Rp,H=!this.suspendedOrOutsideOfView&&!G;H!==this._visible&&(this._visible=H,H?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(R){return null!=R?this.graphics3DGraphics.get(R):void 0}getGraphics3DGraphicByObjectId(R){var G;return null!==(G=this.owner.layer)&&void 0!==G&&G.objectIdField?this._findGraphics3DGraphicByObjectId(R):null}_getGraphicObjectID(R){var G;let H=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null===(G=this.owner.layer)||void 0===G?void 0:G.objectIdField;return(0,Mi.RW)(R,H)}get graphics3DGraphicsByObjectID(){var R;const G=null===(R=this.owner.layer)||void 0===R?void 0:R.objectIdField;if(!G)return;const H=new Map;return this.graphics3DGraphics.forEach((R=>{if(!R)return;const W=R.graphic,q=this._getGraphicObjectID(W,G);null!=q&&H.set(q,R)})),H}get labelsEnabled(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}async updateLabelingInfo(R){const G=this._deconflictor&&this._deconflictor.labelingInfoChange(R),H=this._labeler&&this._labeler.labelingInfoChange(R);await Promise.allSettled([G,H])}updateVisibilityInfo(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let R=0,G=0;return(0,Ti.Bs)(this._symbols,((H,W)=>{if(null!=H){const q=H.getFastUpdateStatus();if(q.loading>0)return!0;this._graphicsBySymbol.has(W)&&(G+=q.fast,R+=q.slow)}return!1}))?"unknown":G>=0&&0===R?"fast":R>=0&&0===G?"slow":"mixed"}runTask(R){if(this._dataUpdateQueue.runTask(R),this._updateQueue.runTask(R),this._applyPendingUpdates(R),this.notifyChange("running"),this.running||this.notifyChange("dataUpdating"),this.notifyChange("updatingRemaining"),!R.hasProgressed)return Uu.G}setObjectIdVisibility(R,G){G?this._objectIdInvisibleSet.delete(R):this._objectIdInvisibleSet.add(R);const H=this._findGraphics3DGraphicByObjectId(R);null!=H&&this._updateUserVisibility(H)}_findGraphics3DGraphicByObjectId(R){return(0,Ti.$n)(this.graphics3DGraphics,(G=>this._getGraphicObjectID(G.graphic)===R))}_updateUserVisibility(R){if(null==R)return!1;const G=R.graphic,H=this._getGraphicObjectID(G),W=G.visible&&!this.owner.suspended&&(null==H||!this._objectIdInvisibleSet.has(H));return R.setVisibilityFlag(Nr.GRAPHIC,Fr.USER,W)}_whenGraphics3DGraphic(R){const G=this.graphics3DGraphics.get(R.uid);if(G)return Promise.resolve(G);const H=this._whenGraphics3DGraphicRequests[R.uid];if(H)return H.promise;const W=(0,X.Tw)();return this._whenGraphics3DGraphicRequests[R.uid]=W,W.promise}async _boundsForGraphics3DGraphic(R,G){const H=this._viewSpatialReference,W=this.owner.view.renderSpatialReference,q=this.owner.view.basemapTerrain.spatialReference,Q=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=G&&!!G.useViewElevation,minDemResolution:null!=G?G.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null,J=await R.getProjectedBoundingBox(((R,G,q)=>(0,Ie.projectBuffer)(R,W,G,R,H,G,q)),((R,G,W)=>(0,Ie.projectBuffer)(R,q,G,R,H,G,W)),Q,null===G||void 0===G?void 0:G.signal);if(!J)return null;const X=J.boundingBox;if(J.requiresDrapedElevation){const R=this.symbolCreationContext.elevationProvider;if(R){var $;(0,Le.gX)(X,Sp);const G=null!==($=R.getElevation(Sp[0],Sp[1],0,H,"ground"))&&void 0!==$?$:0;X[2]=Math.min(X[2],G),X[5]=Math.max(X[5],G)}}return{boundingBox:X,screenSpaceObjects:J.screenSpaceObjects}}async whenGraphicBounds(R,G){var H;await(0,$.C_)((()=>{var R;return null===(R=this.owner)||void 0===R?void 0:R.loadedGraphics}));const W=null===(H=this.owner.layer)||void 0===H?void 0:H.objectIdField,q=this.owner.loadedGraphics.find((G=>G===R||null!=W&&null!=G.attributes&&R.attributes&&G.attributes[W]===R.attributes[W]));if(!q)throw new Ze.A("internal:graphic-not-part-of-view","Graphic is not part of this view");const Q=await this._whenGraphics3DGraphic(q);return this._boundsForGraphics3DGraphic(Q,G)}computeAttachmentOrigin(R,G){const H=this.graphics3DGraphics.get(R.uid);if(!H)return null;const W=H.computeAttachmentOrigin();if(0===W.render.num&&0===W.draped.num)return null;(0,be.s)(Tp,0,0,0);let q=0;if(W.render.num>0){if(!(0,De.F)(W.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,Ep,G))return null;(0,be.g)(Tp,Tp,Ep),q++}if(W.draped.num>0){var Q;const[R,H]=W.draped.origin,J=null!==(Q=this._viewElevationProvider.getElevation(R,H,"ground"))&&void 0!==Q?Q:0;if((0,be.s)(Ep,R,H,J),!(0,De.F)(Ep,this._viewElevationProvider.spatialReference,Ep,G))return null;(0,be.g)(Tp,Tp,Ep),q++}return q>1&&(0,be.h)(Tp,Tp,1/q),new yp.A({x:Tp[0],y:Tp[1],z:Tp[2],spatialReference:G})}getSymbolLayerSize(R,G){const H=this._symbols.get(R.id);if(null==H)throw new Ze.A("internal:symbol-not-part-of-view","Symbol is not part of this view");const W=R.symbolLayers.indexOf(G);if(-1===W)throw new Ze.A("internal:missing-symbol-layer","Symbol layer is not in symbol");const q=H.getSymbolLayerSize(W);if(null==q)throw new Ze.A("internal:missing-size","Symbol layer has no valid size");return q}_graphicsCollectionChanged(R){this._startCreateGraphics&&(this.add(R.added),this.remove(R.removed))}graphicUpdateHandler(R){const G=R.graphic.uid,H=this.graphics3DGraphics.get(G);if(null!=H||null!=this._graphicsWithoutSymbol.get(G))switch(R.property){case"visible":this._graphicUpdateVisibleHandler(H);break;case"geometry":this._graphicUpdateGeometryHandler(H,R);break;case"symbol":this._graphicUpdateSymbolHandler(H,R);break;case"attributes":break;case"origin-transform":this._graphicUpdateTransformHandler(H,R)}}_graphicUpdateGeometryHandler(R,G){this._graphicUpdateGeometryOrTransformHandler(R,G,(()=>null!=G.newValue&&null!=R&&R.graphics3DSymbol.updateGeometry(R,G.newValue)));const H=G.graphic.geometry;null!=H&&this._expandComputedExtent(H)}_graphicUpdateTransformHandler(R,G){const H=G.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(R,G,(()=>null!=G.newValue&&null!=R&&null!=H&&R.graphics3DSymbol.updateTransform(R,H.spatialReference,G.newValue,G.action)))}_graphicUpdateGeometryOrTransformHandler(R,G,H){if(null!=G.graphic.geometry)if(null!=R)H()||this._recreateGraphic(R.graphic);else{var W;const R=null===(W=G.graphic.symbol)||void 0===W?void 0:W.id;if(R){const G=this._symbols.get(R);if(null!=G&&G.loadStatus===dn.LOADING)return}this._recreateGraphic(G.graphic)}else this._recreateGraphic(G.graphic)}_graphicUpdateSymbolHandler(R,G){const H=G.graphic,W=null!=R?R.graphics3DSymbol:null!=G.oldValue?this._symbols.get(G.oldValue.id):null;if(null==W||null==G.newValue)return void this._recreateGraphic(H);const q=W.symbol,Q=this._getConvertedSymbol(G.newValue);if(null!=Q&&(Q.type!==q.type||"web-style"===Q.type)||"web-style"===q.type)return void this._recreateGraphic(H);const J=this._graphicsBySymbol.get(q.id);if(J&&1!==J.size)return void this._recreateGraphic(H);const X=(0,Ai.Ui)(q,Q);if(null==X)return void this._updateSymbolMapping(q.id,Q);const $={diff:X,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(W.prepareSymbolPatch($),!(0,Ai.Im)($.diff))return void this._recreateGraphic(H);const K=this._getRenderingInfo(H);if(null==K)return void this._recreateGraphic(H);const ee=W.extentPadding;for(const te of $.symbolStatePatches)te();if(ee!==W.extentPadding&&this._recomputeExtentPadding(),null!=R)for(const te of $.graphics3DGraphicPatches)te(R,K);this._updateSymbolMapping(q.id,Q)}_graphicUpdateVisibleHandler(R){this._updateUserVisibility(R)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}recreateGraphics(R){this._suspendSymbolCleanup=!0,this.remove(R),this.add(R),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===sa.SYNC&&this._cleanupSymbols()}_recreateGraphic(R){this.recreateGraphics([R])}_beginGraphicUpdate(R){const G=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(R.uid,G),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating"),G}_endGraphicUpdate(R){R&&(this._graphicsWaitingForSymbol.delete(R.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let R=0;this._symbols.forEach((G=>{null!=G&&(R=Math.max(R,G.extentPadding))})),this._set("extentPadding",R)}_expandComputedExtent(R){const G=Cp,H=R.spatialReference;(0,Mi.w9)(R,G);const W=this._viewSpatialReference,q=mp.tmpVec;if((0,Te.aI)(H,W)||(0,Oi.L)(G[0],G[1],0,H,q,W)&&(G[0]=q[0],G[1]=q[1],(0,Oi.L)(G[3],G[4],0,H,q,W),G[3]=q[0],G[4]=q[1]),!(isFinite(G[0])&&isFinite(G[3])&&isFinite(G[1])&&isFinite(G[4])))return;const Q=this.computedExtent;let J=null;const X=isFinite(G[2])&&isFinite(G[5]),$=X&&(null==(null===Q||void 0===Q?void 0:Q.zmin)||G[2]<Q.zmin),K=X&&(null==(null===Q||void 0===Q?void 0:Q.zmax)||G[5]>Q.zmax);Q?(G[0]<Q.xmin||G[1]<Q.ymin||G[3]>Q.xmax||G[4]>Q.ymax||$||K)&&(J=this._propertiesPool.get("computedExtent"),J.xmin=Math.min(G[0],Q.xmin),J.ymin=Math.min(G[1],Q.ymin),J.xmax=Math.max(G[3],Q.xmax),J.ymax=Math.max(G[4],Q.ymax),J.spatialReference=W):(J=this._propertiesPool.get("computedExtent"),J.xmin=G[0],J.ymin=G[1],J.xmax=G[3],J.ymax=G[4],J.spatialReference=W),J&&($&&(J.zmin=G[2]),K&&(J.zmax=G[5]),this._set("computedExtent",J))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){var R,G;this._abortElevationInfoChange();const H=new AbortController;this._elevationInfoChangeAbortController=H;const W=featureExpressionInfoUtils_d(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await featureExpressionInfoUtils_a(W,this._viewSpatialReference,H.signal,J.A.getLogger(this)),(0,X.Te)(H.signal),this._elevationInfoChangeAbortController=null,null!==(R=this._labeler)&&void 0!==R&&R.elevationInfoChange(),this.forEachGraphics3DSymbol(((R,G,H)=>{R.globalPropertyChanged("elevationInfo",G)?G.forEach((R=>{const G=R.graphic,H=R.labelLayers;for(const W of H)W.graphics3DSymbolLayer.updateGraphicElevationContext(G,W)})):this._recreateSymbol(H)})),this.updateStageLayerElevationProvider(),null===(G=this._elevationAlignment)||void 0===G||G.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,Qe.WD)(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new cp({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){var R,G,H,W;this.clear(),null!=this._filterVisibility&&this._filterVisibility.clear(),null!==(R=this._labeler)&&void 0!==R&&R.reset(),null!==(G=this._deconflictor)&&void 0!==G&&G.clear(),null!==(H=this._elevationAlignment)&&void 0!==H&&H.clear(),null!==(W=this.stageLayer)&&void 0!==W&&W.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,Qe.WD)(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(){let R=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this._startCreateGraphics)return;const{loadedGraphics:G,view:H}=this.owner,W=H.basemapTerrain.tilingScheme&&null!==G&&void 0!==G&&G.length?G.toArray():null;!R&&W||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),W&&(R?this.add(W):this.recreateGraphics(W))}_recreateSymbol(R){const G=this._graphicsBySymbol.get(R),H=[];G&&(G.forEach(((R,G)=>{var W;const q=R.usedMemory;this._conditionalRemove(R,G),null!==(W=this._spatialIndex)&&void 0!==W&&W.remove(R),H.push(R.graphic),R.destroy(),this._removeGraphics3DGraphic(G,q),this._updateLayerVisibility(),this._featureStore.events.emit("changed")})),this._graphicsBySymbol.set(R,new Map));const W=this._symbols.get(R);(0,Qe.pR)(W),this._symbols.delete(R),this.add(H)}_recreateGraphicsForSymbol(R){const G=this._graphicsBySymbol.get(R);if(G){const R=[];G.forEach((G=>R.push(G.graphic))),this.recreateGraphics(R)}}_conditionalRemove(R,G){var H,W,q;this._graphicsDrapedUids.delete(G),null!==(H=this._objectStates)&&void 0!==H&&H.removeGraphic(R),null!==(W=this._labeler)&&void 0!==W&&W.removeGraphic(R),null!==(q=this._deconflictor)&&void 0!==q&&q.removeGraphic(R),null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(R)}add(R){var G;R&&0!==R.length&&(null!==(G=this.owner.view.basemapTerrain)&&void 0!==G&&G.tilingScheme?(this._updatePolicyForGraphics(R)===sa.ASYNC?this._addDelayed(R):this._addImmediate(R),this.notifyChange("dataUpdating")):J.A.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(R){if(this.effectiveUpdatePolicy===sa.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const G of R)if(null!=G.geometry&&"mesh"===G.geometry.type&&!G.geometry.loaded)return sa.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(R){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const G of R)this._addGraphic(G,this._getRenderingInfo(G,J.A.getLogger(this)),sa.SYNC);this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}_addDelayed(R){for(const H of R){var G;const R=H.uid;let W=this._pendingUpdates.get(R);W?W.add?W.state!==Ap.NEW&&(null===(G=W.abortController)||void 0===G||G.abort()):this._pendingAdds++:(W=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(R,W)),W.add=H}this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}remove(R){this.effectiveUpdatePolicy===sa.ASYNC?this._removeDelayed(R):this._removeImmediate(R),this.notifyChange("dataUpdating")}_removeImmediate(R){for(const G of R)this._removeGraphic(G);this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_removeDelayed(R){for(const H of R){var G;const R=H.uid,W=this._pendingUpdates.get(R);if(W)W.add&&(W.remove?W.add=null:this._pendingUpdates.delete(R),W.state===Ap.LOADING&&null!==(G=W.abortController)&&void 0!==G&&G.abort(),this._pendingAdds--);else{const G=this._pendingUpdatesPool.pushNew();G.remove=H,this._pendingUpdates.set(R,G),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&J.A.getLogger(this).warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(R){var G;if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&null!==(G=this._spatialIndex)&&void 0!==G&&G.updating)return this._spatialIndex.update(),void R.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[G,H]of this._pendingUpdates){if(R.done){this._applyPendingRemovesFirst=!0;break}if(H.remove&&!H.add&&(this._pendingRemoves--,R.madeProgress(),this._removeGraphic(H.remove),H.remove=null,this._pendingUpdates.delete(G),0===this._pendingRemoves))break}}for(const[H,W]of this._pendingUpdates){if(R.done)break;W.add&&W.state===Ap.NEW&&this._processPendingUpdateNew(W);let G=this.effectiveUpdatePolicy;if(!W.remove||W.add&&W.state!==Ap.READY||(this._pendingRemoves--,R.madeProgress(),this._removeGraphic(W.remove),W.remove=null,G=sa.SYNC),W.add)switch(W.state){case Ap.READY:this._addGraphic(W.add,W.renderingInfo,G),W.add=null,this._pendingAdds--,R.madeProgress();break;case Ap.REJECTED:W.add=null,this._pendingAdds--;case Ap.LOADING:}null==W.remove&&null==W.add&&this._pendingUpdates.delete(H)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}_processPendingUpdateNew(R){if(!R.add)return void(R.state=Ap.READY);const G=R.add.geometry;null==G||"mesh"!==G.type||G.loaded?this._processPendingUpdateNewRenderingInfo(R):this._processPendingUpdateNewMesh(R,G)}async _processPendingUpdateNewMesh(R,G){R.state=Ap.LOADING,R.abortController=new AbortController;const H=R.abortController.signal;try{await G.load({signal:H})}catch(W){return this._processPendingUpdateNewError(R,W)}R.abortController=null,this._processPendingUpdateNewRenderingInfo(R)}_processPendingUpdateNewError(R,G){R.abortController=null,(0,X.zf)(G)?R.state=Ap.NEW:R.state=Ap.REJECTED}async _processPendingUpdateNewRenderingInfo(R){var G;if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)return R.renderingInfo=this._getRenderingInfo(R.add,J.A.getLogger(this)),void(R.state=Ap.READY);R.state=Ap.LOADING,R.abortController=new AbortController;let H=null;try{H=await this._getRenderingInfoAsync(R.add,{signal:R.abortController.signal})}catch(W){return R.abortController=null,void((0,X.zf)(W)?R.state=Ap.NEW:R.state=Ap.REJECTED)}null==(null===(G=H)||void 0===G?void 0:G.symbol)?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,J.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),R.renderingInfo=null):R.renderingInfo=H,R.state=Ap.READY}_addGraphic(R,G,H){if(this._graphicsWithoutSymbol.set(R.uid,R),null==(null===G||void 0===G?void 0:G.symbol)||!(0,Mi.N3)(R))return;if(null!=this.stage.renderView.objectAndLayerIdRenderHelper&&this.setUidToIdOnAdd){var W;const G=(0,Ci.ns)(this.owner.view.map,this.layer.uid);this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(R.objectId,R.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!G&&(0,fp.d0)(this.layer,null===(W=this.owner.view.popup)||void 0===W?void 0:W.defaultPopupTemplateEnabled))}const q=G.symbol,Q=this.getOrCreateGraphics3DSymbol(q,G.renderer);if(null==Q)return;this._expandComputedExtent(R.geometry);const J=this._beginGraphicUpdate(R),$=new Graphics3DGraphicCreationContext_r(R,G,this.layer);let K=!1;const l=R=>{R===Q.symbol.id&&(K=!0)};this._whenSymbolRemoved.push(l);const h=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l),this._graphicsWaitingForSymbol.get(R.uid)!==J||K||Q.destroyed||this.graphicSymbolSupported&&R.symbol&&R.symbol.id!==Q.symbol.id)--Q.referenced,this._cleanupSymbols();else{const G=this._createGraphics3DGraphic(Q,$);this._spatialIndex&&null!=G&&this._spatialIndex.add(G),--Q.referenced,this._endGraphicUpdate(R)}this._featureStore.events.emit("changed"),this._labeler&&this.owner.view.labeler.setDirty()}},d=G=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),K||((0,X.zf)(G)?this.add([R]):Q.destroyed||this._endGraphicUpdate(R)))};++this._loadingSymbols,H===sa.ASYNC?Q.load((()=>this._dataUpdateQueue.push(h,null)),(R=>this._dataUpdateQueue.push((()=>d(R)),null))):Q.load(h,d)}_removeGraphic(R){const G=R.uid,H=this.graphics3DGraphics.get(G);if(H){var W,q;H.graphics3DSymbol.onRemoveGraphic(H);const R=H.usedMemory,Q=H.isElevationSource;this._conditionalRemove(H,G),null===(W=this._spatialIndex)||void 0===W||W.remove(H);const J=H.graphics3DSymbol.symbol.id;null!==(q=this._graphicsBySymbol.get(J))&&void 0!==q&&q.delete(G),this._graphicsWithoutSymbol.delete(G),this._removeGraphics3DGraphic(G,R,Q),H.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(G),this._graphicsWaitingForSymbol.delete(G),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(R){if(R instanceof vp.A||R instanceof bp.A){const G=this.symbolCreationContext.layer;return!!G.labelingInfo&&G.labelingInfo.some((G=>G.symbol===R))}return!1}_hasValidSymbolCreationContext(R){return!(R instanceof vp.A&&!this._hasLabelingContext(R))||(J.A.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(R,G){var H;const W=R.geometry;if(null==W)return G&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,G.warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!(0,Ei.canProjectWithoutEngine)(W.spatialReference,this._viewSpatialReference))return G&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,G.warn("Graphic in layer ".concat(this.layer.id," has incompatible spatial reference and will not render"))),null;if(!this.graphicSymbolSupported&&null!=R.symbol)return G&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,G.warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;const q=this.rendererHasGeometryOperations?hydratedFeatures_c(R,this.layer):R;let Q;return Q=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer)?this.owner.getRenderingInfo(q,this.currentRenderer,this._arcadeOnDemand):{symbol:q.symbol||defaults3D_j(q.geometry)},null==(null===(H=Q)||void 0===H?void 0:H.symbol)?(G&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,G.warn("Graphic in layer ".concat(this.layer.id," has no symbol and will not render"))),null):Q}_getRenderingInfoAsync(R,G){if(null==R.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,J.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," has no geometry and will not render"))),null;if(!this.graphicSymbolSupported&&null!=R.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,J.A.getLogger(this).warn("Graphic in layer ".concat(this.layer.id," is not allowed to have a symbol, use a renderer instead"))),null;const H=this.rendererHasGeometryOperations?hydratedFeatures_c(R,this.layer):R;return this.owner.getRenderingInfoAsync(H,this.currentRenderer,this._arcadeOnDemand,G)}_createGraphics3DSymbol(R,G){if(!this._hasValidSymbolCreationContext(R))return null;const H=this._getConvertedSymbol(R);if(!H)return null;let W;if(null!=G&&"backgroundFillSymbol"in G&&G.backgroundFillSymbol){const R=(0,Ii.t)(G.backgroundFillSymbol,{ignoreDrivers:!0});null!=R.symbol&&"web-style"!==R.symbol.type&&"cim"!==R.symbol.type&&(W=R.symbol.symbolLayers)}const q=function Graphics3DSymbolFactory_t(R,G,H){return"point-3d"===R.type?new Graphics3DPointSymbol_s(R,G,H):new Graphics3DSymbol_m(R,G,H)}(H,this.symbolCreationContext,W);return q.load((()=>{const R=q.extentPadding;R>this.extentPadding&&this._set("extentPadding",R),this.notifyChange("averageSymbolComplexity")}),(()=>{})),q}getOrCreateGraphics3DSymbol(R,G){let H=this._symbols.get(R.id);if(void 0===H){const W=this._unusedSymbolsCache.pop(R.id);H=null!=W?W:R instanceof xp.A?new Graphics3DWebStyleSymbol_i(R,(R=>this._dataUpdateQueue.push(R,null)),(R=>this._createGraphics3DSymbol(R,G))):this._createGraphics3DSymbol(R,G),this._symbols.set(R.id,H)}return null!=H&&++H.referenced,H}trackGraphicState(R){return null==this._graphicStateTracking&&(this._graphicStateTracking=new GraphicStateTracking_e(this)),this._graphicStateTracking.add(R)}_addGraphics3DGraphic(R){this._usedMemory+=R.usedMemory,this.graphics3DGraphics.set(R.graphic.uid,R),this._numberOfGraphics++,R.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(R,G){let H=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._usedMemory-=G,this.graphics3DGraphics.delete(R),this._numberOfGraphics--,H&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(R,G){var H,W,q;const Q=G.graphic;if(this._graphicsWithoutSymbol.delete(Q.uid),!this._symbols.has(R.symbol.id))return this.add([Q]),null;if(this.graphics3DGraphics.has(Q.uid))return null;const J=R.createGraphics3DGraphic(G);if(null==J)return null;this._addGraphics3DGraphic(J);const X=R.symbol.id;if(this._graphicsBySymbol.has(X)||this._graphicsBySymbol.set(X,new Map),this._graphicsBySymbol.get(X).set(Q.uid,J),J.isDraped&&this._graphicsDrapedUids.add(Q.uid),J.centroid=null,null!=Q.geometry&&"point"!==Q.geometry.type&&(J.centroid=graphicUtils_b(Q.geometry,this._viewSpatialReference)),this._updateUserVisibility(J),null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(J),null!=this._filterVisibility){const{defaultVisibility:R}=this._filterVisibility;J.setVisibilityFlag(Nr.GRAPHIC,Fr.FILTER,R),R||this._filterVisibility.reapply()}null!==(H=this._deconflictor)&&void 0!==H&&H.addGraphic(J),null!==(W=this._labeler)&&void 0!==W&&W.addGraphic(J),null!==(q=this._objectStates)&&void 0!==q&&q.addGraphic(J),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,J),J.initialize(this.stageLayer,this.owner),null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(J);const $=this._whenGraphics3DGraphicRequests[Q.uid];return $&&(delete this._whenGraphics3DGraphicRequests[Q.uid],$.resolve(J)),J}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}async rendererChange(R){if(this._abortRendererChange(),R!==this.currentRenderer)if(this._validateRenderer(R),null==R&&this._currentRendererChange(null,!1),rendererConversion_t(R))if(null!=R&&R.arcadeRequired){const G=new AbortController;this._rendererChangeAbortController=G;const{arcadeUtils:H}=await this._ensureArcade();(0,X.Te)(G);const W=H.hasGeometryOperations(R);W&&(await H.enableGeometryOperations(),(0,X.Te)(G)),this.effectiveUpdatePolicy===sa.ASYNC?await this._updateQueue.push((()=>this._currentRendererChange(R,W)),G.signal):this._currentRendererChange(R,W),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===sa.ASYNC){const G=new AbortController;this._rendererChangeAbortController=G,await this._updateQueue.push((()=>this._currentRendererChange(R,!1)),G.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(R,!1);else this._currentRendererChange(R,!1)}async _ensureArcade(){return null==this._arcadeOnDemand?(this._arcadeOnDemand=await(0,$t.lw)(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(R,G){var H;this.currentRenderer=R,this.rendererHasGeometryOperations=G,this.symbolCreationContext.arcade=this._arcadeOnDemand;const W=this.symbolCreationContext.renderer;if(R===W)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==R)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const q=(0,Ai.Ui)(W,R);this._updateUnchangedSymbolMappings(q,R,W),this.symbolCreationContext.renderer=R,null!=q&&("complete"===q.type?this.recreateAllGraphicsAndSymbols():"partial"===q.type&&(this._applyRendererDiff(q,R,W)?null===(H=this._labeler)||void 0===H||H.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(R){for(const G in R.diff)switch(G){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete R.diff[G];break;default:return!0}return!1}_applySymbolSetDiff(R,G,H){R=R||[],G=G||[];const W=[];for(const q of G){const G=this._graphicsBySymbol.get(q.id);G&&G.forEach(((Q,J)=>{const X=Q.graphic,$=this.layer instanceof Pi.A?this.layer:null,K=this._arcadeOnDemand;if(q===H.defaultSymbol&&H.getSymbol(hydratedFeatures_c(X,$),{arcade:K})===H.defaultSymbol)return;const ee=Q.usedMemory;R.length||H.defaultSymbol?W.push(X):this._graphicsWithoutSymbol.set(J,X);const te=this.graphics3DGraphics.get(J);this._conditionalRemove(te,J),Q.destroy(),G.delete(J),this._removeGraphics3DGraphic(J,ee),this._updateLayerVisibility()})),this._whenSymbolRemoved.forAll((R=>R(q.id)))}(R.length||W.length)&&(this._graphicsWithoutSymbol.forEach((R=>W.push(R))),this._graphicsWithoutSymbol.clear(),this.add(W)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_applyUniqueValueRendererDiff(R,G,H){const W=R.diff.defaultSymbol,q=R.diff.uniqueValueInfos;if(W||q){const Q=q?q.added.map((R=>R.symbol)).filter(ce.Ru):[],J=q?q.removed.map((R=>R.symbol)).filter(ce.Ru):[];if(q)for(let R=0;R<q.changed.length;R++)Q.push(q.changed[R].newValue.symbol),J.push(q.changed[R].oldValue.symbol);return W?(H.defaultSymbol&&J.push(H.defaultSymbol),G.defaultSymbol&&Q.push(G.defaultSymbol)):H.defaultSymbol&&Q.length&&J.push(G.defaultSymbol),this._applySymbolSetDiff(Q,J,G),delete R.diff.defaultSymbol,delete R.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(R,G,H){if("unique-value"!==(null===G||void 0===G?void 0:G.type)||"unique-value"!==(null===H||void 0===H?void 0:H.type)||null!=R&&"partial"!==R.type)return[];const r=R=>null!=R?R.id:null,W=R&&R.diff,q=null===W||void 0===W?void 0:W.defaultSymbol,Q=W&&W.uniqueValueInfos;let J;if(Q)J=Q.unchanged.map((R=>({oldId:r(R.oldValue.symbol),newId:r(R.newValue.symbol)})));else{J=[];for(const R of null!==(X=H.uniqueValueInfos)&&void 0!==X?X:[]){var X,$;const H=r(R.symbol),W=null===($=G.uniqueValueInfos)||void 0===$?void 0:$.find((G=>G.value===R.value));W&&H!==r(W.symbol)&&J.push({oldId:H,newId:r(W.symbol)})}}return!q&&H.defaultSymbol&&J.push({oldId:r(H.defaultSymbol),newId:r(G.defaultSymbol)}),J}_updateSymbolMapping(R,G){const H=null!=G&&G?"string"==typeof G?G:G.id:null;if(null==R||R===H)return;const W=this._graphicsBySymbol.get(R);this._graphicsBySymbol.delete(R),void 0!==W&&this._graphicsBySymbol.set(H,W);const q=this._symbols.get(R);if(void 0!==q&&(this._symbols.delete(R),this._symbols.set(H,q),null!=q)){const R="string"==typeof G?null:G;null!=R?q.symbol=R:q.symbol.id=H}}_updateUnchangedSymbolMappings(R,G,H){const W=this._calculateUnchangedSymbolMapping(R,G,H);for(const{oldId:q,newId:Q}of W)this._updateSymbolMapping(q,Q)}_applyRendererDiff(R,G,H){if(this._diffHasSymbolChange(R))return!1;if(G instanceof Ri.A&&H instanceof Ri.A&&this._applyUniqueValueRendererDiff(R,G,H)&&0===Object.keys(R.diff).length)return!0;for(const[W]of this._graphicsBySymbol){const H=this._symbols.get(W);if(null!=H)switch(H.applyRendererDiff(R,G)){case cn.RecreateSymbol:this._recreateSymbol(W);break;case cn.RecreateGraphics:this._recreateGraphicsForSymbol(W);case cn.FastUpdate:}}return!0}opacityChange(){this.forEachGraphics3DSymbol(((R,G)=>R.globalPropertyChanged("opacity",G))),this._updateStageLayerVisibility()}_slicePlaneEnabledChange(R){R!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=R,this.stageLayer.sliceable=R,this.forEachGraphics3DSymbol(((R,G)=>R.globalPropertyChanged("slicePlaneEnabled",G))),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())}_physicalBasedRenderingChange(R){this.symbolCreationContext.physicalBasedRenderingEnabled=R,this.forEachGraphics3DSymbol(((R,G,H)=>{R.globalPropertyChanged("physicalBasedRenderingEnabled",G)||this._recreateSymbol(H)}))}_skipHighSymbolLoDsChange(R){this.symbolCreationContext.skipHighSymbolLods=R,this.forEachGraphics3DSymbol(((R,G,H)=>{R.globalPropertyChanged("skipHighSymbolLods",G)||this._recreateSymbol(H)}))}_pixelRatioChange(){this.forEachGraphics3DSymbol(((R,G,H)=>{R.globalPropertyChanged("pixelRatio",G)||this._recreateSymbol(H)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,K._)((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(R,G){const H=this.symbolCreationContext.clippingExtent,W=(0,Fe.vt)();return extentUtils_u(R,W,G)?this.symbolCreationContext.clippingExtent=(0,Le.Jt)((0,Le.vt)(),W):this.symbolCreationContext.clippingExtent=null,!(0,Le.aI)(this.symbolCreationContext.clippingExtent,H)}modifyGraphics3DGraphicVisibilities(R){var G,H;if(this.destroyed)return;let W=!1;this.graphics3DGraphics.forEach((G=>{R(G)&&(W=!0)})),W&&(null!==(G=this.owner.view.labeler)&&void 0!==G&&G.setDirty(),null===(H=this.owner.view.deconflictor)||void 0===H||H.setDirty())}forEachGraphics3DSymbol(R){for(const[G,H]of this._symbols){if(null==H)return;R(H,this._graphicsBySymbol.get(G)||Op,G)}}updateAllGraphicsVisibility(){null!=this._filterVisibility&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((R=>{const G=this._updateUserVisibility(R),H=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(R);return G||H}))}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((R=>R.setVisibilityFlag(Nr.GRAPHIC,Fr.USER,!1)))}_validateRenderer(R){var G;const H=rendererConversion_s(R,{geometryType:null===(G=this.layer)||void 0===G?void 0:G.geometryType});if(H){const R="Renderer for layer '".concat(this.layer.title?"".concat(this.layer.title,", "):"",", id:").concat(this.layer.id,"' is not supported in a SceneView");J.A.getLogger(this).warn(R,H.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let R=!1;this._symbols.forEach(((G,H)=>{if(null==G||G.referenced>0)return;const W=this._graphicsBySymbol.get(H);W&&0!==W.size||(this._graphicsBySymbol.delete(H),this._symbols.delete(H),this._unusedSymbolsCache.put(H,G,function symbolMemory_r(R){return 2216+4096*R.symbolLayers.length+R.complexity.memory.resourceBytes}(G),Ye.Ti),R=!0)})),R&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map((R=>({symbolId:R,graphics:[...this._graphicsBySymbol.get(R).keys()].sort()}))),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:R=>{this._forcedUpdatePolicy=R}}}get performanceInfo(){return new GraphicsCorePerformanceInfo_s(this.graphics3DGraphics.size,this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};var Ap;wp.tmpVec=(0,xe.vt)(),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"computedExtent",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"currentRenderer",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"rendererHasGeometryOperations",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_frameTaskHandle",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_dataUpdateQueue",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_updateQueue",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"_viewSpatialReference",null),(0,W._)([(0,ee.MZ)()],wp.prototype,"_rendererChangeAbortController",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_elevationInfoChangeAbortController",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_initializeAbortController",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_elevationAlignment",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_scaleVisibility",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_filterVisibility",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_initializePromise",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_spatialIndex",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"extentPadding",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_featureStore",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_deconflictor",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_labeler",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_objectStates",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_loadingSymbols",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"preferredUpdatePolicy",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_forcedUpdatePolicy",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"effectiveUpdatePolicy",null),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"elevationFeatureExpressionEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"owner",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"graphicSymbolSupported",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"componentFactories",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"setUidToIdOnAdd",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"featureStore",null),(0,W._)([(0,ee.MZ)()],wp.prototype,"initializePromise",null),(0,W._)([(0,ee.MZ)()],wp.prototype,"scaleVisibility",null),(0,W._)([(0,ee.MZ)()],wp.prototype,"elevationAlignment",null),(0,W._)([(0,ee.MZ)()],wp.prototype,"objectStates",null),(0,W._)([(0,ee.MZ)()],wp.prototype,"filterVisibility",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"updating",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"dataUpdating",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"running",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"suspendedOrOutsideOfView",null),(0,W._)([(0,ee.MZ)({readOnly:!0,dependsOn:[]})],wp.prototype,"updatingRemaining",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],wp.prototype,"displayFeatureLimit",null),(0,W._)([(0,ee.MZ)({readOnly:!0,dependsOn:[]})],wp.prototype,"averageSymbolComplexity",null),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"hasZ",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wp.prototype,"hasM",void 0),(0,W._)([(0,ee.MZ)()],wp.prototype,"_objectIdField",null),wp=mp=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.Graphics3DCore")],wp),function(R){R[R.NEW=0]="NEW",R[R.LOADING=1]="LOADING",R[R.READY=2]="READY",R[R.REJECTED=3]="REJECTED"}(Ap||(Ap={}));class Graphics3DCore_Me{constructor(){this.add=null,this.renderingInfo=null,this.state=Ap.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=Ap.NEW,this.abortController=null,this.remove=null}}const Rp=10,Tp=(0,xe.vt)(),Ep=(0,xe.vt)(),Op=new Map;let Pp=class extends Q.A{constructor(R){super(R),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new we.U,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();const R=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(R.registerTask(ot.W6.SCALE_VISIBILITY,this)),this._updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.layerMinMaxScaleChangeHandler()))}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(R){const G=this.graphicsCoreOwner.view.spatialReference,H=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(G===H)this._extent=null!==R&&void 0!==R?R:null;else{const W=(0,Fe.vt)();projectBoundingRect_i(R,G,W,H)?this._extent=W:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const R=this.layer,G=R.effectiveScaleRange;let H=this.layerScaleEnabled&&null!=G&&Graphics3DScaleVisibility_g(G.minScale,G.maxScale);R.labelingInfo&&!H&&(H=R.labelingInfo.some((R=>{var G,H;return R&&Graphics3DScaleVisibility_g(null!==(G=R.minScale)&&void 0!==G?G:0,null!==(H=R.maxScale)&&void 0!==H?H:0)})));const W=this._scaleRangeActive!==H;return this._scaleRangeActive=H,H&&!this.hasHandles(Mp)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on("scale-change",(R=>this._scaleUpdateHandler(R))),Mp),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),Mp)):!H&&this.hasHandles(Mp)&&this.removeHandles(Mp),W}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(R){const G=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&G&&G.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return Uu.G;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:R,maxScale:H}=this.layer.effectiveScaleRange;G.queryVisibleScaleRange(this._extent,R,H,(R=>this._finishUpdate(R)))}}else this._finishUpdate(!0);R.madeProgress()}_finishUpdate(R){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!R),this._dirty=!1}_visibleAtLayerScale(R){const G=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,pi.JU)(R,G.minScale||0,G.maxScale||0)}_visibleAtLabelScale(R,G){return(0,pi.JU)(R,G.minScale||0,G.maxScale||0)}_graphicScale(R){let G;return null!=R.centroid?G=R.centroid:null!=R.graphic.geometry&&"point"===R.graphic.geometry.type&&(G=R.graphic.geometry),G?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(G):1:null}_graphicVisible(R){if(!this.layerScaleEnabled)return!0;const G=this._graphicScale(R);return this._visibleAtLayerScale(G)}updateVisibility(R){if(this._scaleRangeActive){const G=this._graphicVisible(R);return R.setVisibilityFlag(Nr.GRAPHIC,Fr.SCALE_RANGE,G)}return!1}updateGraphicLabelScaleVisibility(R){if(!this._scaleRangeActive)return!1;if(!R.labelLayers||0===R.labelLayers.length)return!1;const G=this._graphicScale(R),H=this._updateLabelScaleVisibility(R,G);return H&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),H}_updateLabelScaleVisibility(R,G){if(!R.labelLayers||0===R.labelLayers.length)return!1;const H=R.labelLayers[0]._labelClass;if(null!=(null===H||void 0===H?void 0:H.minScale)&&null!=H.maxScale){const W=this._visibleAtLabelScale(G,H);if(R.setVisibilityFlag(Nr.LABEL,Fr.SCALE_RANGE,W))return!0}return!1}_scaleUpdateHandler(R){if(this._setDirty(),!this.graphicsCore.visible)return;const G=R.extent,H=R.scale,W=this._visibleAtLayerScale(H);let q=!1;const Q=this.graphicsCoreOwner.view.spatialReference,X=R.spatialReference;if(null==X)return void J.A.getLogger(this).error("scaleUpdate: Internal error, no SpatialReference given for tiles");const $=!X.equals(Q);if($&&!projectBoundingRect_i(G,X,Ip,Q))return void J.A.getLogger(this).error("scaleUpdate: Internal error, cannot project AABR from "+X+" to wkid "+Q);const K=$?Ip:G;this.queryGraphicUIDsInExtent(K,Q,(R=>{const Q=this.graphicsCore.getGraphics3DGraphicById(R);if(null==Q)return;const J=Q.centroid;null!=J&&(G[0]>J.x||G[1]>J.y||G[2]<J.x||G[3]<J.y)||(Q.setVisibilityFlag(Nr.GRAPHIC,Fr.SCALE_RANGE,W)&&(q=!0),this._updateLabelScaleVisibility(Q,H)&&(q=!0))})),q&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((R=>R.setVisibilityFlag(Nr.GRAPHIC,Fr.SCALE_RANGE,!0))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function Graphics3DScaleVisibility_g(R,G){return R>0||G>0}(0,W._)([(0,ee.MZ)()],Pp.prototype,"graphicsCoreOwner",void 0),(0,W._)([(0,ee.MZ)()],Pp.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)()],Pp.prototype,"queryGraphicUIDsInExtent",void 0),(0,W._)([(0,ee.MZ)()],Pp.prototype,"graphicsCore",void 0),(0,W._)([(0,ee.MZ)()],Pp.prototype,"basemapTerrain",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Pp.prototype,"layerScaleEnabled",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Pp.prototype,"suspended",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Pp.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],Pp.prototype,"_dirty",void 0),Pp=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],Pp);const Mp="terrain-events",Ip=(0,Fe.vt)();function I3SGeometryUtil_c(R,G,H,W,q){const Q=G.getComponentAabb(H,R,Dp),J=G.getObjectTransform(H);for(let X=0;X<8;++X)Lp[0]=1&X?Q[0]:Q[3],Lp[1]=2&X?Q[1]:Q[4],Lp[2]=4&X?Q[2]:Q[5],(0,be.t)(Lp,Lp,J.rotationScale),(0,be.g)(Lp,Lp,J.position),W[q++]=Lp[0],W[q++]=Lp[1],W[q++]=Lp[2];return W}const Dp=(0,Le.vt)(),Lp=(0,xe.vt)();class GraphicsMap_r extends Vr.A{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const R=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:R})}}get length(){return this._map.size}get(R){return this._map.get(R)}addMany(R){if(0===R.length)return;const G=new Set;for(let W=0;W<R.length;W++){const H=R[W],q=H.objectId,Q=this._map.get(q);Q?(G.add(q),H!==Q&&(R[W]=Q),Q.refCount||(Q.refCount=0),++Q.refCount):(H.refCount=1,this._map.set(q,H))}const H=G.size>0?R.filter((R=>!G.has(R.objectId))):R;H.length>0&&this.emit("change",{added:H,removed:[]})}removeMany(R){const G=[];for(const H of R){const R=H.objectId,W=this._map.get(R);null!=W&&(!W.refCount||--W.refCount<=0)&&(this._map.delete(R),G.push(H))}G.length>0&&this.emit("change",{added:[],removed:G})}removeManyByObjectId(R){const G=[];for(const H of R){const R=this._map.get(H);null!=R&&(!R.refCount||--R.refCount<=0)&&(this._map.delete(H),G.push(R))}G.length>0&&this.emit("change",{added:[],removed:G})}toArray(){return[...this._map.values()]}find(R){let G;return(0,Ti.Bs)(this._map,(H=>!!R(H)&&(G=H,!0))),G}forEach(R){this._map.forEach((G=>R(G)))}}class LimitGraphicsMap_i extends Vr.A{constructor(R){super(),this._limit=R,this._all=new GraphicsMap_r,this._active=new LimitGraphicsMap_a(this),this._pending=new Map,this._handle=this._all.on("change",(R=>this._handleChanges(R)))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(R){return this._active.find(R)}forEach(R){this._active.forEach(R)}addMany(R){this._all.addMany(R)}removeManyByObjectId(R){this._all.removeManyByObjectId(R)}_handleChanges(R){let G=R.removed;if(this._pending.size>0){G=new Array;for(const H of R.removed)this._pending.delete(H.objectId)||G.push(H)}let H=this._limit-this._active.length+G.length;H<R.added.length&&(this._active.removeMany(G),G=[],Fp.reset(1-this._limit/(this._active.length+R.added.length)),this._active.forEach((R=>{Fp.sample()&&(G.push(R),this._pending.set(R.objectId,R))})),H=this._limit-this._active.length+G.length);let W=R.added;if(H<R.added.length){W=new Array,Fp.reset(H/R.added.length);for(const G of R.added)Fp.sample()?W.push(G):this._pending.set(G.objectId,G)}const q=H-W.length;q>0&&this._pending.size>0&&(Fp.reset(q/this._pending.size),this._pending.forEach((R=>{Fp.sample()&&(W.push(R),this._pending.delete(R.objectId))}))),this._active.addAndRemove(W,G)}}const Fp=new class LimitGraphicsMap_n{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(R){this._percentage=R,this._last=-1}sample(){const R=Math.floor(this._index*this._percentage);return++this._index,R!==this._last&&(this._last=R,!0)}};class LimitGraphicsMap_a{constructor(R){this._parent=R,this._map=new Map}get length(){return this._map.size}forEach(R){this._map.forEach((G=>R(G)))}find(R){let G;return(0,Ti.Bs)(this._map,(H=>!!R(H)&&(G=H,!0))),G}toArray(){return[...this._map.values()]}addAndRemove(R,G){for(const H of R)this._map.set(H.objectId,H);for(const H of G)this._map.delete(H.objectId);(R.length>0||G.length>0)&&this._parent.emit("change",{added:R,removed:G})}removeMany(R){for(const G of R)this._map.delete(G.objectId);R.length>0&&this._parent.emit("change",{added:[],removed:R})}}class I3SMeshViewLabeler_G{constructor(R,G){this.meta=R,this.index=G}}class I3SMeshViewLabeler_D{constructor(R,G){this.graphic=R,this.geometry=G,this.components=[],this.overridesDirty=!1}}let Np=class extends Q.A{get updating(){var R,G;return null!==(R=null===(G=this._graphicsCore)||void 0===G?void 0:G.updating)&&void 0!==R&&R}constructor(R){super(R),this.loadedGraphics=new LimitGraphicsMap_i(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new Ni.A},this._featuresMap=new Map}initialize(){const R=this.view.basemapTerrain;this._graphicsCore=new wp({owner:this,layer:this.layer,preferredUpdatePolicy:sa.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:R=>this.view.deconflictor.addGraphicsOwner(R),labeler:(R,G)=>this.view.labeler.addGraphicsOwner(R,G,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(G,H)=>new Pp({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:H,graphicsCore:G,basemapTerrain:R,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then((()=>this._graphicsCore.startCreateGraphics())).catch((()=>{})),this.addHandles((0,$.wB)((()=>this.layer.labelingInfo),((R,G)=>{(0,Ai.Ui)(R,G)&&this._graphicsCore.updateLabelingInfo()})))}destroy(){this._graphicsCore=(0,Qe.pR)(this._graphicsCore),this.loadedGraphics=(0,Qe.pR)(this.loadedGraphics),this.view=null}addNodeMeta(R,G){let H=0;const W=R.filteredIds,q=this.view.spatialReference,Q=[];for(let J=0;J<R.featureIds.length;J++){const X=R.featureIds[J];let $=null==W;if(W&&H<W.length&&X===W[H]&&($=!0,H++),!this._enabledForFeatureInNode(R,J))continue;const K=this._featuresMap.get(X);if(K){K.components.push(new I3SMeshViewLabeler_G(R,J)),this._updateLabelPosition(X);continue}const ee=G(J,R),te=(0,We.T)(0,0,0,q),ie={objectId:X,uid:(0,wi.c)(),attributes:ee,visible:$,geometry:te},re=new I3SMeshViewLabeler_D(ie,te);re.components.push(new I3SMeshViewLabeler_G(R,J)),this._featuresMap.set(X,re),this._updateLabelGeometry(X),Q.push(ie)}this.loadedGraphics.addMany(Q)}updateLabelPositions(R){const G=this.view.renderCoordsHelper;this._forEachGraphic(R,((H,W,q)=>{var Q;const J=this._graphicsCore.getGraphics3DGraphicById(W.uid);null!=J&&this._updateLabelGeometry(R.featureIds[H])&&J.alignWithAbsoluteElevation(null!==(Q=q.z)&&void 0!==Q?Q:0,G,!1)}))}setNodeMetaAttributes(R,G){const H=new Array;this._forEachGraphic(R,((W,q)=>{const Q=G(W,R);(0,Tt.gh)(q.attributes,Q)||(q.attributes=Q,H.push(q.uid))})),this._graphicsCore.updateLabelingInfo(H)}applyFilterChange(R){this._forEachFeature(R,((G,H,W)=>{if(!this._enabledForFeatureInNode(R,G)){const W=R.featureIds[G];switch(this._removeFeature(H,R,G)){case Up.REMOVED:this.loadedGraphics.removeManyByObjectId([W]);break;case Up.MODIFIED:this._updateLabelPosition(W)}return}const q=H.graphic,Q=q.visible;Q!==W&&(q.visible=W,Vp.graphic=q,Vp.property="visible",Vp.oldValue=Q,Vp.newValue=W,this._graphicsCore.graphicUpdateHandler(Vp))}))}removeNodeMeta(R){const G=[];this._forEachGraphic(R,(H=>{const W=R.featureIds[H],q=this._featuresMap.get(W);if(q)switch(this._removeFeature(q,R,H)){case Up.MODIFIED:this._updateLabelPosition(W);break;case Up.REMOVED:G.push(W)}})),this.loadedGraphics.removeManyByObjectId(G)}_removeFeature(R,G,H){const W=R.components.length;return(0,ce.$i)(R.components,(R=>!(R.meta===G&&R.index===H))),0===R.components.length?(this._featuresMap.delete(G.featureIds[H]),Up.REMOVED):W!==R.components.length?Up.MODIFIED:Up.UNMODIFIED}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(R){const G=this._featuresMap.get(R);G&&this._updateLabelGeometry(R)&&(this.loadedGraphics.removeManyByObjectId([R]),this.loadedGraphics.addMany([G.graphic]))}_updateLabelGeometry(R){var G;const H=this._featuresMap.get(R);if(!H)return!1;const W=H.geometry,q=this.view.spatialReference,Q=this.view.renderCoordsHelper,J=W.x,X=W.y,$=null!==(G=W.z)&&void 0!==G?G:0,K=H.components.length,ee=(0,Ne.jh)(24*K);let te=0;for(const{meta:ie,index:re}of H.components)I3SGeometryUtil_c(re,this.collection,ie.objectHandle,ee,te),te+=24;return(0,Ie.projectBuffer)(ee,Q.spatialReference,0,ee,q,0,ee.length/3),(0,Le.hZ)(Gp,Le.qv),(0,Le.Hq)(Gp,ee),W.x=(Gp[0]+Gp[3])/2,W.y=(Gp[1]+Gp[4])/2,W.z=Gp[5],!(0,Ee.Io)(W.x,J)||!(0,Ee.Io)(W.y,X)||!(0,Ee.Io)(W.z,$)}_forEachGraphic(R,G){this._forEachFeature(R,((H,W,q)=>{let{graphic:Q,geometry:J}=W;this._enabledForFeatureInNode(R,H)&&G(H,Q,J,q)}))}_forEachFeature(R,G){let H=0;for(let W=0;W<R.featureIds.length;W++){const q=this._featuresMap.get(R.featureIds[W]);let Q=null==R.filteredIds;R.filteredIds&&R.filteredIds[H]===R.featureIds[W]&&(Q=!0,H++),q&&G(W,q,Q)}}_enabledForFeatureInNode(R,G){var H;return R.node.index<0||!(null!==(H=this.overrides)&&void 0!==H&&H.featureHasGeometryChanges(R.featureIds[G]))}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};(0,W._)([(0,ee.MZ)()],Np.prototype,"view",void 0),(0,W._)([(0,ee.MZ)()],Np.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)()],Np.prototype,"collection",void 0),(0,W._)([(0,ee.MZ)()],Np.prototype,"loadedGraphics",void 0),(0,W._)([(0,ee.MZ)()],Np.prototype,"overrides",void 0),(0,W._)([(0,ee.MZ)()],Np.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],Np.prototype,"slicePlaneEnabled",void 0),(0,W._)([(0,ee.MZ)()],Np.prototype,"_graphicsCore",void 0),Np=(0,W._)([(0,ie.$)("esri.views.3d.layers.I3SMeshViewLabeler")],Np);const Vp={graphic:null,property:null,oldValue:null,newValue:null};var Up;!function(R){R[R.UNMODIFIED=0]="UNMODIFIED",R[R.MODIFIED=1]="MODIFIED",R[R.REMOVED=2]="REMOVED"}(Up||(Up={}));const Gp=(0,Le.vt)();class LayerViewPerformanceInfo_t{constructor(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;this.usedMemory=R,this.displayedFeatures=G,this.totalFeatures=H,this.maximumFeatures=W,this.nodes=q,this.core=Q}}H(29405);ne.B;new pe.A({deallocator:null}),(0,xe.vt)();var zp,Bp,Hp;!function(R){R[R.VISIBLE_ONLY=0]="VISIBLE_ONLY",R[R.ALL=1]="ALL",R[R.QUERYABLE=2]="QUERYABLE"}(zp||(zp={})),function(R){R[R.EXIT=0]="EXIT",R[R.CONTINUE=1]="CONTINUE",R[R.SKIP=2]="SKIP"}(Bp||(Bp={})),function(R){R[R.Absolute=0]="Absolute",R[R.RelativeToGround=1]="RelativeToGround",R[R.OnTheGround=2]="OnTheGround"}(Hp||(Hp={}));H(14784);var jp=H(19549);function graphicSymbolUtils_i(R){return R instanceof Graphics3DWebStyleSymbol_i?R.graphics3DSymbol:R instanceof Graphics3DSymbol_m?R:null}const labelPlacement_u=()=>J.A.getLogger("esri.views.3d.layers.graphics.labelPlacement");class labelPlacement_h{constructor(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.graphics3DGraphic=R,this.labelSymbol=G,this.labelClass=H,this.disablePlacement=W}}function labelPlacement_b(R){const G=function labelPlacement_C(R){const G=R.labelClass.labelPlacement,{labelSymbol:H,graphics3DGraphic:W}=R,q=graphicSymbolUtils_i(W.graphics3DSymbol),Q="point-3d"===(null===q||void 0===q?void 0:q.symbol.type)?q.symbol:null,J=Wp[G]||labelPlacement_y(R);return null!=Q&&Q.supportsCallout()&&Q.hasVisibleVerticalOffset()&&!W.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:labelPlacement_x(Q.verticalOffset),anchor:null,normalizedOffset:null}:!H||!H.hasVisibleVerticalOffset()||null!=Q&&Q.supportsCallout()&&Q.verticalOffset&&!W.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:J&&function labelPlacement_D(R){return"above-center"===R}(J.placement)?{placement:"above-center",verticalOffset:labelPlacement_x(H.verticalOffset),anchor:"bottom",normalizedOffset:[0,J.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(labelPlacement_u().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+G+" placement)"),null)}(R);if(null==G)return null;const H=function labelPlacement_g(R,G){if(G.anchor)return G;const H=R.labelClass.labelPlacement,W=Wp[H],q=W||labelPlacement_y(R);return H&&!W&&labelPlacement_u().warnOncePerTick("the requested label placement '".concat(H,"' is currently unsupported in SceneView.")),function labelPlacement_d(R,G){const H=G.graphics3DGraphic.graphic.geometry;if(null==H)return null;if(null!=G.disablePlacement)return G.labelClass.labelPlacement?(labelPlacement_u().warnOncePerTick(labelPlacement_v(null===R||void 0===R?void 0:R.placement,G.disablePlacement.logEntityDescription)),labelPlacement_y(G)):R;const W=H.type;switch(W){case"polyline":case"polygon":case"extent":case"multipoint":if(G.labelClass.labelPlacement)return labelPlacement_u().warnOncePerTick(labelPlacement_v(null===R||void 0===R?void 0:R.placement,"'".concat(W,"' geometries"))),labelPlacement_y(G);break;case"point":case"mesh":return R}return R}(q,R)}(R,G);if(null==H)return null;const W=H.anchor,q=!!G.hasLabelVerticalOffset,Q=G.verticalOffset;return function labelPlacement_P(R,G,H){const W=H.graphics3DGraphic.graphic.geometry;if(null==W)return null;switch(W.type){case"point":!function labelPlacement_z(R,G,H){const W=labelPlacement_O(H);if(null==W)return;const q=H.graphics3DGraphic.layers[0];switch(null!=q?q.getCenterObjectSpace(R.translation):(0,be.s)(R.translation,0,0,0),W.type){case"icon":case"text":!function labelPlacement_L(R,G,H,W){const{graphics3DGraphic:q}=H,Q=null!=W?W.getScreenSize():null;if(q.isDraped||null==Q)R.hasLabelVerticalOffset||"center"===R.anchor||(Wp[H.labelClass.labelPlacement]&&labelPlacement_u().warnOncePerTick("the requested placement '".concat(G.placement,"' is currently unsupported for draped graphics")),R.anchor="center");else{const W=function labelPlacement_S(R){var G;let H=arguments.length>1&&void 0!==arguments[1]?arguments[1]:qp;const{graphics3DGraphic:W}=R,q=W.layers[0],Q=null!==(G=null===q||void 0===q?void 0:q.stageObject.geometries[0].material)&&void 0!==G?G:null;if(Q&&Q instanceof HUDMaterial_Q){const R=Q.parameters.anchorPosition;H[0]=2*(R[0]-.5),H[1]=2*(R[1]-.5)}else H[0]=0,H[1]=0;return H}(H);R.screenOffset[0]=Q[0]/2*(G.normalizedOffset[0]-W[0]);const q=Q[1]/2*(G.normalizedOffset[1]-W[1]);R.hasLabelVerticalOffset?(R.centerOffset[1]=q,R.centerOffsetUnits="screen"):R.screenOffset[1]=q}}(R,G,H,q);break;case"object":labelPlacement_j(R,G,q)}}(R,G,H);break;case"polygon":!function labelPlacement_w(R,G,H){const W=labelPlacement_O(H);if(null!=W)switch(W.type){case"extrude":{const W=H.graphics3DGraphic.layers[0];null!=W?(W.getBoundingBoxObjectSpace(Zp),(0,Le.gX)(Zp,R.translation),R.translation[2]=(0,Le.uJ)(Zp)/2):(0,be.s)(R.translation,0,0,0),labelPlacement_j(R,G,W);break}}}(R,G,H);break;case"mesh":labelPlacement_j(R,G,H.graphics3DGraphic.layers[0])}const q=Vl-Wl;return R.screenOffset[0]+=q*G.normalizedOffset[0],R.screenOffset[1]+=q*G.normalizedOffset[1],R}(new LabelParameters_i(Q,W,q),H,R)}function labelPlacement_O(R){const G=graphicSymbolUtils_i(R.graphics3DGraphic.graphics3DSymbol);return null!=G?G.symbol.symbolLayers.at(0):null}function labelPlacement_v(R,G){return"the requested label placement '".concat(R,"' is currently unsupported for ").concat(G," in SceneView.")}function labelPlacement_y(R){const G=R.graphics3DGraphic.graphic.geometry;if(null==G)return null;switch(G.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:xe.uY,anchor:"center"};case"polygon":{const G=labelPlacement_O(R);return null!=G&&"extrude"===G.type?Wp["above-center"]:{placement:"center-center",normalizedOffset:xe.uY,anchor:"center"}}case"point":case"mesh":return Wp["above-center"];default:return}}function labelPlacement_j(R,G,H){const W=null!=H?H.getBoundingBoxObjectSpace(Zp):Zp,q=(0,xe.fA)(W[3]-W[0],W[4]-W[1],W[5]-W[2]),Q=Math.sqrt(q[0]*q[0]+q[1]*q[1]);R.centerOffset[0]=Q/2*G.normalizedOffset[0];const J=R.translation[2],X=q[2]/2*G.normalizedOffset[1];R.translation[2]=0,R.elevationOffset=J+X;const $=(0,be.l)(q);R.centerOffset[2]=$/2*G.normalizedOffset[2]}function labelPlacement_x(R){const{screenLength:G,minWorldLength:H,maxWorldLength:W}=R;return{screenLength:G,minWorldLength:H,maxWorldLength:W}}const Wp={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},kp={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const ag in kp){const R=kp[ag],G=Wp[ag];R.forEach((R=>{Wp[R]=G}))}Object.freeze&&(Object.freeze(Wp),Object.keys(Wp).forEach((R=>{var G;Object.freeze(Wp[R]),Object.freeze(null===(G=Wp[R])||void 0===G?void 0:G.normalizedOffset)})));const qp=[0,0],Zp=(0,Le.vt)();class MaterialCollection_s{constructor(R){this._stage=R,this._materials=new Map}get(R){return this._materials.get(R)}add(R,G){this._materials.set(R,G),this._stage.add(G)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}class Labeler_z{constructor(R,G){this.labelingContext=R,this.graphics3DGraphic=G,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Labeler_V{constructor(R,G,H,W,q){this.labelClass=R,this.graphics3DSymbol=G,this.graphics3DCalloutSymbolLayer=H,this.textRenderParameters=W,this.labelFunction=q,this.calloutSymbolLayerIndex=0}}class Labeler_F{constructor(R,G,H,W,q,Q,J,X){this.layer=G,this.graphics3DCore=H,this.scaleVisibility=W,this.emptySymbolLabelSupported=q,this.elevationInfoOverride=Q,this.disablePlacement=J,this.active=X,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new WebGLLayer_a(R,{pickable:!0,disableOctree:!0},G.uid)}destroy(){this.stageLayer.destroy()}}let Qp=class extends Q.A{constructor(R){super(R),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([(0,$.wB)((()=>{var R;return null===(R=this.view.state)||void 0===R?void 0:R.camera}),(()=>this.setDirty())),(0,$.wB)((()=>{var R;return null===(R=this.view.state)||void 0===R?void 0:R.rasterPixelRatio}),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(ot.W6.LABELER,this)]),this._textTextureAtlas=new zu({view:this.view}),this._hudMaterialCollection=new MaterialCollection_s(this.view._stage),this._calloutMaterialCollection=new MaterialCollection_s(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=(0,Qe.WD)(this._textTextureAtlas),this._hudMaterialCollection=(0,Qe.WD)(this._hudMaterialCollection),this._calloutMaterialCollection=(0,Qe.WD)(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),Yp.graphic=null,Yp.renderingInfo=null,Yp.layer=null}_activateLabelingContext(R){R.graphics.forEach(((G,H)=>{const W=new Labeler_z(R,G);this._labels.set(H,W),R.labelsToInitialize.set(H,W),G.setVisibilityFlag(Nr.LABEL,Fr.USER,!0)})),R.active=!0}_deactivateLabelingContext(R){R.graphics.forEach(((R,G)=>{R.setVisibilityFlag(Nr.LABEL,Fr.USER,!1),this.setLabelGraphicVisibility(R,!1),R.clearLabelGraphics(),this._labels.delete(G)})),R.active=!1}_addLabelTextureToAtlas(R){for(const G of R.graphics3DGraphic.labelLayers){if(!G._labelClass)continue;const H=R.textRenderers[G._labelIndex];H&&(this._textTextureAtlas.addTextTexture(H,G.stageObject),R.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(R){for(const G of R.graphics3DGraphic.labelLayers){if(!G._labelClass)continue;const H=R.textRenderers[G._labelIndex];null!=H&&(this._textTextureAtlas.removeTextTexture(H,G.stageObject),R.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(R){return this._updateLabels(R),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(R),Uu.G}_updateLabels(R){if(this._dirty){this._dirty=!1;for(const G of this._labelingContexts)if(G.active)if(Labeler_U(G))this._dirty=!0;else if(Labeler_k(G.labelClassContexts)){if(null===G.labelClassContexts){this._deactivateLabelingContext(G);continue}this._createLabelClassContext(G),this._dirty=!0}else(0,Ti.Bs)(G.labelsToInitialize,((H,W)=>(this._ensureGraphics3DResources(H)&&(this._labels.set(W,H),this.deconflictor.setDirty(),R.madeProgress()),(H.visible&&H.textInitialized||!H.visible&&H.hasGraphics3DResources)&&(G.labelsToInitialize.delete(W),R.madeProgress()),R.done)))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(R){var G,H;const W=null===(G=R.labelClassAbortController)||void 0===G?void 0:G.signal;R.layer.when&&await R.layer.when(),(0,X.Te)(W),R.scaleVisibility&&R.scaleVisibility.updateScaleRangeActive();const q=R.graphics3DCore,Q=null===(H=q.layer.labelingInfo)||void 0===H?void 0:H.filter((R=>!!R.symbol));if(!Q||0===Q.length)return;let $=!1;await(0,Rt.jJ)(Q,(async(G,H)=>{const Q=G.symbol,K=graphicSymbolUtils_i(q.getOrCreateGraphics3DSymbol(Q));if(null==K)return void J.A.getLogger(this).error("Failed to create Graphics3DSymbol for label");await K.load(),(0,X.Te)(W);let ee=null;(0,Wr.YX)(Q)&&Q.hasVisibleCallout()&&(ee=Graphics3DCalloutSymbolLayerFactory_e(Q,q.symbolCreationContext),await ee.load(),(0,X.Te)(W));const te=await(0,Rt.Ke)((0,jp.l)(G,R.layer.fieldsIndex,this.view.spatialReference));if((0,X.Te)(W),!0===te.ok){const q=await this._createTextRenderParameters(K.symbol);(0,X.Te)(W),R.labelClassContexts[H]=new Labeler_V(G,K,ee,q,te.value)}else J.A.getLogger(this).error("Label expression failed to evaluate: ".concat(te.error)),$=!0})),(0,X.Te)(W)}async _createLabelClassContext(R){return null==R.labelClassPromise&&(R.labelClassPromise=this._createLabelClassContextAsync(R).catch((G=>{if((0,X.zf)(G))throw G;R.labelClassContexts.length=0})).then((()=>{R.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),R.labelClassPromise}async _createTextRenderParameters(R){const G=R.symbolLayers.at(0);return"text"!==(null===G||void 0===G?void 0:G.type)?null:TextRenderParameters_l.fromSymbol(G,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(R){for(const H of R.labelClassContexts)--H.graphics3DSymbol.referenced;const G=R.labelClassAbortController;R.labelClassAbortController=new AbortController,(0,Qe.DC)(G),R.labelClassContexts.length=0,R.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(R,G,H,W,q,Q){const J=new LabelParameters_r(H,placementUtils_a(H.anchor),function placementUtils_l(R){switch(R){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}(H.anchor),R.text,(0,Xi.fA)(R.displayWidth,R.displayHeight));return Yp.graphic=G,Yp.renderingInfo=null,Yp.layer=W,q.createLabel(Yp,J,this._hudMaterialCollection,this._textTextureAtlas,(()=>{const R=labelPlacement_b(Q);return R?R.elevationOffset:null}))}_createLineCalloutGraphic(R,G,H,W,q){Yp.graphic=R,Yp.layer=q;const Q=W.screenOffset[0];return Yp.renderingInfo=new Graphics3DLineCalloutSymbolLayer_w(null,G,W.translation,W.centerOffset,Q,W.centerOffsetUnits,W.elevationOffset,this._calloutMaterialCollection),H.createGraphics3DGraphic(Yp)}_ensureGraphics3DResources(R){if(R.hasGraphics3DResources)return!1;const G=R.graphics3DGraphic;if(G.destroyed)return!1;this._ensureTextTextureResources(R);const H=R.labelingContext,W=H.labelClassContexts;if(Labeler_k(W)||!H.emptySymbolLabelSupported&&0===G.layers.length)return!1;let q=!1;const Q=G.graphic,J=H.layer,X=Labeler_B(H.layer);for(let ee=0;ee<W.length;ee++){var $,K;const te=R.textRenderers[ee],ie=R.textLabelPlacements[ee];if(null==te||null==ie)continue;const re=W[ee],ne=re.graphics3DSymbol,se=ne.symbol&&"label-3d"===ne.symbol.type?ne.symbol:null,ae=ne.symbolLayers[0];if(!ae)continue;ae.setElevationInfoOverride(H.elevationInfoOverride);const oe=new labelPlacement_h(G,se,re.labelClass),le=this._createTextSymbolGraphic(te,Q,ie,J,ae,oe);if(null==le)return!1;le._labelClass=re.labelClass,le._labelIndex=ee,G.addLabelGraphic(le,H.stageLayer),G.deconflictionPriority=null!==($=null===(K=re.textRenderParameters)||void 0===K?void 0:K.definition.size)&&void 0!==$?$:0,G.setVisibilityFlag(Nr.LABEL,Fr.USER,X),G.setVisibilityFlag(Nr.LABEL,Fr.SCALE_RANGE,!0),G.setVisibilityFlag(Nr.LABEL,Fr.DECONFLICTION,!1),q=!0;const ce=re.graphics3DCalloutSymbolLayer;if(ce&&ie.hasLabelVerticalOffset){ce.setElevationInfoOverride(H.elevationInfoOverride);const R=this._createLineCalloutGraphic(Q,se,ce,ie,J);null!=R&&(re.calloutSymbolLayerIndex=G.labelLayers.length,G.addLabelGraphic(R,H.stageLayer))}break}return H.scaleVisibility&&q&&H.scaleVisibility.updateGraphicLabelScaleVisibility(G),R.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(R){const G=R.labelingContext.labelClassContexts;for(const H of R.graphics3DGraphic.labelLayers){if(null==H._labelClass)continue;const R=G[H._labelIndex].graphics3DSymbol.symbolLayers[0];null===R||void 0===R||R.onRemoveGraphic(H)}R.graphics3DGraphic.deconflictionPriority=0,R.graphics3DGraphic.clearLabelGraphics(),R.hasGraphics3DResources=!1}_ensureTextTextureResources(R){if(R.textInitialized)return;const G=R.labelingContext,H=G.labelClassContexts;if(Labeler_k(H))return;const W=R.graphics3DGraphic.graphic;for(let J=0;J<H.length;J++){var q;const X=H[J];if(R.textRenderers[J]=null,R.textLabelPlacements[J]=null,null==(null===X||void 0===X?void 0:X.textRenderParameters))continue;const $=X.labelFunction;let K;if("arcade"===$.type)try{const R=$.needsHydrationToEvaluate()?hydratedFeatures_c(W,G.layer):W;K=$.evaluate(R)}catch(Q){K=null}else K=$.evaluate(W);if(null==K||""===K||/^\s+$/.test(K))continue;const ee=X.graphics3DSymbol,te="label-3d"===(null===(q=ee.symbol)||void 0===q?void 0:q.type)?ee.symbol:null;if(!ee.symbolLayers[0])continue;const ie=labelPlacement_b({graphics3DGraphic:R.graphics3DGraphic,labelSymbol:te,labelClass:X.labelClass,disablePlacement:G.disablePlacement});if(null==ie)continue;const re=placementUtils_f(placementUtils_a(ie.anchor));R.textRenderers[J]=new TextRenderer_r(K,re,X.textRenderParameters,zu.maxSize),R.textLabelPlacements[J]=ie}R.textInitialized=!0}_destroyTextTextureResources(R){R.textInitialized=!1,R.textRenderers.length=0,R.textLabelPlacements.length=0}_addGraphic(R,G){const H=G.graphic.uid;if(R.graphics.set(H,G),R.active){const W=new Labeler_z(R,G);this._labels.set(H,W),R.labelsToInitialize.set(H,W)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(R,G){const H=G.graphic.uid,W=this._labels.get(H);R.graphics.delete(H),W&&(this._destroyGraphic(W,H),R.labelsToInitialize.delete(H),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(R,G){this._labels.delete(G),R.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(R),this._destroyTextTextureResources(R),R.hasGraphics3DResources&&this._destroyGraphics3DResources(R)}async _labelingInfoChange(R,G){if(!G)return this._visibilityInfoChange(R),this._resetLabels(R),this._createLabelClassContext(R);for(const H of G){const G=R.graphics.get(H);G&&(this._removeGraphic(R,G),this._addGraphic(R,G))}}_globalPropertyChanged(R,G){for(const H of G.labelClassContexts){const W=new Map;G.graphics.forEach((R=>W.set(R.graphic.uid,R)));const l=R=>R.labelLayers[0];if(H.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(R,W,l),H.graphics3DCalloutSymbolLayer){const t=R=>R.labelLayers[H.calloutSymbolLayerIndex];H.graphics3DCalloutSymbolLayer.globalPropertyChanged(R,W,t)}}}_visibilityInfoChange(R){const G=Labeler_B(R.layer);G&&!R.active&&this._activateLabelingContext(R),!G&&R.active&&this._deactivateLabelingContext(R),this.setDirty()}_resetAllLabels(){for(const R of this._labelingContexts)this._resetLabels(R)}_resetLabels(R){R.graphics.forEach(((G,H)=>{const W=this._labels.get(H);W&&(this._destroyGraphic(W,H),W.visible=!1,R.labelsToInitialize.set(H,W))})),this._destroyLabelClassContext(R),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(R){for(const G of this._labelingContexts)if(G.graphics3DCore===R)return G;return null}addGraphicsOwner(R,G,H){const W=H&&H.emptySymbolLabelSupported||!1,q=(null===H||void 0===H?void 0:H.elevationInfoOverride)||null,Q=(null===H||void 0===H?void 0:H.disablePlacement)||null;if(this._findLabelingContext(R))return;const J=R.layer,X=new Labeler_F(this.view._stage,J,R,G,W,q,Q,Labeler_B(J));return this._labelingContexts.push(X),this.setDirty(),{addGraphic:R=>this._addGraphic(X,R),removeGraphic:R=>this._removeGraphic(X,R),featureReductionChange:()=>{},layerLabelsEnabled:()=>Labeler_B(X.layer),labelingInfoChange:R=>this._labelingInfoChange(X,R),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",X),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",X),visibilityInfoChange:()=>this._visibilityInfoChange(X),reset:()=>this._resetLabels(X),clear:()=>{}}}removeGraphicsOwner(R){const G=this._findLabelingContext(R);if(!G)return;const H=this._labelingContexts.indexOf(G);this._labelingContexts.splice(H,1),G.graphics.forEach((R=>this._removeGraphic(G,R))),G.destroy(),this.setDirty()}setLabelGraphicVisibility(R,G){const H=R.graphic.uid,W=this._labels.get(H);W&&W.visible!==G&&(G&&!W.addedToTextureAtlas?(this._addLabelTextureToAtlas(W),W.textInitialized||W.labelingContext.labelsToInitialize.set(H,W)):!G&&W.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(W),W.visible=G,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var R;return this._dirty||(null===(R=this._textTextureAtlas)||void 0===R?void 0:R.updating)||this.deconflictor.updating||this._labelingContexts.some((R=>Labeler_U(R)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const R=this._labelingContexts.length>0?this._labelingContexts.reduce(((R,G)=>R+(Labeler_U(G)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*R+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function Labeler_U(R){return!!R.labelClassPromise&&!!R.labelClassAbortController}function Labeler_k(R){return!R||0===R.length}function Labeler_B(R){var G;return!0===R.labelsVisible&&!(null===(G=R.labelingInfo)||void 0===G||!G.some((R=>!!R.symbol)))}(0,W._)([(0,ee.MZ)({constructOnly:!0})],Qp.prototype,"view",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Qp.prototype,"deconflictor",void 0),(0,W._)([(0,ee.MZ)()],Qp.prototype,"_textTextureAtlas",void 0),(0,W._)([(0,ee.MZ)({type:Boolean,readOnly:!0})],Qp.prototype,"updating",null),Qp=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.Labeler")],Qp);const Yp=new class Graphics3DLineCalloutSymbolLayer_G extends Graphics3DGraphicCreationContext_r{}(null,null,null);class ExtentSet_l{constructor(){this._extents=new pe.A({allocator:R=>R||(0,Fe.vt)()}),this._tmpExtent=(0,Fe.vt)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(R){this._contains(R)||(this._removeContained(R),(0,Fe.C)(this._extents.pushNew(),R),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(R){return this._mergeTight(R),R.hasProgressed}_mergeTight(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ot.Bb;const G=this._extents,H=new Set;let W=0;for(;W!==G.length;){G.sort(((R,G)=>R[0]-G[0])),W=G.length,H.clear();for(let W=0;W<G.length;++W){if(R.done)return;const q=G.at(W);if(q){for(let R=W+1;R<G.length;++R){const W=G.at(R);if(null==W||W[0]>=q[2])break;H.add(W)}H.forEach((W=>{if(q===W)return;if(W[2]<=q[0])return void H.delete(W);const Q=(0,Fe.Wc)(q),J=(0,Fe.Wc)(W),X=this._tmpExtent;(0,Fe.fT)(q,W,X);const $=Q+J;((0,Fe.Wc)(X)-$)/$<.05&&((0,Fe.C)(q,X),H.delete(W),G.remove(W),R.madeProgress())})),H.add(q)}}}this._dirty=!1}_contains(R){return this._extents.some((G=>(0,Fe.gR)(G,R)))}_removeContained(R){this._extents.filterInPlace((G=>!(0,Fe.gR)(R,G)))}get test(){const R=this;return{containsPoint:G=>R._extents.some((R=>(0,Fe.Uc)(R,G)))}}}let Jp=class extends Q.A{constructor(R,G,H,W){super({}),this._updateExtent=G,this._updateNode=H,this._getElevationMode=W,this.running=!1,this._extentSet=new ExtentSet_l,this._nodeSet=new Set;const q=this._taskPriority,Q=R.registerTask(this._taskPriority,this);this.addHandles(Q),this._task=Q,this._lastTaskPriority=q}get _taskPriority(){const R=this._getElevationMode();return R&&R===Hp.RelativeToGround?ot.W6.ELEVATION_ALIGNMENT_SCENE:ot.W6.ELEVATION_ALIGNMENT}_updateTaskPriority(){const R=this._taskPriority;R!==this._lastTaskPriority&&(this._task.priority=R,this._lastTaskPriority=R)}normalizeCtorArgs(){return{}}addExtent(R){this._extentSet.add(R),this._updateTaskPriority(),this.running=!0}schedule(R){this._nodeSet.add(R),this._updateTaskPriority(),this.running=!0}remove(R){this._nodeSet.delete(R),this._updateRunning()}runTask(R){const G=this._extentSet;for(R.run((()=>G.merge(R)));!G.empty&&!R.done;){const H=this._updateExtent(G.pop());null!=H&&H.forAll((R=>this.schedule(R))),R.madeProgress()}if(R.done)return;const H=this._nodeSet;for(const W of H)if(H.delete(W),this._updateNode(W),R.madeProgress(),R.done)break;this._updateRunning()}_updateRunning(){this.running=this._nodeSet.size>0||this._extentSet.size>0}};(0,W._)([(0,ee.MZ)()],Jp.prototype,"running",void 0),Jp=(0,W._)([(0,ie.$)("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater.ts")],Jp);var Xp=H(83255),$p=H(16913),Kp=H(21262),e_=H(56372),t_=H(74629),i_=H(26128),r_=H(85059),n_=H(82004),s_=H(76193),a_=H(83522),o_=H(49096),l_=(H(66445),H(60141),H(40304)),c_=H(67871),d_=H(1912);class featureReference_t{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(R,G){this._highestResolutionVersion=null,this.versions=[],this.ref(R,G)}ref(R,G){const H=this.feature;h_.oldVersion=H,this.feature&&Object.defineProperty(R,"uid",{value:this.feature.uid,configurable:!0});for(const q of this.versions)if(q.resolution===G){q.refCount++;const G=this._highestResolutionVersion===q&&!(0,d_.aI)(R,q.feature);return(G||this._highestResolutionVersion!==q)&&(q.feature=R),h_.newVersion=G?R:H,h_}const W={feature:R,resolution:G,refCount:1};return this.versions.push(W),!this._highestResolutionVersion||G<this._highestResolutionVersion.resolution?(h_.newVersion=R,this._highestResolutionVersion=W):h_.newVersion=H,h_}unref(R){for(let G=0;G<this.versions.length;G++){const H=this.versions[G];if(H.resolution===R)return H.refCount--,h_.oldVersion=this.feature,0===H.refCount&&(this.versions[G]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===H&&(this._recalculateHighestResolutionVersion(),h_.oldVersion=H.feature)),h_.newVersion=this.feature,h_}return null}get feature(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let R=this.versions[0];for(let G=1;G<this.versions.length;G++){const H=this.versions[G];H.resolution<R.resolution&&(R=H)}this._highestResolutionVersion=R}}class featureReference_s{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(R){this._feature=R,this._refCount=1}ref(R){return++this._refCount,h_.oldVersion=this._feature,this.feature&&Object.defineProperty(R,"uid",{value:this.feature.uid,configurable:!0}),(0,d_.aI)(this._feature,R)||(this._feature=R),h_.newVersion=this._feature,h_}unref(){return h_.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(h_.newVersion=null,h_):(h_.newVersion=this._feature,h_)}get feature(){return this._feature}}const h_={oldVersion:null,newVersion:null};var u_=H(82428);const p_=new Set;class FeatureTile_m{get featuresMissing(){return this._featuresMissing.value}set featuresMissing(R){this._featuresMissing.value=R}get missingAttributes(){return this._missingAttributes}get fetchFailed(){return this._fetchFailed.value}set fetchFailed(R){this._fetchFailed.value=R}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(R){this._displayingFeatures=R,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){const R=(this.fetchStatus===m_.DONE||this.fetchStatus===m_.FULL)&&this.featuresMissing;return!this.filtered&&(R||this.hasFeatureLimit)}get features(){return this._features}get featureLimit(){return this._featureLimit.value}set featureLimit(R){this._featureLimit.value!==R&&(this._featureLimit.value=R,this._estimatedUnusedSizeDirty=!0)}get hasFeatureLimit(){return this.featureLimit!==this._featuresLength.value}get hasAllFeatures(){return!(this.featuresMissing||this.fetchFailed||this.hasFeatureLimit)}get availableFields(){return this._availableFields}setFeatures(R,G,H,W){var q;this._availableFields=null!==H&&void 0!==H?H:p_,this._features=R,this._featuresLength.value=null!==(q=null===R||void 0===R?void 0:R.length)&&void 0!==q?q:0,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,this._missingAttributes=W,R&&R.length>0?(this._emptyFeatureRatio.value=G/(R.length+G),this._numVertices=R.reduce(((R,G)=>R+(0,Mi.Kq)(G.geometry)),0)):(this._emptyFeatureRatio.value=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio.value}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(R){this._numFeatures=R}get hasPreciseFeatureCount(){return this._numFeatures>__}get needsFeatureCount(){return this._numFeatures===__}get numVertices(){return this._numVertices}constructor(R){this.descriptor=R,this.fetchStatus=m_.FETCH_NEEDED,this._features=null,this._featuresLength=(0,u_.v)(0),this._numVertices=0,this._featureLimit=(0,u_.v)(0),this._featuresMissing=(0,u_.v)(!0),this._fetchFailed=(0,u_.v)(!1),this._shuffled=!1,this._numFeatures=__,this._emptyFeatureRatio=(0,u_.v)(0),this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=p_,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let R=0;R<this._features.length;++R){const G=(0,Mi.Ek)(this._features[R]);this._estimatedSize+=G,R>=this.featureLimit&&(this._estimatedUnusedSize+=G)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let R=this.featureLimit;R<this._features.length;++R)this._estimatedUnusedSize+=(0,Mi.Ek)(this._features[R]);return!0}return!1}get isFetching(){return this.fetchStatus===m_.FETCHING||this.fetchStatus===m_.REFETCHING}get isRefetching(){return this.fetchStatus===m_.REFETCHING}get needsFetching(){return this.fetchStatus===m_.FETCH_NEEDED||this.fetchStatus===m_.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===m_.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===m_.DONE||this.fetchStatus===m_.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===m_.REFETCHING?m_.REFETCH_NEEDED:m_.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function FeatureTile_E(R,G,H){if(null==G||null==R||H!==G.length||H>R.length)return!1;for(let W=0;W<H;++W)if(R[W]!==G[W])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(R){return null==R||!this.descriptor.extent||((0,Fe.VY)(R,g_),(0,Fe.HY)(this.descriptor.extent,g_))}intersectionIncludingBorrowed(R,G){const H=null!=this.extentIncludingBorrowedFeatures?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return R||H?(null!=R?((0,Fe.VY)(R,G),(0,Fe.E$)(G,H,G)):(0,Fe.C)(G,H),G):((0,Fe.C)(G,Fe.sI),G)}_shuffle(R){this._features&&(this._features.sort(((G,H)=>(0,Mi.RW)(G,R)-(0,Mi.RW)(H,R))),(0,ce.k4)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0)}reduceFeatures(R,G,H){if(R<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let W=!1;this.featureLimit=Math.ceil(this.numFeatures*R),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===m_.DONE&&this._features.length>0&&(this.fetchStatus=m_.REFETCH_NEEDED,W=!0)),!this._shuffled&&R<1&&this._shuffle(H);const q=Math.max(this.featureLimit,Math.ceil(G*this.numFeatures));return this._features.length>q&&(this._features.length=q,this._featuresLength.value=q,this.featuresMissing=!0,this.fetchStatus===m_.FULL&&(this.fetchStatus=m_.DONE)),W}get cache(){return{availableFields:this._availableFields,features:this._features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio.value,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(R){var G,H;this.requestController=null,this._availableFields=R.availableFields,this._features=R.features,this._featuresLength.value=null!==(G=null===(H=R.features)||void 0===H?void 0:H.length)&&void 0!==G?G:0,this._numFeatures=R.numFeatures,this._emptyFeatureRatio.value=R.emptyFeatureRatio,this.fetchStatus=R.fetchStatus,this.featuresMissing=R.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const __=-1;var m_;!function(R){R[R.FETCH_NEEDED=0]="FETCH_NEEDED",R[R.REFETCH_NEEDED=1]="REFETCH_NEEDED",R[R.FETCHING=2]="FETCHING",R[R.REFETCHING=3]="REFETCHING",R[R.DONE=4]="DONE",R[R.FULL=5]="FULL"}(m_||(m_={}));const g_=(0,Fe.vt)();var f_;!function(R){R[R.BACK_TO_FRONT=-1]="BACK_TO_FRONT",R[R.NONE=0]="NONE",R[R.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(f_||(f_={}));let y_=class extends Q.A{set maximumNumberOfFeatures(R){R=R||1/0;const G=this._get("maximumNumberOfFeatures");R===G||R<1||(this._set("maximumNumberOfFeatures",R),this._maximumFeaturesUpdated(G,R))}set memoryFactor(R){this.memoryFactor!==R&&(this._set("memoryFactor",R),this._setDirty())}set lodFactor(R){this.lodFactor!==R&&(this._set("lodFactor",R),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&null!=this.context.query.queryFeatureCount}set useTileCount(R){this._useTileCount=R,this.notifyChange("useTileCount")}get updating(){var R,G;return this._dirty||!!this._pendingEdits||this._isFetching||null!==(R=null===(G=this.tileDescriptors)||void 0===G?void 0:G.updating)&&void 0!==R&&R}get memoryForUnusedFeatures(){let R=0;return this._featureTiles.forEach((G=>R+=G.estimatedUnusedSize)),R}get totalVertices(){let R=0;return this._featureTiles.forEach((G=>R+=G.numVertices)),R}get totalFeatures(){let R=0;return this._featureTiles.forEach((G=>R+=G.numFeatures)),R}get hasAllFeatures(){if(this._paused||this.dataUpdating)return!1;for(const[,R]of this._featureTiles)if(!this.hasFullGeometries&&0!==R.emptyFeatureRatio||!R.hasAllFeatures)return!1;return!0}get hasFullGeometries(){return!this._supportsResolution||(!this.tileDescriptors.find((R=>null!=R.resolution))||!this.context.capabilities.supportsQuantization&&"polyline"!==this.context.geometryType)}set filterExtent(R){if(null!=R&&this.context.tilingScheme&&!R.spatialReference.equals(this.context.tilingScheme.spatialReference))return void J.A.getLogger(this).error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const G=this._get("filterExtent");if(G===R||null!=G&&R&&G.equals(R))return;const H=null!=R?R.clone():null;this._set("filterExtent",H),this._reclip(H,G)}constructor(R){super(R),this._useTileCount=!1,this.dataUpdating=!1,this.running=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this._fullRatio=1,this._farRatio=1,this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._frameTask=ot.nu,this._dirty=!1,this._featureTiles=new s_.A,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._suspended=!0,this._pendingEdits=null,this._applyEditsTilesUpdated=!1,this._isFetching=!1}initialize(){this.addHandles((0,$.on)((()=>this.tileDescriptors),"change",(()=>this._setDirty()),{sync:!0,onListenerAdd:()=>this._setDirty()})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?featureReference_t:featureReference_s;const R=this.context.scheduler;null!=R&&(this._frameTask=R.registerTask(ot.W6.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){var R;this._frameTask.remove(),this._featureTiles.forEach((R=>{this._cancelFetchTile(R),this._removeTile(R)})),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),null!==(R=this._pendingEdits)&&void 0!==R&&R.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach((R=>{this._cancelFetchTile(R),this._clearTile(R),this._resetFetchTile(R)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach((R=>{this._cancelFetchTile(R),this._resetFetchTile(R)})),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}getMissingAttributesForFeature(R){for(const[,H]of this._featureTiles){var G;const W=null===(G=H.missingAttributes)||void 0===G?void 0:G.get(R);if(null!=W)return W}}_pause(){this._paused&&(this._featureTiles.forEach((R=>this._cancelFetchTile(R))),this._updated())}_unpause(){this._paused||(this._setDirty(),this._updated())}get availableFields(){let R=null;return this._featureTiles.forEach((G=>{null!=G.displayingFeatures&&0!==G.displayingFeatures.length&&(null==R?R=new Set(G.availableFields):R.forEach((H=>{G.availableFields.has(H)||R.delete(H)})))})),null!=R?R:new Set}applyEdits(R){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const G=this._pendingEdits;G.count++;const H=G.edits.then((()=>R.result.catch((R=>{if((0,X.zf)(R))throw R;return null})).then((R=>R?(this._applyEditsDeleteFeatures(R.deletedFeatures),this._applyEditsAddUpdateFeatures(R.addedFeatures,R.updatedFeatures,G.controller.signal).then((()=>R))):R)).then((R=>(0==--G.count&&(this._pendingEdits===G&&(this._pendingEdits=null),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._applyEditsTilesUpdated=!1,this._unpause()),R)))));return G.edits=H,this._updated(),H}_applyEditsDeleteFeatures(R){if(0===R.length)return;const G=this.context.globalIdField,H=G&&this.availableFields.has(G),W=new Set,q=this._objectIdField;R.forEach((R=>{let{objectId:Q,globalId:X}=R;(!Q||Q<0)&&G&&X&&(H||J.A.getLogger(this).errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(G," to be included the layer's outFields for updates to be reflected in the view")),Q=this._objectIdFromGlobalId(X,q,G)),null!=Q&&Q>=0&&W.add(Q)})),this._featureTiles.forEach((R=>{if(!R.features)return;const G=R.features.filter((R=>!W.has((0,Mi.RW)(R,this._objectIdField))));G.length!==R.features.length&&(this._applyEditsTileUpdated(),R.setFeatures(G,0,R.availableFields,R.missingAttributes),this._invalidateCounts())}))}_objectIdFromGlobalId(R,G,H){if(null==R)return null;const W=this.features.find((G=>{var W;return(null===(W=G.attributes)||void 0===W?void 0:W[H])===R}));return W?(0,Mi.RW)(W,G):null}async _applyEditsAddUpdateFeatures(R,G,H){const{objectIdField:W,globalIdField:q}=this.context,Q=q&&this.availableFields.has(q),X=new Set,$=new Set;for(const J of R){const R=J.objectId;null!=R&&X.add(R)}for(const{objectId:ee,globalId:te}of G){let R=ee;(null==R||R<0)&&q&&(Q||J.A.getLogger(this).errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(q," to be included the layer's outFields for updates to be reflected in the view")),R=this._objectIdFromGlobalId(te,W,q)),null!=R&&R>=0&&(X.add(R),$.add(R))}if(0===X.size)return;const K=[];this._featureTiles.forEach((R=>{const G=this._applyEditsAddUpdateTile(R,X,$,H);G&&K.push(G)})),this._updated(),await Promise.allSettled(K)}async _applyEditsAddUpdateTile(R,G,H,W){if(!R.features)return;const q=this._createQuery(R);q.resultType=void 0,q.cacheHint=!1,q.objectIds=Array.from(G);const Q=await this._queryFeatures(q,W);let J=null;if(H.size>0){const G=R.features.filter((R=>!H.has((0,Mi.RW)(R,this._objectIdField))));G.length!==R.features.length&&(J=G)}if(Q.features.length>0){J||(J=R.features.slice());for(const R of Q.features)J.push(R)}J&&(R.hasPreciseFeatureCount&&(R.numFeatures=Math.max(R.numFeatures,J.length)),this._applyEditsTileUpdated(),R.setFeatures(J,0,FeatureTileFetcher3D_q(R.availableFields,Q.fields),FeatureTileFetcher3D_L(R.missingAttributes,Q.missingAttributes)),this._invalidateCounts())}_applyEditsTileUpdated(){this._applyEditsTilesUpdated||(this._applyEditsTilesUpdated=!0,this._updated())}_queryFeatures(R,G){return this.context.query.queryFeaturesDehydrated(R,{signal:G,timeout:S_})}_setDirty(){this._dirty=!0,this._updated()}runTask(R){const G=this._frameTask.processQueue(R);if(!this._dirty||!this.initialized)return G;this._dirty=!1;const H=this._getListOfTiles();if(this._markTilesNotAlive(H),!R.run((()=>this._addTiles(H,R)))||!R.run((()=>this._filterExtentTiles(H,R)))||!R.run((()=>this._removeTiles(H,R)))||R.done)return void this._setDirty();const W=this._sortTiles(H);R.run((()=>this._showTiles(W,R)))&&R.run((()=>this._fetchTiles(W,R)))&&R.run((()=>this._updateMemoryEstimates(W,R)))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(R){for(const G of R)G.alive=!1}_addTiles(R,G){return!(this._suspended||!this.tileDescriptors)&&(this.tileDescriptors.forEach((H=>{const W=this._featureTiles.get(H.id);W?W.alive=!0:G.done||(R.push(this._addTile(H)),G.madeProgress())})),G.hasProgressed)}_filterExtentTiles(R,G){for(const H of R){if(G.done)break;H.alive&&(H.filtered=!H.intersects(this.filterExtent),H.filtered&&(this._clearTile(H),G.madeProgress()))}return G.hasProgressed}_removeTiles(R,G){for(let H=R.length-1;H>=0&&!G.done;H--){const W=R[H];W.alive||(this._removeTile(W),H!==R.length-1&&(R[H]=R[R.length-1]),R.pop(),G.madeProgress())}return G.hasProgressed}_sortTiles(R){return R.sort(((R,G)=>{var H,W;return(null!==(H=R.descriptor.loadPriority)&&void 0!==H?H:0)-(null!==(W=G.descriptor.loadPriority)&&void 0!==W?W:0)})),R}_showTiles(R,G){const H=this._updateRatio(R),i=R=>{const G=this._fullRatio<1?H(R)*this._farRatio:1;return R.reduceFeatures(G,this.memoryFactor,this._objectIdField)&&this._setDirty(),this._showTile(R)};for(const W of R)if(!G.run((()=>i(W)))){this._setDirty();break}return G.hasProgressed}_fetchTiles(R,G){if(this._paused)return!1;let H=!1;for(const W of R){if(!W.needsFetching)continue;const R=null!=this.context.memoryCache?this.context.memoryCache.pop(W.id):null;if(null==R){if(this._needsNumFeatures(W)){const R=new AbortController,q=this._fetchTileCount(W,R.signal);this._handleRequest(W,q,R,(()=>W.numFeatures=-2)),H=!0,G.madeProgress()}if(G.done)return!0}else W.cache=R,this._setDirty(),this._scheduleUpdated(),G.madeProgress()}if(H)return G.hasProgressed;for(const W of R)if(W.needsFetching){const R=new AbortController,H=this._fetchTile(W,R.signal);if(this._handleRequest(W,H,R,(R=>{W.setFeatures([],0,null,void 0),this._invalidateCounts(),W.featuresMissing=!1,W.fetchFailed=!0,this.context.logFetchError(J.A.getLogger(this),R)})),G.madeProgress())return!0}return G.hasProgressed}_updateMemoryEstimates(R,G){return R.some((R=>!G.run((()=>R.updateMemoryEstimates()))&&(this._setDirty(),!0))),G.hasProgressed}_reclip(R,G){if(!this.initialized)return;const H=new Array;this._featureTiles.forEach((W=>{null!=W.displayingFeatures&&0!==W.displayingFeatures.length&&(W.intersectionIncludingBorrowed(G,b_),W.intersectionIncludingBorrowed(R,x_),(0,Fe.aI)(b_,x_)||H.push(W))})),this._refreshDisplayingFeatures(H),this._updated()}_refreshDisplayingFeatures(R){const G=new Set,H=this._changes.updates;for(const W of R)if(null!=W.displayingFeatures)for(const R of W.displayingFeatures){const W=(0,Mi.RW)(R,this._objectIdField);if(G.has(W))continue;G.add(W);const q=this._displayingFeatureReferences.get(W).feature;H.removes.push(q),H.adds.push(q)}this._applyChanges()}_updated(){let R=0;if(this._paused||this._featureTiles.forEach((G=>G.isFetching?++R:0)),this._isFetching=R>0,this._set("running",this._dirty),R>0||this._applyEditsTilesUpdated?this._set("dataUpdating",!0):this._dirty||this._set("dataUpdating",!1),this.updating){let G=0,H=0,W=0,q=0,Q=0;const J=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach((R=>{if(++H,R.isFetching&&R.hasPreciseFeatureCount){const G=this._maximumFeaturesForTile(R)*(1-R.emptyFeatureRatio),H=null!=R.displayingFeatures?R.displayingFeatures.length*J:0;Q+=G-H}R.needsFetching?++q:R.numFeatures>0&&(++W,G+=R.numFeatures)})),q+=R;let X=0,$=0;G?($=G,X=Math.min(q*G/W,G)):($=H,X=q),Q=Math.min(this.maximumNumberOfFeatures-this.features.length,Q),this._set("updatingTotal",$),this._set("updatingRemaining",X),this._set("expectedFeatureDiff",Q)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const R=(0,Ti.Bs)(this._featureTiles,(R=>R.perTileMaximumNumberOfFeaturesExceeded));this._set("maximumNumberOfFeaturesExceeded",R)}_updateRatio(R){const G=function FeatureTileFetcher3D_U(R){let G=0;for(const H of R)H.features&&H.features.length>0&&H.alive&&(G=Math.max(G,H.descriptor.lij[0]));return G}(R),s=R=>1/(1<<Math.max(0,G-R.descriptor.lij[0]));let H=0,W=0;for(const q of R){const R=q.numFeatures;H+=R,W+=R*s(q)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/H),this._farRatio=this.maximumNumberOfFeatures/W,this._scheduleUpdated(),s}_maximumFeaturesUpdated(R,G){R!==G&&(G>R&&this._featureTiles.forEach((R=>{if(!R.featuresMissing)return;const G=this._maximumFeaturesForTile(R);R.features&&(R.features.length>=G||R.fetchStatus===m_.FULL)||(this._cancelFetchTile(R),this._resetFetchTile(R))})),this._setDirty())}_addTile(R){const G=new FeatureTile_m(R);return this._featureTiles.set(G.id,G),this._resetFetchTile(G),this._referenceDisplayingFeaturesFromRelatedTiles(G),G}_referenceDisplayingFeaturesFromRelatedTiles(R){const G=R.descriptor.resolution;this._featureTiles.forEach((H=>{if(!(null==H.displayingFeatures||R===H||R.descriptor.lij&&H.descriptor.lij&&!function tileUtils_x(R,G){if(!R||!G||R[0]===G[0])return!1;const H=R[0]<G[0],W=H?R:G,q=H?G:R,Q=1<<q[0]-W[0];return Math.floor(q[1]/Q)===W[1]&&Math.floor(q[2]/Q)===W[2]}(R.descriptor.lij,H.descriptor.lij))){null==R.displayingFeatures&&(R.displayingFeatures=[]),R.descriptor.extent&&H.descriptor.extent&&(null==R.extentIncludingBorrowedFeatures&&(R.extentIncludingBorrowedFeatures=(0,Fe.o8)(R.descriptor.extent)),(0,Fe.fT)(R.extentIncludingBorrowedFeatures,H.descriptor.extent,R.extentIncludingBorrowedFeatures));for(const W of H.displayingFeatures){R.displayingFeatures.push(W);const H=this._displayingFeatureReferences.get((0,Mi.RW)(W,this._objectIdField));H.ref(H.feature,G),this._numDisplayingFeatureReferences++}}})),R.featureLimit=null!=R.displayingFeatures?R.displayingFeatures.length:0}_removeTile(R){this._clearTile(R),this._featureTiles.delete(R.id)}_resetFetchTile(R){R.filtered=!R.intersects(this.filterExtent),R.filtered?R.needsFetching&&(R.fetchStatus=m_.DONE):R.fetchStatus=m_.FETCH_NEEDED}_cancelFetchTile(R){const G=R.requestController;null!=G&&(R.requestController=null,R.resetFetching(),G.abort())}async _fetchTileCount(R,G){return R.numFeatures=await this._fetchCount(R,G),this._updateRatio(this._getListOfTiles()),R.fetchStatus===m_.REFETCHING?m_.REFETCH_NEEDED:m_.FETCH_NEEDED}async _fetchTile(R,G){R.fetchFailed=!1;const H=this._maximumFeaturesForTile(R);if(H<=0)return R.hasPreciseFeatureCount&&0===R.numFeatures||(R.fetchFailed=!0),function FeatureTileFetcher3D_A(R){return R.setFeatures([],0,null,void 0),R.featuresMissing=!1,m_.DONE}(R);const W=this._getMaxRecordCount(R),q=Math.ceil(H/W);if(FeatureTileFetcher3D_O(R)||!this.context.capabilities.supportsMaxRecordCountFactor||R.numFeatures<=H&&q>o_.A.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(R,G);const Q=this._createQuery(R);if(Q.maxRecordCountFactor=Math.ceil(H/W),R.isRefetching&&R.features&&R.features.length>0){const G=Math.ceil(R.features.length/(1-R.emptyFeatureRatio)/W);Q.maxRecordCountFactor=Math.max(G+1,Q.maxRecordCountFactor)}const{features:J,exceededTransferLimit:$,fields:K,missingAttributes:ee}=await this._queryFeatures(Q,G),te=$?Q.maxRecordCountFactor>=o_.A.MAX_MAX_RECORD_COUNT_FACTOR?m_.FULL:m_.DONE:m_.FULL;return await this._frameTask.schedule((()=>{R.featuresMissing=R.hasPreciseFeatureCount&&J.length<R.numFeatures||!!$;const G=this._removeEmptyFeatures(J);R.setFeatures(J,G,FeatureTileFetcher3D_N(K),FeatureTileFetcher3D_L(void 0,ee))}),G),(0,X.Te)(G),this._invalidateCounts(),te}async _fetchCount(R,G){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(R),{signal:G})}async _fetchPagedTile(R,G){let H,W=0,q=0,Q=0,J=this._maximumFeaturesForTile(R)-Q;const $=this._getMaxRecordCount(R);let K,ee=null;for(;;){const te=this._createQuery(R),ie=this._setPagingParameters(te,W,J,$),{features:re,exceededTransferLimit:ne,fields:se,missingAttributes:ae}=await this._queryFeatures(te,G);if(await this._frameTask.schedule((()=>{ie&&(W+=te.num),Q+=re.length,q+=this._removeEmptyFeatures(re),R.featuresMissing=ie&&R.hasPreciseFeatureCount&&W<R.numFeatures||!!ne,H=H?H.concat(re):re,ee=FeatureTileFetcher3D_q(ee,se),K=FeatureTileFetcher3D_L(K,ae),R.setFeatures(H,q,ee,K)}),G),(0,X.Te)(G),this._invalidateCounts(),this._setDirty(),J=this._maximumFeaturesForTile(R)-Q,!ie||!ne||J<=0)return ne?m_.DONE:m_.FULL}}_createFeatureCountQuery(R){const G=this._createQuery(R);return this.context.capabilities.supportsCacheHint&&(G.resultType=void 0,G.cacheHint=!0),G}_createQuery(R){const G=this.context.createQuery(),H=R.descriptor.extent;if(H){const R=this.context.tilingScheme.spatialReference;G.geometry=(0,Fe.w1)(H,R)}return this._setResolutionParams(G,R),this._useTileQuery(R)?G.resultType="tile":this.context.capabilities.supportsCacheHint&&(G.cacheHint=!0),G}_setPagingParameters(R,G,H,W){return!!this.context.capabilities.supportsPagination&&(R.start=G,H>0&&this.context.capabilities.supportsMaxRecordCountFactor?(R.maxRecordCountFactor=Math.ceil(H/W),R.num=Math.min(R.maxRecordCountFactor*W,H)):R.num=Math.min(W),!0)}_getEffectiveTileResolution(R){if(null==R.descriptor.resolution)return null;const G=this.context.viewingMode===qe.RT.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(R.descriptor.resolution,G)/this.lodFactor}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(R,G){if(!this._supportsResolution)return;const H=this._getEffectiveTileResolution(G);null!=H&&(this.context.capabilities.supportsQuantization?R.quantizationParameters=new a_.A({mode:"view",originPosition:"upper-left",tolerance:H,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(R.maxAllowableOffset=H))}_removeEmptyFeatures(R){const G=R.length;for(let H=0;H<R.length;){const G=R[H];(0,Mi.ao)(G.geometry)?++H:(R[H]=R[R.length-1],--R.length)}return G-R.length}_needsNumFeatures(R){return this.useTileCount&&R.needsFeatureCount&&!FeatureTileFetcher3D_O(R)}_getMaxRecordCount(R){const{tileMaxRecordCount:G,maxRecordCount:H}=this.context;return this._useTileQuery(R)&&null!=G&&G>0&&this.context.capabilities.supportsResultType?G:null!=H&&H>0?H:v_}_useTileQuery(R){return(!FeatureTileFetcher3D_O(R)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(R,G,H,W){R.fetchStatus=R.needsRefetching?m_.REFETCHING:m_.FETCHING,R.requestController=H;let q=!1;G.then((G=>{R.requestController=null,R.fetchStatus=G})).catch((G=>{R.requestController===H&&(R.requestController=null,R.fetchStatus=m_.DONE),(0,X.zf)(G)?q=!0:W(G)})).then((()=>{q||this._setDirty(),this._scheduleUpdated()}))}_scheduleUpdated(){this.hasHandles("scheduleUpdated")||this.addHandles((0,K._)((()=>{this.removeHandles("scheduleUpdated"),this._updated()})),"scheduleUpdated")}_showTile(R){if(null!=R.displayingFeatures&&!R.needsDisplayUpdate)return!1;const G=R.features;if(0===R.featureLimit||!G){const G=null!=R.displayingFeatures&&R.displayingFeatures.length>0;return this._hideTileFeatures(R),R.displayingFeatures=[],G}const H=R.descriptor.resolution,W=this._changes.updates,q=this._changes.adds,Q=Math.min(R.featureLimit,G.length);R.featureLimit=Q;for(let J=0;J<Q;++J){const R=G[J],Q=(0,Mi.RW)(R,this._objectIdField),X=this._displayingFeatureReferences.get(Q);if(X){const G=X.ref(R,H);G.oldVersion!==G.newVersion&&(G.oldVersion&&W.removes.push(G.oldVersion),G.newVersion&&W.adds.push(G.newVersion))}else this._displayingFeatureReferences.set(Q,new this.FeatureReferenceClass(R,H)),q.push(R);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(R),this._applyChanges(),R.displayingFeatures=G.slice(0,Q),!0}_hideTile(R){this._cancelFetchTile(R),this._hideTileFeatures(R)}_hideTileFeatures(R){if(null==R.displayingFeatures)return;const G=this._changes.updates,H=this._changes.removes;for(const W of R.displayingFeatures){const q=(0,Mi.RW)(W,this._objectIdField),Q=this._displayingFeatureReferences.get(q);if(!Q)continue;const J=Q.unref(R.descriptor.resolution);this._numDisplayingFeatureReferences--,J?J.oldVersion!==J.newVersion&&(null==J.newVersion?(this._displayingFeatureReferences.delete(q),J.oldVersion&&H.push(J.oldVersion)):(G.adds.push(J.newVersion),J.oldVersion&&G.removes.push(J.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),R.displayingFeatures=null}_applyChanges(){const R=this._changes.updates;R.removes.length>0&&(this.features.removeMany(R.removes),R.removes.length=0),R.adds.length>0&&(this.features.addMany(R.adds),R.adds.length=0);const G=this._changes.adds,H=this._changes.removes,W=Math.min(G.length,H.length);let q=0;for(;q<W;){const R=Math.min(q+C_,W);this.features.addMany(G.slice(q,R)),this.features.removeMany(H.slice(q,R)),q=R}G.length>W&&this.features.addMany(0===q?G:G.slice(q)),H.length>W&&this.features.removeMany(0===q?H:H.slice(q)),G.length=0,H.length=0}_clearTile(R){if(this._hideTile(R),R.features&&null!=this.context.memoryCache){const G=16+R.estimatedSize;this.context.memoryCache.put(R.id,R.cache,G)}R.setFeatures(null,0,null,void 0),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this._featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce(((R,G)=>R+(G.features?G.features.length:0)),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce(((R,G)=>R+(G.needsFetching||G.isFetching?1:0)),0)}_maximumFeaturesForTile(R){const G=R.hasPreciseFeatureCount?R.numFeatures:1/0,H=R.hasPreciseFeatureCount?G:this.maximumNumberOfFeatures,W=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(H*W/(1-R.emptyFeatureRatio)),G)}get test(){return{process:R=>this.runTask(R),getFeatureTileById:R=>this._featureTiles.get(R),forEachFeatureTile:R=>this._featureTiles.forEach(R)}}};function FeatureTileFetcher3D_O(R){return"dummy-tile-full-extent"===R.id}function FeatureTileFetcher3D_I(R){switch(R.geometryType){case"polyline":return!0;case"polygon":return R.capabilities&&R.capabilities.query&&R.capabilities.query.supportsQuantization;default:return!1}}function FeatureTileFetcher3D_N(R){return null==R?new Set:new Set(R.map((R=>R.name)))}function FeatureTileFetcher3D_q(R,G){if(null==R||null==G)return FeatureTileFetcher3D_N(G);const H=new Set;for(const{name:W}of G)R.has(W)&&H.add(W);return H}function FeatureTileFetcher3D_L(R,G){var H;if(null===G||void 0===G||!G.length)return R;null!==(H=R)&&void 0!==H||(R=new Map);const s=()=>new Set;for(const{objectId:W,attribute:q}of G)(0,Ti.tE)(R,W,s).add(q);return R}(0,W._)([(0,ee.MZ)({constructOnly:!0})],y_.prototype,"features",void 0),(0,W._)([(0,ee.MZ)()],y_.prototype,"tileDescriptors",void 0),(0,W._)([(0,ee.MZ)({value:1/0})],y_.prototype,"maximumNumberOfFeatures",null),(0,W._)([(0,ee.MZ)({value:1})],y_.prototype,"memoryFactor",null),(0,W._)([(0,ee.MZ)({value:1})],y_.prototype,"lodFactor",null),(0,W._)([(0,ee.MZ)()],y_.prototype,"useTileCount",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"updating",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"dataUpdating",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"running",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"updatingTotal",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"updatingRemaining",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"expectedFeatureDiff",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"memoryForUnusedFeatures",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"totalVertices",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"totalFeatures",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"hasAllFeatures",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],y_.prototype,"hasFullGeometries",null),(0,W._)([(0,ee.MZ)()],y_.prototype,"filterExtent",null),(0,W._)([(0,ee.MZ)({constructOnly:!0})],y_.prototype,"context",void 0),(0,W._)([(0,ee.MZ)()],y_.prototype,"_dirty",void 0),(0,W._)([(0,ee.MZ)()],y_.prototype,"_suspended",void 0),(0,W._)([(0,ee.MZ)()],y_.prototype,"_pendingEdits",void 0),(0,W._)([(0,ee.MZ)()],y_.prototype,"_applyEditsTilesUpdated",void 0),(0,W._)([(0,ee.MZ)()],y_.prototype,"_paused",null),(0,W._)([(0,ee.MZ)()],y_.prototype,"_isFetching",void 0),y_=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.FeatureTileFetcher3D")],y_);const v_=2e3,b_=(0,Fe.vt)(),x_=(0,Fe.vt)(),S_=6e5,C_=200;var w_=H(52252),A_=H(52966),R_=H(80417),T_=H(86168),E_=H(22179);class TilingScheme_v{constructor(R){const G=TilingScheme_v.checkUnsupported(R);if(null!=G)throw G;const H=R;this.spatialReference=H.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=(0,Ei.canProjectToWGS84ComparableLonLat)(this.spatialReference)||(0,Te.q8)(this.spatialReference)||(0,Te.KQ)(this.spatialReference),this.origin=[H.origin.x,H.origin.y],this.pixelSize=H.size[0],this.dpi=H.dpi;const W=H.lods.reduce(((R,G,H)=>(G.level<R.min&&(R.min=G.level,R.minIndex=H),R.max=Math.max(R.max,G.level),R)),{min:1/0,minIndex:0,max:-1/0}),q=H.lods[W.minIndex],Q=2**q.level;let J=q.resolution*Q,X=q.scale*Q;this.levels=new Array(W.max+1);for(let $=0;$<this.levels.length;$++)this.levels[$]={resolution:J,scale:X,tileSize:[J*H.size[0],J*H.size[1]]},J/=2,X/=2}clone(){return new TilingScheme_v(this.toTileInfo())}toTileInfo(){return new E_.A({dpi:this.dpi,origin:new yp.A({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map(((R,G)=>new T_.A({level:G,scale:R.scale,resolution:R.resolution})))})}getExtent(R,G,H,W){const q=this.levels[R],Q=q.tileSize[0],J=q.tileSize[1];W[0]=this.origin[0]+H*Q,W[2]=this.origin[0]+(H+1)*Q,W[3]=this.origin[1]-G*J,W[1]=this.origin[1]-(G+1)*J}convertExtentToRadians(R,G){this._isWebMercator?(G[0]=(0,R_.yw)(R[0]),G[1]=(0,R_.jg)(R[1]),G[2]=(0,R_.yw)(R[2]),G[3]=(0,R_.jg)(R[3])):this._isGCS&&(G[0]=(0,Ee.kU)(R[0]),G[1]=(0,Ee.kU)(R[1]),G[2]=(0,Ee.kU)(R[2]),G[3]=(0,Ee.kU)(R[3]))}getExtentGeometry(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new jc.A;return this.getExtent(R,G,H,O_),W.spatialReference=this.spatialReference,W.xmin=O_[0],W.ymin=O_[1],W.xmax=O_[2],W.ymax=O_[3],W.zmin=void 0,W.zmax=void 0,W}ensureMaxLod(R){if(null==R)return!1;let G=!1;for(;this.levels.length<=R;){const R=this.levels[this.levels.length-1],H=R.resolution/2;this.levels.push({resolution:H,scale:R.scale/2,tileSize:[H*this.pixelSize,H*this.pixelSize]}),G=!0}return G}capMaxLod(R){this.levels.length>R+1&&(this.levels.length=R+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(R){return this.levels[0].scale/2**R}levelAtScale(R){const G=this.levels[0].scale;return R>=G?0:Math.log(G/R)*Math.LOG2E}resolutionAtLevel(R){return this.levels[0].resolution/2**R}compatibleWith(R){if(!(R instanceof TilingScheme_v)){if(TilingScheme_v.checkUnsupported(R))return!1;R=new TilingScheme_v(R)}if(!R.spatialReference.equals(this.spatialReference))return!1;if(R.pixelSize!==this.pixelSize)return!1;const G=Math.min(this.levels.length,R.levels.length)-1,H=this.levels[G].resolution;let W=.5*H;return!(!(0,Ee.Sp)(R.origin[0],this.origin[0],W)||!(0,Ee.Sp)(R.origin[1],this.origin[1],W))&&(W=.5*H/2**G/this.pixelSize*12,(0,Ee.Sp)(H,R.levels[G].resolution,W))}rootTilesInExtent(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;const W=new Array,q=this.levels[0].tileSize;if(null==R||0===q[0]||0===q[1])return W;TilingScheme_v.computeRowColExtent(R,q,this.origin,O_);let Q=O_[1],J=O_[3],X=O_[0],$=O_[2];const K=$-X,ee=J-Q;if(K*ee>H){const R=Math.floor(Math.sqrt(H));ee>R&&(Q=Q+Math.floor(.5*ee)-Math.floor(.5*R),J=Q+R),K>R&&(X=X+Math.floor(.5*K)-Math.floor(.5*R),$=X+R)}for(let te=Q;te<J;te++)for(let R=X;R<$;R++)W.push([0,te,R]);return null!=G&&(G[0]=this.origin[0]+X*q[0],G[1]=this.origin[1]-J*q[1],G[2]=this.origin[0]+$*q[0],G[3]=this.origin[1]-Q*q[1]),W}static computeRowColExtent(R,G,H,W){const q=.001*(R[2]-R[0]+(R[3]-R[1]));W[0]=Math.max(0,Math.floor((R[0]+q-H[0])/G[0])),W[2]=Math.max(0,Math.ceil((R[2]-q-H[0])/G[0])),W[1]=Math.max(0,Math.floor((H[1]-R[3]+q)/G[1])),W[3]=Math.max(0,Math.ceil((H[1]-R[1]-q)/G[1]))}static isPowerOfTwo(R){const G=R.lods,H=G[0].resolution*2**G[0].level;return!G.some((R=>!(0,Ee.b6)(R.resolution,H/2**R.level)))}static hasGapInLevels(R){const G=R.lods.map((R=>R.level));G.sort(((R,G)=>R-G));for(let H=1;H<G.length;H++)if(G[H]!==G[0]+H)return!0;return!1}static tileSizeSupported(R){const G=R.size[1];return G===R.size[0]&&0==(G&G-1)&&G>=128&&G<=512}static hasOriginPerLODs(R){const G=R.origin;return R.lods.some((R=>null!=R.origin&&(R.origin[0]!==G.x||R.origin[1]!==G.y)))}static getMissingTileInfoError(){return new Ze.A("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(R){return null==R?function TilingScheme_w(){return new Ze.A("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}():R.lods.length<1?new Ze.A("tilingscheme:generic","Tiling scheme must have at least one level"):TilingScheme_v.isPowerOfTwo(R)?TilingScheme_v.hasGapInLevels(R)?new Ze.A("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):TilingScheme_v.tileSizeSupported(R)?TilingScheme_v.hasOriginPerLODs(R)?new Ze.A("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new Ze.A("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new Ze.A("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(R,G){const H=R[2]-R[0],W=R[3]-R[1],q=(0,me.GA)(G),Q=1.2*Math.max(H,W),J=256,X=new TilingScheme_v(new E_.A({size:[J,J],origin:new yp.A({x:R[0]-.5*(Q-H),y:R[3]+.5*(Q-W)}),lods:[new T_.A({level:0,resolution:Q/J,scale:1/(J/96*.0254/(Q*q))})],spatialReference:G}));return X.ensureMaxLod(20),X}static makeWebMercatorAuxiliarySphere(R){const G=new TilingScheme_v(TilingScheme_v.WebMercatorAuxiliarySphereTileInfo);return G.ensureMaxLod(R),G}static makeGCSWithTileSize(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:256,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16;const W=256/G,q=new TilingScheme_v(new E_.A({size:[G,G],origin:new yp.A({x:-180,y:90,spatialReference:R}),spatialReference:R,lods:[new T_.A({level:0,resolution:.703125*W,scale:295497598.570834*W})]}));return q.ensureMaxLod(H),q}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}TilingScheme_v.WebMercatorAuxiliarySphereTileInfo=new E_.A({size:[256,256],origin:new yp.A({x:-20037508.342787,y:20037508.342787,spatialReference:Jt.A.WebMercator}),spatialReference:Jt.A.WebMercator,lods:[new T_.A({level:0,resolution:156543.03392800014,scale:591657527.591555})]}),TilingScheme_v.WebMercatorAuxiliarySphere=TilingScheme_v.makeWebMercatorAuxiliarySphere(19);const O_=(0,Fe.vt)();var P_=H(17599);const M_=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class FeatureTileFetcher3DDebugger_m{constructor(R,G,H){this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._dataExtentGraphic=null,this._enabled=!0,this._tileFetcher=R,this._view=H,this._tilingScheme=new TilingScheme_v(G),this._loadedSymbols=M_.map((R=>new Vi.A({symbolLayers:new he.A([new Di.A({material:{color:[R[0],R[1],R[2],.6]},outline:{color:"black",size:1}})])}))),this._loadingSymbols=[new Vi.A({symbolLayers:new he.A([new Di.A({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}})])})],this._pendingSymbols=[new Vi.A({symbolLayers:new he.A([new Di.A({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}})])})],this._dataExtentSymbol=new Vi.A({symbolLayers:new he.A([new Di.A({material:{color:[0,0,0,0]},outline:{color:"green",size:4}})])})}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(R){this._enabled=R,this.update()}update(){this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:R=>R.isFetching,symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:R=>!R.isFetching,symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:R=>!R.isFetching,symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach((R=>{this._view.graphics.removeMany(R)})),this._loadingGraphics.clear(),this._loadedGraphics.forEach((R=>{this._view.graphics.removeMany(R)})),this._loadedGraphics.clear(),this._pendingGraphics.forEach((R=>{this._view.graphics.removeMany(R)})),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}showDataExtent(R){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),null==R)return;const G=Jn.A.fromExtent(R);this._dataExtentGraphic=new le.A({geometry:G,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}_synchronizeMaps(R,G){const H=[];R.forEach(((R,W)=>{const q=this._tileFetcher.test.getFeatureTileById(W);q&&G.filter(q)||(this._view.graphics.removeMany(R),H.push(W))})),H.forEach((G=>R.delete(G))),this._tileFetcher.test.forEachFeatureTile((H=>{if(G.filter(H)&&!R.has(H.id)){const[W,q,Q]=H.descriptor.lij;this._tilingScheme.ensureMaxLod(W);const J=this._tilingScheme.getExtentGeometry(W,q,Q),X=[new le.A({geometry:J,symbol:G.symbols[W%G.symbols.length]}),new le.A({geometry:J.center,symbol:new Ni.A({verticalOffset:new A_.A({screenLength:40/.75}),callout:new P_.A({color:"white",border:{color:"black"}}),symbolLayers:new he.A([new w_.A({text:"".concat(W,"/").concat(q,"/").concat(Q),halo:{color:"white",size:1/.75},material:{color:"black"},size:16})])})})];R.set(H.id,X),this._view.graphics.addMany(X)}}))}}let I_=class extends((0,ze.g)(Q.A)){get dataUpdating(){var R,G;return null!==(R=null===(G=this._tileFetcher)||void 0===G?void 0:G.dataUpdating)&&void 0!==R&&R}set extent(R){if(null!=R&&!R.spatialReference.equals(this.layerView.view.spatialReference))return void J.A.getLogger(this).error("#extent=","extent needs to be in the same spatial reference as the view");const G=this._get("extent");if(G===R)return;if(null!=G&&R&&G.equals(R))return;const H=null!=R?R.clone():null;this._set("extent",H)}get updating(){return!!(null!=this._tileFetcher&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._updatingHandles&&this._updatingHandles.updating)}get updatingTotal(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&null!=this._tileFetcher?this._tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return null!=this._tileFetcher?this._tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(null==this._tileFetcher||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){var R,G;return null!==(R=null===(G=this.displayFeatureLimit)||void 0===G?void 0:G.maximumNumberOfFeatures)&&void 0!==R?R:0}set maximumNumberOfFeatures(R){R!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",R)}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get hasAllFeatures(){return this.serviceDataCount===F_.noServiceDataCount&&"snapshot"===this.mode&&this.hasAllFeaturesInView||this.serviceDataCount===this.graphics.length}get hasAllFeaturesInView(){var R,G;return null!==(R=null===(G=this._tileFetcher)||void 0===G?void 0:G.hasAllFeatures)&&void 0!==R&&R}get hasFullGeometries(){var R,G;return null!==(R=null===(G=this._tileFetcher)||void 0===G?void 0:G.hasFullGeometries)&&void 0!==R&&R}get mode(){var R;const G=this.layerView.layer;if("feature"===G.type&&null!=G.infoFor3D)return"snapshot";if(this._forceTilesMode)return"tiles";const H=this.layerView.view;if(!1===(null===(R=H.qualitySettings)||void 0===R||null===(R=R.graphics3D)||void 0===R?void 0:R.snapshotAvailable)||this.serviceDataCount===F_.noServiceDataCount||this._snapshotLimitExceeded||this.maximumNumberOfFeaturesExceeded||H.quality<1)return"tiles";const W=H&&H.featureTiles,q=W&&W.tilingScheme;if(G&&G.minScale&&this.serviceDataExtent&&q){const R=this._approximateExtentSizeAtScale(G.minScale,q);if((this.serviceDataExtent.width/R+this.serviceDataExtent.height/R)/2>F_.maxSnapshotMinScaleFactor)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){var R;const G=this._get("maxTotalSnapshotVertices")||0,H="snapshot"===this.mode&&(null===(R=this._tileFetcher)||void 0===R?void 0:R.totalVertices)||0;return Math.max(G,H)}_approximateExtentSizeAtScale(R,G){const H=this.layerView.view,W=Math.ceil((H.width/G.pixelSize+H.height/G.pixelSize)/2),q=G.levels[0];return W*((q.tileSize[0]/(q.scale/R)+q.tileSize[1]/(q.scale/R))/2)}get tileDescriptors(){const R=this.layerView.view.featureTiles;return"snapshot"===this.mode?new he.A([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):R?R.tiles:new he.A}get test(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}constructor(R){super(R),this.type="feature-tile-3d",this._updatingHandles=new we.U,this.serviceDataExtent=null,this.serviceDataCount=F_.noServiceDataCount,this._snapshotLimitExceeded=!1,this.displayFeatureLimit=null,this._forceTilesMode=!1,this._suspended=!1,this._tileFetcher=null,this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null,this._lifeCycleAbortController=new AbortController}initialize(){this._updatingHandles.add((()=>this.displayFeatureLimit),(R=>this._updatingHandles.addPromise(this._updateSnapshotLimit(R,null,this._lifeCycleAbortController.signal)))),this._updatingHandles.add((()=>this.mode),(()=>this._modeChanged()),$.Vh),this._updatingHandles.add((()=>this.mode),((R,G)=>{"tiles"===R&&"snapshot"===G&&(this._forceTilesMode=!0)}),$.Vh),this.addResolvingPromise(Promise.resolve().then((()=>this._verifyCapabilities())).then((()=>this._updatingHandles.addPromise(this._fetchServiceDataInfo()))).then((()=>this._initializeTileFetcher())))}_verifyCapabilities(){var R;const G=this.layerView.layer;if("ogc-feature"!==G.type&&(null===(R=(0,t_.BR)(G))||void 0===R||!R.operations.supportsQuery))throw new Ze.A("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:G})}destroy(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,Qe.pR)(this._tileFetcher),this._tilesHandle=(0,Qe.xt)(this._tilesHandle),this._lifeCycleAbortController=(0,Qe.DC)(this._lifeCycleAbortController),this._updatingHandles.destroy(),this._set("_updatingHandles",null)}suspend(){this._suspended||(this._suspended=!0,null!=this._tileFetcher&&this._tileFetcher.suspend())}resume(){this._suspended&&(this._suspended=!1,null!=this._tileFetcher&&this._tileFetcher.resume())}restart(){const e=()=>{null!=this._tileFetcher&&this._tileFetcher.restart()};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(e,e))}refetch(){this._refetch({resetForceTilesMode:!1})}getMissingAttributesForFeature(R){var G;return null===(G=this._tileFetcher)||void 0===G?void 0:G.getMissingAttributesForFeature(R)}_refetch(R){const t=()=>{null!=this._tileFetcher&&(R.resetForceTilesMode&&(this._forceTilesMode=!1),this._tileFetcher.refetch())};this._updatingHandles.addPromise(this._fetchServiceDataInfo().then(t,t))}_initializeTileFetcher(){const R=this.layerView.view;if(!R)return;const G=(0,$.C_)((()=>{var G;return null===(G=R.featureTiles)||void 0===G?void 0:G.tilingScheme}),this._lifeCycleAbortController.signal);this._updatingHandles.addPromise(G),G.then((()=>{const{layerView:R,tileDescriptors:G}=this,H=R.layer,W=new y_({context:this.context,filterExtent:this.extent,tileDescriptors:G,features:this.graphics});this._tileFetcher=W,this._suspended?W.suspend():W.resume();const q=this.layerView.view;q&&this.addHandles((0,$.wB)((()=>q.quality),(R=>W.memoryFactor=R),$.pc));const Q="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;Q&&this.addHandles((0,$.wB)((()=>{var R;return null===(R=this.layerView.view)||void 0===R||null===(R=R.qualitySettings)||void 0===R||null===(R=R.graphics3D)||void 0===R?void 0:R[Q]}),(R=>W.lodFactor=R||1),$.Vh));"ogc-feature"!==H.type&&this._updatingHandles.add((()=>H.createQueryVersion),(()=>this._dataFilterChanged())),this._updatingHandles.add((()=>R.availableFields),((R,G)=>this._availableFieldsChanged(G,R))),this._updatingHandles.add((()=>R.requiredFields),((R,G)=>this._requiredFieldsChanged(G,R))),"customParameters"in H&&this._updatingHandles.add((()=>H.customParameters),(()=>this.restart())),this.addHandles([H.on("apply-edits",(R=>this._applyEdits(R))),(0,$.wB)((()=>this.extent),(R=>W.filterExtent=R),$.OH),(0,$.wB)((()=>this.tileDescriptors),(R=>W.tileDescriptors=R),$.OH),(0,$.wB)((()=>this.maximumNumberOfFeatures),(R=>{W.maximumNumberOfFeatures=R,W.useTileCount=this.serviceDataCount>R}),$.pc),(0,$.wB)((()=>this.serviceDataCount),(R=>{W.useTileCount=R>this.maximumNumberOfFeatures}),$.pc),(0,$.wB)((()=>qr.b.FEATURE_TILE_FETCH_SHOW_TILES),(R=>{R&&W&&!W.debugger?(W.debugger=new FeatureTileFetcher3DDebugger_m(W,q.featureTiles.tilingScheme.toTileInfo(),q),W.debugger.update()):!R&&this._tileFetcher&&W.debugger&&(W.debugger.destroy(),W.debugger=null)}),$.pc)]),this._supportsExceedsLimitQuery||this._updatingHandles.add((()=>this.maxTotalSnapshotVertices),(()=>this._updatingHandles.addPromise(this._updateSnapshotLimit(this.displayFeatureLimit,null,this._lifeCycleAbortController.signal))))})).catch((()=>{}))}_modeChanged(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:J.A.getLogger(this).warn("Unhandled feature layer mode "+this.mode);case"snapshot":null!=this._tilesHandle&&(this._tilesHandle.remove(),this._tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this._refetch({resetForceTilesMode:!0})}_applyEdits(R){null!=this._tileFetcher&&this._tileFetcher.applyEdits(R).then((R=>{if(R){if(!this._lifeCycleAbortController)throw(0,X.NK)();R.exceededTransferLimit?this.layerView.layer.refresh():(R.deletedFeatures.length||R.updatedFeatures.length||R.addedFeatures.length)&&this._updatingHandles.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}})).catch((R=>{if(!(0,X.zf)(R))throw R}))}_availableFieldsChanged(R,G){null!=this._tileFetcher&&FeatureTileController3D_A(this._tileFetcher.availableFields,G)&&this._refetch({resetForceTilesMode:!1})}_requiredFieldsChanged(R,G){null!=this._tileFetcher&&FeatureTileController3D_A(this._tileFetcher.availableFields,G)&&this.restart()}_createVertexLimitExceededQuery(R){var G;const H=this.layerView.layer,W=H.createQuery();return W.returnGeometry=!1,W.outStatistics=[new n_.A({statisticType:"exceedslimit",maxVertexCount:R,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],null!==(G=H.capabilities)&&void 0!==G&&G.query.supportsCacheHint&&(W.cacheHint=!0),W}_createDataInfoQuery(){var R;const G=this.layerView.layer,H=G.createQuery();return H.returnGeometry=!1,H.outSpatialReference=this.layerView.view.spatialReference,null!==(R=G.capabilities)&&void 0!==R&&R.query.supportsCacheHint&&(H.cacheHint=!0),H}_fullExtentIsAccurate(){const R=this.layerView.layer;if("definitionExpression"in R&&R.definitionExpression)return!1;switch(R.type){case"feature":case"oriented-imagery":return(0,i_.Wo)(R.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}async _updateServiceDataExtent(R){try{await this._tryUpdateServiceDataExtent(R)}catch(G){(0,X.zf)(G)||this._set("serviceDataExtent",(0,Tt.o8)(this.layerView.fullExtentInLocalViewSpatialReference))}}async _tryUpdateServiceDataExtent(R){var G,H;const W=this.layerView,q=W.layer,Q=null!==(G=null===(H=q.capabilities)||void 0===H?void 0:H.query.supportsExtent)&&void 0!==G&&G,J=(0,Tt.o8)(W.fullExtentInLocalViewSpatialReference),X=q.fullExtent,$=this._fullExtentIsAccurate(),K=this.serviceDataCount;if(Q&&K<=F_.maxFeatureCountForExtent&&(!J||!$)&&"queryExtent"in q){const G=this._createDataInfoQuery(),H=await q.queryExtent(G,{timeout:F_.queryExtentTimeout,signal:R});this._set("serviceDataExtent",H.extent)}else if(J)this._set("serviceDataExtent",J);else if(null!=X){const G="portalItem"in q?q.portalItem:null,H=await(0,r_.projectGeometry)(X,W.view.spatialReference,G,R);this._set("serviceDataExtent",H)}else this._set("serviceDataExtent",null)}async _updateServiceDataCount(R){const G=this.layerView.layer;if(!("queryFeatureCount"in G)||!(0,te.A)("featurelayer-snapshot-enabled"))return void this._set("serviceDataCount",F_.noServiceDataCount);const H=await(0,Rt.Ke)(G.queryFeatureCount(this._createDataInfoQuery(),{timeout:F_.queryStatisticsTimeout,signal:R}));if(!0===H.ok)this._set("serviceDataCount",H.value);else{if((0,X.zf)(H.error))throw H.error;this._set("serviceDataCount",F_.noServiceDataCount)}}get _supportsExceedsLimitQuery(){const R=this.layerView.layer;return null!=R.capabilities&&R.capabilities.operations&&R.capabilities.operations.supportsExceedsLimitStatistics}get _minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}async _updateSnapshotLimit(R,G,H){if(null==(null===R||void 0===R?void 0:R.averageSymbolComplexity))return void(this._snapshotLimitExceeded=!1);const{maximumTotalNumberOfVertices:W,averageSymbolComplexity:q}=R,{verticesPerFeature:Q,verticesPerCoordinate:J}=q,$=Q<=0,K=this._minimumNumberOfVerticesForGeometry>1;if(!$&&!K)return void(this._snapshotLimitExceeded=!1);0!==Q&&null!=G&&await G;const ee=Math.min(W,D_),ie=this.serviceDataCount,re=ie!==F_.noServiceDataCount;let ne=re?Math.ceil((ee-ie*Q)/(J||1)):Math.ceil(ee/(J||1));if(K&&(ne=Math.min(ne,L_)),re&&this._minimumNumberOfVerticesForGeometry*ie>ne)return void(this._snapshotLimitExceeded=!0);if(!this._supportsExceedsLimitQuery||!(0,te.A)("featurelayer-snapshot-enabled"))return void(this._snapshotLimitExceeded=this.maxTotalSnapshotVertices>ne);const se=await(0,Rt.Ke)(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(ne),{timeout:F_.queryStatisticsTimeout,signal:H}));if(!1===se.ok){if((0,X.zf)(se.error))throw se.error;return void(this._snapshotLimitExceeded=!1)}const ae=se.value.features[0];this._snapshotLimitExceeded=!(null===ae||void 0===ae||!ae.attributes)&&!!ae.attributes.exceedslimit}async _fetchServiceDataInfo(){this._cancelFetchServiceDataInfo();let R=new AbortController;const G=R.signal,H=this._updateServiceDataCount(G),W=Promise.allSettled([H,this._updateSnapshotLimit(this.displayFeatureLimit,H,G)]),q=W.then((()=>this._updateServiceDataExtent(G))).catch((R=>{(0,X.zf)(R)||J.A.getLogger(this).error("#fetchServiceDataInfo()",R)})).then((()=>{q===this._fetchDataInfoPromise&&(this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null),R=null}));return R&&(this._fetchDataInfoPromise=q),this._fetchDataInfoAbortController=R,W.then((()=>{}),(()=>{}))}_cancelFetchServiceDataInfo(){const R=this._fetchDataInfoAbortController;R&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,R.abort())}get performanceInfo(){var R,G,H,W,q,Q,J,X;return{storedFeatures:null!==(R=null===(G=this._tileFetcher)||void 0===G?void 0:G.storedFeatures)&&void 0!==R?R:0,totalFeatures:null!==(H=null===(W=this._tileFetcher)||void 0===W?void 0:W.totalFeatures)&&void 0!==H?H:0,totalVertices:null!==(q=null===(Q=this._tileFetcher)||void 0===Q?void 0:Q.totalVertices)&&void 0!==q?q:0,missingTiles:null!==(J=null===(X=this._tileFetcher)||void 0===X?void 0:X.missingTiles)&&void 0!==J?J:0}}};(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"type",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],I_.prototype,"graphics",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],I_.prototype,"layerView",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],I_.prototype,"context",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"dataUpdating",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"extent",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"updating",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"_updatingHandles",void 0),(0,W._)([(0,ee.MZ)()],I_.prototype,"updatingTotal",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"updatingRemaining",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"expectedFeatureDiff",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"memoryForUnusedFeatures",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"maximumNumberOfFeaturesExceeded",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"serviceDataExtent",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"serviceDataCount",void 0),(0,W._)([(0,ee.MZ)()],I_.prototype,"_snapshotLimitExceeded",void 0),(0,W._)([(0,ee.MZ)()],I_.prototype,"displayFeatureLimit",void 0),(0,W._)([(0,ee.MZ)({type:Number})],I_.prototype,"maximumNumberOfFeatures",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"hasAllFeatures",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"hasAllFeaturesInView",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"hasFullGeometries",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"_forceTilesMode",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"mode",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"maxTotalSnapshotVertices",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],I_.prototype,"tileDescriptors",null),(0,W._)([(0,ee.MZ)()],I_.prototype,"_tileFetcher",void 0),(0,W._)([(0,ee.MZ)()],I_.prototype,"_fetchDataInfoPromise",void 0),I_=(0,W._)([(0,ie.$)("esri.layers.graphics.controllers.FeatureTileController3D")],I_);const D_=1e6,L_=5e6;function FeatureTileController3D_A(R,G){if(!G)return!1;for(const H of G)if(!R.has(H))return!0;return!1}var F_;!function(R){R.noServiceDataCount=1/0,R.maxSnapshotMinScaleFactor=5,R.reset=function t(){R.maxFeatureCountForExtent=1e4,R.queryStatisticsTimeout=12e3,R.queryExtentTimeout=1e4}}(F_||(F_={})),F_.reset();class FeatureLayerViewPerformanceInfo_t extends LayerViewPerformanceInfo_t{constructor(R,G,H,W,q,Q){super(R.usedMemory,R.displayedFeatures,R.totalFeatures,R.maximumFeatures,R.nodes,R.core),this.storedFeatures=G,this.totalVertices=H,this.partial=W,this.mode=q,this.symbolComplexity=Q}}var N_=H(89722);var V_=H(91003),U_=H(45936);let G_=class extends Q.A{constructor(R){super(R),this._dirtyExtents=new ExtentSet_l,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new Vr.A}initialize(){var R;const G=this.elevationProvider,H=this.graphicsCoreOwner.view.resourceController.scheduler;this._task=H.registerTask(Graphics3DElevationAlignment_d(null===(R=this.graphicsCore.layer.elevationInfo)||void 0===R?void 0:R.mode),this),this.addHandles([G.on("elevation-change",(R=>this._elevationChanged(R))),(0,$.wB)((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),this._task,(0,$.wB)((()=>{var R;return Graphics3DElevationAlignment_d(null===(R=this.graphicsCore.layer.elevationInfo)||void 0===R?void 0:R.mode)}),(R=>this._task.priority=R))])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(R){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,R.madeProgress()),R.run((()=>this._dirtyExtents.merge(R)));this.running&&!R.done;)this._updateDirtyGraphics(R),this._updateDirtyExtents(R);this.notifyChange("updating")}_updateDirtyGraphics(R){const G=this.graphicsCoreOwner.view.renderCoordsHelper,H=this.graphicsCore.effectiveUpdatePolicy===sa.ASYNC;for(const W of this._dirtyGraphicsSet.keys()){const q=this.graphicsCore.getGraphics3DGraphicById(W);if(this._dirtyGraphicsSet.delete(W),null!=q&&(q.alignWithElevation(this.elevationProvider,G,H),this.graphicsCoreOwner.view.deconflictor.setDirty(),R.madeProgress()),R.done)return}}_updateDirtyExtents(R){for(;!this._dirtyExtents.empty&&!R.done;){const G=this._dirtyExtents.pop(),H=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:G,spatialReference:H});const W=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(G,H,(R=>{const G=this.graphicsCore.getGraphics3DGraphicById(R);null!=G&&G.needsElevationUpdates()&&this._dirtyGraphicsSet.add(R)})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-W)+.9*this._averageExtentUpdateSize,R.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((R,G)=>this._dirtyGraphicsSet.add(G)))}_elevationChanged(R){if("scene"===R.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const G=R.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const R=this.graphicsCore.computedExtent;R&&G[2]>R.xmin&&G[0]<R.xmax&&G[3]>R.ymin&&G[1]<R.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",R)}else G[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(G),this.notifyChange("updating")}};function Graphics3DElevationAlignment_d(R){return null==R?ot.W6.ELEVATION_ALIGNMENT:"relative-to-scene"===R?ot.W6.ELEVATION_ALIGNMENT_SCENE:ot.W6.ELEVATION_ALIGNMENT}function intersectionUtils_g(R,G,H,W){return intersectionUtils_x(R,G,H,intersectionUtils_h(W,G,H,!0))}(0,W._)([(0,ee.MZ)()],G_.prototype,"graphicsCoreOwner",void 0),(0,W._)([(0,ee.MZ)()],G_.prototype,"graphicsCore",void 0),(0,W._)([(0,ee.MZ)()],G_.prototype,"queryGraphicUIDsInExtent",void 0),(0,W._)([(0,ee.MZ)()],G_.prototype,"elevationProvider",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],G_.prototype,"updating",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],G_.prototype,"updatingRemaining",null),G_=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],G_);const z_={dir:(0,xe.vt)(),len:0,clip:(0,Xi.vt)()};function intersectionUtils_h(R,G,H,W){const q=z_;return R?(H&&W&&(q.len=(0,be.q)(G,H)),(0,be.c)(q.dir,R)):W?(q.len=(0,be.q)(G,H),(0,be.f)(q.dir,H,G),(0,be.h)(q.dir,q.dir,1/q.len)):((0,be.f)(q.dir,H,G),(0,be.n)(q.dir,q.dir)),q}function intersectionUtils_v(R,G,H){const W=(0,be.k)((0,Ki.Qj)(R),H.dir),q=-(0,Ki.mN)(R,G);if(q<0&&W>=0)return!1;if(W>-1e-6&&W<1e-6)return q>0;if((q<0||W<0)&&!(q<0&&W<0))return!0;const Q=q/W;return W>0?Q<H.clip[1]&&(H.clip[1]=Q):Q>H.clip[0]&&(H.clip[0]=Q),H.clip[0]<=H.clip[1]}function intersectionUtils_x(R,G,H,W){W.clip[0]=0,W.clip[1]=H?W.len:Number.MAX_VALUE;for(let q=0;q<R.length;q++)if(!intersectionUtils_v(R[q],G,W))return!1;return!0}const B_=.5*Math.PI,H_=B_/Math.PI*180;class FrustumExtentIntersection_N{constructor(R){this._renderCoordsHelper=R.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:(0,xe.vt)(),direction:(0,xe.vt)()};for(let G=0;G<4;G++)this._extent[G]={origin:(0,xe.vt)(),direction:(0,xe.vt)(),cap:{next:null,direction:(0,xe.vt)()}},this._planes[G]=(0,Ki.vt)();this._planes[zt.FB.NEAR]=(0,Ki.vt)(),this._planes[zt.FB.FAR]=(0,Ki.vt)(),this._planesWithoutFar=this._planes.slice(0,5)}update(R,G,H){let W=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const q=this._extent;this._toRenderBoundingExtent(R,G,H),(0,be.g)(this._center.origin,q[0].origin,q[2].origin),(0,be.h)(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),W||(0,be.h)(this._center.direction,this._center.direction,-1);for(let Q=0;Q<4;Q++){const R=q[Q];this._renderCoordsHelper.worldUpAtPosition(R.origin,R.direction);const G=q[3===Q?0:Q+1];R.cap.next=G.origin,(0,be.E)(R.cap.direction,R.origin,G.origin),(0,Ki.mR)(R.direction,R.cap.direction,R.origin,this._planes[Q]),W||(0,be.h)(R.direction,R.direction,-1)}(0,Ki.mR)(q[0].cap.direction,q[1].cap.direction,q[0].origin,this._planes[zt.FB.NEAR]),W?(0,Ki.ze)(this._planes[zt.FB.NEAR],this._planes[zt.FB.FAR]):((0,Ki.C)(this._planes[zt.FB.FAR],this._planes[zt.FB.NEAR]),(0,Ki.ze)(this._planes[zt.FB.NEAR],this._planes[zt.FB.NEAR])),this._maxSpan=Math.max(Math.abs(R[0]-R[2]),Math.abs(R[1]-R[3])),this._maxSpanSpatialReference=G,this._minGlobalAltitude=.9*(0,Ut.tO)(this._maxSpanSpatialReference).radius}isVisibleInFrustum(R,G){let H=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null==R)return!1;if(this._renderCoordsHelper.viewingMode===qe.RT.Global){const H=this._maxSpanSpatialReference.isGeographic?H_:B_*G;if(this._maxSpan>H)return!0;if(null!=R.altitude&&R.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(R)}if(0===this._maxSpan){const G=this._extent[0];return!(H||!R.intersectsRay((0,er.LV)(G.origin,G.direction)))}for(let q=0;q<this._extent.length;q++){const G=this._extent[q];if(!H&&R.intersectsRay((0,er.LV)(G.origin,G.direction)))return!0;if(R.intersectsLineSegment((0,oa.Cr)(G.origin,G.cap.next,Y_),G.cap.direction))return!0}const W=H?this._planes:this._planesWithoutFar;for(let q=0;q<R.lines.length;q++){const G=R.lines[q];if(intersectionUtils_g(W,G.origin,G.endpoint,G.direction))return!0}return!1}_toRenderBoundingExtentGlobal(R,G,H){(0,Fe.gX)(R,W_),W_[2]=H,(0,Bt.l)(G,W_,k_,this._renderCoordsHelper.spatialReference),(0,ye.B8)(q_,k_),(0,Le.Ie)(Z_);for(const{x0:W,x1:q,y0:Q,y1:J}of j_)for(let X=0;X<5;X++){const $=X/4;W_[0]=(0,Ee.Cc)(R[W],R[q],$),W_[1]=(0,Ee.Cc)(R[Q],R[J],$),W_[2]=H,(0,De.F)(W_,G,W_,this._renderCoordsHelper.spatialReference),(0,be.e)(W_,W_,q_),(0,Le.iT)(Z_,W_)}(0,be.s)(this._extent[0].origin,Z_[0],Z_[1],Z_[2]),(0,be.s)(this._extent[1].origin,Z_[3],Z_[1],Z_[2]),(0,be.s)(this._extent[2].origin,Z_[3],Z_[4],Z_[2]),(0,be.s)(this._extent[3].origin,Z_[0],Z_[4],Z_[2]);for(let W=0;W<4;++W)(0,be.e)(this._extent[W].origin,this._extent[W].origin,k_)}_toRenderBoundingExtentLocal(R,G,H){projectBoundingRect_i(R,G,Q_,this._renderCoordsHelper.spatialReference),(0,be.s)(this._extent[0].origin,Q_[0],Q_[1],H),(0,be.s)(this._extent[1].origin,Q_[2],Q_[1],H),(0,be.s)(this._extent[2].origin,Q_[2],Q_[3],H),(0,be.s)(this._extent[3].origin,Q_[0],Q_[3],H)}_toRenderBoundingExtent(R,G,H){switch(this._renderCoordsHelper.viewingMode){case qe.RT.Global:this._toRenderBoundingExtentGlobal(R,G,H);break;case qe.RT.Local:this._toRenderBoundingExtentLocal(R,G,H);break;default:(0,ki.Xb)(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(R){if((0,Ki.mN)(R.planes[zt.FB.NEAR],this._center.origin)<0&&(0,be.k)(this._center.direction,R.direction)<0)return!0;for(let G=0;G<4;G++){const H=this._extent[G];if((0,Ki.mN)(R.planes[zt.FB.NEAR],H.origin)<0&&(0,be.k)(H.direction,R.direction)<0)return!0}return!1}}const j_=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],W_=(0,xe.vt)(),k_=(0,ve.vt)(),q_=(0,ve.vt)(),Z_=(0,Le.vt)(),Q_=(0,Fe.vt)(),Y_=(0,oa.vt)();let J_=class extends Q.A{constructor(R){super(R),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:R}=this;this._extentIntersection=new FrustumExtentIntersection_N({renderCoordsHelper:R.view.renderCoordsHelper});const G=R.view,H=G.basemapTerrain,W=G.resourceController.scheduler;this.addHandles([G.on("resize",(()=>this._viewChange())),(0,$.wB)((()=>G.state.camera),(()=>this._viewChange()),$.OH),W.registerTask(ot.W6.FRUSTUM_VISIBILITY,this),(0,$.wB)((()=>H.visibleElevationBounds),(()=>this._elevationBoundsChange()))]),"local"===G.viewingMode?this._isVisibleBelowSurface=!0:this.addHandles([(0,$.wB)((()=>{var R;return[H.baseOpacity,H.wireframe,null===(R=G.map)||void 0===R||null===(R=R.ground)||void 0===R||null===(R=R.navigationConstraint)||void 0===R?void 0:R.type]}),(()=>this._updateIsVisibleBelowSurface()),$.Vh)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(R){this._extent=R,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(R){this._isVisibleBelowSurfaceInternal=R,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){var R;const G=this.graphicsCoreOwner.view,H=G.basemapTerrain,W="local"===G.viewingMode,q="none"===(null===(R=G.map.ground)||void 0===R||null===(R=R.navigationConstraint)||void 0===R?void 0:R.type);this._isVisibleBelowSurface=W||!H.opaque||q}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const R=this.graphicsCoreOwner.view;let G;if(this._isVisibleBelowSurfaceInternal)G=-.3*(0,Ut.tO)(R.spatialReference).radius;else{const{min:H,max:W}=R.basemapTerrain.visibleElevationBounds;G=H-Math.max(1,(W-H)*(1.2-1))}this._extentIntersection.update(this._extent,R.spatialReference,G)}get running(){return this.updating}runTask(R){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),Uu.G;this._updateExtentIntersection();const G=this.graphicsCoreOwner.view.frustum,H=(0,Ut.tO)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(G,H)),R.madeProgress()}};var X_;(0,W._)([(0,ee.MZ)({readOnly:!0})],J_.prototype,"suspended",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],J_.prototype,"graphicsCoreOwner",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],J_.prototype,"updating",void 0),J_=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],J_),function(R){R[R.Object=0]="Object",R[R.RenderGeometry=1]="RenderGeometry",R[R.External=2]="External",R[R.COUNT=3]="COUNT"}(X_||(X_={}));class Object3DStateSet_r{constructor(){this._items=[]}addObject(R,G){this._items.push({type:X_.Object,objectStateId:G,object:R})}addRenderGeometry(R,G,H){this._items.push({type:X_.RenderGeometry,objectStateId:G,renderGeometry:R,owner:H})}addExternal(R,G){this._items.push({type:X_.External,objectStateId:G,remove:R})}remove(R){for(let G=this._items.length-1;G>=0;--G){const H=this._items[G];H.objectStateId===R&&(this._removeObjectStateItem(H),this._items.splice(G,1))}}removeObject(R){for(let G=this._items.length-1;G>=0;--G){const H=this._items[G];H.type===X_.Object&&H.object===R&&(this._removeObjectStateItem(H),this._items.splice(G,1))}}removeRenderGeometry(R){for(let G=this._items.length-1;G>=0;--G){const H=this._items[G];H.type===X_.RenderGeometry&&H.renderGeometry===R&&(this._removeObjectStateItem(H),this._items.splice(G,1))}}removeAll(){this._items.forEach((R=>{this._removeObjectStateItem(R)})),this._items=[]}_removeObjectStateItem(R){switch(R.type){case X_.Object:R.objectStateId.channel===et.Mg.Highlight?R.object.removeHighlight(R.objectStateId):R.objectStateId.channel===et.Mg.MaskOccludee&&R.object.removeOcclude(R.objectStateId);break;case X_.RenderGeometry:R.owner.removeRenderGeometryObjectState(R.renderGeometry,R.objectStateId);break;case X_.External:R.remove(R.objectStateId)}}}class Graphics3DObjectStateSet_e{constructor(R,G){this.stateType=R,this.objectIdField=G,this.objectStateSet=new Object3DStateSet_r,this.ids=new Set,this.paused=!1}hasGraphic(R){if(this.objectIdField){const G=R.graphic.attributes[this.objectIdField];return this.ids.has(G)}return this.ids.has(R.graphic.uid)}}class Graphics3DObjectStates_s{constructor(R){this._graphicsCore=R,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach((R=>R.objectStateSet.removeAll())),this._stateSets.length=0)}acquireSet(R,G){const H=new Graphics3DObjectStateSet_e(R,G);this._stateSets.push(H);const W=(0,ue.hA)((()=>this.releaseSet(H)));return{set:H,handle:W}}releaseSet(R){R.objectStateSet.removeAll();const G=this._stateSets?this._stateSets.indexOf(R):-1;-1!==G&&this._stateSets.splice(G,1)}_addObjectStateSet(R,G){R.addObjectStateSet(G.stateType,G.objectStateSet)}_removeObjectStateSet(R,G){R.removeObjectState(G.objectStateSet)}setUid(R,G){R.ids.add(G);const H=this._graphicsCore.graphics3DGraphics.get(G);H&&this._addObjectStateSet(H,R)}setUids(R,G){G.forEach((G=>this.setUid(R,G)))}setObjectIds(R,G){G.forEach((G=>R.ids.add(G))),this._initializeSet(R)}addGraphic(R){this._stateSets.forEach((G=>{!G.paused&&G.hasGraphic(R)&&this._addObjectStateSet(R,G)}))}removeGraphic(R){this._stateSets.forEach((G=>{G.hasGraphic(R)&&this._removeObjectStateSet(R,G)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((R=>R.objectStateSet.removeAll()))}_initializeSet(R){const G=this._graphicsCore.graphics3DGraphics;R.objectIdField?G.forEach((G=>{G&&R.hasGraphic(G)&&this._addObjectStateSet(G,R)})):R.ids.forEach((H=>{const W=G.get(H);W&&this._addObjectStateSet(W,R)}))}get test(){return{states:this._stateSets}}}function attributeUtils_n(R,G,H){if(!H||null==G)return null;if(!R)return function attributeUtils_r(R,G){const H=G.toLowerCase();for(const W in R)if(W.toLowerCase()===H)return R[W];return null}(G,H);const W=R.get(H);return W?G[W.name]:null}var $_=H(71843),K_=H(84058),em=H(56103),tm=H(8084),im=H(94309);const rm=em.d;let nm=class extends Q.A{get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new o_.A({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(R){super(R),this._dataQueryEngineInstance=null}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(R,G,H){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(R,G),H)}async executeQueryForCount(R,G){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(R),G)}async executeQueryForExtent(R,G){const{count:H,extent:W}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(R),G);return{count:H,extent:jc.A.fromJSON(W)}}async executeQueryForIds(R,G){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(R),G)}async executeQueryForLatestObservations(R,G){const H=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(R),G),W=im.A.fromJSON(H);return W.features.forEach((R=>{R.layer=this.layer,R.sourceLayer=this.layer})),W}async executeQuery(R,G){const H=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(R),G),W=im.A.fromJSON(H);return W.features.forEach((R=>{R.layer=this.layer,R.sourceLayer=this.layer})),W}_ensureQueryJSON(R,G){let H=this.defaultQueryJSON;if(null!=R&&("outSpatialReference"in R&&!R.outSpatialReference&&(R.outSpatialReference=this.spatialReference),H=R.toJSON()),null!=G){const R=G.geometries.map((R=>R.toJSON())).reduce(((R,G)=>(R.rings=R.rings.concat(G.rings),R)));H={...H,sceneFilter:{...G,geometry:R}}}return H}_ensureDataQueryEngine(){var R,G;if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const H="timeInfo"in this.layer&&(null===(R=this.layer.timeInfo)||void 0===R?void 0:R.toJSON())||null,W=this.layer.objectIdField,q=l_.g.toJSON(this._queryGeometryType),Q=(null===(G=this.layer.fieldsIndex)||void 0===G?void 0:G.toJSON())||new tm.A([]),J=this.priority,X=this.spatialReference.toJSON(),{hasZ:$,hasM:K,featureStore:ee,scheduler:te}=this.context;return this._dataQueryEngineInstance=new rm({hasZ:$,hasM:K,geometryType:q,fieldsIndex:Q,timeInfo:H,spatialReference:X,objectIdField:W,featureStore:ee,scheduler:te,priority:J}),this._dataQueryEngineInstance}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],nm.prototype,"context",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],nm.prototype,"priority",void 0),(0,W._)([(0,ee.MZ)()],nm.prototype,"layer",null),(0,W._)([(0,ee.MZ)()],nm.prototype,"spatialReference",null),(0,W._)([(0,ee.MZ)()],nm.prototype,"_queryGeometryType",null),(0,W._)([(0,ee.MZ)()],nm.prototype,"defaultQueryJSON",null),nm=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.QueryEngine")],nm);let sm=class extends Q.A{constructor(R){super(R),this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new we.U,this._updateVisibility=async R=>{if(null==this._compositedFeatureFilter&&null==this._sceneFilter||0===this.context.getFeatureCount())return this._frameTask.schedule((()=>this.clear()),R);try{const G=await this._queryEngine.executeQueryForIdSet(this._compositedFeatureFilter,this._sceneFilter,R);return this._frameTask.schedule((()=>{this.context.updateFeatureVisibilities((R=>G.has(R)))}),R)}catch(G){return(0,X.QP)(G),J.A.getLogger(this).warn("FeatureFilter query failed: ".concat(G),{error:G}),this._frameTask.schedule((()=>{this.context.setAllFeaturesVisibility(!0)}),R)}}}initialize(){const R=ot.W6.FILTER_VISIBILITY,{layer:G,view:H}=this._layerView,{featureStore:W}=this.context,q="hasZ"in this._layerView&&this._layerView.hasZ,Q="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new nm({context:{spatialReference:H.spatialReference,layer:G,scheduler:H.resourceController.scheduler,featureStore:W,hasM:Q,hasZ:q},priority:R}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(R,this),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),$.Vh)}destroy(){this._updateRequested=!1,this._updatingHandles.destroy(),this.clear(),this._updateTask=(0,Qe.DC)(this._updateTask),this._frameTask=(0,Qe.xt)(this._frameTask),this._queryEngine=(0,Qe.pR)(this._queryEngine),this._set("context",null)}get updating(){return this.running||this._updatingHandles.updating||null!=this._updateTask&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return(0,K_.E)(this._layerView)}get _timeExtent(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:R,_timeExtent:G,_floorFilter:H}=this;if(null==G&&null==H)return R;const W=null!=R?R.clone():new $_.A;if(null!=G&&(W.timeExtent=null!=W.timeExtent?W.timeExtent.intersection(G):G),null!=H){const R=null==W.where||""===W.where;W.where=R?H:"(".concat(W.where,") AND (").concat(H,")")}return W}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}runTask(R){if(this._updateRequested&&(this._updateTask=(0,Qe.DC)(this._updateTask),this._updateTask=(0,Rt.UT)(this._updateVisibility),this._updateRequested=!1,R.madeProgress()),this._frameTask.processQueue(R),!R.hasProgressed)return Uu.G}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],sm.prototype,"context",void 0),(0,W._)([(0,ee.MZ)()],sm.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"running",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"defaultVisibility",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"_featureFilter",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"_sceneFilter",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"_floorFilter",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"_timeExtent",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"_compositedFeatureFilter",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"_layerView",null),(0,W._)([(0,ee.MZ)()],sm.prototype,"_updateTask",void 0),(0,W._)([(0,ee.MZ)()],sm.prototype,"_updateRequested",void 0),sm=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.FeatureVisibilityFilter")],sm);let am=class extends Q.A{constructor(R){super(R),this.type="graphics-3d",this._randomRotationRenderers=null,this._updatingHandles=new we.U,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=Cs.Features,this.preferredUpdatePolicy=sa.ASYNC,this._suspendResumeExtent=null}initialize(){const R=this.owner,G=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==R.layer.geometryType,H=new wp({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:R.hasZ,hasM:R.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:G=>R.view.deconflictor.addGraphicsOwner(G),labeler:(G,H)=>R.view.labeler.addGraphicsOwner(G,H),elevationAlignment:this.elevationAlignmentEnabled?(G,H)=>new G_({graphicsCoreOwner:this,graphicsCore:G,queryGraphicUIDsInExtent:H,elevationProvider:R.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(G,H)=>new Pp({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:H,graphicsCore:G,basemapTerrain:R.view.basemapTerrain}):null,filterVisibility:G?G=>new sm({context:{layerView:R,...G}}):null,objectStates:R=>new Graphics3DObjectStates_s(R)}});this._set("graphicsCore",H),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new J_({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add((()=>this.layer.elevationInfo),((R,G)=>{(0,Ai.Ui)(R,G)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})),this._updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this._updatingHandles.add((()=>this.layer.labelingInfo),((R,G)=>{(0,Ai.Ui)(R,G)&&this.graphicsCore.updateLabelingInfo()})),this._updatingHandles.add((()=>this.preferredUpdatePolicy),(R=>this.graphicsCore.preferredUpdatePolicy=R)),this._set("initializePromise",this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}async _initializeAsync(){await(0,X.Qg)(this.graphicsCore.initializePromise);const R=this.owner;this._updatingHandles.add((()=>this.renderer),(R=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(R)))),this._updatingHandles.add((()=>R.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add((()=>R.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await(0,X.Qg)(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",(0,Qe.pR)(this.frustumVisibility)),this._set("graphicsCore",(0,Qe.pR)(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get dataUpdating(){var R,G;return null!==(R=null===(G=this.graphicsCore)||void 0===G?void 0:G.dataUpdating)&&void 0!==R&&R}get renderer(){const{renderer:R,objectIdField:G}=this.layer;if(!R||!G||"heatmap"===R.type||!R.visualVariables)return R;const H=R.visualVariables.findIndex((R=>"rotation"===R.type&&null!=R.valueExpression&&(0,U_.D)(R.valueExpression)===G&&(null==R.axis||"heading"===R.axis)&&"geographic"===R.rotationType));if(H<0)return R;const W=R.clone();return W.visualVariables.splice(H,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(W,G),W}get scaleVisibility(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.scaleVisibility}get filterVisibility(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.filterVisibility}get elevationAlignment(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.elevationAlignment}get objectStates(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.objectStates}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){return null!=this.scaleVisibility&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return null==this.frustumVisibility||!this.frustumVisibility.suspended}get suspendInfo(){const R={};return this.scaleVisibilitySuspended&&(R.outsideScaleRange=!0),null!=this.frustumVisibility&&this.frustumVisibility.suspended&&(R.outsideOfView=!0),R}get updating(){var R,G;return!!(null!==(R=this.graphicsCore)&&void 0!==R&&R.updating||null!==(G=this.frustumVisibility)&&void 0!==G&&G.updating||this._updatingHandles.updating)}get updatingRemaining(){var R,G;return null!==(R=null===(G=this.graphicsCore)||void 0===G?void 0:G.updatingRemaining)&&void 0!==R?R:0}get featureStore(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var R;return null===(R=this.owner)||void 0===R?void 0:R.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.graphics3DGraphicsByObjectID}get symbolUpdateType(){var R;return null===(R=this.graphicsCore)||void 0===R?void 0:R.symbolUpdateType}get displayFeatureLimit(){var R;const G=this.view.quality,H=null===(R=this.graphicsCore)||void 0===R?void 0:R.displayFeatureLimit;if(1===G)return H;const W=Math.ceil(H.maximumNumberOfFeatures*G);return new DisplayFeatureLimit_e(H.maximumTotalNumberOfVertices,W,H.averageSymbolComplexity)}get usedMemory(){var R,G;return null!==(R=null===(G=this.graphicsCore)||void 0===G?void 0:G.usedMemory)&&void 0!==R?R:0}get loadedFeatures(){var R,G;return null!==(R=null===(G=this.graphicsCore)||void 0===G?void 0:G.numberOfGraphics)&&void 0!==R?R:0}get usedMemoryPerFeature(){var R,G;return null!==(R=null===(G=this.graphicsCore)||void 0===G?void 0:G.usedMemoryPerGraphic)&&void 0!==R?R:0}get unprocessedMemoryEstimate(){var R,G;return null!==(R=null===(G=this.graphicsCore)||void 0===G?void 0:G.unprocessedMemoryEstimate)&&void 0!==R?R:0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(R){const{set:G,handle:H}=this.objectStates.acquireSet(et.Mg.MaskOccludee,null);return this.objectStates.setUid(G,R.uid),H}highlight(R,G){if(R instanceof o_.A){const{set:H,handle:W}=this.objectStates.acquireSet(et.Mg.Highlight,G);return this.owner.queryObjectIds(R).then((R=>this.objectStates.setObjectIds(H,R))),W}if("number"==typeof R||"string"==typeof R)return this.highlight([R],G);if(R instanceof le.A)return this.highlight([R],G);if("toArray"in R&&(R=R.toArray()),Array.isArray(R)&&R.length>0){if(R[0]instanceof le.A){const H=R;if(null==attributeUtils_n(this.layer.fieldsIndex,H[0].attributes,G)){const R=H.map((R=>R.uid)),{set:G,handle:W}=this.objectStates.acquireSet(et.Mg.Highlight,null);return this.objectStates.setUids(G,R),W}R=H.map((R=>attributeUtils_n(this.layer.fieldsIndex,R.attributes,G)))}if(Array.isArray(R)&&("number"==typeof R[0]||"string"==typeof R[0])){const H=R,{set:W,handle:q}=this.objectStates.acquireSet(et.Mg.Highlight,G);return this.objectStates.setObjectIds(W,H),q}}return(0,ue.hA)()}resetObjectStates(){this.objectStates.reset()}whenGraphicBounds(R,G){var H;return null===(H=this.graphicsCore)||void 0===H?void 0:H.whenGraphicBounds(R,G)}computeAttachmentOrigin(R,G){var H;return null===(H=this.graphicsCore)||void 0===H?void 0:H.computeAttachmentOrigin(R,G)}notifyGraphicGeometryChanged(R){this.graphicsCore.notifyGraphicGeometryChanged(R)}notifyGraphicVisibilityChanged(R){this.graphicsCore.notifyGraphicVisibilityChanged(R)}getRenderingInfo(R,G,H){var W;const q=renderingInfoUtils_i(R,{renderer:G,arcade:H});if(null!==q&&void 0!==q&&q.color){const R=q.color;R[0]=R[0]/255,R[1]=R[1]/255,R[2]=R[2]/255}if(null!=q&&null!=G&&null!==(W=this._randomRotationRenderers)&&void 0!==W&&W.has(G)){const H=this._randomRotationRenderers.get(G),W=R.attributes[H],Q=new V_.b(0);Q.updateFloatArray([W]),Q.updateUint8Array([173]),q.heading=8.381e-8*Q.digest()}return q}getRenderingInfoAsync(R,G,H,W){return renderingInfoUtils_l(R,{renderer:G,arcade:H,...W})}getSymbolLayerSize(R,G){var H;return null===(H=this.graphicsCore)||void 0===H?void 0:H.getSymbolLayerSize(R,G)}setObjectIdVisibility(R,G){var H;null===(H=this.graphicsCore)||void 0===H||H.setObjectIdVisibility(R,G)}refreshFilter(){null!=this.filterVisibility&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(R){var G;return null===(G=this.graphicsCore)||void 0===G?void 0:G.getGraphics3DGraphicByObjectId(R)}_updateClippingExtent(){const R=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(R,this.owner.view.spatialReference)&&(this.updateClippingExtent(R)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles((0,$.wB)((()=>this.suspendResumeExtentMode),(()=>{switch(this.removeHandles(om),this.suspendResumeExtentMode){case"computed":this.addHandles([(0,$.wB)((()=>this.graphicsCore.computedExtent),(R=>this._updateSuspendResumeExtent(R)),$.Vh),(0,$.wB)((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],om);break;case"data":this.addHandles([(0,$.z7)((()=>this.dataExtent),(R=>this._updateSuspendResumeExtent(R)),$.Vh),(0,$.wB)((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.dataExtent)))],om);break;default:(0,ki.Xb)(this.suspendResumeExtentMode)}}),$.Vh))}_updateSuspendResumeExtent(R){R?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(R,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(R,G){const H=this.owner.view.spatialReference;if(!R.spatialReference.equals(H)){if(!(0,R_.y7)(R,H))return;R=(0,R_.Cv)(R,H)}return function graphicUtils_P(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(R){G||(G=(0,Fe.vt)());const q=R;let Q=.5*q.width*(H-1),J=.5*q.height*(H-1);return q.width<1e-7*q.height?Q+=J/20:q.height<1e-7*q.width&&(J+=Q/20),(0,Se.s)(G,q.xmin-Q-W,q.ymin-J-W,q.xmax+Q+W,q.ymax+J+W),G}return null}(R,G,1.2,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(R){null!=this.frustumVisibility&&this.frustumVisibility.setExtent(R),null!=this.scaleVisibility&&this.scaleVisibility.setExtent(R)}};(0,W._)([(0,ee.MZ)()],am.prototype,"type",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"owner",void 0),(0,W._)([(0,ee.MZ)()],am.prototype,"layer",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],am.prototype,"dataUpdating",null),(0,W._)([(0,ee.MZ)()],am.prototype,"renderer",null),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"updateClippingExtent",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"elevationFeatureExpressionEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"graphicsCore",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"scaleVisibilityEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"filterVisibilityEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"frustumVisibilityEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"elevationAlignmentEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"timeExtentEnabled",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"setUidToIdOnAdd",void 0),(0,W._)([(0,ee.MZ)()],am.prototype,"scaleVisibility",null),(0,W._)([(0,ee.MZ)()],am.prototype,"filterVisibility",null),(0,W._)([(0,ee.MZ)()],am.prototype,"elevationAlignment",null),(0,W._)([(0,ee.MZ)({constructOnly:!0})],am.prototype,"frustumVisibility",void 0),(0,W._)([(0,ee.MZ)()],am.prototype,"objectStates",null),(0,W._)([(0,ee.MZ)()],am.prototype,"initializePromise",void 0),(0,W._)([(0,ee.MZ)()],am.prototype,"suspendResumeExtentMode",null),(0,W._)([(0,ee.MZ)()],am.prototype,"dataExtent",void 0),(0,W._)([(0,ee.MZ)()],am.prototype,"scaleVisibilitySuspended",null),(0,W._)([(0,ee.MZ)()],am.prototype,"suspended",null),(0,W._)([(0,ee.MZ)()],am.prototype,"legendEnabled",null),(0,W._)([(0,ee.MZ)()],am.prototype,"suspendInfo",null),(0,W._)([(0,ee.MZ)()],am.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],am.prototype,"updatingRemaining",null),(0,W._)([(0,ee.MZ)()],am.prototype,"featureStore",null),(0,W._)([(0,ee.MZ)()],am.prototype,"view",null),(0,W._)([(0,ee.MZ)()],am.prototype,"loadedGraphics",null),(0,W._)([(0,ee.MZ)()],am.prototype,"fullOpacity",null),(0,W._)([(0,ee.MZ)()],am.prototype,"filter",null),(0,W._)([(0,ee.MZ)()],am.prototype,"slicePlaneEnabled",null),(0,W._)([(0,ee.MZ)()],am.prototype,"drapeSourceType",void 0),(0,W._)([(0,ee.MZ)()],am.prototype,"updatePolicy",null),(0,W._)([(0,ee.MZ)()],am.prototype,"preferredUpdatePolicy",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],am.prototype,"displayFeatureLimit",null),am=(0,W._)([(0,ie.$)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],am);const om="suspendResumeExtentMode";const lm={candidates:[],sourceCandidateIndices:[]};var cm=H(16906),dm=H(45691),hm=H(73126),um=H(40332);new um._(Wt.r.POSITION,3,Ft.pe.FLOAT,0,12),new um._(Wt.r.POSITION,3,Ft.pe.FLOAT,0,20),new um._(Wt.r.UV0,2,Ft.pe.FLOAT,12,20),new um._(Wt.r.POSITION,3,Ft.pe.FLOAT,0,32),new um._(Wt.r.NORMAL,3,Ft.pe.FLOAT,12,32),new um._(Wt.r.UV0,2,Ft.pe.FLOAT,24,32),new um._(Wt.r.POSITION,3,Ft.pe.FLOAT,0,16),new um._(Wt.r.COLOR,4,Ft.pe.UNSIGNED_BYTE,12,16);const pm=[new um._(Wt.r.POSITION,2,Ft.pe.FLOAT,0,8)],_m=[new um._(Wt.r.POSITION,2,Ft.pe.FLOAT,0,16),new um._(Wt.r.UV0,2,Ft.pe.FLOAT,8,16)];var mm=H(15261);class HeatmapTechnique_h extends Gs.Y{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class HeatmapTechnique_d extends Ln.w{constructor(R,G){super(R,G,(()=>this.destroy()))}initializeProgram(R){return new Nn.B(R.rctx,HeatmapTechnique_d.shader.get().build(this.configuration),Fn.D)}initializePipeline(){return(0,Un.Ey)({blending:ha.V0,colorWrite:Un.wE,depthTest:null,depthWrite:null})}get primitiveType(){return Ft.WR.TRIANGLE_STRIP}}HeatmapTechnique_d.shader=new Dn.$(mm.H,(()=>H.e(3379).then(H.bind(H,83379))));class HeatmapTechnique_f extends zn.E{constructor(){super(...arguments),this.usesHalfFloat=!1}}(0,W._)([(0,Gn.W)()],HeatmapTechnique_f.prototype,"usesHalfFloat",void 0);var gm=H(50707);let fm=class extends il{constructor(R){super(R),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new HeatmapTechnique_h;const G=new al.R;G.pixelFormat=R.pixelFormat,G.internalFormat=R.internalFormat,G.dataType=R.dataType,G.samplingMode=R.samplingMode,G.wrapMode=Ft.pF.CLAMP_TO_EDGE;const H=R.rendererContext.rctx;this._densityMap=new gm.H(H,G),this._quad=function glUtil3D_i(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pm,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Fn.D,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,Q=null;return Q=G===_m?new Float32Array([W,W,0,0,q,W,1,0,W,q,0,1,q,q,1,1]):new Float32Array([W,W,q,W,W,q,q,q]),new VertexArrayObject_r(R,H,{geometry:G},{geometry:Wo.g.createVertex(R,Ft._U.STATIC_DRAW,Q)})}(H);const W=new HeatmapTechnique_f;W.usesHalfFloat=R.dataType!==Ft.ld.FLOAT,this._technique=new HeatmapTechnique_d({rctx:H,viewingMode:qe.RT.Local},W)}initialize(){const R=this._colorRampData,G=new al.R(R.length/4,1);G.wrapMode=Ft.pF.CLAMP_TO_EDGE,this._colorRamp=new Qa.g(this.rctx,G,R),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,$.wB)((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))}destroy(){this._technique=(0,Qe.Gz)(this._technique),this._densityMap=(0,Qe.WD)(this._densityMap),this._quad=(0,Qe.WD)(this._quad),this._colorRamp=(0,Qe.WD)(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(R){R!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=R,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(R){R!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=R,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(R){R!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=R,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(R){this._heatmapParameters.fieldTotal=R,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(R){const{colorRamp:G}=this._heatmapParameters;if(null!=G&&R!==this._colorRampData){const H=G.descriptor.width,W=R.length/4;W!==H&&G.resize(W,1),G.setData(R)}this._colorRampData=R}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(R){this._heatmapParameters.colorRamp=R}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccludedDraped(){return!1}render(R){const G=this._sortedMaterialRenderers;if(0===G.length)return;const H=this.rctx.getBoundFramebufferObject(),W=this.rctx.getViewport(),{pixelRatio:q}=this,Q=Math.ceil(W.width*q),J=Math.ceil(W.height*q);this._densityMap.resize(Q,J),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,Q,J),this.rctx.clear(Ft.hn.COLOR_BUFFER_BIT);let X=!1;G.forAll((G=>{const H=G.prepareTechnique(R);null!=H&&(G.renderNode(R,H),X=!0)})),this.rctx.bindFramebuffer(H),this.rctx.setViewport(W.x,W.y,W.width,W.height),X&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,R.bindParameters,this._heatmapParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,hh.mT)(this._quad,"geometry")))}};(0,W._)([(0,ee.MZ)()],fm.prototype,"searchRadius",null),(0,W._)([(0,ee.MZ)()],fm.prototype,"minDensity",null),(0,W._)([(0,ee.MZ)()],fm.prototype,"maxDensity",null),(0,W._)([(0,ee.MZ)()],fm.prototype,"fieldTotal",null),(0,W._)([(0,ee.MZ)()],fm.prototype,"pixelRatio",void 0),(0,W._)([(0,ee.MZ)()],fm.prototype,"colorRampData",null),(0,W._)([(0,ee.MZ)({constructOnly:!0})],fm.prototype,"dataType",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],fm.prototype,"samplingMode",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],fm.prototype,"pixelFormat",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],fm.prototype,"internalFormat",void 0),(0,W._)([(0,ee.MZ)()],fm.prototype,"_colorRampData",void 0),fm=(0,W._)([(0,ie.$)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],fm);var ym=H(15645);class HeatmapDensityTechnique_d extends Pn.qA{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class HeatmapDensityTechnique_f extends Ln.w{initializeProgram(R){return new Nn.B(R.rctx,HeatmapDensityTechnique_f.shader.get().build(this.configuration),Fn.D)}initializePipeline(){return(0,Un.Ey)({blending:(0,Un.ox)(Ft.dn.ONE,Ft.dn.ONE,Ft.Tb.ADD),colorWrite:Un.wE,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}HeatmapDensityTechnique_f.shader=new Dn.$(ym.H,(()=>H.e(6375).then(H.bind(H,46375))));class HeatmapDensityTechnique_b extends zn.E{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloat=!1}}(0,W._)([(0,Gn.W)()],HeatmapDensityTechnique_b.prototype,"isAttributeDriven",void 0),(0,W._)([(0,Gn.W)()],HeatmapDensityTechnique_b.prototype,"usesHalfFloat",void 0);class HeatmapDensityMaterial_b extends HeatmapDensityTechnique_d{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloats=!1}}class HeatmapDensityMaterial_T extends Pn.im{constructor(R){super(R,new HeatmapDensityMaterial_b),this.produces=new Map([[Mn.N.DRAPED_MATERIAL,R=>R===En.V.Color]]),this._configuration=new HeatmapDensityTechnique_b}getConfiguration(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}createGLMaterial(R){return new HeatmapDensityMaterial_d(R)}intersect(){}intersectDraped(R,G,H,W,q,Q){const J=R.attributes.get(Wt.r.POSITION),{parameters:X}=this,{searchRadius:$}=X,{screenToWorldRatio:K}=R,ee=$*K+2*K,te=ee*ee,ie=J.data.length/J.size;for(let re=0;re<ie;re++){const R=re*J.size,G=(0,Yn.hZ)(Sm,J.data[R],J.data[R+1]);(0,Yn.hG)(G,W)<te&&q(Q.dist,Q.normal,-1,!1)}}createBufferWriter(){return new HeatmapDensityMaterial_g(this.parameters.isAttributeDriven?bm:vm)}}class HeatmapDensityMaterial_d extends On.A{beginSlot(R){return this.ensureTechnique(HeatmapDensityTechnique_f,R)}}class HeatmapDensityMaterial_g{constructor(R){this.vertexBufferLayout=R}elementCount(R){return R.attributes.get(Wt.r.POSITION).indices.length*xm}write(R,G,H,W,q){(0,In.Hk)(H.attributes.get(Wt.r.POSITION),R,W.position,q,xm);const Q=H.attributes.get(Wt.r.POSITION).indices.length,J=W.uv0;let X=q;for(let K=0;K<Q;++K)J.setValues(X++,-1,-1),J.setValues(X++,1,-1),J.setValues(X++,1,1),J.setValues(X++,1,1),J.setValues(X++,-1,1),J.setValues(X++,-1,-1);const $=Wt.r.FEATUREATTRIBUTE in W?W.featureAttribute:null;$&&(0,In.uO)(H.attributes.get(Wt.r.FEATUREATTRIBUTE),$,q,xm)}}const vm=(0,Tn.BP)().vec3f(Wt.r.POSITION).vec2f(Wt.r.UV0),bm=vm.clone().f32(Wt.r.FEATUREATTRIBUTE),xm=6,Sm=(0,Xi.vt)();var Cm=H(74011);let wm=class extends Q.A{constructor(R){super(R),this.type="heatmap",this.preferredUpdatePolicy=sa.ASYNC,this.dataExtent=null,this.drapeSourceType=Cs.Features,this._renderGeometries=new Map,this._fieldTotal=0,this._drapeSourceRenderer=null,this._dataType=Ft.ld.HALF_FLOAT,this._pixelFormat=Ft.Ab.RGBA,this._updatingHandles=new we.U,this.initializePromise=Promise.resolve()}initialize(){this._featureStore=new dm.A({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{dataType:R,samplingMode:G,pixelFormat:H,internalFormat:W}=(0,Cm.S)(this._renderView.renderingContext,J.A.getLogger(this));this._dataType=R,this._pixelFormat=H;const q=R!==Ft.ld.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,fm,{...this._rendererParameters,dataType:R,samplingMode:G,pixelFormat:H,internalFormat:W}),this._material=new HeatmapDensityMaterial_T({usesHalfFloats:q}),this._materialWithField=new HeatmapDensityMaterial_T({usesHalfFloats:q,isAttributeDriven:!0}),this._filterVisibility=new sm({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:R=>this._setAllFeaturesVisibility(R),clearFeaturesVisibility:()=>this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:R=>this._updateFeatureVisibilities(R)}}),this._updatingHandles.addOnCollectionChange((()=>this._loadedPointGraphics),(R=>this._onLoadedFeaturesChange(R)),$.Vh),this._updatingHandles.addWhen((()=>this._materialParameters),(R=>this._forEachMaterial((G=>G.setParameters(R)))),$.Vh),this._updatingHandles.add((()=>this._rendererParameters),(R=>this._drapeSourceRenderer.set(R))),this._updatingHandles.add((()=>this._heatmapRendererField),(()=>{this._recreate()}),$.OH),this._updatingHandles.add((()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric})),(R=>{let{fieldName:G,numeric:H}=R;if(null!=G&&H){let R=0;this._featureStore.forEach((H=>{var W;return R+=null!==(W=H.attributes[G])&&void 0!==W?W:0})),this._fieldTotal=R}else this._fieldTotal=this._featureStore.numFeatures}),$.Vh),this.addHandles([(0,$.wB)((()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField})),(R=>{var G;let{fieldName:H,field:W}=R;H&&!W&&J.A.getLogger(this).warn("Heatmap renderer field '".concat(H,"' for layer '").concat(null!==(G=this.layer.title)&&void 0!==G?G:this.layer.id,"' not found"))})),(0,$.wB)((()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric})),(R=>{var G;let{field:H,numeric:W}=R;null==H||W||J.A.getLogger(this).warn("Heatmap renderer field '".concat(H.name,"' for layer '").concat(null!==(G=this.layer.title)&&void 0!==G?G:this.layer.id,"' does not contain numeric values and cannot be used to drive the heatmap density"))})),(0,ue.hA)((()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)))])}destroy(){this._renderGeometries.clear(),this._material=null,this._materialWithField=null,this._featureStore.clear(),this._featureStore=null,this._updatingHandles.destroy()}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this._updatingHandles.updating||this.filterVisibility.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get filterVisibility(){return this._filterVisibility}get displayFeatureLimit(){var R,G,H;const W=null!==(R=null===(G=this.owner)||void 0===G||null===(G=G.view)||void 0===G?void 0:G.quality)&&void 0!==R?R:1,q=null===(H=this.owner)||void 0===H||null===(H=H.view)||void 0===H?void 0:H.qualitySettings,Q=q?Math.ceil(q.heatmap.maxTotalNumberOfFeatures*W):0;return new DisplayFeatureLimit_e(6*Q,Q)}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){if(!this._isScaleRangeActive)return!1;const{minScale:R,maxScale:G}=this.layer.effectiveScaleRange,{scale:H}=this.view;return!(0,pi.JU)(H,null!==R&&void 0!==R?R:0,null!==G&&void 0!==G?G:0)}get usedMemory(){var R,G,H;const W=this.usedMemoryPerFeature*this._featureStore.numFeatures,q=this._pixelFormat===Ft.Ab.RED?1:4,Q=this._dataType===Ft.ld.FLOAT?4:2,J=null!==(R=Math.ceil((null!==(G=null===(H=this._overlayRenderer)||void 0===H||null===(H=H.overlays[0])||void 0===H?void 0:H.resolution)&&void 0!==G?G:0)*this._densityMapPixelRatio))&&void 0!==R?R:0;return J*J*q*Q+W}get usedMemoryPerFeature(){const R=this._loadedPointGraphics.find((()=>!0));if(null==R)return 0;const G=(0,Zn.eY)(R),H=(0,Zn.f3)();return 6*(0,Zn.zd)([0,0,0],H)+6*(0,Zn.zd)([0,0],H)+(this._heatmapRendererFieldIsNumeric?6*H:0)+G}get loadedFeatures(){return this._featureStore.numFeatures}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return new GraphicsCorePerformanceInfo_s(this._visibleFeatures,0,0)}get renderer(){return this._heatmapRenderer}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return this._overlayRenderer.spatialReference}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const R=this._heatmapRenderer;if(null==R)return null;const{minDensity:G,maxDensity:H}=R;return{minDensity:G,maxDensity:H,fieldTotal:this._fieldTotal}}get _radiusParameter(){const R=this._heatmapRenderer;return R?{searchRadius:(0,kr.Lz)(this._clampSearchRadius(R.radius))}:null}get _resolutionForScaleParameter(){const R=this._heatmapRenderer;if(!R)return null;const{referenceScale:G}=R;return{resolutionForScale:0===G?0:(0,cm.i1)(G,this.view.spatialReference)}}get _colorRampParameter(){const R=this._heatmapRenderer;return R?{colorRampData:(0,hm.O3)(R.colorStops)}:null}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){var R,G;return null!==(R=null===(G=this.owner)||void 0===G||null===(G=G.view)||void 0===G?void 0:G.qualitySettings.heatmap.pixelRatio)&&void 0!==R?R:1}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const R=this.layer.renderer;return"heatmap"===(null===R||void 0===R?void 0:R.type)?R:null}get _heatmapRendererFieldName(){var R;return null===(R=this._heatmapRenderer)||void 0===R?void 0:R.field}get _heatmapRendererField(){const R=this._heatmapRendererFieldName;return null!=R?this.layer.fieldsIndex.get(R):null}get _heatmapRendererFieldIsNumeric(){const R=this._heatmapRendererField;return null!=R&&(0,xi.WA)(R)}get _isScaleRangeActive(){const{layer:R}=this;if(!("effectiveScaleRange"in R))return!1;const{minScale:G,maxScale:H}=R.effectiveScaleRange;return(0,pi.WK)(G,H)}get _visibleFeatures(){let R=0;return this._renderGeometries.forEach((G=>{G.visible&&++R})),R}async whenGraphicBounds(){return null}computeAttachmentOrigin(){return null}highlight(){return(0,ue.hA)()}maskOccludee(){return(0,ue.hA)()}setObjectIdVisibility(){}refreshFilter(){this.filterVisibility.reapply()}_onLoadedFeaturesChange(R){if(!this._featuresArePoints)return;const{objectIdField:G}=this.layer;this._featureStore.removeManyById(R.removed.map((R=>(0,Mi.RW)(R,G)))),this._featureStore.addMany(R.added.map((R=>{const{attributes:H,centroid:W,geometry:q}=R,Q=new Ur.Om((0,Xn.qN)(new Gr.A,q),H,W?(0,Xn.qN)(new Gr.A,W):null,(0,Mi.RW)(R,G));return Q.displayId=R.uid,Q})));const H=R.added,W=R.removed;this._fieldTotal+=this._computeFieldTotalChange(H,W);const q=W.map((R=>{let{uid:G}=R;const H=this._renderGeometries.get(G);return this._renderGeometries.delete(G),H})).filter(ce.Ru),Q=H.map((R=>{const G=this._pointGraphicToRenderGeometry(R);return this._renderGeometries.set(R.uid,G),G}));q.length>0&&this._drapeSourceRenderer.removeGeometries(q,Go.REMOVE),Q.length>0&&this._drapeSourceRenderer.addGeometries(Q,Go.ADD),(Q.length>0||q.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}_recreate(){if(!this._loadedPointGraphics)return;const R=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:R,removed:R})}_pointGraphicToRenderGeometry(R){var G;const H=this._heatmapRendererFieldName,W=null!=H?this._materialWithField:this._material,q=(0,xe.vt)();(0,mn.g)(R.geometry,q,this._overlaySpatialReference),q[2]=-2;const Q=(0,Ue.tM)(1),J=[[Wt.r.POSITION,new tr.n(q,Q,q.length)]],X=this._heatmapRendererFieldIsNumeric;null!=H&&J.push([Wt.r.FEATUREATTRIBUTE,new tr.n([X&&null!==(G=R.attributes[H])&&void 0!==G?G:0],Q,1)]);const $=new RenderGeometry_m(new rr.V(W,J,null,ir.X.Point),{layerUid:this.layer.uid,graphicUid:R.uid});return $.visible=this.filterVisibility.defaultVisibility,$}_forEachMaterial(R){R(this._material),R(this._materialWithField)}_computeFieldTotalChange(R,G){if(null==this._heatmapRendererFieldName||!this._heatmapRendererFieldIsNumeric)return R.length-G.length;const H=this._heatmapRendererFieldName,i=(R,G)=>{var W;return R+(null!==(W=G.attributes[H])&&void 0!==W?W:0)};return R.reduce(i,0)-G.reduce(i,0)}_clampSearchRadius(R){return R>112&&J.A.getLogger(this).warnOnce("SceneView supports a maximum radius of ".concat(112," pt for HeatmapRenderer.")),Math.min(R,112)}_updateFeatureVisibilities(R){const G=[];this._featureStore.forEach((H=>{let{objectId:W,displayId:q}=H;const Q=R(W),J=this._renderGeometries.get(q);J&&J.visible!==Q&&(G.push(J),J.visible=Q)})),this._drapeSourceRenderer.modifyGeometries(G,zo.VISIBILITY)}_setAllFeaturesVisibility(R){const G=[];for(const H of this._renderGeometries.values())H.visible!==R&&(G.push(H),H.visible=R);this._drapeSourceRenderer.modifyGeometries(G,zo.VISIBILITY)}get test(){return{visibleFeatureCount:this._visibleFeatures}}};(0,W._)([(0,ee.MZ)()],wm.prototype,"type",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],wm.prototype,"owner",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"layer",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"featureStore",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"updatingRemaining",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"suspendInfo",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"legendEnabled",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"filterVisibility",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"displayFeatureLimit",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"preferredUpdatePolicy",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"hasZ",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"hasM",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"dataExtent",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"view",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"fullOpacity",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"updatePolicy",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"drapeSourceType",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"scaleVisibilitySuspended",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"renderer",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_featureStore",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"_filterVisibility",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"_overlayRenderer",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_overlaySpatialReference",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_rendererParameters",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_materialParameters",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_densityParameters",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_radiusParameter",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_resolutionForScaleParameter",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_colorRampParameter",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_pixelRatioParameter",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_densityMapPixelRatio",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_renderGeometries",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"_material",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"_materialWithField",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"_renderView",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_featuresArePoints",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_loadedPointGraphics",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_heatmapRenderer",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_heatmapRendererFieldName",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_heatmapRendererField",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_heatmapRendererFieldIsNumeric",null),(0,W._)([(0,ee.MZ)()],wm.prototype,"_fieldTotal",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"_drapeSourceRenderer",void 0),(0,W._)([(0,ee.MZ)()],wm.prototype,"_isScaleRangeActive",null),wm=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.HeatmapFeatureProcessor")],wm);const FeatureLikeLayerView3D_b=R=>{let G=class extends R{constructor(){super(...arguments),this._dataUpdatingState=Am.NONE,this.controller=null,this.updatePolicy=sa.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.supportsHeightUnitConversion=!0,this._pendingController=null,this.queryEngine=null}initialize(){const R=this.layer;if("isTable"in R&&R.isTable)return void this.addResolvingPromise(Promise.reject(new Ze.A("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:R})));this.addResolvingPromise(this._validateGeometryType()),this._updatingHandles.add((()=>this.layer.renderer),(R=>this._recreateProcessor(R)),$.Vh),this.addResolvingPromise((async()=>{const R=await function projectExtentUtils_l(R){const G=R.view.spatialReference,H=R.layer.fullExtent,W=null!=H&&H.spatialReference;if(null==H||!W)return Promise.resolve(null);if(W.equals(G))return Promise.resolve(H.clone());const q=(0,R_.Cv)(H,G);return null!=q?Promise.resolve(q):R.view.state.isLocal?(0,r_.projectGeometry)(H,G,R.layer.portalItem).then((G=>!R.destroyed&&G?G:null)).catch((()=>null)):Promise.resolve(null)}(this);this.fullExtentInLocalViewSpatialReference=R,await this._initializeController()})()),this._updatingHandles.add((()=>this.updatePolicy),(R=>this.processor.preferredUpdatePolicy=R));const r=()=>this.processor.featureStore;this.queryEngine=new nm({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return r()},hasZ:this.hasZ,hasM:this.hasM},priority:ot.W6.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}destroy(){this._destroyPendingController(),this.controller=(0,Qe.pR)(this.controller),this._set("processor",(0,Qe.pR)(this.processor)),this.queryEngine=(0,Qe.pR)(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=(0,Qe.pR)(this._pendingController)}get dataUpdating(){return this._dataUpdatingState!==Am.NONE}get legendEnabled(){var R;return this.canResume()&&(null===(R=this.processor)||void 0===R?void 0:R.legendEnabled)}get graphics3DProcessor(){var R;return"graphics-3d"===(null===(R=this.processor)||void 0===R?void 0:R.type)?this.processor:null}get heatmapProcessor(){var R;return"heatmap"===(null===(R=this.processor)||void 0===R?void 0:R.type)?this.processor:null}get symbologySnappingSupported(){var R,G;const H=null===(R=this.layer)||void 0===R||null===(R=R.renderer)||void 0===R?void 0:R.getSymbols();return null!==(G=null===H||void 0===H?void 0:H.some(Ll.f3))&&void 0!==G&&G}get hasAllFeatures(){return!(!this.controller||!("hasAllFeatures"in this.controller))&&this.controller.hasAllFeatures}get hasAllFeaturesInView(){return!(!this.controller||!("hasAllFeaturesInView"in this.controller))&&this.controller.hasAllFeaturesInView}get hasFullGeometries(){return!(!this.controller||!("hasFullGeometries"in this.controller))&&this.controller.hasFullGeometries}getHit(R){var G;let H;return null!==(G=this.loadedGraphics)&&void 0!==G&&G.forEach((G=>{G.uid===R&&(H=hydratedFeatures_c(G,this.layer))})),H?{type:"graphic",graphic:H,layer:H.layer}:null}whenGraphicBounds(R,G){var H;return null===(H=this.processor)||void 0===H?void 0:H.whenGraphicBounds(R,G)}computeAttachmentOrigin(R,G){var H;return null===(H=this.processor)||void 0===H?void 0:H.computeAttachmentOrigin(R,G)}async elevationAlignPointsInFeatures(R,G){const H=this.graphics3DProcessor;if(null==H)throw new Ze.A("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return async function elevationAlignPointsInFeatures_m(R,G,H,W,q){var Q;const{elevationProvider:J,renderCoordsHelper:$}=R,{elevationInfo:K}=G,{pointsInFeatures:ee,spatialReference:te}=W,ie=Jt.A.fromJSON(te),re=featureExpressionInfoUtils_d(K,!0),ne=await featureExpressionInfoUtils_a(re,ie,q);(0,X.Te)(q);const se=[],ae=new Set,oe=new Set,le=new ElevationContext_o,ce=(0,We.T)(0,0,0,Jt.A.WGS84),de=new elevationAlignmentUtils_R,he=(0,xe.vt)();ce.spatialReference=ie;const ue=null!==(Q=R.elevationProvider.spatialReference)&&void 0!==Q?Q:R.spatialReference;for(const{objectId:X,points:_e}of ee){const R=H(X);if(null==R){for(const R of _e){var pe;se.push(null!==(pe=R.z)&&void 0!==pe?pe:0)}ae.add(X);continue}R.isDraped&&oe.add(X);const W=R.graphic.geometry;le.setFromElevationInfo((0,N_.ze)(W,K)),le.updateFeatureExpressionInfoContext(ne,R.graphic,G);for(const{x:G,y:H,z:Q}of _e)ce.x=G,ce.y=H,ce.z=null!==Q&&void 0!==Q?Q:0,await(0,mn.W)(ce,he,ue,0,{signal:q}),elevationAlignmentUtils_c(he,J,le,$,de),se.push(de.z)}return{elevations:se,drapedObjectIds:oe,failedObjectIds:ae}}(this.view,this.layer,(R=>H.getGraphics3DGraphicByObjectId(R)),R,G)}async queryForSymbologySnapping(R,G){return this.symbologySnappingSupported?async function queryForSymbologySnapping_r(R,G,H){var W;if(null==R||0===G.candidates.length)return lm;const q=null!==(W=R.graphics3DGraphicsByObjectID)&&void 0!==W?W:R.graphics3DGraphics,Q=[],J=[],{renderer:$}=R,K=null!=$&&"arcadeRequired"in $&&$.arcadeRequired?(0,$t.lw)():null,l=async(G,W)=>{let{graphic:q,graphics3DSymbol:Q}=W;const J=await K,X=await R.getRenderingInfoAsync(q,$,J,{signal:H});return null==X?[]:Q.queryForSnapping(G,te,X,H)},{candidates:ee,spatialReference:te}=G;for(let X=0;X<ee.length;++X){const R=ee[X],{objectId:G}=R,H="number"==typeof G?null===q||void 0===q?void 0:q.get(G):void 0;if(null==H)continue;const{graphics3DSymbol:W}=H;W.symbologySnappingSupported&&(Q.push(l(R,H)),J.push(X))}if(0===Q.length)return lm;const ie=await Promise.all(Q);(0,X.Te)(H);const re=[],ne=[];for(let X=0;X<ie.length;++X){const R=ie[X],G=J[X];for(const H of R)re.push(H),ne.push(G)}return{candidates:re,sourceCandidateIndices:ne}}(this.graphics3DProcessor,R,G):{candidates:[],sourceCandidateIndices:[]}}queryFeatures(R,G){return this.queryEngine.executeQuery(this._ensureQuery(R),null===G||void 0===G?void 0:G.signal)}queryObjectIds(R,G){return this.queryEngine.executeQueryForIds(this._ensureQuery(R),null===G||void 0===G?void 0:G.signal)}queryFeatureCount(R,G){return this.queryEngine.executeQueryForCount(this._ensureQuery(R),null===G||void 0===G?void 0:G.signal)}queryExtent(R,G){return this.queryEngine.executeQueryForExtent(this._ensureQuery(R),null===G||void 0===G?void 0:G.signal)}_ensureQuery(R){return null==R?this.createQuery():o_.A.from(R)}highlight(R){return this.processor.highlight(R,this.layer.objectIdField)}maskOccludee(R){return this.processor.maskOccludee(R)}canResume(){var R;return super.canResume()&&!(null!==(R=this.processor)&&void 0!==R&&R.scaleVisibilitySuspended)}getSuspendInfo(){const R=super.getSuspendInfo();return this.processor?{...R,...this.processor.suspendInfo}:R}isUpdating(){var R,G;return!(!this.processor||this.processor.destroyed)&&!(this._controllerCreated&&(null===(R=this.controller)||void 0===R||!R.updating)&&null!==(G=this.view)&&void 0!==G&&null!==(G=G.basemapTerrain)&&void 0!==G&&G.ready&&!this.processor.updating)}async _initializeController(){const R=this.createController();this._pendingController=R,this._setupDataUpdating(R),await R.when(),this._setControllerWhenInitialized(R)}_setupDataUpdating(R){"dataUpdating"in R&&this.addHandles([(0,$.wB)((()=>R.dataUpdating),(R=>{R&&this._dataUpdatingState===Am.NONE?this._dataUpdatingState=Am.CONTROLLER:R||this._dataUpdatingState!==Am.CONTROLLER||(this._dataUpdatingState=Am.NONE)}),$.OH),(0,$.wB)((()=>{var R;return!(null===(R=this.graphics3DProcessor)||void 0===R||!R.dataUpdating)}),(G=>{G&&this._dataUpdatingState===Am.CONTROLLER?this._dataUpdatingState=Am.CORE:G||this._dataUpdatingState!==Am.CORE||(this._dataUpdatingState=R.dataUpdating?Am.CONTROLLER:Am.NONE)}),$.OH)])}async _setControllerWhenInitialized(R){try{await this.when()}catch(G){}this._controllerCreated=!0,this.notifyChange("updating"),this.isResolved()&&!this.destroyed?(await(0,$.C_)((()=>{var R;return null===(R=this.view)||void 0===R||null===(R=R.basemapTerrain)||void 0===R?void 0:R.ready})),this.beforeSetController(R),this._pendingController=null,this.controller=R,this.loadedGraphics=R.graphics,this.notifyChange("updating")):this._destroyPendingController()}_updateClippingExtent(R){if(this.clippingExtent=R,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=R,!0}}async _validateGeometryType(){switch(this.layer.geometryType){case"multipatch":case"multipoint":throw new Ze.A("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType})}}_recreateProcessor(R){var G,H;const W="heatmap"===(null===R||void 0===R?void 0:R.type),q="heatmap"===(null===(G=this.processor)||void 0===G?void 0:G.type),Q=this.processor;if(Q&&W===q)return;const J=W?new wm({owner:this}):new am({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:R=>this._updateClippingExtent(R)});this._set("processor",J),null!==Q&&void 0!==Q&&Q.destroy(),null!==(H=this.queryEngine)&&void 0!==H&&H.clear(),this.addResolvingPromise(J.initializePromise)}get performanceInfo(){var R,G,H;const W=this.controller instanceof I_?this.controller:null;return new LayerViewPerformanceInfo_t(this.processor.usedMemory,null===(R=this.loadedGraphics)||void 0===R?void 0:R.length,null!==(G=null===W||void 0===W?void 0:W.serviceDataCount)&&void 0!==G?G:-1,null!==(H=null===W||void 0===W?void 0:W.maximumNumberOfFeatures)&&void 0!==H?H:-1,0,this.processor.performanceInfo)}};return(0,W._)([(0,ee.MZ)()],G.prototype,"loadedGraphics",void 0),(0,W._)([(0,ee.MZ)()],G.prototype,"_dataUpdatingState",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"dataUpdating",null),(0,W._)([(0,ee.MZ)()],G.prototype,"suspended",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"legendEnabled",null),(0,W._)([(0,ee.MZ)()],G.prototype,"updating",void 0),(0,W._)([(0,ee.MZ)()],G.prototype,"controller",void 0),(0,W._)([(0,ee.MZ)()],G.prototype,"processor",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"updatePolicy",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"suspendResumeExtentMode",void 0),(0,W._)([(0,ee.MZ)({type:Boolean})],G.prototype,"slicePlaneEnabled",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"suspendInfo",void 0),(0,W._)([(0,ee.MZ)()],G.prototype,"graphics3DProcessor",null),(0,W._)([(0,ee.MZ)()],G.prototype,"heatmapProcessor",null),(0,W._)([(0,ee.MZ)()],G.prototype,"symbologySnappingSupported",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"hasAllFeatures",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"hasAllFeaturesInView",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],G.prototype,"hasFullGeometries",null),G=(0,W._)([(0,ie.$)("esri.views.3d.layers.FeatureLikeLayerView3D")],G),G};var Am;!function(R){R[R.NONE=0]="NONE",R[R.CONTROLLER=1]="CONTROLLER",R[R.CORE=2]="CORE"}(Am||(Am={}));var Rm=H(48284);const LayerView3D_n=R=>{let G=class extends R{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(R){super.postscript(R),(0,Rm.jI)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const R=new AbortController,G=R.signal;this.addHandles((0,ue.hA)((()=>R.abort()))),await(0,$.C_)((()=>{var R;return null===(R=this.view.defaultsFromMap)||void 0===R?void 0:R.heightModelInfoReady}),G),(0,X.Te)(G);const H=(0,Rm.Hu)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(H)throw H}canResume(){const R=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!(null!==R&&void 0!==R&&R.minScale)||!R.maxScale||R.minScale>=R.maxScale)}getSuspendInfo(){const R=super.getSuspendInfo(),G=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return G&&G.minScale&&G.maxScale&&G.minScale<G.maxScale&&(R.outsideScaleRange=!0),R}};return(0,W._)([(0,ee.MZ)()],G.prototype,"view",void 0),(0,W._)([(0,ee.MZ)()],G.prototype,"slicePlaneEnabled",void 0),G=(0,W._)([(0,ie.$)("esri.views.3d.layers.LayerView3D")],G),G};var Tm=H(83947);class PBFDecoder_n{constructor(R){this._controller=R,this._handle=new PBFDecoder_c((G=>R.schedule(G)))}destroy(){this._handle.destroy()}invoke(R,G){return R.buffer&&0!==R.buffer.byteLength?(R.options.sourceSpatialReference&&R.options.sourceSpatialReference instanceof Jt.A&&(R.options={...R.options,sourceSpatialReference:R.options.sourceSpatialReference.toJSON()}),this._handle.invoke(R,G).then((R=>{let G=0,H=0;const W=Jt.A.fromJSON(R.spatialReference);R.spatialReference=W;const i=async q=>{const Q=R.fields;if(Q)for(;G<Q.length;)if(Q[G]=c_.A.fromJSON(Q[G]),G++,q.madeProgress())return this._controller.reschedule((R=>i(R)));const J=R.features;for(;H<J.length;){const R=J[H];++H,R.uid=le.A.generateUID();const G=R.geometry;if(null!=G&&(G.spatialReference=W,PBFDecoder_a(G),q.madeProgress()))return this._controller.reschedule((R=>i(R)))}return R};return this._controller.schedule((R=>i(R)))}))):Promise.resolve(null)}}function PBFDecoder_a(R){switch(R.type){case"polyline":R.paths.reduce(((R,G)=>R+G.length),0)<_e.y9&&(R.paths=R.hasZ||R.hasM?R.paths.map((R=>R.map((R=>[R[0],R[1],R[2]])))):R.paths.map((R=>R.map((R=>[R[0],R[1]])))));break;case"polygon":R.rings.reduce(((R,G)=>R+G.length),0)<_e.y9&&(R.rings=R.hasZ||R.hasM?R.rings.map((R=>R.map((R=>[R[0],R[1],R[2]])))):R.rings.map((R=>R.map((R=>[R[0],R[1]])))))}}class PBFDecoder_c extends ne.B{constructor(R){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:R=>[R.buffer]},R)}}let Em=class extends Q.A{constructor(R){super(R)}get implicitFields(){var R;if(!(null===(R=this.layer.outFields)||void 0===R?void 0:R.includes("*")))return new Set;const G=new Set(this.layerView.requiredFields),H=new Set(this.layerView.availableFields);return(0,Es.iv)(H,G)}get queryFeaturesDehydrated(){const{layer:R}=this,G=R.capabilities,H=G&&G.query,W=H&&H.supportsFormatPBF,q=R.parsedUrl;if(W){var Q,J;null==this._decoder&&(this._decoder=new PBFDecoder_n(this.controller));const G={sourceSpatialReference:null!==(Q=null===(J=R.spatialReference)||void 0===J?void 0:J.toJSON())&&void 0!==Q?Q:null,applyTransform:!0,maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:Im};return(R,H)=>(0,Tm.GB)(q,R,"pbf",this._createRequestOptions(H)).then((R=>((0,X.Te)(H),null!=this._decoder?this._decoder.invoke({buffer:R.data,options:G},H.signal):Promise.reject((0,X.NK)()))))}return(G,H)=>(0,Tm.eW)(q,G,R.spatialReference,this._createRequestOptions(H)).then((R=>(0,Mi.JS)(R.data,{maxStringAttributeFields:this.implicitFields,maxStringAttributeLength:Im})))}queryFeatureCount(R,G){return this.layer.queryFeatureCount(R,G)}destroy(){this._decoder=(0,Qe.pR)(this._decoder)}_createRequestOptions(R){return{...R,query:{...this.layer.customParameters,token:this.layer.apiKey,...null===R||void 0===R?void 0:R.query}}}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Em.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Em.prototype,"layerView",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Em.prototype,"controller",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Em.prototype,"implicitFields",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Em.prototype,"queryFeaturesDehydrated",null),Em=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],Em);let Om=class extends Q.A{constructor(R){super(R)}queryFeaturesDehydrated(R,G){return this.layer.queryFeatures(R,G)}queryFeatureCount(R,G){return this.layer.queryFeatureCount(R,G)}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Om.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Om.prototype,"queryFeaturesDehydrated",null),Om=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],Om);let Pm=class extends Q.A{constructor(R){super(R)}queryFeaturesDehydrated(R,G){return this.layer.queryFeatures(R,G)}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Pm.prototype,"layer",void 0),Pm=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],Pm);let Mm=class extends Q.A{constructor(R){super(R)}queryFeaturesDehydrated(R,G){return this.source.queryFeaturesJSON(R,G).then(Mi.JS,(H=>{if(H&&"query-features-json:unsupported"===H.name)return this.layer.queryFeatures(R,G);throw H}))}queryFeatureCount(R,G){return this.layer.queryFeatureCount(R,G)}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Mm.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Mm.prototype,"source",void 0),Mm=(0,W._)([(0,ie.$)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],Mm);const Im=1024;class FeatureTileFetcher3DLayerViewContext_i{constructor(R){this._memoryCache=null,this._capabilities=null;const G=R.layerView.layer;this._layerView=R.layerView,this.objectIdField=G.objectIdField,this.globalIdField="globalIdField"in G?G.globalIdField:null,this._returnZ=R.returnZ,this._returnM=R.returnM;const H=this._layerView.view.resourceController;this.query=function featureTileQuery3D_F(R,G){const{layer:H}=R;return"feature"===H.type&&"feature-layer"===H.source.type?null!=H.infoFor3D?new Om({layer:H}):new Em({layer:H,layerView:R,controller:G}):"feature"===H.type&&"memory"===H.source.type||"csv"===H.type||"geojson"===H.type||"oriented-imagery"===H.type||"wfs"===H.type?new Mm({layer:H,source:H.source}):"ogc-feature"===H.type?new Pm({layer:H}):null}(this._layerView,H.normal),H&&this._memoryCacheEnabled&&(this._memoryCache=H.memoryController.newCache("fl-".concat(G.uid)))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=(0,Qe.pR)(this._memoryCache),this.query.destroy()}createQuery(){const R=this._layerView.layer.createQuery();return R.outFields=this._layerView.availableFields,R.returnZ=this._returnZ,R.returnM=this._returnM,R.outSpatialReference=this.tilingScheme.spatialReference,R}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles.tilingScheme}get scheduler(){const R=this._layerView.view.resourceController;return R?R.scheduler:null}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return null!=this._capabilities||(this._capabilities=function FeatureTileFetcher3D_P(R){const G=R.capabilities.query;return{supportsMultipleResolutions:FeatureTileFetcher3D_I(R),supportsPagination:!(!G||!G.supportsPagination),supportsResultType:!(!G||!G.supportsResultType),supportsCacheHint:!(!G||!G.supportsCacheHint),supportsQuantization:!(!G||!G.supportsQuantization),supportsQuantizationEditMode:!(!G||!G.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!G||!G.supportsMaxRecordCountFactor),supportsFormatPBF:!(!G||!G.supportsFormatPBF)}}(this._layerView.layer)),this._capabilities}logFetchError(R,G){var H;R.error("#fetchTile()",this._layerView.layer,null!==(H=null===G||void 0===G?void 0:G.message)&&void 0!==H?H:G)}}var Dm=H(52020);class EventedSet_h extends Vr.A{constructor(){super(...arguments),this._set=new Set,this._length=(0,u_.v)(0)}clear(){if(this._set.size>0){const R=this.toArray();this._set.clear(),this.emit("after-changes",{type:Dm.R.REMOVE}),this.emit("change",{added:[],removed:R})}}get length(){return this._length.value}addMany(R){if(0!==R.length){for(const G of R)this._set.add(G);this._length.value=this._set.size,this.emit("after-changes",{type:Dm.R.ADD}),this.emit("change",{added:R,removed:[]})}}remove(R){this._set.delete(R)&&(this._length.value=this._set.size,this.emit("after-changes",{type:Dm.R.REMOVE}),this.emit("change",{added:[],removed:[R]}))}removeMany(R){const G=[];for(const H of R)this._set.delete(H)&&G.push(H);G.length>0&&(this._length.value=this._set.size,this.emit("after-changes",{type:Dm.R.REMOVE}),this.emit("change",{added:[],removed:G}))}toArray(){return[...this._set]}find(R){let G;return(0,Es.bw)(this._set,(H=>!!R(H)&&(G=H,!0))),G}forEach(R){this._set.forEach((G=>R(G)))}}const Lm={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};var Fm=H(67612),Nm=H(27012),Vm=H(59995);let Um=class extends((0,Vm.A)(FeatureLikeLayerView3D_b((0,Fm.A)(LayerView3D_n(Nm.A))))){constructor(R){super(R),this._controllerTotal=0,this._processorTotal=0,this._needsRefresh=!1,this.suspendResumeExtentMode="data"}initialize(){this.addHandles([(0,$.wB)((()=>this._updatingRequiredFieldsPromise),(R=>this._updatingHandles.addPromise(R)),$.pc),(0,$.wB)((()=>({controller:this.controller,suspended:this.suspended})),(R=>{let{controller:G,suspended:H}=R;G&&!H&&this._needsRefresh&&(G.refetch(),this._needsRefresh=!1)}))])}destroy(){this._updatingHandles.removeAll(),this._fetcherContext=(0,Qe.pR)(this._fetcherContext)}get maximumNumberOfFeatures(){var R,G;return null!==(R=null===(G=this.controller)||void 0===G?void 0:G.maximumNumberOfFeatures)&&void 0!==R?R:this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(R){this._set("maximumNumberOfFeatures",R),this.controller&&(this.controller.maximumNumberOfFeatures=R)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var R,G;let H=0;if(null!==(R=this.controller)&&void 0!==R&&R.updating){const R=this.controller.updatingRemaining,G=Math.max(this.controller.updatingTotal,this._controllerTotal);G>0&&(H=(G-R)/G,this._controllerTotal=G)}let W=0;if(null!==(G=this.processor)&&void 0!==G&&G.updating){const R=this.processor.updatingRemaining,G=Math.max(R,this._processorTotal);G>0&&(W=(G-R)/G,this._processorTotal=G)}return.5*(H+W)}get updatePolicy(){if(!this.controller)return sa.ASYNC;switch(this.controller.mode){case"snapshot":{const R=Gm.get(this.layer.geometryType);return null==R||this.controller.serviceDataCount>R?sa.ASYNC:sa.SYNC}case"tiles":return sa.ASYNC}}get hasZ(){const R=this.layer,G=R.capabilities&&R.capabilities.data;return!(!G||!G.supportsZ)&&("returnZ"in R&&null!=R.returnZ?R.returnZ:G.supportsZ)}get hasM(){const R=this.layer,G=R.capabilities&&R.capabilities.data;return!(!G||!G.supportsM)&&"returnM"in R&&null!=R.returnM&&R.returnM}setVisibility(R,G){var H;null===(H=this.processor)||void 0===H||H.setObjectIdVisibility(R,G)}createQuery(){return super.createQuery()}queryFeatures(R,G){const t=()=>super.queryFeatures(R,G);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(R),t):t()}beforeSetController(R){R.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this._fetcherContext=new FeatureTileFetcher3DLayerViewContext_i({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const R=new I_({layerView:this,context:this._fetcherContext,graphics:new EventedSet_h,extent:this.clippingExtent});return this._updatingHandles.add((()=>R.serviceDataExtent),(R=>{this.processor&&(this.processor.dataExtent=R)}),$.Vh),this.addHandles((0,$.wB)((()=>this.suspended),(G=>{G?R.suspend():R.resume()}),$.pc)),this._updatingHandles.add((()=>{var R;return null===(R=this.processor)||void 0===R?void 0:R.displayFeatureLimit}),(G=>R.displayFeatureLimit=G),$.Vh),this.addHandles((0,$.z7)((()=>!this.updating),(()=>{this._controllerTotal=0,this._processorTotal=0}))),R}async doRefresh(R){const{controller:G,processor:H,suspended:W}=this;R&&G&&(W?this._needsRefresh=!0:(G.refetch(),this._needsRefresh=!1)),H.refreshFilter()}_popupFeatureHasRequiredFields(R,G){if(!super._popupFeatureHasRequiredFields(R,G))return!1;const H=(0,Mi.RW)(R,this.layer.objectIdField);if(null==H)return!0;const W=this.controller.getMissingAttributesForFeature(H);if(null==W)return!0;for(const q of G)if(W.has(q))return!1;return!0}get usedMemory(){var R,G,H,W;return(null!==(R=null===(G=this.processor)||void 0===G?void 0:G.usedMemory)&&void 0!==R?R:0)+(null!==(H=null===(W=this.controller)||void 0===W?void 0:W.memoryForUnusedFeatures)&&void 0!==H?H:0)}get unloadedMemory(){var R,G,H,W,q,Q,J,X;const $=null!==(R=null===(G=this.processor)||void 0===G?void 0:G.unprocessedMemoryEstimate)&&void 0!==R?R:0,K=null!==(H=null===(W=this.controller)||void 0===W?void 0:W.expectedFeatureDiff)&&void 0!==H?H:0,ee=null!==(q=null===(Q=this.processor)||void 0===Q?void 0:Q.loadedFeatures)&&void 0!==q?q:0,te=ee+K>0?ee/(ee+K):1;return $+K*(null!==(J=null===(X=this.processor)||void 0===X?void 0:X.usedMemoryPerFeature)&&void 0!==J?J:0)*te}get ignoresMemoryFactor(){var R;return null===(R=this.controller)||void 0===R?void 0:R.hasMaximumNumberOfFeaturesOverride}async _queryFeaturesMesh(R,G){await this._validateQueryFeaturesMesh(R);const H=await G();if(null!==R&&void 0!==R&&R.outStatistics||null==this.graphics3DProcessor)return H;const W=this.layer.objectIdField,q=this.graphics3DProcessor.graphics3DGraphicsByObjectID,Q=[];for(const J of H.features)if(J.geometry){const R=q.get(J.attributes[W]);R&&(J.geometry=hydratedFeatures_u(R.graphic.geometry),Q.push(J))}else Q.push(J);return H.features=Q,H}async _validateQueryFeaturesMesh(R){if(!R)return;const t=R=>{throw new Ze.A("feature-layer-view:unsupported-query","Queries on Mesh feature collection layers do not support '".concat(R,"'"))},G=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const H of G)null!=R[H]&&t(H);"returnM"in R&&R.returnM&&t("returnM"),"returnCentroid"in R&&R.returnCentroid&&t("returnCentroid"),null==R.outSpatialReference||R.outSpatialReference.equals(this.view.spatialReference)||t("outSpatialReference")}get performanceInfo(){var R,G,H,W,q,Q,J;const X=null===(R=this.controller)||void 0===R?void 0:R.displayFeatureLimit,$=null!=X?X.averageSymbolComplexity:void 0,K=null!=$?"f:".concat($.verticesPerFeature,",v:").concat($.verticesPerCoordinate):"n/a";return new FeatureLayerViewPerformanceInfo_t(super.performanceInfo,null!==(G=null===(H=this.controller)||void 0===H||null===(H=H.performanceInfo)||void 0===H?void 0:H.storedFeatures)&&void 0!==G?G:0,null!==(W=null===(q=this.controller)||void 0===q||null===(q=q.performanceInfo)||void 0===q?void 0:q.totalVertices)&&void 0!==W?W:0,this.maximumNumberOfFeaturesExceeded,null!==(Q=null===(J=this.controller)||void 0===J?void 0:J.mode)&&void 0!==Q?Q:"n/a",K)}get test(){var R;return{updatePolicy:this.updatePolicy,controller:this.controller,loadedGraphics:null===(R=this.controller)||void 0===R?void 0:R.graphics,...this.getTest()}}};(0,W._)([(0,ee.MZ)()],Um.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)()],Um.prototype,"controller",void 0),(0,W._)([(0,ee.MZ)()],Um.prototype,"_controllerTotal",void 0),(0,W._)([(0,ee.MZ)()],Um.prototype,"_processorTotal",void 0),(0,W._)([(0,ee.MZ)()],Um.prototype,"_needsRefresh",void 0),(0,W._)([(0,ee.MZ)()],Um.prototype,"maximumNumberOfFeatures",null),(0,W._)([(0,ee.MZ)()],Um.prototype,"maximumNumberOfFeaturesExceeded",null),(0,W._)([(0,ee.MZ)(Lm)],Um.prototype,"updatingProgress",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Um.prototype,"updatingProgressValue",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Um.prototype,"updatePolicy",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Um.prototype,"hasZ",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Um.prototype,"hasM",null),(0,W._)([(0,ee.MZ)()],Um.prototype,"suspendResumeExtentMode",void 0),Um=(0,W._)([(0,ie.$)("esri.views.3d.layers.FeatureLayerViewBase3D")],Um);const Gm=new Map([["point",5e3],["polygon",500],["polyline",1e3]]),zm=Um;let Bm=class extends zm{constructor(){super(...arguments),this.type="feature-3d",this.direct3DObjectFeatureLayerDisplayEnabled=(0,dt.Qf)()}initialize(){var R;const{layer:G,view:H}=this;null!==(R=(0,t_.BR)(G))&&void 0!==R&&R.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new Ze.A("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:G}))),null!=G.infoFor3D&&(this.direct3DObjectFeatureLayerDisplayEnabled?this._set("suspendResumeExtentMode","computed"):this.addResolvingPromise(Promise.reject(new Ze.A("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ".concat(G.geometryType))))),"mesh"!==G.geometryType||(0,Ei.canProjectWithoutEngine)(G.spatialReference,H.spatialReference)||this.addResolvingPromise(Promise.reject(new Ze.A("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get featureSpatialReference(){var R;return null===(R=this.view.featureTiles)||void 0===R||null===(R=R.tilingScheme)||void 0===R?void 0:R.spatialReference}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Bm.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,W._)([(0,ee.MZ)()],Bm.prototype,"layer",void 0),Bm=(0,W._)([(0,ie.$)("esri.views.3d.layers.FeatureLayerView3D")],Bm);const Hm=Bm,jm="esri.views.3d.layers.i3s.I3SOverrides";let Wm=class extends Q.A{constructor(R){super(R),this._warnMaximumChangedObjectsExceeded=!1,this._maximumNumberOfEditOVerrides=qm,this._original3DOFLDefinitionExpression=null,this._interactiveEditingSessions=new he.A,this.geometryOverrides=new he.A,this._clientGeometryCache=new Map,this._associatedLayerView=null,this._attributeChangedObjectIds=new Xp.A,this._geometryChangedObjectIds=new Xp.A,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController,this._featureIdLocks=new Map}initialize(){var R;this._memCache=this.memoryController.newCache("i3s-attribute-overrides-".concat(this.layer.uid)),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(null===(R=this._pendingFetchAbortController)||void 0===R?void 0:R.signal),this._pendingFetchChangedObjectIds.finally((()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null})),this.is3DOFL&&null!=this._associatedLayer&&((0,dt.Qf)()?this._associatedLayer.load().then((R=>{this.destroyed||(this._original3DOFLDefinitionExpression=R.definitionExpression,this.addHandles((0,$.wB)((()=>this._definitionExpression),(G=>R.definitionExpression=G),$.Vh)),this._associatedLayerView=new Hm({layer:this._associatedLayer,view:this.view}))})):(0,dt.lC)())}destroy(){this.is3DOFL&&null!=this._associatedLayer&&((0,dt.Qf)()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):(0,dt.lC)()),this._set("layer",null),this._memCache=(0,Qe.pR)(this._memCache),this._pendingFetchAbortController=(0,Qe.DC)(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}get is3DOFL(){var R;return(0,dt.Vo)()&&null!=(null===(R=this._associatedLayer)||void 0===R?void 0:R.infoFor3D)}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort(((R,G)=>R-G)):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return this._geometryChangedObjectIds.size>0}get _definitionExpression(){const R=this.sortedGeometryChangedObjectIds;return 0===R.length?"1 = 0":"OBJECTID IN (".concat(R.join(","),")")}get updating(){return!!this.is3DOFL&&(!!this._pendingFetchChangedObjectIds||!!(0,dt.Qf)()&&(!(null!=this._associatedLayerView)||null!=this._associatedLayerView&&this._associatedLayerView.updating))}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(R){return this._geometryChangedObjectIds.has(R)}featureHasAttributeChanges(R){return this._attributeChangedObjectIds.has(R)}createInteractiveEditSession(R){this._attributeChangedObjectIds.add(R);const G=this._interactiveEditingSessions,H=new I3SOverrides_M(R,(()=>{G.remove(H)}));return G.unshift(H),H}async applyAttributeOverrides(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(this._pendingFetchChangedObjectIds&&await(0,X.qr)(this._pendingFetchChangedObjectIds,H),null==G)return;const{attributeData:q,loadedAttributes:Q}=G;if(null==Q||null==q||0===this._attributeChangedObjectIds.size)return;const J=new Set;for(const X of Q)J.add(X.index);for(const X of W)J.has(X.index)||(Q.push(X),q[X.name]=new Array(R.length));const $=await this._lockFeatureIds(R);try{const G={attributeData:q,loadedAttributes:Q},W=this._getOverridesFromCache(R,G,this._attributeChangedObjectIds),{objectIds:J,fieldNames:X}=W;if(0===J.length||0===X.length)return;const $=await this._queryAttributeOverridesFromAssociatedLayer(J,X,H);if(null==$)return;this._processOverridesFromAssociatedLayer(R,$,X,G)}finally{$.remove()}}updateGeometry(R,G){this._geometryChangedObjectIds.add(R);const H=this._clientGeometryCache.get(R);if(null!=H&&(this.geometryOverrides.remove(H),this._clientGeometryCache.delete(R)),null!=G){const H={oid:R,mesh:G};this.geometryOverrides.add(H),this._clientGeometryCache.set(R,H)}}updateAttributeValue(R,G,H){this._attributeChangedObjectIds.add(R),this._cacheAttributeValue(R,G,H)}featureAdded(R){this.is3DOFL&&(0,dt.lC)()&&this._geometryChangedObjectIds.add(R),this._attributeChangedObjectIds.add(R)}_cacheAttributeValue(R,G,H){this._memCache.put(this._getAttributeCacheKey(R,G),H,this._memCacheAttributeValueSize(H))}_getOverridesFromCache(R,G,H){let{loadedAttributes:W,attributeData:q}=G;const Q=new Set,J=new Array;for(const $ of W)J[$.index]=q[$.name];const X=new Set;for(let $=0;$<R.length;$++){const G=R[$];if(H.has(G))for(const R of W){const H=this._attributeFromCache(G,R.index);void 0===H?(Q.add(G),X.add(R.name)):J[R.index][$]=H}}return{objectIds:Array.from(Q),fieldNames:Array.from(X)}}_attributeFromCache(R,G){const H=this._fromInteractiveEditingSession(R,G);if(void 0!==H)return H;const W=this._getAttributeCacheKey(R,G);return this._memCache.get(W)}_fromInteractiveEditingSession(R,G){if(null!=this._interactiveEditingSessions)for(const H of this._interactiveEditingSessions){if(H.objectId!==R)continue;const W=H.getAttribute(G);if(void 0!==W)return W}}_getAttributeCacheKey(R,G){return"".concat(R,"-").concat(G)}async _queryAttributeOverridesFromAssociatedLayer(R,G,H){if(0===R.length)return null;this._logWarningIfMaximumObjectsExceeded();const{associatedLayer:W}=this.layer;if(null==W)return null;const q=W.createQuery(),{objectIdField:Q}=W,J=[Q,...G];q.where="1=1",q.returnGeometry=!1,q.outFields=J,q.cacheHint=!0;const X=await this._executeBatchQuery(W,R,q,H),$=[];for(const K of X)if(K.ok)for(const R of K.value.features)$.push(R);return $}async _queryGeometryOverridesFromAssociatedLayer(R,G){if(0===R.length||!this.is3DOFL||!(0,dt.lC)())return null;const H=this.layer.associatedLayer,W=H.infoFor3D,{spatialReference:q}=H,{state:{viewingMode:Q},spatialReference:X}=this.view,$=Q===qe.RT.Global,K=q.isGeographic;if($&&!K)return J.A.getLogger(jm).warn("unsupported-pcs-edits-in-global-view",this.layer.title,I3SOverrides_N(q,X,this.view.viewingMode,Zm.Mode)),null;if(!$&&K)return J.A.getLogger(jm).warn("unsupported-gcs-edits-in-local-view",this.layer.title,I3SOverrides_N(q,X,this.view.viewingMode,Zm.Mode)),null;if(!((0,Te.aI)(q,X)||$&&X.isWebMercator&&q.isWGS84))return J.A.getLogger(jm).warn("unsupported-mismatched-spatial-reference-edits",this.layer.title,I3SOverrides_N(q,X,this.view.viewingMode,Zm.SpatialReference)),null;this._logWarningIfMaximumObjectsExceeded();const{objectIdField:ee,globalIdField:te}=H,ie=[ee,...null!=te?[te]:[]],re=H.createQuery();re.where="1=1",re.returnGeometry=!0,re.outFields=ie,re.cacheHint=!0,re.returnZ=H.hasZ,re.returnM=H.hasM;const ne=await this._executeBatchQuery(H,R,re,G),se=[];for(const J of ne){if(!J.ok)continue;const R=J.value,{assetMaps:G,features:H,globalIdFieldName:Q}=R;if(null==G)continue;const X=(0,e_.assetMapFromAssetMapsJSON)(W,G);for(const J of H){const R=(0,e_.extractMesh)(J,Q,q,W,X),G=J;null!=R?(G.geometry=R,se.push(G)):G.geometry=null}}return se}_logWarningIfMaximumObjectsExceeded(){if(!this._warnMaximumChangedObjectsExceeded)return;this._warnMaximumChangedObjectsExceeded=!1;let R="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat((0,$p.ZV)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service");const G=this.layer.portalItem;G&&G.loaded?R+=" (".concat(G.portal.url,"/home/item.html?id=").concat(G.id,"#settings)"):R+=" (".concat(this.layer.parsedUrl.path,")"),J.A.getLogger(jm).warn("#queryOverrides()",this.layer.title,"".concat(R,"."))}async _executeBatchQuery(R,G,H,W){if(0===G.length)return[];const q=(0,Kp.qM)(R);G=[...G].sort(((R,G)=>R-G));const Q=(0,ce.Ho)(G,q).map((G=>{const q=H.clone();return q.objectIds=G,(0,Rt.DZ)((0,Kp.SE)(R,q,{signal:W}))}));return Promise.all(Q)}_processOverridesFromAssociatedLayer(R,G,H,W){let{loadedAttributes:q,attributeData:Q}=W;const J=this._associatedLayer;if(null==J)return;const X=J.objectIdField,$=H.map((G=>(G in Q||(Q[G]=new Array(R.length)),Q[G]))),K=new Map(q.map((R=>[R.name,R.index]))),ee=H.map((R=>K.get(R))),te=new Map(Array.from(R,((R,G)=>[R,G])));for(const ie of G){const R=ie.attributes[X];for(let G=0;G<H.length;G++){const W=ee[G],q=te.get(R),Q=ie.attributes[H[G]];$[G][q]=Q,this._cacheAttributeValue(R,W,Q)}}}_memCacheAttributeValueSize(R){return"string"==typeof R?(0,Zn.xU)(R):(0,Zn.f3)()}async _fetchChangedObjectIds(R){var G,H;const W=this.layer;await W.load({signal:R}),this._geometryChangedObjectIds.clear(),this._attributeChangedObjectIds.clear();const{associatedLayer:Q}=W;if(null==Q||null===(G=Q.capabilities)||void 0===G||null===(G=G.operations)||void 0===G||!G.supportsChangeTracking)return;const X=this._getFetchChangedObjectIdsServerGen();if(null==X)return;const $=Q.layerId,K=this.is3DOFL,ee={f:"json",returnIdsOnly:!0,layers:"[".concat($,"]"),returnUpdates:!0,returnDeletes:K,returnInserts:K,layerServerGens:JSON.stringify([{id:$,serverGen:X}])};if(K){const R=Q.infoFor3D;ee.fieldsToCompare=JSON.stringify({fields:[...Object.values(R.transformFieldRoles),R.sourceHashField]})}const te=await(0,Rt.Ke)((0,q.A)("".concat(Q.url,"/extractChanges"),{method:"post",query:ee,timeout:km,signal:R}));if(!te.ok&&(0,$e.c8)(te.error)){const R=this.layer.title;J.A.getLogger(jm).warn("extractChanges:timeout",R,"".concat(R," could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service."))}if(te.ok&&1===(null===(H=te.value.data)||void 0===H||null===(H=H.edits)||void 0===H?void 0:H.length)){var ie,re,ne;const G=te.value.data.edits[0],H=null===G||void 0===G?void 0:G.objectIds,W=null===G||void 0===G?void 0:G.fieldUpdates,q=null!==(ie=null===H||void 0===H?void 0:H.adds)&&void 0!==ie?ie:[],J=null!==(re=null===H||void 0===H?void 0:H.updates)&&void 0!==re?re:[],X=null!==(ne=null===H||void 0===H?void 0:H.deletes)&&void 0!==ne?ne:[],$=[...q,...J,...X],ee=K?[...q,...null!==W&&void 0!==W?W:J,...X]:[],se=Math.min(this._maximumNumberOfEditOVerrides,$.length);se<$.length&&(this._warnMaximumChangedObjectsExceeded=!0);const ae=$.sort(((R,G)=>R-G));for(let R=0;R<se;++R){const G=ae[R];this._attributeChangedObjectIds.add(G)}for(const R of ee)this._geometryChangedObjectIds.add(R);if(this.is3DOFL&&(0,dt.lC)()&&this._geometryChangedObjectIds.size>0){const G=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),R);if(null!=G)for(const R of G)null!=R.geometry&&this.updateGeometry(R.attributes[Q.objectIdField],R.geometry)}}}_getFetchChangedObjectIdsServerGen(){var R,G;const H=this.layer;if(null!=(null===(R=H.serviceUpdateTimeStamp)||void 0===R?void 0:R.lastUpdate))return H.serviceUpdateTimeStamp.lastUpdate;const W=H.associatedLayer;return null!=(null===W||void 0===W||null===(G=W.serverGens)||void 0===G?void 0:G.minServerGen)?W.serverGens.minServerGen:null}async _lockFeatureIds(R){const G=this._featureIdLocks;let H=!0;for(;H;){const W=new Array;for(const H of R){const R=G.get(H);R&&W.push(R)}0===W.length?H=!1:await Promise.all(W)}const W=(0,X.Tw)(),q=W.promise;for(const Q of R)G.set(Q,q);return(0,ue.hA)((()=>{for(const H of R)G.delete(H);W.resolve()}))}get test(){const R=Array.from(this._attributeChangedObjectIds),G=this._pendingFetchChangedObjectIds,H=this;return{changedObjectIds:R,pendingFetchChangedObjectIds:G,get maximumNumberOfEditOVerrides(){return H._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(R){H._maximumNumberOfEditOVerrides=R}}}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Wm.prototype,"view",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Wm.prototype,"layer",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Wm.prototype,"is3DOFL",null),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_interactiveEditingSessions",void 0),(0,W._)([(0,ee.MZ)({readOnly:!0})],Wm.prototype,"sortedGeometryChangedObjectIds",null),(0,W._)([(0,ee.MZ)({readOnly:!0})],Wm.prototype,"geometryOverrides",void 0),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_clientGeometryCache",void 0),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_associatedLayer",null),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_associatedLayerView",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Wm.prototype,"memoryController",void 0),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_attributeChangedObjectIds",void 0),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_geometryChangedObjectIds",void 0),(0,W._)([(0,ee.MZ)()],Wm.prototype,"hasGeometryChanges",null),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_pendingFetchChangedObjectIds",void 0),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_pendingFetchAbortController",void 0),(0,W._)([(0,ee.MZ)()],Wm.prototype,"_definitionExpression",null),(0,W._)([(0,ee.MZ)()],Wm.prototype,"updating",null),(0,W._)([(0,ee.MZ)()],Wm.prototype,"isEmpty",null),Wm=(0,W._)([(0,ie.$)(jm)],Wm);class I3SOverrides_M{constructor(R,G){this.objectId=R,this._remove=G,this._updates=new Map,this._isActive=!0}getAttribute(R){return this._updates.get(R)}setAttribute(R,G){this.isActive&&this._updates.set(R,G)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}const km=1e4,qm=5e4;var Zm;function I3SOverrides_N(R,G,H,W){return"Displaying the edits of a SceneLayer with a".concat(W===Zm.Mode?R.isGeographic?" geographic ":" projected ":" ","spatial reference (wkid:").concat(R.wkid,") in ").concat(H," viewing mode").concat(W===Zm.SpatialReference?" with spatial reference (wkid:".concat(G.wkid,") "):" ","is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ").concat(W===Zm.Mode?"viewing mode":"view spatial reference"," to display edits.")}!function(R){R[R.Mode=0]="Mode",R[R.SpatialReference=1]="SpatialReference"}(Zm||(Zm={}));H(83638);new WeakMap;let Qm=class extends(Vr.A.EventedMixin(Q.A)){constructor(R){super(R),this._tmpEvent=new ElevationUpdateEvent_e,this._renderCoordsHelper=R.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=R.layerElevationSource}initialize(){this._intersector=Intersector_T(this.view.state.viewingMode),this._intersector.options.store=So.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){var R;return null===(R=this.view)||void 0===R||null===(R=R.elevationProvider)||void 0===R?void 0:R.spatialReference}getElevation(R,G,H,W){const q=this._renderCoordsHelper,Q=(0,be.s)(Xm,R,G,H);if(!q.toRenderCoords(Q,W,Q))return J.A.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:X,_intersector:$,intersectionHandler:K}=this,ee=X.fullExtent,te=null!=ee&&Number.isFinite(ee.xmin)&&Number.isFinite(ee.xmax)&&Number.isFinite(ee.ymin)&&Number.isFinite(ee.ymax)&&Number.isFinite(ee.zmin)&&Number.isFinite(ee.zmax)?new pt.H(ee.zmin,ee.zmax):X.elevationRange;if(null==te)return null;const ie=X.elevationOffset,re=te.elevationRangeMin+ie,ne=te.elevationRangeMax+ie,se=q.setAltitude($m,ne,Q),ae=q.setAltitude(Km,re,Q);return $.reset(se,ae,null),K.intersect($,null,se,ae,null,!0),$.results.min.getIntersectionPoint(Q)?q.getAltitude(Q):null}getSphereElevationBounds(R,G){return projectBoundingSphere_a(R,G,Jm,this._renderSR),this._layerElevationSource.getElevationRange(Jm)}getRootElevationBounds(){const R=this.layerElevationSource.fullExtent;return null!==R&&void 0!==R&&R.hasZ?new pt.H(R.zmin,R.zmax):null}objectsChanged(R){this.spatialReference&&(this._computeLayerExtent(R,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(R){this.spatialReference&&(this._computeObjectExtent(R,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(R,G){(0,Fe.Ie)(G),this._expandExtent(R,G)}_computeLayerExtent(R,G){(0,Fe.Ie)(G);for(const H of R)this._expandExtent(H,G)}_expandExtent(R,G){const H=this.spatialReference;if(null==H)return;if(null==R)return;(0,ye.I0)(Ym,R.quaternion),Ym[12]=R.center[0],Ym[13]=R.center[1],Ym[14]=R.center[2];const W=R.halfSize;for(let q=0;q<8;++q)Xm[0]=1&q?W[0]:-W[0],Xm[1]=2&q?W[1]:-W[1],Xm[2]=4&q?W[2]:-W[2],(0,be.e)(Xm,Xm,Ym),this._renderCoordsHelper.fromRenderCoords(Xm,Xm,H),(0,Fe.fT)(G,Xm,G)}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],Qm.prototype,"layerElevationSource",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Qm.prototype,"intersectionHandler",void 0),(0,W._)([(0,ee.MZ)({constructOnly:!0})],Qm.prototype,"view",void 0),(0,W._)([(0,ee.MZ)()],Qm.prototype,"spatialReference",null),Qm=(0,W._)([(0,ie.$)("esri.views.3d.layers.i3s.LayerElevationProvider")],Qm);const Ym=(0,ve.vt)(),Jm=(0,Ge.f)(0,0,0,0),Xm=(0,xe.vt)(),$m=(0,xe.vt)(),Km=(0,xe.vt)();H(68984);H(29126);var eg;!function(R){R[R.CastShadows=4]="CastShadows",R[R.Pickable=5]="Pickable"}(eg||(eg={}));de.u.MEGABYTES;var tg;!function(R){R[R.ADD=0]="ADD",R[R.REMOVE=1]="REMOVE",R[R.UPDATE=2]="UPDATE"}(tg||(tg={}));(0,Le.vt)(),(0,Fe.vt)(),(0,Fe.vt)(),new _t.ab,new oe.A([0,0,0,0]),(0,Ge.f)(0,0,0,0);(0,xe.vt)(),(0,Le.vt)();function Xt(R){return G=>{if(R.immediate)return R.immediate.schedule(G);throw console.error("Error no immediate schudler"),new Error("cant find immediate scheduler")}}new pt.H;var ig,rg;!function(R){R[R.Lifetime=0]="Lifetime",R[R.Jobs=1]="Jobs",R[R.Renderables=2]="Renderables"}(ig||(ig={})),function(R){R[R.Critical=0]="Critical",R[R.Error=1]="Error",R[R.Warning=2]="Warning",R[R.Info=3]="Info"}(rg||(rg={}));let ng=class extends Q.A{constructor(R){super(R),this._lyr3DMainPromise=null,this._lyr3DMain=null,this._layers=new Map,this._debugFlags=new Set,this._debugLevel=rg.Critical,this._pulseTaskHandle=null,this._session=null,this._debugFlags.add(ig.Lifetime),this._debugFlags.add(ig.Jobs),this._debugFlags.add(ig.Renderables)}_debugLog(R,G,H){let W=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(this._debugFlags.has(R)&&this._debugLevel>=G){const R=W?"[js] ".concat(H):"".concat(H);G===rg.Critical||G===rg.Error?J.A.getLogger(this).error(R):G===rg.Warning&&J.A.getLogger(this).warn(R),J.A.getLogger(this).info(R)}}initialize(){this._debugLevel>rg.Warning&&(J.A.getLogger(this).level="info"),this._debugLog(ig.Lifetime,rg.Info,"Lyr3DWasmPerSceneView.initialize()"),this.addHandles([(0,$.wB)((()=>{var R;return null===(R=this.view.state)||void 0===R?void 0:R.contentCamera}),(()=>this._updateWasmCamera()))]),this._pulseTaskHandle=(0,K.mg)({preRender:()=>this._pulseTask()})}destroy(){var R;this._debugLog(ig.Lifetime,rg.Info,"Lyr3DWasmPerSceneView.destroy()"),this._lyr3DMain&&(this._layers.forEach((R=>{R.abortController.abort()})),this._lyr3DMain.uninitialize_lyr3d_wasm(),this._lyr3DMain=null);const G=this._worker;G&&G.destroyWasm().then((()=>{var R;null!==(R=this._worker)&&void 0!==R&&R.destroy(),this._worker=null})),null!==(R=this._pulseTaskHandle)&&void 0!==R&&R.remove(),this._pulseTaskHandle=null}add3DTilesLayerView(R){return this._lyr3DMain?this._add3DTilesLayerView(R):(this._debugLog(ig.Lifetime,rg.Error,"Lyr3DWasmPerSceneView.add3DTilesLayerView() called when WASM wasn't initialized"),re.vE)}remove3DTilesLayerView(R){if(!this._lyr3DMain)return this._debugLog(ig.Lifetime,rg.Error,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() called when WASM wasn't loaded!"),0;this._doRemoveLayerView(R);const G=this._layers.size;return 0===G&&(this._debugLog(ig.Lifetime,rg.Info,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() no Lyr3D layers left after removing a layer, destroying"),this.destroy()),G}setEnabled(R,G){if(!this._lyr3DMain)return void this._debugLog(ig.Lifetime,rg.Error,"Lyr3DWasmPerSceneView.setEnabled() called when WASM wasn't loaded!");const H=this._layers.get(R.wasmLayerId);H&&(this._lyr3DMain.set_enabled(R.wasmLayerId,G),H.needMemoryUsageUpdate=!0)}setLayerOffset(R,G){this._lyr3DMain?this._layers.get(R.wasmLayerId)&&this._lyr3DMain.set_carto_offset_z(R.wasmLayerId,G):this._debugLog(ig.Lifetime,rg.Error,"Lyr3DWasmPerSceneView.setLayerOffset() called when WASM wasn't loaded!")}getAttributionText(){return this._lyr3DMain?this._lyr3DMain.get_current_attribution_text().split("|"):(this._debugLog(ig.Lifetime,rg.Error,"Lyr3DWasmPerSceneView.getAttributionText() called when WASM wasn't loaded!"),[])}onRenderableEvicted(R,G,H){this._lyr3DMain?this._layers.get(R.wasmLayerId)&&this._lyr3DMain.on_renderable_evicted(R.wasmLayerId,G,H):this._debugLog(ig.Lifetime,rg.Error,"Lyr3DWasmPerSceneView.onRenderableEvicted() called when WASM wasn't loaded!")}isUpdating(R){if(!this._lyr3DMain&&this._lyr3DMainPromise)return!0;const G=this._layers.get(R);return!!G&&(G.outstandingJobCount>0||G.outstandingRenderableCount>0)}initializeWasm(){return this._lyr3DMain?Promise.resolve():(this._debugLog(ig.Lifetime,rg.Info,"Lyr3DWasmPerSceneView.initializeWasm()"),this._lyr3DMainPromise||(this._lyr3DMainPromise=(0,se.a)().then((R=>{var G,H,W,q;this._lyr3DMain=R,this._lyr3DMainPromise=null;const Q=this._lyr3DMain.addFunction(this._onNewJob.bind(this),"v"),J=this._lyr3DMain.addFunction(this._onNewRenderable.bind(this),"v"),X=this._lyr3DMain.addFunction(this._freeRenderables.bind(this),"viii"),$=this._lyr3DMain.addFunction(this._setRenderableVisibility.bind(this),"viiii"),K=this._lyr3DMain.addFunction(this._onWasmError.bind(this),"viiii"),ee="global"===this.view.viewingMode,te=null!==(G=this.view.renderSpatialReference)&&void 0!==G&&G.isWebMercator?3857:null!==(H=null===(W=this.view.renderSpatialReference)||void 0===W?void 0:W.wkid)&&void 0!==H?H:-1,ie=null===(q=this.view.heightModelInfo)||void 0===q?void 0:q.heightModel,re=!ie||"gravity-related-height"===ie;return this._lyr3DMain.initialize_lyr3d_wasm(K,Q,J,X,$,ee,re,te,this._debugLevel)?(this._worker=new Lyr3DWorkerHandle_s(Xt(this.view.resourceController)),this._worker.promise?this._worker.promise:void 0):(this._lyr3DMain=null,void this._debugLog(ig.Lifetime,rg.Critical,"Lyr3d Main WASM failed to initialize",!1))})).catch((R=>{this._debugLog(ig.Lifetime,rg.Critical,"Lyr3d WASM failed to download error = ".concat(R),!1)}))),this._lyr3DMainPromise)}_pulseTask(){if(this._lyr3DMain){let R=0;this._layers.forEach((G=>{R+=G.layerView.usedMemory})),R/=1048576;const G=this.view.resourceController.memoryController,H=G.usedMemory*G.maxMemory-R,W=G.maxMemory-H+G.additionalCacheMemory;this._lyr3DMain.frame_pulse(W,R,H,G.maxMemory)}}_incrementJobCount(R){R.outstandingJobCount+=1,1===R.outstandingJobCount&&R.outstandingRenderableCount<1&&R.layerView.updatingFlagChanged()}_decrementJobCount(R){R.outstandingJobCount-=1,0===R.outstandingJobCount&&R.outstandingRenderableCount<1&&R.layerView.updatingFlagChanged()}_incrementRenderableCount(R){R.outstandingRenderableCount+=1,R.outstandingJobCount<1&&1===R.outstandingRenderableCount&&R.layerView.updatingFlagChanged()}_decrementRenderableCount(R){R.outstandingRenderableCount-=1,R.outstandingJobCount<1&&0===R.outstandingRenderableCount&&R.layerView.updatingFlagChanged()}_onJobFailed(R,G,H){G.error.length&&this._debugLog(ig.Jobs,rg.Error,G.error,!1),this._lyr3DMain&&this._lyr3DMain.on_job_failed(H.jobId,H.desc),this._decrementJobCount(R)}_onJobSucceeded(R,G,H){if(this._lyr3DMain){const R=G.data.byteLength,W=this._lyr3DMain._malloc(R);new Uint8Array(this._lyr3DMain.HEAPU8.buffer,W,R).set(G.data),this._lyr3DMain.on_job_completed(H.jobId,G.jobDescJson,W,R),this._lyr3DMain._free(W)}this._decrementJobCount(R)}_getRequestPromises(R,G){const H=[];for(const W of R){const R=new URL(W),Q=R.searchParams.get("session");Q?this._session=Q:this._session&&R.searchParams.append("session",this._session),H.push((0,q.A)(R.toString(),G).then((R=>R.data)))}return H}_onNewJob(){const R=this._lyr3DMain.get_next_job(),G=this._layers.get(R.layerId);if(!G)return;this._incrementJobCount(G);const H=G.abortController.signal,W={responseType:"array-buffer",signal:H,query:{...G.customParameters,token:G.apiKey}},q={inputs:[],jobDescJson:R.desc,isMissingResourceCase:!1},Q=this._getRequestPromises(R.urls,W);Promise.all(Q).then((R=>(q.inputs=R,this._worker.invoke(q,H)))).then((R=>R)).catch((G=>((0,X.zf)(G)?this._debugLog(ig.Jobs,rg.Warning,"job ".concat(R.jobId," was cancelled.")):this._debugLog(ig.Jobs,rg.Error,"job ".concat(R.jobId," failed with error ").concat(G,".")),{status:re.Qg.Failed,error:"",jobDescJson:"",data:new Uint8Array(0),missingInputUrls:[],inputs:[]}))).then((Q=>{if(Q.status===re.Qg.Failed)this._onJobFailed(G,Q,R);else if(Q.status===re.Qg.Succeeded)this._onJobSucceeded(G,Q,R);else if(Q.status===re.Qg.MissingInputs){const J=this._getRequestPromises(Q.missingInputUrls,W);Promise.all(J).then((R=>{q.jobDescJson=Q.jobDescJson,Q.originalInputs?q.inputs=Q.originalInputs:q.inputs=[],q.isMissingResourceCase=!0;for(const G of R)q.inputs.push(G);return this._worker.invoke(q,H)})).then((H=>{H.status===re.Qg.Failed?this._onJobFailed(G,H,R):H.status===re.Qg.Succeeded&&this._onJobSucceeded(G,H,R)})).catch((H=>{this._decrementJobCount(G),(0,X.zf)(H)?this._debugLog(ig.Jobs,rg.Warning,"job ".concat(R.jobId," was cancelled.")):this._debugLog(ig.Jobs,rg.Error,"job ".concat(R.jobId," failed with error2 ").concat(H,".")),this._lyr3DMain&&this._lyr3DMain.on_job_failed(R.jobId,R.desc)}))}}))}_onNewRenderable(){const R=this._lyr3DMain.get_next_renderable(),G=R.meshData;if(G.data&&G.data.byteLength>0){const R=G.data.slice();G.data=R}const H=this._layers.get(R.layerId);H&&(this._incrementRenderableCount(H),H.layerView.createRenderable(R).then((G=>{this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!0,R.layerId,R.handle,G.memUsageBytes),this._decrementRenderableCount(H)})).catch((G=>{(0,X.zf)(G)||this._debugLog(ig.Renderables,rg.Error,"createRenderable failed with error ".concat(G,".")),this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!1,R.layerId,R.handle,0),this._decrementRenderableCount(H)})))}_freeRenderables(R,G,H){if(H<1)return;const W=this._layers.get(R);if(!W)return;const q=W.layerView,Q=[],J=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,G,H);for(let X=0;X<H;++X)Q.push(J[X]);for(let X=0;X<H;++X)q.freeRenderable(Q[X])}_setRenderableVisibility(R,G,H,W){if(W<1)return;const q=this._layers.get(R);if(!q)return;const Q=q.layerView,J=[],X=[],$=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,G,W),K=new Uint8Array(this._lyr3DMain.HEAPU8.buffer,H,W);for(let ee=0;ee<W;++ee)J.push($[ee]),X.push(1===K[ee]);Q.setRenderableVisibility(J,X,W)}_onWasmError(R,G,H,W){this._lyr3DMain&&this._debugLog(H,W,this._lyr3DMain.UTF8ToString(R,G),!1)}_doRemoveLayerView(R){const G=this._layers.get(R.wasmLayerId);return!!G&&(G.abortController.abort(),this._lyr3DMain.remove_layer(R.wasmLayerId),this._layers.delete(R.wasmLayerId),!0)}_add3DTilesLayerView(R){var G,H,W,q;const Q=R.layer;if(!Q.url)return re.Pl;const J=this._lyr3DMain.get_next_layer_id(),X=new AbortController;this._layers.set(J,{layerView:R,abortController:X,needMemoryUsageUpdate:!1,outstandingJobCount:0,outstandingRenderableCount:0,customParameters:Q.customParameters,apiKey:Q.apiKey});const $=null!==(G=null===(H=Q.elevationInfo)||void 0===H?void 0:H.offset)&&void 0!==G?G:0,K=null!==(W=Q.elevationInfo)&&void 0!==W&&W.unit?(0,ae.Ao)(null===(q=Q.elevationInfo)||void 0===q?void 0:q.unit):1;return this._lyr3DMain.add_layer(Q.url,J,$*K)?(this._updateWasmCamera(),J):(this._layers.delete(J),re.Pl)}_updateWasmCamera(){var R;const G=null===(R=this.view.state)||void 0===R?void 0:R.contentCamera;if(!G||!this._lyr3DMain)return;const{eye:H,center:W,up:q,near:Q,far:J,fovY:X}=G,$=[G.viewport[2],G.viewport[3]],K=G.width/G.height;this._lyr3DMain.set_camera_parameters({eye:H,center:W,up:q,near:Q,far:J,fov:X,aspectRatio:K,viewport:$})}};(0,W._)([(0,ee.MZ)({constructOnly:!0})],ng.prototype,"view",void 0),ng=(0,W._)([(0,ie.$)("esri.layers.Lyr3DWasmPerSceneView")],ng);const sg=ng},61816:(R,G,H)=>{H.d(G,{F:()=>o});var W=H(50886),q=H(30925),Q=H(88965);const J={minX:0,minY:0,maxX:0,maxY:0};function e(R,G,H){(function t(R){J.minX=R[0],J.minY=R[1],J.maxX=R[2],J.maxY=R[3]})(G),R.search(J,H)}class o{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new q.w(9,(0,W.A)("esri-csp-restrictions")?R=>({minX:R[0],minY:R[1],maxX:R[2],maxY:R[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const R=new Array(this._idByBounds.size);let G=0;this._idByBounds.forEach(((H,W)=>{R[G++]=W})),this._indexInvalid=!1,this._index.clear(),this._index.load(R)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter((R=>this._idByBounds.has(R)))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const R=(0,Q.Ie)();for(const G of this._boundsById.values())G&&(R[0]=Math.min(G[0],R[0]),R[1]=Math.min(G[1],R[1]),R[2]=Math.max(G[2],R[2]),R[3]=Math.max(G[3],R[3]));return R}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(R){const G=this._boundsById.get(R);this._boundsById.delete(R),G&&(this._idByBounds.delete(G),this._indexInvalid||this._index.remove(G))}forEachInBounds(R,G){this._loadIndex(),e(this._index,R,(R=>G(this._idByBounds.get(R))))}get(R){return this._boundsById.get(R)}has(R){return this._boundsById.has(R)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(R,G){if(!this._indexInvalid){const G=this._boundsById.get(R);G&&(this._index.remove(G),this._idByBounds.delete(G))}this._boundsById.set(R,G),G&&(this._idByBounds.set(G,R),this._indexInvalid||(this._boundsToLoad.push(G),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},45691:(R,G,H)=>{H.d(G,{A:()=>m});var W=H(16842),q=H(4180),Q=H(73067),J=H(89412),X=H(21374),$=H(88965),K=H(32050),ee=H(61816),te=H(23047),ie=H(19464);const re=(0,X.vt)();class m{constructor(R){this.geometryInfo=R,this._boundsStore=new ee.F,this._featuresById=new Map,this._markedIds=new Set,this.events=new Q.A,this.featureAdapter=ie.T}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let R=0;return this._featuresById.forEach((G=>{null!=G.geometry&&G.geometry.coords&&(R+=G.geometry.coords.length)})),{featureCount:this._featuresById.size,vertexCount:R/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(R){if(null==this.fullBounds)return null;const[G,H,W,q]=this.fullBounds;return{xmin:G,ymin:H,xmax:W,ymax:q,spatialReference:(0,te.ag)(R)}}add(R){this._add(R),this._emitChanged()}addMany(R){for(const G of R)this._add(G);this._emitChanged()}upsertMany(R){const G=R.map((R=>this._upsert(R)));return this._emitChanged(),G.filter(W.Ru)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(R){const G=this._featuresById.get(R);return G?(this._remove(G),this._emitChanged(),G):null}removeManyById(R){this._boundsStore.invalidateIndex();for(const G of R){const R=this._featuresById.get(G);R&&this._remove(R)}this._emitChanged()}forEachBounds(R,G){for(const H of R){const R=this._boundsStore.get(H.objectId);R&&G((0,X.Jt)(re,R))}}getFeature(R){return this._featuresById.get(R)}has(R){return this._featuresById.has(R)}forEach(R){this._featuresById.forEach((G=>R(G)))}forEachInBounds(R,G){this._boundsStore.forEachInBounds(R,(R=>{G(this._featuresById.get(R))}))}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let R=!1;this._featuresById.forEach(((G,H)=>{this._markedIds.has(H)||(R=!0,this._remove(G))})),this._markedIds.clear(),R&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(R){var G;if(!R)return;const H=R.objectId;if(null==H)return void J.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new q.A("featurestore:invalid-feature","feature id is missing",{feature:R}));const W=this._featuresById.get(H);let Q;if(this._markedIds.add(H),W?(R.displayId=W.displayId,Q=this._boundsStore.get(H),this._boundsStore.delete(H)):null!=this.onFeatureAdd&&this.onFeatureAdd(R),null===(G=R.geometry)||void 0===G||null===(G=G.coords)||void 0===G||!G.length)return this._boundsStore.set(H,null),void this._featuresById.set(H,R);Q=(0,K.jQ)(null!=Q?Q:(0,$.vt)(),R.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=Q&&this._boundsStore.set(H,Q),this._featuresById.set(H,R)}_upsert(R){var G;const H=null===R||void 0===R?void 0:R.objectId;if(null==H)return J.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new q.A("featurestore:invalid-feature","feature id is missing",{feature:R})),null;const W=this._featuresById.get(H);if(!W)return this._add(R),R;this._markedIds.add(H);const{geometry:Q,attributes:X}=R;for(const q in X)W.attributes[q]=X[q];return Q&&(W.geometry=Q,this._boundsStore.set(H,null!==(G=(0,K.jQ)((0,$.vt)(),Q,this.geometryInfo.hasZ,this.geometryInfo.hasM))&&void 0!==G?G:null)),W}_remove(R){null!=this.onFeatureRemove&&this.onFeatureRemove(R);const G=R.objectId;return this._markedIds.delete(G),this._boundsStore.delete(G),this._featuresById.delete(G),R}}},1912:(R,G,H)=>{H.d(G,{aI:()=>h});H(50886),H(48237);var W=H(78395);function t(R,G){if(R===G)return!0;if(null==R||null==G)return!1;if(R.length!==G.length)return!1;for(let H=0;H<R.length;H++){const W=R[H],q=G[H];if(W.length!==q.length)return!1;for(let R=0;R<W.length;R++)if(W[R]!==q[R])return!1}return!0}function r(R,G){if(R===G)return!0;if(null==R||null==G)return!1;if(R.length!==G.length)return!1;for(let H=0;H<R.length;H++)if(!t(R[H],G[H]))return!1;return!0}function c(R,G){if(R===G)return!0;if(null==R||null==G)return!1;if(R.type!==G.type)return!1;switch(R.type){case"point":return function a(R,G){return R===G||null!=R&&null!=G&&(0,W.aI)(R.spatialReference,G.spatialReference)&&R.x===G.x&&R.y===G.y&&R.z===G.z&&R.m===G.m}(R,G);case"extent":return function f(R,G){return R.hasZ===G.hasZ&&R.hasM===G.hasM&&!!(0,W.aI)(R.spatialReference,G.spatialReference)&&R.xmin===G.xmin&&R.ymin===G.ymin&&R.zmin===G.zmin&&R.xmax===G.xmax&&R.ymax===G.ymax&&R.zmax===G.zmax}(R,G);case"polyline":return function u(R,G){return R.hasZ===G.hasZ&&R.hasM===G.hasM&&!!(0,W.aI)(R.spatialReference,G.spatialReference)&&r(R.paths,G.paths)}(R,G);case"polygon":return function l(R,G){return R.hasZ===G.hasZ&&R.hasM===G.hasM&&!!(0,W.aI)(R.spatialReference,G.spatialReference)&&r(R.rings,G.rings)}(R,G);case"multipoint":return function s(R,G){return R.hasZ===G.hasZ&&R.hasM===G.hasM&&!!(0,W.aI)(R.spatialReference,G.spatialReference)&&t(R.points,G.points)}(R,G);case"mesh":return!1;default:return}}function h(R,G){return R===G||null!=R&&null!=G&&R.objectId===G.objectId&&!!c(R.geometry,G.geometry)&&!!function o(R,G){if(R===G)return!0;if(!R||!G)return!1;const H=Object.keys(R),W=Object.keys(G);if(H.length!==W.length)return!1;for(const q of H)if(R[q]!==G[q])return!1;return!0}(R.attributes,G.attributes)}},42640:(R,G,H)=>{H.d(G,{Ek:()=>Z,HP:()=>f,JS:()=>b,Kq:()=>M,N3:()=>y,RW:()=>I,Uz:()=>z,ao:()=>k,iQ:()=>F,jy:()=>g,w9:()=>N});var W=H(39587),q=(H(50886),H(49905)),Q=H(49376),J=H(98664),X=H(21374),$=H(88965),K=H(89343),ee=H(40304),te=H(67871);H(1912);class f{constructor(R,G,H){this.uid=R,this.geometry=G,this.attributes=H,this.visible=!0,this.objectId=null,this.centroid=null}}function y(R){return null!=R.geometry}class g{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function b(R,G){var H,W;const q=ee.g.fromJSON(R.geometryType),X=J.A.fromJSON(R.spatialReference),$=R.transform,ie=R.objectIdFieldName,re=null===G||void 0===G?void 0:G.maxStringAttributeLength,ne=null===G||void 0===G?void 0:G.maxStringAttributeFields;let se;const ae=R.features.map((G=>{const H=function d(R,G,H,W){return{uid:(0,Q.c)(),objectId:W&&R.attributes?R.attributes[W]:null,attributes:R.attributes,geometry:x(R.geometry,G,H),visible:!0}}(G,q,X,R.objectIdFieldName),W=H.geometry;if(z(H.attributes,ne,re,(R=>{var G;null!==(G=se)&&void 0!==G||(se=[]);const W=I(H,ie);null!=W&&se.push({objectId:W,attribute:R})})),null!=W&&$)switch(W.type){case"point":H.geometry=(0,K.Tr)($,W,W,W.hasZ,W.hasM);break;case"multipoint":H.geometry=(0,K.SW)($,W,W,!!W.hasZ,!!W.hasM);break;case"polygon":H.geometry=(0,K.$X)($,W,W,!!W.hasZ,!!W.hasM);break;case"polyline":H.geometry=(0,K.P5)($,W,W,!!W.hasZ,!!W.hasM);break;case"extent":case"mesh":H.geometry=W}return H}));return{geometryType:q,features:ae,spatialReference:X,fields:null!==(H=null===(W=R.fields)||void 0===W?void 0:W.map((R=>te.A.fromJSON(R))))&&void 0!==H?H:[],objectIdFieldName:R.objectIdFieldName,globalIdFieldName:R.globalIdFieldName,geohashFieldName:R.geohashFieldName,geometryProperties:R.geometryProperties,hasZ:R.hasZ,hasM:R.hasM,exceededTransferLimit:R.exceededTransferLimit,transform:null,missingAttributes:se}}function x(R,G,H){if(null==R)return null;switch(G){case"point":{const G=R;return{x:G.x,y:G.y,z:G.z,m:G.m,hasZ:null!=G.z,hasM:null!=G.m,type:"point",spatialReference:H}}case"polyline":{const G=R;return{paths:G.paths,hasZ:!!G.hasZ,hasM:!!G.hasM,type:"polyline",spatialReference:H}}case"polygon":{const G=R;return{rings:G.rings,hasZ:!!G.hasZ,hasM:!!G.hasM,type:"polygon",spatialReference:H}}case"multipoint":{const G=R;return{points:G.points,hasZ:!!G.hasZ,hasM:!!G.hasM,type:"multipoint",spatialReference:H}}}}function Z(R){let G=32;return G+=(0,W.eY)(R.attributes),G+=3,G+=8+function j(R){if(null==R)return 0;let G=32;switch(R.type){case"point":G+=42;break;case"polyline":case"polygon":{let H=0;const W=2+(R.hasZ?1:0)+(R.hasM?1:0),q="polyline"===R.type?R.paths:R.rings;for(const R of q)H+=R.length;G+=8*H*W+64,G+=128*H,G+=34,G+=32*(q.length+1);break}case"multipoint":{const H=2+(R.hasZ?1:0)+(R.hasM?1:0),W=R.points.length;G+=8*W*H+64,G+=128*W,G+=34,G+=32;break}case"extent":G+=98,R.hasM&&(G+=32),R.hasZ&&(G+=32);break;case"mesh":G+=(0,q.Ek)(R.vertexAttributes.position,R.vertexAttributes.normal,R.vertexAttributes.uv,R.vertexAttributes.tangent)}return G}(R.geometry),G}function M(R){if(null==R)return 0;switch(R.type){case"point":return 1;case"polyline":{let G=0;for(const H of R.paths)G+=H.length;return G}case"polygon":{let G=0;for(const H of R.rings)G+=H.length;return G}case"multipoint":return R.points.length;case"extent":return 2;case"mesh":{const G=R.vertexAttributes&&R.vertexAttributes.position;return G?G.length/3:0}default:return}}function k(R){if(null==R)return!1;switch(R.type){case"extent":case"point":return!0;case"polyline":for(const G of R.paths)if(G.length>0)return!0;return!1;case"polygon":for(const G of R.rings)if(G.length>0)return!0;return!1;case"multipoint":return R.points.length>0;case"mesh":return!R.loaded||R.vertexAttributes.position.length>0}}function N(R,G){switch((0,X.Ie)(G),"mesh"===R.type&&(R=R.extent),R.type){case"point":G[0]=G[3]=R.x,G[1]=G[4]=R.y,R.hasZ&&(G[2]=G[5]=R.z);break;case"polyline":for(let H=0;H<R.paths.length;H++)(0,X.Jf)(G,R.paths[H],!!R.hasZ);break;case"polygon":for(let H=0;H<R.rings.length;H++)(0,X.Jf)(G,R.rings[H],!!R.hasZ);break;case"multipoint":(0,X.Jf)(G,R.points,!!R.hasZ);break;case"extent":G[0]=R.xmin,G[1]=R.ymin,G[3]=R.xmax,G[4]=R.ymax,null!=R.zmin&&(G[2]=R.zmin),null!=R.zmax&&(G[5]=R.zmax)}}function F(R,G){switch((0,$.Ie)(G),"mesh"===R.type&&(R=R.extent),R.type){case"point":G[0]=G[2]=R.x,G[1]=G[3]=R.y;break;case"polyline":for(let H=0;H<R.paths.length;H++)(0,$.Jf)(G,R.paths[H]);break;case"polygon":for(let H=0;H<R.rings.length;H++)(0,$.Jf)(G,R.rings[H]);break;case"multipoint":(0,$.Jf)(G,R.points);break;case"extent":G[0]=R.xmin,G[1]=R.ymin,G[2]=R.xmax,G[3]=R.ymax}}function I(R,G){return null!=R.objectId?R.objectId:R.attributes&&G?R.attributes[G]:null}function z(R,G,H,W){if(null!==G&&void 0!==G&&G.size&&null!=H&&R)for(const q in R){if(!G.has(q))continue;const Q=R[q];"string"==typeof Q&&Q.length>H&&(W(q),R[q]="")}}},63831:(R,G,H)=>{H.d(G,{A:()=>se});var W,q=H(80671),Q=(H(30174),H(83375)),J=H(66004),X=H(4282),$=H(57453),K=(H(50886),H(89412),H(68682)),ee=H(51715),te=H(73602),ie=H(54208),re=H(48343);let ne=W=class extends Q.oY{constructor(R){super(R),this.geometry=null,this.type="clip"}writeGeometry(R,G,H,W){var q;if(null!==(q=W.layer)&&void 0!==q&&q.spatialReference&&!W.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,ie.canProjectWithoutEngine)(R.spatialReference,W.layer.spatialReference))return void((null===W||void 0===W?void 0:W.messages)&&W.messages.push(new X.A("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:W.layer.spatialReference,context:W})));const q=new re.A;(0,ie.projectPolygon)(R,q,W.layer.spatialReference),G[H]=q.toJSON(W)}else G[H]=R.toJSON(W);delete G[H].spatialReference}clone(){return new W({geometry:(0,J.o8)(this.geometry),type:this.type})}};(0,q._)([(0,$.MZ)({type:re.A}),(0,te.P)()],ne.prototype,"geometry",void 0),(0,q._)([(0,ee.K)(["web-scene","portal-item"],"geometry")],ne.prototype,"writeGeometry",null),(0,q._)([(0,$.MZ)({type:["clip","mask","replace"],nonNullable:!0}),(0,te.P)()],ne.prototype,"type",void 0),ne=W=(0,q._)([(0,K.$)("esri.layers.support.SceneModification")],ne);const se=ne},35999:(R,G,H)=>{H.d(G,{E1:()=>i,Fm:()=>s,JZ:()=>F,R_:()=>u,fu:()=>t,oF:()=>r,rq:()=>c});const W=[["binary","application/octet-stream","bin",""]];function t(R,G){var H;return null!=d(G.name,null!==(H=null===R||void 0===R?void 0:R.supportedFormats)&&void 0!==H?H:[])}function r(R,G){var H;if(!R)return!1;const W=c(G,null!==(H=R.supportedFormats)&&void 0!==H?H:[]);return null!=W&&R.editFormats.includes(W)}function u(R,G){return m(function p(R,G){const H=R.toLowerCase();return a(G).find((R=>l(R)===H))}(R,G))}function i(R,G){return m(d(R,G))}function s(R,G){return l(function f(R,G){return a(G).find((G=>m(G)===R))}(R,G))}function c(R,G){var H;return null!==(H=i(R.name,G))&&void 0!==H?H:u(R.type,G)}function a(R){return[...W,...R]}function d(R,G){const H=R.toLowerCase();return a(G).find((R=>w(R).some((R=>H.endsWith(R)))))}function m(R){return null===R||void 0===R?void 0:R[0]}function l(R){return null===R||void 0===R?void 0:R[1].toLowerCase()}function w(R){var G;return null!==(G=null===R||void 0===R?void 0:R[2].split(",").map((R=>R.toLowerCase())))&&void 0!==G?G:[]}function F(R){var G;return null===(G=R.tables)||void 0===G?void 0:G.find((R=>"assetMaps"===R.role))}},29405:(R,G,H)=>{var W,q;H.d(G,{D:()=>q,f:()=>W}),function(R){R[R.None=0]="None",R[R.Int16=1]="Int16",R[R.Int32=2]="Int32"}(W||(W={})),function(R){R[R.Replace=0]="Replace",R[R.Outside=1]="Outside",R[R.Inside=2]="Inside",R[R.Finished=3]="Finished"}(q||(q={}))},87022:(R,G,H)=>{H.d(G,{a:()=>n,h:()=>e});var W=H(14795);function n(){return new Promise((R=>H.e(1398).then(H.bind(H,51398)).then((R=>R.l)).then((G=>{let{default:H}=G;const W=H({locateFile:i,onRuntimeInitialized:()=>R(W)})})))).catch((R=>{throw R}))}function e(){return new Promise((R=>H.e(2345).then(H.bind(H,72345)).then((R=>R.l)).then((G=>{let{default:H}=G;const W=H({locateFile:i,onRuntimeInitialized:()=>R(W)})})))).catch((R=>{throw R}))}function i(R){return(0,W.s)("esri/libs/lyr3d/".concat(R))}},85059:(R,G,H)=>{H.r(G),H.d(G,{getGeometryServiceURL:()=>n,projectGeometry:()=>a});var W=H(61272),q=H(4180),Q=H(91710),J=H(98881),X=H(28534);async function n(){var R;let G,H=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,J=arguments.length>1?arguments[1]:void 0;if(W.A.geometryServiceUrl)return W.A.geometryServiceUrl;if(!H)throw new q.A("internal:geometry-service-url-not-configured");G="portal"in H?H.portal||Q.A.getDefault():H,await G.load({signal:J});const X=null===(R=G.helperServices)||void 0===R||null===(R=R.geometry)||void 0===R?void 0:R.url;if(!X)throw new q.A("internal:geometry-service-url-not-configured");return X}async function a(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,W=arguments.length>3?arguments[3]:void 0;const Q=await n(H,W),$=new X.A;$.geometries=[R],$.outSpatialReference=G;const K=await(0,J.C)(Q,$,{signal:W});if(K&&Array.isArray(K)&&1===K.length)return K[0];throw new q.A("internal:geometry-service-projection-failed")}},28330:(R,G,H)=>{H.d(G,{n:()=>p});var W=H(4270);function p(R){return q[function t(R){return"json"===R.type?"application/json":"blob"===R.type?R.blob.type:function n(R){const G=(0,W.Zo)(R);return X[G]||Q}(R.url)}(R)]||J}const q={},Q="text/plain",J=q[Q],X={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const $ in X)q[X[$]]=$},98881:(R,G,H)=>{H.d(G,{C:()=>n});var W=H(53705),q=H(6493),Q=H(31670),J=H(95530),X=H(10182),$=H(28534);const K=(0,q.dp)($.A);async function n(R,G,H){G=K(G);const q=(0,J.Dl)(R),$={...q.query,f:"json",...G.toJSON()},ee=G.outSpatialReference,te=(0,Q.$B)(G.geometries[0]),ie=(0,J.jV)($,H);return(0,W.A)(q.path+"/project",ie).then((R=>{let{data:{geometries:G}}=R;return(0,X.V)(G,te,ee)}))}},19766:(R,G,H)=>{function t(R){const G={};for(const H in R){if("declaredClass"===H)continue;const W=R[H];if(null!=W&&"function"!=typeof W)if(Array.isArray(W)){G[H]=[];for(let R=0;R<W.length;R++)G[H][R]=t(W[R])}else"object"==typeof W?W.toJSON&&(G[H]=JSON.stringify(W)):G[H]=W}return G}H.d(G,{z:()=>t})},83947:(R,G,H)=>{H.d(G,{GB:()=>E,IJ:()=>f,Jf:()=>x,Pk:()=>p,eW:()=>c,gW:()=>S,kS:()=>d});var W=H(53705),q=H(4270),Q=H(31670),J=H(30172),X=H(78395),$=H(19766),K=H(84714),ee=H(34127);const te="Layer does not support extent calculation.";function y(R,G){var H;const W=R.geometry,q=R.toJSON();delete q.compactGeometryEnabled,delete q.defaultSpatialReferenceEnabled;const J=q;let $,K,ee;if(null!=W&&(K=W.spatialReference,ee=(0,X.YX)(K),J.geometryType=(0,Q.$B)(W),J.geometry=function m(R,G){if(G&&"extent"===R.type)return"".concat(R.xmin,",").concat(R.ymin,",").concat(R.xmax,",").concat(R.ymax);if(G&&"point"===R.type)return"".concat(R.x,",").concat(R.y);const H=R.toJSON();return delete H.spatialReference,JSON.stringify(H)}(W,R.compactGeometryEnabled),J.inSR=ee),q.groupByFieldsForStatistics&&(J.groupByFieldsForStatistics=q.groupByFieldsForStatistics.join(",")),q.objectIds&&(J.objectIds=q.objectIds.join(",")),q.orderByFields&&(J.orderByFields=q.orderByFields.join(",")),!q.outFields||!q.returnDistinctValues&&(null!==G&&void 0!==G&&G.returnCountOnly||null!==G&&void 0!==G&&G.returnExtentOnly||null!==G&&void 0!==G&&G.returnIdsOnly)?delete J.outFields:q.outFields.includes("*")?J.outFields="*":J.outFields=q.outFields.join(","),q.outSR?(J.outSR=(0,X.YX)(q.outSR),$=R.outSpatialReference):W&&(q.returnGeometry||q.returnCentroid)&&(J.outSR=J.inSR,$=K),q.returnGeometry&&delete q.returnGeometry,q.outStatistics&&(J.outStatistics=JSON.stringify(q.outStatistics)),q.fullText&&(J.fullText=JSON.stringify(q.fullText)),q.pixelSize&&(J.pixelSize=JSON.stringify(q.pixelSize)),q.quantizationParameters&&(R.defaultSpatialReferenceEnabled&&null!=K&&null!=(null===(H=R.quantizationParameters)||void 0===H?void 0:H.extent)&&K.equals(R.quantizationParameters.extent.spatialReference)&&delete q.quantizationParameters.extent.spatialReference,J.quantizationParameters=JSON.stringify(q.quantizationParameters)),q.parameterValues&&(J.parameterValues=JSON.stringify(q.parameterValues)),q.rangeValues&&(J.rangeValues=JSON.stringify(q.rangeValues)),q.dynamicDataSource&&(J.layer=JSON.stringify({source:q.dynamicDataSource}),delete q.dynamicDataSource),q.timeExtent){const R=q.timeExtent,{start:G,end:H}=R;null==G&&null==H||(J.time=G===H?G:"".concat(null!==G&&void 0!==G?G:"null",",").concat(null!==H&&void 0!==H?H:"null")),delete q.timeExtent}return R.defaultSpatialReferenceEnabled&&null!=K&&null!=$&&K.equals($)&&(J.defaultSR=J.inSR,delete J.inSR,delete J.outSR),J}async function c(R,G,H,W){const q=null!=G.timeExtent&&G.timeExtent.isEmpty?{data:{features:[]}}:await E(R,G,"json",W);return(0,ee.q)(G,H,q.data),q}async function f(R,G,H,W){if(null!=G.timeExtent&&G.timeExtent.isEmpty)return{data:H.createFeatureResult()};const q=await d(R,G,W),Q=q;return Q.data=(0,K.m)(q.data,H),Q}function d(R,G,H){return E(R,G,"pbf",H)}function p(R,G,H){return null!=G.timeExtent&&G.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):E(R,G,"json",H,{returnIdsOnly:!0})}function S(R,G,H){return null!=G.timeExtent&&G.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):E(R,G,"json",H,{returnIdsOnly:!0,returnCountOnly:!0})}async function x(R,G,H){if(null!=G.timeExtent&&G.timeExtent.isEmpty)return{data:{count:0,extent:null}};const W=await E(R,G,"json",H,{returnExtentOnly:!0,returnCountOnly:!0}),q=W.data;if(q.hasOwnProperty("extent"))return W;if(q.features)throw new Error(te);if(q.hasOwnProperty("count"))throw new Error(te);return W}async function E(R,G,H){let Q=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},X=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const K="string"==typeof R?(0,q.An)(R):R,ee=G.geometry?[G.geometry]:[],te=await(0,J.el)(ee,null,{signal:Q.signal}),ie=null===te||void 0===te?void 0:te[0];null!=ie&&((G=G.clone()).geometry=ie);const re=(0,$.z)({...K.query,f:H,...X,...y(G,X)});return(0,W.A)((0,q.fj)(K.path,function g(R,G){return null!=R.formatOf3DObjects&&!(G.returnCountOnly||G.returnExtentOnly||G.returnIdsOnly)}(G,X)?"query3d":"query"),{...Q,responseType:"pbf"===H?"array-buffer":"json",query:{...re,...Q.query}})}},34127:(R,G,H)=>{H.d(G,{q:()=>t});var W=H(8641);function t(R,G,H){if(null===H||void 0===H||!H.features||!H.hasZ)return;const q=(0,W.N)(H.geometryType,G,R.outSpatialReference);if(null!=q)for(const W of H.features)q(W.geometry)}},28534:(R,G,H)=>{H.d(G,{A:()=>ee});var W=H(80671),q=H(83375),Q=H(57453),J=(H(50886),H(89412),H(76761),H(68682)),X=H(31670),$=H(78395);let K=class extends q.oY{constructor(R){super(R),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const R=this.geometries.map((R=>R.toJSON())),G=this.geometries[0],H={};return H.outSR=(0,$.YX)(this.outSpatialReference),H.inSR=(0,$.YX)(G.spatialReference),H.geometries=JSON.stringify({geometryType:(0,X.$B)(G),geometries:R}),this.transformation&&(H.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(H.transformForward=this.transformForward),H}};(0,W._)([(0,Q.MZ)()],K.prototype,"geometries",void 0),(0,W._)([(0,Q.MZ)({json:{read:{source:"outSR"}}})],K.prototype,"outSpatialReference",void 0),(0,W._)([(0,Q.MZ)()],K.prototype,"transformation",void 0),(0,W._)([(0,Q.MZ)()],K.prototype,"transformForward",void 0),K=(0,W._)([(0,J.$)("esri.rest.support.ProjectParameters")],K);const ee=K},56372:(R,G,H)=>{H.r(G),H.d(G,{assetMapFromAssetMapsJSON:()=>S,extractMesh:()=>h,meshFeatureSetFromJSON:()=>p});var W=H(13812),q=H(89412),Q=H(69719),J=H(84661),X=H(72664),$=H(57264),K=H(98664),ee=H(45042),te=H(81581),ie=H(35999),re=H(94309);const m=()=>q.A.getLogger("esri.rest.support.meshFeatureSet");function p(R,G,H){var q;const Q=H.features;H.features=[],delete H.geometryType;const J=re.A.fromJSON(H);if(J.geometryType="mesh",!H.assetMaps)return J;const X=S(G,H.assetMaps),$=null!==(q=R.sourceSpatialReference)&&void 0!==q?q:K.A.WGS84,ee=H.globalIdFieldName,{outFields:te}=R,ie=null!=te&&te.length>0?function g(R){return G=>{let{attributes:H}=G;if(!H)return{};if(!R)return H;for(const W in H)R.has(W)||delete H[W];return H}}(te.includes("*")?null:new Set(te)):()=>({});for(const K of Q){const R=h(K,ee,$,G,X);null!=R&&J.features.push(new W.A({geometry:R,attributes:ie(K)}))}return J}function h(R,G,H,W,q){const Q=R.attributes[G],K=q.get(Q);if(null==K)return m().error("mesh-feature-set:asset-not-found","Service returned a feature which was not found in the asset map",R),null;if(!R.geometry)return m().error("mesh-feature-set:no-geometry","Service returned a feature without geometry",R),null;const ie=function y(R,G,H){let{attributes:W}=R,{transformFieldRoles:q}=H;const Q=W[q.originX],J=W[q.originY],X=W[q.originZ];return new $.A({x:Q,y:J,z:X,spatialReference:G})}(R,H,W),re=J.A.fromJSON(R.geometry);re.spatialReference=H;const se=function E(R,G){let{transformFieldRoles:H}=G;return new ee.A({translation:[R[H.translationX],-R[H.translationZ],R[H.translationY]],rotationAxis:[R[H.rotationX],-R[H.rotationZ],R[H.rotationY]],rotationAngle:R[H.rotationDeg],scale:[R[H.scaleX],R[H.scaleZ],R[H.scaleY]]})}(R.attributes,W),ae=H.isGeographic?"local":"georeferenced",oe=function w(R){const G=Array.from(R.files.values()),H=new Array;for(const W of G){if(W.status!==ne.COMPLETED)return null;const R=new Array;for(const G of W.parts){if(!G)return null;R.push(new te.Bq(G.url,G.hash))}H.push(new te.Qp(W.name,W.mimeType,R))}return H}(K);return oe?X.A.createWithExternalSource(ie,oe,{extent:re,transform:se,vertexSpace:ae}):X.A.createIncomplete(ie,{extent:re,transform:se,vertexSpace:ae})}var ne;function S(R,G){const H=new Map;for(const W of G){const G=W.parentGlobalId;if(null==G)continue;const q=W.assetName,J=W.assetType,X=W.assetHash,$=W.assetURL,K=W.conversionStatus,ee=W.seqNo,te=(0,ie.Fm)(J,R.supportedFormats);if(!te){m().error("mesh-feature-set:unknown-format","Service returned an asset of type ".concat(J,", but it does not list it as a supported type"));continue}const re=(0,Q.tE)(H,G,(()=>({files:new Map})));(0,Q.tE)(re.files,q,(()=>({name:q,type:J,mimeType:te,status:D(K),parts:[]}))).parts[ee]={hash:X,url:$}}return H}function D(R){switch(R){case"COMPLETED":case"SUBMITTED":return ne.COMPLETED;case"INPROGRESS":return ne.PENDING;default:return ne.FAILED}}!function(R){R[R.FAILED=0]="FAILED",R[R.PENDING=1]="PENDING",R[R.COMPLETED=2]="COMPLETED"}(ne||(ne={}))},89722:(R,G,H)=>{H.d(G,{$7:()=>y,B:()=>x,XF:()=>I,tW:()=>Z,w7:()=>i,ze:()=>l});H(49049),H(2001);function o(R){return R?W:q}function i(R,G){return function r(R,G){return null!==G&&void 0!==G&&G.mode?G.mode:o(R).mode}(null!=R&&R.hasZ,G)}function l(R,G){return function u(R,G){return null!=G?G:o(R)}(null!=R&&!!R.hasZ,G)}function x(R,G,H){return H&&H.mode!==G?"".concat(R," only support ").concat(G," elevation mode"):null}function y(R,G,H){return(null===H||void 0===H?void 0:H.mode)===G?"".concat(R," do not support ").concat(G," elevation mode"):null}function Z(R,G){return null!=(null===G||void 0===G?void 0:G.featureExpressionInfo)&&"0"!==G.featureExpressionInfo.expression?"".concat(R," do not support featureExpressionInfo"):null}function I(R,G){G&&R.warn(".elevationInfo=",G)}const W={mode:"absolute-height",offset:0},q={mode:"on-the-ground",offset:null}},64032:(R,G,H)=>{var W,q,Q,J,X,$,K,ee,te,ie,re,ne,se,ae,oe,le,ce,de,he,ue,pe,_e,me,ge,fe,ye,ve,be,xe,Se,Ce,we,Ae,Re,Te,Ee,Oe,Pe,Me,Ie,De,Le,Fe,Ne,Ve,Ue,Ge,ze,Be,He,je,We,ke,qe,Ze,Qe,Ye,Je,Xe,$e,Ke;H.d(G,{$2:()=>X,C1:()=>Q,JO:()=>q,M1:()=>_e,O$:()=>Ye,Q1:()=>Ue,TZ:()=>le,WE:()=>be,Y:()=>K,YI:()=>ze,bj:()=>ee,e_:()=>Ve,f0:()=>Qe,fu:()=>re,g7:()=>te,ip:()=>Ge,mU:()=>xe,oF:()=>ue,uQ:()=>pe,uT:()=>Ee,vG:()=>Xe,wd:()=>Ie,xR:()=>W,xn:()=>ce,xw:()=>fe,yS:()=>Oe}),function(R){R[R.BUTT=0]="BUTT",R[R.ROUND=1]="ROUND",R[R.SQUARE=2]="SQUARE",R[R.UNKNOWN=4]="UNKNOWN"}(W||(W={})),function(R){R[R.BEVEL=0]="BEVEL",R[R.ROUND=1]="ROUND",R[R.MITER=2]="MITER",R[R.UNKNOWN=4]="UNKNOWN"}(q||(q={})),function(R){R[R.SCREEN=0]="SCREEN",R[R.MAP=1]="MAP"}(Q||(Q={})),function(R){R[R.Tint=0]="Tint",R[R.Ignore=1]="Ignore",R[R.Multiply=99]="Multiply"}(J||(J={})),function(R){R.Both="Both",R.JustBegin="JustBegin",R.JustEnd="JustEnd",R.None="None"}(X||(X={})),function(R){R[R.Mosaic=0]="Mosaic",R[R.Centered=1]="Centered"}($||($={})),function(R){R[R.Normal=0]="Normal",R[R.Superscript=1]="Superscript",R[R.Subscript=2]="Subscript"}(K||(K={})),function(R){R[R.MSSymbol=0]="MSSymbol",R[R.Unicode=1]="Unicode"}(ee||(ee={})),function(R){R[R.Unspecified=0]="Unspecified",R[R.TrueType=1]="TrueType",R[R.PSOpenType=2]="PSOpenType",R[R.TTOpenType=3]="TTOpenType",R[R.Type1=4]="Type1"}(te||(te={})),function(R){R[R.Display=0]="Display",R[R.Map=1]="Map"}(ie||(ie={})),function(R){R.None="None",R.Loop="Loop",R.Oscillate="Oscillate"}(re||(re={})),function(R){R[R.Z=0]="Z",R[R.X=1]="X",R[R.Y=2]="Y"}(ne||(ne={})),function(R){R[R.XYZ=0]="XYZ",R[R.ZXY=1]="ZXY",R[R.YXZ=2]="YXZ"}(se||(se={})),function(R){R[R.Rectangle=0]="Rectangle",R[R.RoundedRectangle=1]="RoundedRectangle",R[R.Oval=2]="Oval"}(ae||(ae={})),function(R){R[R.None=0]="None",R[R.Alpha=1]="Alpha",R[R.Screen=2]="Screen",R[R.Multiply=3]="Multiply",R[R.Add=4]="Add"}(oe||(oe={})),function(R){R[R.TTB=0]="TTB",R[R.RTL=1]="RTL",R[R.BTT=2]="BTT"}(le||(le={})),function(R){R[R.None=0]="None",R[R.SignPost=1]="SignPost",R[R.FaceNearPlane=2]="FaceNearPlane"}(ce||(ce={})),function(R){R[R.Float=0]="Float",R[R.String=1]="String",R[R.Boolean=2]="Boolean"}(de||(de={})),function(R){R[R.Intersect=0]="Intersect",R[R.Subtract=1]="Subtract"}(he||(he={})),function(R){R.OpenEnded="OpenEnded",R.Block="Block",R.Crossed="Crossed"}(ue||(ue={})),function(R){R.FullGeometry="FullGeometry",R.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",R.ReversedFirstSegment="ReversedFirstSegment",R.PerpendicularToSecondSegment="PerpendicularToSecondSegment",R.SecondSegmentWithTicks="SecondSegmentWithTicks",R.DoublePerpendicular="DoublePerpendicular",R.OppositeToFirstSegment="OppositeToFirstSegment",R.TriplePerpendicular="TriplePerpendicular",R.HalfCircleFirstSegment="HalfCircleFirstSegment",R.HalfCircleSecondSegment="HalfCircleSecondSegment",R.HalfCircleExtended="HalfCircleExtended",R.OpenCircle="OpenCircle",R.CoverageEdgesWithTicks="CoverageEdgesWithTicks",R.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",R.GapExtentMidline="GapExtentMidline",R.Chevron="Chevron",R.PerpendicularWithArc="PerpendicularWithArc",R.ClosedHalfCircle="ClosedHalfCircle",R.TripleParallelExtended="TripleParallelExtended",R.ParallelWithTicks="ParallelWithTicks",R.Parallel="Parallel",R.PerpendicularToFirstSegment="PerpendicularToFirstSegment",R.ParallelOffset="ParallelOffset",R.OffsetOpposite="OffsetOpposite",R.OffsetSame="OffsetSame",R.CircleWithArc="CircleWithArc",R.DoubleJog="DoubleJog",R.PerpendicularOffset="PerpendicularOffset",R.LineExcludingLastSegment="LineExcludingLastSegment",R.MultivertexArrow="MultivertexArrow",R.CrossedArrow="CrossedArrow",R.ChevronArrow="ChevronArrow",R.ChevronArrowOffset="ChevronArrowOffset",R.PartialFirstSegment="PartialFirstSegment",R.Arch="Arch",R.CurvedParallelTicks="CurvedParallelTicks",R.Arc90Degrees="Arc90Degrees"}(pe||(pe={})),function(R){R.Mitered="Mitered",R.Bevelled="Bevelled",R.Rounded="Rounded",R.Square="Square",R.TrueBuffer="TrueBuffer"}(_e||(_e={})),function(R){R.ClosePath="ClosePath",R.ConvexHull="ConvexHull",R.RectangularBox="RectangularBox"}(me||(me={})),function(R){R.BeginningOfLine="BeginningOfLine",R.EndOfLine="EndOfLine"}(ge||(ge={})),function(R){R.Mitered="Mitered",R.Bevelled="Bevelled",R.Rounded="Rounded",R.Square="Square"}(fe||(fe={})),function(R){R.Fast="Fast",R.Accurate="Accurate"}(ye||(ye={})),function(R){R.BeginningOfLine="BeginningOfLine",R.EndOfLine="EndOfLine"}(ve||(ve={})),function(R){R.Sinus="Sinus",R.Square="Square",R.Triangle="Triangle",R.Random="Random"}(be||(be={})),function(R){R[R.None=0]="None",R[R.Default=1]="Default",R[R.Force=2]="Force"}(xe||(xe={})),function(R){R[R.Buffered=0]="Buffered",R[R.Left=1]="Left",R[R.Right=2]="Right",R[R.AlongLine=3]="AlongLine"}(Se||(Se={})),function(R){R[R.Linear=0]="Linear",R[R.Rectangular=1]="Rectangular",R[R.Circular=2]="Circular",R[R.Buffered=3]="Buffered"}(Ce||(Ce={})),function(R){R[R.Discrete=0]="Discrete",R[R.Continuous=1]="Continuous"}(we||(we={})),function(R){R[R.AcrossLine=0]="AcrossLine",R[R.AloneLine=1]="AloneLine"}(Ae||(Ae={})),function(R){R[R.Left=0]="Left",R[R.Right=1]="Right",R[R.Center=2]="Center",R[R.Justify=3]="Justify"}(Re||(Re={})),function(R){R[R.Base=0]="Base",R[R.MidPoint=1]="MidPoint",R[R.ThreePoint=2]="ThreePoint",R[R.FourPoint=3]="FourPoint",R[R.Underline=4]="Underline",R[R.CircularCW=5]="CircularCW",R[R.CircularCCW=6]="CircularCCW"}(Te||(Te={})),function(R){R.Butt="Butt",R.Round="Round",R.Square="Square"}(Ee||(Ee={})),function(R){R.NoConstraint="NoConstraint",R.HalfPattern="HalfPattern",R.HalfGap="HalfGap",R.FullPattern="FullPattern",R.FullGap="FullGap",R.Custom="Custom"}(Oe||(Oe={})),function(R){R[R.None=-1]="None",R[R.Custom=0]="Custom",R[R.Circle=1]="Circle",R[R.OpenArrow=2]="OpenArrow",R[R.ClosedArrow=3]="ClosedArrow",R[R.Diamond=4]="Diamond"}(Pe||(Pe={})),function(R){R[R.ExtraLeading=0]="ExtraLeading",R[R.Multiple=1]="Multiple",R[R.Exact=2]="Exact"}(Me||(Me={})),function(R){R.Bevel="Bevel",R.Round="Round",R.Miter="Miter"}(Ie||(Ie={})),function(R){R[R.Default=0]="Default",R[R.String=1]="String",R[R.Numeric=2]="Numeric"}(De||(De={})),function(R){R[R.InsidePolygon=0]="InsidePolygon",R[R.PolygonCenter=1]="PolygonCenter",R[R.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(Le||(Le={})),function(R){R[R.Tint=0]="Tint",R[R.Replace=1]="Replace",R[R.Multiply=2]="Multiply"}(Fe||(Fe={})),function(R){R[R.ClipAtBoundary=0]="ClipAtBoundary",R[R.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",R[R.DoNotTouchBoundary=2]="DoNotTouchBoundary",R[R.DoNotClip=3]="DoNotClip"}(Ne||(Ne={})),function(R){R.NoConstraint="NoConstraint",R.WithMarkers="WithMarkers",R.WithFullGap="WithFullGap",R.WithHalfGap="WithHalfGap",R.Custom="Custom"}(Ve||(Ve={})),function(R){R.Fixed="Fixed",R.Random="Random",R.RandomFixedQuantity="RandomFixedQuantity"}(Ue||(Ue={})),function(R){R.LineMiddle="LineMiddle",R.LineBeginning="LineBeginning",R.LineEnd="LineEnd",R.SegmentMidpoint="SegmentMidpoint"}(Ge||(Ge={})),function(R){R.OnPolygon="OnPolygon",R.CenterOfMass="CenterOfMass",R.BoundingBoxCenter="BoundingBoxCenter"}(ze||(ze={})),function(R){R[R.Low=0]="Low",R[R.Medium=1]="Medium",R[R.High=2]="High"}(Be||(Be={})),function(R){R[R.MarkerCenter=0]="MarkerCenter",R[R.MarkerBounds=1]="MarkerBounds"}(He||(He={})),function(R){R[R.None=0]="None",R[R.PropUniform=1]="PropUniform",R[R.PropNonuniform=2]="PropNonuniform",R[R.DifUniform=3]="DifUniform",R[R.DifNonuniform=4]="DifNonuniform"}(je||(je={})),function(R){R.Tube="Tube",R.Strip="Strip",R.Wall="Wall"}(We||(We={})),function(R){R[R.Random=0]="Random",R[R.Increasing=1]="Increasing",R[R.Decreasing=2]="Decreasing",R[R.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(ke||(ke={})),function(R){R[R.Relative=0]="Relative",R[R.Absolute=1]="Absolute"}(qe||(qe={})),function(R){R[R.Normal=0]="Normal",R[R.LowerCase=1]="LowerCase",R[R.Allcaps=2]="Allcaps"}(Ze||(Ze={})),function(R){R[R.LTR=0]="LTR",R[R.RTL=1]="RTL"}(Qe||(Qe={})),function(R){R.Draft="Draft",R.Picture="Picture",R.Text="Text"}(Ye||(Ye={})),function(R){R[R.Top=0]="Top",R[R.Center=1]="Center",R[R.Baseline=2]="Baseline",R[R.Bottom=3]="Bottom"}(Je||(Je={})),function(R){R[R.Right=0]="Right",R[R.Upright=1]="Upright"}(Xe||(Xe={})),function(R){R[R.Small=0]="Small",R[R.Medium=1]="Medium",R[R.Large=2]="Large"}($e||($e={})),function(R){R[R.Calm=0]="Calm",R[R.Rippled=1]="Rippled",R[R.Slight=2]="Slight",R[R.Moderate=3]="Moderate"}(Ke||(Ke={}))},32658:(R,G,H)=>{H.d(G,{I:()=>h,p:()=>j,resolveWebStyleSymbol:()=>g});var W=H(21343),q=H(17067),Q=H(4180),J=H(4270),X=H(91710),$=H(85173),K=H(34985),ee=H(89973),te=H(48886),ie=H(82750);function g(R,G,H,W){const q=R.name;return null==q?Promise.reject(new Q.A("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference")):R.styleName&&"Esri2DPointSymbolsStyle"===R.styleName?function d(R,G,H){const W=te.jg.replaceAll(/\{SymbolName\}/gi,R),q=null!=G.portal?G.portal:X.A.getDefault();return(0,te.yA)(W,H).then((R=>{const G=(0,te.bo)(R.data);return(0,K.rS)(G,{portal:q,url:(0,J.An)((0,J.nM)(W)),origin:"portal-item"})}))}(q,G,W):(0,te.cF)(R,G,W).then((R=>h(R,q,G,H,te.o5,W)))}function j(R,G){return G.items.find((G=>G.name===R))}function h(R,G,H,re,ne,se){var ae,oe,le,ce;const de=null!=(null===H||void 0===H?void 0:H.portal)?H.portal:X.A.getDefault(),he={portal:de,url:(0,J.An)(R.baseUrl),origin:"portal-item"},ue=j(G,R.data);if(!ue){const R="The symbol name '".concat(G,"' could not be found");return Promise.reject(new Q.A("symbolstyleutils:symbol-name-not-found",R,{symbolName:G}))}let pe=(0,$.f)(ne(ue,re),he),_e=null!==(ae=null===(oe=ue.thumbnail)||void 0===oe?void 0:oe.href)&&void 0!==ae?ae:null;const me=null===(le=ue.thumbnail)||void 0===le?void 0:le.imageData;(0,q.b5)()&&(pe=null!==(ce=(0,q.EM)(pe))&&void 0!==ce?ce:"",_e=(0,q.EM)(_e));const ge={portal:de,url:(0,J.An)((0,J.nM)(pe)),origin:"portal-item"};return(0,te.yA)(pe,se).then((q=>{const Q="cimRef"===re?(0,te.bo)(q.data):q.data,J=(0,K.rS)(Q,ge);if(J&&(0,W.wk)(J)){if(_e){const R=(0,$.f)(_e,he);J.thumbnail=new ie.V({url:R})}else me&&(J.thumbnail=new ie.V({url:"data:image/png;base64,".concat(me)}));R.styleUrl?J.styleOrigin=new ee.A({portal:H.portal,styleUrl:R.styleUrl,name:G}):R.styleName&&(J.styleOrigin=new ee.A({portal:H.portal,styleName:R.styleName,name:G}))}return J}))}},22070:(R,G,H)=>{H.d(G,{A:()=>i});var W=H(40102);class i{constructor(R,G,H,q){this.computedX=0,this.computedY=0,this.center=(0,W.fA)(R,G),this.centerT=(0,W.vt)(),this.halfWidth=H/2,this.halfHeight=q/2,this.width=H,this.height=q}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(R){this.center[0]=R}set y(R){this.center[1]=R}clone(){return new i(this.x,this.y,this.width,this.height)}serialize(R){return R.writeF32(this.center[0]),R.writeF32(this.center[1]),R.push(this.width),R.push(this.height),R}findCollisionDelta(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;const H=Math.abs(R.centerT[0]-this.centerT[0]),W=Math.abs(R.centerT[1]-this.centerT[1]),q=(R.halfWidth+this.halfWidth+G)/H,Q=(R.halfHeight+this.halfHeight+G)/W,J=Math.min(q,Q);return Math.log2(J)}extend(R){const G=Math.min(this.xmin,R.xmin),H=Math.min(this.ymin,R.ymin),W=Math.max(this.xmax,R.xmax)-G,q=Math.max(this.ymax,R.ymax)-H,Q=G+W/2,J=H+q/2;this.width=W,this.height=q,this.halfWidth=W/2,this.halfHeight=q/2,this.x=Q,this.y=J}static deserialize(R){const G=R.readF32(),H=R.readF32(),W=R.readInt32(),q=R.readInt32();return new i(G,H,W,q)}}},80271:(R,G,H)=>{H.d(G,{$U:()=>xe,C2:()=>te,CQ:()=>q,CR:()=>pe,C_:()=>Ce,Cp:()=>_e,DY:()=>K,Gh:()=>ve,LY:()=>fe,O5:()=>Me,Pq:()=>ie,Qb:()=>Oe,Sr:()=>he,TB:()=>Ne,Tv:()=>J,Vl:()=>Fe,Xh:()=>Le,YS:()=>ne,YV:()=>X,_j:()=>Ae,_x:()=>Ie,bg:()=>Q,c5:()=>be,dV:()=>ge,eG:()=>ee,eI:()=>De,fq:()=>Te,g0:()=>ye,hM:()=>we,ju:()=>$,lL:()=>le,mg:()=>Se,n9:()=>de,nM:()=>oe,nW:()=>Re,qM:()=>W,r1:()=>Pe,sn:()=>ce,uM:()=>se,ue:()=>re,vN:()=>me,vd:()=>ue,yv:()=>Ee,z2:()=>ae});const W=1e-30,q=512,Q=128,J=511,X=16777216,$=8,K=29,ee=24,te=4,ie=0,re=0,ne=0,se=1,ae=2,oe=3,le=4,ce=5,de=6,he=12,ue=5,pe=6,_e=5,me=6;var ge;!function(R){R[R.FilterFlags=0]="FilterFlags",R[R.Animation=1]="Animation",R[R.GPGPU=2]="GPGPU",R[R.VV=3]="VV",R[R.DD0=4]="DD0",R[R.DD1=5]="DD1",R[R.DD2=6]="DD2"}(ge||(ge={}));const fe=8,ye=fe<<1,ve=1.05,be=1,xe=5,Se=6,Ce=1.15,we=2,Ae=128-2*we,Re=2,Te=10,Ee=1024,Oe=128,Pe=4,Me=1,Ie=1<<20,De=.75,Le=10,Fe=.75,Ne=256},74769:(R,G,H)=>{var W,q;function N(R){return null!=R&&!R.running}H.d(G,{c:()=>q,c2:()=>W,pi:()=>N}),function(R){R[R.RENDERING=0]="RENDERING",R[R.FADING=1]="FADING",R[R.FINISHED=2]="FINISHED"}(W||(W={})),function(R){R[R.RG=0]="RG",R[R.BA=1]="BA"}(q||(q={}))},41201:(R,G,H)=>{H.d(G,{OQ:()=>W,ny:()=>A});var W,q=H(48237),Q=H(39393),J=H(70655),X=H(54880),$=H(83800),K=H(58968),ee=H(39572),te=H(74769),ie=H(91400),re=H(57492);class A{constructor(){this.readChannels=te.c.RG,this.renderingStage=te.c2.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=(0,$.vt)(),this.parallax=new C,this.parallaxNew=new C,this.pointOnGround=(0,$.vt)(),this.fadeMode=W.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(R){const G=this.parallax,H=(0,X.l)(R.eye);if(G.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(H*H-ee.$O.radius*ee.$O.radius,0))/H,(0,K.Cr)(ne,G.anchorPointClouds,se),(0,Q.e$)(G.transform,J.zK,se[3],(0,K.yo)(se)),this.fadeMode===W.CROSS_FADE){const R=this.parallaxNew;(0,K.Cr)(ne,R.anchorPointClouds,se),(0,Q.e$)(R.transform,J.zK,se[3],(0,K.yo)(se))}}updateFading(R,G,H,W){this.isFading&&this._advanceFading(H,W),this._evaluateFading(R,G,H)}_evaluateFading(R,G,H){const q=R.relativeElevation,Q=this._calculateDistanceToAnchorPoint(R);if((q>1.7*ie.ni||q<-ie.ni||Q>de)&&this.opacity>0)this._setFade(W.HIDE,H);else if(!this.isFading)if((q>ie.ni||q<-.35*ie.ni||Q>ce)&&this.opacity>0)this._setFade(W.FADE_OUT,H);else if(q<=ie.ni&&q>=-.35*ie.ni&&G===re.M.IDLE&&(0,te.pi)(this.data)){if(0===this.opacity)return void this._setFade(W.FADE_IN,H);(Q>le||this.renderingStage===te.c2.FADING)&&this._setFade(W.CROSS_FADE,H)}}_advanceFading(R,G){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(R,G)}_advanceFadingFactorAndOpacity(R,G){if(this.fadeFactor<1)return this.fadeFactor=G?(0,q.qE)((R-this.startTime)/(oe*G),0,1):1,this.fadeMode===W.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===W.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===W.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===W.FADE_OUT&&(this.opacity=0),this.fadeMode===W.FADE_IN&&(this.opacity=1),this.fadeMode===W.CROSS_FADE&&(this.opacity=1),this.fadeMode=W.NONE}_switchReadChannels(){const R=this.fadeMode===W.CROSS_FADE&&1===this.fadeFactor,G=this.fadeMode===W.FADE_IN&&0===this.fadeFactor;this.renderingStage===te.c2.FADING&&(R||G)&&(this.readChannels=1-this.readChannels,this.renderingStage=te.c2.FINISHED)}_calculateDistanceToAnchorPoint(R){return(0,X.n)(this.pointOnGround,R.eye),(0,X.h)(this.pointOnGround,this.pointOnGround,ee.$O.radius),(0,X.l)((0,X.f)(ae,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===W.CROSS_FADE&&(0===this.fadeFactor&&(0,X.c)(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&(0,X.c)(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===W.FADE_IN&&0===this.fadeFactor&&(0,X.c)(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(R,G){switch(R){case W.HIDE:this.opacity=0;break;case W.FADE_OUT:this.opacity=1;break;case W.FADE_IN:this.opacity=0;break;case W.CROSS_FADE:this.opacity=1}this.fadeMode=R,this.fadeFactor=0,this.startTime=G}get isFading(){return this.fadeMode===W.FADE_OUT||this.fadeMode===W.FADE_IN||this.fadeMode===W.CROSS_FADE}}!function(R){R[R.NONE=0]="NONE",R[R.HIDE=1]="HIDE",R[R.FADE_OUT=2]="FADE_OUT",R[R.FADE_IN=3]="FADE_IN",R[R.CROSS_FADE=4]="CROSS_FADE"}(W||(W={}));class C{constructor(){this.anchorPointClouds=(0,$.vt)(),this.radiusCurvatureCorrectionFactor=0,this.transform=(0,J.vt)()}}const ne=(0,$.fA)(0,0,1),se=(0,K.vt)(),ae=(0,$.vt)(),oe=1.25,le=34e3,ce=64e3,de=2e5},91400:(R,G,H)=>{H.d(G,{k9:()=>_e,ni:()=>pe});var W,q=H(80671),Q=H(83375),J=H(57453),X=(H(50886),H(89412),H(76761),H(99825)),$=H(68682);let K=W=class extends Q.oY{constructor(R){super(R),this.type="cloudy",this.cloudCover=.5}clone(){return new W({cloudCover:this.cloudCover})}};(0,q._)([(0,X.e)({cloudy:"cloudy"})],K.prototype,"type",void 0),(0,q._)([(0,J.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],K.prototype,"cloudCover",void 0),K=W=(0,q._)([(0,$.$)("esri.views.3d.environment.CloudyWeather")],K);const ee=K;var te;let ie=te=class extends Q.oY{constructor(R){super(R),this.type="foggy",this.fogStrength=.5}clone(){return new te({fogStrength:this.fogStrength})}};(0,q._)([(0,X.e)({foggy:"foggy"})],ie.prototype,"type",void 0),(0,q._)([(0,J.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ie.prototype,"fogStrength",void 0),ie=te=(0,q._)([(0,$.$)("esri.views.3d.environment.FoggyWeather")],ie);const re=ie;var ne;let se=ne=class extends Q.oY{constructor(R){super(R),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new ne({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,q._)([(0,X.e)({rainy:"rainy"})],se.prototype,"type",void 0),(0,q._)([(0,J.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],se.prototype,"cloudCover",void 0),(0,q._)([(0,J.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],se.prototype,"precipitation",void 0),se=ne=(0,q._)([(0,$.$)("esri.views.3d.environment.RainyWeather")],se);const ae=se;var oe;let le=oe=class extends Q.oY{constructor(R){super(R),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new oe({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};(0,q._)([(0,X.e)({snowy:"snowy"})],le.prototype,"type",void 0),(0,q._)([(0,J.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],le.prototype,"cloudCover",void 0),(0,q._)([(0,J.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],le.prototype,"precipitation",void 0),(0,q._)([(0,J.MZ)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],le.prototype,"snowCover",void 0),le=oe=(0,q._)([(0,$.$)("esri.views.3d.environment.SnowyWeather")],le);const ce=le;var de;let he=de=class extends Q.oY{constructor(R){super(R),this.type="sunny",this.cloudCover=.5}clone(){return new de({cloudCover:this.cloudCover})}};(0,q._)([(0,X.e)({sunny:"sunny"})],he.prototype,"type",void 0),(0,q._)([(0,J.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],he.prototype,"cloudCover",void 0),he=de=(0,q._)([(0,$.$)("esri.views.3d.environment.SunnyWeather")],he);const ue={key:"type",base:he,typeMap:{sunny:he,cloudy:ee,rainy:ae,snowy:ce,foggy:re}};Object.keys(ue.typeMap);const pe=1e4,_e=1e5},14784:(R,G,H)=>{H.r(G),H.d(G,{destroyContext:()=>b,dracoDecompressPointCloudData:()=>l,filterObbsForModifications:()=>u,filterObbsForModificationsSync:()=>L,initialize:()=>j,interpretObbModificationResults:()=>A,process:()=>c,project:()=>p,setLegacySchema:()=>y,setModifications:()=>m,setModificationsSync:()=>w,test:()=>ne,transformNormals:()=>d});var W=H(98664),q=H(39783),Q=H(75478),J=H(49837),X=H(98504),$=H(29405),K=H(14795);function i(R){return(0,K.s)("esri/libs/i3s/".concat(R))}let ee;var te=H(65791);async function c(R){re=await _();const G=[R.geometryBuffer];return{result:E(re,R,G),transferList:G}}async function l(R){var G;re=await _();const H=[R.geometryBuffer],{geometryBuffer:W}=R,q=W.byteLength,Q=re._malloc(q),J=new Uint8Array(re.HEAPU8.buffer,Q,q);J.set(new Uint8Array(W));const X=re.dracoDecompressPointCloudData(Q,J.byteLength);if(re._free(Q),X.error.length>0)throw new Error("i3s.wasm: ".concat(X.error));const $=(null===(G=X.featureIds)||void 0===G?void 0:G.length)>0?X.featureIds.slice():null,K=X.positions.slice();return $&&H.push($.buffer),H.push(K.buffer),{result:{positions:K,featureIds:$},transferList:H}}async function u(R){await _(),L(R);const G={buffer:R.buffer};return{result:G,transferList:[G.buffer]}}async function m(R){await _(),w(R)}async function y(R){re=await _(),re.setLegacySchema(R.context,R.jsonSchema)}async function p(R){const{localMatrix:G,origin:X,positions:$,vertexSpace:K,localMode:ee}=R,te=W.A.fromJSON(R.inSpatialReference),ie=W.A.fromJSON(R.outSpatialReference);let re;if("georeferenced"===K.type&&null==K.origin){const[{projectBuffer:R},{initializeProjection:G}]=await Promise.all([Promise.resolve().then(H.bind(H,33876)),Promise.resolve().then(H.bind(H,54208))]);await G(te,ie),re=new Float64Array($.length),R($,te,0,re,ie,0,re.length/3)}else{const R="georeferenced"===K.type?Q.A.fromJSON(K):J.A.fromJSON(K),{project:W}=await Promise.all([H.e(9278),H.e(148)]).then(H.bind(H,20148));re=(0,q.Ns)(W({positions:$,transform:G?{localMatrix:G}:void 0,vertexSpace:R,inSpatialReference:te,outSpatialReference:ie,localMode:ee}))}const ne=re.length,[se,ae,oe]=X;for(let H=0;H<ne;H+=3)re[H]-=se,re[H+1]-=ae,re[H+2]-=oe;return{result:{projected:re,original:$},transferList:[re.buffer,$.buffer]}}async function d(R){let{normalMatrix:G,normals:H}=R;const W=new Float32Array(H.length);return(0,X.b)(W,H,G),(0,X.n)(W,W),{result:{transformed:W,original:H},transferList:[W.buffer,H.buffer]}}function b(R){I(R)}let ie,re;function w(R){if(!re)return;const G=R.modifications,H=re._malloc(8*G.length),W=new Float64Array(re.HEAPU8.buffer,H,G.length);for(let q=0;q<G.length;++q)W[q]=G[q];re.setModifications(R.context,H,G.length,R.isGeodetic),re._free(H)}function E(R,G,H){const{context:W,localOrigin:q,globalTrafo:Q,mbs:J,obbData:X,elevationOffset:K,geometryBuffer:ee,geometryDescriptor:te,indexToVertexProjector:ie,vertexToRenderProjector:re}=G,ne=R._malloc(ee.byteLength),se=R._malloc(33*Float64Array.BYTES_PER_ELEMENT),ae=new Uint8Array(R.HEAPU8.buffer,ne,ee.byteLength);ae.set(new Uint8Array(ee));const oe=new Float64Array(R.HEAPU8.buffer,se,33);S(oe,q);let le=oe.byteOffset+3*oe.BYTES_PER_ELEMENT,ce=new Float64Array(oe.buffer,le);S(ce,Q),le+=16*oe.BYTES_PER_ELEMENT,ce=new Float64Array(oe.buffer,le),S(ce,J),le+=4*oe.BYTES_PER_ELEMENT,X&&(ce=new Float64Array(oe.buffer,le),S(ce,X));const de=te,he={isDraco:!1,isLegacy:!1,color:G.layouts.some((R=>R.some((R=>"color"===R.name)))),normal:G.needNormals&&G.layouts.some((R=>R.some((R=>"normalCompressed"===R.name)))),uv0:G.layouts.some((R=>R.some((R=>"uv0"===R.name)))),uvRegion:G.layouts.some((R=>R.some((R=>"uvRegion"===R.name)))),featureIndex:de.featureIndex},ue=R.process(W,!!G.obbData,ne,ae.byteLength,de,he,se,K,ie,re,G.normalReferenceFrame);if(R._free(se),R._free(ne),ue.error.length>0)throw new Error("i3s.wasm: ".concat(ue.error));if(ue.discarded)return null;const pe=ue.componentOffsets.length>0?ue.componentOffsets.slice():null,_e=ue.featureIds.length>0?ue.featureIds.slice():null,me=ue.anchorIds.length>0?Array.from(ue.anchorIds):null,ge=ue.anchors.length>0?Array.from(ue.anchors):null,fe=ue.interleavedVertedData.slice().buffer,ye=ue.indicesType===$.f.Int16?new Uint16Array(ue.indices.buffer,ue.indices.byteOffset,ue.indices.byteLength/2).slice():new Uint32Array(ue.indices.buffer,ue.indices.byteOffset,ue.indices.byteLength/4).slice(),ve=ue.positions.slice(),be=ue.positionIndicesType===$.f.Int16?new Uint16Array(ue.positionIndices.buffer,ue.positionIndices.byteOffset,ue.positionIndices.byteLength/2).slice():new Uint32Array(ue.positionIndices.buffer,ue.positionIndices.byteOffset,ue.positionIndices.byteLength/4).slice(),xe={layout:G.layouts[0],interleavedVertexData:fe,indices:ye,hasColors:ue.hasColors,hasModifications:ue.hasModifications,positionData:{data:ve,indices:be}};return _e&&H.push(_e.buffer),pe&&H.push(pe.buffer),H.push(fe),H.push(ye.buffer),H.push(ve.buffer),H.push(be.buffer),{componentOffsets:pe,featureIds:_e,anchorIds:me,anchors:ge,transformedGeometry:xe,obb:ue.obb}}function A(R){return 0===R?te.Js.Unmodified:1===R?te.Js.PotentiallyModified:2===R?te.Js.Culled:te.Js.Unknown}function L(R){if(!re)return;const{context:G,buffer:H}=R,W=re._malloc(H.byteLength),q=H.byteLength/Float64Array.BYTES_PER_ELEMENT,Q=new Float64Array(re.HEAPU8.buffer,W,q),J=new Float64Array(H);Q.set(J),re.filterOBBs(G,W,q),J.set(Q),re._free(W)}function I(R){re&&0===re.destroy(R)&&(re=null)}function S(R,G){for(let H=0;H<G.length;++H)R[H]=G[H]}async function j(){re||await _()}function _(){return re?Promise.resolve(re):(ie||(ie=function e(){return ee||(ee=new Promise((R=>H.e(9570).then(H.bind(H,49570)).then((R=>R.i)).then((G=>{let{default:H}=G;const W=H({locateFile:i,onRuntimeInitialized:()=>R(W)});delete W.then})))).catch((R=>{throw R}))),ee}().then((R=>(re=R,ie=null,re)))),ie)}const ne={transform:(R,G)=>re&&E(re,R,G),destroy:I}},65791:(R,G,H)=>{H.d(G,{EG:()=>l,Js:()=>q,TJ:()=>W,UY:()=>X,ay:()=>s,bP:()=>h,cJ:()=>J,iF:()=>Q});var W,q,Q,J,X,$=H(40727),K=H(65174),ee=H(72015),te=H(46257);class s extends te.H{constructor(R,G){super(NaN,NaN),this.id=R,this.serviceMbsInIndexSR=G,this.serviceMbsInRenderSR=(0,K.f)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){var R;(0,ee.Q7)(this.serviceMbsInRenderSR),null===(R=this.serviceObbInRenderSR)||void 0===R||R.invalidate()}shareServiceBVsInRenderSRWith(R){this.serviceObbInRenderSR=R.serviceObbInRenderSR,this.serviceMbsInRenderSR=R.serviceMbsInRenderSR}}!function(R){R[R.Unmodified=0]="Unmodified",R[R.Culled=1]="Culled",R[R.NotChecked=2]="NotChecked"}(W||(W={})),function(R){R[R.Unmodified=0]="Unmodified",R[R.PotentiallyModified=1]="PotentiallyModified",R[R.Culled=2]="Culled",R[R.Unknown=3]="Unknown",R[R.NotChecked=4]="NotChecked"}(q||(q={}));class h extends s{constructor(R,G,H,W,J,X,K,ee,te,ie){super(R,H),this.index=G,this.childCount=W,this.level=J,this.resources=X,this.version=K,this.lodMetric=ee,this.maxError=te,this.numFeatures=ie,this.failed=!1,this.cacheState=Q.Unknown,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=q.NotChecked,this.elevationAgnosticBoundingVolume=(0,$.fA)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){super.invalidateServiceBVsInRenderSR(),this.elevationAgnosticBoundingVolume[3]=-1}}!function(R){R[R.Unknown=0]="Unknown",R[R.Uncached=1]="Uncached",R[R.Cached=2]="Cached"}(Q||(Q={})),function(R){R[R.None=0]="None",R[R.MaxScreenThreshold=1]="MaxScreenThreshold",R[R.ScreenSpaceRelative=2]="ScreenSpaceRelative",R[R.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",R[R.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(J||(J={})),function(R){R[R.Hole=0]="Hole",R[R.Leaf=1]="Leaf"}(X||(X={}));class l{constructor(R,G,H,W){this.nodeHasLOD=R,this.isChosen=G,this.lodLevel=H,this.version=W}}},46257:(R,G,H)=>{H.d(G,{H:()=>e});class e{constructor(){let R=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1/0;this.elevationRangeMin=R,this.elevationRangeMax=G}get elevationRangeValid(){return!Number.isNaN(this.elevationRangeMin)}invalidateElevationRange(){this.elevationRangeMin=NaN}expandElevationRangeValues(R,G){this.elevationRangeMin=Math.min(this.elevationRangeMin,R),this.elevationRangeMax=Math.max(this.elevationRangeMax,G)}expandElevationRange(R){this.elevationRangeMin=Math.min(this.elevationRangeMin,R.elevationRangeMin),this.elevationRangeMax=Math.max(this.elevationRangeMax,R.elevationRangeMax)}setElevationRange(R){this.elevationRangeMin=R.elevationRangeMin,this.elevationRangeMax=R.elevationRangeMax}}},27361:(R,G,H)=>{H.d(G,{U:()=>r});var W=H(60985),q=H(40332);function r(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const H=R.stride;return Array.from(R.fields.keys()).map((W=>{const Q=R.fields.get(W),J=Q.constructor.ElementCount,X=o(Q.constructor.ElementType),$=Q.offset,K=!(!Q.optional||!Q.optional.glNormalized);return new q._(W,J,X,$,H,K,G)}))}function o(R){const G=Q[R];if(G)return G;throw new Error("BufferType not supported in WebGL")}const Q={u8:W.pe.UNSIGNED_BYTE,u16:W.pe.UNSIGNED_SHORT,u32:W.pe.UNSIGNED_INT,i8:W.pe.BYTE,i16:W.pe.SHORT,i32:W.pe.INT,f32:W.pe.FLOAT}},35211:(R,G,H)=>{H.d(G,{Cz:()=>q,DZ:()=>X,PV:()=>J,vO:()=>W});H(21740),H(60985),H(83663),H(83881);const W=64,q=W/2,Q=q/5,J=W/Q,X=.25},21740:(R,G,H)=>{H.d(G,{CN:()=>X,Q_:()=>J,ny:()=>a,sZ:()=>u});H(50886);var W=H(31714),q=H(1382),Q=H(60985);const J=128,X=.5;function a(R){return"cross"===R||"x"===R}function u(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J;const H=c(R,G,arguments.length>2&&void 0!==arguments[2]?arguments[2]:G*X,arguments.length>3&&void 0!==arguments[3]?arguments[3]:0);return new q.g(H,{mipmap:!1,wrap:{s:Q.pF.CLAMP_TO_EDGE,t:Q.pF.CLAMP_TO_EDGE},width:G,height:G,components:4,noUnpackFlip:!0,reloadable:!0})}function c(R){let G=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J,H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:G*X,W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;switch(R){case"circle":default:return function s(R,G){const H=R/2-.5;return x(R,T(H,H,G/2))}(G,H);case"square":return function i(R,G){return p(R,G,!1)}(G,H);case"cross":return function h(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return b(R,G,!1,H)}(G,H,W);case"x":return function M(R,G){let H=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return b(R,G,!0,H)}(G,H,W);case"kite":return function f(R,G){return p(R,G,!0)}(G,H);case"triangle":return function l(R,G){return x(R,w(R/2,G,G/2))}(G,H);case"arrow":return function m(R,G){const H=G,W=G/2,q=R/2,Q=.8*H,J=T(q,(R-G)/2-Q,Math.sqrt(Q*Q+W*W)),X=w(q,H,W);return x(R,((R,G)=>Math.max(X(R,G),-J(R,G))))}(G,H)}}function p(R,G,H){return H&&(G/=Math.SQRT2),x(R,((W,q)=>{let Q=W-.5*R+.25,J=.5*R-q-.75;if(H){const R=(Q+J)/Math.SQRT2;J=(J-Q)/Math.SQRT2,Q=R}return Math.max(Math.abs(Q),Math.abs(J))-.5*G}))}function b(R,G,H){let W=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;G-=W,H&&(G*=Math.SQRT2);const q=.5*G;return x(R,((G,Q)=>{let J,X=G-.5*R,$=.5*R-Q-1;if(H){const R=(X+$)/Math.SQRT2;$=($-X)/Math.SQRT2,X=R}return X=Math.abs(X),$=Math.abs($),J=X>$?X>q?Math.sqrt((X-q)*(X-q)+$*$):$:$>q?Math.sqrt(X*X+($-q)*($-q)):X,J-=W/2,J}))}function T(R,G,H){return(W,q)=>{const Q=W-R,J=q-G;return Math.sqrt(Q*Q+J*J)-H}}function w(R,G,H){const W=Math.sqrt(G*G+H*H);return(q,Q)=>{const J=Math.abs(q-R)-H,X=Q-R+G/2+.75,$=(G*J+H*X)/W,K=-X;return Math.max($,K)}}function x(R,G){const H=new Uint8Array(4*R*R);for(let q=0;q<R;q++)for(let Q=0;Q<R;Q++){const J=Q+R*q;let X=G(Q,q);X=X/R+.5,(0,W.U)(X,H,4*J)}return H}},37355:(R,G,H)=>{var W,q,Q,J;H.d(G,{vr:()=>W}),function(R){R[R.INNER=0]="INNER",R[R.OUTER=1]="OUTER"}(W||(W={})),function(R){R[R.REGULAR=0]="REGULAR",R[R.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",R[R.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",R[R.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(q||(q={})),function(R){R[R.OFF=0]="OFF",R[R.ON=1]="ON"}(Q||(Q={})),function(R){R[R.FADING=0]="FADING",R[R.IMMEDIATE=1]="IMMEDIATE",R[R.UNFADED=2]="UNFADED"}(J||(J={}))},93911:(R,G,H)=>{H.d(G,{H:()=>f,W:()=>n});var W,q,Q,J,X,$,K,ee,te,ie,re,ne=H(57528),se=H(52273),ae=H(63966),oe=H(69460),le=H(20373),ce=H(47909),de=H(89013),he=H(96767),ue=H(64286),pe=H(44828);const _e=8;function f(R,G){const H=ue.r.FEATUREVALUE;R.attributes.add(H,"vec4");const se=R.vertex;se.code.add((0,he.H)(W||(W=(0,ne.A)(["\n  bool isCapVertex() {\n    return ",".w == 1.0;\n  }\n  "])),H)),se.uniforms.add(new oe.G("size",(R=>R.size))),G.vvSize?(se.uniforms.add(new le.t("vvSizeMinSize",(R=>R.vvSize.minSize)),new le.t("vvSizeMaxSize",(R=>R.vvSize.maxSize)),new le.t("vvSizeOffset",(R=>R.vvSize.offset)),new le.t("vvSizeFactor",(R=>R.vvSize.factor))),se.code.add((0,he.H)(q||(q=(0,ne.A)(["\n    vec2 getSize() {\n      return size * clamp(vvSizeOffset + ",".x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;\n    }\n    "])),H))):se.code.add((0,he.H)(Q||(Q=(0,ne.A)(["vec2 getSize(){\nreturn size;\n}"])))),G.vvOpacity?(se.constants.add("vvOpacityNumber","int",_e),se.uniforms.add(new de.x("vvOpacityValues",(R=>R.vvOpacity.values),_e),new de.x("vvOpacityOpacities",(R=>R.vvOpacity.opacityValues),_e)),se.code.add((0,he.H)(J||(J=(0,ne.A)(["\n    vec4 applyOpacity(vec4 color) {\n      float value = ",".z;\n      if (value <= vvOpacityValues[0]) {\n        return vec4( color.xyz, vvOpacityOpacities[0]);\n      }\n\n      for (int i = 1; i < vvOpacityNumber; ++i) {\n        if (vvOpacityValues[i] >= value) {\n          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\n          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));\n        }\n      }\n\n      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);\n    }\n    "])),H))):se.code.add((0,he.H)(X||(X=(0,ne.A)(["vec4 applyOpacity(vec4 color){\nreturn color;\n}"])))),G.vvColor?(se.constants.add("vvColorNumber","int",pe.p),se.uniforms.add(new de.x("vvColorValues",(R=>R.vvColor.values),pe.p),new ce.F("vvColorColors",(R=>R.vvColor.colors),pe.p)),se.code.add((0,he.H)($||($=(0,ne.A)(["\n    vec4 getColor() {\n      float value = ",".y;\n      if (value <= vvColorValues[0]) {\n        return applyOpacity(vvColorColors[0]);\n      }\n\n      for (int i = 1; i < vvColorNumber; ++i) {\n        if (vvColorValues[i] >= value) {\n          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);\n          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));\n        }\n      }\n\n      return applyOpacity(vvColorColors[vvColorNumber - 1]);\n    }\n    "])),H))):se.code.add((0,he.H)(K||(K=(0,ne.A)(["vec4 getColor(){\nreturn applyOpacity(vec4(1, 1, 1, 1));\n}"])))),R.include(ae.I),R.attributes.add(ue.r.PROFILERIGHT,"vec4"),R.attributes.add(ue.r.PROFILEUP,"vec4"),R.attributes.add(ue.r.PROFILEVERTEXANDNORMAL,"vec4"),se.code.add((0,he.H)(ee||(ee=(0,ne.A)(["vec3 calculateVPos() {\nvec2 size = getSize();\nvec3 origin = position;\nvec3 right = profileRight.xyz;\nvec3 up = profileUp.xyz;\nvec3 forward = cross(up, right);\nvec2 profileVertex = profileVertexAndNormal.xy * size;\nvec2 profileNormal = profileVertexAndNormal.zw;\nfloat positionOffsetAlongProfilePlaneNormal = 0.0;\nfloat normalOffsetAlongProfilePlaneNormal = 0.0;"])))),se.code.add((0,he.H)(te||(te=(0,ne.A)(["if(!isCapVertex()) {\nvec2 rotationRight = vec2(profileRight.w, profileUp.w);\nfloat maxDistance = length(rotationRight);"])))),se.code.add((0,he.H)(ie||(ie=(0,ne.A)(["rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);\nfloat rx = dot(profileVertex, rotationRight);\nif (abs(rx) > maxDistance) {\nvec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);\nfloat ry = dot(profileVertex, rotationUp);\nprofileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;\n}\n}else{\npositionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];\nnormalOffsetAlongProfilePlaneNormal = profileUp.w;\n}\nvec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;\nreturn origin + offset;\n}"])))),se.code.add((0,he.H)(re||(re=(0,ne.A)(["vec3 localNormal() {\nvec3 right = profileRight.xyz;\nvec3 up = profileUp.xyz;\nvec3 forward = cross(up, right);\nvec2 profileNormal = profileVertexAndNormal.zw;\nvec3 normal = right * profileNormal.x + up * profileNormal.y;\nif(isCapVertex()) {\nnormal += forward * profileUp.w;\n}\nreturn normal;\n}"]))))}class n extends pe.S{constructor(){super(...arguments),this.size=(0,se.fA)(1,1)}}},76406:(R,G,H)=>{H.d(G,{s:()=>c});var W,q,Q,J,X,$,K=H(57528),ee=H(89651),te=H(20373),ie=H(3878),re=H(89013),ne=H(96767),se=H(64286);const ae=8;function c(R,G){const H=R.vertex;H.uniforms.add(new ie.m("intrinsicWidth",(R=>R.width))),G.vvSize?(R.attributes.add(se.r.SIZEFEATUREATTRIBUTE,"float"),H.uniforms.add(new te.t("vvSizeMinSize",(R=>R.vvSize.minSize)),new te.t("vvSizeMaxSize",(R=>R.vvSize.maxSize)),new te.t("vvSizeOffset",(R=>R.vvSize.offset)),new te.t("vvSizeFactor",(R=>R.vvSize.factor))),H.code.add((0,ne.H)(W||(W=(0,K.A)(["float getSize() {\nreturn intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;\n}"]))))):(R.attributes.add(se.r.SIZE,"float"),H.code.add((0,ne.H)(q||(q=(0,K.A)(["float getSize(){\nreturn intrinsicWidth * size;\n}"]))))),G.vvOpacity?(R.attributes.add(se.r.OPACITYFEATUREATTRIBUTE,"float"),H.constants.add("vvOpacityNumber","int",8),H.uniforms.add(new re.x("vvOpacityValues",(R=>R.vvOpacity.values),ae),new re.x("vvOpacityOpacities",(R=>R.vvOpacity.opacityValues),ae)),H.code.add((0,ne.H)(Q||(Q=(0,K.A)(["float interpolateOpacity( float value ){\nif (value <= vvOpacityValues[0]) {\nreturn vvOpacityOpacities[0];\n}\nfor (int i = 1; i < vvOpacityNumber; ++i) {\nif (vvOpacityValues[i] >= value) {\nfloat f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\nreturn mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);\n}\n}\nreturn vvOpacityOpacities[vvOpacityNumber - 1];\n}\nvec4 applyOpacity( vec4 color ){\nreturn vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));\n}"]))))):H.code.add((0,ne.H)(J||(J=(0,K.A)(["vec4 applyOpacity( vec4 color ){\nreturn color;\n}"])))),G.vvColor?(R.include(ee.A,G),R.attributes.add(se.r.COLORFEATUREATTRIBUTE,"float"),H.code.add((0,ne.H)(X||(X=(0,K.A)(["vec4 getColor(){\nreturn applyOpacity(interpolateVVColor(colorFeatureAttribute));\n}"]))))):(R.attributes.add(se.r.COLOR,"vec4"),H.code.add((0,ne.H)($||($=(0,K.A)(["vec4 getColor(){\nreturn applyOpacity(color);\n}"])))))}},76504:(R,G,H)=>{H.d(G,{K:()=>o});var W,q,Q=H(57528),J=H(96416),X=H(96767);function o(R){R.uniforms.add(new J.e("alignPixelEnabled",((R,G)=>G.alignPixelEnabled))),R.code.add((0,X.H)(W||(W=(0,Q.A)(["vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {\nif (!alignPixelEnabled)\nreturn clipCoord;\nvec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"])))),R.code.add((0,X.H)(q||(q=(0,Q.A)(["vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {\nif (!alignPixelEnabled)\nreturn clipCoord;\nvec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;\nvec2 pixelSz = vec2(1.0) / widthHeight;\nvec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;\nvec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;\nreturn vec4(result, clipCoord.zw);\n}"]))))}},45526:(R,G,H)=>{H.d(G,{Q:()=>d,R:()=>le});var W,q,Q,J,X,$,K,ee=H(57528),te=H(10386),ie=H(85729),re=H(38013),ne=H(50390),se=H(3878),ae=H(96767),oe=H(64286);const le=.5;function d(R,G){R.include(ie.Y6),R.attributes.add(oe.r.POSITION,"vec3"),R.attributes.add(oe.r.NORMAL,"vec3"),R.attributes.add(oe.r.CENTEROFFSETANDDISTANCE,"vec4");const H=R.vertex;(0,re.NB)(H,G),(0,re.yu)(H,G),H.uniforms.add(new ne.E("viewport",((R,G)=>G.camera.fullViewport)),new se.m("polygonOffset",(R=>R.shaderPolygonOffset)),new se.m("cameraGroundRelative",((R,G)=>G.camera.aboveGround?1:-1))),G.hasVerticalOffset&&(0,te.V)(H),H.constants.add("smallOffsetAngle","float",.984807753012208),H.code.add((0,ae.H)(W||(W=(0,ee.A)(["struct ProjectHUDAux {\nvec3 posModel;\nvec3 posView;\nvec3 vnormal;\nfloat distanceToCamera;\nfloat absCosAngle;\n};"])))),H.code.add((0,ae.H)(q||(q=(0,ee.A)(["\n    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {\n      float pointGroundSign = ",";\n      if (pointGroundSign == 0.0) {\n        pointGroundSign = cameraGroundRelative;\n      }\n\n      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground\n      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise\n      float groundRelative = cameraGroundRelative * pointGroundSign;\n\n      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is\n      // dropped is instead introduced using the ground-relative position of the symbol and the camera\n      if (polygonOffset > .0) {\n        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);\n        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;\n        float factor = (1.0 - tanAlpha / viewport[2]);\n\n        // same side of the terrain\n        if (groundRelative > 0.0) {\n          posView *= factor;\n        }\n        // opposite sides of the terrain\n        else {\n          posView /= factor;\n        }\n      }\n\n      return groundRelative;\n    }\n  "])),G.multipassEnabled?ae.H.float(0):(0,ae.H)(Q||(Q=(0,ee.A)(["sign(pointGroundDistance)"]))))),G.draped&&!G.hasVerticalOffset||(0,re.S7)(H),G.draped||(H.uniforms.add(new se.m("perDistancePixelRatio",((R,G)=>Math.tan(G.camera.fovY/2)/(G.camera.fullViewport[2]/2)))),H.code.add((0,ae.H)(J||(J=(0,ee.A)(["\n    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {\n      float distanceToCamera = length(posView);\n\n      // Compute offset in world units for a half pixel shift\n      float pixelOffset = distanceToCamera * perDistancePixelRatio * ",";\n\n      // Apply offset along normal in the direction away from the ground surface\n      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;\n\n      // Apply the same offset also on the view space position\n      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n\n      posModel += modelOffset;\n      posView += viewOffset;\n    }\n  "])),ae.H.float(le)))),G.screenCenterOffsetUnitsEnabled&&(0,re.Nz)(H),G.hasScreenSizePerspective&&(0,ie.OH)(H),H.code.add((0,ae.H)(X||(X=(0,ee.A)(["\n    vec4 projectPositionHUD(out ProjectHUDAux aux) {\n      vec3 centerOffset = centerOffsetAndDistance.xyz;\n      float pointGroundDistance = centerOffsetAndDistance.w;\n\n      aux.posModel = position;\n      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;\n      aux.vnormal = normal;\n      ","\n\n      // Screen sized offset in world space, used for example for line callouts\n      // Note: keep this implementation in sync with the CPU implementation, see\n      //   - MaterialUtil.verticalOffsetAtDistance\n      //   - HUDMaterial.applyVerticalOffsetTransformation\n\n      aux.distanceToCamera = length(aux.posView);\n\n      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);\n      float cosAngle = dot(aux.vnormal, viewDirObjSpace);\n\n      aux.absCosAngle = abs(cosAngle);\n\n      ","\n\n      ","\n\n      ","\n\n      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);\n\n      ","\n\n      vec4 posProj = proj * vec4(aux.posView, 1.0);\n\n      ","\n\n      ","\n\n      // constant part of polygon offset emulation\n      posProj.z -= groundRelative * polygonOffset * posProj.w;\n      return posProj;\n    }\n  "])),G.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);",G.hasScreenSizePerspective&&(G.hasVerticalOffset||G.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":"",G.hasVerticalOffset?G.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":"",G.hasVerticalOffset?(0,ae.H)($||($=(0,ee.A)(["\n            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);\n            vec3 modelOffset = aux.vnormal * worldOffset;\n            aux.posModel += modelOffset;\n            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;\n            aux.posView += viewOffset;\n            // Since we elevate the object, we need to take that into account\n            // in the distance to ground\n            pointGroundDistance += worldOffset;"]))):"",G.screenCenterOffsetUnitsEnabled?"":(0,ae.H)(K||(K=(0,ee.A)(["\n            // Apply x/y in view space, but z in screen space (i.e. along posView direction)\n            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);\n\n            // Same material all have same z != 0.0 condition so should not lead to\n            // branch fragmentation and will save a normalization if it's not needed\n            if (centerOffset.z != 0.0) {\n              aux.posView -= normalize(aux.posView) * centerOffset.z;\n            }\n          "]))),G.screenCenterOffsetUnitsEnabled?G.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":"",G.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""))}},85568:(R,G,H)=>{H.d(G,{I:()=>i});var W,q,Q,J,X=H(57528),$=H(76504),K=H(17372),ee=H(82993),te=H(96767);function i(R,G){const{vertex:H,fragment:ie}=R;H.include($.K),G.multipassEnabled&&(H.include(K.H),R.varyings.add("depth","float")),H.code.add((0,te.H)(W||(W=(0,X.A)(["\n  void main(void) {\n    vec4 posProjCenter;\n    if (dot(position, position) > 0.0) {\n      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color\n      ProjectHUDAux projectAux;\n      vec4 posProj = projectPositionHUD(projectAux);\n      posProjCenter = alignToPixelCenter(posProj, viewport.zw);\n\n      ","\n\n      ","\n      vec3 vpos = projectAux.posModel;\n      if (rejectBySlice(vpos)) {\n        // Project out of clip space\n        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n      }\n\n    } else {\n      // Project out of clip space\n      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n\n    gl_Position = posProjCenter;\n    gl_PointSize = 1.0;\n  }\n  "])),G.multipassEnabled?(0,te.H)(q||(q=(0,X.A)(["\n        // Don't draw vertices behind geometry\n        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){\n          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);\n        }"]))):"",G.multipassEnabled?"depth = projectAux.posView.z;":"")),R.include(ee.Q,G),ie.code.add((0,te.H)(Q||(Q=(0,X.A)(["\n  void main() {\n    fragColor = vec4(1);\n    ","\n  }\n  "])),G.multipassEnabled?(0,te.H)(J||(J=(0,X.A)(["\n        if(terrainDepthTest(depth)) {\n          fragColor.g = 0.5;\n        }"]))):""))}},95249:(R,G,H)=>{var W;H.d(G,{D:()=>W}),function(R){R[R.Occluded=0]="Occluded",R[R.NotOccluded=1]="NotOccluded",R[R.Both=2]="Both",R[R.COUNT=3]="COUNT"}(W||(W={}))},55454:(R,G,H)=>{H.d(G,{y:()=>t});var W,q=H(57528),Q=H(76504),J=H(95249),X=H(50390),$=H(3878),K=H(96767),ee=H(34343);function t(R){R.vertex.uniforms.add(new $.m("renderTransparentlyOccludedHUD",((R,G)=>G.hudRenderStyle===J.D.Occluded?1:G.hudRenderStyle===J.D.NotOccluded?0:.75)),new X.E("viewport",((R,G)=>G.camera.fullViewport)),new ee.N("hudVisibilityTexture",((R,G)=>{var H;return null===(H=G.hudVisibility)||void 0===H?void 0:H.getTexture()}))),R.vertex.include(Q.K),R.vertex.code.add((0,K.H)(W||(W=(0,q.A)(["bool testHUDVisibility(vec4 posProj) {\nvec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);\nvec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);\nif (renderTransparentlyOccludedHUD > 0.5) {\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;\n}\nreturn occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;\n}"]))))}},63605:(R,G,H)=>{H.d(G,{v:()=>n,z:()=>o});var W,q,Q=H(57528),J=H(96767);function o(R){R.fragment.code.add((0,J.H)(W||(W=(0,Q.A)(["float normals2FoamIntensity(vec3 n, float waveStrength){\nfloat normalizationFactor =  max(0.015, waveStrength);\nreturn max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n}"]))))}function n(R){R.fragment.code.add((0,J.H)(q||(q=(0,Q.A)(["vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\nreturn foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n}"]))))}},2385:(R,G,H)=>{H.d(G,{q:()=>d,h:()=>S});var W=H(57528),q=H(39313),Q=H(38013),J=H(50390),X=H(3878),$=H(96767),K=H(34343);H(31714),H(60985),H(83663),H(83881);function c(R){return R.pattern.map((G=>Math.round(G*R.pixelRatio)))}function f(R){if(null==R)return 1;const G=c(R);return Math.floor(G.reduce(((R,G)=>R+G)))}function s(R){return c(R).reduce(((R,G)=>Math.max(R,G)))}var ee=H(14223),te=H(40727);const ie=(0,te.vt)();var re,ne,se,ae,oe,le,ce,de,he;function d(R,G){R.constants.add("stippleAlphaColorDiscard","float",.001),R.constants.add("stippleAlphaHighlightDiscard","float",.5),G.stippleEnabled?function LineStipple_glsl_c(R,G){const H=!(G.draped&&G.stipplePreferContinuous),{vertex:he,fragment:pe}=R;pe.include(q.W),G.draped||((0,Q.yu)(he,G),he.uniforms.add(new X.m("worldToScreenPerDistanceRatio",((R,G)=>1/G.camera.perScreenPixelRatio))),he.code.add((0,$.H)(re||(re=(0,W.A)(["float computeWorldToScreenRatio(vec3 segmentCenter) {\nfloat segmentDistanceToCamera = length(segmentCenter - cameraPosition);\nreturn worldToScreenPerDistanceRatio / segmentDistanceToCamera;\n}"]))))),R.varyings.add("vStippleDistance","float"),R.varyings.add("vStippleDistanceLimits","vec2"),R.varyings.add("vStipplePatternStretch","float"),he.code.add((0,$.H)(ne||(ne=(0,W.A)(["\n    float discretizeWorldToScreenRatio(float worldToScreenRatio) {\n      float step = ",";\n\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n      return discreteWorldToScreenRatio;\n    }\n  "])),ue)),he.code.add((0,$.H)(se||(se=(0,W.A)(["vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {"])))),he.code.add((0,$.H)(ae||(ae=(0,W.A)(["\n    if (segmentLengthPseudoScreen >= ",") {\n  "])),H?"patternLength":"1e4")),(0,Q.Nz)(he),he.code.add((0,$.H)(oe||(oe=(0,W.A)(["float repetitions = segmentLengthScreen / (patternLength * pixelRatio);\nfloat flooredRepetitions = max(1.0, floor(repetitions + 0.5));\nfloat segmentLengthScreenRounded = flooredRepetitions * patternLength;\nfloat stretch = repetitions / flooredRepetitions;\nvStipplePatternStretch = max(0.75, stretch);\nreturn vec2(0.0, segmentLengthScreenRounded);\n}\nreturn vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);\n}"])))),pe.uniforms.add(new K.N("stipplePatternTexture",(R=>R.stippleTexture)),new X.m("stipplePatternSDFNormalizer",(R=>function m(R){return R?(Math.floor(.5*(s(R)-1))+.5)/R.pixelRatio:1}(R.stipplePattern))),new X.m("stipplePatternPixelSizeInv",(R=>1/S(R)))),pe.code.add((0,$.H)(le||(le=(0,W.A)(["float getStippleSDF(out bool isClamped) {\nfloat stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);\nvec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;\nisClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;\nfloat u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;\nu = fract(u);\nfloat encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));\nfloat sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;\nreturn (sdf - 0.5) * vStipplePatternStretch + 0.5;\n}\nfloat getStippleSDF() {\nbool ignored;\nreturn getStippleSDF(ignored);\n}\nfloat getStippleAlpha() {\nbool isClamped;\nfloat stippleSDF = getStippleSDF(isClamped);\nfloat antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);\nreturn isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;\n}"])))),G.stippleOffColorEnabled?(pe.uniforms.add(new J.E("stippleOffColor",(R=>function ensureColor4_s(R){return null==R?te.uY:4===R.length?R:(0,ee.s)(ie,R[0],R[1],R[2],1)}(R.stippleOffColor)))),pe.code.add((0,$.H)(ce||(ce=(0,W.A)(["#define discardByStippleAlpha(stippleAlpha, threshold) {}\n#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)"]))))):pe.code.add((0,$.H)(de||(de=(0,W.A)(["#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }\n#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)"]))))}(R,G):function LineStipple_glsl_f(R){R.fragment.code.add((0,$.H)(he||(he=(0,W.A)(["float getStippleAlpha() { return 1.0; }\n#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}\n#define blendStipple(color, _stippleAlpha_) color"]))))}(R)}function S(R){const G=R.stipplePattern;return G?f(R.stipplePattern)/G.pixelRatio:1}const ue=$.H.float(.4)},96218:(R,G,H)=>{H.d(G,{r:()=>n});var W,q,Q=H(57528),J=H(35211),X=H(38013),$=H(3878),K=H(96767),ee=H(5157);function n(R,G){const{vertex:H,constants:te}=R;te.add("markerSizePerLineWidth","float",J.PV),(0,X.Nz)(H),null==H.uniforms.get("markerScale")&&H.constants.add("markerScale","float",1),H.code.add((0,K.H)(W||(W=(0,Q.A)(["float getLineWidth() {\nreturn max(getSize(), 1.0) * pixelRatio;\n}\nfloat getScreenMarkerSize() {\nreturn markerSizePerLineWidth * markerScale * getLineWidth();\n}"])))),G.space===ee.lM.World&&(H.constants.add("maxSegmentLengthFraction","float",.45),H.uniforms.add(new $.m("perRenderPixelRatio",((R,G)=>G.camera.perRenderPixelRatio))),H.code.add((0,K.H)(q||(q=(0,Q.A)(["bool areWorldMarkersHidden(vec4 pos, vec4 other) {\nvec3 midPoint = mix(pos.xyz, other.xyz, 0.5);\nfloat distanceToCamera = length(midPoint);\nfloat screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;\nfloat worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;\nfloat segmentLen = length(pos.xyz - other.xyz);\nreturn worldMarkerSize > maxSegmentLengthFraction * segmentLen;\n}\nfloat getWorldMarkerSize(vec4 pos) {\nfloat distanceToCamera = length(pos.xyz);\nfloat screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;\nreturn getScreenMarkerSize() * screenToWorldRatio;\n}"])))))}},17372:(R,G,H)=>{H.d(G,{H:()=>a,U:()=>s});var W,q=H(57528),Q=H(83370),J=H(69460),X=H(96767),$=H(34343);function a(R){R.include(Q.D),R.uniforms.add(new $.N("geometryDepthTexture",((R,G)=>{var H;return null===(H=G.multipassGeometry.linearDepth)||void 0===H?void 0:H.getTexture()})),new J.G("nearFar",((R,G)=>G.camera.nearFar))),R.code.add((0,X.H)(W||(W=(0,q.A)(["bool geometryDepthTest(vec2 pos, float elementDepth) {\nfloat geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);\nreturn (elementDepth < (geometryDepth - 1.0));\n}"]))))}class s{}},10748:(R,G,H)=>{H.d(G,{n:()=>r});var W,q,Q,J,X=H(57528),$=H(96767);function r(R,G){G.spherical?R.vertex.code.add((0,$.H)(W||(W=(0,X.A)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn normalize(pos + origin);\n}"])))):R.vertex.code.add((0,$.H)(q||(q=(0,X.A)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),G.spherical?R.vertex.code.add((0,$.H)(Q||(Q=(0,X.A)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"])))):R.vertex.code.add((0,$.H)(J||(J=(0,X.A)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = vec3(1.0, 0.0, 0.0);\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"]))))}},7536:(R,G,H)=>{H.d(G,{E:()=>f});var W,q=H(57528),Q=H(63605),J=H(96767);function e(R){R.fragment.code.add((0,J.H)(W||(W=(0,q.A)(["const float GAMMA = 2.2;\nconst float INV_GAMMA = 0.4545454545;\nvec4 delinearizeGamma(vec4 color) {\nreturn vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n}\nvec3 linearizeGamma(vec3 color) {\nreturn pow(color, vec3(GAMMA));\n}"]))))}var X,$=H(99253),K=H(83833),ee=H(83370),te=H(69460),ie=H(3878),re=H(51305),ne=H(34343);function d(R,G){const H=R.fragment;H.include(ee.D),H.uniforms.add(new te.G("nearFar",((R,G)=>G.camera.nearFar))),H.uniforms.add(new ne.N("depthMap",((R,G)=>{var H;return null===(H=G.linearDepth)||void 0===H?void 0:H.getTexture()}))),H.uniforms.add(new re.X("proj",((R,G)=>G.camera.projectionMatrix))),H.uniforms.add(new ie.m("invResolutionHeight",((R,G)=>1/G.camera.height))),H.uniforms.add(new re.X("reprojectionMatrix",((R,G)=>G.ssr.reprojectionMatrix))),H.code.add((0,J.H)(X||(X=(0,q.A)(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy * 0.5 + 0.5;\n  }\n\n  const int maxSteps = ",";\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n        return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P = clamp(P + dP, vec2(0.0), vec2(0.999));\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),G.highStepCount?"150":"75"))}var se,ae,oe,le,ce,de,he,ue,pe,_e,me,ge,fe,ye,ve,be,xe=H(48237),Se=H(39572),Ce=H(74769),we=H(41201),Ae=H(91400),Re=H(21181),Te=H(96416),Ee=H(20373),Oe=H(91839),Pe=H(45981);class s extends Oe.n{constructor(R,G){super(R,"samplerCube",Pe.c.Pass,((H,W,q)=>H.bindTexture(R,G(W,q))))}}function CloudsParallaxShading_glsl_v(R){const G=R.fragment;G.uniforms.add(new re.X("rotationMatrixClouds",((R,G)=>G.cloudsFade.parallax.transform)),new re.X("rotationMatrixCloudsCrossFade",((R,G)=>G.cloudsFade.parallaxNew.transform)),new Ee.t("anchorPosition",((R,G)=>G.cloudsFade.parallax.anchorPointClouds)),new Ee.t("anchorPositionCrossFade",((R,G)=>G.cloudsFade.parallaxNew.anchorPointClouds)),new ie.m("cloudsHeight",(()=>Ae.k9)),new ie.m("radiusCurvatureCorrectionFactor",((R,G)=>G.cloudsFade.parallax.radiusCurvatureCorrectionFactor)),new ie.m("totalFadeInOut",((R,G)=>1-G.cloudsFade.opacity)),new ie.m("crossFadeAnchorFactor",((R,G)=>(0,xe.qE)(G.cloudsFade.fadeFactor,0,1))),new s("cubeMap",((R,G)=>{var H,W;return null!==(H=null===(W=G.cloudsFade.data)||void 0===W||null===(W=W.cubeMap)||void 0===W?void 0:W.colorTexture)&&void 0!==H?H:null})),new Te.e("crossFade",((R,G)=>G.cloudsFade.fadeMode===we.OQ.CROSS_FADE)),new Te.e("readChannelsRG",((R,G)=>G.cloudsFade.readChannels===Ce.c.RG)),new Te.e("fadeTextureChannels",((R,G)=>G.cloudsFade.renderingStage===Ce.c2.FADING))),G.constants.add("planetRadius","float",Se.$O.radius),G.code.add((0,J.H)(se||(se=(0,q.A)(["vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)\n{\nfloat radiusClouds = planetRadius + cloudsHeight;\nfloat B = 2.0 * dot(cameraPosition, dir);\nfloat C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;\nfloat det = B * B - 4.0 * C;\nfloat pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));\nvec3 intersectionPont = cameraPosition + dir * pointIntDist;\nintersectionPont =  intersectionPont - spherePos;\nreturn intersectionPont;\n}"])))),G.code.add((0,J.H)(ae||(ae=(0,q.A)(["vec3 correctForPlanetCurvature(vec3 dir)\n{\ndir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;\nreturn dir;\n}"])))),G.code.add((0,J.H)(oe||(oe=(0,q.A)(["vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)\n{\nreturn (rotMat * vec4(inVec, 0.0)).xyz;\n}"])))),(0,Re.Gc)(G),(0,Re.O4)(G),G.code.add((0,J.H)(le||(le=(0,q.A)(["const float SUNSET_TRANSITION_FACTOR = 0.3;\nconst vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);\nconst float RIM_SCATTERING_FACTOR = 140.0;\nconst float BACKLIGHT_FACTOR = 0.2;\nconst float BACKLIGHT_SCATTERING_FACTOR = 10.0;\nconst float BACKLIGHT_TRANSITION_FACTOR = 0.3;\nvec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)\n{\nfloat upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));\nfloat dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);\nfloat sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);\nvec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);\nvec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);\nvec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));\nvec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));\nfloat scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);\nfloat rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);\nvec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;\nfloat additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;\nreturn vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);\n}"])))),G.code.add((0,J.H)(ce||(ce=(0,q.A)(["vec4 getCloudData(vec3 rayDir, bool readOtherChannel)\n{\nvec4 cloudData = texture(cubeMap, rayDir);\nfloat mu = dot(rayDir, vec3(0, 0, 1));\nbool readChannels = readChannelsRG ^^ readOtherChannel;\nif (readChannels) {\ncloudData = vec4(vec3(cloudData.r), cloudData.g);\n} else {\ncloudData = vec4(vec3(cloudData.b), cloudData.a);\n}\nif (length(cloudData) == 0.0) {\nreturn vec4(cloudData.rgb, 1.0);\n}\nreturn cloudData;\n}"])))),G.code.add((0,J.H)(de||(de=(0,q.A)(["vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected, false);\nfloat totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudData.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);\n}"])))),G.code.add((0,J.H)(he||(he=(0,q.A)(["vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)\n{\nvec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = getCloudData(worldRayRotatedCorrected, false);\nvec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\nintersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);\nworldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));\nworldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\ncloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);\nvec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);\ncloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);\nfloat totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);\nif (length(cloudColor.rgb) == 0.0) {\ntotalTransmittance = 1.0;\n}\nreturn vec4(cloudColor.rgb, totalTransmittance);\n}"])))),G.code.add((0,J.H)(ue||(ue=(0,q.A)(["vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)\n{\nreturn crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);\n}"]))))}function f(R,G){R.include($.f,G),R.include(e),R.include(Q.v),G.hasCloudsReflections&&R.include(CloudsParallaxShading_glsl_v,G),G.hasScreenSpaceReflections&&R.include(d,G);const H=R.fragment;H.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",K.O).add("ssrHeightFadeEnd","float",K.b).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),H.code.add((0,J.H)(pe||(pe=(0,q.A)(["PBRShadingWater shadingInfo;\nvec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\nfloat exponent = pow((1.0 - cosTheta), fresnelSky[2]);\nreturn mix(zenit, horizon, exponent);\n}"])))),H.uniforms.add(new ie.m("lightingSpecularStrength",((R,G)=>G.lighting.mainLight.specularStrength)),new ie.m("lightingEnvironmentStrength",((R,G)=>G.lighting.mainLight.environmentStrength))),H.code.add((0,J.H)(_e||(_e=(0,q.A)(["vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {\nfloat reflectionHit = 0.0;\nfloat reflectionHitDiffused = 0.0;\nvec3 seaWaterColor = linearizeGamma(color);\nvec3 h = normalize(l + v);\nshadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\nshadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\nshadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\nshadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\nshadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\nshadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\nfloat upDotV = max(dot(localUp,v), 0.0);\nvec3 skyHorizon = linearizeGamma(skyColor);\nvec3 skyZenit = linearizeGamma(skyZenitColor);\nvec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\nfloat upDotL = max(dot(localUp,l),0.0);\nfloat daytimeMod = 0.1 + upDotL * 0.9;\nskyColor *= daytimeMod;\nfloat shadowModifier = clamp(shadow, 0.8, 1.0);\nvec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\nvec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;\nvec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\nvec3 specular = vec3(0.0);\nif(upDotV > 0.0 && upDotL > 0.0) {\nvec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\nvec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\nspecular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;\n}\nvec3 foam = vec3(0.0);\nif(upDotV > 0.0) {\nfoam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n}\nfloat correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);\nvec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);\nvec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));"])))),G.hasCloudsReflections&&H.code.add((0,J.H)(me||(me=(0,q.A)(["vec4 cloudsColor = renderClouds(reflectedWorld, position);\ncloudsColor.a = 1.0 - cloudsColor.a;\ncloudsColor = pow(cloudsColor, vec4(GAMMA));\ncloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);"])))),G.hasScreenSpaceReflections?(H.uniforms.add(new re.X("view",((R,G)=>G.camera.viewMatrix)),new ne.N("lastFrameColorTexture",((R,G)=>{var H;return null===(H=G.ssr.lastFrameColor)||void 0===H?void 0:H.getTexture()})),new ie.m("fadeFactorSSR",((R,G)=>G.ssr.fadeFactor))),H.code.add((0,J.H)(ge||(ge=(0,q.A)(["vec3 viewDir = normalize(viewPosition);\nvec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);\nvec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\nvec4 viewUp = view * vec4(localUp, 0.0);\nvec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\nvec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));\nvec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);\nvec3 reflectedColor = vec3(0.0);\nif (hitCoordinate.z > 0.0)\n{\nvec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\nvec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\nfloat heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);\nreflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;\nreflectionHitDiffused = waterDiffusion * reflectionHit;\nreflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *\nreflectionHitDiffused * fresnelModifier.y * ssrIntensity;\n}\nfloat seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);\nvec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +\nreflSea * seaColorMod + specular + foam);"]))))):H.code.add((0,J.H)(fe||(fe=(0,q.A)(["vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);"])))),G.hasCloudsReflections?G.hasScreenSpaceReflections?H.code.add((0,J.H)(ye||(ye=(0,q.A)(["return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;\n}"])))):H.code.add((0,J.H)(ve||(ve=(0,q.A)(["return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;\n}"])))):H.code.add((0,J.H)(be||(be=(0,q.A)(["return waterRenderedColor;\n}"]))))}},53948:(R,G,H)=>{H.d(G,{V:()=>u});var W,q=H(57528),Q=H(37131),J=H(52273),X=H(14223),$=H(40727),K=H(63605),ee=(H(39202),H(69460)),te=H(50390),ie=H(96767),re=H(34343);function u(R){R.fragment.uniforms.add(new re.N("texWaveNormal",(R=>R.waveNormal)),new re.N("texWavePerturbation",(R=>R.wavePerturbation)),new te.E("waveParams",(R=>(0,X.s)(ne,R.waveStrength,R.waveTextureRepeat,R.flowStrength,R.flowOffset))),new ee.G("waveDirection",(R=>(0,Q.hZ)(se,R.waveDirection[0]*R.waveVelocity,R.waveDirection[1]*R.waveVelocity)))),R.include(K.z),R.fragment.code.add((0,ie.H)(W||(W=(0,q.A)(["const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\nvec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture(_tex, _uv).rg - 1.0;\n}\nfloat sampleNoiseTexture(vec2 _uv) {\nreturn texture(texWavePerturbation, _uv).b;\n}\nvec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture(_tex, _uv).rgb - 1.0;\n}\nfloat computeProgress(vec2 uv, float time) {\nreturn fract(time);\n}\nfloat computeWeight(vec2 uv, float time) {\nfloat progress = computeProgress(uv, time);\nreturn 1.0 - abs(1.0 - 2.0 * progress);\n}\nvec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\nfloat flowStrength = waveParams[2];\nfloat flowOffset = waveParams[3];\nvec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\nfloat progress = computeProgress(uv, time + phaseOffset);\nfloat weight = computeWeight(uv, time + phaseOffset);\nvec2 result = uv;\nresult -= flowVector * (progress + flowOffset);\nresult += phaseOffset;\nresult += (time - progress) * FLOW_JUMP;\nreturn vec3(result, weight);\n}\nconst float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\nconst float TIME_NOISE_STRENGTH = 7.77;\nvec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\nfloat waveStrength = waveParams[0];\nvec2 waveMovement = time * -_waveDir;\nfloat timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\nvec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\nvec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\nvec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\nvec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\nvec3 mixNormal = normalize(normal_A + normal_B);\nmixNormal.xy *= waveStrength;\nmixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\nreturn mixNormal;\n}\nvec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\nfloat waveTextureRepeat = waveParams[1];\nvec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\nfloat foam  = normals2FoamIntensity(normal, waveParams[0]);\nreturn vec4(normal, foam);\n}"]))))}const ne=(0,$.vt)(),se=(0,J.vt)()},78368:(R,G,H)=>{H.d(G,{aT:()=>s,fA:()=>e});var W=H(48237);H(54880),H(83800),H(85922);function s(R,G,H,W,q){let Q=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2;const J=1/(Math.abs(H)+Math.abs(W)+Math.abs(q)),X=H*J,$=W*J,K=q<=0?(X>=0?1:-1)*(1-Math.abs($)):X,ee=q<=0?($>=0?1:-1)*(1-Math.abs(X)):$,te=G*Q;R[te]=i(K),R[te+1]=i(ee)}function e(R){const G=R.length/3,H=new Int16Array(2*G);let W=0;for(let q=0;q<G;++q)s(H,q,R[W++],R[W++],R[W++]);return H}function i(R){return(0,W.qE)(Math.round(32767*R),-32767,32767)}},19154:(R,G,H)=>{var W;H.d(G,{O:()=>W}),function(R){R[R.Horizontal=0]="Horizontal",R[R.Vertical=1]="Vertical",R[R.Cross=2]="Cross",R[R.ForwardDiagonal=3]="ForwardDiagonal",R[R.BackwardDiagonal=4]="BackwardDiagonal",R[R.DiagonalCross=5]="DiagonalCross",R[R.COUNT=6]="COUNT"}(W||(W={}))},5157:(R,G,H)=>{H.d(G,{Dt:()=>a,kJ:()=>q,lM:()=>W});var W,q,Q=H(80671),J=H(32573),X=H(88335),$=H(62301),K=H(96952);!function(R){R[R.Draped=0]="Draped",R[R.Screen=1]="Screen",R[R.World=2]="World",R[R.COUNT=3]="COUNT"}(W||(W={})),function(R){R[R.Center=0]="Center",R[R.Tip=1]="Tip",R[R.COUNT=2]="COUNT"}(q||(q={}));class a extends K.E{constructor(){super(...arguments),this.output=J.V.Color,this.transparencyPassType=$.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=W.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=q.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===W.Draped}}(0,Q._)([(0,X.W)({count:J.V.COUNT})],a.prototype,"output",void 0),(0,Q._)([(0,X.W)({count:$.y.COUNT})],a.prototype,"transparencyPassType",void 0),(0,Q._)([(0,X.W)()],a.prototype,"occluder",void 0),(0,Q._)([(0,X.W)()],a.prototype,"hasSlicePlane",void 0),(0,Q._)([(0,X.W)()],a.prototype,"writeDepth",void 0),(0,Q._)([(0,X.W)({count:W.COUNT})],a.prototype,"space",void 0),(0,Q._)([(0,X.W)()],a.prototype,"hideOnShortSegments",void 0),(0,Q._)([(0,X.W)()],a.prototype,"hasCap",void 0),(0,Q._)([(0,X.W)({count:q.COUNT})],a.prototype,"anchor",void 0),(0,Q._)([(0,X.W)()],a.prototype,"hasTip",void 0),(0,Q._)([(0,X.W)()],a.prototype,"vvSize",void 0),(0,Q._)([(0,X.W)()],a.prototype,"vvColor",void 0),(0,Q._)([(0,X.W)()],a.prototype,"vvOpacity",void 0),(0,Q._)([(0,X.W)()],a.prototype,"hasOccludees",void 0),(0,Q._)([(0,X.W)()],a.prototype,"multipassEnabled",void 0),(0,Q._)([(0,X.W)()],a.prototype,"cullAboveGround",void 0),(0,Q._)([(0,X.W)({constValue:!1})],a.prototype,"occlusionPass",void 0),(0,Q._)([(0,X.W)({constValue:!0})],a.prototype,"hasVvInstancing",void 0),(0,Q._)([(0,X.W)({constValue:!0})],a.prototype,"hasSliceTranslatedView",void 0)},82363:(R,G,H)=>{H.d(G,{Q:()=>s,x:()=>W});var W,q=H(80671),Q=H(32573),J=H(88335),X=H(62301),$=H(96952);!function(R){R[R.BUTT=0]="BUTT",R[R.SQUARE=1]="SQUARE",R[R.ROUND=2]="ROUND",R[R.COUNT=3]="COUNT"}(W||(W={}));class s extends $.E{constructor(){super(...arguments),this.output=Q.V.Color,this.capType=W.BUTT,this.transparencyPassType=X.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}}(0,q._)([(0,J.W)({count:Q.V.COUNT})],s.prototype,"output",void 0),(0,q._)([(0,J.W)({count:W.COUNT})],s.prototype,"capType",void 0),(0,q._)([(0,J.W)({count:X.y.COUNT})],s.prototype,"transparencyPassType",void 0),(0,q._)([(0,J.W)()],s.prototype,"occluder",void 0),(0,q._)([(0,J.W)()],s.prototype,"hasSlicePlane",void 0),(0,q._)([(0,J.W)()],s.prototype,"hasPolygonOffset",void 0),(0,q._)([(0,J.W)()],s.prototype,"writeDepth",void 0),(0,q._)([(0,J.W)()],s.prototype,"draped",void 0),(0,q._)([(0,J.W)()],s.prototype,"stippleEnabled",void 0),(0,q._)([(0,J.W)()],s.prototype,"stippleOffColorEnabled",void 0),(0,q._)([(0,J.W)()],s.prototype,"stipplePreferContinuous",void 0),(0,q._)([(0,J.W)()],s.prototype,"roundJoins",void 0),(0,q._)([(0,J.W)()],s.prototype,"applyMarkerOffset",void 0),(0,q._)([(0,J.W)()],s.prototype,"vvSize",void 0),(0,q._)([(0,J.W)()],s.prototype,"vvColor",void 0),(0,q._)([(0,J.W)()],s.prototype,"vvOpacity",void 0),(0,q._)([(0,J.W)()],s.prototype,"falloffEnabled",void 0),(0,q._)([(0,J.W)()],s.prototype,"innerColorEnabled",void 0),(0,q._)([(0,J.W)()],s.prototype,"hasOccludees",void 0),(0,q._)([(0,J.W)()],s.prototype,"multipassEnabled",void 0),(0,q._)([(0,J.W)()],s.prototype,"cullAboveGround",void 0),(0,q._)([(0,J.W)()],s.prototype,"wireframe",void 0),(0,q._)([(0,J.W)()],s.prototype,"objectAndLayerIdColorInstanced",void 0),(0,q._)([(0,J.W)({constValue:!1})],s.prototype,"occlusionPass",void 0),(0,q._)([(0,J.W)({constValue:!0})],s.prototype,"hasVvInstancing",void 0),(0,q._)([(0,J.W)({constValue:!0})],s.prototype,"hasSliceTranslatedView",void 0)},18715:(R,G,H)=>{function n(R){return R&&"function"==typeof R.highlight}function t(R,G,H){return null==R||R>H&&(0===G||R<G)}function u(R,G){return null!=R&&R>0||null!=G&&G>0}function c(R){var G,H;const W=R.effectiveScaleRange;return{minScale:null!==(G=null===W||void 0===W?void 0:W.minScale)&&void 0!==G?G:0,maxScale:null!==(H=null===W||void 0===W?void 0:W.maxScale)&&void 0!==H?H:0}}H.d(G,{Cf:()=>c,JU:()=>t,Of:()=>n,WK:()=>u})},77127:(R,G,H)=>{H.d(G,{Z:()=>$});var W=H(89412),q=H(35598),Q=H(49905),J=H(60985),X=H(76879);const n=()=>W.A.getLogger("esri.views.webgl.VertexArrayObject");let $=class{constructor(R,G,H,W){let q=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this._context=R,this._locations=G,this._layout=H,this._buffers=W,this._indexBuffer=q,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Object.keys(this._buffers).reduce(((R,G)=>R+this._buffers[G].usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*Q.zQ}dispose(){if(this._context){this._context.getBoundVAO()===this&&this._context.bindVAO(null);for(const G in this._buffers){var R;null!==(R=this._buffers[G])&&void 0!==R&&R.dispose(),delete this._buffers[G]}this._indexBuffer=(0,q.WD)(this._indexBuffer),this.disposeVAOOnly()}else(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&n().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(J.vt.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:R}=this._context,G=R.createVertexArray();R.bindVertexArray(G),this._bindLayout(),R.bindVertexArray(null),this._glName=G,this._context.instanceCounter.increment(J.vt.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:R,_layout:G,_indexBuffer:H}=this;R||n().error("Vertex buffer dictionary is empty!");const W=this._context.gl;for(const q in R){const H=R[q];H||n().error("Vertex buffer is uninitialized!");const W=G[q];W||n().error("Vertex element descriptor is empty!"),(0,X.yu)(this._context,this._locations,H,W)}null!=H&&W.bindBuffer(W.ELEMENT_ARRAY_BUFFER,H.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}}},40332:(R,G,H)=>{H.d(G,{_:()=>t});class t{constructor(R,G,H,W,q){let Q=arguments.length>5&&void 0!==arguments[5]&&arguments[5],J=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;this.name=R,this.count=G,this.type=H,this.offset=W,this.stride=q,this.normalized=Q,this.divisor=J}}},74011:(R,G,H)=>{H.d(G,{S:()=>n});var W=H(4180),q=H(60985);class l{constructor(R,G,H,W){this.dataType=R,this.samplingMode=G,this.pixelFormat=H,this.internalFormat=W}}function n(R,G){const{textureFloat:H,colorBufferFloat:Q}=R.capabilities,J=null===H||void 0===H?void 0:H.textureFloatLinear,X=null===Q||void 0===Q?void 0:Q.textureFloat,$=null===Q||void 0===Q?void 0:Q.textureHalfFloat,K=null===Q||void 0===Q?void 0:Q.floatBlend,ee=R.driverTest.floatBufferBlend.result;if(!X&&!$)throw new W.A("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(K&&ee||$))throw new W.A("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(ee?"":" This device claims support for EXT_float_blend, but does not actually support it."));const te=X&&K&&ee,ie=$,re=J,ne=!(null===Q||void 0===Q||!Q.R32F),se=!(null===Q||void 0===Q||!Q.R16F);if(te&&re)return re||G.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new l(q.ld.FLOAT,re?q.Cj.LINEAR:q.Cj.NEAREST,ne?q.Ab.RED:q.Ab.RGBA,ne?q.H0.R32F:q.Ab.RGBA);if(ie)return new l(q.ld.HALF_FLOAT,q.Cj.LINEAR,se?q.Ab.RED:q.Ab.RGBA,se?q.H0.R16F:q.Ab.RGBA);throw new W.A("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}}}]);
//# sourceMappingURL=2207.c6ccc3f4.chunk.js.map