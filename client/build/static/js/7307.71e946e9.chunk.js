"use strict";(self.webpackChunkSEEDs_v2_0_Client=self.webpackChunkSEEDs_v2_0_Client||[]).push([[7307],{13600:(i,n,a)=>{a.d(n,{A:()=>t});class t{constructor(i){this.size=0,this._start=0,this.maxSize=i,this._buffer=new Array(i)}get entries(){return this._buffer}enqueue(i){if(this.size===this.maxSize){const n=this._buffer[this._start];return this._buffer[this._start]=i,this._start=(this._start+1)%this.maxSize,n}return this._buffer[(this._start+this.size++)%this.maxSize]=i,null}dequeue(){if(0===this.size)return null;const i=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,i}peek(){return 0===this.size?null:this._buffer[this._start]}find(i){if(0===this.size)return null;for(const n of this._buffer)if(null!=n&&i(n))return n;return null}clear(i){let n=this.dequeue();for(;null!=n;)i&&i(n),n=this.dequeue()}}},77262:(i,n,a)=>{a.d(n,{Hq:()=>R,Qj:()=>z,V2:()=>S,m_:()=>A});a(50886);var c=a(48237),l=a(84661),d=a(48343),h=a(98664),_=a(39572),p=a(32050),g=a(41156),m=a(22786);const F=new Float64Array(2),x=new Float64Array(2),T="0123456789bcdefghjkmnpqrstuvwxyz",k=64;function S(i,n,a,c){const _=[i.xmin,i.ymin,i.xmax,i.ymax],F=d.A.fromExtent(l.A.fromBounds(_,c)),x=(0,m.Cv)(F,c,h.A.WGS84,{densificationStep:n*k});if(!x)return null;const T=(0,p.Ye)(new g.A,x,!1,!1),M=T.coords.filter(((i,n)=>!(n%2))),O=T.coords.filter(((i,n)=>n%2)),P=Math.min(...M),q=Math.min(...O),E=Math.max(...M),D=Math.max(...O),N=A(P,q,a,h.A.WGS84),B=A(E,D,a,h.A.WGS84);return N&&B?{bounds:_,geohashBounds:{xLL:N[0],yLL:N[1],xTR:B[0],yTR:B[1]},level:a}:null}function A(i,n,a,l){if(l.isWebMercator){const l=(0,c.KJ)(i/_.$O.radius),d=l-360*Math.floor((l+180)/360),h=[0,0];return Y(h,0,(0,c.KJ)(Math.PI/2-2*Math.atan(Math.exp(-n/_.$O.radius))),d,a),h}const d=(0,m.Cv)({x:i,y:n},l,h.A.WGS84);if(!d)return null;const p=[0,0];return Y(p,0,d.y,d.x,a),p}function W(i){return T[i]}function b(i){return(i[0]+i[1])/2}function w(i,n,a){return i[0]=n,i[1]=a,i}function C(i,n){const a=b(i),c=n,l=!n;i[0]=l*i[0]+c*a,i[1]=l*a+c*i[1]}function L(i,n){const a=n>b(i);return C(i,a),a}function R(i,n){let a=-90,c=90,l=-180,d=180;for(let h=0;h<n;h++){const n=Math.ceil((h+1)/2),_=Math.floor((h+1)/2),p=1-h%2,g=30-(3*n+2*_),m=30-(2*n+3*_),F=3*p+2*(1-p),x=2*p+3*(1-p),T=3*p+7*(1-p)<<m,k=(7*p+3*(1-p)<<g&i.geohashX)>>g,M=(T&i.geohashY)>>m;for(let i=F-1;i>=0;i--){const n=(l+d)/2,a=k&1<<i?1:0;l=(1-a)*l+a*n,d=(1-a)*n+a*d}for(let i=x-1;i>=0;i--){const n=(a+c)/2,l=M&1<<i?1:0;a=(1-l)*a+l*n,c=(1-l)*n+l*c}}return[l,a,d,c]}function Y(i,n,a,c,l){l%2&&(l+=1);let d=0,h=0,_=-90,p=90,g=-180,m=180;for(let F=0;F<l/2;F++){for(let i=0;i<5;i++){const n=(g+m)/2,a=c>n?1:0;d|=a<<29-(i+5*F),g=(1-a)*g+a*n,m=(1-a)*n+a*m}for(let i=0;i<5;i++){const n=(_+p)/2,c=a>n?1:0;h|=c<<29-(i+5*F),_=(1-c)*_+c*n,p=(1-c)*n+c*p}}i[2*n]=d,i[2*n+1]=h}function z(i,n,a){let c="";const l=w(F,-90,90),d=w(x,-180,180);for(let h=0;h<a;h++){let a=0;h%2?(a|=L(l,i)<<4,a|=L(d,n)<<3,a|=L(l,i)<<2,a|=L(d,n)<<1,a|=L(l,i)<<0):(a|=L(d,n)<<4,a|=L(l,i)<<3,a|=L(d,n)<<2,a|=L(l,i)<<1,a|=L(d,n)<<0),c+=W(a)}return c}},64032:(i,n,a)=>{var c,l,d,h,_,p,g,m,F,x,T,k,M,O,P,q,E,D,N,B,G,U,j,V,Q,H,J,Z,X,K,$,ee,te,se,re,ie,ne,ae,oe,ue,ce,le,de,he,_e,pe,ge,fe,ye,me,Se,ve,be,Ie,we,Fe,xe,Ce,Ae,Te,ke;a.d(n,{$2:()=>_,C1:()=>d,JO:()=>l,M1:()=>U,O$:()=>xe,Q1:()=>pe,TZ:()=>q,WE:()=>Z,Y:()=>g,YI:()=>fe,bj:()=>m,e_:()=>_e,f0:()=>Fe,fu:()=>T,g7:()=>F,ip:()=>ge,mU:()=>X,oF:()=>B,uQ:()=>G,uT:()=>ie,vG:()=>Ae,wd:()=>ue,xR:()=>c,xn:()=>E,xw:()=>Q,yS:()=>ne}),function(i){i[i.BUTT=0]="BUTT",i[i.ROUND=1]="ROUND",i[i.SQUARE=2]="SQUARE",i[i.UNKNOWN=4]="UNKNOWN"}(c||(c={})),function(i){i[i.BEVEL=0]="BEVEL",i[i.ROUND=1]="ROUND",i[i.MITER=2]="MITER",i[i.UNKNOWN=4]="UNKNOWN"}(l||(l={})),function(i){i[i.SCREEN=0]="SCREEN",i[i.MAP=1]="MAP"}(d||(d={})),function(i){i[i.Tint=0]="Tint",i[i.Ignore=1]="Ignore",i[i.Multiply=99]="Multiply"}(h||(h={})),function(i){i.Both="Both",i.JustBegin="JustBegin",i.JustEnd="JustEnd",i.None="None"}(_||(_={})),function(i){i[i.Mosaic=0]="Mosaic",i[i.Centered=1]="Centered"}(p||(p={})),function(i){i[i.Normal=0]="Normal",i[i.Superscript=1]="Superscript",i[i.Subscript=2]="Subscript"}(g||(g={})),function(i){i[i.MSSymbol=0]="MSSymbol",i[i.Unicode=1]="Unicode"}(m||(m={})),function(i){i[i.Unspecified=0]="Unspecified",i[i.TrueType=1]="TrueType",i[i.PSOpenType=2]="PSOpenType",i[i.TTOpenType=3]="TTOpenType",i[i.Type1=4]="Type1"}(F||(F={})),function(i){i[i.Display=0]="Display",i[i.Map=1]="Map"}(x||(x={})),function(i){i.None="None",i.Loop="Loop",i.Oscillate="Oscillate"}(T||(T={})),function(i){i[i.Z=0]="Z",i[i.X=1]="X",i[i.Y=2]="Y"}(k||(k={})),function(i){i[i.XYZ=0]="XYZ",i[i.ZXY=1]="ZXY",i[i.YXZ=2]="YXZ"}(M||(M={})),function(i){i[i.Rectangle=0]="Rectangle",i[i.RoundedRectangle=1]="RoundedRectangle",i[i.Oval=2]="Oval"}(O||(O={})),function(i){i[i.None=0]="None",i[i.Alpha=1]="Alpha",i[i.Screen=2]="Screen",i[i.Multiply=3]="Multiply",i[i.Add=4]="Add"}(P||(P={})),function(i){i[i.TTB=0]="TTB",i[i.RTL=1]="RTL",i[i.BTT=2]="BTT"}(q||(q={})),function(i){i[i.None=0]="None",i[i.SignPost=1]="SignPost",i[i.FaceNearPlane=2]="FaceNearPlane"}(E||(E={})),function(i){i[i.Float=0]="Float",i[i.String=1]="String",i[i.Boolean=2]="Boolean"}(D||(D={})),function(i){i[i.Intersect=0]="Intersect",i[i.Subtract=1]="Subtract"}(N||(N={})),function(i){i.OpenEnded="OpenEnded",i.Block="Block",i.Crossed="Crossed"}(B||(B={})),function(i){i.FullGeometry="FullGeometry",i.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",i.ReversedFirstSegment="ReversedFirstSegment",i.PerpendicularToSecondSegment="PerpendicularToSecondSegment",i.SecondSegmentWithTicks="SecondSegmentWithTicks",i.DoublePerpendicular="DoublePerpendicular",i.OppositeToFirstSegment="OppositeToFirstSegment",i.TriplePerpendicular="TriplePerpendicular",i.HalfCircleFirstSegment="HalfCircleFirstSegment",i.HalfCircleSecondSegment="HalfCircleSecondSegment",i.HalfCircleExtended="HalfCircleExtended",i.OpenCircle="OpenCircle",i.CoverageEdgesWithTicks="CoverageEdgesWithTicks",i.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",i.GapExtentMidline="GapExtentMidline",i.Chevron="Chevron",i.PerpendicularWithArc="PerpendicularWithArc",i.ClosedHalfCircle="ClosedHalfCircle",i.TripleParallelExtended="TripleParallelExtended",i.ParallelWithTicks="ParallelWithTicks",i.Parallel="Parallel",i.PerpendicularToFirstSegment="PerpendicularToFirstSegment",i.ParallelOffset="ParallelOffset",i.OffsetOpposite="OffsetOpposite",i.OffsetSame="OffsetSame",i.CircleWithArc="CircleWithArc",i.DoubleJog="DoubleJog",i.PerpendicularOffset="PerpendicularOffset",i.LineExcludingLastSegment="LineExcludingLastSegment",i.MultivertexArrow="MultivertexArrow",i.CrossedArrow="CrossedArrow",i.ChevronArrow="ChevronArrow",i.ChevronArrowOffset="ChevronArrowOffset",i.PartialFirstSegment="PartialFirstSegment",i.Arch="Arch",i.CurvedParallelTicks="CurvedParallelTicks",i.Arc90Degrees="Arc90Degrees"}(G||(G={})),function(i){i.Mitered="Mitered",i.Bevelled="Bevelled",i.Rounded="Rounded",i.Square="Square",i.TrueBuffer="TrueBuffer"}(U||(U={})),function(i){i.ClosePath="ClosePath",i.ConvexHull="ConvexHull",i.RectangularBox="RectangularBox"}(j||(j={})),function(i){i.BeginningOfLine="BeginningOfLine",i.EndOfLine="EndOfLine"}(V||(V={})),function(i){i.Mitered="Mitered",i.Bevelled="Bevelled",i.Rounded="Rounded",i.Square="Square"}(Q||(Q={})),function(i){i.Fast="Fast",i.Accurate="Accurate"}(H||(H={})),function(i){i.BeginningOfLine="BeginningOfLine",i.EndOfLine="EndOfLine"}(J||(J={})),function(i){i.Sinus="Sinus",i.Square="Square",i.Triangle="Triangle",i.Random="Random"}(Z||(Z={})),function(i){i[i.None=0]="None",i[i.Default=1]="Default",i[i.Force=2]="Force"}(X||(X={})),function(i){i[i.Buffered=0]="Buffered",i[i.Left=1]="Left",i[i.Right=2]="Right",i[i.AlongLine=3]="AlongLine"}(K||(K={})),function(i){i[i.Linear=0]="Linear",i[i.Rectangular=1]="Rectangular",i[i.Circular=2]="Circular",i[i.Buffered=3]="Buffered"}($||($={})),function(i){i[i.Discrete=0]="Discrete",i[i.Continuous=1]="Continuous"}(ee||(ee={})),function(i){i[i.AcrossLine=0]="AcrossLine",i[i.AloneLine=1]="AloneLine"}(te||(te={})),function(i){i[i.Left=0]="Left",i[i.Right=1]="Right",i[i.Center=2]="Center",i[i.Justify=3]="Justify"}(se||(se={})),function(i){i[i.Base=0]="Base",i[i.MidPoint=1]="MidPoint",i[i.ThreePoint=2]="ThreePoint",i[i.FourPoint=3]="FourPoint",i[i.Underline=4]="Underline",i[i.CircularCW=5]="CircularCW",i[i.CircularCCW=6]="CircularCCW"}(re||(re={})),function(i){i.Butt="Butt",i.Round="Round",i.Square="Square"}(ie||(ie={})),function(i){i.NoConstraint="NoConstraint",i.HalfPattern="HalfPattern",i.HalfGap="HalfGap",i.FullPattern="FullPattern",i.FullGap="FullGap",i.Custom="Custom"}(ne||(ne={})),function(i){i[i.None=-1]="None",i[i.Custom=0]="Custom",i[i.Circle=1]="Circle",i[i.OpenArrow=2]="OpenArrow",i[i.ClosedArrow=3]="ClosedArrow",i[i.Diamond=4]="Diamond"}(ae||(ae={})),function(i){i[i.ExtraLeading=0]="ExtraLeading",i[i.Multiple=1]="Multiple",i[i.Exact=2]="Exact"}(oe||(oe={})),function(i){i.Bevel="Bevel",i.Round="Round",i.Miter="Miter"}(ue||(ue={})),function(i){i[i.Default=0]="Default",i[i.String=1]="String",i[i.Numeric=2]="Numeric"}(ce||(ce={})),function(i){i[i.InsidePolygon=0]="InsidePolygon",i[i.PolygonCenter=1]="PolygonCenter",i[i.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(le||(le={})),function(i){i[i.Tint=0]="Tint",i[i.Replace=1]="Replace",i[i.Multiply=2]="Multiply"}(de||(de={})),function(i){i[i.ClipAtBoundary=0]="ClipAtBoundary",i[i.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",i[i.DoNotTouchBoundary=2]="DoNotTouchBoundary",i[i.DoNotClip=3]="DoNotClip"}(he||(he={})),function(i){i.NoConstraint="NoConstraint",i.WithMarkers="WithMarkers",i.WithFullGap="WithFullGap",i.WithHalfGap="WithHalfGap",i.Custom="Custom"}(_e||(_e={})),function(i){i.Fixed="Fixed",i.Random="Random",i.RandomFixedQuantity="RandomFixedQuantity"}(pe||(pe={})),function(i){i.LineMiddle="LineMiddle",i.LineBeginning="LineBeginning",i.LineEnd="LineEnd",i.SegmentMidpoint="SegmentMidpoint"}(ge||(ge={})),function(i){i.OnPolygon="OnPolygon",i.CenterOfMass="CenterOfMass",i.BoundingBoxCenter="BoundingBoxCenter"}(fe||(fe={})),function(i){i[i.Low=0]="Low",i[i.Medium=1]="Medium",i[i.High=2]="High"}(ye||(ye={})),function(i){i[i.MarkerCenter=0]="MarkerCenter",i[i.MarkerBounds=1]="MarkerBounds"}(me||(me={})),function(i){i[i.None=0]="None",i[i.PropUniform=1]="PropUniform",i[i.PropNonuniform=2]="PropNonuniform",i[i.DifUniform=3]="DifUniform",i[i.DifNonuniform=4]="DifNonuniform"}(Se||(Se={})),function(i){i.Tube="Tube",i.Strip="Strip",i.Wall="Wall"}(ve||(ve={})),function(i){i[i.Random=0]="Random",i[i.Increasing=1]="Increasing",i[i.Decreasing=2]="Decreasing",i[i.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(be||(be={})),function(i){i[i.Relative=0]="Relative",i[i.Absolute=1]="Absolute"}(Ie||(Ie={})),function(i){i[i.Normal=0]="Normal",i[i.LowerCase=1]="LowerCase",i[i.Allcaps=2]="Allcaps"}(we||(we={})),function(i){i[i.LTR=0]="LTR",i[i.RTL=1]="RTL"}(Fe||(Fe={})),function(i){i.Draft="Draft",i.Picture="Picture",i.Text="Text"}(xe||(xe={})),function(i){i[i.Top=0]="Top",i[i.Center=1]="Center",i[i.Baseline=2]="Baseline",i[i.Bottom=3]="Bottom"}(Ce||(Ce={})),function(i){i[i.Right=0]="Right",i[i.Upright=1]="Upright"}(Ae||(Ae={})),function(i){i[i.Small=0]="Small",i[i.Medium=1]="Medium",i[i.Large=2]="Large"}(Te||(Te={})),function(i){i[i.Calm=0]="Calm",i[i.Rippled=1]="Rippled",i[i.Slight=2]="Slight",i[i.Moderate=3]="Moderate"}(ke||(ke={}))},80050:(i,n,a)=>{a.d(n,{$r:()=>t,M$:()=>h,mF:()=>d});var c=a(22123),l=a(45104);const d={selection:i=>new l.A({color:new c.A([i.color.r/2,i.color.g/2,i.color.b/2,i.color.a])}),highlight:i=>i,popup:i=>new l.A({color:new c.A([i.color.g,i.color.b,i.color.r,i.color.a])})};function t(i){if(!i)return 0;let n=1;for(const a in d){if(a===i)break;n<<=1}return n}const h=Object.keys(d)},80271:(i,n,a)=>{a.d(n,{$U:()=>X,C2:()=>F,CQ:()=>l,CR:()=>G,C_:()=>$,Cp:()=>U,DY:()=>g,Gh:()=>J,LY:()=>Q,O5:()=>oe,Pq:()=>x,Qb:()=>ne,Sr:()=>N,TB:()=>he,Tv:()=>h,Vl:()=>de,Xh:()=>le,YS:()=>k,YV:()=>_,_j:()=>te,_x:()=>ue,bg:()=>d,c5:()=>Z,dV:()=>V,eG:()=>m,eI:()=>ce,fq:()=>re,g0:()=>H,hM:()=>ee,ju:()=>p,lL:()=>q,mg:()=>K,n9:()=>D,nM:()=>P,nW:()=>se,qM:()=>c,r1:()=>ae,sn:()=>E,uM:()=>M,ue:()=>T,vN:()=>j,vd:()=>B,yv:()=>ie,z2:()=>O});const c=1e-30,l=512,d=128,h=511,_=16777216,p=8,g=29,m=24,F=4,x=0,T=0,k=0,M=1,O=2,P=3,q=4,E=5,D=6,N=12,B=5,G=6,U=5,j=6;var V;!function(i){i[i.FilterFlags=0]="FilterFlags",i[i.Animation=1]="Animation",i[i.GPGPU=2]="GPGPU",i[i.VV=3]="VV",i[i.DD0=4]="DD0",i[i.DD1=5]="DD1",i[i.DD2=6]="DD2"}(V||(V={}));const Q=8,H=Q<<1,J=1.05,Z=1,X=5,K=6,$=1.15,ee=2,te=128-2*ee,se=2,re=10,ie=1024,ne=128,ae=4,oe=1,ue=1<<20,ce=.75,le=10,de=.75,he=256},95454:(i,n,a)=>{a.r(n),a.d(n,{default:()=>FeaturePipelineWorker_m});var c=a(4180),l=a(58285),d=a(50886),h=a(33584),_=a(81618),p=a(76761),g=a(63390),m=a(62555),F=a(22179),x=a(63801),T=a(67685),k=(a(54869),a(11808),a(80271));class PipelineConnectionHandlers_e{constructor(i){this._client=i,this.layerView=this._client.createInvokeProxy(),this.container=this._client.createInvokeProxy("container"),this.eventLog=this._client.createInvokeProxy("eventLog")}}var M=a(35598),O=a(61163),P=a(98664),q=a(50386),E=a(4690);const D=128;function u(i){switch(i){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case D:return 1}}function f(i){switch(i){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case D:return 1}}class y{constructor(i,n){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.tileKey=i,this._bufferingEnabled=n,this._sizeHint=a,this._meshes={self:new q.U(this.id,this._sizeHint),neighbors:new Array},this._currentRecordOverlaps=0,this._currentEntityOverlaps=0}get id(){return this.tileKey}vertexCount(){return this._meshes.self.vertexCount()}indexCount(){return this._meshes.self.indexCount()}indexEnsureSize(i){this._meshes.self.indexEnsureSize(i)}entityStart(i){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i;this._currentEntityOverlaps=0,this._meshes.self.entityStart(i,n)}entityRecordCount(){return this._meshes.self.entityRecordCount()}entityEnd(){if(this._meshes.self.entityEnd(),this._bufferingEnabled)for(let i=0;i<8;i++){const n=1<<i;this._currentEntityOverlaps&n&&this._meshes.neighbors[i].entityEnd()}}recordStart(i,n,a){this._currentRecordOverlaps=0,this._meshes.self.recordStart(i,n,a)}recordEnd(){const i=this._meshes.self.recordEnd(this._currentRecordOverlaps);return i&&0!==this._currentRecordOverlaps?(this._copyIntoNeighbors(),this._currentEntityOverlaps|=this._currentRecordOverlaps,!0):i}recordBounds(i,n,a,c){this._bufferingEnabled&&this._addOverlap(i,n,a,c)}recordCount(){return this._meshes.self.recordCount()}metricStart(i){this._meshes.self.metricStart(i)}metricBoxWrite(i){this._meshes.self.metricBoxWrite(i)}metricEnd(){this._meshes.self.metricEnd()}vertexWrite(i){this._meshes.self.vertexWrite(i)}vertexWriteF32(i){this._meshes.self.vertexWriteF32(i)}vertexWriteRegion(i){this._meshes.self.vertexWriteRegion(i)}indexWrite(i){this._meshes.self.indexWrite(i)}serialize(i){const n={message:[],transferList:[]},a=this._meshes.self.serialize();return n.message.push({tileId:this.tileKey,...a.message}),n.transferList.push(...a.transferList),this._meshes.neighbors.forEach(((a,c)=>{const l=a.serialize(),d=1<<c,h=u(d),_=f(d),p=(0,E.K)(new T.A(this.tileKey),h,_,i);n.message.push({tileId:p.id,...l.message}),n.transferList.push(...l.transferList)})),n}_addOverlap(i,n,a,c){const l=Math.min(k.CQ/2,a),d=Math.min(k.CQ/2,c),h=255^((i<0+l?148:i>=k.CQ-l?41:189)|(n<0+d?224:n>=k.CQ-d?7:231));this._currentRecordOverlaps|=h}_copyIntoNeighbors(){for(let i=0;i<8;i++){const n=1<<i;if(this._currentRecordOverlaps&n){if(!this._meshes.neighbors[i]){const a=Math.floor(this._sizeHint/16);this._meshes.neighbors[i]=new q.U(n,a)}const a=this._meshes.neighbors[i],c=-u(n)*k.CQ,l=-f(n)*k.CQ;a.copyLastFrom(this._meshes.self,c,l)}}}}class MeshFactory_s{}var N=a(75224);class e{constructor(){this._defaultResult=null,this._backgroundFillResult=null}static async from(i,n,a,c){const l=new e;return l.setDefault(await(0,N.PZ)(i,n,a.meshes,c)),l}size(){return 1}getDefault(){return this._defaultResult}setDefault(i){this._defaultResult=i}getBackgroundFill(){return this._backgroundFillResult}setBackgroundFill(i){this._backgroundFillResult=i}match(i,n){const a=this.doMatch(i,n)||this.getDefault();if(a&&a.length>0){const i=this.getBackgroundFill();if(i)return[...i,...a]}return a}getSortKey(i,n){return 0}doMatch(i,n){return null}async fetchResources(i,n){}}class s extends e{static async fromDictionaryRenderer(i,n,a){return new s(i,n,a)}constructor(i,n,a){super(),this._storage=i,this._schema=n,this._viewParams=a,this._hashToGroup=new Map}get fieldMap(){return this._schema.fieldMap}async fetchResources(i,n){const a=n.getCursor(),c=[];for(;a.next();)c.push(this._updateMeshWriterGroup(i,a));await Promise.all(c)}match(i,n){const a=i.getAttributeHash();return this._hashToGroup.get(a)}async _updateMeshWriterGroup(i,n){const a=n.readLegacyFeatureForDisplay(),c=n.getAttributeHash();if(this._hashToGroup.has(c))return;this._hashToGroup.set(c,null);const l=await i.fetchDictionaryResourceImmediate({type:"dictionary-request",feature:a});if(!l)return;const d=await(0,N.PZ)(this._storage,i,l.meshes,this._viewParams);this._hashToGroup.set(c,d)}}class IntervalMatcher_s extends e{constructor(i,n){super(),this._intervals=[],this._isMaxInclusive=n,this._field=i}static async fromIntervalSchema(i,n,a,c){const l=await i.createComputedField(a),d=new IntervalMatcher_s(l,a.isMaxInclusive);await Promise.all(a.intervals.map((async a=>{const l=await(0,N.PZ)(i,n,a.meshes,c);d.add(a,l)})));const h=await(0,N.PZ)(i,n,a.defaultSymbol,c);d.setDefault(h);const _=await(0,N.PZ)(i,n,a.backgroundFill,c);return d.setBackgroundFill(_),d}add(i,n){this._intervals.push({interval:i,result:n}),this._intervals.sort(((i,n)=>i.interval.min-n.interval.min))}size(){return super.size()+this._intervals.length}doMatch(i,n){var a;const c=null===(a=this._field)||void 0===a?void 0:a.read(i,n);if(null==c||isNaN(c)||c===1/0||c===-1/0)return null;for(let l=0;l<this._intervals.length;l++){const{interval:i,result:n}=this._intervals[l],a=c>=i.min,d=this._isMaxInclusive?c<=i.max:c<i.max;if(a&&d)return n}return null}}class LabelMatcher_s extends e{static async fromLabelSchema(i,n,a,c){const l=a.classes.map((async a=>{const l=await(0,N.PZ)(i,n,a.meshes,c);return{minScale:a.minScale,maxScale:a.maxScale,meshes:l,expression:null,where:await i.createWhereClause(a.where)}})),d=await Promise.all(l);return new LabelMatcher_s(d)}constructor(i){super(),this._labels=i}match(i,n){if(!this._labels.length)return null;const a=this._getLabels(n.$view.scale),c=[];for(const l of a)l.where&&!l.where(i)||c.push(...l.meshes);return c}_getLabels(i){return this._labels.filter((n=>this._validForTileScale(n,i)))}_validForTileScale(i,n){const a=n-n/4,c=n+n/2;return(!i.minScale||i.minScale>=a)&&(!i.maxScale||i.maxScale<=c)}}class MapMatcher_l extends e{constructor(i,n){super(),this._defaultSymbolSortKey=0,this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fields=i,this._separator=n||""}static async fromMatcherSchema(i,n,a,c){const l=a.expression?[i.createComputedField({expression:a.expression})]:[a.field?i.createComputedField({field:a.field}):null,a.field2?i.createComputedField({field:a.field2}):null,a.field3?i.createComputedField({field:a.field3}):null],d=(await Promise.all(l)).filter((i=>!!i)),h=new MapMatcher_l(d,a.fieldDelimiter),_=await(0,N.PZ)(i,n,a.defaultSymbol,c);h.setDefault(_);const p=await(0,N.PZ)(i,n,a.backgroundFill,c);return h.setBackgroundFill(p),await Promise.all(a.map.map((async(a,l)=>{const d=await(0,N.PZ)(i,n,a.symbol,c);"<Null>"===a.value?h.setNullResult(d):h.add(a.value,d,l+1)}))),h}setNullResult(i){this._nullResult=i}getSortKey(i,n){const a=this._getValueFromFields(i,n);if(null==a||""===a||"<Null>"===a)return 0;const c=this._resultsMap.get(a.toString());return c?c.sortKey:this._defaultSymbolSortKey}add(i,n,a){this._resultsMap.set(i.toString(),{meshWriters:n,sortKey:a}),this._defaultSymbolSortKey=Math.max(this._defaultSymbolSortKey,a+1)}size(){return super.size()+this._resultsMap.size}doMatch(i,n){var a;const c=this._getValueFromFields(i,n);if(null!==this._nullResult&&(null==c||""===c||"<Null>"===c))return this._nullResult;if(null==c)return null;const l=c.toString();return null===(a=this._resultsMap.get(l))||void 0===a?void 0:a.meshWriters}_getValueFromFields(i,n){const a=[];for(const c of this._fields){const l=c.read(i,n);null==l||""===l?a.push("<Null>"):a.push(l)}return a.join(this._separator)}}async function createMatcher_c(i,n,a,c){switch(a.type){case"simple":case"heatmap":case"dot-density":case"pie-chart":return e.from(i,n,a,c);case"interval":return IntervalMatcher_s.fromIntervalSchema(i,n,a,c);case"dictionary":return s.fromDictionaryRenderer(i,a,c);case"label":return LabelMatcher_s.fromLabelSchema(i,n,a,c);case"map":return MapMatcher_l.fromMatcherSchema(i,n,a,c);case"subtype":return createMatcher_n.fromSubtypes(i,n,a,c);case"cluster":return createMatcher_o.fromClusterSchema(i,n,a,c);default:throw new Error("Impl")}}class createMatcher_n extends e{constructor(i,n){super(),this._subMatchers=i,this._subtypeField=n}static async fromSubtypes(i,n,a,c){const l=new Map,d=[];for(const h in a.renderers){const _=parseInt(h,10),p=createMatcher_c(i,n,a.renderers[h],c).then((i=>l.set(_,i)));d.push(p)}return await Promise.all(d),new createMatcher_n(l,a.subtypeField)}match(i,n){const a=i.readAttribute(this._subtypeField),c=this._subMatchers.get(a);return c?c.match(i,n):null}}class createMatcher_o extends e{static async fromClusterSchema(i,n,a,c){const[l,d]=await Promise.all([createMatcher_c(i,n,a.feature,c),createMatcher_c(i,n,a.cluster,c)]);return new createMatcher_o(l,d)}constructor(i,n){super(),this._featureMatcher=i,this._clusterMatcher=n}match(i,n){return 1===i.readAttribute("cluster_count")?this._featureMatcher.match(i,n):this._clusterMatcher.match(i,n)}}class FeatureMeshFactory_s extends MeshFactory_s{static async create(i,n,a,c){const l=await createMatcher_c(i,n,a.symbology,c),d=a.labels?await createMatcher_c(i,n,a.labels,c):null;return new FeatureMeshFactory_s(l,d)}constructor(i,n){super(),this._symbology=i,this._labels=n}destroy(){}async enqueueMatcherRequests(i,n){var a;await Promise.all([this._symbology.fetchResources(i,n),null===(a=this._labels)||void 0===a?void 0:a.fetchResources(i,n)])}enqueueWriterRequests(i,n,a){const c=this._symbology.match(n,a);if(c){for(const l of c)l.enqueueRequest(i,n,a);if(this._labels){const c=this._labels.match(n,a);if(!c)return;for(const l of c)l.enqueueRequest(i,n,a)}}}write(i,n,a,c,l){const d=this._symbology.match(a,c);if(d){for(const h of d)h.write(i,n,a,c,l);if(i.entityRecordCount()>=1&&this._labels){const h=this._labels.match(a,c);if(!h)return;for(const _ of h)_.setReferences(d),_.write(i,n,a,c,l)}}}getSortKey(i,n){return this._symbology.getSortKey(i,n)}}var B=a(74771),G=(a(30174),a(77262)),U=a(32050),j=a(57224),V=a(22786),Q=a(14454);class ComputedAggregateField_s{static async create(i,n){var a;if("count"===n.statisticType){const i=new Q.G(1);return new ComputedAggregateField_s(n.name,n.alias,n.type,n.statisticType,i)}const c=await i.createComputedField({expression:null===(a=n.onStatisticExpression)||void 0===a?void 0:a.expression,field:n.onStatisticField});return new ComputedAggregateField_s(n.name,n.alias,n.type,n.statisticType,c)}constructor(i,n,a,c,l){this.name=i,this.alias=n,this.type=a,this.statisticType=c,this.computed=l}}var H=a(73067),J=a(21374),Z=a(19464),X=a(56103);class t{constructor(i){this.subscription=i,this.handledChunks=new Set}destroy(){}}class AProcessorStrategy_e{constructor(i,n){this._source=i,this._attributeStore=n,this._sendStates=new Map}destroy(){}get enablePixelBuffering(){return!0}onSubscribe(i){const n=this.createState(i);this._sendStates.set(i.key.id,n),this.updateChunks()}onUnsubscribe(i){var n;null!==(n=this._sendStates.get(i.key.id))&&void 0!==n&&n.destroy(),this._sendStates.delete(i.key.id)}invalidate(){const i=Array.from(this._sendStates.values());this._sendStates.clear();for(const n of i)n.destroy(),this.onSubscribe(n.subscription)}invalidateAttributeData(){}getFeatureObjectIdsForAggregate(i){throw new Error("InternalError: AggregateId lookup not supported")}getDisplayIds(i){return this.displayMap(i,(i=>i),(i=>i))}getDisplayAndObjectIds(i){return this.displayMap(i,(i=>i),((i,n,a)=>[i,a]))}}class AAggregateStrategy_i extends AProcessorStrategy_e{constructor(i,n,a,c){super(i,n),this.spatialReference=a,this.aggregateFields=c,this.events=new H.A,this.featureAdapter=Z.T}get aggregateQueryEngine(){return this._aggregateQueryEngine||(this._aggregateQueryEngine=new X.d({featureStore:this,fieldsIndex:this._metadata.fieldsIndex,geometryType:this._metadata.geometryType,objectIdField:this._metadata.objectIdField,spatialReference:this.spatialReference})),this._aggregateQueryEngine}removeChunks(i){}forEach(i){return this.forEachAggregateWorldSpace(i)}forEachInBounds(i,n){}forEachBounds(i,n){const a=(0,J.vt)();for(const c of i){const i=(0,U.jQ)(a,c.geometry,!1,!1);i&&n(i)}}}class FeatureSourceMessage_e{constructor(i,n,a,c,l){this.subscription=i,this.reader=n,this.clear=a,this.end=c,this.debugInfo=l,this.type="append"}get id(){return this.subscription.tile.id}createMessage(i,n,a){return{type:"append",clear:this.clear,id:this.id,append:i,end:this.end,debugInfo:this.debugInfo,subscriptionVesrion:this.subscription.version,version:n,attributeEpoch:a}}}class FeatureSourceMessage_i{constructor(i,n,a,c,l){this.subscription=i,this.reader=n,this.remove=a,this.end=c,this.debugInfo=l,this.type="update"}get id(){return this.subscription.tile.id}createMessage(i,n,a){return{type:"update",id:this.id,modify:i,debugInfo:this.debugInfo,remove:this.remove,version:n,subscriptionVesrion:this.subscription.version,end:this.end,attributeEpoch:a}}}var K=a(29170),$=a(70535),ee=a(91080),te=a(8084),se=a(95330);class FeatureSetReaderJSON_u extends se.Y{static fromFeatures(i,n){const{objectIdField:a,geometryType:c}=n,l=(0,U.Di)([],i,c,!1,!1,a);for(let d=0;d<l.length;d++)l[d].displayId=i[d].displayId;return FeatureSetReaderJSON_u.fromOptimizedFeatures(l,n)}static fromFeatureSet(i,n){const a=(0,U.q3)(i,n.objectIdField);return FeatureSetReaderJSON_u.fromOptimizedFeatureSet(a,n)}static fromOptimizedFeatureSet(i,n){const a=FeatureSetReaderJSON_u.fromOptimizedFeatures(i.features,n);return a._exceededTransferLimit=i.exceededTransferLimit,a._transform=i.transform,a._fieldsIndex=new te.A(i.fields),a}static fromOptimizedFeatures(i,n,a){const c=new FeatureSetReaderJSON_u(i,n);return c._fieldsIndex=n.fieldsIndex,c._transform=a,c}static empty(i){return new FeatureSetReaderJSON_u([],i)}constructor(i,n){super(n),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=n.geometryType,this._features=i}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}removeIds(i){const n=new Set(i);this._features=this._features.filter((i=>!(null!=i.objectId&&n.has(i.objectId))))}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let i="";for(const n in this._current.attributes)i+=this._current.attributes[n];return i}getIndex(){return this._featureIndex}setIndex(i){this._featureIndex=i}getObjectId(){var i;return null===(i=this._current)||void 0===i?void 0:i.objectId}getDisplayId(){return this._current.displayId}setDisplayId(i){this._current.displayId=i}copy(){const i=new FeatureSetReaderJSON_u(this._features,this.metadata);return this.copyInto(i),i}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return(0,j.N3)(this._current)?(0,U.Rk)(this._current.geometry,2):0}_readX(){return(0,j.N3)(this._current)?this._current.geometry.coords[0]:0}_readY(){return(0,j.N3)(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){var i;return(0,j.N3)(this._current)&&null!==(i=this._current.geometry)&&void 0!==i?i:null}_readServerCentroid(){return this._current.centroid}_readAttribute(i,n){var a;if(!this._fieldsIndex){const n=this._current.attributes[i];if(void 0!==n)return n;const a=i.toLowerCase();for(const i in this._current.attributes)if(i.toLowerCase()===a)return this._current.attributes[i];return}const c=this._fieldsIndex.get(i);if(!c)return;let l=this._current.attributes[c.name];return null==l?l:("esriFieldTypeTimestampOffset"===(null===(a=this.fields.get(i))||void 0===a?void 0:a.type)&&(l=this.parseTimestampOffset(l)),n&&this.fields.isDateField(i)?new Date(l):l)}_readAttributes(){return this._current.attributes}copyInto(i){super.copyInto(i),i._featureIndex=this._featureIndex,i._transform=this._transform,i._fieldsIndex=this._fieldsIndex}}class BinningStrategy_m extends t{constructor(i,n){super(i),this.bins=new Map,this.done=!1,this._store=n}reset(){this.destroy(),this.bins.clear(),this.done=!1,this.handledChunks.clear()}destroy(){const i=this.subscription.tile.key.level;for(const a of this.bins.values()){var n;const c=null===(n=a.cachedFeature)||void 0===n?void 0:n.objectId;null!=c&&this._store.releaseDisplayIdForObjectId("".concat(c,".").concat(i))}}*featuresWorldSpace(){for(const i of this.bins.values()){const n=i.cachedFeature;if(n){const i=n.clone();(0,U.Ch)(i.geometry,i.geometry,!1,!1,this.subscription.tile.transform),yield i}}}getGeohashBounds(i,n){const a=this.subscription.tile;return(0,G.V2)(a.extent,a.resolution,n,i)}}class BinningStrategy_g extends AAggregateStrategy_i{static async create(i,n,a,c,l){const d=new K.l({spatialReference:n}),h=i.fixedBinLevel,_=await Promise.all(i.fields.map((async i=>ComputedAggregateField_s.create(d,i)))),p=i.featureFilter?await $.A.create({geometryType:a.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:a.metadata.timeInfo,fieldsIndex:a.metadata.fieldsIndex,spatialReference:n,filterJSON:i.featureFilter}):null;return await(0,V.Nk)(n,P.A.WGS84),new BinningStrategy_g({fields:_,geohashLevel:h,spatialReference:n,featureFilter:p,timeZone:l},i.fields,a,c)}constructor(i,n,a,c){super(a,c,i.spatialReference,i.fields),this._indexOptions=i,this._metadata=new ee.i({geometryType:"esriGeometryPolygon",objectIdField:"aggregateId",fields:n,globalIdField:null,spatialReference:a.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}createState(i){return new BinningStrategy_m(i,this._attributeStore)}async*applyOverride(i){for(const n of this._sendStates.values())n.reset()}displayMap(i,n,a){const c=new Map(i.map((i=>[n(i),i]))),l=[];for(const d of this._sendStates.values())for(const i of d.featuresWorldSpace()){const{objectId:n,displayId:d}=i,h=c.get(n);if(null!=h){const i=a(d,h,n);l.push(i),c.delete(n)}}return l}getDisplayFeatures(i){const n=new Set(i),a=new Set,c=[];for(const l of this._sendStates.values())for(const i of l.featuresWorldSpace())n.has(i.displayId)&&!a.has(i.objectId)&&(i.geometry&&c.push({...(0,U.oN)(i,this._metadata.geometryType,!1,!1),displayId:i.displayId}),a.add(i.objectId));return{features:[],aggregates:c}}getFeatureObjectIdsForAggregate(i){for(const n of this._sendStates.values())for(const a of n.bins.values())if(a.id===i)return Array.from(a.objectIds);return[]}async*updateChunks(){if(this._source.chunks().length)for(const i of this._sendStates.values())yield*this._update(i,this._source)}forEachAggregateWorldSpace(i){for(const n of this._sendStates.values())for(const a of n.featuresWorldSpace())i(a)}async*_update(i,n){const{handledChunks:a,subscription:c,bins:l}=i,{spatialReference:d,geohashLevel:h}=this._indexOptions,_=c.tile;if(i.done)return;for(const O of n.chunks()){if(a.has(O.chunkId))continue;a.add(O.chunkId);const n=O.queryInfo;if("tileId"in n){const i=new T.A(n.tileId);if(i.level!==_.level||i.world!==_.key.world)continue}const c=O.getGeohashIndex(this._indexOptions),p=i.getGeohashBounds(d,h);null!=p&&c.putBins(l,p)}const p=[],g=c.tile.transform,m=c.tile.key.level;for(const T of l.values()){if(T.cachedFeature)T.cachedFeature.attributes=T.getAttributes();else{const i=T.getGeometry(this.spatialReference,g),n=new j.Om(i,T.getAttributes(),null);i||(n.centroid=T.getGeometryCentroid(this.spatialReference,g)),n.objectId=T.id,n.displayId=this._attributeStore.createDisplayIdForObjectId("".concat(n.objectId,".").concat(m)),T.cachedFeature=n}p.push(T.cachedFeature)}this.events.emit("changed"),i.done=!n.updateTracking.updating;const F=FeatureSetReaderJSON_u.fromOptimizedFeatures(p,this._metadata,g),x=F.getCursor(),k=i.subscription.tile.createArcadeEvaluationOptions(this._indexOptions.timeZone);for(;x.next();)this._attributeStore.setAttributeData(x.getDisplayId(),x,k);const M=new FeatureSourceMessage_i(i.subscription,F,[],i.done,{});yield M}}var re=a(41156),ie=a(51961);const ne=Math.PI/180;class AccumulatedStatistics_s{static create(i){return new AccumulatedStatistics_s(i.map((i=>function AccumulatedStatistics_i(i){switch(i.statisticType){case"min":return new r(i);case"max":return new AccumulatedStatistics_u(i);case"avg":return new AccumulatedStatistics_c(i);case"avg_angle":return new AccumulatedStatistics_h(i);case"sum":case"count":return new AccumulatedStatistics_a(i);case"mode":return new AccumulatedStatistics_o(i)}}(i))))}constructor(i){this._statistics=i}values(){return this._statistics.values()}insert(i,n){for(const a of this._statistics)a.insert(i,n)}merge(i){for(let n=0;n<this._statistics.length;n++){const a=this._statistics[n],c=i._statistics[n];if(a.field.name!==c.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");a.merge(c)}}clone(){return new AccumulatedStatistics_s(this._statistics.map((i=>i.clone())))}}class AccumulatedStatistics_n{constructor(i){this.field=i}insert(i,n){if(!this.field.computed)return;const a=this.field.computed.read(i,n);(0,ie.rZ)(a)||this._insertValue(a)}}class r extends AccumulatedStatistics_n{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(i){this.value=Math.min(this.value,i)}merge(i){this.value=Math.min(this.value,i.value)}clone(){const i=new r(this.field);return i.value=this.value,i}}class AccumulatedStatistics_u extends AccumulatedStatistics_n{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(i){this.value=Math.max(this.value,i)}merge(i){this.value=Math.max(this.value,i.value)}clone(){const i=new AccumulatedStatistics_u(this.field);return i.value=this.value,i}}class AccumulatedStatistics_a extends AccumulatedStatistics_n{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(i){this.value+=i}merge(i){this.value+=i.value}clone(){const i=new AccumulatedStatistics_a(this.field);return i.value=this.value,i}}class AccumulatedStatistics_c extends AccumulatedStatistics_n{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(i){this._total+=i,this._count+=1}merge(i){this._total+=i._total,this._count+=i._count}clone(){const i=new AccumulatedStatistics_c(this.field);return i._total=this._total,i._count=this._count,i}}class AccumulatedStatistics_h extends AccumulatedStatistics_n{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const i=this._x/this._count,n=this._y/this._count,a=180/Math.PI;return Math.atan2(n,i)*a}_insertValue(i){this._x=this._x+Math.cos(i*ne),this._y=this._y+Math.sin(i*ne),this._count+=1}merge(i){this._x+=i._x,this._y+=i._y,this._count+=i._count}clone(){const i=new AccumulatedStatistics_h(this.field);return i._x=this._x,i._y=this._y,i._count=this._count,i}}class AccumulatedStatistics_o extends AccumulatedStatistics_n{constructor(){super(...arguments),this._frequencies=new Map}get value(){let i,n=0;for(const[a,c]of this._frequencies.entries())c>n&&(n=c,i=a);return i}_insertValue(i){const n=this._frequencies.get(i);null!=n?this._frequencies.set(i,n+1):this._frequencies.set(i,1)}merge(i){for(const[n,a]of i._frequencies.entries()){const i=this._frequencies.get(n);null!=i?this._frequencies.set(n,i+a):this._frequencies.set(n,a)}}clone(){const i=new AccumulatedStatistics_o(this.field);return i._frequencies=new Map(this._frequencies),i}}class GridCell_i{static createId(i,n){return"".concat(i,".").concat(n)}static create(i,n,a,c){return new GridCell_i(i,n,AccumulatedStatistics_s.create(a),c)}constructor(i,n,a,c){this.gridX=i,this.gridY=n,this._statistics=a,this._worldUnitsPerCell=c,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return GridCell_i.createId(this.gridX,this.gridY)}get count(){return this._count}get statistics(){return this._statistics}get objectIds(){return this._objectIds}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}clone(){const i=new GridCell_i(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return i._count=this._count,i._xWorldTotal=this._xWorldTotal,i._yWorldTotal=this._yWorldTotal,i._firstFeatureAttributes=this._firstFeatureAttributes,i._objectIds=new Set(this._objectIds),i}insert(i,n,a,c){0===this._count?this._firstFeatureAttributes=i.readAttributes():this._firstFeatureAttributes=null,this._count+=1,this._xWorldTotal+=a,this._yWorldTotal+=c,this._statistics.insert(i,n),this._objectIds.add(i.getObjectId())}merge(i){if(0!==i._count){this._count+=i._count,this._firstFeatureAttributes=i._firstFeatureAttributes,this._xWorldTotal+=i._xWorldTotal,this._yWorldTotal+=i._yWorldTotal,this._statistics.merge(i._statistics);for(const n of i._objectIds.values())this._objectIds.add(n)}}getCentroid(i){const n=new re.A([],[this.centroidXWorld,this.centroidYWorld]);if(null!=i){const a=new re.A;return(0,U.Nl)(a,n,!1,!1,"esriGeometryPoint",i)}return n}getGeometricCentroid(i){const n=this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,a=this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,c=new re.A([],[n,a]);if(null!=i){const n=new re.A;return(0,U.Nl)(n,c,!1,!1,"esriGeometryPoint",i)}return c}getAttributes(){const i={aggregateId:this.id};for(const n of this._statistics.values())i[n.field.name]=n.value;return null!=this._firstFeatureAttributes?{...i,...this._firstFeatureAttributes}:i}}var ae=a(49049);function GridSpatialIndex_l(i,n){return(0,ae.GA)(i)*ae.dy*96/n}class GridSpatialIndex_r{constructor(i){this._options=i,this._cells=new Map,this._pixelsPerMapUnit=GridSpatialIndex_l(i.spatialReference,i.scale)}insert(i,n){const a=i.getCursor(),c={$view:{scale:this._options.scale,timeZone:this._options.timeZone}};for(;a.next();)this._insertFeature(a,c,n)}putCellsInBounds(i,n){const[a,c,l,d]=n,h=Math.floor(a*this._pixelsPerMapUnit/this._options.cellSize),_=Math.floor(c*this._pixelsPerMapUnit/this._options.cellSize),p=Math.ceil(l*this._pixelsPerMapUnit/this._options.cellSize),g=Math.ceil(d*this._pixelsPerMapUnit/this._options.cellSize);for(let m=_;m<=g;m++)for(let n=h;n<=p;n++){const a="".concat(n,".").concat(m),c=this._cells.get(a);if(!c)continue;const l=i.get(c.id);l?c&&!i.has(c.id)&&l.merge(c):i.set(c.id,c.clone())}}putCells(i){for(const n of this._cells.values()){const a=i.get(n.id);a?a.merge(n):i.set(n.id,n.clone())}}_insertFeature(i,n,a){const{featureFilter:c}=this._options;if(null!==c&&!c.check(i))return;let l=0,d=0;if("esriGeometryPoint"===i.geometryType)l=i.readXWorldSpace(),d=i.readYWorldSpace();else{if(a){const n=i.readCentroidForDisplay();if(null==n)return;const[a,c]=n.coords;if(a<0||a>k.CQ||c<0||c>k.CQ)return}const n=i.readCentroidWorldSpace();if(null==n)return;l=n.coords[0],d=n.coords[1]}const h=l*this._pixelsPerMapUnit,_=d*this._pixelsPerMapUnit,p=Math.floor(h/this._options.cellSize),g=Math.floor(_/this._options.cellSize);this._getCellOrCreate(p,g).insert(i,n,l,d)}_getCellOrCreate(i,n){const a=GridCell_i.createId(i,n);let c=this._cells.get(a);if(!c){const l=1*this._options.cellSize/this._pixelsPerMapUnit;c=GridCell_i.create(i,n,this._options.fields,l),this._cells.set(a,c)}return c}}class WithDisplayId_s{constructor(i,n){this.inner=i,this.displayId=n}}const oe=128;class ClusterStrategy_ extends t{constructor(i){super(i),this.didSend=!1,this.done=!1}}class ClusterStrategy_m{constructor(i,n,a,c,l){this._level=i,this._scale=n,this._indexOptions=a,this._clusterRadius=c,this._store=l,this._cells=new Map,this._handledChunks=new Set,this._statistics=new Map,this._clusters=new Map}destroy(){this._clearClusters()}_clearClusters(){for(const i of this._clusters.values())this._store.releaseDisplayIdForObjectId(i.inner.id);this._clusters.clear()}*aggregatesWorldSpace(){for(const i of this._clusters.values()){const n=i.inner.getCentroid(null),a=new j.Om(n,i.inner.getAttributes(),null);a.objectId=i.inner.id,a.displayId=i.displayId,yield a}}clusters(){return this._clusters.values()}updateChunks(i){let n=!1;for(const a of i){const i=a.queryInfo;"tileId"in i&&new T.A(i.tileId).level!==this._level||(this._handledChunks.has(a.normalizedChunkId)||(this._handledChunks.add(a.normalizedChunkId),n=!0,a.getGridIndex({...this._indexOptions,scale:this._scale}).putCells(this._cells)))}return n&&this._clusterCells(),n}async updateStatistics(i){let n=!1;for(const a of this._clusters.values())a.inner.count>1&&(n=this._updateAggregateStatistics(this._statistics,a.inner)||n);if(n){const n=Array.from(this._statistics.entries()).map((i=>{let[n,a]=i;return{fieldName:n,minValue:a.minValue,maxValue:a.maxValue}}));await i.container.updateStatistics(this._level,n)}}createAggregateFeatures(i,n){const a=i.subscription,c=[],l=a.tile.transform;for(const d of this._clusters.values()){const i=d.inner.getCentroid(l),n=new j.Om(i,d.inner.getAttributes(),null);n.objectId=d.inner.id,n.displayId=d.displayId;const h=n.geometry.coords,_=a.tile.lod,p=_.wrap?_.worldSize[0]:null;if(null!=p)if(1===p){const i=n.clone();i.geometry.coords[0]-=k.CQ,c.push(i);const a=n.clone();a.geometry.coords[0]+=k.CQ,c.push(a)}else h[0]>k.CQ+k.CQ/2?h[0]-=p*k.CQ:h[0]<-k.CQ/2&&(h[0]+=p*k.CQ);const[g,m]=n.geometry.coords;g<k.CQ+oe&&g>=-128&&m<k.CQ+oe&&m>=-128&&c.push(n)}return FeatureSetReaderJSON_u.fromOptimizedFeatures(c,n,a.tile.transform)}_clusterCells(){let i=Array.from(this._cells.values());i=i.sort(((i,n)=>n.count-i.count));const n=[];for(const c of this._clusters.values())n.push(c.inner.id);this._clusters.clear();const a=new Set;for(const c of i){if(a.has(c.id))continue;const i=this._store.createDisplayIdForObjectId(c.id),n=new WithDisplayId_s(c.clone(),i);a.add(c.id),this._clusters.set(c.id,n);const l=this._clusterRadius*(1/GridSpatialIndex_l(this._indexOptions.spatialReference,this._scale)),d=1+this._clusterRadius/this._indexOptions.cellSize,h=c.centroidXWorld,_=c.centroidYWorld;for(let p=c.gridY-d;p<=c.gridY+d;p++)for(let i=c.gridX-d;i<=c.gridX+d;i++){if(p===c.gridY&&i===c.gridX)continue;const d=this._cells.get(GridCell_i.createId(i,p));if(!d||a.has(d.id))continue;const g=Math.abs(d.centroidXWorld-h),m=Math.abs(d.centroidYWorld-_);g<l&&m<l&&(n.inner.merge(d),a.add(d.id))}}for(const c of n)this._store.releaseDisplayIdForObjectId(c)}_updateAggregateStatistics(i,n){let a=!1;for(const c of n.statistics.values()){if("esriFieldTypeString"===c.field.type)continue;const n=c.value,l=c.field,d=i.get(l.name);if(d){const{minValue:i,maxValue:c}=d,l=Math.min(d.minValue,n),h=Math.max(d.maxValue,n);i===l&&c===h||(d.minValue=l,d.maxValue=h,a=!0)}else i.set(l.name,{minValue:n,maxValue:n}),a=!0}return a}}class ClusterStrategy_y extends AAggregateStrategy_i{static async create(i,n,a,c,l,d){const h=new K.l({spatialReference:a}),_={fields:await Promise.all(n.fields.map((async i=>ComputedAggregateField_s.create(h,i)))),spatialReference:a,featureFilter:n.featureFilter?await $.A.create({geometryType:c.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:c.metadata.timeInfo,fieldsIndex:c.metadata.fieldsIndex,spatialReference:a,filterJSON:n.featureFilter}):null,cellSize:n.clusterRadius/4,timeZone:d};return new ClusterStrategy_y(i,n.clusterRadius,_,n.fields,c,l)}constructor(i,n,a,c,l,d){super(l,d,a.spatialReference,a.fields),this._connection=i,this._clusterRadius=n,this._indexOptions=a,this._cellsPerScale=new Map,this._metadata=new ee.i({geometryType:"esriGeometryPoint",objectIdField:"aggregateId",fields:[...c,...this._source.metadata.fieldsIndex.fields,{name:"aggregateId",alias:"aggregateId",type:"esriFieldTypeOID"}],globalIdField:null,spatialReference:l.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}get enablePixelBuffering(){return!1}invalidate(){super.invalidate();for(const i of this._cellsPerScale.values())i.destroy();this._cellsPerScale.clear()}onSubscribe(i){super.onSubscribe(i),this._requiredLevel=i.tile.level,this._requiredScale=i.tile.scale}createState(i){return new ClusterStrategy_(i)}async*applyOverride(i){for(const n of this._cellsPerScale.values())n.destroy();this._cellsPerScale.clear();for(const n of this._sendStates.values())n.done=!1}displayMap(i,n,a){const c=new Map(i.map((i=>[n(i),i]))),l=[],d=this._getClusterState(this._requiredLevel,this._requiredScale);for(const h of d.clusters()){const i=c.get(h.inner.id);if(null==i){if(1===h.inner.count){const i=c.get(h.inner.firstObjectId);if(null!=i){const n=a(h.displayId,i,h.inner.firstObjectId);l.push(n),c.delete(h.inner.firstObjectId)}}}else{const n=a(h.displayId,i,h.inner.id);l.push(n),c.delete(h.inner.id)}}return l}getDisplayFeatures(i){const n=new Set(i),a=new Set,c=[],l=[],d=this._getClusterState(this._requiredLevel,this._requiredScale);for(const h of d.aggregatesWorldSpace())if(n.has(h.displayId)&&!a.has(h.displayId)){const i=(0,U.oN)(h,this._metadata.geometryType,!1,!1);if(a.add(h.displayId),1===i.attributes.cluster_count){c.push({...i,displayId:h.displayId});continue}l.push({...i,displayId:h.displayId})}return{features:c,aggregates:l}}getFeatureObjectIdsForAggregate(i){const n=this._getClusterState(this._requiredLevel,this._requiredScale);for(const a of n.clusters())if(a.inner.id===i)return Array.from(a.inner.objectIds);return[]}async*updateChunks(){const i=this._source.chunks();if(!i.length)return;const n=this._getClusterState(this._requiredLevel,this._requiredScale);if(n.updateChunks(i)||!this._source.updateTracking.updating)for(const l of this._sendStates.values())l.subscription.tile.level===this._requiredLevel&&(l.didSend=!1,l.done=!1);const a=Array.from(this._sendStates.values()).filter((i=>i.done)).map((i=>i.subscription.tile.key)),c=new Set(a);for(const l of this._sendStates.values()){if(this._source.updateTracking.updating){if(a.some((i=>i.containsChild(l.subscription.tile.key))))continue;if(l.subscription.tile.key.getChildKeys().every((i=>c.has(i))))continue}l.didSend||l.subscription.tile.level!==this._requiredLevel||(l.didSend=!0,yield*this._update(l,n,this._source))}await n.updateStatistics(this._connection)}forEachAggregateWorldSpace(i){if(null==this._requiredLevel||null==this._requiredScale)return;const n=this._getClusterState(this._requiredLevel,this._requiredScale);for(const a of n.aggregatesWorldSpace())i(a)}_getClusterState(i,n){if(null==i||null==n)throw new Error("InternalError: Level and scale must be defined");let a=this._cellsPerScale.get(n);return a||(a=new ClusterStrategy_m(i,n,this._indexOptions,this._clusterRadius,this._attributeStore),this._cellsPerScale.set(n,a)),a}async*_update(i,n,a){if(i.done)return;const c=n.createAggregateFeatures(i,this._metadata);this.events.emit("changed"),i.done=!a.updateTracking.updating;const l=c.getCursor(),d=i.subscription.tile.createArcadeEvaluationOptions(this._indexOptions.timeZone);for(;l.next();)this._attributeStore.setAttributeData(l.getDisplayId(),l,d);const h=new FeatureSourceMessage_e(i.subscription,c,!0,i.done,{});yield h}}var ue=a(71055);class FeatureSpatialIndex_t{static fromReader(i){const n=[],a=i.copy(),c=(0,J.vt)();for(;a.next();)a.getBounds(c)&&n.push(a.getIndex());const l=(0,ue.r)(9,(i=>(a.setIndex(i),{minX:a.getBoundsXMin(),minY:a.getBoundsYMin(),maxX:a.getBoundsXMax(),maxY:a.getBoundsYMax()})));return l.load(n),new FeatureSpatialIndex_t(l)}constructor(i){this._index=i}search(i){const n={minX:i[0],minY:i[1],maxX:i[2],maxY:i[3]};return this._index.search(n)}}class GeohashTree_a{static create(i,n,a,c){const l=AccumulatedStatistics_s.create(i),d=new Array(32);for(let h=0;h<d.length;h++)d[h]=null;return new GeohashTree_a(l,n,a,c,d)}constructor(i,n,a,c,l){this._statistics=i,this.xNode=n,this.yNode=a,this.depth=c,this.children=l,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}get id(){return"".concat(this.xNode,".").concat(this.yNode)}get objectIds(){return this._objectIds}clone(){const i=new GeohashTree_a(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return i._count=this._count,i._xWorldTotal=this._xWorldTotal,i._yWorldTotal=this._yWorldTotal,i._xGeohashTotal=this._xGeohashTotal,i._yGeohashTotal=this._yGeohashTotal,i.next=this.next,i.cachedFeature=this.cachedFeature,i._objectIds=new Set(this._objectIds),i}insert(i,n,a,c,l,d){this._count+=1,this._xWorldTotal+=n,this._yWorldTotal+=a,this._xGeohashTotal+=c,this._yGeohashTotal+=l,this._statistics.insert(i,d),this._objectIds.add(i.getObjectId())}merge(i){if(0!==i._count){this._count+=i._count,this._xWorldTotal+=i._xWorldTotal,this._yWorldTotal+=i._yWorldTotal,this._xGeohashTotal+=i._xWorldTotal,this._yGeohashTotal+=i._yWorldTotal,this._statistics.merge(i._statistics);for(const n of i._objectIds.values())this._objectIds.add(n)}}getGeometry(i,n){const a=this._getLngLatBounds(),[c,l,d,h]=a,_=(0,V.Cv)({rings:[[[c,l],[c,h],[d,h],[d,l],[c,l]]]},P.A.WGS84,i),p=(0,U.Ye)(new re.A,_,!1,!1);return null!=n?(0,U.Nl)(new re.A,p,!1,!1,"esriGeometryPolygon",n,!1,!1):p}getGeometryCentroid(i,n){const a=this._getLngLatBounds(),[c,l,d,h]=a,_=(0,V.Cv)({x:(c+d)/2,y:(l+h)/2},P.A.WGS84,i),p=(0,U.qN)(new re.A,_);return null!=n?(0,U.Nl)(new re.A,p,!1,!1,"esriGeometryPoint",n,!1,!1):p}getAttributes(){const i={aggregateId:this.id};for(const n of this._statistics.values())i[n.field.name]=n.value;return i.aggregateCount=this._count,i}_getLngLatBounds(){const i=this.depth,n=Math.ceil(i/2),a=Math.floor(i/2),c=30-(3*n+2*a),l=30-(2*n+3*a),d=this.xNode<<c,h=this.yNode<<l;return(0,G.Hq)({geohashX:d,geohashY:h},this.depth)}}class GeohashTree_l{constructor(i){this._fields=i,this._root=GeohashTree_a.create(this._fields,0,0,0)}destroy(){}insert(i,n,a,c,l,d,h){let _=this._root,p=0,g=0,m=0;for(;null!==_;){if(_.insert(i,n,a,c,l,h),p>=d)return;const F=Math.ceil((p+1)/2),x=Math.floor((p+1)/2),T=1-p%2,k=30-(3*F+2*x),M=30-(2*F+3*x),O=(c&7*T+3*(1-T)<<k)>>k,P=(l&3*T+7*(1-T)<<M)>>M,q=O+P*(8*T+4*(1-T));g=g<<3*T+2*(1-T)|O,m=m<<2*T+3*(1-T)|P,null==_.children[q]&&(_.children[q]=GeohashTree_a.create(this._fields,g,m,p+1)),p+=1,_=_.children[q]}}putBins(i,n){for(const a of this.getNodes(n)){const n=i.get(a.id);n?n.merge(a):i.set(a.id,a.clone())}}getNodes(i){const n=[],{geohashBounds:a,level:c}=i;let l=this._root;for(;null!==l;){const i=l.depth,d=l.xNode,h=l.yNode;if(i>=c){n.push(l),l=l.next;continue}const _=Math.ceil((i+1)/2),p=Math.floor((i+1)/2),g=1-i%2,m=30-(3*_+2*p),F=30-(2*_+3*p),x=~((1<<m)-1),T=~((1<<F)-1),k=(a.xLL&x)>>m,M=(a.yLL&T)>>F,O=(a.xTR&x)>>m,P=(a.yTR&T)>>F,q=d<<3*g+2*(1-g),E=h<<2*g+3*(1-g),D=q+8*g+4*(1-g),N=E+4*g+8*(1-g),B=Math.max(q,k),G=Math.max(E,M),U=Math.min(D,O),j=Math.min(N,P);let V=null,Q=null;for(let n=G;n<=j;n++)for(let i=B;i<=U;i++){const a=i-q+(n-E)*(8*g+4*(1-g)),c=l.children[a];c&&(V||(V=c,V.next=l.next),Q&&(Q.next=c),Q=c,c.next=l.next)}l=V||l.next}return n}}class GeohashSpatialIndex_o{constructor(i){this._options=i,this._tree=new GeohashTree_l(i.fields)}insert(i,n){const a=i.getCursor(),c={$view:{scale:0,timeZone:this._options.timeZone}};for(;a.next();)this._insertFeature(a,c,n)}putBins(i,n){this._tree.putBins(i,n)}_insertFeature(i,n,a){const{featureFilter:c,geohashLevel:l,spatialReference:d}=this._options;if(null!==c&&!c.check(i))return;let h=0,_=0;if("esriGeometryPoint"===i.geometryType)h=i.readXWorldSpace(),_=i.readYWorldSpace();else{if(a){const n=i.readCentroidForDisplay();if(null==n)return;const[a,c]=n.coords;if(a<0||a>k.CQ||c<0||c>k.CQ)return}const n=i.readCentroidWorldSpace();if(null==n)return;h=n.coords[0],_=n.coords[1]}const p=(0,G.m_)(h,_,l,d);p&&this._tree.insert(i,h,_,p[0],p[1],l,n)}}class FeatureSetReaderIndirect_s extends se.Y{static from(i,n){return new FeatureSetReaderIndirect_s(i.copy(),n)}constructor(i,n){super(i.metadata),this._currentIndex=-1,this._displayTranslationX=0,this._displayTranslationY=0,this._displayScaleX=1,this._displayScaleY=1,this._reader=i,this._indices=n,this._isPoint="esriGeometryPoint"===i.geometryType}setTransformForDisplay(i){const n=this._reader.getInTransform();if(null==n){const[n,a]=i.scale,[c,l]=i.translate;return this._displayTranslationX=-c/n,this._displayScaleX=1/n,this._displayTranslationY=l/a,this._displayScaleY=1/-a,void(this._displayTransform=i)}const[a,c]=n.scale,[l,d]=n.translate,[h,_]=i.scale,[p,g]=i.translate;if(this._displayScaleX=a/h,this._displayTranslationX=(l-p)/h,this._displayScaleY=c/_,this._displayTranslationY=(-d+g)/_,!this._isPoint&&n)throw new Error("InternalError: Relative transformations not supported for non-point features");this._displayTransform=i}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const i=new FeatureSetReaderIndirect_s(this._reader.copy(),this._indices);return i._currentIndex=this._currentIndex,i._displayTransform=this._displayTransform,i._displayTranslationX=this._displayTranslationX,i._displayTranslationY=this._displayTranslationY,i._displayScaleX=this._displayScaleX,i._displayScaleY=this._displayScaleY,i}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._reader.readXForDisplay()*this._displayScaleX+this._displayTranslationX}readYForDisplay(){return this._reader.readYForDisplay()*this._displayScaleY+this._displayTranslationY}readGeometryForDisplay(){const i=this._reader.readGeometryForDisplay();if(!this._displayTransform)return i;const n=new re.A;return(0,U.Nl)(n,i,this.hasZ,this.hasM,this.geometryType,this._displayTransform),n.deltaDecode()}readCentroidForDisplay(){var i;const n=null===(i=this._reader.readCentroidForDisplay())||void 0===i?void 0:i.clone();if(n){const[i,a]=n.coords;n.coords[0]=i*this._displayScaleX+this._displayTranslationX,n.coords[1]=a*this._displayScaleY+this._displayTranslationY}return n}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(i){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._reader.readAttribute(i,n)}readAttributes(){return this._reader.readAttributes()}joinAttributes(i){return this._reader.joinAttributes(i)}getBounds(i){return this._reader.getBounds(i)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(i){return this._reader.setDisplayId(i)}setIndex(i){return this._reader.setIndex(i)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){return this._reader.readLegacyFeatureForDisplay()}readLegacyGeometryForDisplay(){return this._reader.readLegacyGeometryForDisplay()}readGeometryArea(){return this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(i,n){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(i){return this.readAttribute(i,!0)}hasField(i){return this._reader.hasField(i)}setField(i,n){return this._reader.setField(i,n)}keys(){return this._reader.keys()}castToText(){let i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._reader.castToText(i)}}class ASourceChunk_r{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._geohashIndex=null,this._geohashIndexHash=null,this._spatialIndex=null,this._gridIndex=null,this._gridIndexHash=null}queryFeaturesInBounds(i){const n=this._getSpatialIndex().search(i);return FeatureSetReaderIndirect_s.from(this.reader,n)}getGeohashIndex(i){const n=JSON.stringify(i);return n!==this._geohashIndexHash&&(this._geohashIndexHash=n,this._geohashIndex=new GeohashSpatialIndex_o(i),this._geohashIndex.insert(this.reader,this.isTiled)),this._geohashIndex}getGridIndex(i){const n=JSON.stringify(i);return n!==this._gridIndexHash&&(this._gridIndexHash=n,this._gridIndex=new GridSpatialIndex_r(i),this._gridIndex.insert(this.reader,this.isTiled)),this._gridIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=FeatureSpatialIndex_t.fromReader(this.reader)),this._spatialIndex}}class OverrideChunk_t extends ASourceChunk_r{constructor(){super(...arguments),this.chunkId="override",this.normalizedChunkId="override",this.removed=new Set,this.overridenIds=new Set,this._features=[]}get reader(){var i;return FeatureSetReaderJSON_u.fromOptimizedFeatures(this._features,null!==(i=this._layerSchema)&&void 0!==i?i:{fields:[]})}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}applyOverrides(i){super.invalidate(),this._layerSchema||(this._layerSchema=i.reader.fullSchema());const{reader:n,removed:a}=i,c=[],l=new Set,d=n.getCursor(),h=new Set(a);for(this.overridenIds.clear();d.next();){const i=d.readOptimizedFeatureWorldSpace(),n=i.objectId;c.push(i),l.add(n),this.overridenIds.add(n),this.removed.delete(n)}for(const _ of this._features){const i=_.objectId;h.has(i)||l.has(i)||(c.push(_),this.overridenIds.add(i))}this._features=c;for(const _ of l.values())this.removed.delete(_);for(const _ of a)this.removed.add(_),this.overridenIds.add(_)}getTileReader(i){if(!this._features.length)return null;const n=this.queryFeaturesInBounds(i.bounds);return n.setTransformForDisplay(i.transform),n}}class FeatureUpdateStrategy_o extends t{}class FeatureUpdateStrategy_a extends AProcessorStrategy_e{constructor(i,n,a){super(i,n),this._timeZone=a,this.handledChunks=new Set,this.handledChunksForIdCreation=new Set,this.handledChunksForAttributeData=new Set}destroy(){super.destroy();for(const i of this._source.chunks())this._cleanupChunkIds(i)}invalidateAttributeData(){this.handledChunksForAttributeData.clear()}onSubscribe(i){super.onSubscribe(i),this._evalOptions=i.tile.createArcadeEvaluationOptions(this._timeZone)}createState(i){return new FeatureUpdateStrategy_o(i)}get aggregateQueryEngine(){return null}displayMap(i,n,a){const c=new Map(i.map((i=>[n(i),i]))),l=[];for(const d of this._source.chunks()){const i=d.reader.getCursor();for(;i.next();){const n=i.getObjectId(),d=i.getDisplayId(),h=c.get(n);if(null!=h){const i=a(d,h,n);l.push(i),c.delete(n)}}}return l}getDisplayFeatures(i){const n=new Set(i),a=new Set,c=[];for(const l of this._source.chunks()){const i=l.reader.getCursor();for(;i.next();){const l=i.getObjectId(),d=i.getDisplayId();n.has(d)&&!a.has(l)&&(c.push({...i.readLegacyFeatureWorldSpace(),displayId:d}),a.add(l))}}return{features:c,aggregates:[]}}async*applyOverride(i){const n=[],a=i.reader.getCursor();for(;a.next();){const i=a.getObjectId();n.push(i);const c=this._attributeStore.createDisplayIdForObjectId(i);a.setDisplayId(c),this._attributeStore.setAttributeData(c,a,this._evalOptions)}const c=this.getDisplayIds(n),l=this.getDisplayIds(i.removed),d=new OverrideChunk_t;d.applyOverrides(i);for(const h of this._sendStates.values())yield new FeatureSourceMessage_i(h.subscription,null,c,!1,d.queryInfo);for(const h of this._sendStates.values()){const i=d.getTileReader(h.subscription.tile);yield new FeatureSourceMessage_i(h.subscription,i,l,!1,d.queryInfo)}for(const h of i.removed)this._attributeStore.releaseDisplayIdForObjectId(h)}async*updateChunks(){if(this._source.chunks().length){await this._updateAttributeData();for(const i of this._sendStates.values())yield*this._update(i)}}removeChunks(i){for(const n of i)this.handledChunks.delete(n.chunkId),this.handledChunksForAttributeData.delete(n.chunkId),this._cleanupChunkIds(n)}_cleanupChunkIds(i){if(this.handledChunksForIdCreation.has(i.chunkId)){const n=i.reader.getCursor();for(;n.next();){const i=n.getObjectId();this._attributeStore.releaseDisplayIdForObjectId(i)}this.handledChunksForIdCreation.delete(i.chunkId)}}async _updateAttributeData(){for(const i of this._source.chunks()){const{chunkId:n,reader:a}=i;if(!this.handledChunksForIdCreation.has(n)){this.handledChunksForIdCreation.add(n);const i=a.getCursor();for(;i.next();){const n=this._attributeStore.createDisplayIdForObjectId(i.getObjectId());i.setDisplayId(n)}}}for(const i of this._source.chunks())if(!this.handledChunksForAttributeData.has(i.chunkId)){this.handledChunksForAttributeData.add(i.chunkId);const n=i.reader.getCursor();for(;n.next();){const i=n.getDisplayId();this._attributeStore.setAttributeData(i,n,this._evalOptions)}}}*_update(i){const{subscription:n,handledChunks:a}=i;for(const c of this._source.chunks()){const{chunkId:l}=c;if(a.has(l))continue;a.add(l);const d=c.getTileReader(n.tile);d&&(yield new FeatureSourceMessage_e(i.subscription,d,!1,c.end,c.queryInfo))}}}var ce=a(13869),le=a(73896);class Processor_l{constructor(i,n){this._connection=i,this._source=n,this._version=1,this._queue=new le.e({concurrency:1,process:i=>this._process(i)}),this._proxy=new B.J({fetch:(i,n)=>this._connection.layerView.fetch(i,n),fetchDictionary:(i,n)=>this._connection.layerView.fetchDictionary(i,n)}),this._attributeStore=new ce.K({isLocal:!1,update:i=>(0,_.QZ)(this._connection.container.updateAttributeView(i))})}destroy(){var i;this._proxy.destory(),null!==(i=this._strategy)&&void 0!==i&&i.destroy(),this._attributeStore.destroy()}get aggregateQueryEngine(){var i;return null===(i=this._strategy)||void 0===i?void 0:i.aggregateQueryEngine}getDisplayFeatures(i){return this._strategy?this._strategy.getDisplayFeatures(i):{features:[],aggregates:[]}}getFeatureObjectIdsForAggregate(i){return this._strategy?this._strategy.getFeatureObjectIdsForAggregate(i):[]}onSubscribe(i){var n;null===(n=this._strategy)||void 0===n||n.onSubscribe(i)}onUnsubscribe(i){var n;null===(n=this._strategy)||void 0===n||n.onUnsubscribe(i)}async update(i,n,a,c,l){var h;const _=i.processor,p=(0,O.Ui)(this._schema,_);if(!p&&!c)return;(0,d.A)("esri-2d-update-debug")&&console.debug("Version[".concat(this._version,"] SymbolProcessor.update"),{changes:p,schema:_}),this._schema=_;const g=P.A.fromJSON(i.source.mutable.dataFilter.outSpatialReference),m=new K.l({fields:this._source.metadata.fieldsIndex,spatialReference:g});return await this._attributeStore.update(_.storage,m,this._source.metadata,g,n),null!==(h=this._strategy)&&void 0!==h&&h.invalidateAttributeData(),c||(0,O.EB)(p,"mesh")?((0,O.EB)(p,"mesh.strategy")&&await this._updateStrategy(_.mesh.strategy,g,l,_.mesh.timeZone),this._updateSortKey(m,"sortKey"in _.mesh?_.mesh.sortKey:null),((0,O.EB)(p,"mesh.factory")||"dictionary"===_.mesh.factory.symbology.type)&&(this._factory=await FeatureMeshFactory_s.create(m,this._proxy,_.mesh.factory,a)),this._invalidate(),this._version=n,this._connection.container.updateRenderState(this._version)):void 0}async applyOverride(i){if(!this._strategy)return;const n=this._strategy.applyOverride(i);for await(const a of n)try{await this._process(a)}catch(s){}this._source.applyOverride(i)}async updateChunks(){return this._doUpdateChunks()}async removeChunks(i){var n;null!==(n=this._strategy)&&void 0!==n&&n.removeChunks(i),this._attributeStore.incrementDisplayIdGeneration()}updateHighlight(i){let{highlights:n}=i;if(!this._strategy)return void this._attributeStore.setHighlight(n.map((i=>{let{objectId:n,highlightFlags:a}=i;return{objectId:n,highlightFlags:a,displayId:-1}})),n);const a=this._strategy.displayMap(n,(i=>{let{objectId:n}=i;return n}),((i,n,a)=>{let{highlightFlags:c}=n;return{objectId:a,displayId:i,highlightFlags:c}}));this._attributeStore.setHighlight(a,n)}async _doUpdateChunks(){if(!this._strategy)return;const i=this._strategy.updateChunks(),n=[];for await(const a of i){const i=this._queue.push(a).catch((i=>(0,_.jH)(i)));n.push(i)}try{await Promise.all(n)}catch(r){}(0,d.A)("esri-2d-update-debug")&&console.log("SendUpdates"),await this._attributeStore.sendUpdates(),(0,d.A)("esri-2d-update-debug")&&console.log("SendUpdates.await")}async _updateStrategy(i,n,a,c){var l;switch(null!==(l=this._strategy)&&void 0!==l&&l.destroy(),i.type){case"feature":this._strategy=new FeatureUpdateStrategy_a(this._source,this._attributeStore,c);break;case"binning":this._strategy=await BinningStrategy_g.create(i,n,this._source,this._attributeStore,c);break;case"cluster":this._strategy=await ClusterStrategy_y.create(this._connection,i,n,this._source,this._attributeStore,c)}for(const d of a)this._strategy.onSubscribe(d)}async _updateSortKey(i,n){var a;if(this._sortInfo=(0,M.pR)(null===(a=this._sortInfo)||void 0===a?void 0:a.computed),null!=n){const a=n.byRenderer?null:await i.createComputedField(n);this._sortInfo={...n,computed:a}}}_invalidate(){this._strategy&&this._strategy.invalidate()}async _process(i){const n=i.subscription;if((0,d.A)("esri-2d-update-debug")){const a=n.tile;console.debug("Version[".concat(this._version,"] Tile[").concat(a.key.id,", end=").concat(i.end,"] Processor._process"))}await this._fetchResources(i),(0,_.Te)(n.signal);const a=await this._write(i,n.tile.createArcadeEvaluationOptions(this._schema.mesh.timeZone)),c=n.tile.tileInfoView.tileInfo.isWrappable,{message:l,transferList:h}=a.serialize(c),p=i.createMessage(l,this._version,this._attributeStore.epoch);if((0,_.Te)(n.signal),await this._connection.container.onMessage(p,{signal:n.signal,transferList:h}),await this._attributeStore.sendUpdates(),(0,d.A)("esri-2d-update-debug")){const a=n.tile;console.debug("Version[".concat(this._version,"] Tile[").concat(a.key.id,", end=").concat(i.end,"] Processor._process.await"))}}async _fetchResources(i){await this._fetchMatcherResources(i),await this._fetchWriterResources(i)}async _fetchMatcherResources(i){if(i.reader)return this._factory.enqueueMatcherRequests(this._proxy,i.reader)}async _fetchWriterResources(i){if(!i.reader)return;const n=i.reader.getCursor(),a=i.subscription.tile.createArcadeEvaluationOptions(this._schema.mesh.timeZone);for(;n.next();)this._factory.enqueueWriterRequests(this._proxy,n,a);await this._proxy.fetchEnqueuedResources()}async _write(i,n){var a,c;const l=i.subscription.tile,d=null===(a=i.reader)||void 0===a?void 0:a.getCursor(),h=null!==(c=null===d||void 0===d?void 0:d.getSize())&&void 0!==c?c:0,_=new y(l.key.id,this._strategy.enablePixelBuffering,h);if(!d)return _;const p=l.createArcadeEvaluationOptions(this._schema.mesh.timeZone);for(;d.next();){const i=this._getSortKeyValue(d,n);_.entityStart(d.getDisplayId(),i),this._factory.write(_,this._proxy,d,p,l.level),_.entityEnd()}return _}_getSortKeyValue(i,n){if(!this._sortInfo)return 0;const{computed:a,order:c,byRenderer:l}=this._sortInfo,d=l?this._factory.getSortKey(i,n):null===a||void 0===a?void 0:a.read(i,n);return null==d||isNaN(d)?0:d*("asc"===c?-1:1)}}var de=a(53705),he=a(83947);class FeatureStoreStatistics_t{static from(i){let n=0,a=0,c=0;return i.forEach((i=>{const l=i._readGeometry();l&&(a+=l.isPoint?1:l.lengths.reduce(((i,n)=>i+n),0),c+=l.isPoint?1:l.lengths.length,n+=1)})),new FeatureStoreStatistics_t(n,a,c)}constructor(i,n,a){this.featureCount=i,this.vertexCount=n,this.ringCount=a}toJSON(){return{featureCount:this.featureCount,ringCount:this.featureCount,vertexCount:this.featureCount}}}var _e=a(94631),pe=a(49096);class FeatureSourceQueryInfo_o{static fromSchema(i,n){return new FeatureSourceQueryInfo_o(function FeatureSourceQueryInfo_a(i,n){var a,c,l;const{service:d}=i,h=null!==(a=d.orderByFields)&&void 0!==a?a:n.objectIdField+" ASC",_={returnCentroid:"esriGeometryPolygon"===n.geometryType,returnGeometry:!0,timeReferenceUnknownClient:null!==(c=n.timeReferenceUnknownClient)&&void 0!==c?c:void 0,outSpatialReference:P.A.fromJSON(i.mutable.dataFilter.outSpatialReference),orderByFields:[h],where:null!==(l=i.mutable.dataFilter.definitionExpression)&&void 0!==l?l:"1=1",outFields:i.mutable.availableFields};if("feature"===i.type){const{gdbVersion:n,historicMoment:a,timeExtent:c}=i.mutable.dataFilter;return{..._,gdbVersion:n,historicMoment:a?new Date(a):null,timeExtent:c?_e.A.fromJSON(c):null,outFields:i.mutable.availableFields}}return _}(i,n),i.mutable.dataFilter.customParameters,n.geometryType,i.service.queryMetadata.capabilities)}constructor(i,n,a,c){this._queryParams=i,this._customParameters=n,this._geometryType=a,this._capabilities=c}get pageSize(){var i;if(null==this._capabilities)throw new Error("InternalError: Service does not support paged queries");const{query:n}=this._capabilities,a=n.supportsMaxRecordCountFactor?4:null,c=(null!==(i=n.maxRecordCount)&&void 0!==i?i:8e3)*(null!==a&&void 0!==a?a:1);return Math.min(8e3,c)}updateFields(i){this._queryParams.outFields=i}createPatchFieldsQuery(i,n){const a=i.clone();if("*"===this._queryParams.outFields[0]){var c;if("*"===(null!==(c=a.outFields)&&void 0!==c?c:[])[0])return null;a.outFields=this._queryParams.outFields}else{const i=new Set(this._queryParams.outFields),c=[];for(const a of i)n.has(a)||c.push(a);if(0===c.length)return null;a.outFields=c}return a.returnGeometry=!1,a.returnCentroid=!1,a.quantizationParameters=null,a.cacheHint=!0,{inner:a,customParameters:this._customParameters}}createQuery(){let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._queryParams)throw new Error("InternalError: queryInfo should be defined");return{inner:new pe.A({...this._queryParams,...i}),customParameters:this._customParameters}}createTileQuery(i,n){var a;if(null==this._capabilities)throw new Error("InternalError: Service does not support tile queries");const c=this.createQuery(n),l=c.inner;return l.quantizationParameters=null!==(a=n.quantizationParameters)&&void 0!==a?a:i.getQuantizationParameters(),l.resultType="tile",l.geometry=i.extent,this._capabilities.query.supportsQuantization?"esriGeometryPolyline"===this._geometryType&&(l.maxAllowableOffset=i.resolution*(0,d.A)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==this._geometryType&&"esriGeometryPolygon"!==this._geometryType||(l.maxAllowableOffset=i.resolution,"esriGeometryPolyline"===this._geometryType&&(l.maxAllowableOffset*=(0,d.A)("feature-polyline-generalization-factor"))),l.defaultSpatialReferenceEnabled=this._capabilities.query.supportsDefaultSpatialReference,l.compactGeometryEnabled=this._capabilities.query.supportsCompactGeometry,this._capabilities.query.supportsMaxRecordCountFactor&&(l.maxRecordCountFactor=4),c}createPagedTileQuery(i,n){const a=this.pageSize;return this.createTileQuery(i,{start:a*n,num:a,returnExceededLimitFeatures:!0})}createPagedQuery(i){const n=this.pageSize;return this.createQuery({start:n*i,num:n,returnExceededLimitFeatures:!0,maxRecordCountFactor:4})}}var ge=a(80671),fe=a(18763),ye=a(57453),me=a(89412),Se=a(68682);let ve=class extends fe.A{constructor(i){super(),this._connection=i,this._enabledEventTypes=new Set,this._updateInfo={websocket:0,client:0},this._lastTime=performance.now(),this.addHandles([(0,g.wB)((()=>{var i,n;return null!==(i=null===(n=this._strategy)||void 0===n?void 0:n.connectionStatus)&&void 0!==i?i:"disconnected"}),(i=>{this._layerView.setProperty({propertyName:"pipelineConnectionStatus",value:i})}),{initial:!0}),(0,g.wB)((()=>{var i;return(null===(i=this._strategy)||void 0===i?void 0:i.errorString)||null}),(i=>this._layerView.setProperty({propertyName:"pipelineErrorString",value:i})),{initial:!0})])}destroy(){this._strategy=null,this.removeAllHandles()}get _layerView(){return this._connection.layerView}set strategy(i){null==this._strategy&&this._resetUpdateInfo(performance.now());const n="event-handles";this.removeHandles(n),null!=i&&this.addHandles([i.events.on("data-received",(i=>this._onFeature(i))),i.events.on("message-received",(i=>this._onWebSocketMessage(i))),i.events.on("features-updated",(i=>this._onUpdate(i))),i.events.on("tick",(()=>this._onTick()))],n),this._strategy=i}updateCustomParameters(i){var n;null!=i&&(null===(n=this._strategy)||void 0===n||n.updateCustomParameters(i))}sendMessageToSocket(i){var n;null===(n=this._strategy)||void 0===n||n.sendMessageToSocket(i)}sendMessageToClient(i){var n;null===(n=this._strategy)||void 0===n||n.sendMessageToClient(i)}enableEvent(i,n){n?this._enabledEventTypes.add(i):this._enabledEventTypes.delete(i)}disconnect(){var i;null===(i=this._strategy)||void 0===i||i.disconnect()}connect(){var i;null===(i=this._strategy)||void 0===i||i.connect()}clear(){var i;null===(i=this._strategy)||void 0===i||i.clear()}_onWebSocketMessage(i){this._enabledEventTypes.has("message-received")&&this._layerView.emitEvent({name:"message-received",event:i})}_onFeature(i){this._updateInfo.websocket++,this._enabledEventTypes.has("data-received")&&this._layerView.emitEvent({name:"data-received",event:{attributes:i.attributes,centroid:i.centroid,geometry:i.geometry}})}_onUpdate(i){this._updateInfo.client+=i}_onTick(){const i=performance.now(),n=i-this._lastTime;if(n>2500){const a=Math.round(this._updateInfo.client/(n/1e3)),c=Math.round(this._updateInfo.websocket/(n/1e3));this._resetUpdateInfo(i),this._layerView.emitEvent({name:"update-rate",event:{client:a,websocket:c}})}}_resetUpdateInfo(i){this._lastTime=i,this._updateInfo.client=0,this._updateInfo.websocket=0}};(0,ge._)([(0,ye.MZ)()],ve.prototype,"_strategy",void 0),ve=(0,ge._)([(0,Se.$)("esri.views.2d.layers.features.sources.StreamMessenger")],ve);class ALoadStrategy_r{constructor(i){this._store=i,this._controller=new AbortController}destroy(){this._controller.abort()}get _options(){return{signal:this._controller.signal}}async queryOverride(i){throw new Error("InternalError: LoadStrategy does not support fetching")}}var be=a(92732),Ie=a(89343),we=a(95543),Fe=a(40954),xe=a(64429);const Ce=268435455;class FeatureSetReaderPBFHeader_o{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}}const Ae=268435455,Te=128e3,ke={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(Te),decoded:new Int32Array(Te)}};function FeatureSetReaderPBF_g(i){return i<=ke.small.delta.length?ke.small:(i<=ke.large.delta.length||(ke.large.delta=new Int32Array(Math.round(1.25*i)),ke.large.decoded=new Int32Array(Math.round(1.25*i))),ke.large)}function FeatureSetReaderPBF_f(i){for(;i.next();){if(1===i.tag())return i.getMessage();i.skip()}return null}function I(i,n,a,c,l,d){return.5*Math.abs(i*c+a*d+l*n-i*d-a*n-l*c)}function FeatureSetReaderPBF_p(i,n,a,c){return 0===i*c-a*n&&i*a+n*c>0}class FeatureSetReaderPBF_y extends se.Y{static fromBuffer(i,n){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const l=n.geometryType,d=function FeatureSetReaderPBF_l(i){try{const n=2,a=new Fe.A(new Uint8Array(i),new DataView(i));for(;a.next();){if(a.tag()===n)return FeatureSetReaderPBF_f(a.getMessage());a.skip()}}catch(d){const n=new c.A("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:d});me.A.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(n)}return null}(i),h=function FeatureSetReaderPBFHeader_a(i,n){var a;let l=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const d=i.asUnsafe(),h=d.pos(),_=new FeatureSetReaderPBFHeader_o;let p=0,g=0,m=null,F=null,x=null,T=!1;const k=[];for(;d.next();)switch(d.tag()){case 1:m=d.getString();break;case 3:F=d.getString();break;case 12:x=d.processMessage(xe.ae);break;case 9:if(_.exceededTransferLimit=d.getBool(),_.exceededTransferLimit){_.offsets.geometry=l?new Float64Array(8e3):new Int32Array(8e3),_.centroid=l?new Float64Array(16e3):new Int32Array(16e3);for(let i=0;i<_.centroid.length;i++)_.centroid[i]=Ce}break;case 13:{const i=d.processMessage(xe.cn);i.index=p++,k.push(i);break}case 15:{const i=d.getLength(),a=d.pos()+i;if(!_.exceededTransferLimit){const i=_.offsets.geometry,n=_.centroid;i.push(0),n.push(Ce),n.push(Ce)}!T&&_.exceededTransferLimit&&(T=!0,_.offsets.attributes=l?new Float64Array(8e3*p):new Uint32Array(8e3*p));let c=g*p;for(;d.pos()<a&&d.next();)switch(d.tag()){case 1:{T?_.offsets.attributes[c++]=d.pos():_.offsets.attributes.push(d.pos());const i=d.getLength();d.skipLen(i);break}case 2:if(n){const i=d.getLength(),n=d.pos()+i;for(;d.pos()<n&&d.next();)switch(d.tag()){case 3:{d.getUInt32();const i=d.getSInt64(),n=d.getSInt64();_.centroid[2*g]=i,_.centroid[2*g+1]=n;break}default:d.skip()}}else{_.offsets.geometry[g]=d.pos();const i=d.getLength();_.vertexCount+=i,d.skipLen(i)}break;case 4:{const i=d.getLength(),n=d.pos()+i;for(;d.pos()<n&&d.next();)switch(d.tag()){case 3:{d.getUInt32();const i=d.getSInt64(),n=d.getSInt64();_.centroid[2*g]=i,_.centroid[2*g+1]=n;break}default:d.skip()}break}default:d.skip()}g++,_.hasFeatures=!0;break}default:d.skip()}const M=m||F;if(!M)throw new c.A("FeatureSet has no objectId or globalId field name");return _.fields=new te.A(k),_.featureCount=g,_.fieldCount=p,_.objectIdFieldIndex=null===(a=_.fields.get(M))||void 0===a?void 0:a.index,_.transform=x,_.displayIds=new Uint32Array(_.featureCount),_.groupIds=new Uint16Array(_.featureCount),d.move(h),_}(d,"esriGeometryPoint"===l,a);return new FeatureSetReaderPBF_y(d,h,n)}constructor(i,n,a){super(a),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=a.geometryType,this._reader=i,this._header=n,this._hasNext=n.hasFeatures,this._isPoints="esriGeometryPoint"===a.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(i){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=i}getAttributeHash(){let i="";for(const n of this._header.fields.fields)i+=this._readAttributeAtIndex(n.index)+".";return i}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(i){this._header.displayIds[this._featureIndex]=i}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){const i=this._reader.clone(),n=new FeatureSetReaderPBF_y(i,this._header,this.metadata);return this.copyInto(n),n}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){const i=this._header.centroid[2*this._featureIndex],n=this._header.centroid[2*this._featureIndex+1];return i===Ae?null:new re.A([],[i,n])}_readGeometry(){let i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.geometry){var n;let a=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Ae)return null;const i=this._header.centroid[2*this._featureIndex],n=this._header.centroid[2*this._featureIndex+1];a=new re.A([],[i,n])}else{const n=this._header.offsets.geometry[this._featureIndex],c=this._reader;if(0===n)return null;c.move(n);try{a=i?this._parseGeometryForDisplay(c):this._parseGeometry(c)}catch(t){return console.error("Failed to parse geometry!",t),null}}return 0===(null===(n=a)||void 0===n?void 0:n.coords.length)&&(a=null),this._cache.geometry=a,a}return this._cache.geometry}_readAttribute(i,n){var a;const c=this._header.fields.get(i);if(null==c)return;let l=this._readAttributeAtIndex(c.index);"esriFieldTypeTimestampOffset"===(null===(a=this.fields.get(i))||void 0===a?void 0:a.type)&&(l=this.parseTimestampOffset(l));const d=this._header.fields.isDateField(c.name);return n?null==l?l:d?new Date(l):l:l}_readAttributes(){const i={};for(const n of this._header.fields.fields)i[n.name]=this._readAttributeAtIndex(n.index);return i}copyInto(i){super.copyInto(i),i._featureIndex=this._featureIndex,i._featureOffset=this._featureOffset,i._hasNext=this._hasNext}_readAttributeAtIndex(i){const n=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+i],a=this._reader;return a.move(n),function FeatureSetReaderPBF_(i){const n=i.getLength(),a=i.pos()+n;for(;i.pos()<a&&i.next();)switch(i.tag()){case 1:return i.getString();case 2:return i.getFloat();case 3:return i.getDouble();case 4:return i.getSInt32();case 5:return i.getUInt32();case 6:return i.getInt64();case 7:return i.getUInt64();case 8:return i.getSInt64();case 9:return i.getBool();default:return i.skip(),null}return null}(a)}_readGeometryDeltaDecoded(){let i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.unquantGeometry){const n=this._readGeometry(i);if(!n)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=n,n;const a=FeatureSetReaderPBF_g(n.coords.length).decoded,c=n.clone(a),l=c.coords;let d=0;for(const i of c.lengths){for(let n=1;n<i;n++){const i=2*(d+n),a=2*(d+n-1);l[i]+=l[a],l[i+1]+=l[a+1]}d+=i}return this._cache.unquantGeometry=c,c}return this._cache.unquantGeometry}_parseGeometry(i){const n=i.asUnsafe(),a=n.getLength(),c=n.pos()+a,l=[],d=[];for(;n.pos()<c&&n.next();)switch(n.tag()){case 2:{const i=n.getUInt32(),a=n.pos()+i;for(;n.pos()<a;)d.push(n.getUInt32());break}case 3:{const i=n.getUInt32(),a=n.pos()+i;for(l.push(n.getSInt64()),l.push(n.getSInt64()),this.hasZ&&n.getSInt64(),this.hasM&&n.getSInt64();n.pos()<a;)l.push(n.getSInt64()),l.push(n.getSInt64()),this.hasZ&&n.getSInt64(),this.hasM&&n.getSInt64();break}default:n.skip()}return new re.A(d,l)}_parseGeometryForDisplay(i){const n=i.asUnsafe(),a=n.getLength(),c=n.pos()+a,l=[],d=[];let h=0,_=0,p=null,g=0;const m="esriGeometryPolygon"===this.geometryType;for(;n.pos()<c&&n.next();)switch(n.tag()){case 2:{const i=n.getUInt32(),a=n.pos()+i;for(;n.pos()<a;){const i=n.getUInt32();l.push(i),h+=i}p=FeatureSetReaderPBF_g(2*h).delta;break}case 3:{n.getUInt32();const i=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,M.Lw)(p);for(const a of l)if(_+i*a>p.length)for(let i=0;i<a;i++)n.getSInt32(),n.getSInt32(),this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();else if(m){const i=this.getAreaSimplificationThreshold(a,this._header.vertexCount);let c=2,l=1;const h=!1;let m=n.getSInt32(),F=n.getSInt32();p[_++]=m,p[_++]=F,this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();let x=n.getSInt32(),T=n.getSInt32();for(this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();c<a;){let a=n.getSInt32(),d=n.getSInt32();this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32();const h=m+x,k=F+T;I(m,F,h,k,h+a,k+d)>=i?(g+=-.5*(h-m)*(k+F),l>1&&FeatureSetReaderPBF_p(p[_-2],p[_-1],x,T)?(p[_-2]+=x,p[_-1]+=T):(p[_++]=x,p[_++]=T,l++),m=h,F=k):(a+=x,d+=T),x=a,T=d,c++}l<3||h?_-=2*l:(g+=-.5*(m+x-m)*(F+T+F),FeatureSetReaderPBF_p(p[_-2],p[_-1],x,T)?(p[_-2]+=x,p[_-1]+=T,d.push(l)):(p[_++]=x,p[_++]=T,d.push(++l)))}else{let i=0,c=n.getSInt32(),l=n.getSInt32();this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32(),p[_++]=c,p[_++]=l,i+=1;for(let d=1;d<a;d++){const a=n.getSInt32(),h=n.getSInt32(),m=c+a,F=l+h;g+=-.5*(m-c)*(F+l),this.hasZ&&n.getSInt32(),this.hasM&&n.getSInt32(),d>2&&FeatureSetReaderPBF_p(p[_-2],p[_-1],a,h)?(p[_-2]+=a,p[_-1]+=h):(p[_++]=a,p[_++]=h,i+=1),c=m,l=F}d.push(i)}break}default:n.skip()}return this._cache.area=g,d.length?new re.A(d,p):null}}class queryAdapters_c{constructor(i,n){this.service=i,this._metadata=n}destroy(){}}class queryAdapters_l extends queryAdapters_c{constructor(i,n){super(i,n),this._portsOpen=async function queryAdapters_p(i){const n=new be.A;return await n.open(i,{}),n}(i.source).then((i=>this.client=i))}destroy(){this.client.close(),this.client=null}async executeQuery(i,n){await this._portsOpen;const a=await this.client.invoke("queryFeatures",i.toJSON(),n);return FeatureSetReaderJSON_u.fromFeatureSet(a,this._metadata)}}class queryAdapters_y extends queryAdapters_c{async executeQuery(i,n){const{data:a}=await(0,he.kS)(this.service.source,i,n),c=!i.quantizationParameters;return FeatureSetReaderPBF_y.fromBuffer(a,this._metadata,c)}}class queryAdapters_d extends queryAdapters_c{async executeQuery(i,n){var a;const{source:c,queryMetadata:l}=this.service,d=l.capabilities;if(null!=i.quantizationParameters&&!d.query.supportsQuantization){const a=i.clone(),l=(0,Ie.VV)(a.quantizationParameters);a.quantizationParameters=null;const{data:d}=await(0,he.eW)(c,a,this._metadata.spatialReference,n),h=(0,U.q3)(d,this._metadata.objectIdField);return(0,U.jH)(l,h),FeatureSetReaderJSON_u.fromOptimizedFeatureSet(h,this._metadata)}const{data:h}=await(0,he.eW)(c,i,this._metadata.spatialReference,n);return"esriGeometryPoint"===this._metadata.geometryType&&(h.features=null===(a=h.features)||void 0===a?void 0:a.filter((i=>{if(null!=i.geometry){const n=i.geometry;return Number.isFinite(n.x)&&Number.isFinite(n.y)}return!0}))),FeatureSetReaderJSON_u.fromFeatureSet(h,this._metadata)}}class queryAdapters_f extends queryAdapters_c{async executeQuery(i,n){const{capabilities:a}=this.service.queryMetadata;if(i.quantizationParameters&&!a.query.supportsQuantization){const a=i.clone(),c=(0,Ie.VV)(a.quantizationParameters);a.quantizationParameters=null;const l=await(0,we.I)(this.service.source,i,n);return(0,U.jH)(c,l),FeatureSetReaderJSON_u.fromOptimizedFeatureSet(l,this._metadata)}const c=await(0,we.I)(this.service.source,i,n);return FeatureSetReaderJSON_u.fromOptimizedFeatureSet(c,this._metadata)}}class AFetchLoadStrategy_n extends ALoadStrategy_r{constructor(i,n,a,c,l){super(a),this._serviceInfo=i,this._queryInfo=n,this._metadata=c,this._eventLog=l,this._queue=new le.e({concurrency:8,process:async i=>{var n;const a={signal:null===(n=i.options)||void 0===n?void 0:n.signal,query:i.query.customParameters};return this._adapter.executeQuery(i.query.inner,a)}}),this._adapter=function queryAdapters_m(i,n){switch(i.type){case"memory":return new queryAdapters_l(i,n);case"ogc":return new queryAdapters_f(i,n);case"feature-service":return i.queryMetadata.capabilities.query.supportsFormatPBF&&(0,d.A)("featurelayer-pbf")?new queryAdapters_y(i,n):new queryAdapters_d(i,n)}}(i,c)}async updateFields(i){this._queryInfo.updateFields(i);const n=Array.from(this._store.chunks()).map((async i=>{const a=pe.A.fromJSON(i.queryInfo.queryJSON);if(a)try{return await this._tryUpdateFields(i.reader,a),null}catch(n){return n}})),a=(await Promise.all(n)).filter((i=>i));if(a.length)throw new c.A("featurelayer-query","Encountered errors when downloading fields",{errors:a})}async queryOverride(i){let{edits:n}=i;const a=[],c=[];for(const h of n.removed)null!=h.objectId&&-1!==h.objectId?a.push(h.objectId):c.push(h.globalId);c.length&&a.push(...this._mapGlobalIdsToObjectIds(c));const l=n.addOrModified.map((i=>{let{objectId:n}=i;return n})),d=this._queryInfo.createQuery({objectIds:l});return{reader:await this._fetch(d),removed:a}}_mapGlobalIdsToObjectIds(i){const n=new Set(i),a=this._metadata.globalIdField;if(null==a)throw new Error("InternalError: Recieved an edit with globalIds, but not supported by the service");const c=[];return this._store.forEachUnsafe((i=>{const l=i.readAttribute(a);n.has(l)&&c.push(i.getObjectId())})),c}async _fetch(i,n){const a=await this._enqueue(i,n);return await this._tryUpdateFields(a,i.inner),a}async _tryUpdateFields(i,n){const a=this._queryInfo.createPatchFieldsQuery(n,i.fields);if(!a)return;const c=await this._enqueue(a,this._options);i.joinAttributes(c)}async _enqueue(i,n){return this._eventLog.onEvent({type:"fetchStart"}),this._queue.push({query:i,options:n}).finally((()=>{this._eventLog.onEvent({type:"fetchEnd",done:0===this._queue.length})}))}}class ATileLoadStrategy_s extends AFetchLoadStrategy_n{constructor(){super(...arguments),this._chunksById=new Map}unload(i){this._removeChunks(i.tile)}_addChunk(i){const n=i.tile.id;this._chunksById.has(n)||this._chunksById.set(n,[]);const a=i.size();(a||i.first||i.end)&&((0,d.A)("esri-2d-update-debug")&&console.debug("Chunk[".concat(i.chunkId,"] ATileLoadStrategy.addChunk [count=").concat(a,"]")),this._chunksById.get(n).push(i),this._store.insert(i))}_removeChunks(i){var n;const a=null!==(n=this._chunksById.get(i.key.id))&&void 0!==n?n:[];for(const c of a)(0,d.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(i.key.id,"] Chunk[").concat(c.chunkId,"] ATileLoadStrategy.removeChunk")),this._store.remove(c);this._chunksById.delete(i.key.id)}}class DrillDownTileSourceChunk_i extends ASourceChunk_r{constructor(i,n,a,c,l,d){var h,_;super(),this._reader=i,this._queryJSON=n,this._tile=a,this._sourceTile=c,this._sourceTileDepth=l,this._end=d,this.chunkId="".concat(this._tile.key.id,".").concat(null===(h=this._sourceTile)||void 0===h?void 0:h.key.id).concat(this._end?"e":""),this.normalizedChunkId="".concat(this._tile.key.normalizedId,".").concat(null===(_=this._sourceTile)||void 0===_?void 0:_.key.normalizedId).concat(this._end?"e":"")}get queryInfo(){var i;return{type:"drill-down-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,sourceTileDepth:this._sourceTileDepth,sourceTileId:null===(i=this._sourceTile)||void 0===i?void 0:i.key.id,size:this.size(),end:this.end}}get first(){return 0===this._sourceTileDepth}get reader(){return this._reader}get end(){return this._end}get tile(){return this._tile}get isTiled(){return!0}getTileReader(i){return this._tile.key.id===i.key.id?this.reader:null}}class DrillDownTileLoadStrategy_r{constructor(i,n){this.subscription=i,this._tileIdToResult=new Map,this._controller=new AbortController,(0,_.u7)(i.options,(()=>this._controller.abort())),(0,_.u7)(n,(()=>this._controller.abort()))}get(i){return this._tileIdToResult.get(i)}set(i,n){this._tileIdToResult.set(i,n)}get options(){return{signal:this._controller.signal}}}class DrillDownTileLoadStrategy_n extends ATileLoadStrategy_s{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(i){this._loadStates.has(i.key.id)||this._loadStates.set(i.key.id,new DrillDownTileLoadStrategy_r(i,this._options));const n=this._loadStates.get(i.key.id);let a;try{for await(const a of this._fetchChunkInfos(n,i.tile,0)){const{queryJSON:n,reader:c,sourceTile:l,sourceTileDepth:d,tile:h}=a,p=new DrillDownTileSourceChunk_i(c,n,h,l,d,!1);(0,_.Te)(i.options),this._addChunk(p)}}catch(l){a=l}const c=new DrillDownTileSourceChunk_i(FeatureSetReaderJSON_u.empty(this._metadata),null,i.tile,null,-1,!0);if(this._addChunk(c),a)throw a}unload(i){super.unload(i),this._loadStates.delete(i.key.id)}async*_fetchChunkInfos(i,n,a){let c=i.get(n.id);const l=!!c;if(c||(c=await this._fetchChunkInfo(i,n,a),i.set(n.id,c)),c.reader.exceededTransferLimit&&a<(0,d.A)("featurelayer-query-max-depth"))for(const d of n.createChildTiles())yield*this._fetchChunkInfos(i,d,a+1);else l||(yield c)}async _fetchChunkInfo(i,n,a){const c=i.subscription.tile.getQuantizationParameters(),l=this._queryInfo.createTileQuery(n,{returnExceededLimitFeatures:!1,quantizationParameters:c});return{reader:await this._fetch(l,i.subscription.options),queryJSON:l.inner.toJSON(),tile:i.subscription.tile,sourceTile:n,sourceTileDepth:a}}}class PagedTileSourceChunk_t extends ASourceChunk_r{constructor(i,n,a,c,l){super(),this._reader=i,this._queryJSON=n,this._tile=a,this._page=c,this._end=l,this.chunkId="".concat(this._tile.key.id,".").concat(this._page).concat(this.end?"e":""),this.normalizedChunkId="".concat(this._tile.key.normalizedId,".").concat(this._page).concat(this.end?"e":"")}get queryInfo(){return{type:"paged-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get page(){return this._page}get tile(){return this._tile}get isTiled(){return!0}getTileReader(i){return this._tile.key.id===i.key.id?this.reader:null}}class PagedTileLoadStrategy_n{constructor(i,n){this.subscription=i,this._pages=new Set,this._controller=new AbortController,this._done=!1,(0,_.u7)(i.options,(()=>this._controller.abort())),(0,_.u7)(n,(()=>this._controller.abort()))}resetAbortController(){this._controller=new AbortController}get pageStart(){let i=-1;for(const n of this._pages.values())i=Math.max(i,n);return i+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(i,n){this._pages.add(i),this._done=this._done||n}}class PagedTileLoadStrategy_a extends ATileLoadStrategy_s{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(i){this._loadStates.has(i.key.id)||this._loadStates.set(i.key.id,new PagedTileLoadStrategy_n(i,this._options));const n=this._loadStates.get(i.key.id);let a;n.resetAbortController();try{await this._fetchPages(n)}catch(l){a=l}const c=new PagedTileSourceChunk_t(FeatureSetReaderJSON_u.empty(this._metadata),null,i.tile,-1,!0);if((0,_.G4)(n.options)||this._addChunk(c),a)throw a}unload(i){super.unload(i),this._loadStates.delete(i.key.id)}async _fetchPages(i){let n=0,a=i.pageStart,c=1;for(;n<20&&!i.done;){const l=[];for(let n=0;n<c;n++)l.push(this._fetchChunk(i,a++));const d=await Promise.all(l);for(const n of d)(0!==n.size()||n.first)&&(i.add(n.page,!n.reader.exceededTransferLimit),(0,_.Te)(i.options),this._addChunk(n));n++,c=Math.min(c+1,4)}}async _fetchChunk(i,n){const a=i.subscription.tile,c=this._queryInfo.createPagedTileQuery(a,n),l=await this._fetch(c,i.options);return new PagedTileSourceChunk_t(l,c.inner.toJSON(),a,n,!1)}}class FeatureSnapshotSourceChunk_t extends ASourceChunk_r{constructor(i,n,a,c){super(),this._reader=i,this._queryJSON=n,this._page=a,this._end=c,this.chunkId="".concat(this._page).concat(this.end?"e":""),this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(i){const n=this.queryFeaturesInBounds(i.bounds);return n.setTransformForDisplay(i.transform),n}}class SnapshotLoadStrategy_a extends AFetchLoadStrategy_n{constructor(i,n,a,c,l,d){super(i,n,a,l,d),this._random=new p.A(1e3),this._featureCount=c}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(i){return null==this._promise&&(this._promise=this._downloadPages(this._featureCount)),this._promise}unload(i){}async _downloadPages(i){const n=Math.ceil(i/this._queryInfo.pageSize),a=Array.from({length:n},((i,n)=>n)).sort(((i,n)=>this._random.getInt()-this._random.getInt())),l=await Promise.all(a.map((i=>this._downloadPage(i)))),d=new FeatureSnapshotSourceChunk_t(FeatureSetReaderJSON_u.empty(this._metadata),null,-1,!0);this._store.insert(d);const h=l.filter((i=>i));if(h.length)throw new c.A("featurelayer-query","Encountered errors when downloading data",{errors:h})}async _downloadPage(i){try{const n=this._queryInfo.createPagedQuery(i),a=await this._fetch(n,this._options),c=new FeatureSnapshotSourceChunk_t(a,n.inner.toJSON(),i,!1);return(0,_.Te)(this._options),this._store.insert(c),null}catch(r){return r}}}var Me=a(13600),Re=a(48237);const Oe="__esri_timestamp__";class StreamFeatureManager_o{constructor(i,n,a,c){let l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=a,this._purgeOptions=c,this.store=i,this.objectIdField=n,this.purgeInterval=l,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}removeById(i){this._removed.push(i)}removeByTrackId(i){const n=this._trackIdToObservations.get(i);if(n)for(const a of n.entries)this._removed.push(a)}add(i){if(this._useGeneratedIds){const n=this._nextId();i.attributes[this.objectIdField]=n,i.objectId=n}else i.objectId=i.attributes[this.objectIdField];const n=i.objectId;if(this._addOrUpdated.set(n,i),this._maxAge=Math.max(this._maxAge,i.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return null==this._trackIdLessObservations&&(this._trackIdLessObservations=new Me.A(1e5)),void this._trackIdLessObservations.enqueue(n);const a=i.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(a)){var c;const i=null!=(null===(c=this._purgeOptions)||void 0===c?void 0:c.maxObservations)?this._purgeOptions.maxObservations:1e3,n=(0,Re.qE)(i,0,1e3);this._trackIdToObservations.set(a,new Me.A(n))}const l=this._trackIdToObservations.get(a),d=null===l||void 0===l?void 0:l.enqueue(n);null!=d&&(this._addOrUpdated.has(d)?this._addOrUpdated.delete(d):this._removed.push(d))}checkForUpdates(){const i=this._getToAdd(),n=this._getToRemove(),a=performance.now();a-this._lastPurge>=this.purgeInterval&&(this._purge(a),this._lastPurge=a);const c=[];if(null!=n)for(const d of n){const i=this.store.removeById(d);null!=i&&c.push(i)}const l=[];if(null!=i){const c=new Set(null!==n&&void 0!==n?n:[]);for(const n of i)c.has(n.objectId)||(n.attributes[Oe]=a,this.store.add(n),l.push(n))}return!(!l.length&&(null===c||void 0===c||!c.length))&&(this.store.update(l,c),!0)}_getToAdd(){if(!this._addOrUpdated.size)return null;const i=new Array(this._addOrUpdated.size);let n=0;return this._addOrUpdated.forEach((a=>i[n++]=a)),this._addOrUpdated.clear(),i}_getToRemove(){const i=this._removed;return this._removed.length?(this._removed=[],i):null}_nextId(){const i=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,i}_purge(i){const n=this._purgeOptions;null!=n&&(this._purgeSomeByDisplayCount(n),this._purgeByAge(n),this._purgeByAgeReceived(i,n),this._purgeTracks())}_purgeSomeByDisplayCount(i){if(!i.displayCount)return;let n=this.store.size;if(n>i.displayCount){if(this._timeInfo.trackIdField)for(const a of this._trackIdToObservations.values())if(n>i.displayCount&&a.size){const i=a.dequeue();this._removed.push(i),n--}if(null!=this._trackIdLessObservations){let a=n-i.displayCount;for(;a-- >0;){const i=this._trackIdLessObservations.dequeue();null!=i&&this._removed.push(i)}}}}_purgeByAge(i){var n;const a=null===(n=this._timeInfo)||void 0===n?void 0:n.startTimeField;if(!i.age||!a)return;const c=60*i.age*1e3,l=this._maxAge-c;this.store.forEach((i=>{i.attributes[a]<l&&this._removed.push(i.objectId)}))}_purgeByAgeReceived(i,n){if(!n.ageReceived)return;const a=i-60*n.ageReceived*1e3;this.store.forEach((i=>{i.attributes[Oe]<a&&this._removed.push(i.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((i,n)=>{0===i.size&&this._trackIdToObservations.delete(n)}))}}var Pe=a(42834);let qe=class extends fe.A{constructor(i){super(i)}get connectionStatus(){var i;return null===(i=this.connection)||void 0===i?void 0:i.connectionStatus}get errorString(){var i;return null===(i=this.connection)||void 0===i?void 0:i.errorString}};(0,ge._)([(0,ye.MZ)()],qe.prototype,"connection",void 0),(0,ge._)([(0,ye.MZ)()],qe.prototype,"connectionStatus",null),(0,ge._)([(0,ye.MZ)()],qe.prototype,"errorString",null),qe=(0,ge._)([(0,Se.$)("esri.views.2d.layers.features.sources.StreamConnectionState")],qe);class StreamFeatureStore_t{constructor(i,n){this._metadata=i,this._onUpdate=n,this._objectIdToFeature=new Map}get size(){return this._objectIdToFeature.size}get reader(){return FeatureSetReaderJSON_u.fromFeatures([...this._objectIdToFeature.values()],this._metadata)}add(i){this._objectIdToFeature.set(i.objectId,i)}forEach(i){this._objectIdToFeature.forEach(i)}removeById(i){const n=this._objectIdToFeature.get(i);return n?(this._objectIdToFeature.delete(i),n):null}clear(){this._objectIdToFeature=new Map}update(i,n){var a;this._onUpdate(null!==(a=null===i||void 0===i?void 0:i.length)&&void 0!==a?a:0)}}class StreamSourceChunk_r extends ASourceChunk_r{constructor(i){super(),this._reader=i,this.chunkId="stream-chunk",this.normalizedChunkId="stream-chunk"}get reader(){return this._reader}get first(){return!0}get end(){return!0}get queryInfo(){return{type:"stream",chunkId:this.chunkId,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(i){const n=this.queryFeaturesInBounds(i.bounds);return n.setTransformForDisplay(i.transform),n}}class StreamLoadStrategy_h extends ALoadStrategy_r{constructor(i,n,a,c,l){super(a),this._service=i,this._dataFilter=n,this._streamOptions=c,this._metadata=l,this._connectionState=new qe,this._forceRefresh=!1,this.events=new H.A;const{objectIdField:d,timeInfo:h}=this._metadata,{purgeOptions:_}=n;this._stagingStore=new StreamFeatureStore_t(this._metadata,(i=>this.events.emit("features-updated",i))),this._manager=new StreamFeatureManager_o(this._stagingStore,d,h,_),this.connect()}destroy(){super.destroy(),this.disconnect()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){var i;return null===(i=this._connectionState)||void 0===i?void 0:i.errorString}async refresh(){const i=null!=this._chunk;this._manager.checkForUpdates()||!i||this._forceRefresh?(this._chunk&&this._store.remove(this._chunk),this._forceRefresh=!1,this._chunk=new StreamSourceChunk_r(this._stagingStore.reader),this._store.insert(this._chunk),this.events.emit("tick")):this.events.emit("tick")}async updateFields(i){throw new Error("Updating available fields not supported for StreamLayer")}async load(i){}unload(i){}disconnect(){var i;this._connection=(0,M.pR)(this._connection),this._connectionState.connection=null,null===(i=this._handlesGroup)||void 0===i||i.remove()}connect(){if(null!=this._connection)return;const{geometryType:i,spatialReference:n}=this._metadata,{maxReconnectionAttempts:a,maxReconnectionInterval:c,geometryDefinition:d,definitionExpression:h,customParameters:_}=this._dataFilter;this._connection=(0,Pe.createConnection)(this._service.source,n,this._streamOptions.outSR,i,h,d,a,c,_),this._handlesGroup=(0,l.vE)([this._connection.on("data-received",(i=>this._onFeature(i))),this._connection.on("message-received",(i=>this._onWebSocketMessage(i)))]),this._connectionState.connection=this._connection}clear(){this._manager.checkForUpdates(),this._stagingStore.clear(),this._forceRefresh=!0}updateCustomParameters(i){var n;null===(n=this._connection)||void 0===n||n.updateCustomParameters(i)}sendMessageToSocket(i){var n;null===(n=this._connection)||void 0===n||n.sendMessageToSocket(i)}sendMessageToClient(i){var n;null===(n=this._connection)||void 0===n||n.sendMessageToClient(i)}_onWebSocketMessage(i){if("type"in i)switch(i.type){case"delete":if(i.objectIds)for(const n of i.objectIds)this._manager.removeById(n);if(i.trackIds)for(const n of i.trackIds)this._manager.removeByTrackId(n);break;case"clear":this.clear()}this.events.emit("message-received",i)}_onFeature(i){try{this._manager.add(i),this.events.emit("data-received",i)}catch(t){}}}var Ee=a(9099);class SourceChunkStore_t{constructor(i){this._onChange=i,this._chunks=new Map,this._overrideChunk=new OverrideChunk_t,this._chunksToRemove=[],this.events=new H.A,this.featureAdapter=new Ee.Z}destroy(){this.clear()}clear(){for(const i of this._chunks.values())this._chunksToRemove.push(i);this._chunks.clear()}*chunks(){this._overrideChunk&&(yield this._overrideChunk),yield*this._chunks.values()}insert(i){(0,d.A)("esri-2d-update-debug")&&console.debug("Chunk[".concat(i.chunkId,"] SourceChunkStore.insert")),this._overrideChunk.overridenIds.size&&i.reader.removeIds(this._overrideChunk.overridenIds),this._chunks.set(i.chunkId,i),this.events.emit("changed"),this._onChange()}remove(i){(0,d.A)("esri-2d-update-debug")&&console.debug("Chunk[".concat(i.chunkId,"] SourceChunkStore.remove")),this._chunks.delete(i.chunkId),this._chunksToRemove.push(i)}cleanupRemovedChunks(){const i=this._chunksToRemove;return this._chunksToRemove=[],i}applyOverrides(i){this._overrideChunk.applyOverrides(i);for(const n of this._chunks.values())n.reader.removeIds(this._overrideChunk.overridenIds),n.invalidate()}forEach(i){const n=new Set;for(const a of this.chunks()){const c=a.reader.getCursor();for(;c.next();){const a=c.getObjectId();n.has(a)||(i(c.copy()),n.add(a))}}}forEachUnsafe(i){const n=new Set;for(const a of this.chunks()){const c=a.reader.getCursor();for(;c.next();){const a=c.getObjectId();n.has(a)||(i(c),n.add(a))}}}forEachInBounds(i,n){const a=new Set;for(const c of this.chunks()){const l=c.queryFeaturesInBounds(i);for(;l.next();){const i=l.getObjectId();a.has(i)||(n(l.copy()),a.add(i))}}}forEachBounds(i,n){const a=(0,J.vt)();for(const c of i)c.getBounds(a)&&n(a)}}var Le=a(72593);class v{constructor(i,n,a,c){this._aggregateAdapter=i,this._subscriptions=n,this._onChange=a,this._connection=c,this._updateTracking=new Le.F({debugName:"FeatureSource"}),this._store=new SourceChunkStore_t(this._onChange)}destroy(){var i,n;null!==(i=this._strategy)&&void 0!==i&&i.destroy(),this._store.destroy(),null===(n=this._streamMessenger)||void 0===n||n.destroy()}get _eventLog(){return this._connection.eventLog}get metadata(){if(!this._metadata)throw new Error("InternalError: Metadata not defined. Was update called?");return this._metadata}get service(){return this._schema.service}get store(){return this._store}get streamMessenger(){return null==this._streamMessenger&&this._initStreamMessenger(),this._streamMessenger}get statistics(){return FeatureStoreStatistics_t.from(this._store)}get updateTracking(){return this._updateTracking}get queryEngine(){if(!this._queryEngine){if(!this._schema)return null;const{dataFilter:i}=this._schema.mutable,n=this._schema.mutable.availableFields,a=this._metadata;this._queryEngine=new X.d({featureStore:this._store,fieldsIndex:a.fieldsIndex,geometryType:a.geometryType,objectIdField:a.objectIdField,hasM:!1,hasZ:!1,spatialReference:i.outSpatialReference,cacheSpatialQueries:!0,aggregateAdapter:this._aggregateAdapter,timeInfo:a.timeInfo,definitionExpression:i.definitionExpression,availableFields:n})}return this._queryEngine}get isStream(){return"stream"===this._schema.type}chunks(){return Array.from(this._store.chunks())}cleanupRemovedChunks(){return this._store.cleanupRemovedChunks()}onSubscribe(i){var n;this._eventLog.onEvent({type:"subscribe",tile:i.tile.id});const a=null===(n=this._strategy)||void 0===n?void 0:n.load(i);a&&(a.then((()=>this._eventLog.onEvent({type:"loaded",tile:i.tile.id}))).catch((n=>this._eventLog.onEvent({type:"error",tile:i.tile.id,error:n}))),this._updateTracking.addPromise(a))}onResume(i){var n;this._updateTracking.addPromise((0,_.QZ)(null===(n=this._strategy)||void 0===n?void 0:n.load(i)))}onUnsubscribe(i){var n;this._eventLog.onEvent({type:"unsubscribe",tile:i.tile.id}),null===(n=this._strategy)||void 0===n||n.unload(i)}getOverride(i){return this._updateTracking.addPromise(this._doGetOverride(i))}applyOverride(i){this._store.applyOverrides(i)}async update(i,n){var a,c,l;const h=i.source,_=(0,O.Ui)(null===(a=this._schema)||void 0===a?void 0:a.mutable,h.mutable);if(!_)return!1;if((0,d.A)("esri-2d-update-debug")&&console.debug("Version[".concat(n,"] FeatureSource.update"),{changes:_}),this._schema=h,this._metadata=new ee.i(this._schema.service.metadata),null!==(c=this._queryEngine)&&void 0!==c&&c.destroy(),this._queryEngine=null,"feature"===this._schema.type&&null!=this._schema.service.queryMetadata.lastEditDate&&(this._lastEditDate=this._schema.service.queryMetadata.lastEditDate),null==this._streamMessenger&&"stream"===this._schema.type&&this._initStreamMessenger(),(0,O.w2)(_,"sourceRefreshVersion")&&null!==(l=this._strategy)&&void 0!==l&&l.refresh)return await this._strategy.refresh(),!0;if("feature"===h.type&&(0,O.w2)(_,"availableFields")&&!await this._queryLastEditDateChanged()){this._eventLog.onEvent({type:"updateFieldsStart"});try{await this._strategy.updateFields(h.mutable.availableFields),this._eventLog.onEvent({type:"updateFieldsEnd"})}catch(p){this._eventLog.onEvent({type:"updateFieldsError",error:p})}return!1}return!(!(0,O.Mj)(_,"dataFilter")&&!(0,O.Mj)(_,"sourceRefreshVersion"))&&(await this._updateStrategy(n),!0)}_initStreamMessenger(){null==this._streamMessenger&&(this._streamMessenger=new ve(this._connection))}async _doGetOverride(i){return this._strategy.queryOverride(i)}async _queryLastEditDateChanged(){if(null==this._lastEditDate)return!1;const i=this._schema.service.source,n={...i.query,f:"json"},a=(await(0,de.A)(i.path,{query:n,responseType:"json"})).data.editingInfo.lastEditDate;return a!==this._lastEditDate&&(this._lastEditDate=a,!0)}async _createStrategy(){const i=this.service,n="isSourceHosted"in i&&i.isSourceHosted,a=Array.isArray(i.source),c=i.source&&"collection"in i.source,l=n||a||c;if("stream"===this._schema.type){const i=new StreamLoadStrategy_h(this._schema.service,this._schema.mutable.dataFilter,this._store,{outSR:this._schema.mutable.dataFilter.outSpatialReference},this.metadata);return this._streamMessenger.strategy=i,i}const d=FeatureSourceQueryInfo_o.fromSchema(this._schema,this._metadata),h=await this._supportSnapshotMode(this._schema,d);return h?new SnapshotLoadStrategy_a(this._schema.service,d,this._store,h.featureCount,this.metadata,this._eventLog):l?new PagedTileLoadStrategy_a(this._schema.service,d,this._store,this.metadata,this._eventLog):new DrillDownTileLoadStrategy_n(this._schema.service,d,this._store,this.metadata,this._eventLog)}async _updateStrategy(i){var n;const a=await this._createStrategy();this._eventLog.onEvent({type:"updateStrategyStart",about:a.about});const c=!!this._strategy;this._store.clear(),null!==(n=this._strategy)&&void 0!==n&&n.destroy(),this._strategy=a,(0,d.A)("esri-2d-update-debug")&&console.debug("Version[".concat(i,"] FeatureSource.updateStrategy"),{strategy:a});const l=Array.from(this._subscriptions.values());if(!l.length)return void this._eventLog.onEvent({type:"updateStrategyEnd"});const h=Promise.all(l.map((i=>this._strategy.load(i).then((()=>this._eventLog.onEvent({type:"loaded",tile:i.tile.id}))).catch((n=>this._eventLog.onEvent({type:"error",tile:i.tile.id,error:n}))))));this._updateTracking.addPromise(h);try{c&&await h}catch(p){(0,_.jH)(p)}this._eventLog.onEvent({type:"updateStrategyEnd"}),(0,d.A)("esri-2d-update-debug")&&console.debug("Version[".concat(i,"] FeatureSource.updateStrategyEnd"),{strategy:a})}async _supportSnapshotMode(i,n){const{queryMetadata:a}=i.service,c=a.snapshotInfo;if(!c||!c.supportsSnapshotMinThreshold||!c.snapshotCountThresholds)return null;const l=i.service.source,d=n.createQuery();d.inner.orderByFields=[],d.inner.returnGeometry=!1;const h=(await(0,he.gW)(l,d.inner,{query:d.customParameters})).data.count,{min:_,max:p}=c.snapshotCountThresholds;return h<=_||c.supportsSnapshotMaxThreshold&&h<p?{featureCount:h}:null}}var De=a(30073);class FeatureTileSubscription_r{constructor(i,n){this._handles=new De.A,this._abortController=new AbortController,this._resolver=(0,_.Tw)(),this._isDone=!1,this._aborted=!1,this.tile=i,this._version=n,this._handles.add([])}destroy(){this.pause(),this._handles.destroy()}get key(){return this.tile.key}get version(){return this._version}set version(i){this._version=i}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get done(){return this._resolver.promise}get isDone(){return this._isDone}resolve(){this._isDone=!0,this._resolver.resolve()}get paused(){return this._aborted}resume(){this._abortController=new AbortController,this._aborted=!1}pause(){this._aborted||(this._aborted=!0,this._abortController.abort())}}var Ne=a(70547);class FeaturePipelineWorker_f{constructor(i){this.edit=i,this.resolver=(0,_.Tw)()}}class b{constructor(i,n){this.schema=i,this.version=n,this.resolver=(0,_.Tw)()}}class FeaturePipelineWorker_m{constructor(){this._aggregateAdapter={getFeatureObjectIds:i=>this._processor.getFeatureObjectIdsForAggregate(i)},this._subscriptions=new Map,this._updateRequested=!1,this._updateSubscriptionRequests=[],this._updateHighlightRequests=[]}destroy(){this._subscriptions.clear(),this._processor.destroy(),this._source.destroy(),this._handles.remove(),this._editState=null,this._tileInfoView=null}onDetach(){this.destroy(),this._initialize(this._connection)}_initialize(i){this._source=new v(this._aggregateAdapter,this._subscriptions,(()=>this._requestUpdate()),i),this._processor=new Processor_l(i,this._source),this._handles=(0,l.vE)([(0,g.wB)((()=>this._source.updateTracking.updating),(()=>{this._requestUpdate(),this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0})}))])}set remoteClient(i){this._connection=new PipelineConnectionHandlers_e(i),this._initialize(this._connection)}get features(){const i=this._source.queryEngine;if(!i)throw new c.A("no-queryEngine","No query engine defined");return i}get aggregates(){const i=this._processor.aggregateQueryEngine;if(!i)throw new c.A("no-queryEngine","No aggregate query engine defined");return i}get processor(){return this._processor}get streamMessenger(){return this._source.streamMessenger}getDisplayFeatures(i){return this._processor.getDisplayFeatures(i)}async updateSchema(i,n){return(0,d.A)("esri-2d-update-debug")&&this._updateSchemaState&&console.error("InternalError: Schema already updating"),this._updateSchemaState=new b(i,n),this._requestUpdate(),this._updateSchemaState.resolver.promise}updateSubscriptions(i){this._updateSubscriptionRequests.push(i),this._requestUpdate()}updateHighlight(i){this._updateHighlightRequests.push(i),this._requestUpdate()}async onEdits(i){if(null!=this._editState)throw new c.A("InternalError - Already processing an edit");this._editState=new FeaturePipelineWorker_f(i);const n=this._editState.resolver.promise;return this._requestUpdate(),n}queryStatistics(){return this._source.statistics.toJSON()}async queryVisibleFeatures(i,n){return this.features.executeQuery(i,n)}async queryHeatmapStatistics(i){var n;const a=Math.round((0,m.Lz)(i.radius));let c=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY;const d="string"==typeof i.fieldOffset,h=null!==(n=i.fieldOffset)&&void 0!==n?n:0,_=Array.from(this._subscriptions.values()),p=this._source.chunks(),g=a**2,F=3/(Math.PI*g),x=2*a,T=Math.ceil(k.CQ/x);for(const m of _){const n=m.tile,a=new Float64Array(T*T);for(const c of p){const l=c.getTileReader(n);if(!l)continue;const _=l.getCursor();for(;_.next();){let n=1;if(null!=i.field){const a=_.readAttribute(i.field);n=d?-1*+a:+a+h}const c=_.readXForDisplay()/x,l=_.readYForDisplay()/x,p=Math.floor(c),m=Math.floor(l);if(p<0||m<0||p>=T||m>=T)continue;const k=((.5+p-c)*x)**2+((.5+m-l)*x)**2;if(k>g)continue;const M=n*(F*(1-k/g)**2);a[m+p*T]+=M}}for(let i=0;i<a.length;i++)c=Math.min(c,a[i]),l=Math.max(l,a[i])}return{max:l,min:c}}async getSampleFeatures(i){const n=this._source.chunks();if(n.reduce(((i,n)=>i+n.size()),0)<=i.minFeatureCount){if(!this._source.updateTracking.updating){const i=[];return this._source.store.forEachUnsafe((n=>i.push(n.readLegacyFeatureWorldSpace()))),i}return null}const a=new Set,c=[],l=n.map((i=>i.reader.getCursor())),d=new p.A,h=3*i.sampleSize;for(let _=0;_<h&&c.length<i.sampleSize;_++){const i=l[d.getIntRange(0,n.length-1)];if(0===i.getSize())continue;const h=d.getIntRange(0,i.getSize()-1);i.setIndex(h);const _=i.getObjectId();a.has(_)||(a.add(_),c.push(i.readLegacyFeatureWorldSpace()))}return c.length>=i.sampleSize?c:null}_requestUpdate(){this._updateRequested||(this._updateRequested=!0,(0,h.d)((()=>this._scheduleNextUpdate())))}_scheduleNextUpdate(){this._updateRequested&&(this._ongoingUpdate||(this._ongoingUpdate=this._doUpdate().finally((()=>{this._ongoingUpdate=null,this._scheduleNextUpdate()})),this._updateRequested=!1))}_subscribe(i){const n=i.tileId;if(this._subscriptions.has(n)){const a=this._subscriptions.get(n);return void(a.paused&&((0,d.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(n,"] Pipeline.resume")),a.resume(),a.version=i.version,this._source.onResume(a)))}(0,d.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(n,"] Pipeline.subscribe"));const a=new Ne.F(this._tileInfoView,n),c=new FeatureTileSubscription_r(a,i.version);this._subscriptions.set(n,c),this._source.onSubscribe(c),this._processor.onSubscribe(c)}_unsubscribe(i){const n=this._subscriptions.get(i);n&&((0,d.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(i,"] Pipeline.unsubscribe")),this._source.onUnsubscribe(n),this._processor.onUnsubscribe(n),this._subscriptions.delete(n.key.id),n.destroy())}_pauseSubscription(i){const n=this._subscriptions.get(i);n&&((0,d.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(i,"] Pipeline.pause")),n.pause())}async _doUpdate(){if((0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateStart"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0}),this._updateSubscriptionRequests.length){const i=this._updateSubscriptionRequests;this._updateSubscriptionRequests=[];for(const n of i)this._doUpdateSubscriptions(n)}const i=this._updateSchemaState;if(this._updateSchemaState=null,null!=i){const{schema:n,version:a}=i;await this._doUpdateSchema(n,a)}const n=this._editState;if(this._editState=null,null!=n){(0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline.applyEditOverride",n.edit);const i=await this._source.getOverride(n.edit);await this._processor.applyOverride(i),(0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline.endEditOverride",n.edit)}if(this._updateHighlightRequests.length){const i=this._updateHighlightRequests;this._updateHighlightRequests=[];for(const n of i)this._processor.updateHighlight(n)}const a=this._source.cleanupRemovedChunks();this._processor.removeChunks(a);try{this._subscriptions.size&&((0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksStart"),await this._processor.updateChunks(),(0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksEnd"))}catch(r){(0,_.jH)(r)}null!=n&&n.resolver.resolve(),null!=i&&i.resolver.resolve(),this._updateRequested?((0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=true]"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0})):((0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=false, After flush]"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:this._updateRequested}))}async _doUpdateSchema(i,n){var a;if((0,d.A)("esri-2d-update-debug")&&console.debug("Version[".concat(n,"] Pipeline.updateStart"),{schema:i}),!this._tileInfoView){const n=F.A.fromJSON(i.source.tileInfoJSON);this._tileInfoView=new x.A(n)}const c={tileInfo:null===(a=this._tileInfoView)||void 0===a?void 0:a.tileInfo};try{const a=await this._source.update(i,n),l=Array.from(this._subscriptions.values());await this._processor.update(i,n,c,a,l)}catch(l){console.error(l)}(0,d.A)("esri-2d-update-debug")&&console.debug("Version[".concat(n,"] Pipeline.updateEnd"))}_doUpdateSubscriptions(i){if((0,d.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateSubscriptions",i),!this._tileInfoView){const n=F.A.fromJSON(i.tileInfoJSON);this._tileInfoView=new x.A(n)}for(const n of i.subscribe)this._subscribe(n);for(const n of i.unsubscribe)this._unsubscribe(n);if((0,d.A)("featurelayer-query-pausing-enabled"))for(const n of i.pause)this._pauseSubscription(n)}}},4690:(i,n,a)=>{function o(i,n,a,c){const l=i.clone(),d=1<<l.level,h=l.col+n,_=l.row+a;return c&&h<0?(l.col=h+d,l.world-=1):h>=d?(l.col=h-d,l.world+=1):l.col=h,l.row=_,l}a.d(n,{K:()=>o})},40332:(i,n,a)=>{a.d(n,{_:()=>t});class t{constructor(i,n,a,c,l){let d=arguments.length>5&&void 0!==arguments[5]&&arguments[5],h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;this.name=i,this.count=n,this.type=a,this.offset=c,this.stride=l,this.normalized=d,this.divisor=h}}}}]);
//# sourceMappingURL=7307.71e946e9.chunk.js.map