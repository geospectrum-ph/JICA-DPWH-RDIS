"use strict";(self.webpackChunkSEEDs_v2_0_Client=self.webpackChunkSEEDs_v2_0_Client||[]).push([[4600],{4600:(e,i,a)=>{a.r(i),a.d(i,{default:()=>G});var l=a(50075),h=a(80671),d=a(61272),c=a(53705),_=a(4180),v=a(73067),f=a(1045),g=a(66004),m=a(2395),w=a(81618),I=a(4270),S=a(57453),A=(a(50886),a(89412),a(68682)),y=(a(55072),a(76761),a(79911)),k=a(43016),U=(a(70218),a(60102)),T=a(8689),x=a(79936),O=a(61948);const P="esri-identity-modal",b={base:P,info:"".concat(P,"__info"),notice:"".concat(P,"__notice")};let D=class extends y.A{constructor(e,i){super(e,i),this.container=document.createElement("div"),this.error=null,this.oAuthPrompt=!1,this.open=!1,this.signingIn=!1,this.server=null,this.resource=null,this._usernameInputNode=null,this._passwordInputNode=null,document.body.appendChild(this.container)}loadDependencies(){return(0,k.W)({button:()=>Promise.all([a.e(463),a.e(616),a.e(1021),a.e(4035)]).then(a.bind(a,94035)),input:()=>Promise.all([a.e(463),a.e(616),a.e(1021),a.e(4946),a.e(1697)]).then(a.bind(a,31697)),label:()=>Promise.all([a.e(463),a.e(8094)]).then(a.bind(a,78094)),modal:()=>Promise.all([a.e(463),a.e(616),a.e(9872),a.e(3112)]).then(a.bind(a,33112)),notice:()=>Promise.all([a.e(463),a.e(616),a.e(7409)]).then(a.bind(a,77409))})}get title(){var e;return null===(e=this.commonMessages)||void 0===e?void 0:e.auth.signIn}render(){var e;const{open:i,title:a,messages:l,signingIn:h,oAuthPrompt:d,server:c,resource:_,error:v}=this,{info:f,oAuthInfo:g,lblItem:m,invalidUser:w,noAuthService:I,lblUser:S,lblPwd:A,lblCancel:y,lblSigning:k,lblOk:U}=l;return(0,T.K)("div",{class:this.classes(b.base,(0,x.fJ)())},(0,T.K)("form",{bind:this,onsubmit:this._submit},(0,T.K)("calcite-modal",{bind:this,open:i,outsideCloseDisabled:!0,scale:"s",widthScale:"s",onCalciteModalClose:this._cancel,onCalciteModalOpen:this._focusUsernameInput},(0,T.K)("div",{slot:"header"},a),(0,T.K)("div",{slot:"content"},(0,T.K)("div",{class:b.info},(0,O.V)(d?g:f,{server:c&&/\.arcgis\.com/i.test(c)?"ArcGIS Online":c,resource:"(".concat(_||m,")")})),v?(0,T.K)("calcite-notice",{class:b.notice,icon:"exclamation-mark-triangle",kind:"danger",open:!0},(0,T.K)("div",{slot:"message"},null!==(e=v.details)&&void 0!==e&&e.httpStatus?w:I)):null,d?null:[(0,T.K)("calcite-label",null,S,(0,T.K)("calcite-input",{afterCreate:e=>this._usernameInputNode=e,autocomplete:"off",bind:this,name:"username",required:!0,spellcheck:!1,type:"text",value:""})),(0,T.K)("calcite-label",null,A,(0,T.K)("calcite-input",{afterCreate:e=>this._passwordInputNode=e,bind:this,name:"password",required:!0,type:"password",value:""}))]),(0,T.K)("calcite-button",{appearance:"outline",bind:this,onclick:this._cancel,slot:"secondary",type:"button",width:"full"},y),(0,T.K)("calcite-button",{loading:!!h,slot:"primary",type:"submit",width:"full"},h?k:U))))}_focusUsernameInput(){requestAnimationFrame((()=>{var e;null===(e=this._usernameInputNode)||void 0===e||e.setFocus()}))}_cancel(){this._set("signingIn",!1),this.open=!1,this._usernameInputNode&&(this._usernameInputNode.value=""),this._passwordInputNode&&(this._passwordInputNode.value=""),this.emit("cancel")}_submit(e){var i,a;e.preventDefault(),this._set("signingIn",!0);const l=this.oAuthPrompt?{}:{username:null===(i=this._usernameInputNode)||void 0===i?void 0:i.value,password:null===(a=this._passwordInputNode)||void 0===a?void 0:a.value};this.emit("submit",l)}};(0,h._)([(0,S.MZ)({readOnly:!0})],D.prototype,"container",void 0),(0,h._)([(0,S.MZ)(),(0,U.G)("esri/t9n/common")],D.prototype,"commonMessages",void 0),(0,h._)([(0,S.MZ)()],D.prototype,"error",void 0),(0,h._)([(0,S.MZ)(),(0,U.G)("esri/identity/t9n/identity")],D.prototype,"messages",void 0),(0,h._)([(0,S.MZ)()],D.prototype,"oAuthPrompt",void 0),(0,h._)([(0,S.MZ)()],D.prototype,"open",void 0),(0,h._)([(0,S.MZ)()],D.prototype,"signingIn",void 0),(0,h._)([(0,S.MZ)()],D.prototype,"server",void 0),(0,h._)([(0,S.MZ)({readOnly:!0})],D.prototype,"title",null),(0,h._)([(0,S.MZ)()],D.prototype,"resource",void 0),D=(0,h._)([(0,A.$)("esri.identity.IdentityModal")],D);const M=D,j="esriJSAPIOAuth";class OAuthCredential_e{constructor(e,i){this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=e,this.storage=i,this._init()}isValid(){let e=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token))if(null==this.expires&&this.refreshToken)e=!0;else if(this.expires){const i=Date.now();this.expires>i&&(this.expires-i)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(e=!0)}return e}save(){if(!this.storage)return!1;const e=this._load(),i=this.oAuthInfo;if(i&&i.authNamespace&&i.portalUrl){let a=e[i.authNamespace];a||(a=e[i.authNamespace]={}),this.appId||(this.appId=i.appId),a[i.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(j,JSON.stringify(e))}catch(L){return console.warn(L),!1}return!0}return!1}destroy(){const e=this._load(),i=this.oAuthInfo;if(null!==i&&void 0!==i&&i.appId&&null!==i&&void 0!==i&&i.portalUrl&&(null==this.expires||this.expires>Date.now())&&(this.refreshToken||this.token)){const e=i.portalUrl.replace(/^http:/i,"https:")+"/sharing/rest/oauth2/revokeToken",a=new FormData;if(a.append("f","json"),a.append("auth_token",this.refreshToken||this.token),a.append("client_id",i.appId),a.append("token_type_hint",this.refreshToken?"refresh_token":"access_token"),"function"==typeof navigator.sendBeacon)navigator.sendBeacon(e,a);else{const i=new XMLHttpRequest;i.open("POST",e),i.send(a)}}if(i&&i.authNamespace&&i.portalUrl&&this.storage){const a=e[i.authNamespace];if(a){delete a[i.portalUrl];try{this.storage.setItem(j,JSON.stringify(e))}catch(L){console.log(L)}}}i&&(i._oAuthCred=null,this.oAuthInfo=null)}_init(){const e=this._load(),i=this.oAuthInfo;if(i&&i.authNamespace&&i.portalUrl){let a=e[i.authNamespace];a&&(a=a[i.portalUrl],a&&(this.appId=a.appId,this.codeVerifier=a.codeVerifier,this.expires=a.expires,this.refreshToken=a.refreshToken,this.ssl=a.ssl,this.stateUID=a.stateUID,this.token=a.token,this.userId=a.userId))}}_load(){let e={};if(this.storage){const i=this.storage.getItem(j);if(i)try{e=JSON.parse(i)}catch(V){console.warn(V)}}return e}}OAuthCredential_e.prototype.declaredClass="esri.identity.OAuthCredential";var N,Z=a(83375);let V=N=class extends Z.oY{constructor(e){super(e),this._oAuthCred=null,this.appId=null,this.authNamespace="/",this.expiration=20160,this.flowType="auto",this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl="oauth-callback.html",this.popupWindowFeatures="height=490,width=800,resizable,scrollbars,status",this.portalUrl="https://www.arcgis.com",this.preserveUrlHash=!1,this.userId=null}clone(){return N.fromJSON(this.toJSON())}};(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"appId",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"authNamespace",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"expiration",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"flowType",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"forceLogin",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"forceUserId",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"locale",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"minTimeUntilExpiration",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"popup",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"popupCallbackUrl",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"popupWindowFeatures",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"portalUrl",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"preserveUrlHash",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],V.prototype,"userId",void 0),V=N=(0,h._)([(0,A.$)("esri.identity.OAuthInfo")],V);const E=V;let L=class extends Z.oY{constructor(e){super(e),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"adminTokenServiceUrl",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"currentVersion",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"hasPortal",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"hasServer",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"owningSystemUrl",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"owningTenant",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"server",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"shortLivedTokenValidity",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"tokenServiceUrl",void 0),(0,h._)([(0,S.MZ)({json:{write:!0}})],L.prototype,"webTierAuth",void 0),L=(0,h._)([(0,A.$)("esri.identity.ServerInfo")],L);const z=L;var F=a(20805);const B={},R=e=>{const i=new I.s0(e.owningSystemUrl).host,a=new I.s0(e.server).host,l=/.+\.arcgis\.com$/i;return l.test(i)&&l.test(a)},C=(e,i)=>!!(R(e)&&i&&i.some((i=>i.test(e.server))));let $=null,J=null;try{$=window.localStorage,J=window.sessionStorage}catch{}class q extends v.A{constructor(){super(),this._portalConfig=globalThis.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._defaultOAuthInfo=null,this._defaultTokenValidity=60,this.dialog=null,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin="null"!==window.origin?window.origin:window.location.origin,this._appUrlObj=(0,I.An)(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthLocationParams=null,this._gwTokenUrl="/sharing/rest/generateToken",this._agsRest="/rest/services",this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,this._gwUser=/http.+\/users\/([^\/]+)\/?.*/i,this._gwItem=/http.+\/items\/([^\/]+)\/?.*/i,this._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getOAuthLocationParams(),window.addEventListener("pageshow",(e=>{this._pageShowHandler(e)}))}registerServers(e){const i=this.serverInfos;i?(e=e.filter((e=>!this.findServerInfo(e.server))),this.serverInfos=i.concat(e)):this.serverInfos=e,e.forEach((e=>{e.owningSystemUrl&&this._portals.push(e.owningSystemUrl),e.hasPortal&&this._portals.push(e.server)}))}registerOAuthInfos(e){const i=this.oAuthInfos;if(i){for(const a of e){const e=this.findOAuthInfo(a.portalUrl);e&&i.splice(i.indexOf(e),1)}this.oAuthInfos=i.concat(e)}else this.oAuthInfos=e}registerToken(e){e={...e};const i=this._sanitizeUrl(e.server),a=this._isServerRsrc(i);let l,h=this.findServerInfo(i),d=!0;h||(h=new z,h.server=this._getServerInstanceRoot(i),a?h.hasServer=!0:(h.tokenServiceUrl=this._getTokenSvcUrl(i),h.hasPortal=!0),this.registerServers([h])),l=this._findCredential(i),l?(delete e.server,Object.assign(l,e),d=!1):(l=new H({userId:e.userId,server:h.server,token:e.token,expires:e.expires,ssl:e.ssl,scope:a?"server":"portal"}),l.resources=[i],this.credentials.push(l)),l.emitTokenChange(!1),d||l.refreshServerTokens()}toJSON(){return(0,g.oy)({serverInfos:this.serverInfos.map((e=>e.toJSON())),oAuthInfos:this.oAuthInfos.map((e=>e.toJSON())),credentials:this.credentials.map((e=>e.toJSON()))})}initialize(e){if(!e)return;"string"==typeof e&&(e=JSON.parse(e));const i=e.serverInfos,a=e.oAuthInfos,l=e.credentials;if(i){const e=[];i.forEach((i=>{i.server&&i.tokenServiceUrl&&e.push(i.declaredClass?i:new z(i))})),e.length&&this.registerServers(e)}if(a){const e=[];a.forEach((i=>{i.appId&&e.push(i.declaredClass?i:new E(i))})),e.length&&this.registerOAuthInfos(e)}l&&l.forEach((e=>{e.server&&e.token&&e.expires&&e.expires>Date.now()&&((e=e.declaredClass?e:new H(e)).emitTokenChange(),this.credentials.push(e))}))}findServerInfo(e){let i;e=this._sanitizeUrl(e);for(const a of this.serverInfos)if(this._hasSameServerInstance(a.server,e)){i=a;break}return i}findOAuthInfo(e){let i;e=this._sanitizeUrl(e);for(const a of this.oAuthInfos)if(this._hasSameServerInstance(a.portalUrl,e)){i=a;break}return i}findCredential(e,i){if(!e)return;let a;e=this._sanitizeUrl(e);const l=this._isServerRsrc(e)?"server":"portal";if(i){for(const h of this.credentials)if(this._hasSameServerInstance(h.server,e)&&i===h.userId&&h.scope===l){a=h;break}}else for(const h of this.credentials)if(this._hasSameServerInstance(h.server,e)&&-1!==this._getIdenticalSvcIdx(e,h)&&h.scope===l){a=h;break}return a}getCredential(e,i){var a;let l,h,d=!0;i&&(l=!!i.token,h=i.error,d=!1!==i.prompt),i={...i},e=this._sanitizeUrl(e);const c=new AbortController,v=(0,w.Tw)();if(i.signal&&(0,w.u7)(i.signal,(()=>{c.abort()})),(0,w.u7)(c,(()=>{v.reject(new _.A("identity-manager:user-aborted","ABORTED"))})),(0,w.G4)(c))return v.promise;i.signal=c.signal;const f=this._isAdminResource(e),g=l?this.findCredential(e):null;let m;if(g&&h&&h.details&&498===h.details.httpStatus)g.destroy();else if(g)return m=new _.A("identity-manager:not-authorized","You are currently signed in as: '"+g.userId+"'. You do not have access to this resource: "+e,{error:h}),v.reject(m),v.promise;const S=this._findCredential(e,i);if(S)return v.resolve(S),v.promise;let A=this.findServerInfo(e);if(A)!A.hasPortal&&A.server&&A.owningSystemUrl&&this._hasSameServerInstance(A.server,A.owningSystemUrl)&&(A.hasPortal=!0),!A.hasServer&&this._isServerRsrc(e)&&(A._restInfoPms=this._getTokenSvcUrl(e),A.hasServer=!0);else{const i=this._getTokenSvcUrl(e);if(!i)return m=new _.A("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),v.reject(m),v.promise;A=new z,A.server=this._getServerInstanceRoot(e),"string"==typeof i?(A.tokenServiceUrl=i,A.hasPortal=!0):(A._restInfoPms=i,A.hasServer=!0),this.registerServers([A])}return A.hasPortal&&void 0===A._selfReq&&(d||(0,I.FX)(A.tokenServiceUrl,this._appOrigin)||this._gwDomains.some((e=>e.tokenServiceUrl===A.tokenServiceUrl)))&&(A._selfReq={owningTenant:null===(a=i)||void 0===a?void 0:a.owningTenant,selfDfd:this._getPortalSelf(A.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),e)}),this._enqueue(e,A,i,v,f)}getResourceName(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(e)&&e.replace(this._gwUser,"$1")||this._gwItem.test(e)&&e.replace(this._gwItem,"$1")||this._gwGroup.test(e)&&e.replace(this._gwGroup,"$1")||""}generateToken(e,i,a){const l=this._rePortalTokenSvc.test(e.tokenServiceUrl),h=new I.s0(this._appOrigin),d=e.shortLivedTokenValidity;let v,f,g,m,w,S,A,y;i&&(y=this.tokenValidity||d||this._defaultTokenValidity,y>d&&d>0&&(y=d)),a&&(v=a.isAdmin,f=a.serverUrl,g=a.token,S=a.signal,A=a.ssl,e.customParameters=a.customParameters),v?m=e.adminTokenServiceUrl:(m=e.tokenServiceUrl,w=new I.s0(m.toLowerCase()),e.webTierAuth&&(null===a||void 0===a?void 0:a.serverUrl)&&!A&&"http"===h.scheme&&((0,I.FX)(h.uri,m,!0)||"https"===w.scheme&&h.host===w.host&&"7080"===h.port&&"7443"===w.port)&&(m=m.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));const k={query:{request:"getToken",username:null===i||void 0===i?void 0:i.username,password:null===i||void 0===i?void 0:i.password,serverUrl:f,token:g,expiration:y,referer:v||l?this._appOrigin:null,client:v?"referer":null,f:"json",...e.customParameters},method:"post",authMode:"anonymous",useProxy:this._useProxy(e,a),signal:S,...null===a||void 0===a?void 0:a.ioArgs};return l||(k.withCredentials=!1),(0,c.A)(m,k).then((a=>{const l=a.data;if(null===l||void 0===l||!l.token)return new _.A("identity-manager:authentication-failed","Unable to generate token");const h=e.server;return B[h]||(B[h]={}),i&&(B[h][i.username]=i.password),l.validity=y,l}))}isBusy(){return!!this._busy}checkSignInStatus(e){return this.checkAppAccess(e,"").then((e=>e.credential))}checkAppAccess(e,i,a){let l=!1;return this.getCredential(e,{prompt:!1}).then((h=>{let d;const v={f:"json"};if("portal"===h.scope)if(i&&(this._doPortalSignIn(e)||null!==a&&void 0!==a&&a.force))d=h.server+"/sharing/rest/oauth2/validateAppAccess",v.client_id=i;else{if(!h.token)return{credential:h};d=h.server+"/sharing/rest"}else{if(!h.token)return{credential:h};d=h.server+"/rest/services"}return h.token&&(v.token=h.token),(0,c.A)(d,{query:v,authMode:"anonymous"}).then((e=>{if(!1===e.data.valid)throw new _.A("identity-manager:not-authorized","You are currently signed in as: '".concat(h.userId,"'."),e.data);return l=!!e.data.viewOnlyUserTypeApp,{credential:h}})).catch((e=>{var i;if("identity-manager:not-authorized"===e.name)throw e;const a=null===(i=e.details)||void 0===i?void 0:i.httpStatus;if(498===a)throw h.destroy(),new _.A("identity-manager:not-authenticated","User is not signed in.");if(400===a)throw new _.A("identity-manager:invalid-request");return{credential:h}}))})).then((e=>({credential:e.credential,viewOnly:l})))}setOAuthResponseHash(e){e&&("#"===e.charAt(0)&&(e=e.substring(1)),this._processOAuthPopupParams((0,I.zf)(e)))}setOAuthRedirectionHandler(e){this._oAuthRedirectFunc=e}setProtocolErrorHandler(e){this._protocolFunc=e}signIn(e,i){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const l=(0,w.Tw)(),n=()=>{var e,i,a;null!==(e=d)&&void 0!==e&&e.remove(),null!==(i=c)&&void 0!==i&&i.remove(),null!==(a=this.dialog)&&void 0!==a&&a.destroy(),this.dialog=d=c=null},o=()=>{n(),this._oAuthDfd=null,l.reject(new _.A("identity-manager:user-aborted","ABORTED"))};a.signal&&(0,w.u7)(a.signal,(()=>{o()}));const h=new M({open:!0,resource:this.getResourceName(e),server:i.server});this.dialog=h,this.emit("dialog-create");let d=h.on("cancel",o),c=h.on("submit",(e=>{this.generateToken(i,e,{isAdmin:a.isAdmin,signal:a.signal}).then((h=>{n();const d=new H({userId:e.username,server:i.server,token:h.token,expires:null!=h.expires?Number(h.expires):null,ssl:!!h.ssl,isAdmin:a.isAdmin,validity:h.validity});l.resolve(d)})).catch((e=>{h.error=e,h.signingIn=!1}))}));return l.promise}oAuthSignIn(e,i,a,l){this._oAuthDfd=(0,w.Tw)();const h=this._oAuthDfd;let d;null!==l&&void 0!==l&&l.signal&&(0,w.u7)(l.signal,(()=>{const e=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;e&&!e.closed?e.close():this.dialog&&u()})),h.resUrl_=e,h.sinfo_=i,h.oinfo_=a;const c=a._oAuthCred;if(c.storage&&("authorization-code"===a.flowType||"auto"===a.flowType&&i.currentVersion>=8.4)){let e=crypto.getRandomValues(new Uint8Array(32));d=(0,I.$1)(e),c.codeVerifier=d,e=crypto.getRandomValues(new Uint8Array(32)),c.stateUID=(0,I.$1)(e),c.save()||(c.codeVerifier=d=null)}else c.codeVerifier=null;let v,f;this._getCodeChallenge(d).then((h=>{const d=!l||!1!==l.oAuthPopupConfirmation;if(!a.popup||!d)return void this._doOAuthSignIn(e,i,a,h);const c=new M({oAuthPrompt:!0,server:i.server,open:!0});this.dialog=c,this.emit("dialog-create"),v=c.on("cancel",u),f=c.on("submit",(()=>{p(),this._doOAuthSignIn(e,i,a,h)}))}));const u=()=>{p(),this._oAuthDfd=null,h.reject(new _.A("identity-manager:user-aborted","ABORTED"))},p=()=>{var e,i,a;null!==(e=v)&&void 0!==e&&e.remove(),null!==(i=f)&&void 0!==i&&i.remove(),null!==(a=this.dialog)&&void 0!==a&&a.destroy(),this.dialog=null};return h.promise}destroyCredentials(){this.credentials&&this.credentials.slice().forEach((e=>{e.destroy()})),this.emit("credentials-destroy")}enablePostMessageAuth(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"https://www.arcgis.com/sharing/rest";this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=(0,f.on)(window,"message",(i=>{var a;if((i.origin===this._appOrigin||i.origin.endsWith(".arcgis.com"))&&"arcgis:auth:requestCredential"===(null===(a=i.data)||void 0===a?void 0:a.type)){const a=i.source;this.getCredential(e).then((e=>{a.postMessage({type:"arcgis:auth:credential",credential:{expires:e.expires,server:e.server,ssl:e.ssl,token:e.token,userId:e.userId}},i.origin)})).catch((e=>{a.postMessage({type:"arcgis:auth:error",error:{name:e.name,message:e.message}},i.origin)}))}}))}disablePostMessageAuth(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)}_getOAuthLocationParams(){let e=window.location.hash;if(e){var i;"#"===e.charAt(0)&&(e=e.substring(1));const a=(0,I.zf)(e);let l=!1;if(a.access_token&&a.expires_in&&a.state&&a.hasOwnProperty("username"))try{a.state=JSON.parse(a.state),a.state.portalUrl&&(this._oAuthLocationParams=a,l=!0)}catch{}else if(a.error&&a.error_description&&(console.log("IdentityManager OAuth Error: ",a.error," - ",a.error_description),"access_denied"===a.error&&(l=!0,a.state)))try{a.state=JSON.parse(a.state)}catch{}l&&(window.location.hash=(null===(i=a.state)||void 0===i?void 0:i.hash)||"")}let a=window.location.search;if(a){"?"===a.charAt(0)&&(a=a.substring(1));const e=(0,I.zf)(a);let i=!1;if(e.code&&e.state)try{e.state=JSON.parse(e.state),e.state.portalUrl&&e.state.uid&&(this._oAuthLocationParams=e,i=!0)}catch{}else if(e.error&&e.error_description&&(console.log("IdentityManager OAuth Error: ",e.error," - ",e.error_description),"access_denied"===e.error&&(i=!0,e.state)))try{e.state=JSON.parse(e.state)}catch{}if(i){var l;const i={...e};["code","error","error_description","message_code","persist","state"].forEach((e=>{delete i[e]}));const a=(0,I.x0)(i),h=window.location.pathname+(a?"?".concat(a):"")+((null===(l=e.state)||void 0===l?void 0:l.hash)||"");window.history.replaceState(window.history.state,"",h)}}}_getOAuthToken(e,i,a,l,h){return e=e.replace(/^http:/i,"https:"),(0,c.A)("".concat(e,"/sharing/rest/oauth2/token"),{authMode:"anonymous",method:"post",query:l&&h?{grant_type:"authorization_code",code:i,redirect_uri:l,client_id:a,code_verifier:h}:{grant_type:"refresh_token",refresh_token:i,client_id:a}}).then((e=>e.data))}_getCodeChallenge(e){if(e&&globalThis.isSecureContext){const i=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",i).then((e=>(0,I.$1)(new Uint8Array(e))))}return Promise.resolve(null)}_pageShowHandler(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){const e=new _.A("identity-manager:user-aborted","ABORTED");this._errbackFunc(e)}}_findCredential(e,i){let a,l,h,d,c=-1;const _=null===i||void 0===i?void 0:i.token,v=null===i||void 0===i?void 0:i.resource,f=this._isServerRsrc(e)?"server":"portal",g=this.credentials.filter((i=>this._hasSameServerInstance(i.server,e)&&i.scope===f));if(e=v||e,g.length)if(1===g.length){var m;if(a=g[0],h=this.findServerInfo(a.server),l=null===(m=h)||void 0===m?void 0:m.owningSystemUrl,d=l?this.findCredential(l,a.userId):void 0,c=this._getIdenticalSvcIdx(e,a),!_)return-1===c&&a.resources.push(e),this._addResource(e,d),a;-1!==c&&(a.resources.splice(c,1),this._removeResource(e,d))}else{let i,a;if(g.some((_=>{var v;return a=this._getIdenticalSvcIdx(e,_),-1!==a&&(i=_,h=this.findServerInfo(i.server),l=null===(v=h)||void 0===v?void 0:v.owningSystemUrl,d=l?this.findCredential(l,i.userId):void 0,c=a,!0)})),_)i&&(i.resources.splice(c,1),this._removeResource(e,d));else if(i)return this._addResource(e,d),i}}_findOAuthInfo(e){let i=this.findOAuthInfo(e);if(!i)for(const a of this.oAuthInfos)if(this._isIdProvider(a.portalUrl,e)){i=a;break}return i}_addResource(e,i){i&&-1===this._getIdenticalSvcIdx(e,i)&&i.resources.push(e)}_removeResource(e,i){let a=-1;i&&(a=this._getIdenticalSvcIdx(e,i),a>-1&&i.resources.splice(a,1))}_useProxy(e,i){return(null===i||void 0===i?void 0:i.isAdmin)&&!(0,I.FX)(e.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(e.tokenServiceUrl)&&"10.1"===String(e.currentVersion)&&!(0,I.FX)(e.tokenServiceUrl,this._appOrigin)}_getOrigin(e){const i=new I.s0(e);return i.scheme+"://"+i.host+(null!=i.port?":"+i.port:"")}_getServerInstanceRoot(e){const i=e.toLowerCase();let a=i.indexOf(this._agsRest);return-1===a&&this._isAdminResource(e)&&(a=this._agsAdmin.test(e)?e.replace(this._agsAdmin,"$1").length:e.search(this._adminSvcs)),-1!==a||(0,F.$)(i)||(a=i.indexOf("/sharing")),-1===a&&"/"===i.substr(-1)&&(a=i.length-1),a>-1?e.substring(0,a):e}_hasSameServerInstance(e,i){return"/"===e.substr(-1)&&(e=e.slice(0,-1)),e=e.toLowerCase(),i=this._getServerInstanceRoot(i).toLowerCase(),e=this._normalizeAGOLorgDomain(e),i=this._normalizeAGOLorgDomain(i),(e=e.substr(e.indexOf(":")))===i.substr(i.indexOf(":"))}_normalizeAGOLorgDomain(e){const i=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,a=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,l=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return i.test(e)?e=e.replace(i,"https://www.arcgis.com"):a.test(e)?e=e.replace(a,"https://devext.arcgis.com"):l.test(e)&&(e=e.replace(l,"https://qaext.arcgis.com")),e}_sanitizeUrl(e){const i=(d.A.request.proxyUrl||"").toLowerCase(),a=i?e.toLowerCase().indexOf(i+"?"):-1;return-1!==a&&(e=e.substring(a+i.length+1)),e=(0,I.S8)(e),(0,I.An)(e).path}_isRESTService(e){return e.includes(this._agsRest)}_isAdminResource(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)}_isServerRsrc(e){return this._isRESTService(e)||this._isAdminResource(e)}_isIdenticalService(e,i){let a=!1;if(this._isRESTService(e)&&this._isRESTService(i)){const l=this._getSuffix(e).toLowerCase(),h=this._getSuffix(i).toLowerCase();if(a=l===h,!a){const e=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;a=l.replaceAll(e,"$1")===h.replaceAll(e,"$1")}}else this._isAdminResource(e)&&this._isAdminResource(i)?a=!0:this._isServerRsrc(e)||this._isServerRsrc(i)||!this._isPortalDomain(e)||(a=!0);return a}_isPortalDomain(e){const i=new I.s0(e.toLowerCase()),a=this._portalConfig;let l=this._gwDomains.some((e=>e.regex.test(i.uri)));return!l&&a&&(l=this._hasSameServerInstance(this._getServerInstanceRoot(a.restBaseUrl),i.uri)),l||d.A.portalUrl&&(l=(0,I.FX)(i,d.A.portalUrl,!0)),l||(l=this._portals.some((e=>this._hasSameServerInstance(e,i.uri)))),l=l||this._agsPortal.test(i.path),l}_isIdProvider(e,i){let a=-1,l=-1;this._gwDomains.forEach(((h,d)=>{-1===a&&h.regex.test(e)&&(a=d),-1===l&&h.regex.test(i)&&(l=d)}));let h=!1;if(a>-1&&l>-1&&(0===a||4===a?0!==l&&4!==l||(h=!0):1===a?1!==l&&2!==l||(h=!0):2===a?2===l&&(h=!0):3===a&&3===l&&(h=!0)),!h){const a=this.findServerInfo(i),l=null===a||void 0===a?void 0:a.owningSystemUrl;l&&R(a)&&this._isPortalDomain(l)&&this._isIdProvider(e,l)&&(h=!0)}return h}_getIdenticalSvcIdx(e,i){let a=-1;for(let l=0;l<i.resources.length;l++){const h=i.resources[l];if(this._isIdenticalService(e,h)){a=l;break}}return a}_getSuffix(e){return e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")}_getTokenSvcUrl(e){let i,a,l;if(this._isRESTService(e)||this._isAdminResource(e)){const l=this._getServerInstanceRoot(e);return i=l+"/admin/generateToken",a=(0,c.A)(e=l+"/rest/info",{query:{f:"json"}}).then((e=>e.data)),{adminUrl:i,promise:a}}if(this._isPortalDomain(e)){let i="";if(this._gwDomains.some((a=>(a.regex.test(e)&&(i=a.tokenServiceUrl),!!i))),i||this._portals.some((a=>(this._hasSameServerInstance(a,e)&&(i=a+this._gwTokenUrl),!!i))),i||(l=e.toLowerCase().indexOf("/sharing"),-1!==l&&(i=e.substring(0,l)+this._gwTokenUrl)),i||(i=this._getOrigin(e)+this._gwTokenUrl),i){const a=new I.s0(e).port;/^http:\/\//i.test(e)&&"7080"===a&&(i=i.replace(/:7080/i,":7443")),i=i.replace(/http:/i,"https:")}return i}if(e.toLowerCase().includes("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"}_processOAuthResponseParams(e,i,a){const l=i._oAuthCred;if(e.code){const h=l.codeVerifier;return l.codeVerifier=null,l.stateUID=null,l.save(),this._getOAuthToken(a.server,e.code,i.appId,this._getRedirectURI(i,!0),h).then((h=>{const d=new H({userId:h.username,server:a.server,token:h.access_token,expires:Date.now()+1e3*h.expires_in,ssl:h.ssl,oAuthState:e.state,_oAuthCred:l});return i.userId=d.userId,l.storage=h.persist?$:J,l.refreshToken=h.refresh_token,l.token=null,l.expires=h.refresh_token_expires_in?Date.now()+1e3*h.refresh_token_expires_in:null,l.userId=d.userId,l.ssl=d.ssl,l.save(),d}))}const h=new H({userId:e.username,server:a.server,token:e.access_token,expires:Date.now()+1e3*Number(e.expires_in),ssl:"true"===e.ssl,oAuthState:e.state,_oAuthCred:l});return i.userId=h.userId,l.storage=e.persist?$:J,l.refreshToken=null,l.token=h.token,l.expires=h.expires,l.userId=h.userId,l.ssl=h.ssl,l.save(),Promise.resolve(h)}_processOAuthPopupParams(e){var i;const a=this._oAuthDfd;if(this._oAuthDfd=null,a)if(clearInterval(this._oAuthIntervalId),null!==(i=this._oAuthOnPopupHandle)&&void 0!==i&&i.remove(),e.error){const i="access_denied"===e.error,l=new _.A(i?"identity-manager:user-aborted":"identity-manager:authentication-failed",i?"ABORTED":"OAuth: "+e.error+" - "+e.error_description);a.reject(l)}else this._processOAuthResponseParams(e,a.oinfo_,a.sinfo_).then((e=>{a.resolve(e)})).catch((e=>{a.reject(e)}))}_setOAuthResponseQueryString(e){e&&("?"===e.charAt(0)&&(e=e.substring(1)),this._processOAuthPopupParams((0,I.zf)(e)))}_exchangeToken(e,i,a){return(0,c.A)("".concat(e,"/sharing/rest/oauth2/exchangeToken"),{authMode:"anonymous",method:"post",query:{f:"json",client_id:i,token:a}}).then((e=>e.data.token))}_getPlatformSelf(e,i){return e=e.replace(/^http:/i,"https:"),(0,c.A)("".concat(e,"/sharing/rest/oauth2/platformSelf"),{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":i,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json",expiration:30},withCredentials:!0}).then((e=>e.data))}_getPortalSelf(e,i){let a;return this._gwDomains.some((i=>(i.regex.test(e)&&(a=i.customBaseUrl),!!a))),a?Promise.resolve({allSSL:!0,currentVersion:"8.4",customBaseUrl:a,portalMode:"multitenant",supportsOAuth:!0}):(this._appOrigin.startsWith("https:")?e=e.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(i)&&(e=e.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),(0,c.A)(e,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then((e=>e.data)))}_doPortalSignIn(e){const i=this._portalConfig,a=window.location.href,l=this.findServerInfo(e);return!(!i&&!this._isPortalDomain(a)||!(l?l.hasPortal||l.owningSystemUrl&&this._isPortalDomain(l.owningSystemUrl):this._isPortalDomain(e))||!(this._isIdProvider(a,e)||i&&(this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),e)||this._isIdProvider(i.restBaseUrl,e))||(0,I.FX)(a,e,!0)))}_checkProtocol(e,i,a,l){let h=!0;const d=l?i.adminTokenServiceUrl:i.tokenServiceUrl;return d.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&(0,I.zs)(d)&&(h=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:i}),!h)&&a(new _.A("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection.")),h}_enqueue(e,i,a,l,h,d){return l||(l=(0,w.Tw)()),l.resUrl_=e,l.sinfo_=i,l.options_=a,l.admin_=h,l.refresh_=d,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(l)):this._xoReqs.push(l):this._doSignIn(l),l.promise}_doSignIn(e){this._busy=e,this._rejectOnPersistedPageShow=!1;const t=i=>{var a;const l=null===(a=e.options_)||void 0===a?void 0:a.resource,h=e.resUrl_,d=e.refresh_;let c=!1;this.credentials.includes(i)||(d&&this.credentials.includes(d)?(d.userId=i.userId,d.token=i.token,d.expires=i.expires,d.validity=i.validity,d.ssl=i.ssl,d.creationTime=i.creationTime,c=!0,i=d):this.credentials.push(i)),i.resources||(i.resources=[]),i.resources.includes(l||h)||i.resources.push(l||h),i.scope=this._isServerRsrc(h)?"server":"portal",i.emitTokenChange();const _=this._soReqs,v={};this._soReqs=[],_.forEach((e=>{if(!this._isIdenticalService(h,e.resUrl_)){const a=this._getSuffix(e.resUrl_);v[a]||(v[a]=!0,i.resources.push(e.resUrl_))}})),e.resolve(i),_.forEach((e=>{this._hasSameServerInstance(this._getServerInstanceRoot(h),e.resUrl_)?e.resolve(i):this._soReqs.push(e)})),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,c||this.emit("credential-create",{credential:i}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},r=i=>{e.reject(i),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},s=(i,a,l,h)=>{var d,c;const v=e.sinfo_,g=!e.options_||!1!==e.options_.prompt,m=v.hasPortal&&this._findOAuthInfo(e.resUrl_);let S,A;if(i)t(new H({userId:i,server:v.server,token:l||null,expires:null!=h?Number(h):null,ssl:!!a}));else if(window!==window.parent&&null!==(d=this._appUrlObj.query)&&void 0!==d&&d["arcgis-auth-origin"]&&null!==(c=this._appUrlObj.query)&&void 0!==c&&c["arcgis-auth-portal"]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query["arcgis-auth-portal"]),e.resUrl_)){var y;window.parent.postMessage({type:"arcgis:auth:requestCredential"},this._appUrlObj.query["arcgis-auth-origin"]);const i=(0,f.on)(window,"message",(e=>{e.source===window.parent&&e.data&&("arcgis:auth:credential"===e.data.type?(i.remove(),e.data.credential.expires<Date.now()?r(new _.A("identity-manager:credential-request-failed","Parent application's token has expired.")):t(new H(e.data.credential))):"arcgis:auth:error"===e.data.type&&(i.remove(),"tokenExpiredError"===e.data.error.name?r(new _.A("identity-manager:credential-request-failed","Parent application's token has expired.")):r(_.A.fromJSON(e.data.error))))}));(0,w.u7)(null===(y=e.options_)||void 0===y?void 0:y.signal,(()=>{i.remove()}))}else if(m){let i=m._oAuthCred;if(!i){const e=new OAuthCredential_e(m,$),a=new OAuthCredential_e(m,J);e.isValid()&&a.isValid()?e.expires>a.expires?(i=e,a.destroy()):(i=a,e.destroy()):i=e.isValid()?e:a,m._oAuthCred=i}if(i.isValid()){S=new H({userId:i.userId,server:v.server,token:i.token,expires:i.expires,ssl:i.ssl,_oAuthCred:i});const a=m.appId!==i.appId&&this._doPortalSignIn(e.resUrl_);a||i.refreshToken?(e._pendingDfd=i.refreshToken?this._getOAuthToken(v.server,i.refreshToken,i.appId).then((e=>(S.expires=Date.now()+1e3*e.expires_in,S.token=e.access_token,S))):Promise.resolve(S),e._pendingDfd.then((e=>a?this._exchangeToken(e.server,m.appId,e.token).then((i=>(e.token=i,e))).catch((()=>e)):e)).then((e=>{t(e)})).catch((()=>{var e;null!==(e=i)&&void 0!==e&&e.destroy(),s()}))):t(S)}else if(this._oAuthLocationParams&&this._hasSameServerInstance(m.portalUrl,this._oAuthLocationParams.state.portalUrl)&&(this._oAuthLocationParams.access_token||this._oAuthLocationParams.code&&this._oAuthLocationParams.state.uid===i.stateUID&&i.codeVerifier)){const i=this._oAuthLocationParams;this._oAuthLocationParams=null,e._pendingDfd=this._processOAuthResponseParams(i,m,v).then((e=>{t(e)})).catch(r)}else{const s=()=>{g?e._pendingDfd=this.oAuthSignIn(e.resUrl_,v,m,e.options_).then(t,r):(A=new _.A("identity-manager:not-authenticated","User is not signed in."),r(A))};this._doPortalSignIn(e.resUrl_)?e._pendingDfd=this._getPlatformSelf(v.server,m.appId).then((e=>{(0,I.FX)(e.portalUrl,this._appOrigin,!0)?(S=new H({userId:e.username,server:v.server,expires:Date.now()+1e3*e.expires_in,token:e.token}),t(S)):s()})).catch(s):s()}}else if(g){if(this._checkProtocol(e.resUrl_,v,r,e.admin_)){let i=e.options_;e.admin_&&(i=i||{},i.isAdmin=!0),e._pendingDfd=this.signIn(e.resUrl_,v,i).then(t,r)}}else A=new _.A("identity-manager:not-authenticated","User is not signed in."),r(A)},n=()=>{const i=e.sinfo_,a=i.owningSystemUrl,l=e.options_;let h,d,c,_;if(l&&(h=l.token,d=l.error,c=l.prompt),_=this._findCredential(a,{token:h,resource:e.resUrl_}),!_)for(const e of this.credentials)if(this._isIdProvider(a,e.server)){_=e;break}if(_){const a=this.findCredential(e.resUrl_,_.userId);if(a)t(a);else if(C(i,this._legacyFed)){const e=_.toJSON();e.server=i.server,e.resources=null,t(new H(e))}else(e._pendingDfd=this.generateToken(this.findServerInfo(_.server),null,{serverUrl:e.resUrl_,token:_.token,signal:e.options_.signal,ssl:_.ssl})).then((a=>{var l;t(new H({userId:null===(l=_)||void 0===l?void 0:l.userId,server:i.server,token:a.token,expires:null!=a.expires?Number(a.expires):null,ssl:!!a.ssl,isAdmin:e.admin_,validity:a.validity}))}),r)}else this._busy=null,h&&(e.options_.token=null),(e._pendingDfd=this.getCredential(a.replace(/\/?$/,"/sharing"),{resource:e.resUrl_,owningTenant:i.owningTenant,signal:e.options_.signal,token:h,error:d,prompt:c})).then((()=>{this._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)}),(i=>{e.resUrl_=e.sinfo_=e.refresh_=null,e.reject(i)}))};this._errbackFunc=r;const i=e.sinfo_.owningSystemUrl,a=this._isServerRsrc(e.resUrl_),l=e.sinfo_._restInfoPms;l?l.promise.then((i=>{const l=e.sinfo_;if(l._restInfoPms){var h,d;l.adminTokenServiceUrl=l._restInfoPms.adminUrl,l._restInfoPms=null,l.tokenServiceUrl=null!==(h=(0,m.wc)("authInfo.tokenServicesUrl",i)||(0,m.wc)("authInfo.tokenServiceUrl",i)||(0,m.wc)("tokenServiceUrl",i))&&void 0!==h?h:null,l.shortLivedTokenValidity=null!==(d=(0,m.wc)("authInfo.shortLivedTokenValidity",i))&&void 0!==d?d:null,l.currentVersion=i.currentVersion,l.owningTenant=i.owningTenant;const e=l.owningSystemUrl=i.owningSystemUrl;e&&this._portals.push(e)}a&&l.owningSystemUrl?n():s()}),(()=>{e.sinfo_._restInfoPms=null;const i=new _.A("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");r(i)})):a&&i?n():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then((i=>{var a;const l={};let h,d,c,_;return i&&(h=null===(a=i.user)||void 0===a?void 0:a.username,l.username=h,l.allSSL=i.allSSL,d=i.supportsOAuth,_=parseFloat(i.currentVersion),"multitenant"===i.portalMode&&(c=i.customBaseUrl),e.sinfo_.currentVersion=_),e.sinfo_.webTierAuth=!!h,h&&this.normalizeWebTierAuth?this.generateToken(e.sinfo_,null,{ssl:l.allSSL}).catch((()=>null)).then((e=>(l.portalToken=e&&e.token,l.tokenExpiration=e&&e.expires,l))):!h&&d&&_>=4.4&&!this._findOAuthInfo(e.resUrl_)?this._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:c,owningTenant:e.sinfo_._selfReq.owningTenant}).catch((()=>null)).then((()=>l)):l})).catch((()=>null)).then((i=>{e.sinfo_._selfReq=null,i?s(i.username,i.allSSL,i.portalToken,i.tokenExpiration):s()})):s()}_generateOAuthInfo(e){let i,a=null,l=e.portalUrl;const h=e.customBaseUrl,d=e.owningTenant,_=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(_){a=window.location.href;let e=a.indexOf("?");e>-1&&(a=a.slice(0,e)),e=a.search(/\/(apps|home)\//),a=e>-1?a.slice(0,e):null}return _&&a?(this._hasTestedIfAppIsOnPortal=!0,i=(0,c.A)(a+"/sharing/rest",{query:{f:"json"}}).then((()=>{this._defaultOAuthInfo=new E({appId:"arcgisonline",popupCallbackUrl:a+"/home/oauth-callback.html"})}))):i=Promise.resolve(),i.then((()=>{if(this._defaultOAuthInfo)return l=l.replace(/^http:/i,"https:"),(0,c.A)(l+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:d,client_id:this._defaultOAuthInfo.appId,redirect_uri:(0,I.s2)(this._defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then((e=>{if(e.data.valid){const i=this._defaultOAuthInfo.clone();e.data.urlKey&&h?i.portalUrl="https://"+e.data.urlKey.toLowerCase()+"."+h:i.portalUrl=l,i.popup=window!==window.top||!((0,I.FX)(l,this._appOrigin)||this._gwDomains.some((e=>e.regex.test(l)&&e.regex.test(this._appOrigin)))),this.oAuthInfos.push(i)}}))}))}_doOAuthSignIn(e,i,a,l){const h=a._oAuthCred,d={portalUrl:a.portalUrl};!a.popup&&a.preserveUrlHash&&window.location.hash&&(d.hash=window.location.hash),h.stateUID&&(d.uid=h.stateUID);const c={client_id:a.appId,response_type:h.codeVerifier?"code":"token",state:JSON.stringify(d),expiration:a.expiration,locale:a.locale,redirect_uri:this._getRedirectURI(a,!!h.codeVerifier)};a.forceLogin&&(c.force_login=!0),a.forceUserId&&a.userId&&(c.prepopulatedusername=a.userId),!a.popup&&this._doPortalSignIn(e)&&(c.redirectToUserOrgUrl=!0),h.codeVerifier&&(c.code_challenge=l||h.codeVerifier,c.code_challenge_method=l?"S256":"plain");const v=a.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",g=v+"?"+(0,I.x0)(c);if(a.popup){const e=window.open(g,"esriJSAPIOAuth",a.popupWindowFeatures);if(e)e.focus(),this._oAuthDfd.oAuthWin_=e,this._oAuthIntervalId=setInterval((()=>{if(e.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle.remove();const e=this._oAuthDfd;if(e){const i=new _.A("identity-manager:user-aborted","ABORTED");e.reject(i)}}}),500),this._oAuthOnPopupHandle=(0,f.on)(window,["arcgis:auth:hash","arcgis:auth:location:search"],(e=>{"arcgis:auth:hash"===e.type?this.setOAuthResponseHash(e.detail):this._setOAuthResponseQueryString(e.detail)}));else{const e=new _.A("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(e)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:c,authorizeUrl:v,resourceUrl:e,serverInfo:i,oAuthInfo:a}):window.location.href=g}_getRedirectURI(e,i){const a=window.location.href.replace(/#.*$/,"");if(e.popup)return(0,I.s2)(e.popupCallbackUrl);if(i){const e=(0,I.An)(a);return e.query&&["code","error","error_description","message_code","persist","state"].forEach((i=>{delete e.query[i]})),(0,I.a6)(e.path,e.query)}return a}}q.prototype.declaredClass="esri.identity.IdentityManagerBase";let H=class extends v.A.EventedAccessor{constructor(e){super(e),this._oAuthCred=null,this.tokenRefreshBuffer=2,(null===e||void 0===e?void 0:e._oAuthCred)&&(this._oAuthCred=e._oAuthCred)}initialize(){this.resources=this.resources||[],null==this.creationTime&&(this.creationTime=Date.now())}refreshToken(){const e=l.id.findServerInfo(this.server),i=null===e||void 0===e?void 0:e.owningSystemUrl,a=!!i&&"server"===this.scope,h=a&&C(e,l.id._legacyFed),d=e.webTierAuth,c=d&&l.id.normalizeWebTierAuth,_=B[this.server],v=null===_||void 0===_?void 0:_[this.userId];let f,g=this.resources&&this.resources[0],m=a?l.id.findServerInfo(i):null,w={username:this.userId,password:v};if(d&&!c)return;a&&!m&&l.id.serverInfos.some((e=>(l.id._isIdProvider(i,e.server)&&(m=e),!!m)));const I=m?l.id.findCredential(m.server,this.userId):null;if(!a||I){if(!h){if(a)f={serverUrl:g,token:null===I||void 0===I?void 0:I.token,ssl:I&&I.ssl};else if(c)w=null,f={ssl:this.ssl};else{if(!v){let i;return g&&(g=l.id._sanitizeUrl(g),this._enqueued=1,i=l.id._enqueue(g,e,null,null,this.isAdmin,this),i.then((()=>{this._enqueued=0,this.refreshServerTokens()})).catch((()=>{this._enqueued=0}))),i}this.isAdmin&&(f={isAdmin:!0})}return l.id.generateToken(a?m:e,a?null:w,f).then((e=>{this.token=e.token,this.expires=null!=e.expires?Number(e.expires):null,this.creationTime=Date.now(),this.validity=e.validity,this.emitTokenChange(),this.refreshServerTokens()})).catch((()=>{}))}null===I||void 0===I||I.refreshToken()}}refreshServerTokens(){"portal"===this.scope&&l.id.credentials.forEach((e=>{const i=l.id.findServerInfo(e.server),a=null===i||void 0===i?void 0:i.owningSystemUrl;e!==this&&e.userId===this.userId&&a&&"server"===e.scope&&(l.id._hasSameServerInstance(this.server,a)||l.id._isIdProvider(a,this.server))&&(C(i,l.id._legacyFed)?(e.token=this.token,e.expires=this.expires,e.creationTime=this.creationTime,e.validity=this.validity,e.emitTokenChange()):e.refreshToken())}))}emitTokenChange(e){clearTimeout(this._refreshTimer);const i=this.server?l.id.findServerInfo(this.server):null,a=null===i||void 0===i?void 0:i.owningSystemUrl,h=a?l.id.findServerInfo(a):null;!1===e||a&&"portal"!==this.scope&&(!(null!==h&&void 0!==h&&h.webTierAuth)||l.id.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer(),this.emit("token-change")}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const e=l.id.credentials.indexOf(this);e>-1&&l.id.credentials.splice(e,1),this.emitTokenChange(),this.emit("destroy")}toJSON(){const e=(0,g.oy)({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),i=this.resources;return i&&i.length>0&&(e.resources=i.slice()),e}_startRefreshTimer(){clearTimeout(this._refreshTimer);const e=6e4*this.tokenRefreshBuffer,i=2**31-1;let a=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();a<0?a=0:a>i&&(a=i),this._refreshTimer=setTimeout(this.refreshToken.bind(this),a>e?a-e:a)}};(0,h._)([(0,S.MZ)()],H.prototype,"creationTime",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"expires",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"isAdmin",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"oAuthState",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"resources",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"scope",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"server",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"ssl",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"token",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"tokenRefreshBuffer",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"userId",void 0),(0,h._)([(0,S.MZ)()],H.prototype,"validity",void 0),H=(0,h._)([(0,A.$)("esri.identity.Credential")],H);class r extends q{}r.prototype.declaredClass="esri.identity.IdentityManager";const G=new r;(0,l.Aq)(G)}}]);
//# sourceMappingURL=4600.3d5d6a8a.chunk.js.map